ORIGIN '~beta/distribution/v1.1/shell';
INCLUDE 'testDOTserverLib';

--- program:descriptor ---
shellEnv
(# back: humle
     (# cbimpl::< 
          (# 
          do count+1 -> count -> putInt; newline;
          #)
     #);
   cb: ^back;
   count: @Integer;
   
   shellType::<
     (# server: ^testDOTServer;
        serverEnsembleName: ^Text;
        serverEnsemble: ^ensemble;
     do
        'Enter testServer hostname: ' -> screen.putText;
        keyboard.getLine -> serverEnsembleName[];
        
        getHost: (ensemble##, serverEnsembleName[]) -> myEnsemble.ns.get
        (# notFound::<
             (# 
             do serverEnsembleName[] -> screen.putText;
                ' not found. Try again: ' -> screen.putText;
                keyboard.getLine -> serverEnsembleName[];
                restart getHost
             #)
        #) -> serverEnsemble[];
        
        (testDOTServer##, 'testDOTServer') -> serverEnsemble.ns.get
        (# notFound::<
             (# 
             do 'No TestServer on ' -> screen.putText;
                serverEnsemble.hostName[] -> screen.putLine;
                kill;
             #)
        #) -> server[];
        
        'Got Server' -> screen.putLine;
        
        (for 5000 repeat
             &back[] -> cb[] -> server.callback;
             cb[] -> withdraw
        for);
        
        server.kill;
        
        kill;
     #);
#)
