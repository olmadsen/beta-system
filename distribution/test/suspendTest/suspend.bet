ORIGIN '~beta/basiclib/v1.4/betaenv';
(* 
 * $RCSfile: suspend.bet,v $ $Revision: 1.1.1.1 $ $Date: 1994-08-22 08:37:22 $
 *
 * COPYRIGHT
 *       Copyright Mjolner Informatics, 1992-94
 *       All rights reserved.
 *)
OBJFILE default 'suspend.o';

--- program:descriptor ---
(# callback: external
     (# i1,i2,i3: @Integer;
        io: ^IntegerObject;
     enter (i1,i2,i3)
     do CExternalEntry;
        (* Generate a lot of garbage *)
        'Generating garbage' -> putLine;
        (for i:100000 repeat
             &IntegerObject[] -> io[];
        for);
        'Suspending' -> putLine;
        suspend;
        'Continuing' -> putLine;
     #);
   
   installCallback: external
     (# cb: ##callback;
     enter cb##
     #);
   
   attachWorker: 
     (# level: @Integer;
     enter level
     do 
        'attachWorker level ' -> putText; level -> putInt; newline;
        
        worker;
        
        'attachWorker level ' -> putText; level -> putInt; ' done' -> putLine;
        
        (if level //0 then else
            level-1 -> attachWorker
        if);
     #);
   
   worker: @|
     (# 
     do 
        cycle
        (# 
        do
           'Calling C' -> putLine;
           callback## -> installCallback;
           'Returned from C' -> putLine;
        #);
     #);
   
do 
   5 -> attachWorker;
#)
