ORIGIN '../frejaenv';
LIB_ITEM 'frejaenv';
INCLUDE '~beta/containers/seqContainers'
        '../frejaoptions'
        '~beta/sysutils/endian';
-- FrejaCheckEditMenuTextEdit: DoPart --
do
   not FrejaEditMenu.TextModeOn->FrejaEditMenu.TextModeOn;
   FrejaEditMenu.TextModeOn->FrejaEditMenu.iTextEdit.Check  

-- FrejaDesignInterfaceDoPart: DoPart --
do
   false->userdataVerbose;
   true
     ->ShowSifSelection
     (*toby: Hack, because editormenu is currently not initialised
      ess: udmaerket hack :-) *) ;
   false->verbose;
   false->callbackVerbose;
   false->switch[1]->switch[12]->switch[17]->switch[30]->switch[40]->switch[50]
     ->switch[51]->switch[52]->switch[53]->switch[54]->switch[60]->switch[70]
     ->switch[80]->switch[90]->switch[99];
     (# frejaprefs: ^frejaCMDpreferences; 
     do
        objectpool.get (# type:: frejaCMDpreferences #)->frejaprefs[];
        (if frejaprefs[] <> none then
            (frejaprefs.switch).scan
              (# i: @integer; 
              do
                 current.asint->i;
                 (if (i > 0) and (i <= 100) then true->switch[i];  if);
                 
              #)
        if);
        
     #);
     

-- FrejaDoPart: Descriptor --
(#  do  #)  

-- ChangedFocus: Descriptor --
(#
   t: ^Text;
   ok: @boolean;
   editorid: @Integer;
   anAST: ^MPS.AST;
   theExp: ^mps.expanded;
   graf: ^theGraphicalInterface.DesignInterface;
   theDoc: ^theGraphicalInterface.theDesignInterface.OADDocument;
   ff: ^mps.fragmentform
do
   (if theGraphicalInterface.switch[12]
    // true then
       '----------------------------------------------------------------------'
         ->screen.putLine;
       'Show Sif Selection: '->putText;
       ShowSIFSelection->putBoolean;
       newline;
       
   if);
   (if oldFocus[] <> none then (* use oldFocus instead of oldObject *)
       theGraphicalInterface.theDesignInterface[]->graf[];
       graf.theDocument[]->theDoc[];
       (if oldFocus.theText.isModeOn then
           (if theGraphicalInterface.switch[12]
            // true then 'Finish textediting'->screen.putLine; 
           if);
           oldFocus.theText.modeOff;
           false->theDoc.FrejaEditMenu.textModeOn
             ->theDoc.FrejaEditMenu.iTextEdit.check;
           
       if);
       
   if);
   (if ShowSIFSelection then
       (if newObject.theSifEditor <> none then
           newObject.getASTNode->anAST[];
           (if anAST[] <> none then
               (if anAST## <= betaGram.AttributeDecl## then
                   anAST[]->theExp[];
                   (if anAST.Symbol = betaGram.RepetitionDecl then
                       theExp.getSon3->anAST[]
                    else
                       theExp.getSon2->anAST[]
                   if);
                   setFocus:
                   (if anAST.kind = mps.kinds.unExpanded then
                       (anAST[],1)->(newObject.theSifEditor).changeFocus
                    else
                       (if (anAST## <= betaGram.ReferenceSpecification##) or
                       (anAST## <= betaGram.Remote##) then
                           anAST[]->theExp[];
                           theExp.getSon1->anAST[];
                           restart setFocus
                        else
                           (newObject.getASTNode,1)
                             ->(newObject.theSifEditor).changeFocus
                       if)
                   if)
                else
                   (newObject.getASTNode,1)
                     ->(newObject.theSifEditor).changeFocus
               if)
            else
               newObject.getFragment->ff[];
               newObject.astIndex
                 ->ff.indexToNode
                   (#
                      indexOutOfRange::< 
                        (# 
                        do 'indexOutOfRange'->putLine; true->continue; 
                        #);
                      noSuchSymbol::< 
                        (#  do 'noSuchSymbol'->putLine; true->continue;  #);
                      grammarGenRefArrayError::< 
                        (# 
                        do 'grammarGenRefArrayError'->putLine; true->continue; 
                        #)
                   #)->anAST[];
               (anAST[],1)->(newObject.theSifEditor).changeFocus
           if);
           
       if)
   if);
   
#)  

-- declarationTextChanged: Descriptor --
(# (* should we use currentFocus or theObject? *) 
do
   (if theObject[] <> none
    // true then
       (if theObject.theDiagram <> none
        // true then
           (if theObject.theSifEditor <> none then
               (node[],theParseText)->(theObject.theSifEditor).parse
           if)
        else
           'DoParse: theDiagram is NONE'->putline; 
       if)
    else
       'DoParse: CurrentFocus is NONE'->putline; 
   if)
#)  

-- openFormInSif: Descriptor --
(# t: ^text; theTitle: @Text; editorId: @Integer
do
   fn[]->theFragmentNode[];
   (if switch[40] then
       (if theFragmentNode[] <> none then
           
        else
           'openFormInSif: theFragmentNode is NONE !!!!'->putline
       if)
   if);
   (if fn.theSifEditor = none then
       (ff.fullname,none )->theController.globalSifCommands.openForm
   if);
   
#)  

-- copy: Descriptor --
(# 
do
   'copy: '->puttext;
   (if theObject[] <> none // true then theObject.astIndex->putint if);
   newline;
   
#)  

-- onFocusChange: Descriptor --
(#
(* Selects the diagram node that corresponds to the focus in sif (node).
 * If the diagram node doesn't exist, the path up to the rooth in the AST is
 * traversed until an AST node that has a corresponding diagram node is found.
 * This diagram node is then detailed and the same is done for the AST nodes
 * that have been met on the way up.
 * The stack S is used for this.
 *)
   theObject: ^PatternDiagramNode;
   theListDiagram: ^ListDiagram;
   anAST2: ^mps.ast;
   S: @stack (# element::< mps.ast (* integerObject *) #);
   io: ^integerObject;
   hasDetailed,noNodeFound: @boolean;
   
do
   false->status;
   true->noNodeFound;
   S.init;
   12->trace (#  do 'Freja ----- onFocusChange: '->t #);
   search:
     (# 
     do
        12->trace (#  do 'searching...'->t #);
        (if (node[] <> none ) then
            12
              ->trace
                (# 
                do
                   'Freja ----- node.Index: %i\n'
                     ->t.putformat (#  do node.Index->i #)
                #);
            node[]->ASTtoNode->theObject[]
         else
            none ->theObject[]; 
        if);
        (if (theObject[] <> none ) then
            theObject.theDiagram->theListDiagram[];
            theObject[]->CurrentObject (#  do true->autoPan #);
            currentFocus[]->oldFocus[];
            theObject[]->CurrentFocus[];
            false->noNodeFound;
            true->status;
            (if S.empty and noNodeFound then
                12->trace (#  do 'Freja ----- stack is empty'->t #);
                theGroupPage.patternDiagrams.theList.scanFragmentDiagrams
                  (# 
                  do
                     thisDiagram.localNodes.scan
                       (#
                          theListDiagram: ^ListDiagram;
                          theFragmentNode: ^theListDiagram.FragmentNode
                       do
                          current.theDiagram->theListDiagram[];
                          (if current## <= theListDiagram.fragmentNode## then
                              current[]->theFragmentNode[];
                              (if node.frag[] = theFragmentNode.theFragment then
                                  (if theFragmentNode.currentDecomposDiagram <>
                                  none then
                                      (theFragmentNode.currentDecomposDiagram).
                                      titleNode[]
                                        ->CurrentObject
                                          (#  do true->autoPan #);
                                      currentFocus[]->oldFocus[];
                                      (theFragmentNode.currentDecomposDiagram).
                                      titleNode[]->CurrentFocus[]
                                   else
                                      theFragmentNode[]
                                        ->CurrentObject
                                          (#  do true->autoPan #);
                                      currentFocus[]->oldFocus[];
                                      theFragmentNode[]->CurrentFocus[]
                                  if)
                              if)
                          if)
                       #)
                  #)
             else
                openDownUntilNode:
                (if S.empty = false then
                    S.pop->anAST2[];
                    12
                      ->trace
                        (# 
                        do
                           'Freja ----- pop: %i\n'
                             ->t.putformat (#  do anAST2.index->i #)
                        #);
                    anAST2[]->ASTtoNode->theObject[];
                    (if theObject[] = none then
                    (* 'detailing... '->statusbar.set;*)
                        (if currentFocus[] <> none then
                            false->currentFocus.IndicateSelection;
                            currentFocus.detail;
                            true->hasDetailed;
                            anAST2[]->ASTtoNode->theObject[];
                            (if theObject[] <> none then
                                12
                                  ->trace
                                    (#  do 'Freja ----- node found'->t #);
                                theObject[]->CurrentObject;
                                currentFocus[]->oldFocus[];
                                theObject[]->CurrentFocus[];
                                true->status
                             else
                                'node not found in detailed diagram!!'
                                  ->stdErr.putLine
                            if);
                            restart openDownUntilNode
                        if)
                    if)
                if)
            if)
         else
            (if (node[] <> none ) then
                12
                  ->trace
                    (# 
                    do
                       'Freja ----- node.symbol = %i  node.index = %i %s\n'
                         ->t.putformat
                           (# 
                           do
                              node.symbol->i;
                              node.index->i;
                              node.symbol->betaGram.symbolToName->s
                           #)
                    #);
                (if node.kind
                 // mps.kinds.interior then
                    (if node.symbol
                     // betaGram.SimpleDecl // betaGram.PatternDecl
                     // betaGram.VirtualDecl // betaGram.BindingDecl
                     // betaGram.FinalDecl
                     //
                     betaGram.RepetitionDecl (*// betaGram.VariablePatternDecl*)
                     then
                        12
                          ->trace
                            (# 
                            do
                               'Freja ----- push %i'
                                 ->t.putformat (#  do node.index->i;  #)
                            #);
                        node[]->S.push
                    if)
                 // mps.kinds.unexpanded then
                    (if
                    (node[]->qua (# as:: mps.unexpanded #)).nonterminalSymbol
                     // gram.AttributeDeclOpt then
                        12
                          ->trace
                            (# 
                            do
                               'Freja ----- push nonterminal = %i'
                                 ->t.putformat (#  do node.index->i #)
                            #);
                        node[]->S.push
                    if)
                if);
                node.father->node[];
                restart search
             else
            (* astIndex not on the path up to the root *)
                12
                  ->trace
                    (#  do 'astIndex not on the path up to the root'->t #);
                false->status
            if);
            
        if)
     #);
   (if hasDetailed then Redraw if)
#)  

-- GetStatusFromSif: Descriptor --
(# t: ^Text; theNode: ^PatternDiagramNode; 
do
   (if theObject[] <> none then
       (if theObject## <= PatternDiagramNode##
        // true then
           theObject[]->theNode[];
           (if theNode.theSifEditor = none then
               (if theGraphicalInterface.switch[40]
                // true then
                   'Freja ------ No Sif Editor Instance open'->putline; 
               if);
               
            else
               (theNode.theSifEditor).getStatus
           if);
           
        else
           'Freja ------ ERROR: GetStatus: theObject is not a DiagramNode'
             ->putline;
           
       if)
   if)
#)  

-- DoExpand: Descriptor --
(# 
do
   (if CurrentFocus[] <> none then
       (if CurrentFocus.theDiagram <> none then
           (if CurrentFocus.theSifEditor <> none then
               (if normal then
                   synCatNo->(CurrentFocus.theSifEditor).expandNormal; 
                else
                   synCatNo->(CurrentFocus.theSifEditor).expandOptional; 
               if);
               
           if)
        else
           'DoExpand: theDiagram is NONE'->putline; 
       if)
    else
       'DoExpand: CurrentFocus is NONE'->putline; 
   if)
#)  

-- DoExpandLexem: Descriptor --
(# 
do
   (if CurrentFocus[] <> none then
       (if CurrentFocus.theDiagram <> none then
           (if CurrentFocus.theSifEditor <> none then
               name->(currentFocus.theSifEditor).expandLexem
           if)
       if)
    else
       'DoExpandLexem: CurrentFocus is NONE'->putline; 
   if)
#)  

-- BindingConnectorOnInit: Descriptor --
(#
   aPatternDiagramNode,anotherPatternDiagramNode: ^PatternDiagramNode;
   aDiagramNode: ^theListDiagram.DiagramNode;
   aPatternNode: ^theListDiagram.PatternNode;
   anotherDiagramNode: ^theOtherListDiagram.DiagramNode;
   aNonTerminalNode: ^theListDiagram.NonTerminalNode;
   theListDiagram,theOtherListDiagram: ^ListDiagram;
   anAST: ^MPS.AST;
   theNames: ^betaGram.Names;
   theNameDcl: ^betaGram.NameDcl;
   ObjSpecText: @Text;
   t: ^Text
do
   (if switch[51] then 'BindingConnector onInit'->putline if);
   false->repair;
   gppProp.busy->gppProp.globalInteractivemode;
   true->getEnds->(node1[],node2[]);
   delete;
   (if (node1[] <> none ) and (node2[] <> none ) then
       (if (node1## <= PatternDiagramNode##) and
       (node2## <= PatternDiagramNode##) then
           node1[]->aPatternDiagramNode[];
           aPatternDiagramNode.theDiagram->theListDiagram[];
           node2[]->anotherPatternDiagramNode[];
           anotherPatternDiagramNode.theDiagram->theOtherListDiagram[];
           (if
           (anotherPatternDiagramNode## <= theOtherListDiagram.VirtualNode##) or
           (anotherPatternDiagramNode## <= theOtherListDiagram.BindingNode##)
            then
               (if (theListDiagram## <= FragmentDiagram##) or
               (theOtherListDiagram## <= FragmentDiagram##) then
                   'Source and/or destination is a fragment diagram'->AlertUser
                else
                   (if (theListDiagram## <= PatternAttDiagram##) or
                   (theOtherListDiagram## <= PatternAttDiagram##) then
                       'Source and/or destination is an attributes form diagram'
                         ->AlertUser
                    else
                       (if aPatternDiagramNode## <= theListDiagram.title## then
                           'Source must be an attribute of a pattern diagram'
                             ->AlertUser
                        else
                           anotherPatternDiagramNode[]->anotherDiagramNode[];
                           anotherDiagramNode.theDeclaration.getSon1
                             ->theNames[];
                           theNames.getSon1->theNameDcl[];
                           theNameDcl.getNameDecl->anAST[];
                           (if anAST.kind = mps.kinds.unExpanded then
                               '<<NameDecl>>'->t[]
                            else
                               theNameDcl.getText->t[]
                           if);
                           '::< '->t.puttext;
                           (if aPatternDiagramNode## <=
                           theListDiagram.PatternNode## then
                               aPatternDiagramNode[]->aPatternNode[];
                               aPatternNode.theDeclaration.getSon2->anAST[];
                               (mps[],anAST.frag[],anAST[],ObjSpecText[],none
                                (*streamName[]*) ,80,0,false
                                (*abstractPresentation*) ,false
                                (*showSemanticErrors*) ,false
                                (*includeComments*) ,false,false,false,false,'',
                                false (*onlyProperties*) ,false,false
                                (*
                                 test*) )->ppFragment;
                               (1,ObjSpecText.length-3)->ObjSpecText.sub
                                 ->t.puttext
                            else
                               '<<ObjectSpecification>>'->t.puttext
                           if);
                           (if aPatternDiagramNode## <=
                           theListDiagram.DiagramNode## then
                               aPatternDiagramNode[]->aDiagramNode[];
                               (aDiagramNode.theDeclaration[],t)
                                 ->(aPatternDiagramNode.theSifEditor).parse
                            else
                               (if aPatternDiagramNode## <=
                               theListDiagram.NonTerminalNode## then
                                   aPatternDiagramNode[]->aNonTerminalNode[];
                                   (aNonTerminalNode.unexp[],t)
                                     ->(aPatternDiagramNode.theSifEditor).parse
                                else
                                   'BindingConnectorOnInit: Source neither DiagramNode nor NonTerminalNode??'
                                     ->putline
                               if)
                           if)
                       if)
                   if)
               if)
            else
               'Destination must be a virtual or a binding declaration'
                 ->AlertUser
           if)
        else
           'Source or destination is not part of a pattern diagram'->AlertUser
       if)
   if);
   gppProp.noGlobalinteractivemode->gppProp.globalInteractivemode;
   autosave;
   true->repair
#)  

-- FinalBindingConnectorOnInit: Descriptor --
(#
   aPatternDiagramNode,anotherPatternDiagramNode: ^PatternDiagramNode;
   aDiagramNode: ^theListDiagram.DiagramNode;
   aPatternNode: ^theListDiagram.PatternNode;
   anotherDiagramNode: ^theOtherListDiagram.DiagramNode;
   aNonTerminalNode: ^theListDiagram.NonTerminalNode;
   theListDiagram,theOtherListDiagram: ^ListDiagram;
   anAST: ^MPS.AST;
   theNames: ^betaGram.Names;
   theNameDcl: ^betaGram.NameDcl;
   ObjSpecText: @Text;
   t: ^Text
do
   (if switch[51] then 'BindingConnector onInit!'->putline if);
   false->repair;
   gppProp.busy->gppProp.globalInteractivemode;
   true->getEnds->(node1[],node2[]);
   delete;
   (if (node1[] <> none ) and (node2[] <> none ) then
       (if (node1## <= PatternDiagramNode##) and
       (node2## <= PatternDiagramNode##) then
           node1[]->aPatternDiagramNode[];
           aPatternDiagramNode.theDiagram->theListDiagram[];
           node2[]->anotherPatternDiagramNode[];
           anotherPatternDiagramNode.theDiagram->theOtherListDiagram[];
           (if
           (anotherPatternDiagramNode## <= theOtherListDiagram.VirtualNode##) or
           (anotherPatternDiagramNode## <= theOtherListDiagram.BindingNode##)
            then
               (if (theListDiagram## <= FragmentDiagram##) or
               (theOtherListDiagram## <= FragmentDiagram##) then
                   'Source and/or destination is a fragment diagram'->AlertUser
                else
                   (if (theListDiagram## <= PatternAttDiagram##) or
                   (theOtherListDiagram## <= PatternAttDiagram##) then
                       'Source and/or destination is an attributes form diagram'
                         ->AlertUser
                    else
                       (if aPatternDiagramNode## <= theListDiagram.title## then
                           'Source must be an attribute of a pattern diagram'
                             ->AlertUser
                        else
                           anotherPatternDiagramNode[]->anotherDiagramNode[];
                           anotherDiagramNode.theDeclaration.getSon1
                             ->theNames[];
                           theNames.getSon1->theNameDcl[];
                           theNameDcl.getNameDecl->anAST[];
                           (if anAST.kind = mps.kinds.unExpanded then
                               '<<NameDecl>>'->t[]
                            else
                               theNameDcl.getText->t[]
                           if);
                           ':: '->t.puttext;
                           (if aPatternDiagramNode## <=
                           theListDiagram.PatternNode## then
                               aPatternDiagramNode[]->aPatternNode[];
                               aPatternNode.theDeclaration.getSon2->anAST[];
                               (mps[],anAST.frag[],anAST[],ObjSpecText[],none
                                (*streamName[]*) ,80,0,false
                                (*abstractPresentation*) ,false
                                (*showSemanticErrors*) ,false
                                (*includeComments*) ,false,false,false,false,'',
                                false (*onlyProperties*) ,false,false
                                (*
                                 test*) )->ppFragment;
                               (1,ObjSpecText.length-3)->ObjSpecText.sub
                                 ->t.puttext
                            else
                               '<<ObjectSpecification>>'->t.puttext
                           if);
                           (if aPatternDiagramNode## <=
                           theListDiagram.DiagramNode## then
                               aPatternDiagramNode[]->aDiagramNode[];
                               (aDiagramNode.theDeclaration[],t)
                                 ->(aPatternDiagramNode.theSifEditor).parse
                            else
                               (if aPatternDiagramNode## <=
                               theListDiagram.NonTerminalNode## then
                                   aPatternDiagramNode[]->aNonTerminalNode[];
                                   (aNonTerminalNode.unexp[],t)
                                     ->(aPatternDiagramNode.theSifEditor).parse
                                else
                                   'BindingConnectorOnInit: Source neither DiagramNode nor NonTerminalNode??'
                                     ->putline
                               if)
                           if)
                       if)
                   if)
               if)
            else
               'Destination must be a virtual or a binding declaration'
                 ->AlertUser
           if)
        else
           'Source or destination is not part of a pattern diagram'->AlertUser
       if)
   if);
   gppProp.noGlobalinteractivemode->gppProp.globalInteractivemode;
   autosave;
   true->repair
#)  

-- PatternVariableConnectorOnInit: Descriptor --
(#
   aPatternDiagramNode,anotherPatternDiagramNode: ^PatternDiagramNode;
   theListDiagram,theOtherListDiagram: ^ListDiagram;
   theOtherOADDiagram: ^OADDiagram;
   aDiagramNode: ^theOtherListDiagram.DiagramNode;
   aNonTerminalNode: ^theListDiagram.NonTerminalNode;
   t: ^Text;
   titleText: @text;
   anAST: ^MPS.AST;
   anExp,anotherExp: ^mps.expanded;
   theNames: ^betaGram.Names;
   theNameDcl: ^betaGram.NameDcl;
   theAttrDecl: ^betaGram.AttributeDecl;
   theDesc: ^betaGram.ObjectDescriptor;
   existingConnectors: ^ObjectList;
   theCon: ^Connector
do
   (if switch[52] then 'PatternVariableConnector onInit!'->putline if);
   false->repair;
   gppProp.busy->gppProp.globalInteractivemode;
   true->getEnds->(node1[],node2[]);
   (if (node1[] <> none ) and (node2[] <> none ) then
       (if (node1## <= PatternDiagramNode##) and
       (node2## <= PatternDiagramNode##) then
           node1[]->aPatternDiagramNode[];
           aPatternDiagramNode.theDiagram->theListDiagram[];
           node2[]->anotherPatternDiagramNode[];
           (if (aPatternDiagramNode## <= theListDiagram.SimpleNode##) then
               aPatternDiagramNode.getASTNode->anExp[];
               anExp.getSon1->theNames[];
               theNames.getSon1->theNameDcl[];
               theNameDcl.getNameDecl->anAST[];
               (if anAST.kind = mps.kinds.unExpanded then
                   '<<NameDecl>>'->t[]
                else
                   theNameDcl.getText->t[]
               if);
               ':##'->t.append;
               anotherPatternDiagramNode.thisDiagram->theOtherListDiagram[];
               (if theOtherListDiagram[] <> none then
                   (if anotherPatternDiagramNode## <=
                   theOtherListDiagram.title## then
                       theOtherListDiagram[]->theOtherOADDiagram[];
                       theOtherOADDiagram.theDescriptor[]->theDesc[];
                       theDesc.father->anotherExp[];
                       (if anotherExp## <= betaGram.AttributeDecl## then
                           anotherExp.getSon1->theNames[];
                           theNames.getSon1->theNameDcl[];
                           theNameDcl.getNameDecl->anAST[];
                           (if anAST.kind = mps.kinds.unExpanded then
                               '<<NameAppl>>'->t.puttext
                            else
                               theNameDcl.getText->t.puttext
                           if);
                           node1.getconnectors->existingConnectors[];
                           (if existingConnectors[] <> none then
                               existingConnectors.scan (#  do  #)
                           if);
                           (anExp[],t)->(aPatternDiagramNode.theSifEditor).parse
                        else
                           Delete;
                           'Destination is singularly defined'->AlertUser
                       if)
                   if)
                else
                   anotherPatternDiagramNode.theDiagram->theOtherListDiagram[];
                   (if
                   (anotherPatternDiagramNode## <=
                    theOtherListDiagram.PatternNode##) or
                   (anotherPatternDiagramNode## <=
                    theOtherListDiagram.VirtualNode##) or
                   (anotherPatternDiagramNode## <=
                    theOtherListDiagram.BindingNode##) or
                   (anotherPatternDiagramNode## <=
                    theOtherListDiagram.FinalNode##) then
                       anotherPatternDiagramNode[]->aDiagramNode[];
                       aDiagramNode.theDeclaration[]->theAttrDecl[];
                       theAttrDecl.getSon1->theNames[];
                       theNames.getSon1->theNameDcl[];
                       theNameDcl.getNameDecl->anAST[];
                       (if anAST.kind = mps.kinds.unExpanded then
                           '<<NameAppl>>'->t.puttext
                        else
                           theNameDcl.getText->t.puttext
                       if);
                       node1.getconnectors->existingConnectors[];
                       (if existingConnectors[] <> none then
                           existingConnectors.scan (#  do  #)
                       if);
                       (anExp[],t)->(aPatternDiagramNode.theSifEditor).parse
                    else
                       'The destination is not a pattern, virtual, binding or final declaration'
                         ->AlertUser
                   if)
               if)
            else
               (if aPatternDiagramNode## <= theListDiagram.NonTerminalNode##
                then
                   aPatternDiagramNode[]->aNonTerminalNode[];
                   '<<NameDecl>>:##'->t[];
                   anotherPatternDiagramNode.thisDiagram->theOtherListDiagram[];
                   (if theOtherListDiagram[] <> none then
                       (if anotherPatternDiagramNode## <=
                       theOtherListDiagram.title## then
                           theOtherListDiagram[]->theOtherOADDiagram[];
                           theOtherOADDiagram.theDescriptor[]->theDesc[];
                           theDesc.father->anotherExp[];
                           (if anotherExp## <= betaGram.AttributeDecl## then
                               anotherExp.getSon1->theNames[];
                               theNames.getSon1->theNameDcl[];
                               theNameDcl.getNameDecl->anAST[];
                               (if anAST.kind = mps.kinds.unExpanded then
                                   '<<NameAppl>>'->t.puttext
                                else
                                   theNameDcl.getText->t.puttext
                               if);
                               node1.getconnectors->existingConnectors[];
                               (if existingConnectors[] <> none then
                                   existingConnectors.scan (#  do  #)
                               if);
                               (aNonTerminalNode.unExp[],t)
                                 ->(aNonTerminalNode.theSifEditor).parse
                            else
                               Delete;
                               'Destination is singularly defined'->AlertUser
                           if)
                       if)
                    else
                       anotherPatternDiagramNode.theDiagram
                         ->theOtherListDiagram[];
                       (if
                       (anotherPatternDiagramNode## <=
                        theOtherListDiagram.PatternNode##) or
                       (anotherPatternDiagramNode## <=
                        theOtherListDiagram.VirtualNode##) or
                       (anotherPatternDiagramNode## <=
                        theOtherListDiagram.BindingNode##) or
                       (anotherPatternDiagramNode## <=
                        theOtherListDiagram.FinalNode##) then
                           anotherPatternDiagramNode[]->aDiagramNode[];
                           aDiagramNode.theDeclaration[]->theAttrDecl[];
                           theAttrDecl.getSon1->theNames[];
                           theNames.getSon1->theNameDcl[];
                           theNameDcl.getNameDecl->anAST[];
                           (if anAST.kind = mps.kinds.unExpanded then
                               '<<NameAppl>>'->t.puttext
                            else
                               theNameDcl.getText->t.puttext
                           if);
                           node1.getconnectors->existingConnectors[];
                           (if existingConnectors[] <> none then
                               existingConnectors.scan (#  do  #)
                           if);
                           (aNonTerminalNode.unExp[],t)
                             ->(aNonTerminalNode.theSifEditor).parse
                        else
                           'The destination is not a pattern, virtual, binding or final declaration'
                             ->AlertUser
                       if)
                   if)
                else
                   Delete;
                   'Source must be either a nonterminal or a simple declaration'
                     ->AlertUser
               if)
           if)
        else
           'Source or destination is not part of a pattern diagram'->AlertUser
       if)
   if);
   Delete;
   gppProp.noGlobalinteractivemode->gppProp.globalInteractivemode;
   autosave;
   true->repair
#)  

-- FrejaOADPagePrivate: Descriptor --
(#  #)  

-- FrejaOnKeyDown: DoPart --
do
   INNER onKeyDown;
     (#
        thePage: ^theOADDocument.Page;
        op: ^theOADDocument.OADPage;
        theObject: ^op.DesignObject;
        thePatternDiagramNode: ^op.PatternDiagramNode;
        theListDiagram: ^op.ListDiagram;
        theDiagram: ^op.Diagram;
        thePosition: ^theListDiagram.localNodes.theCellType;
        theDiagPos: ^op.patternDiagrams.theList.theCellType;
        x,y,left,top,right,bottom: @integer
     do
     (*'KbdEvent, frejaLocked is: '->putText;
      Frejalocked->putInt;
      newLine;*)
        (if fragmentBrowserIsActive then
            true->ok
         else
            (if callbackVerbose then 'Callback KbdEvent'->putLine if);
            (if controlKey then
                true->ok
             else
                false->ok;
                (if keyNr = 65307 (* ESC *) then
                    (if switch[30] then 'KbdEvent: ESC pressed'->putline if);
                    abortCommand
                if);
                theDocument[]->theOADDocument[];
                (if theOADDocument[] <> none then
                    (if theOADDocument.gppProp.globalInteractiveMode <>
                    theOADDocument.gppProp.noGlobalInteractiveMode then
                        true->ok
                     else
                        theOADDocument.currentPage->thePage[];
                        (if thePage[] <> none then
                            (if thePage## <= theOADDocument.OADPage## then
                                thePage[]->op[];
                                (if not op.ongoingTextediting then
                                    (if op.currentObject <> none then
                                        op.currentObject->theObject[];
                                        (if theObject## <=
                                        op.PatternDiagramNode## then
                                            theObject[]
                                              ->thePatternDiagramNode[];
                                            thePatternDiagramNode.theDiagram
                                              ->theListDiagram[];
                                            (if theListDiagram[] <> none then
                                                (if controlKey then
                                                (*(if [*enter*] L[1] = 65293 then
                                                 thePatternDiagramNode.abstract
                                                 if)*)
                                                    (if keyNr
                                                     // (*enter*) 65293 then
                                                     (*theOADDocument.FrejaEditMenu.
                                                      insertAfter.hit*)
                                                        
                                                     //
                                                     (*pil til venstre*)
                                                     65361 then
                                                        op.patternDiagrams.
                                                          theList.locate
                                                          (#
                                                             predicate::< 
                                                               (# 
                                                               do
                                                                  (theListDiagram[]
                                                                   =
                                                                   current.elm.
                                                                     e[])->value
                                                               #)
                                                          #)->theDiagPos[];
                                                        (if theDiagPos[] <> none
                                                        then
                                                            (if
                                                            theDiagPos.pred[] <>
                                                            none then
                                                                theDiagPos.pred.
                                                                  elm.e[]
                                                                  ->
                                                                    theDiagram[];
                                                                theDiagram.
                                                                  titlenode[]
                                                                  ->
                                                                    op.
                                                                      currentObject;
                                                                theDiagram.
                                                                  titleNode.
                                                                  onSelect
                                                             else
                                                                ascii.bel
                                                                  ->screen.put
                                                            if)
                                                        if)
                                                     // (*pil op*) 65362 then
                                                        (if not
                                                        (theListDiagram.
                                                           localNodes.empty)
                                                         then
                                                            theListDiagram.
                                                              localNodes.locate
                                                              (#
                                                                 predicate::< 
                                                                   (# 
                                                                   do
                                                                      (thePatternDiagramNode[]
                                                                       =
                                                                       current.
                                                                         elm[])
                                                                        ->value
                                                                   #)
                                                              #)->thePosition[];
                                                            (if thePosition[] <>
                                                            none then
                                                                (if
                                                                thePosition.
                                                                  pred[] <> none
                                                                then
                                                                    thePosition.
                                                                      pred.elm[]
                                                                      ->
                                                                        op.
                                                                          currentObject;
                                                                    thePosition.
                                                                      pred.elm.
                                                                      onSelect
                                                                 else
                                                                    theListDiagram
                                                                    .titleNode[]
                                                                      ->
                                                                        op.
                                                                          currentObject;
                                                                    theListDiagram
                                                                    .titleNode.
                                                                      onSelect
                                                                if)
                                                             else
                                                                ascii.bel
                                                                  ->screen.put
                                                            if)
                                                         else
                                                            ascii.bel
                                                              ->screen.put
                                                        if)
                                                     //
                                                     (*pil til hoejre*)
                                                     65363 then
                                                        op.patternDiagrams.
                                                          theList.locate
                                                          (#
                                                             predicate::< 
                                                               (# 
                                                               do
                                                                  (theListDiagram[]
                                                                   =
                                                                   current.elm.
                                                                     e[])->value
                                                               #)
                                                          #)->theDiagPos[];
                                                        (if theDiagPos[] <> none
                                                        then
                                                            (if
                                                            theDiagPos.succ[] <>
                                                            none then
                                                                theDiagPos.succ.
                                                                  elm.e[]
                                                                  ->
                                                                    theDiagram[];
                                                                theDiagram.
                                                                  titlenode[]
                                                                  ->
                                                                    op.
                                                                      currentObject;
                                                                theDiagram.
                                                                  titleNode.
                                                                  onSelect
                                                             else
                                                                ascii.bel
                                                                  ->screen.put
                                                            if)
                                                        if)
                                                     // (*pil ned*) 65364 then
                                                        (if not
                                                        (theListDiagram.
                                                           localNodes.empty)
                                                         then
                                                            theListDiagram.
                                                              localNodes.locate
                                                              (#
                                                                 predicate::< 
                                                                   (# 
                                                                   do
                                                                      (thePatternDiagramNode[]
                                                                       =
                                                                       current.
                                                                         elm[])
                                                                        ->value
                                                                   #)
                                                              #)->thePosition[];
                                                            (if thePosition[] <>
                                                            none then
                                                                (if
                                                                thePosition.
                                                                  succ[] <> none
                                                                then
                                                                    thePosition.
                                                                      succ.elm[]
                                                                      ->
                                                                        op.
                                                                          currentObject;
                                                                    thePosition.
                                                                      succ.elm.
                                                                      onSelect
                                                                 else
                                                                    ascii.bel
                                                                      ->
                                                                        screen.
                                                                          put
                                                                if)
                                                             else
                                                                (
                                                                theListDiagram.
                                                                  localNodes.
                                                                  head).elm[]
                                                                  ->
                                                                    op.
                                                                      currentObject;
                                                                (
                                                                theListDiagram.
                                                                  localNodes.
                                                                  head).elm.
                                                                  onSelect
                                                            if)
                                                         else
                                                            ascii.bel
                                                              ->screen.put
                                                        if)
                                                    if)
                                                if)
                                            if)
                                        if)
                                    if)
                                if)
                            if)
                        if);
                        (if not theOADDocument.FrejaEditMenu.TextModeOn then
                            (if controlKey then
                                (if keyNr
                                 // (*space*) 32 then
                                    (if not
                                    theOADDocument.FrejaEditMenu.iTextEdit.
                                      isDisabled then
                                        theOADDocument.FrejaEditMenu.iTextEdit.
                                          hit
                                    if)
                                 // (*A*) 65 then
                                    (if not
                                    theOADDocument.FrejaEditMenu.iPasteAfter.
                                      isDisabled then
                                        theOADDocument.FrejaEditMenu.iPasteAfter
                                        .hit
                                    if)
                                 // (*B*) 66 then
                                 (* theOADDocument.FrejaEditMenu.iPasteBefore.hit*)
                                    
                                 // (*U*) 85 then
                                    (if not
                                    theOADDocument.FrejaEditMenu.iPasteBefore.
                                      isDisabled then
                                        theOADDocument.FrejaEditMenu.
                                          iPasteBefore.hit
                                    if)
                                 // (*a*) 97 then
                                    (if not
                                    theOADDocument.FrejaEditMenu.insertAfter.
                                      isDisabled then
                                        theOADDocument.FrejaEditMenu.insertAfter
                                        .hit
                                    if)
                                 // (*b*) 98 then
                                 (* theOADDocument.FrejaEditMenu.insertBeforeItem.hit*)
                                    
                                 // (*c*) 99 then
                                    (if not
                                    theOADDocument.FrejaEditMenu.iCopy.
                                      isDisabled then
                                        theOADDocument.FrejaEditMenu.iCopy.hit
                                    if)
                                 // (*d*) 100 then
                                    (if not
                                    theOADDocument.ViewMenu.detailItem.
                                      isDisabled then
                                        theOADDocument.ViewMenu.detailItem.hit
                                    if)
                                 // (*f*) 102 then
                                    
                                 // (*h*) 104 then
                                    (if not
                                    theOADDocument.AttributeKindMenu.attribute.
                                      isDisabled then
                                        theOADDocument.AttributeKindMenu.
                                          attribute.hit
                                    if)
                                 // (*i*) 105 then
                                    
                                 // (*j*) 106 then
                                    (if not
                                    theOADDocument.FrejaEditMenu.iTextEdit.
                                      isDisabled then
                                        theOADDocument.FrejaEditMenu.iTextEdit.
                                          hit
                                    if)
                                 // (*k*) 107 then
                                    (if not
                                    theOADDocument.ViewMenu.AbstractItem.
                                      isDisabled then
                                        theOADDocument.ViewMenu.AbstractItem.hit
                                    if)
                                 // (*l*) 108 then
                                    (if not
                                    theOADDocument.FrejaEditMenu.iShowOptionals.
                                      isDisabled then
                                        theOADDocument.FrejaEditMenu.
                                          iShowOptionals.hit
                                    if)
                                 // (*m*) 109 then
                                    
                                 // (*n*) 110 then
                                    (if not
                                    theOADDocument.FrejaEditMenu.
                                      iRemoveOptionals.isDisabled then
                                        theOADDocument.FrejaEditMenu.
                                          iRemoveOptionals.hit
                                    if)
                                 // (*o*) 111 then
                                    (if not
                                    theOADDocument.AttributeKindMenu.operation.
                                      isDisabled then
                                        theOADDocument.AttributeKindMenu.
                                          operation.hit
                                    if)
                                 // (*p*) 112 then
                                    (if not
                                    theOADDocument.AttributeKindMenu.newClass.
                                      isDisabled then
                                        theOADDocument.AttributeKindMenu.
                                          newClass.hit
                                    if)
                                 // (*q*) 113 then
                                    theFileMenu.Quit.hit
                                 // (*r*) 114 then
                                    
                                 // (*s*) 115 then
                                    theOADDocument.FrejaEditMenu.iFind.hit
                                 // (*t*) 116 then
                                    (if not
                                    theOADDocument.FrejaEditMenu.iEditOtherText.
                                      isDisabled then
                                        theOADDocument.FrejaEditMenu.
                                          iEditOtherText.hit
                                    if)
                                 // (*u*) 117 then
                                    (if not
                                    theOADDocument.FrejaEditMenu.
                                      insertBeforeItem.isDisabled then
                                        theOADDocument.FrejaEditMenu.
                                          insertBeforeItem.hit
                                    if)
                                 // (*v*) 118 then
                                    (if not
                                    theOADDocument.FrejaEditMenu.iPaste.
                                      isDisabled then
                                        theOADDocument.FrejaEditMenu.iPaste.hit
                                    if)
                                 // (*w*) 119 then
                                    (if not
                                    theOADDocument.FrejaEditMenu.iEditName.
                                      isDisabled then
                                        theOADDocument.FrejaEditMenu.iEditName.
                                          hit
                                    if)
                                 // (*x*) 120 then
                                    (if not
                                    theOADDocument.FrejaEditMenu.iCut.isDisabled
                                     then
                                        theOADDocument.FrejaEditMenu.iCut.hit
                                    if)
                                 // (*z*) 122 then
                                    (if not
                                    theOADDocument.FrejaEditMenu.iUndo.
                                      isDisabled then
                                        theOADDocument.FrejaEditMenu.iUndo.hit
                                    if)
                                if)
                             else
                                (if keyNr = 65535 (* delete and backspace *)
                                 then
                                    (if thePage.currentObject <> none then
                                        (if
                                        (thePage.currentObject).theText.isModeOn
                                         then
                                            true->ok
                                         else
                                            (if not
                                            theOADDocument.FrejaEditMenu.iClear.
                                              isDisabled then
                                                theOADDocument.FrejaEditMenu.
                                                  iClear.hit
                                            if)
                                        if)
                                     else
                                        (if not
                                        theOADDocument.FrejaEditMenu.iClear.
                                          isDisabled then
                                            theOADDocument.FrejaEditMenu.iClear.
                                              hit
                                        if)
                                    if)
                                 else
                                    true->ok
                                if)
                            if)
                         else
                        (* (if kbdstateP.controlKey = 1 then
                         (if L[1]
                         // [*space*] 32 then
                         theOADDocument.FrejaEditMenu.iTextEdit.hit
                         // [*t*] 116 then
                         theOADDocument.FrejaEditMenu.iRevertTextEdit.hit
                         if)
                         if)*)
                            
                        if)
                    if)
                if)
            if)
        if)
     #)  

-- FrejaOADDocumentOnInit: Descriptor --
(# 
do
   (UserMenu3,'File')->theFileMenu.init;
   (UserMenu2,'Edit')->FrejaEditMenu.init;
   (UserMenu9,'New')->AttributeKindMenu.init;
   (UserMenu8,'Expand')->theExpandMenu.Init;
   theExpandMenu[]->menuBar.remove;
   (UserMenu6,'Relations')->RelationsMenu.init;
   DocCreateMenu.init;
   (* Graphics *)
   DocAlignMenu.init;
   false (* added by pahe to speed up the following kludge *) ->menuBar.update;
   UserMenu7 (* Page *)
   (* ->ObjectMenu.insertBefore;
    UserMenu5 [* Object *] *) ->DocAlignMenu.insertBefore;
   9 (* MenuID.AlignMenu *) ->DocCreateMenu.insertBefore;
   4 (* MenuID.CreateMenu *) ->ViewMenu.insertBefore;
   UserMenu4 (* View *) ->RelationsMenu.insertBefore;
   UserMenu6 (* Relations *) ->AttributeKindMenu.insertBefore;
   UserMenu9 (* Create *) ->FrejaEditMenu.insertBefore;
   UserMenu2 (* Edit *) ->theFileMenu.insertBefore
#)

-- FrejaMouseDown: Descriptor --
(# theOADDocument: ^OADDocument
do
   (if switch[30] then 'FrejaMouseDown'->putline if);
   (if theDocument[] <> none then
       theDocument[]->theOADDocument[];
       (if theOADDocument.gppProp.DiagramPositioning <>
       theOADDocument.gppProp.AllAuto then
           (if theOADDocument.theWorkPage[] <> none then
               (if
               theOADDocument.theWorkPage.patterndiagrams.
                 interactiveNewDiagram[] <> none then
                   (x->designUtils.worldToPoints,y->designUtils.worldToPoints)
                     ->
                       theOADDocument.theWorkPage.patterndiagrams.
                         interactiveNewDiagram.titleNode.concludeDisplay;
                   none
                     ->
                       theOADDocument.theWorkPage.patterndiagrams.
                         interactiveNewDiagram[];
                   cursor.restore
               if)
           if)
       if)
   if)
#)  

-- frejaSetReadOnly: DoPart --
do
   (if not readOnlyModeOn then
       true->readOnlyModeOn;
       'Write protected'->statusbar.set;
       FrejaEditMenu.iUndo.mydisable;
       FrejaEditMenu.iCut.mydisable;
       (* FrejaEditMenu.iCopy.mydisable;*)
       FrejaEditMenu.iPasteBefore.mydisable;
       FrejaEditMenu.iPaste.mydisable;
       FrejaEditMenu.iPasteAfter.mydisable;
       FrejaEditMenu.iClear.mydisable;
       FrejaEditMenu.insertBeforeItem.mydisable;
       FrejaEditMenu.insertAfter.mydisable;
       FrejaEditMenu.iEditName.mydisable;
       FrejaEditMenu.iTextEdit.mydisable;
       FrejaEditMenu.iRemoveOptionals.mydisable;
       FrejaEditMenu.iShowOptionals.mydisable;
       FrejaEditMenu.iCheck.mydisable;
       AttributeKindMenu.disable;
       theExpandMenu.disable;
       RelationsMenu.disable
   if)  

-- frejaUnsetReadOnly: DoPart --
do
   (if readOnlyModeOn and (not diagISreadOnly) then
       false->readOnlyModeOn;
       statusbar.reset;
       FrejaEditMenu.iUndo.myenable;
       FrejaEditMenu.iCut.myenable;
       (* FrejaEditMenu.iCopy.myenable;*)
       FrejaEditMenu.iPasteBefore.myenable;
       FrejaEditMenu.iPaste.myenable;
       FrejaEditMenu.iPasteAfter.myenable;
       FrejaEditMenu.iClear.myenable;
       FrejaEditMenu.insertBeforeItem.myenable;
       FrejaEditMenu.insertAfter.myenable;
       FrejaEditMenu.iEditName.myenable;
       FrejaEditMenu.iTextEdit.myenable;
       FrejaEditMenu.iRemoveOptionals.myenable;
       FrejaEditMenu.iShowOptionals.myenable;
       FrejaEditMenu.iCheck.myenable;
       AttributeKindMenu.enable;
       theExpandMenu.enable;
       RelationsMenu.enable
   if)  

-- GraphicalInterfaceEnableEditName: DoPart --
do theDesignInterface.theOADDocument.FrejaEditMenu.iEditName.enable  

-- theGraphicalInterfaceDisableEditName: DoPart --
do theDesignInterface.theOADDocument.FrejaEditMenu.iEditName.disable  

-- theGraphicalInterfaceEnablePaste: DoPart --
do theDesignInterface.theOADDocument.FrejaEditMenu.iPaste.enable  

-- theGraphicalInterfaceDoOADPaste: DoPart --
do v->theDesignInterface.theOADDocument.doOADPaste  

-- theGraphicalInterfaceDoObjectPaste: DoPart --
do v->theDesignInterface.theOADDocument.doObjectPaste  

-- theGraphicalInterfacePasteGroupWithOAD: DoPart --
do v->theDesignInterface.theOADDocument.pasteGroupWithOAD  

