ORIGIN '../freja';
INCLUDE '../designgetapplwidget'
        '~beta/containers/v1.6/seqContainers'
        '~beta/sysutils/v1.6/endian'
        '~beta/guienv/v1.6/utils/private/promptsbody';
-- FrejaCheckEditMenuTextEdit: DoPart --
do
   not FrejaEditMenu.TextModeOn->FrejaEditMenu.TextModeOn;
   FrejaEditMenu.TextModeOn->FrejaEditMenu.iTextEdit.Check  

-- openAssociationDialog: DoPart --
do
     (# theDialog: ^AssociationDialog
     do
        &AssociationDialog[]->theDialog[];
        (theAssociationConnector[],theName[],leftRoleName[],rightRoleName[],
         implementation,leftMulFrom,leftMulTo,rightMulFrom,rightMulTo,embed,
         description[])->theDialog.open
     #)  

-- openAggregationDialog: DoPart --
do
     (# theDialog: ^AggregationDialog
     do
        &AggregationDialog[]->theDialog[];
        (theAggregationConnector[],theName[],kind,implementation,leftMulFrom,
         leftMulTo,rightMulFrom,rightMulTo,description[])->theDialog.open
     #)  

-- frejaPromptForBoolean: DoPart --
do
     (# maxLength: @integer; line,t: ^text
     do
        msgText.reset;
        getMaxLineLength:
          (# 
          do
             msgText.getLine->line[];
             (if line[] <> none then
                 (if line.length > 0 then
                     (maxLength,line.length)->max->maxLength;
                     restart getmaxLineLength
                 if)
             if)
          #);
        msgText.reset;
        msgText.getLine;
        msgText.getLine->line[];
        (if line.length > 0 then
            msgText.reset;
            msgText.getLine;
            &Text[]->t[];
            (for i: maxLength-msgText.getPos+1 repeat ascii.sp->t.put for);
            (t[],msgText.getPos)->msgText.insert
        if);
        (* The above is a hack that ensures proper resize of prompt window
         when using multi-line message texts *)
        (none ,titleText[],msgText[])
          ->theFragmentbrowser.promptForBoolean
            (#
               popup::< 
                 (# 
                 do private.theMessage.theEventHandler.onLabelChanged
                 #);
               ok::<  (#  do yes->THIS(promptForBoolean).ok #);
               notok::<  (#  do no->THIS(promptForBoolean).ok #)
            #)
     #)  

-- FrejaDesignInterfaceDoPart: DoPart --
do
   false->userdataVerbose;
   true
     ->ShowSifSelection
     (*toby: Hack, because editormenu is currently not initialised
      ess: udmaerket hack :-) *) ;
   false->verbose;
   false->callbackVerbose;
   (* --- Switch documentation ---
    * 1:  Menues and buttons for debugging
    * 12: Events related to change of focus
    * 17: Save, Open, Quit, etc.
    * 30: Callbacks
    * 40: Communication with Sif
    * 50: Specializations
    * 51: Binding connectors
    * 52: Pattern variable connectors
    * 53: Association
    * 54: Aggregation
    * 60: AST editing
    * 70: display, detail, abstract, etc.
    * 80: Text editing
    * 90: Tree prettyprint
    * 99: Object diagrams
    *)
   false->switch[1]->switch[12]->switch[17]->switch[30]->switch[40]->switch[50]
     ->switch[51]->switch[52]->switch[53]->switch[54]->switch[60]->switch[70]
     ->switch[80]->switch[90]->switch[99];
     

-- FrejaDoPart: Descriptor --
(# 
do
(*'Mjolner BETA System - Freja v2.1(1)'->putline;
 'Please send error reports and comments to freja@mjolner.dk'->putline*) 
#)  

-- FrejaFileDialog: DoPart --
do
   theFragmentBrowser.FileCreationDialog->t[];
   (if t[] <> none then t->filename if)  

-- FrejaDesignInterfaceOnInit: Descriptor --
(# 
do
   theFragmentBrowser.designsetup;
   theFragmentBrowser;
   (theFragmentBrowser.mps.ast[],theFragmentBrowser.mps.betaCFL[])
     ->(mps[],betaGram[]);
   theExternalInterface[]
     ->theFragmentBrowser.ymerBrowser.edenv.frejaInterface[];
   (UserMenu3,'File')->theFileMenu.init;
   3 (* menuID.editMenu *) ->theFileMenu.insertBefore;
   false->withDexter;
   DocFileMenu[]->menuBar.remove
#)  

-- ChangedFocus: Descriptor --
(#
   t: ^Text;
   ok: @boolean;
   editorid: @Integer;
   anAST: ^MPS.AST;
   theExp: ^mps.expanded;
   graf: ^theGraphicalInterface.DesignInterface;
   theDoc: ^theGraphicalInterface.theDesignInterface.OADDocument;
   ff: ^mps.fragmentform
do
   (if theGraphicalInterface.switch[12]
    // true then
       '----------------------------------------------------------------------'
         ->screen.putLine;
       'Show Sif Selection: '->putText;
       ShowSIFSelection->putBoolean;
       '  newObject.theSifEditor: '->putText;
       (newObject.theSifEditor).fe.id->putInt;
       newline;
       
   if);
   (if oldFocus[] <> none then (* use oldFocus instead of oldObject *)
       theGraphicalInterface.theDesignInterface[]->graf[];
       graf.theDocument[]->theDoc[];
       (if oldFocus.theText.isModeOn then
           (if theGraphicalInterface.switch[12]
            // true then 'Finish textediting'->screen.putLine; 
           if);
           oldFocus.theText.modeOff;
           false->theDoc.FrejaEditMenu.textModeOn
             ->theDoc.FrejaEditMenu.iTextEdit.check;
           
       if);
       
   if);
   (if ShowSIFSelection then
       (if newObject.theSifEditor <> none then
           newObject.getASTNode->anAST[];
           (if anAST[] <> none then
               (if anAST## <= betaGram.AttributeDecl## then
                   anAST[]->theExp[];
                   (if anAST.Symbol = betaGram.RepetitionDecl then
                       theExp.getSon3->anAST[]
                    else
                       theExp.getSon2->anAST[]
                   if);
                   setFocus:
                   (if anAST.kind = mps.kinds.unExpanded then
                       (anAST[],1)->(newObject.theSifEditor).changeFocus
                    else
                       (if (anAST## <= betaGram.ReferenceSpecification##) or
                       (anAST## <= betaGram.Remote##) then
                           anAST[]->theExp[];
                           theExp.getSon1->anAST[];
                           restart setFocus
                        else
                           (newObject.getASTNode,1)
                             ->(newObject.theSifEditor).changeFocus
                       if)
                   if)
                else
                   (newObject.getASTNode,1)
                     ->(newObject.theSifEditor).changeFocus
               if)
            else
               newObject.getFragment->ff[];
               newObject.astIndex
                 ->ff.indexToNode
                   (#
                      indexOutOfRange::< 
                        (# 
                        do 'indexOutOfRange'->putLine; true->continue; 
                        #);
                      noSuchSymbol::< 
                        (#  do 'noSuchSymbol'->putLine; true->continue;  #);
                      grammarGenRefArrayError::< 
                        (# 
                        do 'grammarGenRefArrayError'->putLine; true->continue; 
                        #)
                   #)->anAST[];
               (anAST[],1)->(newObject.theSifEditor).changeFocus
           if);
           
       if)
   if);
   
#)  

-- declarationTextChanged: Descriptor --
(# (* should we use currentFocus or theObject? *) 
do
   (if theObject[] <> none
    // true then
       (if theObject.theDiagram <> none
        // true then
           (if theObject.theSifEditor <> none then
               (node[],theParseText)->(theObject.theSifEditor).parse
           if)
        else
           'DoParse: theDiagram is NONE'->putline; 
       if)
    else
       'DoParse: CurrentFocus is NONE'->putline; 
   if)
#)  

-- openFormInSif: Descriptor --
(# t: ^text; theTitle: @Text; editorId: @Integer
do
   fn[]->theFragmentNode[];
   (if switch[40] then
       (if theFragmentNode[] <> none then
           
        else
           'openFormInSif: theFragmentNode is NONE !!!!'->putline
       if)
   if);
   (if fn.theSifEditor = none then
       (ff.fullname,none )->theController.globalSifCommands.openForm
   if);
   
#)  

-- copy: Descriptor --
(# 
do
   'copy: '->puttext;
   (if theObject[] <> none // true then theObject.astIndex->putint if);
   newline;
   
#)  

-- onFocusChange: Descriptor --
(#
(* Selects the diagram node that corresponds to the focus in sif (node).
 * If the diagram node doesn't exist, the path up to the rooth in the AST is
 * traversed until an AST node that has a corresponding diagram node is found.
 * This diagram node is then detailed and the same is done for the AST nodes
 * that have been met on the way up.
 * The stack S is used for this.
 *)
   theObject: ^PatternDiagramNode;
   theListDiagram: ^ListDiagram;
   anAST2: ^mps.ast;
   S: @stack (# element::< mps.ast (* integerObject *) #);
   io: ^integerObject;
   hasDetailed,noNodeFound: @boolean;
   
do
   false->status;
   true->noNodeFound;
   S.init;
   (if switch[12] // true then 'Freja ----- onFocusChange: '->putline;  if);
   search:
     (# 
     do
        (if switch[12] // true then 'searching...'->putLine;  if);
        (if (node[] <> none )
         // true then
            (if switch[12]
             // true then
                'Freja ----- node.Index: '->putText;
                node.Index->putInt;
                newLine;
                
            if);
            node[]->ASTtoNode->theObject[]
         else
            none ->theObject[]; 
        if);
        (if (theObject[] <> none )
         // true then
            theObject.theDiagram->theListDiagram[];
            (if theObject## <= theListDiagram.FragmentNode## then
            (* don't show these *)
                true->status; leave search
             else
                theObject[]->CurrentObject (#  do true->autoPan #);
                currentFocus[]->oldFocus[];
                theObject[]->CurrentFocus[];
                false->noNodeFound;
                
            if);
            true->status;
            (if S.empty and noNodeFound then
                (if switch[12]
                 // true then 'Freja ----- stack is empty'->putLine; 
                if);
                theGroupPage.patternDiagrams.theList.scanFragmentDiagrams
                  (# 
                  do
                     thisDiagram.localNodes.scan
                       (#
                          theListDiagram: ^ListDiagram;
                          theFragmentNode: ^theListDiagram.FragmentNode
                       do
                          current.theDiagram->theListDiagram[];
                          (if current## <= theListDiagram.fragmentNode## then
                              current[]->theFragmentNode[];
                              (if node.frag[] = theFragmentNode.theFragment then
                                  (if theFragmentNode.currentDecomposDiagram <>
                                  none then
                                      (theFragmentNode.currentDecomposDiagram).
                                      titleNode[]
                                        ->CurrentObject
                                          (#  do true->autoPan #);
                                      currentFocus[]->oldFocus[];
                                      (theFragmentNode.currentDecomposDiagram).
                                      titleNode[]->CurrentFocus[]
                                   else
                                      theFragmentNode[]
                                        ->CurrentObject
                                          (#  do true->autoPan #);
                                      currentFocus[]->oldFocus[];
                                      theFragmentNode[]->CurrentFocus[]
                                  if)
                              if)
                          if)
                       #)
                  #);
                
             else
                openDownUntilNode:
                (if S.empty = false then
                    S.pop->anAST2[];
                    (if switch[12]
                     // true then
                        'Freja ----- pop '->putText;
                        anAST2.index->putInt;
                        newline;
                        
                    if);
                    anAST2[]->ASTtoNode->theObject[];
                    (if theObject[] = none then
                    (* 'detailing... '->statusbar.set;*)
                        (if currentFocus[] <> none then
                            false->currentFocus.IndicateSelection;
                            currentFocus.detail;
                            true->hasDetailed;
                            anAST2[]->ASTtoNode->theObject[];
                            (if theObject[] <> none
                             // true then
                                (if switch[12]
                                 // true then
                                    'Freja ----- node found'->putLine; 
                                if);
                                theObject[]->CurrentObject;
                                currentFocus[]->oldFocus[];
                                theObject[]->CurrentFocus[];
                                true->status;
                                
                             else
                                'node not found in detailed diagram!!'->putLine;
                                
                            if);
                            restart openDownUntilNode
                        if)
                    if)
                if)
            if)
         else
            (if (node[] <> none )
             // true then
                (if switch[12]
                 // true then
                    'Freja ----- node.symbol '->putText;
                    node.symbol->putint;
                    ' node.index '->putText;
                    node.index->putint;
                    ' '->put;
                    node.symbol->betaGram.symbolToName->putLine;
                    
                if);
                (if node.kind
                 // mps.kinds.interior then
                    (if node.symbol
                     // betaGram.SimpleDecl // betaGram.PatternDecl
                     // betaGram.VirtualDecl // betaGram.BindingDecl
                     // betaGram.FinalDecl
                     //
                     betaGram.RepetitionDecl (*// betaGram.VariablePatternDecl*)
                     then
                        (if switch[12]
                         // true then
                            'Freja ----- push '->putText;
                            node.index->putInt;
                            newline;
                            
                        if);
                        (*&integerObject[]->io[];
                         node.index->io.value;
                         io[]->S.push;
                         *)
                        node[]->S.push
                    if)
                 // mps.kinds.unexpanded then
                    (if
                    (node[]->qua (# as:: mps.unexpanded #)).nonterminalSymbol
                     // gram.AttributeDeclOpt then
                        (if switch[12]
                         // true then
                            'Freja ----- push nonterminal'->putText;
                            node.index->putInt;
                            newline;
                            
                        if);
                        (*&integerObject[]->io[];
                         node.index->io.value;
                         io[]->S.push;*)
                        node[]->S.push
                    if)
                if);
                node.father->node[];
                restart search;
                
             else
            (* astIndex not on the path up to the root *)
                (if switch[12] then
                    'astIndex not on the path up to the root'->putLine
                if);
                false->status;
                
            if);
            
        if)
     #);
   (if hasDetailed then Redraw if)
#)  

-- GetStatusFromSif: Descriptor --
(# t: ^Text; theNode: ^PatternDiagramNode; 
do
   (if theObject[] <> none then
       (if theObject## <= PatternDiagramNode##
        // true then
           theObject[]->theNode[];
           (if theNode.theSifEditor = none then
               (if theGraphicalInterface.switch[40]
                // true then
                   'Freja ------ No Sif Editor Instance open'->putline; 
               if);
               
            else
               (theNode.theSifEditor).getStatus
           if);
           
        else
           'Freja ------ ERROR: GetStatus: theObject is not a DiagramNode'
             ->putline;
           
       if)
   if)
#)  

-- DoExpand: Descriptor --
(# 
do
   (if CurrentFocus[] <> none then
       (if CurrentFocus.theDiagram <> none then
           (if CurrentFocus.theSifEditor <> none then
               (if normal then
                   synCatNo->(CurrentFocus.theSifEditor).expandNormal; 
                else
                   synCatNo->(CurrentFocus.theSifEditor).expandOptional; 
               if);
               
           if)
        else
           'DoExpand: theDiagram is NONE'->putline; 
       if)
    else
       'DoExpand: CurrentFocus is NONE'->putline; 
   if)
#)  

-- DoExpandLexem: Descriptor --
(# 
do
   (if CurrentFocus[] <> none then
       (if CurrentFocus.theDiagram <> none then
           (if CurrentFocus.theSifEditor <> none then
               name->(currentFocus.theSifEditor).expandLexem
           if)
       if)
    else
       'DoExpandLexem: CurrentFocus is NONE'->putline; 
   if)
#)  

-- BindingConnectorOnInit: Descriptor --
(#
   aPatternDiagramNode,anotherPatternDiagramNode: ^PatternDiagramNode;
   aDiagramNode: ^theListDiagram.DiagramNode;
   aPatternNode: ^theListDiagram.PatternNode;
   anotherDiagramNode: ^theOtherListDiagram.DiagramNode;
   aNonTerminalNode: ^theListDiagram.NonTerminalNode;
   theListDiagram,theOtherListDiagram: ^ListDiagram;
   anAST: ^MPS.AST;
   theNames: ^betaGram.Names;
   theNameDcl: ^betaGram.NameDcl;
   ObjSpecText: @Text;
   t: ^Text
do
   (if switch[51] then 'BindingConnector onInit'->putline if);
   true->getEnds->(node1[],node2[]);
   delete;
   (if (node1[] <> none ) and (node2[] <> none ) then
       (if (node1## <= PatternDiagramNode##) and
       (node2## <= PatternDiagramNode##) then
           node1[]->aPatternDiagramNode[];
           aPatternDiagramNode.theDiagram->theListDiagram[];
           node2[]->anotherPatternDiagramNode[];
           anotherPatternDiagramNode.theDiagram->theOtherListDiagram[];
           (if
           (anotherPatternDiagramNode## <= theOtherListDiagram.VirtualNode##) or
           (anotherPatternDiagramNode## <= theOtherListDiagram.BindingNode##)
            then
               (if (theListDiagram## <= FragmentDiagram##) or
               (theOtherListDiagram## <= FragmentDiagram##) then
                   'Source and/or destination is a fragment diagram'->AlertUser
                else
                   (if (theListDiagram## <= PatternAttDiagram##) or
                   (theOtherListDiagram## <= PatternAttDiagram##) then
                       'Source and/or destination is an attributes form diagram'
                         ->AlertUser
                    else
                       (if aPatternDiagramNode## <= theListDiagram.title## then
                           'Source must be an attribute of a pattern diagram'
                             ->AlertUser
                        else
                           anotherPatternDiagramNode[]->anotherDiagramNode[];
                           (anotherDiagramNode.theDeclaration).getSon1
                             ->theNames[];
                           theNames.getSon1->theNameDcl[];
                           theNameDcl.getNameDecl->anAST[];
                           (if anAST.kind = mps.kinds.unExpanded then
                               '<<NameDecl>>'->t[]
                            else
                               theNameDcl.getText->t[]
                           if);
                           '::< '->t.puttext;
                           (if aPatternDiagramNode## <=
                           theListDiagram.PatternNode## then
                               aPatternDiagramNode[]->aPatternNode[];
                               (aPatternNode.theDeclaration).getSon2->anAST[];
                               (mps[],anAST.frag[],anAST[],ObjSpecText[],none
                                (*streamName[]*) ,80,0,false
                                (*abstractPresentation*) ,false
                                (*showSemanticErrors*) ,false
                                (*includeComments*) ,false,false,false,false,'',
                                false (*onlyProperties*) ,false,false
                                (*
                                 test*) )->ppFragment;
                               (1,ObjSpecText.length-3)->ObjSpecText.sub
                                 ->t.puttext
                            else
                               '<<ObjectSpecification>>'->t.puttext
                           if);
                           (if aPatternDiagramNode## <=
                           theListDiagram.DiagramNode## then
                               aPatternDiagramNode[]->aDiagramNode[];
                               (aDiagramNode.theDeclaration,t)
                                 ->(aPatternDiagramNode.theSifEditor).parse
                            else
                               (if aPatternDiagramNode## <=
                               theListDiagram.NonTerminalNode## then
                                   aPatternDiagramNode[]->aNonTerminalNode[];
                                   (aNonTerminalNode.unexp,t)
                                     ->(aPatternDiagramNode.theSifEditor).parse
                                else
                                   'BindingConnectorOnInit: Source neither DiagramNode nor NonTerminalNode??'
                                     ->putline
                               if)
                           if)
                       if)
                   if)
               if)
            else
               'Destination must be a virtual or a binding declaration'
                 ->AlertUser
           if)
        else
           'Source or destination is not part of a pattern diagram'->AlertUser
       if)
   if)
#)  

-- FinalBindingConnectorOnInit: Descriptor --
(#
   aPatternDiagramNode,anotherPatternDiagramNode: ^PatternDiagramNode;
   aDiagramNode: ^theListDiagram.DiagramNode;
   aPatternNode: ^theListDiagram.PatternNode;
   anotherDiagramNode: ^theOtherListDiagram.DiagramNode;
   aNonTerminalNode: ^theListDiagram.NonTerminalNode;
   theListDiagram,theOtherListDiagram: ^ListDiagram;
   anAST: ^MPS.AST;
   theNames: ^betaGram.Names;
   theNameDcl: ^betaGram.NameDcl;
   ObjSpecText: @Text;
   t: ^Text
do
   (if switch[51] then 'BindingConnector onInit!'->putline if);
   true->getEnds->(node1[],node2[]);
   delete;
   (if (node1[] <> none ) and (node2[] <> none ) then
       (if (node1## <= PatternDiagramNode##) and
       (node2## <= PatternDiagramNode##) then
           node1[]->aPatternDiagramNode[];
           aPatternDiagramNode.theDiagram->theListDiagram[];
           node2[]->anotherPatternDiagramNode[];
           anotherPatternDiagramNode.theDiagram->theOtherListDiagram[];
           (if
           (anotherPatternDiagramNode## <= theOtherListDiagram.VirtualNode##) or
           (anotherPatternDiagramNode## <= theOtherListDiagram.BindingNode##)
            then
               (if (theListDiagram## <= FragmentDiagram##) or
               (theOtherListDiagram## <= FragmentDiagram##) then
                   'Source and/or destination is a fragment diagram'->AlertUser
                else
                   (if (theListDiagram## <= PatternAttDiagram##) or
                   (theOtherListDiagram## <= PatternAttDiagram##) then
                       'Source and/or destination is an attributes form diagram'
                         ->AlertUser
                    else
                       (if aPatternDiagramNode## <= theListDiagram.title## then
                           'Source must be an attribute of a pattern diagram'
                             ->AlertUser
                        else
                           anotherPatternDiagramNode[]->anotherDiagramNode[];
                           (anotherDiagramNode.theDeclaration).getSon1
                             ->theNames[];
                           theNames.getSon1->theNameDcl[];
                           theNameDcl.getNameDecl->anAST[];
                           (if anAST.kind = mps.kinds.unExpanded then
                               '<<NameDecl>>'->t[]
                            else
                               theNameDcl.getText->t[]
                           if);
                           ':: '->t.puttext;
                           (if aPatternDiagramNode## <=
                           theListDiagram.PatternNode## then
                               aPatternDiagramNode[]->aPatternNode[];
                               (aPatternNode.theDeclaration).getSon2->anAST[];
                               (mps[],anAST.frag[],anAST[],ObjSpecText[],none
                                (*streamName[]*) ,80,0,false
                                (*abstractPresentation*) ,false
                                (*showSemanticErrors*) ,false
                                (*includeComments*) ,false,false,false,false,'',
                                false (*onlyProperties*) ,false,false
                                (*
                                 test*) )->ppFragment;
                               (1,ObjSpecText.length-3)->ObjSpecText.sub
                                 ->t.puttext
                            else
                               '<<ObjectSpecification>>'->t.puttext
                           if);
                           (if aPatternDiagramNode## <=
                           theListDiagram.DiagramNode## then
                               aPatternDiagramNode[]->aDiagramNode[];
                               (aDiagramNode.theDeclaration,t)
                                 ->(aPatternDiagramNode.theSifEditor).parse
                            else
                               (if aPatternDiagramNode## <=
                               theListDiagram.NonTerminalNode## then
                                   aPatternDiagramNode[]->aNonTerminalNode[];
                                   (aNonTerminalNode.unexp,t)
                                     ->(aPatternDiagramNode.theSifEditor).parse
                                else
                                   'BindingConnectorOnInit: Source neither DiagramNode nor NonTerminalNode??'
                                     ->putline
                               if)
                           if)
                       if)
                   if)
               if)
            else
               'Destination must be a virtual or a binding declaration'
                 ->AlertUser
           if)
        else
           'Source or destination is not part of a pattern diagram'->AlertUser
       if)
   if)
#)  

-- PatternVariableConnectorOnInit: Descriptor --
(#
   aPatternDiagramNode,anotherPatternDiagramNode: ^PatternDiagramNode;
   theListDiagram,theOtherListDiagram: ^ListDiagram;
   theOtherOADDiagram: ^OADDiagram;
   aDiagramNode: ^theOtherListDiagram.DiagramNode;
   aNonTerminalNode: ^theListDiagram.NonTerminalNode;
   t: ^Text;
   titleText: @text;
   anAST: ^MPS.AST;
   anExp,anotherExp: ^mps.expanded;
   theNames: ^betaGram.Names;
   theNameDcl: ^betaGram.NameDcl;
   theAttrDecl: ^betaGram.AttributeDecl;
   theDesc: ^betaGram.ObjectDescriptor;
   existingConnectors: ^ObjectList;
   theCon: ^Connector
do
   (if switch[52] then 'PatternVariableConnector onInit!'->putline if);
   true->getEnds->(node1[],node2[]);
   (if (node1[] <> none ) and (node2[] <> none ) then
       (if (node1## <= PatternDiagramNode##) and
       (node2## <= PatternDiagramNode##) then
           node1[]->aPatternDiagramNode[];
           aPatternDiagramNode.theDiagram->theListDiagram[];
           node2[]->anotherPatternDiagramNode[];
           (if (aPatternDiagramNode## <= theListDiagram.SimpleNode##) then
               aPatternDiagramNode.getASTNode->anExp[];
               anExp.getSon1->theNames[];
               theNames.getSon1->theNameDcl[];
               theNameDcl.getNameDecl->anAST[];
               (if anAST.kind = mps.kinds.unExpanded then
                   '<<NameDecl>>'->t[]
                else
                   theNameDcl.getText->t[]
               if);
               ':##'->t.append;
               anotherPatternDiagramNode.thisDiagram->theOtherListDiagram[];
               (if theOtherListDiagram[] <> none then
                   (if anotherPatternDiagramNode## <=
                   theOtherListDiagram.title## then
                       theOtherListDiagram[]->theOtherOADDiagram[];
                       theOtherOADDiagram.theDescriptor->theDesc[];
                       theDesc.father->anotherExp[];
                       (if anotherExp## <= betaGram.AttributeDecl## then
                           anotherExp.getSon1->theNames[];
                           theNames.getSon1->theNameDcl[];
                           theNameDcl.getNameDecl->anAST[];
                           (if anAST.kind = mps.kinds.unExpanded then
                               '<<NameAppl>>'->t.puttext
                            else
                               theNameDcl.getText->t.puttext
                           if);
                           node1.getconnectors->existingConnectors[];
                           (if existingConnectors[] <> none then
                               existingConnectors.scan (#  do  #)
                           if);
                           (anExp[],t)->(aPatternDiagramNode.theSifEditor).parse
                        else
                           Delete;
                           'Destination is singularly defined'->AlertUser
                       if)
                   if)
                else
                   anotherPatternDiagramNode.theDiagram->theOtherListDiagram[];
                   (if
                   (anotherPatternDiagramNode## <=
                    theOtherListDiagram.PatternNode##) or
                   (anotherPatternDiagramNode## <=
                    theOtherListDiagram.VirtualNode##) or
                   (anotherPatternDiagramNode## <=
                    theOtherListDiagram.BindingNode##) or
                   (anotherPatternDiagramNode## <=
                    theOtherListDiagram.FinalNode##) then
                       anotherPatternDiagramNode[]->aDiagramNode[];
                       aDiagramNode.theDeclaration->theAttrDecl[];
                       theAttrDecl.getSon1->theNames[];
                       theNames.getSon1->theNameDcl[];
                       theNameDcl.getNameDecl->anAST[];
                       (if anAST.kind = mps.kinds.unExpanded then
                           '<<NameAppl>>'->t.puttext
                        else
                           theNameDcl.getText->t.puttext
                       if);
                       node1.getconnectors->existingConnectors[];
                       (if existingConnectors[] <> none then
                           existingConnectors.scan (#  do  #)
                       if);
                       (anExp[],t)->(aPatternDiagramNode.theSifEditor).parse
                    else
                       'The destination is not a pattern, virtual, binding or final declaration'
                         ->AlertUser
                   if)
               if)
            else
               (if aPatternDiagramNode## <= theListDiagram.NonTerminalNode##
                then
                   aPatternDiagramNode[]->aNonTerminalNode[];
                   '<<NameDecl>>:##'->t[];
                   anotherPatternDiagramNode.thisDiagram->theOtherListDiagram[];
                   (if theOtherListDiagram[] <> none then
                       (if anotherPatternDiagramNode## <=
                       theOtherListDiagram.title## then
                           theOtherListDiagram[]->theOtherOADDiagram[];
                           theOtherOADDiagram.theDescriptor->theDesc[];
                           theDesc.father->anotherExp[];
                           (if anotherExp## <= betaGram.AttributeDecl## then
                               anotherExp.getSon1->theNames[];
                               theNames.getSon1->theNameDcl[];
                               theNameDcl.getNameDecl->anAST[];
                               (if anAST.kind = mps.kinds.unExpanded then
                                   '<<NameAppl>>'->t.puttext
                                else
                                   theNameDcl.getText->t.puttext
                               if);
                               node1.getconnectors->existingConnectors[];
                               (if existingConnectors[] <> none then
                                   existingConnectors.scan (#  do  #)
                               if);
                               (aNonTerminalNode.unExp,t)
                                 ->(aNonTerminalNode.theSifEditor).parse
                            else
                               Delete;
                               'Destination is singularly defined'->AlertUser
                           if)
                       if)
                    else
                       anotherPatternDiagramNode.theDiagram
                         ->theOtherListDiagram[];
                       (if
                       (anotherPatternDiagramNode## <=
                        theOtherListDiagram.PatternNode##) or
                       (anotherPatternDiagramNode## <=
                        theOtherListDiagram.VirtualNode##) or
                       (anotherPatternDiagramNode## <=
                        theOtherListDiagram.BindingNode##) or
                       (anotherPatternDiagramNode## <=
                        theOtherListDiagram.FinalNode##) then
                           anotherPatternDiagramNode[]->aDiagramNode[];
                           aDiagramNode.theDeclaration->theAttrDecl[];
                           theAttrDecl.getSon1->theNames[];
                           theNames.getSon1->theNameDcl[];
                           theNameDcl.getNameDecl->anAST[];
                           (if anAST.kind = mps.kinds.unExpanded then
                               '<<NameAppl>>'->t.puttext
                            else
                               theNameDcl.getText->t.puttext
                           if);
                           node1.getconnectors->existingConnectors[];
                           (if existingConnectors[] <> none then
                               existingConnectors.scan (#  do  #)
                           if);
                           (aNonTerminalNode.unExp,t)
                             ->(aNonTerminalNode.theSifEditor).parse
                        else
                           'The destination is not a pattern, virtual, binding or final declaration'
                             ->AlertUser
                       if)
                   if)
                else
                   Delete;
                   'Source must be either a nonterminal or a simple declaration'
                     ->AlertUser
               if)
           if)
        else
           'Source or destination is not part of a pattern diagram'->AlertUser
       if)
   if);
   Delete
#)  

-- FrejaOADPagePrivate: Descriptor --
(#  #)  

-- FrejaOnKeyDown: DoPart --
do
     (#
        thePage: ^theOADDocument.Page;
        op: ^theOADDocument.OADPage;
        theObject: ^op.DesignObject;
        thePatternDiagramNode: ^op.PatternDiagramNode;
        theListDiagram: ^op.ListDiagram;
        theDiagram: ^op.Diagram;
        thePosition: ^theListDiagram.localNodes.theCellType;
        theDiagPos: ^op.patternDiagrams.theList.theCellType;
        x,y,left,top,right,bottom: @integer
     do
     (*'KbdEvent, frejaLocked is: '->putText;
      Frejalocked->putInt;
      newLine;*)
        (if theFragmentBrowser.isActive then
            true->ok
         else
            (if callbackVerbose then 'Callback KbdEvent'->putLine if);
            (if controlKey then
                true->ok
             else
                false->ok;
                (if keyNr = 65307 (* ESC *) then
                    (if switch[30] then 'KbdEvent: ESC pressed'->putline if);
                    abortCommand
                if);
                theDocument[]->theOADDocument[];
                (if theOADDocument[] <> none then
                    (if theOADDocument.gppProp.globalInteractiveMode <>
                    theOADDocument.gppProp.noGlobalInteractiveMode then
                        true->ok
                     else
                        theOADDocument.currentPage->thePage[];
                        (if thePage[] <> none then
                            (if thePage## <= theOADDocument.OADPage## then
                                thePage[]->op[];
                                (if not op.ongoingTextediting then
                                    (if op.currentObject <> none then
                                        op.currentObject->theObject[];
                                        (if theObject## <=
                                        op.PatternDiagramNode## then
                                            theObject[]
                                              ->thePatternDiagramNode[];
                                            thePatternDiagramNode.theDiagram
                                              ->theListDiagram[];
                                            (if theListDiagram[] <> none then
                                                (if altKey then
                                                (*(if [*enter*] L[1] = 65293 then
                                                 thePatternDiagramNode.abstract
                                                 if)*)
                                                    (if keyNr
                                                     // (*enter*) 65293 then
                                                     (*theOADDocument.FrejaEditMenu.
                                                      insertAfter.hit*)
                                                        
                                                     //
                                                     (*pil til venstre*)
                                                     65361 then
                                                        op.patternDiagrams.
                                                          theList.locate
                                                          (#
                                                             predicate::< 
                                                               (# 
                                                               do
                                                                  (theListDiagram[]
                                                                   =
                                                                   current.elm.
                                                                     e[])->value
                                                               #)
                                                          #)->theDiagPos[];
                                                        (if theDiagPos[] <> none
                                                        then
                                                            (if
                                                            theDiagPos.pred[] <>
                                                            none then
                                                                theDiagPos.pred.
                                                                  elm.e[]
                                                                  ->
                                                                    theDiagram[];
                                                                theDiagram.
                                                                  titlenode[]
                                                                  ->
                                                                    op.
                                                                      currentObject;
                                                                theDiagram.
                                                                  titleNode.
                                                                  onSelect
                                                             else
                                                                ascii.bel
                                                                  ->screen.put
                                                            if)
                                                        if)
                                                     // (*pil op*) 65362 then
                                                        (if not
                                                        (theListDiagram.
                                                           localNodes.empty)
                                                         then
                                                            theListDiagram.
                                                              localNodes.locate
                                                              (#
                                                                 predicate::< 
                                                                   (# 
                                                                   do
                                                                      (thePatternDiagramNode[]
                                                                       =
                                                                       current.
                                                                         elm[])
                                                                        ->value
                                                                   #)
                                                              #)->thePosition[];
                                                            (if thePosition[] <>
                                                            none then
                                                                (if
                                                                thePosition.
                                                                  pred[] <> none
                                                                then
                                                                    thePosition.
                                                                      pred.elm[]
                                                                      ->
                                                                        op.
                                                                          currentObject;
                                                                    thePosition.
                                                                      pred.elm.
                                                                      onSelect
                                                                 else
                                                                    theListDiagram
                                                                    .titleNode[]
                                                                      ->
                                                                        op.
                                                                          currentObject;
                                                                    theListDiagram
                                                                    .titleNode.
                                                                      onSelect
                                                                if)
                                                             else
                                                                ascii.bel
                                                                  ->screen.put
                                                            if)
                                                         else
                                                            ascii.bel
                                                              ->screen.put
                                                        if)
                                                     //
                                                     (*pil til hoejre*)
                                                     65363 then
                                                        op.patternDiagrams.
                                                          theList.locate
                                                          (#
                                                             predicate::< 
                                                               (# 
                                                               do
                                                                  (theListDiagram[]
                                                                   =
                                                                   current.elm.
                                                                     e[])->value
                                                               #)
                                                          #)->theDiagPos[];
                                                        (if theDiagPos[] <> none
                                                        then
                                                            (if
                                                            theDiagPos.succ[] <>
                                                            none then
                                                                theDiagPos.succ.
                                                                  elm.e[]
                                                                  ->
                                                                    theDiagram[];
                                                                theDiagram.
                                                                  titlenode[]
                                                                  ->
                                                                    op.
                                                                      currentObject;
                                                                theDiagram.
                                                                  titleNode.
                                                                  onSelect
                                                             else
                                                                ascii.bel
                                                                  ->screen.put
                                                            if)
                                                        if)
                                                     // (*pil ned*) 65364 then
                                                        (if not
                                                        (theListDiagram.
                                                           localNodes.empty)
                                                         then
                                                            theListDiagram.
                                                              localNodes.locate
                                                              (#
                                                                 predicate::< 
                                                                   (# 
                                                                   do
                                                                      (thePatternDiagramNode[]
                                                                       =
                                                                       current.
                                                                         elm[])
                                                                        ->value
                                                                   #)
                                                              #)->thePosition[];
                                                            (if thePosition[] <>
                                                            none then
                                                                (if
                                                                thePosition.
                                                                  succ[] <> none
                                                                then
                                                                    thePosition.
                                                                      succ.elm[]
                                                                      ->
                                                                        op.
                                                                          currentObject;
                                                                    thePosition.
                                                                      succ.elm.
                                                                      onSelect
                                                                 else
                                                                    ascii.bel
                                                                      ->
                                                                        screen.
                                                                          put
                                                                if)
                                                             else
                                                                (
                                                                theListDiagram.
                                                                  localNodes.
                                                                  head).elm[]
                                                                  ->
                                                                    op.
                                                                      currentObject;
                                                                (
                                                                theListDiagram.
                                                                  localNodes.
                                                                  head).elm.
                                                                  onSelect
                                                            if)
                                                         else
                                                            ascii.bel
                                                              ->screen.put
                                                        if)
                                                    if)
                                                if)
                                            if)
                                        if)
                                    if)
                                if)
                            if)
                        if);
                        (if not theOADDocument.FrejaEditMenu.TextModeOn then
                            (if altKey then
                                (if keyNr
                                 // (*space*) 32 then
                                    (if not
                                    theOADDocument.FrejaEditMenu.iTextEdit.
                                      isDisabled then
                                        theOADDocument.FrejaEditMenu.iTextEdit.
                                          hit
                                    if)
                                 // (*A*) 65 then
                                    (if not
                                    theOADDocument.FrejaEditMenu.iPasteAfter.
                                      isDisabled then
                                        theOADDocument.FrejaEditMenu.iPasteAfter
                                        .hit
                                    if)
                                 // (*B*) 66 then
                                 (* theOADDocument.FrejaEditMenu.iPasteBefore.hit*)
                                    
                                 // (*U*) 85 then
                                    (if not
                                    theOADDocument.FrejaEditMenu.iPasteBefore.
                                      isDisabled then
                                        theOADDocument.FrejaEditMenu.
                                          iPasteBefore.hit
                                    if)
                                 // (*a*) 97 then
                                    (if not
                                    theOADDocument.FrejaEditMenu.insertAfter.
                                      isDisabled then
                                        theOADDocument.FrejaEditMenu.insertAfter
                                        .hit
                                    if)
                                 // (*b*) 98 then
                                 (* theOADDocument.FrejaEditMenu.insertBeforeItem.hit*)
                                    
                                 // (*c*) 99 then
                                    (if not
                                    theOADDocument.FrejaEditMenu.iCopy.
                                      isDisabled then
                                        theOADDocument.FrejaEditMenu.iCopy.hit
                                    if)
                                 // (*d*) 100 then
                                    (if not
                                    theOADDocument.ViewMenu.detailItem.
                                      isDisabled then
                                        theOADDocument.ViewMenu.detailItem.hit
                                    if)
                                 // (*f*) 102 then
                                    (if not
                                    theOADDocument.AttributeKindMenu.
                                      FinalBindOfVirtPattern.isDisabled then
                                        theOADDocument.AttributeKindMenu.
                                          FinalBindOFVirtPattern.hit
                                    if)
                                 // (*h*) 104 then
                                    (if not
                                    theOADDocument.AttributeKindMenu.
                                      LocalPattern.isDisabled then
                                        theOADDocument.AttributeKindMenu.
                                          LocalPattern.hit
                                    if)
                                 // (*i*) 105 then
                                    (if not
                                    theOADDocument.AttributeKindMenu.
                                      VirtualPattern.isDisabled then
                                        theOADDocument.AttributeKindMenu.
                                          VirtualPattern.hit
                                    if)
                                 // (*j*) 106 then
                                    (if not
                                    theOADDocument.FrejaEditMenu.iTextEdit.
                                      isDisabled then
                                        theOADDocument.FrejaEditMenu.iTextEdit.
                                          hit
                                    if)
                                 // (*k*) 107 then
                                    (if not
                                    theOADDocument.ViewMenu.AbstractItem.
                                      isDisabled then
                                        theOADDocument.ViewMenu.AbstractItem.hit
                                    if)
                                 // (*l*) 108 then
                                    (if not
                                    theOADDocument.FrejaEditMenu.iShowOptionals.
                                      isDisabled then
                                        theOADDocument.FrejaEditMenu.
                                          iShowOptionals.hit
                                    if)
                                 // (*m*) 109 then
                                    (if not
                                    theOADDocument.AttributeKindMenu.
                                      BindingOfVirtualPattern.isDisabled then
                                        theOADDocument.AttributeKindMenu.
                                          BindingOfVirtualPattern.hit
                                    if)
                                 // (*n*) 110 then
                                    (if not
                                    theOADDocument.FrejaEditMenu.
                                      iRemoveOptionals.isDisabled then
                                        theOADDocument.FrejaEditMenu.
                                          iRemoveOptionals.hit
                                    if)
                                 // (*o*) 111 then
                                    (if not
                                    theOADDocument.AttributeKindMenu.PartObject.
                                      isDisabled then
                                        theOADDocument.AttributeKindMenu.
                                          PartObject.hit
                                    if)
                                 // (*p*) 112 then
                                    (if not
                                    theOADDocument.AttributeKindMenu.NewPattern.
                                      isDisabled then
                                        theOADDocument.AttributeKindMenu.
                                          NewPattern.hit
                                    if)
                                 // (*q*) 113 then
                                    theFileMenu.Quit.hit
                                 // (*r*) 114 then
                                    (if not
                                    theOADDocument.AttributeKindMenu.
                                      DynamicReference.isDisabled then
                                        theOADDocument.AttributeKindMenu.
                                          DynamicReference.hit
                                    if)
                                 // (*s*) 115 then
                                    theOADDocument.ViewMenu.SearchItem.hit
                                 // (*t*) 116 then
                                    (if not
                                    theOADDocument.FrejaEditMenu.iEditOtherText.
                                      isDisabled then
                                        theOADDocument.FrejaEditMenu.
                                          iEditOtherText.hit
                                    if)
                                 // (*u*) 117 then
                                    (if not
                                    theOADDocument.FrejaEditMenu.
                                      insertBeforeItem.isDisabled then
                                        theOADDocument.FrejaEditMenu.
                                          insertBeforeItem.hit
                                    if)
                                 // (*v*) 118 then
                                    (if not
                                    theOADDocument.FrejaEditMenu.iPaste.
                                      isDisabled then
                                        theOADDocument.FrejaEditMenu.iPaste.hit
                                    if)
                                 // (*w*) 119 then
                                    (if not
                                    theOADDocument.FrejaEditMenu.iEditName.
                                      isDisabled then
                                        theOADDocument.FrejaEditMenu.iEditName.
                                          hit
                                    if)
                                 // (*x*) 120 then
                                    (if not
                                    theOADDocument.FrejaEditMenu.iCut.isDisabled
                                     then
                                        theOADDocument.FrejaEditMenu.iCut.hit
                                    if)
                                 // (*z*) 122 then
                                    (if not
                                    theOADDocument.FrejaEditMenu.iUndo.
                                      isDisabled then
                                        theOADDocument.FrejaEditMenu.iUndo.hit
                                    if)
                                if)
                             else
                                (if keyNr = 65535 (* delete and backspace *)
                                 then
                                    (if not
                                    theOADDocument.FrejaEditMenu.iClear.
                                      isDisabled then
                                        theOADDocument.FrejaEditMenu.iClear.hit
                                    if)
                                 else
                                    true->ok
                                if)
                            if)
                         else
                        (* (if kbdstateP.controlKey = 1 then
                         (if L[1]
                         // [*space*] 32 then
                         theOADDocument.FrejaEditMenu.iTextEdit.hit
                         // [*t*] 116 then
                         theOADDocument.FrejaEditMenu.iRevertTextEdit.hit
                         if)
                         if)*)
                            
                        if)
                    if)
                if)
            if)
        if)
     #)  

-- FrejaOADDocumentOnInit: Descriptor --
(# 
do
(* DocCreateMenu.init;
 *                   DocMakeupMenu.init;
 *                   DocPageMenu.init;
 *                   DocGroupMenu.init;
 *)
   (UserMenu3,'File')->theFileMenu.init;
   (UserMenu2,'Edit')->FrejaEditMenu.init;
   (UserMenu9,'New...')->AttributeKindMenu.init;
   (UserMenu8,'Expand')->theExpandMenu.Init;
   (UserMenu6,'Relations')->RelationsMenu.init;
   DocCreateMenu.init;
   DocMakeUpMenu.init;
   DocAlignMenu.init;
   UserMenu5 (* Object *) ->PageMenu.insertBefore;
   UserMenu7 (* Page *) ->DocAlignMenu.insertBefore;
   9 (* MenuID.AlignMenu *) ->DocMakeUpMenu.insertBefore;
   5 (* MenuID.MakeUpMenu *) ->DocCreateMenu.insertBefore;
   4 (* MenuID.CreateMenu *) ->theExpandMenu.insertBefore;
   UserMenu8 (* Expand *) ->ViewMenu.insertBefore;
   UserMenu4 (* View *) ->RelationsMenu.insertBefore;
   UserMenu6 (* Relations *) ->AttributeKindMenu.insertBefore;
   UserMenu9 (* AttributeKind *) ->FrejaEditMenu.insertBefore;
   UserMenu2 (* Edit *) ->theFileMenu.insertBefore;
   (*  (UserMenu2,'Sif')->EditorMenu.init; *)
   (*  (UserMenu5,'Create') -> ObjectCreateMenu.init;*)
   
#)  

-- FrejaMouseDown: Descriptor --
(# theOADDocument: ^OADDocument
do
   (if switch[30] then 'FrejaMouseDown'->putline if);
   (if theDocument[] <> none then
       theDocument[]->theOADDocument[];
       (if theOADDocument.gppProp.DiagramPositioning <>
       theOADDocument.gppProp.AllAuto then
           (if theOADDocument.theWorkPage[] <> none then
               (if
               theOADDocument.theWorkPage.patternDiagrams.
                 interactiveNewDiagram[] <> none then
                   (x->designUtils.worldToPoints,y->designUtils.worldToPoints)
                     ->
                       theOADDocument.theWorkPage.patternDiagrams.
                         interactiveNewDiagram.titleNode.concludeDisplay;
                   none
                     ->
                       theOADDocument.theWorkPage.patternDiagrams.
                         interactiveNewDiagram[];
                   cursor.restore
               if)
           if)
       if)
   if)
#)  

-- FrejaPromptForText: DoPart --
do
   '                        '->message.append;
   (none ,'Freja',message[],defaultText[])
     ->theFragmentBrowser.promptForText
       (#
          ok::<  (#  do usertext[]->confirm #);
          cancel::<  (#  do THIS(FrejaPromptForText).cancel #);
          popup::< 
            (# 
            do
               (if defaultText[] <> none then
                   private.theText.all->private.theText.selection
               if)
            #)
       #)  

-- frejaSetReadOnly: DoPart --
do
   (if not readOnlyModeOn then
       true->readOnlyModeOn;
       'Write protected'->statusbar.set;
       FrejaEditMenu.iUndo.mydisable;
       FrejaEditMenu.iCut.mydisable;
       (* FrejaEditMenu.iCopy.mydisable;*)
       FrejaEditMenu.iPasteBefore.mydisable;
       FrejaEditMenu.iPaste.mydisable;
       FrejaEditMenu.iPasteAfter.mydisable;
       FrejaEditMenu.iClear.mydisable;
       FrejaEditMenu.insertBeforeItem.mydisable;
       FrejaEditMenu.insertAfter.mydisable;
       FrejaEditMenu.iEditName.mydisable;
       FrejaEditMenu.iTextEdit.mydisable;
       FrejaEditMenu.iRemoveOptionals.mydisable;
       FrejaEditMenu.iShowOptionals.mydisable;
       FrejaEditMenu.iCheck.mydisable;
       AttributeKindMenu.disable;
       theExpandMenu.disable;
       RelationsMenu.disable
   if)  

-- frejaUnsetReadOnly: DoPart --
do
   (if readOnlyModeOn then
       false->readOnlyModeOn;
       statusbar.reset;
       FrejaEditMenu.iUndo.myenable;
       FrejaEditMenu.iCut.myenable;
       (* FrejaEditMenu.iCopy.myenable;*)
       FrejaEditMenu.iPasteBefore.myenable;
       FrejaEditMenu.iPaste.myenable;
       FrejaEditMenu.iPasteAfter.myenable;
       FrejaEditMenu.iClear.myenable;
       FrejaEditMenu.insertBeforeItem.myenable;
       FrejaEditMenu.insertAfter.myenable;
       FrejaEditMenu.iEditName.myenable;
       FrejaEditMenu.iTextEdit.myenable;
       FrejaEditMenu.iRemoveOptionals.myenable;
       FrejaEditMenu.iShowOptionals.myenable;
       FrejaEditMenu.iCheck.myenable;
       AttributeKindMenu.enable;
       theExpandMenu.enable;
       RelationsMenu.enable
   if)  

-- GraphicalInterfaceEnableEditName: DoPart --
do
   theDesignInterface.theDocument[]->theOADDocument[];
   theOADDocument.FrejaEditMenu.iEditName.enable  

-- theGraphicalInterfaceDisableEditName: DoPart --
do
   theDesignInterface.theDocument[]->theOADDocument[];
   theOADDocument.FrejaEditMenu.iEditName.disable  

-- associationDialog: Descriptor --
theFragmentBrowser.window
  (#
     mainCanvas: @canvas
       (#
          Name: @staticText
            (#
               open::< 
                 (#  do (10,15)->position; (60,16)->size; 'Name:'->label #)
            #);
          NameEdit: @textField
            (#
               isOpen: @Boolean;
               eventHandler:: 
                 (#
                    onBeforeChange:: 
                      (# t: ^text; ch: @char
                      do
                         (if isOpen then
                             theText->t[];
                             (if t[] <> none then
                                 (if t.length = 1 then
                                     t.reset;
                                     (if position = 0 then
                                         (if not (t.get->ch->ascii.isLetter)
                                          then
                                             false->allow;
                                             theFragmentBrowser.system.beep
                                         if)
                                      else
                                         (if not
                                         ((t.get->ch->ascii.isDigit) or
                                          (ch->ascii.isLetter)) then
                                             false->allow;
                                             theFragmentBrowser.system.beep
                                         if)
                                     if)
                                  else
                                     false->allow;
                                     theFragmentBrowser.system.beep
                                 if)
                             if)
                         if)
                      #)
                 #);
               open::< 
                 (# 
                 do
                    (if theName[] <> none then theName[]->insert if);
                    (10,35)->position;
                    (378,30)->size;
                    true->isOpen
                 #)
            #);
          RoleCanvas: Canvas
            (#
               roleName: @staticText
                 (#
                    open::< 
                      (# 
                      do (5,18)->position; (82,16)->size; 'Role Name:'->label
                      #)
                 #);
               roleNameFieldDesc:< textField
                 (#
                    isOpen: @Boolean;
                    eventHandler:: 
                      (#
                         onBeforeChange:: 
                           (# t: ^text; ch: @char
                           do
                              (if isOpen then
                                  theText->t[];
                                  (if t[] <> none then
                                      (if t.length = 1 then
                                          t.reset;
                                          (if position = 0 then
                                              (if not
                                              (t.get->ch->ascii.isLetter) then
                                                  false->allow;
                                                  theFragmentBrowser.system.beep
                                              if)
                                           else
                                              (if not
                                              ((t.get->ch->ascii.isDigit) or
                                               (ch->ascii.isLetter)) then
                                                  false->allow;
                                                  theFragmentBrowser.system.beep
                                              if)
                                          if)
                                       else
                                          false->allow;
                                          theFragmentBrowser.system.beep
                                      if)
                                  if)
                              if)
                           #)
                      #);
                    open::< 
                      (# 
                      do
                         (92,12)->position;
                         (80,30)->size;
                         INNER open;
                         true->isOpen
                      #)
                 #);
               roleNameField: @roleNameFieldDesc;
               multiplicity: @staticText
                 (#
                    open::< 
                      (# 
                      do
                         (5,58)->position; (82,16)->size; 'Multiplicity:'->label
                      #)
                 #);
               toLabel: @staticText
                 (#
                    open::< 
                      (# 
                      do (124,59)->position; (16,16)->size; 'to'->label
                      #)
                 #);
               FromField:< textField
                 (#
                    isOpen: @boolean;
                    eventHandler::< 
                      (#
                         onTextChanged::< 
                           (# 
                           do (if isOpen then INNER onTextChanged if)
                           #);
                         onBeforeChange::< 
                           (# t: ^text; ch: @char
                           do
                              (if isOpen then
                                  theText->t[];
                                  (if t[] <> none then
                                      (if t.length = 1 then
                                          t.reset;
                                          (if t.get->ch->ascii.isDigit then
                                              (if '*'->(contents).equal then
                                                  (if
                                                  selection.contents
                                                    ->(contents).equal then
                                                      to.all->selection;
                                                      to.delete;
                                                      '*'->to.insert
                                                   else
                                                      false->allow;
                                                      theFragmentBrowser.system.
                                                        beep
                                                  if)
                                               else
                                                  (if '0' = ch then
                                                      (if position = 0 then
                                                          (if
                                                          ((contents).length =
                                                           0) then
                                                              
                                                           else
                                                              false->allow;
                                                              theFragmentBrowser
                                                              .system.beep
                                                          if)
                                                      if)
                                                  if)
                                              if)
                                           else
                                              (if ch = '*' then
                                                  (if ((contents).length = 0) or
                                                  (selection.contents
                                                     ->(contents).equal) then
                                                      to.all->to.selection;
                                                      to.delete;
                                                      '*'->to.insert
                                                   else
                                                      false->allow;
                                                      theFragmentBrowser.system.
                                                        beep
                                                  if)
                                               else
                                                  false->allow;
                                                  theFragmentBrowser.system.beep
                                              if)
                                          if)
                                       else
                                          false->allow;
                                          theFragmentBrowser.system.beep
                                      if)
                                  if);
                                  INNER onBeforeChange
                              if)
                           #)
                      #);
                    open::< 
                      (# 
                      do
                         (92,52)->position;
                         (30,30)->size;
                         (if theAssociationConn[] = none then
                             '1'->insert
                         if);
                         INNER open;
                         true->isOpen
                      #)
                 #);
               from: @FromField;
               ToField:< textField
                 (#
                    isOpen: @boolean;
                    eventhandler::< 
                      (#
                         onTextChanged:: 
                           (# t: ^text; m: @integer
                           do
                              (if isOpen then
                                  contents->t[];
                                  (if t[] <> none then
                                      (if t.length > 0 then
                                          (if '*'->t.equal then
                                              (if allImplFalse then
                                                  true
                                                    ->
                                                      implementationCanvas.List.
                                                        state;
                                                  gppProp.List->impl
                                              if)
                                           else
                                              t.reset;
                                              t.getint->m;
                                              (if m > 1 then
                                                  (if allImplFalse then
                                                      true
                                                        ->
                                                          implementationCanvas.
                                                            List.state;
                                                      gppProp.List->impl
                                                  if)
                                              if)
                                          if)
                                      if)
                                  if);
                                  INNER onTextChanged
                              if)
                           #);
                         onBeforeChange:: 
                           (# t: ^text; ch: @char
                           do
                              (if isOpen then
                                  theText->t[];
                                  (if t[] <> none then
                                      (if t.length = 1 then
                                          t.reset;
                                          (if t.get->ch->ascii.isDigit then
                                              (if '*'->(contents).equal then
                                                  (if
                                                  selection.contents
                                                    ->(contents).equal then
                                                      
                                                   else
                                                      false->allow;
                                                      theFragmentBrowser.system.
                                                        beep
                                                  if)
                                               else
                                                  (if '0' = ch then
                                                      (if position = 0 then
                                                          (if
                                                          ((contents).length =
                                                           0) then
                                                              
                                                           else
                                                              false->allow;
                                                              theFragmentBrowser
                                                              .system.beep
                                                          if)
                                                      if)
                                                  if)
                                              if)
                                           else
                                              (if ch = '*' then
                                                  (if ((contents).length = 0) or
                                                  (selection.contents
                                                     ->(contents).equal) then
                                                      
                                                   else
                                                      false->allow;
                                                      theFragmentBrowser.system.
                                                        beep
                                                  if)
                                               else
                                                  false->allow;
                                                  theFragmentBrowser.system.beep
                                              if)
                                          if)
                                       else
                                          false->allow;
                                          theFragmentBrowser.system.beep
                                      if)
                                  if);
                                  INNER onBeforeChange
                              if)
                           #)
                      #);
                    open::< 
                      (# 
                      do
                         (142,52)->position;
                         (30,30)->size;
                         (if theAssociationConn[] = none then
                             '1'->insert
                         if);
                         INNER open;
                         true->isOpen
                      #)
                 #);
               to: @ToField;
               getMultiplicities:
                 (# fromVal,toVal: @integer; t: ^text
                 do
                    from.contents->t[];
                    t.reset;
                    (if t.length > 0 then
                        (if '*'->t.equal then
                            - 1->fromVal->toVal
                         else
                            t.getint->fromVal;
                            to.contents->t[];
                            t.reset;
                            (if t.length > 0 then
                                (if '*'->t.equal then
                                    - 1->toVal
                                 else
                                    t.getint->toVal
                                if)
                             else
                                fromVal->toVal
                            if)
                        if)
                     else
                        to.contents->t[];
                        t.reset;
                        (if t.length > 0 then
                            (if '*'->t.equal then
                                - 1->toVal->fromVal
                             else
                                t.getint->toVal->fromVal
                            if)
                         else
                            1->fromVal->toVal
                        if)
                    if)
                 exit (fromVal,toVal)
                 #);
               open::< 
                 (# 
                 do
                    true->border.visible;
                    theFragmentBrowser.borderStyles.etchedIn->border.style;
                    roleName.open;
                    roleNameField.open;
                    multiplicity.open;
                    toLabel.open;
                    from.open;
                    to.open;
                    (184,95)->size;
                    INNER open
                 #)
            #);
          leftCanvasLabel: @staticText
            (#
               open::< 
                 (#  do (15,75)->position; (40,16)->size; 'Source'->label #)
            #);
          leftCanvas: @RoleCanvas
            (#
               roleNameFieldDesc:: 
                 (#
                    open:: 
                      (# 
                      do
                         (if leftRoleName[] <> none then
                             leftRoleName[]->insert
                         if)
                      #)
                 #);
               FromField:: 
                 (#
                    open:: 
                      (# t: @text
                      do
                         (if theAssociationConn[] <> none then
                             (if leftMulFrom >= 0 then
                                 leftMulFrom->t.putint; t[]->insert
                              else
                                 '*'->insert
                             if)
                         if)
                      #)
                 #);
               ToField:: 
                 (#
                    open:: 
                      (# t: @text
                      do
                         (if theAssociationConn[] <> none then
                             (if leftMulTo >= 0 then
                                 leftMulTo->t.putint; t[]->insert
                              else
                                 '*'->insert
                             if)
                         if)
                      #)
                 #);
               open::  (#  do (10,83)->position;  #)
            #);
          rightCanvasLabel: @staticText
            (#
               open::< 
                 (# 
                 do (209,75)->position; (70,16)->size; 'Destination'->label
                 #)
            #);
          rightCanvas: @RoleCanvas
            (#
               roleNameFieldDesc:: 
                 (#
                    open:: 
                      (# 
                      do
                         (if rightRoleName[] <> none then
                             rightRoleName[]->insert
                         if)
                      #)
                 #);
               FromField:: 
                 (#
                    open:: 
                      (# t: @text
                      do
                         (if theAssociationConn[] <> none then
                             (if rightMulFrom >= 0 then
                                 rightMulFrom->t.putint; t[]->insert
                              else
                                 '*'->insert
                             if)
                         if)
                      #)
                 #);
               ToField:: 
                 (#
                    open:: 
                      (# t: @text
                      do
                         (if theAssociationConn[] <> none then
                             (if rightMulTo >= 0 then
                                 rightMulTo->t.putint; t[]->insert
                              else
                                 '*'->insert
                             if)
                         if)
                      #)
                 #);
               open::  (#  do (204,83)->position #)
            #);
          ImplementationCanvasLabel: @staticText
            (#
               open:: 
                 (# 
                 do (15,183)->position; (88,16)->size; 'Implementation'->label
                 #)
            #);
          ImplementationCanvas: @Canvas
            (#
               Repetition: @checkbox
                 (#
                    eventHandler::< 
                      (#
                         onMouseUp::< 
                           (# 
                           do
                              (if state then
                                  gppProp.noImplementation->impl;
                                  rightCanvas.to.all->rightCanvas.to.selection;
                                  rightCanvas.to.delete;
                                  '1'->rightCanvas.to.insert;
                                  rightCanvas.from.all
                                    ->rightCanvas.from.selection;
                                  rightCanvas.from.delete;
                                  '0'->rightCanvas.from.insert
                               else
                                  gppProp.repetition->impl; setAllImplFalse
                              if)
                           #)
                      #);
                    open::< 
                      (# 
                      do (8,16)->position; (81,16)->size; 'Repetition'->label
                      #)
                 #);
               ArrayContainer: @checkbox
                 (#
                    eventHandler::< 
                      (#
                         onMouseUp::< 
                           (# 
                           do
                              (if state then
                                  gppProp.noImplementation->impl; setNoImplMul
                               else
                                  gppProp.arrayContainer->impl; setAllImplFalse
                              if)
                           #)
                      #);
                    open::< 
                      (# 
                      do
                         (8,37)->position;
                         (111,16)->size;
                         'Array Container'->label
                      #)
                 #);
               HashTable: @checkbox
                 (#
                    eventHandler::< 
                      (#
                         onMouseUp::< 
                           (# 
                           do
                              (if state then
                                  gppProp.noImplementation->impl; setNoImplMul
                               else
                                  gppProp.hashTable->impl; setAllImplFalse
                              if)
                           #)
                      #);
                    open::< 
                      (# 
                      do (8,58)->position; (81,15)->size; 'Hash Table'->label
                      #)
                 #);
               ExtensibleHashTable: @checkbox
                 (#
                    eventHandler::< 
                      (#
                         onMouseUp::< 
                           (# 
                           do
                              (if state then
                                  gppProp.noImplementation->impl; setNoImplMul
                               else
                                  gppProp.ExtensibleHashTable->impl;
                                  setAllImplFalse
                              if)
                           #)
                      #);
                    open::< 
                      (# 
                      do
                         (8,79)->position;
                         (147,16)->size;
                         'Extensible Hash Table'->label
                      #)
                 #);
               List: @checkbox
                 (#
                    eventHandler::< 
                      (#
                         onMouseUp::< 
                           (# 
                           do
                              (if state then
                                  gppProp.noImplementation->impl; setNoImplMul
                               else
                                  gppProp.List->impl; setAllImplFalse
                              if)
                           #)
                      #);
                    open::< 
                      (# 
                      do (8,100)->position; (45,16)->size; 'List'->label
                      #)
                 #);
               Set: @checkbox
                 (#
                    eventHandler::< 
                      (#
                         onMouseUp::< 
                           (# 
                           do
                              (if state then
                                  gppProp.noImplementation->impl; setNoImplMul
                               else
                                  gppProp.Set->impl; setAllImplFalse
                              if)
                           #)
                      #);
                    open::< 
                      (# 
                      do (8,121)->position; (39,16)->size; 'Set'->label
                      #)
                 #);
               MultiSet: @checkbox
                 (#
                    eventHandler::< 
                      (#
                         onMouseUp::< 
                           (# 
                           do
                              (if state then
                                  gppProp.noImplementation->impl; setNoImplMul
                               else
                                  gppProp.MultiSet->impl; setAllImplFalse
                              if)
                           #)
                      #);
                    open::< 
                      (# 
                      do (8,142)->position; (75,16)->size; 'Multi Set'->label
                      #)
                 #);
               Stack: @checkbox
                 (#
                    eventHandler::< 
                      (#
                         onMouseUp::< 
                           (# 
                           do
                              (if state then
                                  gppProp.noImplementation->impl; setNoImplMul
                               else
                                  gppProp.Stack->impl; setAllImplFalse
                              if)
                           #)
                      #);
                    open::< 
                      (# 
                      do (8,163)->position; (51,16)->size; 'Stack'->label
                      #)
                 #);
               Queue: @checkbox
                 (#
                    eventHandler::< 
                      (#
                         onMouseUp::< 
                           (# 
                           do
                              (if state then
                                  gppProp.noImplementation->impl; setNoImplMul
                               else
                                  gppProp.Queue->impl; setAllImplFalse
                              if)
                           #)
                      #);
                    open::< 
                      (# 
                      do (8,184)->position; (51,16)->size; 'Queue'->label
                      #)
                 #);
               PriorityQueue: @checkbox
                 (#
                    eventHandler::< 
                      (#
                         onMouseUp::< 
                           (# 
                           do
                              (if state then
                                  gppProp.noImplementation->impl; setNoImplMul
                               else
                                  gppProp.PriorityQueue->impl; setAllImplFalse
                              if)
                           #)
                      #);
                    open::< 
                      (# 
                      do
                         (8,205)->position;
                         (105,16)->size;
                         'Priority Queue'->label
                      #)
                 #);
               open:: 
                 (# 
                 do
                    true->border.visible;
                    theFragmentBrowser.borderStyles.etchedIn->border.style;
                    Repetition.open;
                    ArrayContainer.open;
                    HashTable.open;
                    ExtensibleHashTable.open;
                    List.open;
                    Set.open;
                    MultiSet.open;
                    Stack.open;
                    Queue.open;
                    PriorityQueue.open;
                    Repetition.disable;
                    ArrayContainer.disable;
                    HashTable.disable;
                    ExtensibleHashTable.disable;
                    Set.disable;
                    MultiSet.disable;
                    Stack.disable;
                    Queue.disable;
                    PriorityQueue.disable;
                    (10,191)->position;
                    (184,229)->size;
                    (if impl <> gppProp.noImplementation then
                        (if impl
                         // gppProp.repetition then
                            true->repetition.state
                         // gppProp.arrayContainer then
                            true->arrayContainer.state
                         // gppProp.hashTable then
                            true->HashTable.state
                         // gppProp.extensibleHashTable then
                            true->ExtensibleHashTable.state
                         // gppProp.list then
                            true->List.state
                         // gppProp.set then
                            true->Set.state
                         // gppProp.multiSet then
                            true->MultiSet.state
                         // gppProp.stack then
                            true->Stack.state
                         // gppProp.queue then
                            true->Queue.state
                         // gppProp.priorityQueue then
                            true->PriorityQueue.state
                        if)
                    if)
                 #)
            #);
          embed: @checkbox
            (#
               open::< 
                 (# 
                 do
                    (209,373)->position;
                    (123,16)->size;
                    'Embed'->label;
                    (if theAssociationConn[] <> none then
                        THIS(AssociationDialog).embed->state
                    if)
                 #)
            #);
          checkConstraints: @checkbox
            (#
               open::< 
                 (# 
                 do
                    (209,394)->position;
                    (123,16)->size;
                    'Check constraints'->label
                 #)
            #);
          Description: @staticText
            (#
               open::< 
                 (# 
                 do (10,430)->position; (76,16)->size; 'Description:'->label
                 #)
            #);
          DescriptionEdit: @textEditor
            (#
               open::< 
                 (# 
                 do
                    (10,450)->position;
                    (378,99)->size;
                    theFragmentBrowser.borderStyles.ShadowIn->border.style;
                    (if desc[] <> none then desc[]->contents.insert if)
                 #)
            #);
          setNoImplMul:
            (# 
            do
               rightCanvas.to.all->rightCanvas.to.selection;
               rightCanvas.to.delete;
               '1'->rightCanvas.to.insert;
               rightCanvas.from.all->rightCanvas.from.selection;
               rightCanvas.from.delete;
               '0'->rightCanvas.from.insert
            #);
          setAllImplFalse:
            (# 
            do
               (if not allImplFalse then
                   false->implementationCanvas.Repetition.state
                     ->implementationCanvas.ArrayContainer.state
                     ->implementationCanvas.HashTable.state
                     ->implementationCanvas.ExtensibleHashTable.state
                     ->implementationCanvas.List.state
                     ->implementationCanvas.Set.state
                     ->implementationCanvas.MultiSet.state
                     ->implementationCanvas.Stack.state
                     ->implementationCanvas.Queue.state
                     ->implementationCanvas.PriorityQueue.state
               if)
            #);
          allImplFalse:
            (# value: @Boolean
            do
               not
               (implementationCanvas.Repetition.state or
                implementationCanvas.ArrayContainer.state or
                implementationCanvas.HashTable.state or
                implementationCanvas.ExtensibleHashTable.state or
                implementationCanvas.List.state or
                implementationCanvas.Set.state or
                implementationCanvas.MultiSet.state or
                implementationCanvas.Stack.state or
                implementationCanvas.Queue.state or
                implementationCanvas.PriorityQueue.state)->value
            exit value
            #);
          open::< 
            (# 
            do
               true->border.visible;
               theFragmentBrowser.borderStyles.etchedOut->border.style;
               Name.open;
               NameEdit.open;
               leftCanvas.open;
               leftCanvasLabel.open;
               rightCanvas.open;
               rightCanvasLabel.open;
               implementationCanvas.open;
               implementationCanvasLabel.open;
               checkConstraints.open;
               embed.open;
               Description.open;
               DescriptionEdit.open;
               DescriptionEdit.disable;
               checkConstraints.disable;
               (6,10)->position;
               (398,566)->size;
               NameEdit[]->target
            #)
       #);
     CancelButton: @pushButton
       (#
          eventhandler::< 
            (#
               onMouseUp::< 
                 (# 
                 do
                    gppProp.noGlobalInteractiveMode
                      ->gppProp.globalInteractiveMode;
                    THIS(associationDialog).close
                 #)
            #);
          open::< 
            (#  do (274,586)->position; (60,20)->size; 'Cancel'->label #)
       #);
     OKbutton: @pushButton
       (#
          eventhandler::< 
            (#
               onMouseUp::< 
                 (# theObject: ^theWorkPage.DesignObject; t: ^text
                 do
                    (if theAssociationConn[] = none then
                        &theWorkPage.AssociationConnector[]
                          ->theAssociationConn[]
                    if);
                    mainCanvas.leftCanvas.getMultiplicities
                      ->(leftMulFrom,leftMulTo);
                    mainCanvas.rightCanvas.getMultiplicities
                      ->(rightMulFrom,rightMulTo);
                    (if ((rightMulTo = - 1) or (rightMulTo >= rightMulFrom)) and
                    ((leftMulTo = - 1) or (leftMulTo >= leftMulFrom)) then
                        mainCanvas.NameEdit.contents->t[];
                        (if t.length = 0 then '<<NameDecl>>'->t[] if);
                        mainCanvas.leftCanvas.RoleNameField.contents
                          ->leftRoleName[];
                        (if leftRoleName.length = 0 then
                            none ->leftRoleName[]
                        if);
                        mainCanvas.rightCanvas.RoleNameField.contents
                          ->rightRoleName[];
                        (if rightRoleName.length = 0 then
                            none ->rightRoleName[]
                        if);
                        mainCanvas.descriptionEdit.contents.contents->desc[];
                        (if desc.length = 0 then none ->desc[] if);
                        mainCanvas.embed.state->embed;
                        THIS(associationDialog).close;
                        gppProp.creatingAssociation
                          ->gppProp.globalInteractiveMode;
                        (if theAssociationConn.id = 0 then
                            ('Drag connector from source to destination',t[],
                             impl,leftRoleName[],rightRoleName[],leftMulFrom,
                             leftMulTo,rightMulFrom,rightMulTo,embed,desc[])
                              ->theAssociationConn.interactiveNew
                         else
                            (t[],impl,leftRoleName[],rightRoleName[],
                             leftMulFrom,leftMulTo,rightMulFrom,rightMulTo,
                             embed,desc[])->theAssociationConn.Redisplay
                        if)
                     else
                        'Lower bound of multiplicies must be less than\n or equal to the upper bound'
                          ->alertUser
                    if)
                 #)
            #);
          open::<  (#  do (344,586)->position; (60,20)->size; 'OK'->label #)
       #);
     impl: @integer;
     theName,leftRoleName,rightRoleName,desc: ^text;
     theAssociationConn: ^theWorkPage.AssociationConnector;
     leftMulFrom,leftMulTo,rightMulFrom,rightMulTo: @integer;
     embed: @boolean;
     eventhandler::< 
       (# onAboutToClose::<  (#  do false->okToClose #) #);
     open::< 
       (# x,y,left,top,right,bottom: @integer
       enter
       (theAssociationConn[],theName[],leftRoleName[],rightRoleName[],impl,
        leftMulFrom,leftMulTo,rightMulFrom,rightMulTo,embed,desc[])
       do
          (if theAssociationConn[] = none then
              gppProp.noImplementation->impl
          if);
          mainCanvas.open;
          OKbutton.open;
          CancelButton.open;
          (410,616)->size;
          'Association'->title;
          theFragmentBrowser.mouse.globalPosition->(x,y);
          theFragmentBrowser.system.screenRectangle
            ->((left,top),(right,bottom));
          (if x < left then left->x if);
          (if y < top then top->y if);
          (if x+410 > right then right-410->x if);
          (if y+576 > bottom then bottom-630->y if);
          (x,y)->position;
          INNER open;
          showModal
       #)
  #)  

-- aggregationDialog: Descriptor --
theFragmentBrowser.window
  (#
     mainCanvas: @canvas
       (#
          Name: @staticText
            (#
               open::< 
                 (#  do (10,15)->position; (60,16)->size; 'Name:'->label #)
            #);
          NameEdit: @textField
            (#
               isOpen: @Boolean;
               eventHandler:: 
                 (#
                    onBeforeChange:: 
                      (# t: ^text; ch: @char
                      do
                         (if isOpen then
                             theText->t[];
                             (if t[] <> none then
                                 (if t.length = 1 then
                                     t.reset;
                                     (if position = 0 then
                                         (if not (t.get->ch->ascii.isLetter)
                                          then
                                             false->allow;
                                             theFragmentBrowser.system.beep
                                         if)
                                      else
                                         (if not
                                         ((t.get->ch->ascii.isDigit) or
                                          (ch->ascii.isLetter)) then
                                             false->allow;
                                             theFragmentBrowser.system.beep
                                         if)
                                     if)
                                  else
                                     false->allow;
                                     theFragmentBrowser.system.beep
                                 if)
                             if)
                         if)
                      #)
                 #);
               open::< 
                 (# 
                 do
                    (if theName[] <> none then theName[]->insert if);
                    (10,35)->position;
                    (378,30)->size;
                    true->isOpen
                 #)
            #);
          RoleCanvas: Canvas
            (#
               multiplicity: @staticText
                 (#
                    open::< 
                      (# 
                      do
                         (5,18)->position; (82,16)->size; 'Multiplicity:'->label
                      #)
                 #);
               toLabel: @staticText
                 (#
                    open::< 
                      (# 
                      do (124,19)->position; (16,16)->size; 'to'->label
                      #)
                 #);
               FromField:< textField
                 (#
                    isOpen: @boolean;
                    eventHandler::< 
                      (#
                         onTextChanged::< 
                           (# 
                           do (if isOpen then INNER onTextChanged if)
                           #);
                         onBeforeChange::< 
                           (# 
                           do (if isOpen then INNER onBeforeChange if)
                           #)
                      #);
                    open::< 
                      (# 
                      do
                         (92,12)->position;
                         (30,30)->size;
                         (if theAggregationConn[] = none then
                             '1'->insert
                         if);
                         INNER open;
                         true->isOpen
                      #)
                 #);
               from: @FromField;
               ToField:< textField
                 (#
                    isOpen: @boolean;
                    eventHandler::< 
                      (#
                         onTextChanged::< 
                           (# 
                           do (if isOpen then INNER onTextChanged if)
                           #);
                         onBeforeChange::< 
                           (# 
                           do (if isOpen then INNER onBeforeChange if)
                           #)
                      #);
                    open::< 
                      (# 
                      do
                         (142,12)->position;
                         (30,30)->size;
                         (if theAggregationConn[] = none then
                             '1'->insert
                         if);
                         INNER open;
                         true->isOpen
                      #)
                 #);
               to: @ToField;
               open::< 
                 (# 
                 do
                    true->border.visible;
                    theFragmentBrowser.borderStyles.etchedIn->border.style;
                    multiplicity.open;
                    toLabel.open;
                    from.open;
                    to.open;
                    (184,55)->size;
                    INNER open
                 #)
            #);
          leftCanvasLabel: @staticText
            (#
               open::< 
                 (#  do (15,75)->position; (34,16)->size; 'Whole'->label #)
            #);
          leftCanvas: @RoleCanvas
            (#
               FromField:: 
                 (#
                    eventHandler:: 
                      (#
                         onBeforeChange:: 
                           (# t: ^text; ch: @char
                           do
                              theText->t[];
                              (if t[] <> none then
                                  (if t.length = 1 then
                                      (if
                                      (selection.contents->(contents).equal) or
                                      ((contents).length = 0) then
                                          t.reset;
                                          t.get->ch;
                                          (if (ch = '0') or (ch = '1') then
                                              
                                           else
                                              false->allow;
                                              theFragmentBrowser.system.beep
                                          if)
                                       else
                                          false->allow;
                                          theFragmentBrowser.system.beep
                                      if)
                                   else
                                      false->allow;
                                      theFragmentBrowser.system.beep
                                  if)
                              if)
                           #)
                      #);
                    open:: 
                      (# t: @text
                      do
                         (if theAggregationConn[] <> none then
                             (if wholeMulFrom >= 0 then
                                 wholeMulFrom->t.putint; t[]->insert
                              else
                                 '*'->insert
                             if)
                         if)
                      #)
                 #);
               ToField:: 
                 (#
                    open:: 
                      (# t: @text
                      do
                         (if theAggregationConn[] <> none then
                             (if wholeMulTo >= 0 then
                                 wholeMulTo->t.putint; t[]->insert
                              else
                                 '*'->insert
                             if)
                         if)
                      #)
                 #);
               open::  (#  do to.disable; (10,83)->position;  #)
            #);
          rightCanvasLabel: @staticText
            (#
               open::< 
                 (#  do (209,75)->position; (28,16)->size; 'Part'->label #)
            #);
          rightCanvas: @RoleCanvas
            (#
               FromField:: 
                 (#
                    eventHandler:: 
                      (#
                         onBeforeChange:: 
                           (# t: ^text; ch: @char
                           do
                              theText->t[];
                              (if t[] <> none then
                                  (if t.length = 1 then
                                      t.reset;
                                      (if t.get->ch->ascii.isDigit then
                                          (if '*'->(contents).equal then
                                              (if
                                              selection.contents
                                                ->(contents).equal then
                                                  to.all->selection;
                                                  to.delete;
                                                  '*'->to.insert
                                               else
                                                  false->allow;
                                                  theFragmentBrowser.system.beep
                                              if)
                                           else
                                              (if '0' = ch then
                                                  (if position = 0 then
                                                      (if
                                                      ((contents).length = 0)
                                                       then
                                                          
                                                       else
                                                          false->allow;
                                                          theFragmentBrowser.
                                                            system.beep
                                                      if)
                                                  if)
                                              if)
                                          if)
                                       else
                                          (if ch = '*' then
                                              (if ((contents).length = 0) or
                                              (selection.contents
                                                 ->(contents).equal) then
                                                  to.all->to.selection;
                                                  to.delete;
                                                  '*'->to.insert
                                               else
                                                  false->allow;
                                                  theFragmentBrowser.system.beep
                                              if)
                                           else
                                              false->allow;
                                              theFragmentBrowser.system.beep
                                          if)
                                      if)
                                   else
                                      false->allow;
                                      theFragmentBrowser.system.beep
                                  if)
                              if)
                           #)
                      #);
                    open:: 
                      (# t: @text
                      do
                         (if theAggregationConn[] <> none then
                             (if partMulFrom >= 0 then
                                 partMulFrom->t.putint; t[]->insert
                              else
                                 '*'->insert
                             if)
                         if)
                      #)
                 #);
               ToField:: 
                 (#
                    eventhandler::< 
                      (#
                         onTextChanged:: 
                           (# t: ^text; m: @integer
                           do
                              contents->t[];
                              (if t[] <> none then
                                  (if t.length > 0 then
                                      (if '*'->t.equal then
                                          (if allImplFalse then
                                              (if not
                                              containmentCanvas.byValue.state
                                               then
                                                  true
                                                    ->
                                                      implementationCanvas.Set.
                                                        state;
                                                  gppProp.Set->impl
                                               else
                                                  true
                                                    ->
                                                      implementationCanvas.
                                                        Repetition.state;
                                                  gppProp.Repetition->impl
                                              if)
                                          if)
                                       else
                                          t.reset;
                                          t.getint->m;
                                          (if m > 1 then
                                              (if allImplFalse then
                                                  (if not
                                                  containmentCanvas.byValue.
                                                    state then
                                                      true
                                                        ->
                                                          implementationCanvas.
                                                            Set.state;
                                                      gppProp.Set->impl
                                                   else
                                                      true
                                                        ->
                                                          implementationCanvas.
                                                            Repetition.state;
                                                      gppProp.Repetition->impl
                                                  if)
                                              if)
                                          if)
                                      if)
                                  if)
                              if)
                           #);
                         onBeforeChange:: 
                           (# t: ^text; ch: @char
                           do
                              theText->t[];
                              (if t[] <> none then
                                  (if t.length = 1 then
                                      t.reset;
                                      (if t.get->ch->ascii.isDigit then
                                          (if '*'->(contents).equal then
                                              (if
                                              selection.contents
                                                ->(contents).equal then
                                                  
                                               else
                                                  false->allow;
                                                  theFragmentBrowser.system.beep
                                              if)
                                           else
                                              (if '0' = ch then
                                                  (if position = 0 then
                                                      (if
                                                      ((contents).length = 0)
                                                       then
                                                          
                                                       else
                                                          false->allow;
                                                          theFragmentBrowser.
                                                            system.beep
                                                      if)
                                                  if)
                                              if)
                                          if)
                                       else
                                          (if ch = '*' then
                                              (if ((contents).length = 0) or
                                              (selection.contents
                                                 ->(contents).equal) then
                                                  
                                               else
                                                  false->allow;
                                                  theFragmentBrowser.system.beep
                                              if)
                                           else
                                              false->allow;
                                              theFragmentBrowser.system.beep
                                          if)
                                      if)
                                   else
                                      false->allow;
                                      theFragmentBrowser.system.beep
                                  if)
                              if)
                           #)
                      #);
                    open:: 
                      (# t: @text
                      do
                         (if theAggregationConn[] <> none then
                             (if partMulTo >= 0 then
                                 partMulTo->t.putint; t[]->insert
                              else
                                 '*'->insert
                             if)
                         if)
                      #)
                 #);
               open::  (#  do (204,83)->position #)
            #);
          ImplementationCanvasLabel: @staticText
            (#
               open:: 
                 (# 
                 do (15,143)->position; (88,16)->size; 'Implementation'->label
                 #)
            #);
          ImplementationCanvas: @Canvas
            (#
               Repetition: @checkbox
                 (#
                    eventHandler::< 
                      (#
                         onMouseUp::< 
                           (# 
                           do
                              (if state then
                                  gppProp.noImplementation->impl;
                                  rightCanvas.to.all->rightCanvas.to.selection;
                                  rightCanvas.to.delete;
                                  '1'->rightCanvas.to.insert;
                                  (if containmentCanvas.byValue.state then
                                      rightCanvas.from.all
                                        ->rightCanvas.from.selection;
                                      rightCanvas.from.delete;
                                      '1'->rightCanvas.from.insert
                                   else
                                      rightCanvas.from.all
                                        ->rightCanvas.from.selection;
                                      rightCanvas.from.delete;
                                      '0'->rightCanvas.from.insert
                                  if)
                               else
                                  gppProp.repetition->impl; setAllImplFalse
                              if)
                           #)
                      #);
                    open::< 
                      (# 
                      do (8,16)->position; (81,16)->size; 'Repetition'->label
                      #)
                 #);
               ArrayContainer: @checkbox
                 (#
                    eventHandler::< 
                      (#
                         onMouseUp::< 
                           (# 
                           do
                              (if state then
                                  gppProp.noImplementation->impl; setNoImplMul
                               else
                                  gppProp.arrayContainer->impl; setAllImplFalse
                              if)
                           #)
                      #);
                    open::< 
                      (# 
                      do
                         (8,37)->position;
                         (111,16)->size;
                         'Array Container'->label
                      #)
                 #);
               HashTable: @checkbox
                 (#
                    eventHandler::< 
                      (#
                         onMouseUp::< 
                           (# 
                           do
                              (if state then
                                  gppProp.noImplementation->impl; setNoImplMul
                               else
                                  gppProp.hashTable->impl; setAllImplFalse
                              if)
                           #)
                      #);
                    open::< 
                      (# 
                      do (8,58)->position; (81,15)->size; 'Hash Table'->label
                      #)
                 #);
               ExtensibleHashTable: @checkbox
                 (#
                    eventHandler::< 
                      (#
                         onMouseUp::< 
                           (# 
                           do
                              (if state then
                                  gppProp.noImplementation->impl; setNoImplMul
                               else
                                  gppProp.ExtensibleHashTable->impl;
                                  setAllImplFalse
                              if)
                           #)
                      #);
                    open::< 
                      (# 
                      do
                         (8,79)->position;
                         (147,16)->size;
                         'Extensible Hash Table'->label
                      #)
                 #);
               List: @checkbox
                 (#
                    eventHandler::< 
                      (#
                         onMouseUp::< 
                           (# 
                           do
                              (if state then
                                  gppProp.noImplementation->impl; setNoImplMul
                               else
                                  gppProp.List->impl; setAllImplFalse
                              if)
                           #)
                      #);
                    open::< 
                      (# 
                      do (8,100)->position; (45,16)->size; 'List'->label
                      #)
                 #);
               Set: @checkbox
                 (#
                    eventHandler::< 
                      (#
                         onMouseUp::< 
                           (# 
                           do
                              (if state then
                                  gppProp.noImplementation->impl; setNoImplMul
                               else
                                  gppProp.Set->impl; setAllImplFalse
                              if)
                           #)
                      #);
                    open::< 
                      (# 
                      do (8,121)->position; (39,16)->size; 'Set'->label
                      #)
                 #);
               MultiSet: @checkbox
                 (#
                    eventHandler::< 
                      (#
                         onMouseUp::< 
                           (# 
                           do
                              (if state then
                                  gppProp.noImplementation->impl; setNoImplMul
                               else
                                  gppProp.MultiSet->impl; setAllImplFalse
                              if)
                           #)
                      #);
                    open::< 
                      (# 
                      do (8,142)->position; (75,16)->size; 'Multi Set'->label
                      #)
                 #);
               Stack: @checkbox
                 (#
                    eventHandler::< 
                      (#
                         onMouseUp::< 
                           (# 
                           do
                              (if state then
                                  gppProp.noImplementation->impl; setNoImplMul
                               else
                                  gppProp.Stack->impl; setAllImplFalse
                              if)
                           #)
                      #);
                    open::< 
                      (# 
                      do (8,163)->position; (51,16)->size; 'Stack'->label
                      #)
                 #);
               Queue: @checkbox
                 (#
                    eventHandler::< 
                      (#
                         onMouseUp::< 
                           (# 
                           do
                              (if state then
                                  gppProp.noImplementation->impl; setNoImplMul
                               else
                                  gppProp.Queue->impl; setAllImplFalse
                              if)
                           #)
                      #);
                    open::< 
                      (# 
                      do (8,184)->position; (51,16)->size; 'Queue'->label
                      #)
                 #);
               PriorityQueue: @checkbox
                 (#
                    eventHandler::< 
                      (#
                         onMouseUp::< 
                           (# 
                           do
                              (if state then
                                  gppProp.noImplementation->impl; setNoImplMul
                               else
                                  gppProp.PriorityQueue->impl; setAllImplFalse
                              if)
                           #)
                      #);
                    open::< 
                      (# 
                      do
                         (8,205)->position;
                         (105,16)->size;
                         'Priority Queue'->label
                      #)
                 #);
               open:: 
                 (# 
                 do
                    true->border.visible;
                    theFragmentBrowser.borderStyles.etchedIn->border.style;
                    Repetition.open;
                    ArrayContainer.open;
                    HashTable.open;
                    ExtensibleHashTable.open;
                    List.open;
                    Set.open;
                    MultiSet.open;
                    Stack.open;
                    Queue.open;
                    PriorityQueue.open;
                    (10,151)->position;
                    (184,229)->size;
                    (if impl <> gppProp.noImplementation then
                        (if impl
                         // gppProp.repetition then
                            true->repetition.state
                         // gppProp.arrayContainer then
                            true->arrayContainer.state
                         // gppProp.hashTable then
                            true->HashTable.state
                         // gppProp.extensibleHashTable then
                            true->ExtensibleHashTable.state
                         // gppProp.list then
                            true->List.state
                         // gppProp.set then
                            true->Set.state
                         // gppProp.multiSet then
                            true->MultiSet.state
                         // gppProp.stack then
                            true->Stack.state
                         // gppProp.queue then
                            true->Queue.state
                         // gppProp.priorityQueue then
                            true->PriorityQueue.state
                        if)
                    if)
                 #)
            #);
          containmentCanvasLabel: @staticText
            (#
               open:: 
                 (# 
                 do (209,143)->position; (70,16)->size; 'Containment'->label
                 #)
            #);
          containmentCanvas: @Canvas
            (#
               byReference: @checkbox
                 (#
                    eventhandler::< 
                      (#
                         onMouseUp::< 
                           (# 
                           do
                              (if state then
                                  gppProp.byValue->kind;
                                  true->byValue.state;
                                  leftCanvas.from.all
                                    ->leftCanvas.from.selection;
                                  leftCanvas.from.delete;
                                  '1'->leftCanvas.from.insert;
                                  leftCanvas.from.disable;
                                  implementationCanvas.ArrayContainer.disable;
                                  implementationCanvas.HashTable.disable;
                                  implementationCanvas.ExtensibleHashTable.
                                    disable;
                                  implementationCanvas.List.disable;
                                  implementationCanvas.Set.disable;
                                  implementationCanvas.MultiSet.disable;
                                  implementationCanvas.Stack.disable;
                                  implementationCanvas.Queue.disable;
                                  implementationCanvas.PriorityQueue.disable;
                                  (if not allImplFalse then
                                      (if not
                                      implementationCanvas.Repetition.state then
                                          false
                                            ->
                                              implementationCanvas.
                                                ArrayContainer.state
                                            ->
                                              implementationCanvas.HashTable.
                                                state
                                            ->
                                              implementationCanvas.
                                                ExtensibleHashTable.state
                                            ->implementationCanvas.List.state
                                            ->implementationCanvas.Set.state
                                            ->
                                              implementationCanvas.MultiSet.
                                                state
                                            ->implementationCanvas.Stack.state
                                            ->implementationCanvas.Queue.state
                                            ->
                                              implementationCanvas.PriorityQueue
                                              .state;
                                          true
                                            ->
                                              implementationCanvas.Repetition.
                                                state;
                                          gppProp.Repetition->impl
                                      if)
                                  if)
                               else
                                  gppProp.byReference->kind;
                                  false->byValue.state;
                                  leftCanvas.from.enable;
                                  implementationCanvas.ArrayContainer.enable;
                                  implementationCanvas.HashTable.enable;
                                  implementationCanvas.ExtensibleHashTable.
                                    enable;
                                  implementationCanvas.List.enable;
                                  implementationCanvas.Set.enable;
                                  implementationCanvas.MultiSet.enable;
                                  implementationCanvas.Stack.enable;
                                  implementationCanvas.Queue.enable;
                                  implementationCanvas.PriorityQueue.enable
                              if)
                           #)
                      #);
                    open::< 
                      (# 
                      do (8,16)->position; (93,16)->size; 'By-reference'->label
                      #)
                 #);
               byValue: @checkbox
                 (#
                    eventhandler::< 
                      (#
                         onMouseUp::< 
                           (# 
                           do
                              (if state then
                                  gppProp.byReference->kind;
                                  true->byReference.state;
                                  leftCanvas.from.enable;
                                  implementationCanvas.ArrayContainer.enable;
                                  implementationCanvas.HashTable.enable;
                                  implementationCanvas.ExtensibleHashTable.
                                    enable;
                                  implementationCanvas.List.enable;
                                  implementationCanvas.Set.enable;
                                  implementationCanvas.MultiSet.enable;
                                  implementationCanvas.Stack.enable;
                                  implementationCanvas.Queue.enable;
                                  implementationCanvas.PriorityQueue.enable
                               else
                                  gppProp.byValue->kind;
                                  false->byReference.state;
                                  leftCanvas.from.all
                                    ->leftCanvas.from.selection;
                                  leftCanvas.from.delete;
                                  '1'->leftCanvas.from.insert;
                                  leftCanvas.from.disable;
                                  implementationCanvas.ArrayContainer.disable;
                                  implementationCanvas.HashTable.disable;
                                  implementationCanvas.ExtensibleHashTable.
                                    disable;
                                  implementationCanvas.List.disable;
                                  implementationCanvas.Set.disable;
                                  implementationCanvas.MultiSet.disable;
                                  implementationCanvas.Stack.disable;
                                  implementationCanvas.Queue.disable;
                                  implementationCanvas.PriorityQueue.disable;
                                  (if not allImplFalse then
                                      (if not
                                      implementationCanvas.Repetition.state then
                                          false
                                            ->
                                              implementationCanvas.
                                                ArrayContainer.state
                                            ->
                                              implementationCanvas.HashTable.
                                                state
                                            ->
                                              implementationCanvas.
                                                ExtensibleHashTable.state
                                            ->implementationCanvas.List.state
                                            ->implementationCanvas.Set.state
                                            ->
                                              implementationCanvas.MultiSet.
                                                state
                                            ->implementationCanvas.Stack.state
                                            ->implementationCanvas.Queue.state
                                            ->
                                              implementationCanvas.PriorityQueue
                                              .state;
                                          true
                                            ->
                                              implementationCanvas.Repetition.
                                                state;
                                          gppProp.Repetition->impl
                                      if)
                                  if)
                              if)
                           #)
                      #);
                    open::< 
                      (# 
                      do (8,37)->position; (69,16)->size; 'By-value'->label
                      #)
                 #);
               open:: 
                 (# 
                 do
                    true->border.visible;
                    theFragmentBrowser.borderStyles.etchedIn->border.style;
                    byReference.open;
                    byValue.open;
                    (if kind
                     // gppProp.byReference then
                        true->byReference.state
                     // gppProp.byValue then
                        true->byValue.state;
                        leftCanvas.from.disable;
                        implementationCanvas.ArrayContainer.disable;
                        implementationCanvas.HashTable.disable;
                        implementationCanvas.ExtensibleHashTable.disable;
                        implementationCanvas.List.disable;
                        implementationCanvas.Set.disable;
                        implementationCanvas.MultiSet.disable;
                        implementationCanvas.Stack.disable;
                        implementationCanvas.Queue.disable;
                        implementationCanvas.PriorityQueue.disable
                     else
                        true->byReference.state
                    if);
                    (204,151)->position;
                    (184,62)->size
                 #)
            #);
          checkConstraints: @checkbox
            (#
               open::< 
                 (# 
                 do
                    (209,354)->position;
                    (123,16)->size;
                    'Check constraints'->label
                 #)
            #);
          Description: @staticText
            (#
               open::< 
                 (# 
                 do (10,390)->position; (76,16)->size; 'Description:'->label
                 #)
            #);
          DescriptionEdit: @textEditor
            (#
               open::< 
                 (# 
                 do
                    (10,410)->position;
                    (378,99)->size;
                    theFragmentBrowser.borderStyles.ShadowIn->border.style;
                    (if desc[] <> none then desc[]->contents.insert if)
                 #)
            #);
          setNoImplMul:
            (# 
            do
               rightCanvas.to.all->rightCanvas.to.selection;
               rightCanvas.to.delete;
               '1'->rightCanvas.to.insert;
               rightCanvas.from.all->rightCanvas.from.selection;
               rightCanvas.from.delete;
               '0'->rightCanvas.from.insert
            #);
          setAllImplFalse:
            (# 
            do
               (if not allImplFalse then
                   false->implementationCanvas.Repetition.state
                     ->implementationCanvas.ArrayContainer.state
                     ->implementationCanvas.HashTable.state
                     ->implementationCanvas.ExtensibleHashTable.state
                     ->implementationCanvas.List.state
                     ->implementationCanvas.Set.state
                     ->implementationCanvas.MultiSet.state
                     ->implementationCanvas.Stack.state
                     ->implementationCanvas.Queue.state
                     ->implementationCanvas.PriorityQueue.state
               if)
            #);
          allImplFalse:
            (# value: @Boolean
            do
               not
               (implementationCanvas.Repetition.state or
                implementationCanvas.ArrayContainer.state or
                implementationCanvas.HashTable.state or
                implementationCanvas.ExtensibleHashTable.state or
                implementationCanvas.List.state or
                implementationCanvas.Set.state or
                implementationCanvas.MultiSet.state or
                implementationCanvas.Stack.state or
                implementationCanvas.Queue.state or
                implementationCanvas.PriorityQueue.state)->value
            exit value
            #);
          open::< 
            (# 
            do
               true->border.visible;
               theFragmentBrowser.borderStyles.etchedOut->border.style;
               Name.open;
               NameEdit.open;
               leftCanvas.open;
               leftCanvasLabel.open;
               rightCanvas.open;
               rightCanvasLabel.open;
               implementationCanvas.open;
               implementationCanvasLabel.open;
               containmentCanvas.open;
               containmentCanvasLabel.open;
               checkConstraints.open;
               Description.open;
               DescriptionEdit.open;
               DescriptionEdit.disable;
               checkConstraints.disable;
               (6,10)->position;
               (398,526)->size;
               NameEdit[]->target
            #)
       #);
     CancelButton: @pushButton
       (#
          eventhandler::< 
            (#
               onMouseUp::< 
                 (# 
                 do
                    gppProp.noGlobalInteractiveMode
                      ->gppProp.globalInteractiveMode;
                    THIS(aggregationDialog).close
                 #)
            #);
          open::< 
            (#  do (274,546)->position; (60,20)->size; 'Cancel'->label #)
       #);
     OKbutton: @pushButton
       (#
          eventhandler::< 
            (#
               onMouseUp::< 
                 (# theObject: ^theWorkPage.DesignObject; t: ^text
                 do
                    (if theAggregationConn[] = none then
                        &theWorkPage.AggregationConnector[]
                          ->theAggregationConn[]
                    if);
                    mainCanvas.leftCanvas.from.contents->t[];
                    t.reset;
                    (if t.length > 0 then
                        t.getint->wholeMulFrom
                     else
                        (if kind
                         // gppProp.byValue then
                            1->wholeMulFrom
                         // gppProp.byReference then
                            0->wholeMulFrom
                        if)
                    if);
                    mainCanvas.leftCanvas.to.contents->t[];
                    t.reset;
                    t.getint->wholeMulTo;
                    mainCanvas.rightCanvas.from.contents->t[];
                    t.reset;
                    (if t.length > 0 then
                        (if '*'->t.equal then
                            - 1->partMulFrom->partMulTo
                         else
                            t.getint->partMulFrom;
                            mainCanvas.rightCanvas.to.contents->t[];
                            t.reset;
                            (if t.length > 0 then
                                (if '*'->t.equal then
                                    - 1->partMulTo
                                 else
                                    t.getint->partMulTo
                                if)
                             else
                                partMulFrom->partMulTo
                            if)
                        if)
                     else
                        mainCanvas.rightCanvas.to.contents->t[];
                        t.reset;
                        (if t.length > 0 then
                            (if '*'->t.equal then
                                - 1->partMulTo->partMulFrom
                             else
                                t.getint->partMulTo->partMulFrom
                            if)
                         else
                            1->partMulFrom->partMulTo
                        if)
                    if);
                    (if (partMulTo = - 1) or (partMulTo >= partMulFrom) then
                        mainCanvas.NameEdit.contents->t[];
                        (if t.length = 0 then '<<NameDecl>>'->t[] if);
                        mainCanvas.descriptionEdit.contents.contents->desc[];
                        (if desc.length = 0 then none ->desc[] if);
                        THIS(aggregationDialog).close;
                        gppProp.creatingAggregation
                          ->gppProp.globalInteractiveMode;
                        (if theAggregationConn.id = 0 then
                            ('Drag connector from whole to part',t[],impl,none ,
                             none ,wholeMulFrom,wholeMulTo,partMulFrom,
                             partMulTo,true,desc[],kind)
                              ->theAggregationConn.interactiveNew
                         else
                            (t[],impl,none ,none ,wholeMulFrom,wholeMulTo,
                             partMulFrom,partMulTo,true,desc[],kind)
                              ->theAggregationConn.Redisplay
                        if)
                     else
                        'Lower bound of the multiplicity on the part\nmust be less than or equal to the upper bound'
                          ->alertUser
                    if)
                 #)
            #);
          open::<  (#  do (344,546)->position; (60,20)->size; 'OK'->label #)
       #);
     kind,impl: @integer;
     theName,desc: ^text;
     theAggregationConn: ^theWorkPage.AggregationConnector;
     wholeMulFrom,wholeMulTo,partMulFrom,partMulTo: @integer;
     eventhandler::< 
       (# onAboutToClose::<  (#  do false->okToClose #) #);
     open::< 
       (# x,y,left,top,right,bottom: @integer
       enter
       (theAggregationConn[],theName[],kind,impl,wholeMulFrom,wholeMulTo,
        partMulFrom,partMulTo,desc[])
       do
          (if theAggregationConn[] = none then
              gppProp.byReference->kind; gppProp.noImplementation->impl
          if);
          mainCanvas.open;
          OKbutton.open;
          CancelButton.open;
          (410,576)->size;
          'Aggregation'->title;
          theFragmentBrowser.mouse.globalPosition->(x,y);
          theFragmentBrowser.system.screenRectangle
            ->((left,top),(right,bottom));
          (if x < left then left->x if);
          (if y < top then top->y if);
          (if x+410 > right then right-410->x if);
          (if y+576 > bottom then bottom-590->y if);
          (x,y)->position;
          INNER open;
          showModal
       #)
  #)  

-- selfAssociateWindow: Descriptor --
theFragmentBrowser.window
  (#
  (*      createAssociation:
   *        (#
   *           op: ^OADPage;
   *           thePatternDiagramNode,theParentNode,lastNode: ^op.PatternDiagramNode;
   *           theListDiagram,theParentDiagram,thePatternNodeDiagram:
   *             ^op.ListDiagram;
   *           theOADDiagram: ^op.OADDiagram;
   *           theAssocNode: ^op.AssociationNode;
   *           thePatternNode: ^thePatternNodeDiagram.PatternNode;
   *           theNonTerminalNode: ^theParentDiagram.NonTerminalNode;
   *           theDesc: ^betaGram.ObjectDescriptor;
   *           anAST,aDeclAST,lastAST: ^mps.ast;
   *           anExp: ^mps.expanded;
   *           theNames: ^betaGram.Names;
   *           theNameDcl: ^betaGram.NameDcl;
   *           theName,t,help: ^text
   *        do
   *           currentPage->op[];
   *           op.currentObject->thePatternDiagramNode[];
   *           thePatternDiagramNode.theDiagram->theListDiagram[];
   *           (if theListDiagram.localNodes.empty then
   *               theListDiagram.titleNode.getASTNode->anAST[];
   *               (if anAST[] <> none then
   *                   (anAST[],1)
   *                     ->(theListDiagram.titleNode.theSifEditor).changeFocus
   *               if);
   *               (theListDiagram.titleNode.theSifEditor).insertOptionals
   *           if);
   *           theListDiagram[]->theOADDiagram[];
   *           theOADDiagram.theDescriptor->theDesc[];
   *           theDesc.father->anAST[];
   *           (if true
   *            // switchesFrame.contents.otoBox.state then
   *               theListDiagram.theParentNode->theParentNode[];
   *               theParentNode.theDiagram->theParentDiagram[];
   *               (theParentDiagram.localNodes.last).elm[]->lastNode[];
   *               lastNode.getAstNode->lastAST[];
   *               (if lastAST[] = none then
   *                   (if lastNode## <= theParentDiagram.NonterminalNode## then
   *                       lastNode[]->theNonTerminalNode[];
   *                       theNonTerminalNode.unexp->lastAST[]
   *                    else
   *                       'No AST for last node??'->putline
   *                   if)
   *               if);
   *               (if lastAST[] <> none then
   *                   anAST[]->anExp[];
   *                   anExp.getSon1->theNames[];
   *                   theNames.getSon1->theNameDcl[];
   *                   theNameDcl.getNameDecl->aDeclAST[];
   *                   (if aDeclAST.kind = mps.kinds.unExpanded then
   *                       'NoName'->theName[]
   *                    else
   *                       theNameDcl.getText->theName[]
   *                   if);
   *                   theName.copy->t[];
   *                   theName[]->t.puttext;
   *                   ':OneToOneAssociation(# leftType::< '->t.puttext;
   *                   theName[]->t.puttext;
   *                   '; rightType::< '->t.puttext;
   *                   theName[]->t.puttext;
   *                   ' #) '->t.puttext;
   *                   &op.AssociationNode[]->theAssocNode[];
   *                   (op.one,theListDiagram[],op.one,theListDiagram[])
   *                     ->theAssocNode.display;
   *                   (if not gppProp.associations then
   *                       false->theAssocNode.BorderVisible;
   *                       (theAssocNode.c1).theText.get->help;
   *                       help[]->(theAssocNode.c1).invisibleText;
   *                       (theAssocNode.c1).theText.clear;
   *                       false->(theAssocNode.c1).BorderVisible;
   *                       (theAssocNode.c2).theText.get->help;
   *                       help[]->(theAssocNode.c2).invisibleText;
   *                       (theAssocNode.c2).theText.clear;
   *                       false->(theAssocNode.c2).BorderVisible
   *                   if);
   *                   (theParentDiagram[],t[])->op.parseAfter;
   *                   op.currentFocus[]->theAssocNode.thePatternNode;
   *                   op.currentFocus.theDiagram->thePatternNodeDiagram[];
   *                   op.currentFocus[]->thePatternNode[];
   *                   theAssocNode[]->thePatternNode.theAssociationNode;
   *                   (anAST[],op.one,anAST[],op.one,thePatternNode.theDeclaration)
   *                     ->op.patternDiagrams.AssociationList.insert;
   *                   t.clear;
   *                   (theListDiagram.localNodes.last).elm[]->lastNode[];
   *                   lastNode.getAstNode->lastAST[];
   *                   (if lastAST[] = none then
   *                       (if lastNode## <= theListDiagram.NonterminalNode## then
   *                           lastNode[]->theNonTerminalNode[];
   *                           theNonTerminalNode.unexp->lastAST[]
   *                        else
   *                           'No AST for last node??'->putline
   *                       if)
   *                   if);
   *                   (if lastAST[] <> none then
   *                       'the'->t.puttext;
   *                       theName[]->t.puttext;
   *                       theName[]->t.puttext;
   *                       ':^'->t.puttext;
   *                       theName[]->t.puttext;
   *                       theName[]->t.puttext;
   *                       (theListDiagram[],t[])->op.parseAfter
   *                   if)
   *                else
   *                   'lastAST i NONE??'->putline
   *               if)
   *            // switchesFrame.contents.otmBox.state then
   *               theListDiagram.theParentNode->theParentNode[];
   *               theParentNode.theDiagram->theParentDiagram[];
   *               (theParentDiagram.localNodes.last).elm[]->lastNode[];
   *               lastNode.getAstNode->lastAST[];
   *               (if lastAST[] = none then
   *                   (if lastNode## <= theParentDiagram.NonterminalNode## then
   *                       lastNode[]->theNonTerminalNode[];
   *                       theNonTerminalNode.unexp->lastAST[]
   *                    else
   *                       'No AST for last node??'->putline
   *                   if)
   *               if);
   *               (if lastAST[] <> none then
   *                   anAST[]->anExp[];
   *                   anExp.getSon1->theNames[];
   *                   theNames.getSon1->theNameDcl[];
   *                   theNameDcl.getNameDecl->aDeclAST[];
   *                   (if aDeclAST.kind = mps.kinds.unExpanded then
   *                       'NoName'->theName[]
   *                    else
   *                       theNameDcl.getText->theName[]
   *                   if);
   *                   theName.copy->t[];
   *                   theName[]->t.puttext;
   *                   ':OneToManyAssociation(# oneType::< '->t.puttext;
   *                   theName[]->t.puttext;
   *                   '; ManyElmType::< '->t.puttext;
   *                   theName[]->t.puttext;
   *                   ' #) '->t.puttext;
   *                   &op.AssociationNode[]->theAssocNode[];
   *                   (op.one,theListDiagram[],op.many,theListDiagram[])
   *                     ->theAssocNode.display;
   *                   (if not gppProp.associations then
   *                       false->theAssocNode.BorderVisible;
   *                       (theAssocNode.c1).theText.get->help;
   *                       help[]->(theAssocNode.c1).invisibleText;
   *                       (theAssocNode.c1).theText.clear;
   *                       false->(theAssocNode.c1).BorderVisible;
   *                       (theAssocNode.c2).theText.get->help;
   *                       help[]->(theAssocNode.c2).invisibleText;
   *                       (theAssocNode.c2).theText.clear;
   *                       false->(theAssocNode.c2).BorderVisible
   *                   if);
   *                   (theParentDiagram[],t[])->op.parseAfter;
   *                   op.currentFocus[]->theAssocNode.thePatternNode;
   *                   op.currentFocus.theDiagram->thePatternNodeDiagram[];
   *                   op.currentFocus[]->thePatternNode[];
   *                   theAssocNode[]->thePatternNode.theAssociationNode;
   *                   (anAST[],op.one,anAST[],op.many,thePatternNode.theDeclaration)
   *                     ->op.patternDiagrams.AssociationList.insert;
   *                   t.clear;
   *                   (theListDiagram.localNodes.last).elm[]->lastNode[];
   *                   lastNode.getAstNode->lastAST[];
   *                   (if lastAST[] = none then
   *                       (if lastNode## <= theListDiagram.NonterminalNode## then
   *                           lastNode[]->theNonTerminalNode[];
   *                           theNonTerminalNode.unexp->lastAST[]
   *                        else
   *                           'No AST for last node??'->putline
   *                       if)
   *                   if);
   *                   (if lastAST[] <> none then
   *                       'the'->t.puttext;
   *                       theName[]->t.puttext;
   *                       theName[]->t.puttext;
   *                       ':^'->t.puttext;
   *                       theName[]->t.puttext;
   *                       theName[]->t.puttext;
   *                       (theListDiagram[],t[])->op.parseAfter
   *                   if)
   *                else
   *                   'lastAST i NONE??'->putline
   *               if)
   *            // switchesFrame.contents.mtmBox.state then
   *               theListDiagram.theParentNode->theParentNode[];
   *               theParentNode.theDiagram->theParentDiagram[];
   *               (theParentDiagram.localNodes.last).elm[]->lastNode[];
   *               lastNode.getAstNode->lastAST[];
   *               (if lastAST[] = none then
   *                   (if lastNode## <= theParentDiagram.NonterminalNode## then
   *                       lastNode[]->theNonTerminalNode[];
   *                       theNonTerminalNode.unexp->lastAST[]
   *                    else
   *                       'No AST for last node??'->putline
   *                   if)
   *               if);
   *               (if lastAST[] <> none then
   *                   anAST[]->anExp[];
   *                   anExp.getSon1->theNames[];
   *                   theNames.getSon1->theNameDcl[];
   *                   theNameDcl.getNameDecl->aDeclAST[];
   *                   (if aDeclAST.kind = mps.kinds.unExpanded then
   *                       'NoName'->theName[]
   *                    else
   *                       theNameDcl.getText->theName[]
   *                   if);
   *                   theName.copy->t[];
   *                   theName[]->t.puttext;
   *                   ':ManyToManyAssociation(# leftType::< '->t.puttext;
   *                   theName[]->t.puttext;
   *                   '; rightType::< '->t.puttext;
   *                   theName[]->t.puttext;
   *                   ' #) '->t.puttext;
   *                   &op.AssociationNode[]->theAssocNode[];
   *                   (op.many,theListDiagram[],op.many,theListDiagram[])
   *                     ->theAssocNode.display;
   *                   (if not gppProp.associations then
   *                       false->theAssocNode.BorderVisible;
   *                       (theAssocNode.c1).theText.get->help;
   *                       help[]->(theAssocNode.c1).invisibleText;
   *                       (theAssocNode.c1).theText.clear;
   *                       false->(theAssocNode.c1).BorderVisible;
   *                       (theAssocNode.c2).theText.get->help;
   *                       help[]->(theAssocNode.c2).invisibleText;
   *                       (theAssocNode.c2).theText.clear;
   *                       false->(theAssocNode.c2).BorderVisible
   *                   if);
   *                   (theParentDiagram[],t[])->op.parseAfter;
   *                   op.currentFocus[]->theAssocNode.thePatternNode;
   *                   op.currentFocus.theDiagram->thePatternNodeDiagram[];
   *                   op.currentFocus[]->thePatternNode[];
   *                   theAssocNode[]->thePatternNode.theAssociationNode;
   *                   (anAST[],op.many,anAST[],op.many,
   *                    thePatternNode.theDeclaration)
   *                     ->op.patternDiagrams.AssociationList.insert;
   *                   t.clear;
   *                   (theListDiagram.localNodes.last).elm[]->lastNode[];
   *                   lastNode.getAstNode->lastAST[];
   *                   (if lastAST[] = none then
   *                       (if lastNode## <= theListDiagram.NonterminalNode## then
   *                           lastNode[]->theNonTerminalNode[];
   *                           theNonTerminalNode.unexp->lastAST[]
   *                        else
   *                           'No AST for last node??'->putline
   *                       if)
   *                   if);
   *                   (if lastAST[] <> none then
   *                       'the'->t.puttext;
   *                       theName[]->t.puttext;
   *                       theName[]->t.puttext;
   *                       ':^'->t.puttext;
   *                       theName[]->t.puttext;
   *                       theName[]->t.puttext;
   *                       (theListDiagram[],t[])->op.parseAfter
   *                   if)
   *                else
   *                   'lastAST i NONE??'->putline
   *               if)
   *           if)
   * 
   *
   #); *)
     bCancel: @pushButton
       (#
          open:: 
            (#  do 'Cancel'->label; (30,140)->position; (60,20)->size #);
          eventhandler:: 
            (# onMouseUp::  (#  do THIS(selfAssociateWindow).close #) #)
       #);
     bOk: @pushButton
       (#
          open::  (#  do 'OK'->label; (100,140)->position; (60,20)->size #);
          eventhandler:: 
            (#
               onMouseUp:: 
                 (# 
                 do (*createAssociation;*) THIS(selfAssociateWindow).close
                 #)
            #)
       #);
     switchesFrame: @labelled
       (#
          contentsType:: canvas
            (#
               otoBox: @radioButton
                 (#
                    open:: 
                      (# 
                      do 'One-to-One'->label; (10,10)->position; (90,20)->size
                      #);
                    eventhandler:: 
                      (#
                         onMouseUp:: 
                           (# 
                           do
                              (if not state then
                                  false->otmBox.state; false->mtmBox.state
                               else
                                  true->state
                              if)
                           #)
                      #)
                 #);
               otmBox: @radioButton
                 (#
                    open:: 
                      (# 
                      do 'One-to-Many'->label; (10,40)->position; (90,20)->size
                      #);
                    eventhandler:: 
                      (#
                         onMouseUp:: 
                           (# 
                           do
                              (if not state then
                                  false->otoBox.state; false->mtmBox.state
                               else
                                  true->state
                              if)
                           #)
                      #)
                 #);
               mtmBox: @radioButton
                 (#
                    open:: 
                      (# 
                      do
                         'Many-to-Many'->label; (10,70)->position; (90,20)->size
                      #);
                    eventhandler:: 
                      (#
                         onMouseUp:: 
                           (# 
                           do
                              (if not state then
                                  false->otoBox.state; false->otmBox.state
                               else
                                  true->state
                              if)
                           #)
                      #)
                 #);
               open:: 
                 (# 
                 do otoBox.open; otmBox.open; mtmBox.open; true->otoBox.state
                 #)
            #);
          open:: 
            (#  do 'Association Type'->label; ((10,10),(160,130))->frame #)
       #);
     open::< 
       (# 
       do
          hide;
          THIS(selfAssociateWindow).contents->bCancel.open;
          THIS(selfAssociateWindow).contents->bOk.open;
          THIS(selfAssociateWindow).contents->switchesFrame.open;
          'Associate to Self'->title;
          (170,171)->size;
          INNER
       #);
     popup: (#  do open; showModal #)
  #)  

-- layoutPreferencesDialog: Descriptor --
theFragmentBrowser.window
  (#
     alreadyOpen: @boolean;
     theCanvas: @canvas
       (#
          open::< 
            (# 
            do
               true->border.visible;
               theFragmentBrowser.borderStyles.etchedIn->border.style;
               ShowLabel.open;
               SpecializationsLabel.open;
               diagPosLabel.open;
               showAttrLabel.open;
               Attributes.open;
               References.open;
               Specializations.open;
               Associations.open;
               NameAndType.open;
               Name.open;
               Type.open;
               NameAndKind.open;
               EdgedConnectors.open;
               SubPatternsAreRegions.open;
               AllManual.open;
               AllAutomatic.open;
               AutomaticForSubPatterns.open;
               AutomaticWhenDetailing.open;
               AutomaticForNewPatterns.open;
               true->Attributes.state;
               true->References.state;
               true->Specializations.state;
               true->Associations.state;
               true->subPatternsAreRegions.state;
               true->Name.state;
               true->AllAutomatic.state;
               EdgedConnectors.disable;
               SubPatternsAreRegions.disable;
               AllManual.disable;
               AllAutomatic.disable;
               AutomaticForSubPatterns.disable;
               AutomaticWhenDetailing.disable;
               AutomaticForNewPatterns.disable;
               (6,32)->position;
               (494,326)->size
            #);
          diagPosLabel: @staticText
            (#
               open::< 
                 (# 
                 do
                    (191,157)->position;
                    (132,16)->size;
                    'Diagram positioning:'->label
                 #)
            #);
          SpecializationsLabel: @staticText
            (#
               open::< 
                 (# 
                 do
                    (191,14)->position;
                    (105,16)->size;
                    'Specializations:'->label
                 #)
            #);
          EdgedConnectors: @checkBox
            (#
               reset:
                 (#  do gppProp.edgedSpecializationConnectors->state #);
               open::< 
                 (# 
                 do
                    (191,43)->position;
                    (132,20)->size;
                    'Edged Connectors'->label
                 #)
            #);
          SubPatternsAreRegions: @checkBox
            (#
               reset: (#  do gppProp.subRegionsOfSuper->state #);
               open::< 
                 (# 
                 do
                    (191,67)->position;
                    (280,20)->size;
                    'Sub-patterns are regions of super-patterns'->label
                 #)
            #);
          ShowLabel: @staticText
            (#
               open::< 
                 (#  do (12,14)->position; (60,16)->size; 'Show:'->label #)
            #);
          Attributes: @checkBox
            (#
               reset: (#  do gppProp.showAttributes->state #);
               open::< 
                 (# 
                 do (12,43)->position; (100,20)->size; 'Attributes'->label
                 #);
               eventhandler::< 
                 (#
                    onMouseUp::< 
                      (#  do not state->localProp.showAttributes #)
                 #)
            #);
          References: @checkBox
            (#
               reset: (#  do gppProp.references->state #);
               open::< 
                 (# 
                 do (12,67)->position; (100,20)->size; 'Aggregations'->label
                 #);
               eventhandler::< 
                 (#
                    onMouseUp::<  (#  do not state->localProp.references #)
                 #)
            #);
          Specializations: @checkBox
            (#
               reset: (#  do gppProp.specializations->state #);
               open::< 
                 (# 
                 do (12,93)->position; (116,20)->size; 'Specializations'->label
                 #);
               eventhandler::< 
                 (#
                    onMouseUp::< 
                      (#  do not state->localProp.specializations #)
                 #)
            #);
          Associations: @checkBox
            (#
               reset: (#  do gppProp.associations->state #);
               open::< 
                 (# 
                 do (12,119)->position; (100,20)->size; 'Associations'->label
                 #);
               eventhandler::< 
                 (#
                    onMouseUp::< 
                      (#  do not state->localProp.associations #)
                 #)
            #);
          AllManual: @radioButton
            (#
               open::< 
                 (# 
                 do (191,180)->position; (91,20)->size; 'All Manual'->label
                 #)
            #);
          AllAutomatic: @radioButton
            (#
               open::< 
                 (# 
                 do (191,206)->position; (100,20)->size; 'All Automatic'->label
                 #)
            #);
          AutomaticForSubPatterns: @radioButton
            (#
               open::< 
                 (# 
                 do
                    (191,232)->position;
                    (185,20)->size;
                    'Automatic for sub-patterns'->label
                 #)
            #);
          AutomaticForNewPatterns: @radioButton
            (#
               open::< 
                 (# 
                 do
                    (191,284)->position;
                    (179,20)->size;
                    'Automatic for new patterns'->label
                 #)
            #);
          AutomaticWhenDetailing: @radioButton
            (#
               open::< 
                 (# 
                 do
                    (191,258)->position;
                    (164,20)->size;
                    'Automatic when detailing'->label
                 #)
            #);
          showAttrLabel: @staticText
            (#
               open::< 
                 (# 
                 do
                    (11,157)->position;
                    (138,16)->size;
                    'Show Attributes with:'->label
                 #)
            #);
          NameAndType: @radioButton
            (#
               reset:
                 (# 
                 do
                    (if gppProp.SimpleDeclDisplay = gppProp.AsNameAndType then
                        true->state
                     else
                        false->state
                    if)
                 #);
               open::< 
                 (# 
                 do (11,180)->position; (100,20)->size; 'Name and type'->label
                 #);
               eventhandler::< 
                 (#
                    onMouseUp::< 
                      (# 
                      do
                         (if not state then
                             false->Name.state;
                             false->Type.state;
                             false->NameAndKind.state;
                             gppProp.AsNameAndType->localProp.SimpleDeclDisplay
                          else
                             gppProp.AsName->localProp.SimpleDeclDisplay;
                             true->Name.state
                         if)
                      #)
                 #)
            #);
          Name: @radioButton
            (#
               reset:
                 (# 
                 do
                    (if gppProp.SimpleDeclDisplay = gppProp.AsName then
                        true->state
                     else
                        false->state
                    if)
                 #);
               open::< 
                 (#  do (11,206)->position; (54,20)->size; 'Name'->label #);
               eventhandler::< 
                 (#
                    onMouseUp::< 
                      (# 
                      do
                         (if not state then
                             false->NameAndType.state;
                             false->Type.state;
                             false->NameAndKind.state;
                             gppProp.AsName->localProp.SimpleDeclDisplay;
                             
                          else
                             gppProp.AsType->localProp.SimpleDeclDisplay;
                             true->Type.state
                         if)
                      #)
                 #)
            #);
          Type: @radioButton
            (#
               reset:
                 (# 
                 do
                    (if gppProp.SimpleDeclDisplay = gppProp.AsType then
                        true->state
                     else
                        false->state
                    if)
                 #);
               open::< 
                 (#  do (11,232)->position; (52,20)->size; 'Type'->label #);
               eventhandler::< 
                 (#
                    onMouseUp::< 
                      (# 
                      do
                         (if not state then
                             false->NameAndType.state;
                             false->Name.state;
                             false->NameAndKind.state;
                             gppProp.AsType->localProp.SimpleDeclDisplay;
                             
                          else
                             gppProp.AsNameAndKind->localProp.SimpleDeclDisplay;
                             true->NameAndKind.state
                         if)
                      #)
                 #)
            #);
          NameAndKind: @radioButton
            (#
               reset:
                 (# 
                 do
                    (if gppProp.SimpleDeclDisplay = gppProp.AsNameAndKind then
                        true->state
                     else
                        false->state
                    if)
                 #);
               open::< 
                 (# 
                 do (11,258)->position; (100,20)->size; 'Name and kind'->label
                 #);
               eventhandler::< 
                 (#
                    onMouseUp::< 
                      (# 
                      do
                         (if not state then
                             false->NameAndType.state;
                             false->Name.state;
                             false->Type.state;
                             gppProp.AsNameAndKind->localProp.SimpleDeclDisplay;
                             
                          else
                             gppProp.AsNameAndType->localProp.SimpleDeclDisplay;
                             true->NameAndType.state
                         if)
                      #)
                 #)
            #)
       #);
     ResetButton: @pushButton
       (#
          open::< 
            (#  do (393,373)->position; (93,20)->size; 'Reset'->label #);
          eventhandler::<  (# onMouseUp::<  (#  do reset #) #)
       #);
     CancelButton: @pushButton
       (#
          open::< 
            (#  do (287,373)->position; (93,20)->size; 'Cancel'->label #);
          eventhandler::< 
            (# onMouseUp::<  (#  do reset; layoutPreferencesDialog.hide #)
            #)
       #);
     OKbutton: @pushButton
       (#
          open::< 
            (#  do (181,373)->position; (93,20)->size; 'OK'->label #);
          eventhandler::< 
            (#
               onMouseUp::< 
                 (#
                    connectors: ^ObjectList;
                    theConn: ^theWorkPage.deletableConnector;
                    n1,n2: ^theWorkPage.DesignObject;
                    theWedgeNode: ^theWorkPage.WedgeNode;
                    thePatternDiagramNode,theOtherPatternDiagramNode:
                      ^theWorkPage.PatternDiagramNode;
                    theListDiagram,theOtherListDiagram:
                      ^theWorkPage.Listdiagram;
                    nd1,nd2: @IntegerRef;
                    t: @text;
                    help: ^text;
                    SimpleDeclDisplayChanged,showAttributesChanged: @boolean
                 do
                    layoutPreferencesDialog.hide;
                    (if localProp.changed then
                        (if theWorkPage[] <> none then
                            (if localProp.showAttributes.isChanged or
                            localProp.references.isChanged or
                            localProp.specializations.isChanged or
                            localProp.associations.isChanged then
                                theWorkPage.getConnectors->connectors[];
                                (if connectors[] <> none then
                                    connectors.scan
                                      (#
                                         theAssociationConn:
                                           ^theWorkPage.AssociationConnector;
                                         theListDiagram:
                                           ^theWorkPage.ListDiagram
                                      do
                                         (if current## <=
                                         theWorkPage.deletableConnector## then
                                             current[]->theConn[];
                                             (if theConn## <=
                                             theWorkPage.PrefixConnector## then
                                                 (if
                                                 localProp.specializations.
                                                   isChanged then
                                                     (if
                                                     localProp.specializations
                                                      then
                                                         true
                                                           ->theConn.selectable;
                                                         true
                                                           ->
                                                             theConn.
                                                               borderVisible
                                                      else
                                                         false
                                                           ->theConn.selectable;
                                                         false
                                                           ->
                                                             theConn.
                                                               borderVisible
                                                     if)
                                                 if)
                                              else
                                                 (if theConn## =
                                                 theWorkPage.
                                                   AssociationConnector## then
                                                     (if
                                                     localProp.associations.
                                                       isChanged then
                                                         localProp.associations
                                                           ->theConn.visible
                                                     if);
                                                     (if
                                                     localProp.showAttributes.
                                                       isChanged then
                                                         theConn[]
                                                           ->
                                                             theAssociationConn[];
                                                         localProp.
                                                           showAttributes
                                                           ->
                                                             theAssociationConn.
                                                               attributesVisible
                                                     if)
                                                  else
                                                     (if theConn## =
                                                     theWorkPage.
                                                       AggregationConnector##
                                                      then
                                                         (if
                                                         localProp.references.
                                                           isChanged then
                                                             localProp.
                                                               references
                                                               ->theConn.visible
                                                         if);
                                                         (if
                                                         localProp.
                                                           showAttributes.
                                                           isChanged then
                                                             theConn[]
                                                               ->
                                                                 theAssociationConn[];
                                                             (
                                                             (
                                                             theAssociationConn.
                                                               rightRole).
                                                             thePatternDiagramNode
                                                             ).theDiagram
                                                               ->
                                                                 theListDiagram[];
                                                             (if
                                                             (
                                                             (
                                                             theAssociationConn.
                                                               rightRole).
                                                             thePatternDiagramNode
                                                             ).struc <=
                                                             theListDiagram.
                                                               PatternNode##
                                                              then
                                                                 localProp.
                                                                   showAttributes
                                                                   ->
                                                                     theAssociationConn
                                                                     .visible;
                                                                 localProp.
                                                                   showAttributes
                                                                   ->
                                                                     theAssociationConn
                                                                     .
                                                                       attributesVisible
                                                              else
                                                                 localProp.
                                                                   showAttributes
                                                                   ->
                                                                     theAssociationConn
                                                                     .
                                                                       attributesVisible
                                                             if)
                                                         if)
                                                     if)
                                                 if)
                                             if);
                                             theConn.redraw
                                         if)
                                      #)
                                if);
                                
                            if);
                            (if
                            localProp.SimpleDeclDisplay.isChanged
                            (* have to update globally to make
                             redisplay work *) then
                                localProp.SimpleDeclDisplay.update;
                                true->SimpleDeclDisplayChanged
                            if);
                            (if
                            localProp.showAttributes.isChanged
                            (* have to update globally to make
                             adjustsizes work *) then
                                localProp.showAttributes.update;
                                true->showAttributesChanged
                            if);
                            theWorkPage.patternDiagrams.theList.Scan
                              (#
                                 thisListDiagram: ^theWorkPage.ListDiagram;
                                 theDiagramNode: ^thisListDiagram.DiagramNode;
                                 theNames: ^betaGram.Names;
                                 iterate: @boolean;
                                 sonNo: @integer
                              do
                                 current.e[]->thisListDiagram[];
                                 thisListDiagram.localNodes.scan
                                   (# 
                                   do
                                      (if SimpleDeclDisplayChanged then
                                          (if not
                                          (current## =
                                           thisListDiagram.PatternNode##) then
                                              (if current## <=
                                              thisListDiagram.DiagramNode## then
                                                  current[]->theDiagramNode[];
                                                  (if iterate then
                                                      (theDiagramNode.
                                                         theDeclaration,
                                                       sonNo->theNames.get)
                                                        ->
                                                          theDiagramNode.
                                                            Redisplay;
                                                      sonNo+1->sonNo;
                                                      (if sonNo >
                                                      theNames.noOfSons then
                                                          false->iterate
                                                      if)
                                                   else
                                                      (
                                                      theDiagramNode.
                                                        theDeclaration).getSon1
                                                        ->theNames[];
                                                      (if theNames.noOfsons = 1
                                                       then
                                                          (theDiagramNode.
                                                             theDeclaration,
                                                           theNames.getSon1)
                                                            ->
                                                              theDiagramNode.
                                                                Redisplay
                                                       else
                                                          true->iterate;
                                                          1->sonNo;
                                                          (theDiagramNode.
                                                             theDeclaration,
                                                           sonNo->theNames.get)
                                                            ->
                                                              theDiagramNode.
                                                                Redisplay;
                                                          2->sonNo
                                                      if)
                                                  if)
                                              if)
                                          if)
                                      if);
                                      (if showAttributesChanged then
                                          (if localProp.showAttributes then
                                              current.invisibleText->help[];
                                              help->current.theText.set;
                                              true->current.selectable
                                           else
                                              (if not
                                              (current.theText.length = 0) then
                                                  current.theText.get->t;
                                                  t[]->current.invisibleText
                                              if);
                                              current.theText.clear;
                                              false->current.selectable
                                          if)
                                      if)
                                   #);
                                 thisListDiagram.localNodes.adjustSizes
                              #);
                            theWorkPage.redraw
                        if);
                        localProp.updateGppProp
                    if)
                 #)
            #)
       #);
     dumpPropsbutton: @pushButton
       (#
          open::< 
            (# 
            do (75,373)->position; (93,20)->size; 'dump props'->label
            #);
          eventhandler::< 
            (#
               onMouseUp::< 
                 (# 
                 do
                    localProp.dump;
                    newline;
                    '-----------gppProp----------'->putline;
                    'SimpleDeclDisplay: '->puttext;
                    gppProp.SimpleDeclDisplay->putBoolean;
                    newline;
                    'showAttributes: '->puttext;
                    gppProp.showAttributes->putboolean;
                    newline;
                    'references: '->puttext;
                    gppProp.references->putBoolean;
                    newline;
                    'specializations: '->puttext;
                    gppProp.specializations->putBoolean;
                    newline;
                    'associations: '->puttext;
                    gppProp.associations->putBoolean;
                    newline;
                    'edgedSpecializationConnectors: '->puttext;
                    gppProp.edgedSpecializationConnectors->putBoolean;
                    newline;
                    'subRegionsOfSuper: '->puttext;
                    gppProp.subRegionsOfSuper->putBoolean;
                    newline;
                    newline
                 #)
            #)
       #);
     canvasLabel: @staticText
       (#
          open::< 
            (# 
            do (6,6)->position; (121,16)->size; 'Layout Preferences'->label
            #)
       #);
     eventhandler::< 
       (# onAboutToClose::<  (#  do false->okToClose #) #);
     open::< 
       (# 
       do
          canvasLabel.open;
          theCanvas.open;
          reset;
          (if switch[1] then dumpPropsButton.open if);
          OKbutton.open;
          CancelButton.open;
          ResetButton.open;
          (507,406)->size;
          'Layout Preferences'->title;
          INNER
       #);
     reset:
       (# 
       do
          &props[]->localProp[];
          theCanvas.NameAndType.reset;
          theCanvas.Name.reset;
          theCanvas.Type.reset;
          theCanvas.NameAndKind.reset;
          theCanvas.attributes.reset;
          theCanvas.specializations.reset;
          theCanvas.references.reset;
          theCanvas.associations.reset;
          
       #);
     props:
       (#
          SimpleDeclDisplay: @gppProp.IntegerDefault
            (#
               isChanged:
                 (# v: @boolean
                 do SimpleDeclDisplay <> gppProp.SimpleDeclDisplay->v
                 exit v
                 #);
               update:
                 (#  do SimpleDeclDisplay->gppProp.SimpleDeclDisplay #)
            do gppProp.SimpleDeclDisplay->value
            #);
          showAttributes: @gppProp.BooleanDefault
            (#
               isChanged:
                 (# v: @boolean
                 do showAttributes <> gppProp.showAttributes->v
                 exit v
                 #);
               update: (#  do showAttributes->gppProp.showAttributes #)
            do gppProp.showAttributes->value
            #);
          references: @gppProp.BooleanDefault
            (#
               isChanged:
                 (# v: @boolean
                 do references <> gppProp.references->v
                 exit v
                 #);
               update: (#  do references->gppProp.references #)
            do gppProp.references->value
            #);
          specializations: @gppProp.BooleanDefault
            (#
               isChanged:
                 (# v: @boolean
                 do specializations <> gppProp.specializations->v
                 exit v
                 #);
               update: (#  do specializations->gppProp.specializations #)
            do gppProp.specializations->value
            #);
          associations: @gppProp.BooleanDefault
            (#
               isChanged:
                 (# v: @boolean
                 do associations <> gppProp.associations->v
                 exit v
                 #);
               update: (#  do associations->gppProp.associations #)
            do gppProp.associations->value
            #);
          edgedSpecializationConnectors: @gppProp.BooleanDefault
            (#
               isChanged:
                 (# v: @boolean
                 do
                    edgedSpecializationConnectors <>
                    gppProp.edgedSpecializationConnectors->v
                 exit v
                 #);
               update:
                 (# 
                 do
                    edgedSpecializationConnectors
                      ->gppProp.edgedSpecializationConnectors
                 #)
            do gppProp.edgedSpecializationConnectors->value
            #);
          subRegionsOfSuper: @gppProp.BooleanDefault
            (#
               isChanged:
                 (# v: @boolean
                 do subRegionsOfSuper <> gppProp.subRegionsOfSuper->v
                 exit v
                 #);
               update:
                 (#  do subRegionsOfSuper->gppProp.subRegionsOfSuper #)
            do gppProp.subRegionsOfSuper->value
            #);
          changed:
            (# value: @boolean
            do
               SimpleDeclDisplay.isChanged or showAttributes.isChanged or
               references.isChanged or specializations.isChanged or
               associations.isChanged or
               edgedSpecializationConnectors.isChanged or
               subRegionsOfSuper.isChanged->value
            exit value
            #);
          updateGppProp:
            (# 
            do
               SimpleDeclDisplay.update;
               showAttributes.update;
               references.update;
               specializations.update;
               associations.update;
               edgedSpecializationConnectors.update;
               subRegionsOfSuper.update
            #);
          dump:
            (# 
            do
               newline;
               '-----------localProp----------'->putline;
               'SimpleDeclDisplay: '->puttext;
               SimpleDeclDisplay->putint;
               newline;
               'showAttributes: '->puttext;
               showAttributes->putBoolean;
               newline;
               'references: '->puttext;
               references->putBoolean;
               newline;
               'specializations: '->puttext;
               specializations->putBoolean;
               newline;
               'associations: '->puttext;
               associations->putBoolean;
               newline;
               'edgedSpecializationConnectors: '->puttext;
               edgedSpecializationConnectors->putBoolean;
               newline;
               'subRegionsOfSuper: '->puttext;
               subRegionsOfSuper->putBoolean;
               newline;
               newline
            #)
       #);
     localProp: ^props;
     popup:
       (# 
       do
          &props[]->localProp[];
          (if alreadyOpen then
              showModal
           else
              open; showModal; true->alreadyOpen
          if)
       #)
  #)  

