ORIGIN '../freja';
INCLUDE '~beta/process/v1.4/osinterface'
'~beta/containers/v1.4/seqContainers'
'~beta/sysutils/v1.4/endian';
-- FrejaDoPart: Descriptor --
(#  do 'Mjolner BETA System - Freja v1.5(5)'->putline #)  

-- HandleControllerMessage: Descriptor --
(#
   theDoc: ^theGraphicalInterface.theDesignInterface.OADDocument;
   thePage: ^theDoc.Page;
   theOADPage: ^theDoc.OADPage;
   theListDiagram: ^theDoc.theGroupPage.ListDiagram;
   fn: ^theListDiagram.FragmentNode;
   theObject: ^theOADPage.DesignObject;
   theNode: ^theOADPage.PatternDiagramNode;
   command,trailer,editstatus,edittype: ^Text;
   OK: @Boolean;
   editorID: @Integer;
   graf: ^theGraphicalInterface.DesignInterface;
   anElement: ^theGraphicalInterface.sifEditorList.element;
   ff: ^theGraphicalInterface.fragmentForm;
   errorPos: @integer;
   ParseErrorText: ^text;
   dashpos: @integer;
   help: ^text;
   titleText: @Text;
   filename: @Text;
   HandleSifCommand:
     (#
        t,s,command: ^Text;
        index,position: @Integer;
        status: @Boolean;
        doSendStatus: @boolean;
        ff: ^theGraphicalInterface.fragmentForm;
        anElement: ^theGraphicalInterface.sifEditorList.element;
        anAst: ^theGraphicalInterface.ast;
        
     enter t[]
     do
        true->doSendStatus;
        1->t.setpos;
        t.getint->editorID;
        2->t.setpos;
        t.getatom->command[];
        (if theGraphicalInterface.switch[12]
         // true then 'Sif-Command is: '->puttext; command[]->putline; 
        if);
        (if true
         // ('openGroup'->command.equal) then
            t.getAtom->s[];
            (* open a new group named 's' *)
            s->theGraphicalInterface.theDesignInterface.openFragmentGroup;
            
         // ('openForm'->command.equal) then
            t.getAtom->s[];
            (s,editorID)
              ->theGraphicalInterface.theDesignInterface.openFragmentForm->ff[];
            (if ff[]
             // none then
                'openFragmentForm: '->putText;
                s[]->putText;
                ' not found'->putline;
                
             else
                &theGraphicalInterface.sifEditorList.element[]->anElement[];
                editorId->anElement.editorId;
                ff[]->anElement.ff[];
                anElement[]->theGraphicalInterface.sifEditorList.insert;
                
            if);
            (if theGraphicalInterface.theDesignInterface.theDocument[]
             // none then
                'Freja ------ NO DOCUMENT after openForm'->screen.putline; 
             else
                theGraphicalInterface.theDesignInterface.theDocument[]
                  ->theDoc[];
                theDoc.CurrentPage->thePage[];
                (if thePage.struc <= theDoc.OADPage##
                 // true then
                    thePage[]->theOADPage[];
                    t.getint->index;
                    (if index
                     // 0 then 
                     else
                        (editorID,index,1)->theOADPage.onFocusChange->status;
                        (*index -> theOADPage.DetailAndSelect;*)
                        
                    if)
                if)
            if);
            
         // ('focusChanged'->command.equal) then
            (editorID,t.getint,t.getint)->theOADPage.onFocusChange->status;
            (if status then
                (if theDoc[] = none then
                    'theDoc is none!'->putLine
                 else
                    theDoc.CurrentPage->thePage[];
                    (if thePage[]
                     // none then 'focusChanged: No current page'->putline; 
                     else
                        (if thePage[]
                         // theDoc.OADPalette[] then
                            'focusChanged: CurrentPage is the palette'->putline;
                            
                         else
                            (if thePage.struc
                             // theDoc.OADPage## then
                                thePage[]->theOADPage[];
                                theOADPage.CurrentObject->theOADPage.GetStatus
                             else
                                'focusChanged: thePage is not an OADPage'
                                  ->screen.putline;
                                
                            if)
                        if)
                    if)
                if);
                
            if);
            
         // ('newFragment'->command.equal) then
         (* newFragment
          * # <editorId> newFragment
          *)
            t.getAtom->s[];
            (s,editorID)
              ->theGraphicalInterface.theDesignInterface.openFragmentForm->ff[];
            (if ff[]
             // none then
                'newFragment'->putText; s[]->putText; ' not found'->putline; 
             else
                &theGraphicalInterface.sifEditorList.element[]->anElement[];
                editorId->anElement.editorId;
                ff[]->anElement.ff[];
                anElement[]->theGraphicalInterface.sifEditorList.insert;
                
            if);
            (if theGraphicalInterface.theDesignInterface.theDocument[]
             // none then
                'Freja ------ NO DOCUMENT after newFragment'->screen.putline; 
             else
                theGraphicalInterface.theDesignInterface.theDocument[]
                  ->theDoc[];
                theDoc.CurrentPage->thePage[];
                (if thePage.struc <= theDoc.OADPage##
                 // true then
                    thePage[]->theOADPage[];
                    t.getint->index;
                    (if index
                     // 0 then 
                     else
                        (editorID,index,1)->theOADPage.onFocusChange->status; 
                    if)
                if)
            if)
         // ('astReplaced'->command.equal) then
         (* astReplaced:
          * # <editorId> astReplaced <oldIndex> <newIndex>
          *)
            editorId->theGraphicalInterface.sifEditorList.findFragmentForm
              ->ff[];
            (if ff[]
             // none then
                'Fragment form '->putText; ' not found!!!!'->putLine; 
             else
                (ff[],t.getint,t.getint)->theOADPage.astReplaced->status; 
            if);
            
         // ('listElementInserted'->command.equal) then
         (* listElementInserted:
          * # <editorId> listElementInserted <fatherIndex> <position> <synCatNo> <synCatName>
          *)
            editorId->theGraphicalInterface.sifEditorList.findFragmentForm
              ->ff[];
            (if ff[]
             // none then
                'Fragment form: '->putText;
                ff.name->putText;
                ' not found!!!!'->putLine;
                
             else
                t.getint->index;
                t.getint->position;
                (ff[],index,position)->theOADPage.listElementInserted;
                true->status;
                
            if);
            
         // ('listElementsDeleted'->command.equal) then
         (* listElementsDeleted:
          * # <editorId> listElementsDeleted <fatherIndex> <position> <length> <oldElements>
          *  <oldElements> ::= { <elementIndex> } i    (i = <length>)
          *)
            editorId->theGraphicalInterface.sifEditorList.findFragmentForm
              ->ff[];
            (if ff[]
             // none then
                'Fragment form: '->putText;
                ff.name->putText;
                ' not found!!!!'->putLine;
                
             else
                (ff[],t[])->theOADPage.listElementsDeleted; 
            if);
            
         // ('listElementsReplaced'->command.equal) then
         (* listElementsReplaced:
          * # <editorId> listElementsReplaced <fatherIndex> <position> <length> <oldElement> <newLength> 
          * <oldElement> ::= { <elementIndex> } i    (i = <length>)
          *)
            editorId->theGraphicalInterface.sifEditorList.findFragmentForm
              ->ff[];
            (if ff[]
             // none then
                'Fragment form: '->putText;
                ff.name->putText;
                ' not found!!!!'->putLine;
                
             else
                (ff[],t[])->theOADPage.listElementsReplaced; 
            if);
            
         // ('presentAnchor'->command.equal) then
            t.getInt->theOADPage.presentAnchor; 
         // 'quit'->command.equal then
            theController.com.closeCommunication; false->doSendStatus; stop; 
         // 'closeComm'->command.equal then
            theController.com.closeCommunication; false->doSendStatus; 
         // 'makeFrejaTilde'->command.equal then
            (if graf.currentDiagramName[] <> none then
                graf.currentDiagramName->graf.removeExtension->fileName;
                '.freja~'->fileName.Append;
                (if theGraphicalInterface.switch[17] then
                    'Freja makeFrejaTilde:'->putLine; filename[]->putLine; 
                if);
                fileName[]->graf.makeFrejaFile
             else
                'No currentDiagramName?'->putline
            if)
         else
            'Freja ------ Command not handled: '->puttext; command[]->putline; 
        if);
        (if doSendStatus
         // true then
            '!'->s[];
            (if theNode[]
             // none then EditorID->s.putint; 
             else
                theNode.SifEditorInstanceNo->s.putint
            if);
            ' '->s.put;
            command[]->s.puttext;
            s[]->theController.sendSifStatus;
            
        if);
        
     #)
do
   (if theGraphicalInterface.switch[12]
    // true then
       '------------------------- HandleControllerMessage: '->putText;
       t[]->screen.putLine;
       
   if);
   theGraphicalInterface.theDesignInterface[]->graf[];
   graf.theDocument[]->theDoc[];
   (if (1->t.inxGet)
    // '!' then
       (if theGraphicalInterface.switch[12]
        // true then 'Freja ------ Status from SIF: '->puttext; t[]->putline; 
       if);
       t[]->parseStatusMessage->(command[],OK,editorID,trailer[]);
       (if ok
        // true then
           (if true
            // 'openGroup'->command.equal then
               (if theGraphicalInterface.switch[12]
                // true then
                   'Freja ------ [[Status OpenGroup; editorID is: '->puttext;
                   editorID->putint;
                   ']]'->putline;
                   
               if);
               
            // 'openForm'->command.equal then
                 (# ffName: ^Text
                 do
                    (if editorId <> 0 then
                        &theGraphicalInterface.sifEditorList.element[]
                          ->anElement[];
                        editorId->anElement.editorId;
                        trailer.reset;
                        trailer.getAtom;
                        trailer.getAtom->ffName[];
                        searchFrag:
                        theDoc.theGroupPage.patternDiagrams.theList.
                          scanFragmentDiagrams
                          (# 
                          do
                             thisDiagram.localNodes.scan
                               (# fn: ^thisDiagram.fragmentNode
                               do
                                  (if current## <= thisDiagram.fragmentNode##
                                   then
                                      current[]->fn[];
                                      (if
                                      (fn.theFragment).fullName->ffName.equal
                                       then
                                          editorID->fn.SifEditorInstanceNo;
                                          fn.theFragment->anElement.ff[];
                                          leave searchFrag
                                      if)
                                  if)
                               #)
                          #);
                        (if anElement.ff[] <> none then
                            anElement[]
                              ->theGraphicalInterface.sifEditorList.insert
                         else
                            'Freja openForm: Fragmentform not open in Freja?'
                              ->putline
                        if)
                    if);
                    
                 #)
            // 'save'->command.equal then
               (if graf.currentDiagramName[] <> none then
                   graf.currentDiagramName->graf.removeExtension->fileName;
                   '.freja~'->fileName.Append;
                   (if theGraphicalInterface.switch[17] then
                       'Freja makeFrejaTilde:'->putLine; filename[]->putLine; 
                   if);
                   fileName[]->graf.makeFrejaFile
                else
                   'No currentDiagramName?'->putline
               if);
               (if graf.currentDiagramName[] <> none then
                   graf.currentDiagramName->graf.removeExtension->fileName;
                   '.freja'->fileName.Append;
                   (if theGraphicalInterface.switch[17] then
                       'Freja save:'->putLine; filename[]->putLine; 
                   if);
                   fileName[]->graf.makeFrejaFile
                else
                   'No currentDiagramName?'->putline
               if)
            // 'saveAndQuit'->command.equal then
               (if graf.currentDiagramName[] <> none then
                   graf.currentDiagramName->graf.removeExtension->fileName;
                   '.freja'->fileName.Append;
                   (if theGraphicalInterface.switch[17] then
                       'Freja save and quit:'->putLine; filename[]->putLine; 
                   if);
                   fileName[]->graf.makeFrejaFile;
                   theController.close;
                   (normal,' ')->stop
                else
                   'No currentDiagramName?'->putline
               if)
            // 'undo'->command.equal then
               
            // 'cut'->command.equal then
               
            // 'copy'->command.equal then
               
            // 'paste'->command.equal then
               
            // 'before'->command.equal then
               
            // 'after'->command.equal then
               
            // 'changeFocus'->command.equal then
               theDoc.CurrentPage->thePage[];
               (if thePage[]
                // theDoc.OADPalette[] then
                   'HandleContrMes: CurrentPage is the palette'->putline; 
                else
                   (if thePage## <= theDoc.OADPage## then
                       thePage[]->theOADPage[];
                       trailer.reset;
                       trailer.getatom->editType[];
                       trailer.getint->theOADPage.canUndo;
                       trailer.getint->theOADPage.canPaste;
                       trailer.getint->theOADPage.canListInsert;
                       (if theOADPage.canUndo then
                           theDoc.FrejaEditMenu.iUndo.enable;
                           (if theGraphicalInterface.switch[1] then
                               'EditMenu: Undo enabled'->putline
                           if)
                        else
                           theDoc.FrejaEditMenu.iUndo.disable;
                           (if theGraphicalInterface.switch[1] then
                               'EditMenu: Undo disabled'->putline
                           if)
                       if);
                       (if theOADPage.canPaste then
                           theDoc.FrejaEditMenu.iPaste.enable;
                           (if theGraphicalInterface.switch[1] then
                               'EditMenu: Paste enabled'->putline
                           if)
                        else
                           theDoc.FrejaEditMenu.iPaste.disable;
                           (if theGraphicalInterface.switch[1] then
                               'EditMenu: Paste disabled'->putline
                           if)
                       if);
                       (if theGraphicalInterface.switch[31]
                        // false then
                           (if ('expanded'->edittype.equal) or
                           ('lexem'->edittype.equal)
                            // true then
                               (if theDoc.GppProp.usingExpandMenu
                                // true then theDoc.theexpandmenu.deletemenu; 
                                else
                                   theDoc.OADPalette.clear; 
                               if);
                               
                            else
                               (if not ('lexem'->editType.equal) then
                                   (if theDoc.GppProp.usingExpandMenu
                                    // true then
                                       theDoc.theexpandmenu.deletemenu;
                                       (trailer.pos+1,trailer.length)
                                         ->trailer.sub
                                         ->theDoc.theExpandMenu.CreateItems;
                                       
                                    else
                                       (trailer.pos+1,trailer.length)
                                         ->trailer.sub->theOADPage.MakeAPalette;
                                       'unexpNormal'->edittype.equal
                                         ->theDoc.OADPalette.normal;
                                       
                                   if)
                               if);
                               
                           if);
                           
                       if);
                       (if theGraphicalInterface.switch[1] then
                           'Calling concludeOngoingOperation!'->putline
                       if);
                       theOADPage.concludeOngoingOperation
                    else
                       'HandleContrllMessage: GetStatus: thePage is not an OADPage'
                         ->screen.putline
                   if);
                   
               if)
            // 'getStatus'->command.equal then
                 (# index,length: @Integer
                 do
                    theDoc.CurrentPage->thePage[];
                    (if thePage[]
                     // theDoc.OADPalette[] then
                        'HandleContrMes: CurrentPage is the palette'->putline; 
                     else
                        (if thePage.struc
                         // theDoc.OADPage## then
                            thePage[]->theOADPage[];
                            trailer.reset;
                            trailer.getint->index;
                            trailer.getint->length;
                            trailer.getatom->edittype[];
                            trailer.getint->theOADPage.canUndo;
                            trailer.getint->theOADPage.canPaste;
                            trailer.getint->theOADPage.canListInsert;
                            (if theOADPage.canUndo then
                                theDoc.FrejaEditMenu.iUndo.enable;
                                (if theGraphicalInterface.switch[1] then
                                    'EditMenu: Undo enabled'->putline
                                if)
                             else
                                theDoc.FrejaEditMenu.iUndo.disable;
                                (if theGraphicalInterface.switch[1] then
                                    'EditMenu: Undo disabled'->putline
                                if)
                            if);
                            (if theOADPage.canPaste then
                                theDoc.FrejaEditMenu.iPaste.enable;
                                (if theGraphicalInterface.switch[1] then
                                    'EditMenu: Paste enabled'->putline
                                if)
                             else
                                theDoc.FrejaEditMenu.iPaste.disable;
                                (if theGraphicalInterface.switch[1] then
                                    'EditMenu: Paste disabled'->putline
                                if)
                            if);
                            (if theGraphicalInterface.switch[31]
                             // false then
                                (if 'expanded'->edittype.equal
                                 // true then
                                    (if theDoc.GppProp.usingExpandMenu
                                     // true then
                                        theDoc.theexpandmenu.deletemenu; 
                                     else
                                        theDoc.OADPalette.clear; 
                                    if);
                                    
                                 else
                                    (if not ('lexem'->editType.equal) then
                                        (if theDoc.GppProp.usingExpandMenu
                                         // true then
                                            theDoc.theexpandmenu.deletemenu;
                                            (trailer.pos+1,trailer.length)
                                              ->trailer.sub
                                              ->
                                                theDoc.theExpandMenu.
                                                  CreateItems;
                                            
                                         else
                                            (trailer.pos+1,trailer.length)
                                              ->trailer.sub
                                              ->theOADPage.MakeAPalette;
                                            'unexpNormal'->edittype.equal
                                              ->theDoc.OADPalette.normal;
                                            
                                        if)
                                    if);
                                    
                                if)
                            if)
                         else
                            'HandleContrllMessage: GetStatus: thePage is not an OADPage'
                              ->screen.putline;
                            
                        if)
                    if)
                 #);
               
            // 'expandNormal'->command.equal then
               (if theGraphicalInterface.switch[31]
                // false then
                   (if theDoc.GppProp.usingExpandMenu
                    // true then theDoc.theexpandmenu.deletemenu; 
                    else
                       theDoc.OADPalette.clear; 
                   if);
                   
               if);
               theDoc.CurrentPage->thePage[];
               (if thePage[] = theDoc.OADPalette[] then
                   'HandleContrMes: CurrentPage is the palette'->putline
                else
                   (if thePage## <= theDoc.OADPage## then
                       thePage[]->theOADPage[];
                       (if theGraphicalInterface.switch[1] then
                           'Calling concludeExpansion!'->putline
                       if);
                       theOADPage.concludeExpansion
                    else
                       'HandleContrMes: CurrentPage is an ObjectPage'->putline
                   if)
               if)
            // 'expandOptional'->command.equal then
               (if theGraphicalInterface.switch[31]
                // true then
                   (if theDoc.GppProp.usingExpandMenu
                    // true then theDoc.theexpandmenu.deletemenu; 
                    else
                       theDoc.OADPalette.clear; 
                   if);
                   
               if);
               theDoc.CurrentPage->thePage[];
               (if thePage[] = theDoc.OADPalette[] then
                   'HandleContrMes: CurrentPage is the palette'->putline
                else
                   (if thePage## <= theDoc.OADPage## then
                       thePage[]->theOADPage[];
                       (if theGraphicalInterface.switch[1] then
                           'Calling concludeExpansion!'->putline
                       if);
                       theOADPage.concludeExpansion
                    else
                       'HandleContrMes: CurrentPage is an ObjectPage'->putline
                   if)
               if)
            // 'getAnchors'->command.equal then
               (if theGraphicalInterface.switch[12]
                // true then
                   'Freja ------ [[Got anchors: '->screen.puttext;
                   trailer[]->screen.puttext;
                   ']]'->screen.putline;
                   
               if);
               theDoc.CurrentPage->thePage[];
               (if thePage[]
                // theDoc.OADPalette[] then
                   'HandleContrMes: CurrentPage is the palette'->putline; 
                else
                   (if thePage.struc
                    // theDoc.OADPage## then
                       thePage[]->theOADPage[];
                       trailer->theOADPage.MakeAnchors;
                       
                    else
                       'HandleContrllMessage: GetAnchors: thePage is not an OADPage'
                         ->screen.putline;
                       
                   if)
               if)
            // 'startLink'->command.equal // 'endLink'->command.equal then
               theDoc.CurrentPage->thePage[];
               (if thePage[]
                // theDoc.OADPalette[] then
                   'HandleContrMes: CurrentPage is the palette'->putline; 
                else
                   thePage[]->theOADPage[];
                   theOADPage.CurrentObject->theObject[];
                   (if theObject[] <> none
                    // true then
                       (if theObject.struc <= theOADPage.PatternDiagramNode##
                        // true then
                           theObject[]->theNode[]; theNode.MakeAnchor; 
                       if)
                   if)
               if);
               
            // ('parse'->command.equal) then
               theDoc.CurrentPage->theOADPage[];
               theOADPage.theTextBefore.clear;
               theOADPage.parseableText.clear;
               (if theOADPage.onGoingTitleEditing then
                   false->theOADPage.onGoingTitleEditing
                else
                   (if theOADPage.ongoingTextediting then
                       theOADPage.CurrentFocus.abstract
                   if)
               if);
               false->theOADPage.ongoingTextediting
            // ('parseAfter'->command.equal) then
               theDoc.CurrentPage->theOADPage[];
               editorId->theGraphicalInterface.sifEditorList.findFragmentForm
                 ->ff[];
               (if ff[]
                // none then
                   'Fragment form '->putText; ' not found!!!!'->putLine; 
                else
                   trailer.reset;
                   trailer.getInt->ff.indexToNode->theOADPage.AstToNode
                     ->theOADPage.private.newAssociationNode.thePatternNode;
                   
               if);
               
            // ('newBETAProgram'->command.equal) then
               
            // ('newBETALib'->command.equal) then
               
            // 'autoSave'->command.equal then
               (if graf.currentDiagramName[] <> none then
                   graf.currentDiagramName->graf.removeExtension->fileName;
                   '.freja#'->fileName.Append;
                   (if theGraphicalInterface.switch[17] then
                       'Freja autosave:'->putLine; filename[]->putLine; 
                   if);
                   fileName[]->graf.makeFrejaFile
                else
                   'No currentDiagramName?'->putline
               if)
            else
               (if theGraphicalInterface.switch[12] then
                   'Freja: OK Status from Sif: "'->puttext;
                   t[]->puttext;
                   '"'->put;
                   newline;
                   'but nothing done!'->putLine;
                   
               if);
               
           if);
           
        else
           (if true
            // ('newBETAProgram'->command.equal) then
               
            // ('newBETALib'->command.equal) then
               
            // ('parse'->command.equal) then
               (if theGraphicalInterface.switch[12] then
                   'trailer is: '->putText; trailer[]->putLine; 
               if);
               trailer.reset;
               trailer.getInt->errorPos;
               (trailer.pos+2,trailer.length)->trailer.sub->parseErrorText[];
               theDoc.CurrentPage->thePage[];
               (if thePage[]
                // theDoc.OADPalette[] then
                   'HandleContrMes: CurrentPage is the palette'->putline; 
                else
                   thePage[]->theOADPage[];
                   theOADPage.CurrentObject->theObject[];
                   (if theObject[] <> none
                    // true then
                       (if theObject.struc <= theOADPage.PatternDiagramNode##
                        // true then
                           theObject[]->theNode[];
                           theNode.theText.ModeOn;
                           true->theDoc.FrejaEditMenu.textModeOn
                             ->theDoc.FrejaEditMenu.iTextEdit.check;
                           (theObject.ID,errorPos,errorPos)
                             ->
                               theGraphicalInterface.theDesignInterface.
                                 DSTextSetSelection;
                           parseErrorText
                             ->
                               theGraphicalInterface.theDesignInterface.
                                 DSUIUserAckMessage;
                           
                       if)
                   if)
               if)
            else
               'Freja: BAD Status from Sif: "'->puttext;
               t[]->puttext;
               '"'->put;
               newline;
               
           if)
       if);
       (if theDoc[] <> none then
           theDoc.currentPage->theOADPage[];
           (if theOADpage[] <> none then theOADpage.ungrabPointer if)
       if);
       
    else
       (if (1->t.inxGet)
        // '#' then
           (if theDoc[] <> none then
               theDoc.currentPage->theOADPage[];
               (if theOADpage[] <> none then theOADpage.grabPointer if)
           if);
           (if theGraphicalInterface.switch[12]
            // true then
               'Freja ------ Command from SIF: '->puttext; t[]->putline; 
           if);
           (if theDoc[]
            // none then t[]->HandleSifCommand; 
            else
               theDoc.CurrentPage->thePage[];
               (if thePage[]
                // none then
                   'HandleCommand: No current page'->putline;
                   '!0 0'->theController.sendSifStatus;
                   
                else
                   (if thePage[]
                    // theDoc.OADPalette[] then
                       'HandleContrMes: CurrentPage is the palette'->putline;
                       '!0 0'->theController.sendSifStatus;
                       
                    else
                       (if thePage.struc
                        // theDoc.OADPage## then
                           thePage[]->theOADPage[];
                           t[]->HandleSifCommand;
                           theOADPage.CurrentFocus[]->theObject[];
                           (if theObject[]
                            // none then
                               'HandleCommand: No object to handle the command'
                                 ->putline;
                               
                            else
                               (if theObject.struc <=
                               theOADPage.PatternDiagramNode##
                                // true then
                                   theObject[]->theNode[];
                                   (if theNode.theDiagram
                                    // none then
                                       'HandleCommand: Current object has no diagram'
                                         ->putline;
                                       
                                    else
                                   (*'t[]->HandleSifCommand;????'->putline;*)
                                       
                                   if)
                                else
                                   'Current object is not a PatternDiagramNode!'
                                     ->putline
                               if)
                           if)
                        else
                           'HandleContrllMessage: SifCommand: thePage is not an OADPage'
                             ->screen.putline;
                           
                       if)
                   if)
               if)
           if);
           (if theDoc[] <> none then
               theDoc.currentPage->theOADPage[];
               (if theOADpage[] <> none then theOADpage.ungrabPointer if)
           if)
        else
           'Something from SIF: '->t.prepend;
           t[]->putline;
           '!0 0'->theController.sendSifStatus;
           
       if)
   if);
   
#)  

-- ParseStatusMessage: Descriptor --
(# 
do
   (if (1->status.inxGet)
    // '!' then
       (if (2->status.inxGet)
        // '0' then (* global command *)
           2->status.setpos;
           (* skip '!0' *)
           status.Getatom->command[];
           status.getint->OK;
           (if status.pos < status.length
            // true then
               status.getint->editorID;
               (if status.pos < status.length
                // true then
                   loop:
                     (# 
                     do (* skip blanks *)
                        (if status.pos->status.inxget
                         // ' ' then status.get; restart loop; 
                        if)
                     #);
                   (status.pos,status.length)->status.sub->trailer[];
                   
               if)
           if);
           
        else
           1->status.setpos;
           (* skip '!' *)
           (* editorID is next *)
           status.getint->editorID;
           (* ess 021394 status.pos-1 -> status.setpos;*)
           status.Getatom->command[];
           status.getint->OK;
           (if status.pos < status.length
            // true then
               status.pos+1->status.setpos;
               loop:
                 (# 
                 do (* skip blanks *)
                    (if status.pos->status.inxget
                     // ' ' then status.get; restart loop; 
                    if)
                 #);
               (status.pos,status.length)->status.sub->trailer[];
               
           if)
       if);
       
    else
       false->ok; 
   if);
   (if theGraphicalInterface.switch[12]
    // true then
       'Freja ------ Sif status from command: "'->screen.puttext;
       (if command[] <> none // true then command[]->screen.puttext;  if);
       '"'->screen.put;
       (if ok
        // true then ' ok. '->screen.puttext
        else
           ' not ok. '->screen.puttext
       if);
       'editorID is: '->screen.puttext;
       editorID->screen.putint;
       (if trailer[] <> none
        // true then '. Rest is: '->puttext; trailer[]->screen.puttext; 
       if);
       screen.newLine;
       
   if);
   
#)  

-- findFragmentForm: Descriptor --
(# 
do
   search: scan
     (# 
     do
        (if current.editorId
         // editorId then current.ff[]->ff[]; leave search; 
        if)
     #)
#)  

-- updateFragmentForm: Descriptor --
(# 
do
   search: scan
     (# 
     do
        (if current.ff.fullname->(ff.fullname).equal then
            ff[]->current.ff[]; leave search; 
        if)
     #)
#)  

-- findEditorId: Descriptor --
(# 
do
   search: scan
     (# 
     do
        (if current.ff.fullname->(ff.fullname).equal then
            current.editorId->editorId; leave search; 
        if)
     #)
#)  

-- SifEditorListInsert: Descriptor --
(# editorID: @integer
do
   theElm.ff[]->findEditorId->editorID;
   (if editorID = 0 then theElm[]->append if)
#)  

-- SifEditorListDump: Descriptor --
(# 
do
   scan
     (# 
     do
        '('->puttext;
        current.editorId->putint;
        ', '->puttext;
        current.ff.fullname->puttext;
        ')'->putline
     #)
#)  

-- OpenObjectInSif: Descriptor --
(# theNode: ^PatternDiagramNode; aForm: ^FragmentForm; t: ^Text; 
do
(*  '#0openForm '->t[];
 (if theObject[] // none then CurrentObject->theObject[] if);
 (if theObject[]
 // none then 'No selection, please select a node'->DSUIUserAckMessage;
 else
 (if theObject.struc <= PatternDiagramNode##
 // true then
 theObject[]->theNode[];
 theNode.GetFragment->aForm[];
 (if aForm[] <> none
 // true then
 aForm[]->theGraphicalInterface.sifEditorList.askedForFragmentForm[];
 aForm.fullname->t.append;
 ' '->t.put;
 theNode.ASTIndex->t.putint;
 (if theGraphicalInterface.switch[12]
 // true then t[]->putline
 if);
 t[]->theController.sendSifCommand;
 else
 'Cannot find FragmentForm for selected node'->DSUIUserAckMessage;
 (if theGraphicalInterface.switch[12]
 // true then t[]->putline
 if);
 if)
 if)
 if);*) 
#)  

-- GetDexterAnchors: Descriptor --
(# t: ^Text; 
do
   (if theController.com.sifIsRunning and false
    // true then
       '# '->t[];
       editorID->t.putint;
       ' getAnchors'->t.append;
       t[]->theController.sendSifCommand;
       (if theGraphicalInterface.switch[12]
        // true then t[]->screen.putline
       if);
       
   if)
#)  

-- ChangedFocus: Descriptor --
(#
   t: ^Text;
   ok: @boolean;
   editorid: @Integer;
   anAST: ^AST;
   theExp: ^Expanded;
   graf: ^theGraphicalInterface.DesignInterface;
   theDoc: ^theGraphicalInterface.theDesignInterface.OADDocument
do
   (if theGraphicalInterface.switch[12]
    // true then
       '----------------------------------------------------------------------'
         ->screen.putLine;
       'Show Sif Selection: '->putText;
       ShowSIFSelection->putInt;
       newline;
       'newObject.SifEditorInstanceNo: '->putText;
       newObject.SifEditorInstanceNo->putInt;
       newline;
       (* 'oldObject: '->putLine;
        oldObject.dump;
        'newObject: '->putLine;
        newObject.dump;
        'oldFocus: '->putLine;
        oldFocus.dump;
        'newFocus: '->putLine;
        currentFocus.dump;*)
       
   if);
   (if oldFocus[] <> none then (* use oldFocus instead of oldObject *)
       theGraphicalInterface.theDesignInterface[]->graf[];
       graf.theDocument[]->theDoc[];
       (if oldFocus.theText.isModeOn then
           (if theGraphicalInterface.switch[12]
            // true then 'Finish textediting'->screen.putLine; 
           if);
           oldFocus.theText.modeOff;
           false->theDoc.FrejaEditMenu.textModeOn
             ->theDoc.FrejaEditMenu.iTextEdit.check;
           (*false->OKToChange*)
           
       if);
       
   if);
   (if ShowSIFSelection
    // true then
       (if newObject.SifEditorInstanceNo <> 0
        // true then
           newObject.getASTNode->anAST[];
           (if anAST[] <> none then
               (if anAST## <= betaGram.AttributeDecl## then
                   anAST[]->theExp[];
                   (if anAST.Symbol = betaGram.RepetitionDecl then
                       theExp.getSon3->anAST[]
                    else
                       theExp.getSon2->anAST[]
                   if);
                   setFocus:
                   (if anAST.kind = kinds.unExpanded then
                       (newObject.SifEditorInstanceNo,anAST.index)
                         ->changeASTFocus
                    else
                       (if (anAST## <= betaGram.ReferenceSpecification##) or
                       (anAST## <= betaGram.Remote##) then
                           anAST[]->theExp[];
                           theExp.getSon1->anAST[];
                           restart setFocus
                        else
                           '# '->t[];
                           newObject.SifEditorInstanceNo->t.putint;
                           ' changeFocus '->t.append;
                           (newObject.getASTNode).index->t.putint;
                           ' 1'->t.append;
                           t[]->theController.sendSifCommand
                       if)
                   if)
                else
                   '# '->t[];
                   newObject.SifEditorInstanceNo->t.putint;
                   ' changeFocus '->t.append;
                   (newObject.getASTNode).index->t.putint;
                   ' 1'->t.append;
                   t[]->theController.sendSifCommand
               if)
            else
               '# '->t[];
               newObject.SifEditorInstanceNo->t.putint;
               ' changeFocus '->t.append;
               newObject.astIndex->t.putint;
               (if theGraphicalInterface.switch[12] then
                   'ChangeFocus: newObject.astIndex '->puttext;
                   newObject.astindex->putint;
                   newline;
                   
               if);
               ' 1'->t.append;
               t[]->theController.sendSifCommand
           if);
           
       if)
   if);
   
#)  

-- declarationTextChanged: Descriptor --
(# t: ^text (* should we use currentFocus or theObject? *) ; 
do
   (if theObject[] <> none
    // true then
       (if theObject.theDiagram <> none
        // true then
           (if theObject.SifEditorInstanceNo <> 0
            // true then
               '# '->t[];
               theObject.SifEditorInstanceNo->t.putint;
               ' parse '->t.putText;
               index->t.putInt;
               theParseText[]->t.putText;
               t[]->theController.sendSifCommand
           if)
        else
           'DoParse: theDiagram is NONE'->putline; 
       if)
    else
       'DoParse: CurrentFocus is NONE'->putline; 
   if)
#)  

-- openFormInSif: Descriptor --
(# t: ^text; theTitle: @Text; editorId: @Integer
do
   '#0openForm '->t[];
   ff.fullName->t.putText;
   fn[]->theFragmentNode[];
   (if switch[1] then
       (if theFragmentNode[] <> none then
           
        else
           'theFragmentNode is NONE !!!!'->putline
       if)
   if);
   ff[]->SifEditorList.findEditorId->editorID;
   (if editorID = 0 then
       ' 0 '->t.puttext; t[]->theController.sendSifCommand
   if);
   
#)  

-- prefixExpand: Descriptor --
(# t: ^Text; 
do
   (if CurrentFocus[] <> none
    // true then
       (if CurrentFocus.theDiagram <> none
        // true then
           (if CurrentFocus.SifEditorInstanceNo <> 0
            // true then
            (* '# '->t[];
             CurrentFocus.SifEditorInstanceNo->t.putint;
             (if normal
             // true then ' expandNormal '->t.append; 
             else
             ' expandOptional '->t.append; 
             if); *)
               'Go call sif to expand the prefix'->screen.putline; 
           if)
        else
           'DoExpand: theDiagram is NONE'->putline; 
       if)
    else
       'DoExpand: CurrentFocus is NONE'->putline; 
   if)
#)  

-- copy: Descriptor --
(# 
do
   'copy: '->puttext;
   (if theObject[] <> none // true then theObject.astIndex->putint if);
   newline;
   
#)  

-- onFocusChange: Descriptor --
(#
(* Selects the diagram node that corresponds to the focus in sif (anAst).
 * If the diagram node doesn't exist, the path up to the rooth in the AST is
 * traversed until an AST node that has a corresponding diagram node is found.
 * This diagram node is then detailed and the same is done for the AST nodes
 * that have been met on the way up.
 * The stack S is used for this.
 *)
   theObject: ^PatternDiagramNode;
   theListDiagram: ^ListDiagram;
   ff: ^fragmentForm;
   anAst,anAST2: ^ast;
   S: @stack (# element::< ast (* integerObject *) #);
   io: ^integerObject;
   hasDetailed: @boolean;
   
do
   false->status;
   S.init;
   (if switch[10]
    // true then
       'Freja ----- onFocusChange: '->putText;
       astIndex->putInt;
       ' '->put;
       length->putInt;
       ' editorId: '->putText;
       editorId->putInt;
       newline;
       
   if);
   editorId->sifEditorList.findFragmentForm->ff[];
   (if ff[]
    // none then 'Fragment form not found!'->putLine; 
    else
       thisOp:
       astIndex
         ->ff.indexToNode
           (#
              indexOutOfRange::< 
                (#  do 'indexOutOfRange'->putLine; true->continue;  #);
              noSuchSymbol::< 
                (#  do 'noSuchSymbol'->putLine; true->continue;  #);
              grammarGenRefArrayError::< 
                (# 
                do 'grammarGenRefArrayError'->putLine; true->continue; 
                #)
           #)->anAst[];
       (if anAst[]
        // none then 'Node not found'->putLine
        else
           search:
             (# 
             do
                (if switch[10] // true then 'searching...'->putLine;  if);
                (if (anAst[] <> none )
                 // true then
                    (if switch[11]
                     // true then
                        'Freja ----- anAst.Index: '->putText;
                        anAst.Index->putInt;
                        newLine;
                        
                    if);
                    (*anAst.index->IndexIDList.IndextoObject->theObject[];*)
                    anAst[]->ASTtoNode->theObject[]
                 else
                    none ->theObject[]; 
                if);
                (if (theObject[] <> none )
                 // true then
                    theObject.theDiagram->theListDiagram[];
                    (if theObject## <= theListDiagram.FragmentNode## then
                    (* don't show these *)
                        
                     else
                        theObject[]->CurrentObject (#  do true->autoPan #);
                        currentFocus[]->oldFocus[];
                        theObject[]->CurrentFocus[];
                        
                    if);
                    (if switch[10]
                     // true then
                        'theObject.astIndex: '->putText;
                        theObject.astIndex->putInt;
                        newLine;
                        (if true
                         // theObject.struc <= PatternDiagramNode## then 
                         else
                            'It is not a PatternDiagramNode!!'->putLine;
                            (if true
                             // theObject.struc = GenericNode## then
                                'It is a GenericNode!!'->putLine; 
                             // theObject.struc = Node## then
                                'It is a Node!!'->putLine; 
                             // theObject.struc = DesignObject## then
                                'It is a DesignObject!!'->putLine; 
                             // theObject.struc = IdObject## then
                                'It is a IdObject!!'->putLine; 
                            if);
                            (* not visible here!!
                             * (if true 
                             // theObject.struc <= AbstractNode## then
                             'It is an AbstractNode!!' ->putLine;
                             (if true 
                             // theObject.struc <= FragmentNode## then
                             'It is an FragmentNode!!' ->putLine;
                             // theObject.struc = NonterminalNode## then
                             'It is an NonterminalNode!!' ->putLine;
                             // theObject.struc <= DiagramNode## then
                             'It is a DiagramNode!!' ->putLine;
                             if);
                             if);
                             * *)
                            
                        if);
                        
                    if);
                    true->status;
                    (if S.empty
                     // true then
                        (if switch[11]
                         // true then 'Freja ----- stack is empty'->putLine; 
                        if);
                        
                     else
                        openDownUntilNode:
                        (if S.empty
                         // false then
                            S.pop->anAST2[];
                            (*io[];*)
                            (if switch[11]
                             // true then
                                'Freja ----- pop '->putText;
                                anAST2.index->putInt;
                                newline;
                                
                            if);
                            (* showNode if not shown *)
                            (*io.value->IndexIDList.IndextoObject->theObject[];*)
                            anAST2[]->ASTtoNode->theObject[];
                            (if theObject[]
                             // none then (* 'detailing... '->statusbar.set;*)
                                false->currentFocus.IndicateSelection;
                                currentFocus.detail;
                                (* statusbar.reset;*)
                                true->hasDetailed;
                                (*io.value->IndexIDList.IndextoObject
                                 ->theObject[];*)
                                anAST2[]->ASTtoNode->theObject[];
                                (if theObject[] <> none
                                 // true then
                                    (if switch[11]
                                     // true then
                                        'Freja ----- node found'->putLine; 
                                    if);
                                    theObject[]->CurrentObject;
                                    currentFocus[]->oldFocus[];
                                    theObject[]->CurrentFocus[];
                                    true->status;
                                    
                                 else
                                    'node not found in detailed diagram!!'
                                      ->putLine;
                                    
                                if);
                                restart openDownUntilNode
                            if)
                        if)
                    if)
                 else
                    (if (anAst[] <> none )
                     // true then
                        (if switch[11]
                         // true then
                            'Freja ----- anAst.symbol '->putText;
                            anAst.symbol->putint;
                            ' anAst.index '->putText;
                            anAst.index->putint;
                            ' '->put;
                            anAst.symbol->betaGram.symbolToName->putLine;
                            
                        if);
                        (if anAst.kind
                         // kinds.interior then
                            (if anAst.symbol
                             // betaGram.SimpleDecl // betaGram.PatternDecl
                             // betaGram.VirtualDecl // betaGram.BindingDecl
                             // betaGram.FinalDecl
                             //
                             betaGram.RepetitionDecl
                             (*// betaGram.VariablePatternDecl*) then
                                (if switch[11]
                                 // true then
                                    'Freja ----- push '->putText;
                                    anAst.index->putInt;
                                    newline;
                                    
                                if);
                                (*&integerObject[]->io[];
                                 anAst.index->io.value;
                                 io[]->S.push;
                                 *)
                                anAST[]->S.push
                            if)
                         // kinds.unexpanded then
                            (if
                            (anAst[]->qua (# as:: unexpanded #)).
                            nonterminalSymbol
                             // gram.AttributeDeclOpt then
                                (if switch[11]
                                 // true then
                                    'Freja ----- push nonterminal'->putText;
                                    anAst.index->putInt;
                                    newline;
                                    
                                if);
                                (*&integerObject[]->io[];
                                 anAst.index->io.value;
                                 io[]->S.push;*)
                                anAST[]->S.push
                            if)
                        if);
                        anAst.father->anAst[];
                        restart search;
                        
                     else
                    (* astIndex not on the path up to the root *)
                        'astIndex not on the path up to the root'->putLine;
                        false->status;
                        
                    if);
                    
                if)
             #);
           
       if)
   if);
   (if status
    // false then astIndex->putint; ': no such object in freja'->putline; 
   if);
   (* if focusChanged has detail,
    * refresh page due to delay in update *)
   (if hasDetailed then Redraw if)
#)  

-- frejaAstReplaced: Descriptor --
(# theObject: ^PatterndiagramNode
do
   (if switch[10]
    // true then
       'Freja: onAstReplaced: '->puttext;
       oldindex->putint;
       ' to: '->puttext;
       newIndex->putint;
       newline;
       'Nothing is done in freja'->putLine;
       
   if);
   
#)  

-- presentAnchor: Descriptor --
(# theObject: ^PatternDiagramNode; 
do
(*  '[[Freja: presentAnchor '->screen.puttext;
 theIndex->screen.putint;
 theIndex->AstToNode->theObject[];
 (if theObject[] <> none
 // true then theObject[]->CurrentObject;
 else
 'no such index shown in Freja'->screen.puttext;
 if);
 ']]'->screen.putline;
 * *) 
#)  

-- GetStatusFromSif: Descriptor --
(# t: ^Text; theNode: ^PatternDiagramNode; 
do
   (if theObject.struc <= PatternDiagramNode##
    // true then
       theObject[]->theNode[];
       (if theNode.SifEditorInstanceNo
        // 0 then
           (if theGraphicalInterface.switch[12]
            // true then 'Freja ------ No Sif Editor Instance open'->putline; 
           if);
           
        else
           '# '->t[];
           theNode.SifEditorInstanceNo->t.putint;
           ' getStatus '->t.append;
           (if theGraphicalInterface.switch[12]
            // true then t[]->putline
           if);
           t[]->theController.sendSifCommand
       if);
       
    else
       'Freja ------ ERROR: GetStatus: theObject is not a DiagramNode'->putline;
       
   if)
#)  

-- DoExpand: Descriptor --
(# t: ^Text; 
do
   (if CurrentFocus[] <> none
    // true then
       (if CurrentFocus.theDiagram <> none
        // true then
           (if CurrentFocus.SifEditorInstanceNo <> 0
            // true then
               '# '->t[];
               CurrentFocus.SifEditorInstanceNo->t.putint;
               (if normal
                // true then ' expandNormal '->t.append; 
                else
                   ' expandOptional '->t.append; 
               if);
               synCatNo->t.putint;
               t[]->theController.sendSifCommand;
               (if theGraphicalInterface.switch[31]
                // true then
                   (if gppProp.UsingExpandMenu
                    // true then theexpandmenu.deletemenu; 
                    else
                       OADPalette.reset; 
                   if);
                   
               if)
           if)
        else
           'DoExpand: theDiagram is NONE'->putline; 
       if)
    else
       'DoExpand: CurrentFocus is NONE'->putline; 
   if)
#)  

-- DoExpandLexem: Descriptor --
(# t: ^Text; 
do
   (if CurrentFocus[] <> none
    // true then
       (if CurrentFocus.theDiagram <> none
        // true then
           (if CurrentFocus.SifEditorInstanceNo <> 0
            // true then
               '# '->t[];
               CurrentFocus.SifEditorInstanceNo->t.putint;
               ' expandLexem '->t.append;
               
           if);
           name[]->t.append;
           t[]->theController.sendSifCommand;
           (if theGraphicalInterface.switch[31]
            // true then
               (if gppProp.UsingExpandMenu
                // true then theexpandmenu.deletemenu; 
                else
                   OADPalette.reset; 
               if);
               
           if)
       if)
    else
       'DoExpandLexem: CurrentFocus is NONE'->putline; 
   if)
#)  

-- MakeAPalette: Descriptor --
(# tt: ^Text; 
do
   (if OADPalette.isopen
    // false then (100,100,200,400)->OADPalette.PositionNew; 
    else
       OADPalette.clear; 
   if);
   nonTerminalCatName->OADPalette.title;
   (if t[]
    // none then 
    else
       t.reset;
       t.getatom->tt[];
       (if tt[]
        // none then 
        else
           (if ('Enter'->tt.equal)
            // true then OADPalette.close; 
            else
               t.reset;
               loop:
               (if 1
                // 1 then
                   (t.getint,t.getatom)->OADPalette.add;
                   (if t.pos+1 < t.length // true then restart loop if)
               if);
               THIS(OADPage)[]->CurrentPage;
               (* select the drawing page again
                * in order to make the palette work right *)
               
           if)
       if)
   if);
   
#)  

-- ControllerInit: Descriptor --
(# portText,host,t: ^Text; help: @text; 
do
   theModel.theGraphicalInterface.switch[12]->com.debugCOM;
   'Starting Sif, please stand by...'
     ->theModel.theGraphicalInterface.theDesignInterface.statusbar.set;
   1->theModel.theGraphicalInterface.theDesignInterface.FrejaLocked;
   false->com.debugCOM;
   start:
     (# 
     do
        (if sifPort
         // 0 then
            '$(FrejaSifPort)'
              ->expandEnvVar
                (# defaultValue::<  (#  do '5000'->envVarValue[] #) #)
              ->portText[];
            portText->help;
            ' '->help.put;
            help.reset;
            help.getInt->sifPort;
            
         else
            sifPort+1->sifPort;
            ''->portText[];
            sifPort->portText.putInt;
            ' '->portText.put;
            
        if);
        '$(FrejaHost)'
          ->expandEnvVar
            (#
               defaultValue::< 
                 (# os: @osinterface;  do 'localhost'->envVarValue[] #)
            #)->host[];
        'Freja: Establishing communication through port : <'->screen.putText;
        sifPort->screen.putInt;
        '> on host: <'->screen.putText;
        host[]->screen.putText;
        '>'->screen.put;
        screen.newLine;
        '$(SifFromFreja)'
          ->expandEnvVar
            (#
               defaultValue::< 
                 (# betalib: ^text; 
                 do
                    '$(BETALIB)'
                      ->expandEnvVar
                        (#
                           defaultValue::< 
                             (#  do '~beta/'->envVarValue[] #);
                           
                        #)->betalib[];
                    '/bin/frejasif4.9.1+'->betalib.append;
                    betalib[]->envVarValue[]
                 #)
            #)->theModel.theGraphicalInterface.ExpandToFullPath->t[];
        'SifFromFreja: '->puttext;
        t[]->putline;
        com.createApplication;
        t[]->com.application.init;
        '-wp'->com.application.argument.append;
        portText[]->com.application.argument.Append;
        host[]->com.application.argument.Append;
        (if theModel.withDexter
         // true then '-dex'->com.application.argument.Append; 
        if);
        com.application.activate;
        (if sifPort->com.initInSocket then  else restart start if);
        theModel.theGraphicalInterface.theDesignInterface.statusbar.reset;
        0->theModel.theGraphicalInterface.theDesignInterface.FrejaLocked;
        
     #);
   
#)  

-- ControllerClose: Descriptor --
(# 
do
   (if com.sifIsRunning
    // true then
       (if startedFromProgram
        // false then
           'Stopping Sif'->screen.putline;
           com.stopXinputFromSocket;
           '#0quit'->sendSifCommand;
           com.closeCommunication;
           
        else
           'Closing communication with Sif'->screen.putline;
           com.stopXinputFromSocket;
           '#0closeComm'->sendSifCommand;
           com.closeCommunication;
           
       if);
       
   if);
   
#)  

-- ControllerSendSifCommand: Descriptor --
(#
   theDoc: ^theModel.theGraphicalInterface.theDesignInterface.OADDocument;
   graf: ^theModel.theGraphicalInterface.DesignInterface;
   theOADPage: ^theDoc.OADPage
do
   (if theModel[] <> none then
       (if theModel.theGraphicalInterface[] <> none then
           theModel.theGraphicalInterface.theDesignInterface[]->graf[];
           (if graf[] <> none then
               graf.theDocument[]->theDoc[];
               (if theDoc[] <> none then theDoc.CurrentPage->theOADpage[] if)
           if)
       if)
   if);
   (if com.sifIsRunning // false then init (* make connection *) if);
   (if com.sifIsRunning
    // false then
       'Cannot make connecton to SIF'
         ->theModel.theGraphicalInterface.theDesignInterface.DSUIUserAckMessage;
       
    else
   (*'Sending...'
    ->theModel.theGraphicalInterface.theDesignInterface.statusbar.set;*)
       (if theModel[] <> none then
           (if theModel.theGraphicalInterface[] <> none then
               (if theModel.theGraphicalInterface.switch[12] then
                   '------------------------- SendSifCommand: '->putText;
                   t[]->putLine
               if)
           if)
       if);
       t[]->com.putline;
       (if theOADpage[] <> none then theOADPage.grabPointer if);
       (* theModel.theGraphicalInterface.theDesignInterface.statusbar.reset*)
       
   if);
   
#)  

-- activatedFromSif: Descriptor --
(# 
do
   true->theController.startedFromProgram;
   'Freja: I was started from Sif.'->screen.putline;
   'Initiating communication throgh port: '->screen.puttext;
   port[]->screen.puttext;
   ' on host: '->screen.puttext;
   host[]->screen.putline;
   port.reset;
   (if (port.getint,host[])->theController.com.initOutSocket then
       
    else
       stop
   if);
   
#)  

-- changeASTFocus: Descriptor --
(# t: ^Text
do
   (if SifEditorInstanceNo <> 0 then
       '# '->t[];
       SifEditorInstanceNo->t.putint;
       ' changeFocus '->t.append;
       ASTIndex->t.putint;
       ' 1'->t.append;
       t[]->theController.sendSifCommand;
       
   if);
   INNER changeASTFocus
#)  

-- StaticItemConnectorOnInit: Descriptor --
(#
   aPatternDiagramNode,anotherPatternDiagramNode: ^PatternDiagramNode;
   theListDiagram,theOtherListDiagram: ^ListDiagram;
   aDiagramNode: ^theOtherListDiagram.DiagramNode;
   t: ^Text;
   titleText: @text;
   anAST: ^AST;
   anExp: ^Expanded;
   theNames: ^betaGram.Names;
   theNameDcl: ^betaGram.NameDcl;
   theAttrDecl: ^betaGram.AttributeDecl
do
   (if switch[1] then 'StaticItemConnector onInit!'->putline if);
   0->Orient;
   true->getEnds->(node1[],node2[]);
   (if (node1## <= PatternDiagramNode##) and (node2## <= PatternDiagramNode##)
    then
       node1[]->aPatternDiagramNode[];
       aPatternDiagramNode.theDiagram->theListDiagram[];
       node2[]->anotherPatternDiagramNode[];
       (if (aPatternDiagramNode## <= theListDiagram.SimpleNode##) then
           aPatternDiagramNode.getASTNode->anExp[];
           '#'->t[];
           aPatternDiagramNode.SifEditorInstanceNo->t.putint;
           ' parse '->t.puttext;
           anExp.index->t.putint;
           ' '->puttext;
           anExp.getSon1->theNames[];
           theNames.getSon1->theNameDcl[];
           theNameDcl.getNameDecl->anAST[];
           (if anAST.kind = kinds.unExpanded then
               '<<NameDecl>>'->t.puttext
            else
               theNameDcl.getText->t.puttext
           if);
           ':@'->t.append;
           anotherPatternDiagramNode.thisDiagram->theOtherListDiagram[];
           (if theOtherListDiagram[] <> none then
               (if anotherPatternDiagramNode## <= theOtherListDiagram.title##
                then
                   anotherPatternDiagramNode.theText.get->titleText;
                   titleText[]->t.append
               if)
            else
               anotherPatternDiagramNode.theDiagram->theOtherListDiagram[];
               (if
               (anotherPatternDiagramNode## <=
                theOtherListDiagram.PatternNode##) or
               (anotherPatternDiagramNode## <=
                theOtherListDiagram.VirtualNode##) or
               (anotherPatternDiagramNode## <=
                theOtherListDiagram.BindingNode##) or
               (anotherPatternDiagramNode## <= theOtherListDiagram.FinalNode##)
                then
                   anotherPatternDiagramNode[]->aDiagramNode[];
                   aDiagramNode.theDeclaration->theAttrDecl[];
                   theAttrDecl.getSon1->theNames[];
                   theNames.getSon1->theNameDcl[];
                   theNameDcl.getNameDecl->anAST[];
                   aDiagramNode.theDeclaration->theAttrDecl[];
                   (if anAST.kind = kinds.unExpanded then
                       '<<NameAppl>>'->t.puttext
                    else
                       theNameDcl.getText->t.puttext
                   if)
                else
                   'The destination is not a pattern, virtual, binding or final declaration!'
                     ->DSUIUserAckMessage
               if)
           if);
           t[]->theController.sendSifCommand
        else
           'The source is not a simple declaration!'->DSUIUserAckMessage
       if)
    else
       'Source or destination is not part of a pattern diagram!'
         ->DSUIUserAckMessage
   if);
   Delete
#)  

-- StaticComponentConnectorOnInit: Descriptor --
(#
   aPatternDiagramNode,anotherPatternDiagramNode: ^PatternDiagramNode;
   theListDiagram,theOtherListDiagram: ^ListDiagram;
   aDiagramNode: ^theOtherListDiagram.DiagramNode;
   t: ^Text;
   titleText: @text;
   anAST: ^AST;
   anExp: ^Expanded;
   theNames: ^betaGram.Names;
   theNameDcl: ^betaGram.NameDcl;
   theAttrDecl: ^betaGram.AttributeDecl
do
   (if switch[1] then 'StaticComponentConnector onInit!'->putline if);
   0->Orient;
   true->getEnds->(node1[],node2[]);
   (if (node1## <= PatternDiagramNode##) and (node2## <= PatternDiagramNode##)
    then
       node1[]->aPatternDiagramNode[];
       aPatternDiagramNode.theDiagram->theListDiagram[];
       node2[]->anotherPatternDiagramNode[];
       (if (aPatternDiagramNode## <= theListDiagram.SimpleNode##) then
           aPatternDiagramNode.getASTNode->anExp[];
           '#'->t[];
           aPatternDiagramNode.SifEditorInstanceNo->t.putint;
           ' parse '->t.puttext;
           anExp.index->t.putint;
           ' '->puttext;
           anExp.getSon1->theNames[];
           theNames.getSon1->theNameDcl[];
           theNameDcl.getNameDecl->anAST[];
           (if anAST.kind = kinds.unExpanded then
               '<<NameDecl>>'->t.puttext
            else
               theNameDcl.getText->t.puttext
           if);
           ':@|'->t.append;
           anotherPatternDiagramNode.thisDiagram->theOtherListDiagram[];
           (if theOtherListDiagram[] <> none then
               (if anotherPatternDiagramNode## <= theOtherListDiagram.title##
                then
                   anotherPatternDiagramNode.theText.get->titleText;
                   titleText[]->t.append
               if)
            else
               anotherPatternDiagramNode.theDiagram->theOtherListDiagram[];
               (if
               (anotherPatternDiagramNode## <=
                theOtherListDiagram.PatternNode##) or
               (anotherPatternDiagramNode## <=
                theOtherListDiagram.VirtualNode##) or
               (anotherPatternDiagramNode## <=
                theOtherListDiagram.BindingNode##) or
               (anotherPatternDiagramNode## <= theOtherListDiagram.FinalNode##)
                then
                   anotherPatternDiagramNode[]->aDiagramNode[];
                   aDiagramNode.theDeclaration->theAttrDecl[];
                   theAttrDecl.getSon1->theNames[];
                   theNames.getSon1->theNameDcl[];
                   theNameDcl.getNameDecl->anAST[];
                   aDiagramNode.theDeclaration->theAttrDecl[];
                   (if anAST.kind = kinds.unExpanded then
                       '<<NameAppl>>'->t.puttext
                    else
                       theNameDcl.getText->t.puttext
                   if)
                else
                   'The destination is not a pattern, virtual, binding or final declaration!'
                     ->DSUIUserAckMessage
               if)
           if);
           t[]->theController.sendSifCommand
        else
           'The source is not a simple declaration!'->DSUIUserAckMessage
       if)
    else
       'Source or destination is not part of a pattern diagram!'
         ->DSUIUserAckMessage
   if);
   Delete
#)  

-- GeneralizationConnectorOnInit: Descriptor --
(#
   aPatternDiagramNode,anotherPatternDiagramNode: ^PatternDiagramNode;
   theListDiagram,theOtherListDiagram: ^ListDiagram;
   theOADDiagram,theOtherOADDiagram: ^OADDiagram;
   aDiagramNode: ^theOtherListDiagram.DiagramNode;
   t: ^Text;
   titleText: @text;
   theDesc,theOtherDesc: ^betaGram.ObjectDescriptor;
   anAST,anotherAST,testAST,testAST2,aDeclAST: ^AST;
   anExp: ^Expanded;
   theNames: ^betaGram.Names;
   theNameDcl: ^betaGram.NameDcl;
   theMainPart: ^betaGram.MainPart;
   existingConnectors: ^ObjectList;
   theCon,aCon: ^Connector
   (* do
    *    true->getEnds->(node1[],node2[]);
    *    delete;
    *    (if switch[1] then 'GeneralizationConnector onInit!'->putline if);
    *    (if (node1## <= PatternDiagramNode##) and (node2## <= PatternDiagramNode##)
    *     then
    *        node1[]->aPatternDiagramNode[];
    *        aPatternDiagramNode.theDiagram->theListDiagram[];
    *        node2[]->anotherPatternDiagramNode[];
    *        anotherPatternDiagramNode.theDiagram->theOtherListDiagram[];
    *        (if (theListDiagram## <= FragmentDiagram##) or
    *        (theOtherListDiagram## <= FragmentDiagram##) then
    *            'Source and/or destination is a fragment diagram!'
    *              ->DSUIUserAckMessage
    *         else
    *            (if (theListDiagram## <= PatternAttDiagram##) or
    *            (theOtherListDiagram## <= PatternAttDiagram##) then
    *                'Source and/or destination is an attributes form diagram!'
    *                  ->DSUIUserAckMessage
    *             else
    *                theListDiagram[]->theOADDiagram[];
    *                theOtherListDiagram[]->theOtherOADDiagram[];
    *                theOADDiagram.theDescriptor->theDesc[];
    *                theOtherOADDiagram.theDescriptor->theOtherDesc[];
    *                theDesc.father->anAST[];
    *                theOtherDesc.father->anotherAST[];
    *                anAST.father->testAST[];
    *                anotherAST.father->testAST2[];
    *                (if (testAST[] <> none ) and (testAST2[] <> none ) then
    *                    (if theListDiagram[] <> theOtherListDiagram[] then
    *                        '#'->t[];
    *                        anotherPatternDiagramNode.SifEditorInstanceNo->t.putint;
    *                        ' parse '->t.puttext;
    *                        theOtherDesc.getPrefixOpt->anotherAST[];
    *                        anotherAST.index->t.putint;
    *                        ' '->t.puttext;
    *                        anAST[]->anExp[];
    *                        anExp.getSon1->theNames[];
    *                        theNames.getSon1->theNameDcl[];
    *                        theNameDcl.getNameDecl->aDeclAST[];
    *                        (if aDeclAST.kind = kinds.unExpanded then
    *                            '<<NameAppl>>'->t.puttext
    *                         else
    *                            theNameDcl.getText->t.puttext
    *                        if);
    *                        t[]->theController.sendSifCommand;
    *                        (theListDiagram.LocalNodes.Last).elm[]->node1[];
    *                        &theOtherListDiagram.PrefixConnector[]->theCon[];
    *                        (node1[],theOtherListDiagram.titleNode[])->theCon.new;
    *                        theListDiagram.titleNode[]
    *                          ->theOtherListDiagram.titleNode.CreateRegion;
    *                        theCon[]->theOtherListDiagram.titleNode.thePrefixConn
    *                     else
    *                        'Source and destination is the same diagram!'
    *                          ->DSUIUserAckMessage
    *                    if)
    *                 else
    *                    'Source and/or destination is a descriptor form diagram!'
    *                      ->DSUIUserAckMessage
    *                if)
    *            if)
    *        if)
    *     else
    *        'Source or destination is not part of a pattern diagram!'
    *          ->DSUIUserAckMessage
    *    if);
    *    (if theCon[] <> none {*A connector was created*} then
    *        theOtherListDiagram.titleNode.getconnectors->existingConnectors[];
    *        (if existingConnectors[] <> none then
    *            existingConnectors.scan
    *              (#
    *              do
    *                 (if (current[] <> theCon[]) and (current## <= PrefixConnector##)
    *                  then
    *                     current[]->aCon[];
    *                     true->aCon.getEnds->(node1[],node2[]);
    *                     (if (node1[] = theOtherListDiagram.titleNode[]) or
    *                     (node2[] = theOtherListDiagram.titleNode[]) then
    *                         (if switch[1] then
    *                             'Deleting InheritanceConnector: '->puttext;
    *                             acon.ID->putint;
    *                             newline
    *                         if);
    *                         aCon.delete
    *                     if)
    *                 if)
    *              #)
    *        if)
    *    if)
    *)
#)  

-- SpecializationConnectorOnInit: Descriptor --
(#
   aPatternDiagramNode,anotherPatternDiagramNode: ^PatternDiagramNode;
   theListDiagram,theOtherListDiagram: ^ListDiagram;
   theOADDiagram,theOtherOADDiagram: ^OADDiagram;
   theOtherPatternDeclDiagram: ^PatternDeclDiagram;
   aDiagramNode: ^theOtherListDiagram.DiagramNode;
   t: ^Text;
   titleText: @text;
   theDesc,theOtherDesc: ^betaGram.ObjectDescriptor;
   anAST,anotherAST,testAST,testAST2,aDeclAST: ^AST;
   anExp: ^Expanded;
   theNames: ^betaGram.Names;
   theNameDcl: ^betaGram.NameDcl;
   theMainPart: ^betaGram.MainPart;
   existingConnectors: ^ObjectList;
   aCon: ^Connector;
   theCon: ^theOtherListDiagram.PrefixConnector
do
   (if switch[1] then 'SpecializationConnector onInit!'->putline if);
   true->getEnds->(node2[],node1[]);
   delete;
   (if (node1## <= PatternDiagramNode##) and (node2## <= PatternDiagramNode##)
    then
       node1[]->aPatternDiagramNode[];
       aPatternDiagramNode.theDiagram->theListDiagram[];
       node2[]->anotherPatternDiagramNode[];
       anotherPatternDiagramNode.theDiagram->theOtherListDiagram[];
       (if (theListDiagram## <= FragmentDiagram##) or
       (theOtherListDiagram## <= FragmentDiagram##) then
           'Source and/or destination is a fragment diagram!'
             ->DSUIUserAckMessage
        else
           (if (theListDiagram## <= PatternAttDiagram##) or
           (theOtherListDiagram## <= PatternAttDiagram##) then
               'Source and/or destination is an attributes form diagram!'
                 ->DSUIUserAckMessage
            else
               theListDiagram[]->theOADDiagram[];
               theOtherListDiagram[]->theOtherOADDiagram[];
               theOADDiagram.theDescriptor->theDesc[];
               theOtherOADDiagram.theDescriptor->theOtherDesc[];
               theDesc.father->anAST[];
               theOtherDesc.father->anotherAST[];
               anAST.father->testAST[];
               anotherAST.father->testAST2[];
               (if (testAST[] <> none ) and (testAST2[] <> none ) then
                   (if theListDiagram[] <> theOtherListDiagram[] then
                       '#'->t[];
                       anotherPatternDiagramNode.SifEditorInstanceNo->t.putint;
                       ' parse '->t.puttext;
                       theOtherDesc.getPrefixOpt->anotherAST[];
                       anotherAST.index->t.putint;
                       ' '->t.puttext;
                       anAST[]->anExp[];
                       anExp.getSon1->theNames[];
                       theNames.getSon1->theNameDcl[];
                       theNameDcl.getNameDecl->aDeclAST[];
                       (if aDeclAST.kind = kinds.unExpanded then
                           '<<NameAppl>>'->t.puttext
                        else
                           theNameDcl.getText->t.puttext
                       if);
                       t[]->theController.sendSifCommand;
                       (if theListDiagram.LocalNodes.Last <> none then
                           (theListDiagram.LocalNodes.Last).elm[]->node1[]
                        else
                           theListDiagram.titleNode[]->node1[]
                       if);
                       &theOtherListDiagram.PrefixConnector[]->theCon[];
                       (theOtherListDiagram.titleNode[],node1[])
                         ->theCon.PrefixNew;
                       theListDiagram.titleNode[]
                         ->theOtherListDiagram.titleNode.CreateRegion;
                       (if theOtherListDiagram.titleNode.thePrefixConn <> none
                        then
                           (theOtherListDiagram.titleNode.thePrefixConn).delete
                       if);
                       theCon[]->theOtherListDiagram.titleNode.thePrefixConn;
                       theOtherListDiagram[]->theOtherPatternDeclDiagram[];
                       theDesc[]->theOtherPatternDeclDiagram.thePrefix;
                       theOtherPatternDeclDiagram.theParentNode->aDiagramNode[];
                       theDesc[]->aDiagramNode.thePrefix;
                       (theOtherDesc.father,theDesc.father)
                         ->patternDiagrams.InheritanceList.insert
                    else
                       'Source and destination is the same diagram!'
                         ->DSUIUserAckMessage
                   if)
                else
                   'Source and/or destination is a descriptor form diagram!'
                     ->DSUIUserAckMessage
               if)
           if)
       if)
    else
       'Source or destination is not part of a pattern diagram!'
         ->DSUIUserAckMessage
   if)
#)  

-- OTOAssociationRelationOnInit: Descriptor --
(#
   node1,node2: ^DesignObject;
   aPatternDiagramNode,anotherPatternDiagramNode,theParentNode,lastNode:
     ^PatternDiagramNode;
   theListDiagram,theOtherListDiagram,theParentDiagram: ^ListDiagram;
   theAssocNode: ^AssociationNode;
   theNonTerminalNode: ^theParentDiagram.NonTerminalNode;
   theOADDiagram,theOtherOADDiagram: ^OADDiagram;
   theDesc,theOtherDesc: ^betaGram.ObjectDescriptor;
   anAST,anotherAST,testAST,testAST2,aDeclAST,anotherDeclAST,lastAST: ^AST;
   anExp,anotherExp: ^Expanded;
   theNames,theOtherNames: ^betaGram.Names;
   theNameDcl,theOtherNameDcl: ^betaGram.NameDcl;
   indextext: @Text;
   t,theName,theOtherName: ^Text
do
   (if switch[1] then 'SpecializationConnector onInit!'->putline if);
   true->getEnds->(node1[],node2[]);
   delete;
   (if (node1## <= PatternDiagramNode##) and (node2## <= PatternDiagramNode##)
    then
       node1[]->aPatternDiagramNode[];
       aPatternDiagramNode.theDiagram->theListDiagram[];
       node2[]->anotherPatternDiagramNode[];
       anotherPatternDiagramNode.theDiagram->theOtherListDiagram[];
       (if (theListDiagram## <= FragmentDiagram##) or
       (theOtherListDiagram## <= FragmentDiagram##) then
           'Source and/or destination is a fragment diagram!'
             ->DSUIUserAckMessage
        else
           (if (theListDiagram## <= PatternAttDiagram##) or
           (theOtherListDiagram## <= PatternAttDiagram##) then
               'Source and/or destination is an attributes form diagram!'
                 ->DSUIUserAckMessage
            else
               theListDiagram[]->theOADDiagram[];
               theOtherListDiagram[]->theOtherOADDiagram[];
               theOADDiagram.theDescriptor->theDesc[];
               theOtherOADDiagram.theDescriptor->theOtherDesc[];
               theDesc.father->anAST[];
               theOtherDesc.father->anotherAST[];
               anAST.father->testAST[];
               anotherAST.father->testAST2[];
               (if (testAST[] <> none ) and (testAST2[] <> none ) then
                   (if theListDiagram[] <> theOtherListDiagram[] then
                       '#'->t[];
                       theListDiagram.theParentNode->theParentNode[];
                       theParentNode.SifEditorInstanceNo->t.putint;
                       ' parseAfter '->t.puttext;
                       theParentNode.theDiagram->theParentDiagram[];
                       (theParentDiagram.localNodes.last).elm[]->lastNode[];
                       lastNode.getAstNode->lastAST[];
                       (if lastAST[] = none then
                           (if lastNode## <= theParentDiagram.NonterminalNode##
                            then
                               lastNode[]->theNonTerminalNode[];
                               theNonTerminalNode.unexp->lastAST[]
                            else
                               'No AST for last node??'->putline
                           if)
                       if);
                       (if lastAST[] <> none then
                           lastAST.index->t.putint;
                           ' '->t.puttext;
                           betaGram.PatternDecl->t.putint;
                           anAST[]->anExp[];
                           anExp.getSon1->theNames[];
                           theNames.getSon1->theNameDcl[];
                           theNameDcl.getNameDecl->aDeclAST[];
                           (if aDeclAST.kind = kinds.unExpanded then
                               'NoName'->theName[]
                            else
                               theNameDcl.getText->theName[]
                           if);
                           theName[]->t.puttext;
                           anotherAST[]->anotherExp[];
                           anotherExp.getSon1->theOtherNames[];
                           theOtherNames.getSon1->theOtherNameDcl[];
                           theOtherNameDcl.getNameDecl->anotherDeclAST[];
                           (if anotherDeclAST.kind = kinds.unExpanded then
                               'NoName'->theOtherName[]
                            else
                               theOtherNameDcl.getText->theOtherName[]
                           if);
                           theOtherName[]->t.puttext;
                           ':Association(# '->t.puttext;
                           theName[]->t.puttext;
                           'One:@One(# element::< '->t.puttext;
                           theName[]->t.puttext;
                           ' #); '->t.puttext;
                           theOtherName[]->t.puttext;
                           'One:@One(# element::< '->t.puttext;
                           theOtherName[]->t.puttext;
                           ' #) #)'->t.puttext;
                           &AssociationNode[]->theAssocNode[]
                             ->private.newAssociationNode[];
                           (one,theListDiagram[],one,theOtherListDiagram[])
                             ->theAssocNode.display;
                           (anAST[],one,anotherAST[],one)
                             ->patternDiagrams.AssociationList.insert;
                           t[]->theController.sendSifCommand
                        else
                           'lastAST i NONE??'->putline
                       if)
                    else
                       'Source and destination is the same diagram!'
                         ->DSUIUserAckMessage
                   if)
                else
                   'Source and/or destination is a descriptor form diagram!'
                     ->DSUIUserAckMessage
               if)
           if)
       if)
    else
       'Source or destination is not part of a pattern diagram!'
         ->DSUIUserAckMessage
   if)
#)  

-- OTMAssociationRelationOnInit: Descriptor --
(#
   node1,node2: ^DesignObject;
   aPatternDiagramNode,anotherPatternDiagramNode,theParentNode,lastNode:
     ^PatternDiagramNode;
   theListDiagram,theOtherListDiagram,theParentDiagram: ^ListDiagram;
   theAssocNode: ^AssociationNode;
   theNonTerminalNode: ^theParentDiagram.NonTerminalNode;
   theOADDiagram,theOtherOADDiagram: ^OADDiagram;
   theDesc,theOtherDesc: ^betaGram.ObjectDescriptor;
   anAST,anotherAST,testAST,testAST2,aDeclAST,anotherDeclAST,lastAST: ^AST;
   anExp,anotherExp: ^Expanded;
   theNames,theOtherNames: ^betaGram.Names;
   theNameDcl,theOtherNameDcl: ^betaGram.NameDcl;
   indextext: @Text;
   t,theName,theOtherName: ^Text
do
   (if switch[1] then 'SpecializationConnector onInit!'->putline if);
   true->getEnds->(node1[],node2[]);
   delete;
   (if (node1## <= PatternDiagramNode##) and (node2## <= PatternDiagramNode##)
    then
       node1[]->aPatternDiagramNode[];
       aPatternDiagramNode.theDiagram->theListDiagram[];
       node2[]->anotherPatternDiagramNode[];
       anotherPatternDiagramNode.theDiagram->theOtherListDiagram[];
       (if (theListDiagram## <= FragmentDiagram##) or
       (theOtherListDiagram## <= FragmentDiagram##) then
           'Source and/or destination is a fragment diagram!'
             ->DSUIUserAckMessage
        else
           (if (theListDiagram## <= PatternAttDiagram##) or
           (theOtherListDiagram## <= PatternAttDiagram##) then
               'Source and/or destination is an attributes form diagram!'
                 ->DSUIUserAckMessage
            else
               theListDiagram[]->theOADDiagram[];
               theOtherListDiagram[]->theOtherOADDiagram[];
               theOADDiagram.theDescriptor->theDesc[];
               theOtherOADDiagram.theDescriptor->theOtherDesc[];
               theDesc.father->anAST[];
               theOtherDesc.father->anotherAST[];
               anAST.father->testAST[];
               anotherAST.father->testAST2[];
               (if (testAST[] <> none ) and (testAST2[] <> none ) then
                   (if theListDiagram[] <> theOtherListDiagram[] then
                       '#'->t[];
                       theListDiagram.theParentNode->theParentNode[];
                       theParentNode.SifEditorInstanceNo->t.putint;
                       ' parseAfter '->t.puttext;
                       theParentNode.theDiagram->theParentDiagram[];
                       (theParentDiagram.localNodes.last).elm[]->lastNode[];
                       lastNode.getAstNode->lastAST[];
                       (if lastAST[] = none then
                           (if lastNode## <= theParentDiagram.NonterminalNode##
                            then
                               lastNode[]->theNonTerminalNode[];
                               theNonTerminalNode.unexp->lastAST[]
                            else
                               'No AST for last node??'->putline
                           if)
                       if);
                       (if lastAST[] <> none then
                           lastAST.index->t.putint;
                           ' '->t.puttext;
                           betaGram.PatternDecl->t.putint;
                           anAST[]->anExp[];
                           anExp.getSon1->theNames[];
                           theNames.getSon1->theNameDcl[];
                           theNameDcl.getNameDecl->aDeclAST[];
                           (if aDeclAST.kind = kinds.unExpanded then
                               'NoName'->theName[]
                            else
                               theNameDcl.getText->theName[]
                           if);
                           theName[]->t.puttext;
                           anotherAST[]->anotherExp[];
                           anotherExp.getSon1->theOtherNames[];
                           theOtherNames.getSon1->theOtherNameDcl[];
                           theOtherNameDcl.getNameDecl->anotherDeclAST[];
                           (if anotherDeclAST.kind = kinds.unExpanded then
                               'NoName'->theOtherName[]
                            else
                               theOtherNameDcl.getText->theOtherName[]
                           if);
                           theOtherName[]->t.puttext;
                           ':Association(# '->t.puttext;
                           theName[]->t.puttext;
                           'One:@One(# element::< '->t.puttext;
                           theName[]->t.puttext;
                           ' #); '->t.puttext;
                           theOtherName[]->t.puttext;
                           'Many:@Many(# element::< '->t.puttext;
                           theOtherName[]->t.puttext;
                           ' #) #)'->t.puttext;
                           &AssociationNode[]->theAssocNode[]
                             ->private.newAssociationNode[];
                           (one,theListDiagram[],many,theOtherListDiagram[])
                             ->theAssocNode.display;
                           (anAST[],one,anotherAST[],many)
                             ->patternDiagrams.AssociationList.insert;
                           t[]->theController.sendSifCommand
                        else
                           'lastAST i NONE??'->putline
                       if)
                    else
                       'Source and destination is the same diagram!'
                         ->DSUIUserAckMessage
                   if)
                else
                   'Source and/or destination is a descriptor form diagram!'
                     ->DSUIUserAckMessage
               if)
           if)
       if)
    else
       'Source or destination is not part of a pattern diagram!'
         ->DSUIUserAckMessage
   if)
#)  

-- MTMAssociationRelationOnInit: Descriptor --
(#
   node1,node2: ^DesignObject;
   aPatternDiagramNode,anotherPatternDiagramNode,theParentNode,lastNode:
     ^PatternDiagramNode;
   theListDiagram,theOtherListDiagram,theParentDiagram: ^ListDiagram;
   theAssocNode: ^AssociationNode;
   theNonTerminalNode: ^theParentDiagram.NonTerminalNode;
   theOADDiagram,theOtherOADDiagram: ^OADDiagram;
   theDesc,theOtherDesc: ^betaGram.ObjectDescriptor;
   anAST,anotherAST,testAST,testAST2,aDeclAST,anotherDeclAST,lastAST: ^AST;
   anExp,anotherExp: ^Expanded;
   theNames,theOtherNames: ^betaGram.Names;
   theNameDcl,theOtherNameDcl: ^betaGram.NameDcl;
   indextext: @Text;
   t,theName,theOtherName: ^Text
do
   (if switch[1] then 'SpecializationConnector onInit!'->putline if);
   true->getEnds->(node1[],node2[]);
   delete;
   (if (node1## <= PatternDiagramNode##) and (node2## <= PatternDiagramNode##)
    then
       node1[]->aPatternDiagramNode[];
       aPatternDiagramNode.theDiagram->theListDiagram[];
       node2[]->anotherPatternDiagramNode[];
       anotherPatternDiagramNode.theDiagram->theOtherListDiagram[];
       (if (theListDiagram## <= FragmentDiagram##) or
       (theOtherListDiagram## <= FragmentDiagram##) then
           'Source and/or destination is a fragment diagram!'
             ->DSUIUserAckMessage
        else
           (if (theListDiagram## <= PatternAttDiagram##) or
           (theOtherListDiagram## <= PatternAttDiagram##) then
               'Source and/or destination is an attributes form diagram!'
                 ->DSUIUserAckMessage
            else
               theListDiagram[]->theOADDiagram[];
               theOtherListDiagram[]->theOtherOADDiagram[];
               theOADDiagram.theDescriptor->theDesc[];
               theOtherOADDiagram.theDescriptor->theOtherDesc[];
               theDesc.father->anAST[];
               theOtherDesc.father->anotherAST[];
               anAST.father->testAST[];
               anotherAST.father->testAST2[];
               (if (testAST[] <> none ) and (testAST2[] <> none ) then
                   (if theListDiagram[] <> theOtherListDiagram[] then
                       '#'->t[];
                       theListDiagram.theParentNode->theParentNode[];
                       theParentNode.SifEditorInstanceNo->t.putint;
                       ' parseAfter '->t.puttext;
                       theParentNode.theDiagram->theParentDiagram[];
                       (theParentDiagram.localNodes.last).elm[]->lastNode[];
                       lastNode.getAstNode->lastAST[];
                       (if lastAST[] = none then
                           (if lastNode## <= theParentDiagram.NonterminalNode##
                            then
                               lastNode[]->theNonTerminalNode[];
                               theNonTerminalNode.unexp->lastAST[]
                            else
                               'No AST for last node??'->putline
                           if)
                       if);
                       (if lastAST[] <> none then
                           lastAST.index->t.putint;
                           ' '->t.puttext;
                           betaGram.PatternDecl->t.putint;
                           anAST[]->anExp[];
                           anExp.getSon1->theNames[];
                           theNames.getSon1->theNameDcl[];
                           theNameDcl.getNameDecl->aDeclAST[];
                           (if aDeclAST.kind = kinds.unExpanded then
                               'NoName'->theName[]
                            else
                               theNameDcl.getText->theName[]
                           if);
                           theName[]->t.puttext;
                           anotherAST[]->anotherExp[];
                           anotherExp.getSon1->theOtherNames[];
                           theOtherNames.getSon1->theOtherNameDcl[];
                           theOtherNameDcl.getNameDecl->anotherDeclAST[];
                           (if anotherDeclAST.kind = kinds.unExpanded then
                               'NoName'->theOtherName[]
                            else
                               theOtherNameDcl.getText->theOtherName[]
                           if);
                           theOtherName[]->t.puttext;
                           ':Association(# '->t.puttext;
                           theName[]->t.puttext;
                           'Many:@Many(# element::< '->t.puttext;
                           theName[]->t.puttext;
                           ' #); '->t.puttext;
                           theOtherName[]->t.puttext;
                           'Many:@Many(# element::< '->t.puttext;
                           theOtherName[]->t.puttext;
                           ' #) #)'->t.puttext;
                           &AssociationNode[]->theAssocNode[]
                             ->private.newAssociationNode[];
                           (many,theListDiagram[],many,theOtherListDiagram[])
                             ->theAssocNode.display;
                           (anAST[],many,anotherAST[],many)
                             ->patternDiagrams.AssociationList.insert;
                           t[]->theController.sendSifCommand
                        else
                           'lastAST i NONE??'->putline
                       if)
                    else
                       'Source and destination is the same diagram!'
                         ->DSUIUserAckMessage
                   if)
                else
                   'Source and/or destination is a descriptor form diagram!'
                     ->DSUIUserAckMessage
               if)
           if)
       if)
    else
       'Source or destination is not part of a pattern diagram!'
         ->DSUIUserAckMessage
   if)
#)  

-- concludeOngoingOperation: Descriptor --
(#
   thePage: ^OADPage;
   theObject: ^DesignObject;
   theNode: ^thePage.PatternDiagramNode;
   thePatternNode: ^theListDiagram.PatternNode;
   theVirtualNode: ^theListDiagram.VirtualNode;
   theDiagram: ^thePage.Diagram;
   theListDiagram: ^thePage.ListDiagram;
   theDecl: ^betaGram.AttributeDecl;
   anAST: ^AST;
   t: ^text
do
   currentPage->thePage[];
   thePage.CurrentObject->theObject[];
   (if theObject[] <> none then
       (if theObject## <= thePage.PatternDiagramNode## then
           theObject[]->theNode[];
           (if true
            // private.performingInsertAfter then
               false->private.performingInsertAfter;
               (if thePage.canListInsert
                // true then
                   '#'->t[];
                   theNode.SifEditorInstanceNo->t.putint;
                   ' after'->t.puttext;
                   t[]->theController.sendSifCommand;
                   
               if)
            // private.performingInsertBefore then
               false->private.performingInsertBefore;
               (if thePage.canListInsert
                // true then
                   '#'->t[];
                   theNode.SifEditorInstanceNo->t.putint;
                   ' before'->t.puttext;
                   t[]->theController.sendSifCommand;
                   
               if)
            // private.performingCut then
               false->private.performingCut;
               theNode.theDiagram->theDiagram[];
               (if theNode## <= theDiagram.title## then
                   'it is a titleNode!'->putline;
                   'Cutting detailed diagrams not implemented yet!'
                     ->DSUIUserAckMessage
                else
                   '#'->t[];
                   theNode.SifEditorInstanceNo->t.putint;
                   ' cut'->t.puttext;
                   t[]->theController.sendSifCommand
               if)
            // private.performingCopy then
               false->private.performingCopy;
               theNode.theDiagram->theDiagram[];
               (if theNode## <= theDiagram.title## then
                   'Copying detailed diagrams not implemented yet!'
                     ->DSUIUserAckMessage
                else
                   '#'->t[];
                   theNode.SifEditorInstanceNo->t.putint;
                   ' copy'->t.puttext;
                   t[]->theController.sendSifCommand
               if)
            // private.performingPaste then
               false->private.performingPaste;
               theNode.theDiagram->theDiagram[];
               (if theNode## <= theDiagram.title## then
                   'Copying detailed diagrams not implemented yet!'
                     ->DSUIUserAckMessage
                else
                   '#'->t[];
                   theNode.SifEditorInstanceNo->t.putint;
                   ' paste'->t.puttext;
                   t[]->theController.sendSifCommand
               if)
            // private.performingExpand then
               false->private.performingExpand;
               '#'->t[];
               theNode.SifEditorInstanceNo->t.putint;
               (if private.ExpandNormal then
                   ' expandNormal '->t.append
                else
                   ' expandOptional '->t.append
               if);
               private.ExpandsynCatNo->t.putint;
               t[]->theController.sendSifCommand
            // private.performingNewPatternExpAfter then
               false->private.performingNewPatternExpAfter;
               (if thePage.canListInsert
                // true then
                   '#'->t[];
                   theNode.SifEditorInstanceNo->t.putint;
                   ' expandAfter '->t.puttext;
                   betaGram.PatternDecl->t.putint;
                   t[]->theController.sendSifCommand;
                   
               if)
            // private.performingNewPatternDetail then
               false->private.performingNewPatternDetail;
               theNode.theDiagram->theListDiagram[];
               (if theNode## <= theListDiagram.PatternNode## then
                   theNode[]->thePatternNode[];
                   (if thePatternNode.hasAttributes then
                       thePatternNode.detail
                   if)
               if)
            // private.performingPartObjectExpAfter then
               false->private.performingPartObjectExpAfter;
               true->private.performingPartObjectStaticItemExp;
               '#'->t[];
               currentFocus.SifEditorInstanceNo->t.putint;
               ' expandAfter '->t.puttext;
               betaGram.SimpleDecl->t.putint;
               t[]->theController.sendSifCommand
            // private.performingPartObjectStaticItemExp then
               false->private.performingPartObjectStaticItemExp;
               '#'->t[];
               currentFocus.SifEditorInstanceNo->t.putint;
               ' expandNormal '->t.puttext;
               betaGram.StaticItem->t.putint;
               t[]->theController.sendSifCommand
            // private.performingDynamicReferenceExpAfter then
               false->private.performingDynamicReferenceExpAfter;
               true->private.performingDynamicReferenceDynamicItemExp;
               '#'->t[];
               currentFocus.SifEditorInstanceNo->t.putint;
               ' expandAfter '->t.puttext;
               betaGram.SimpleDecl->t.putint;
               t[]->theController.sendSifCommand
            // private.performingDynamicReferenceDynamicItemExp then
               false->private.performingDynamicReferenceDynamicItemExp;
               '#'->t[];
               currentFocus.SifEditorInstanceNo->t.putint;
               ' expandNormal '->t.puttext;
               betaGram.DynamicItem->t.putint;
               t[]->theController.sendSifCommand
            // private.performingVirtualPatternExpAfter then
               false->private.performingVirtualPatternExpAfter;
               (if thePage.canListInsert
                // true then
                   true->private.performingVirtualPatternObjectDescExp;
                   '#'->t[];
                   theNode.SifEditorInstanceNo->t.putint;
                   ' expandAfter '->t.puttext;
                   betaGram.VirtualDecl->t.putint;
                   t[]->theController.sendSifCommand;
                   
               if)
            // private.performingVirtualPatternObjectDescExp then
               false->private.performingVirtualPatternObjectDescExp;
               theNode.theDiagram->theListDiagram[];
               (if theNode## <= theListDiagram.VirtualNode## then
                   theNode[]->theVirtualNode[];
                   theVirtualNode.theDeclaration->theDecl[];
                   theDecl.getSon2->anAST[];
                   (if anAST.kind = kinds.unExpanded then  if)
               if)
           if)
       if)
   if)
#)  

-- concludeExpansion: Descriptor --
(#
   anAST: ^AST;
   theListDiagram: ^ListDiagram;
   theSimpleNode: ^theListDiagram.SimpleNode;
   t: ^Text;
   theNodeText: @Text
do
   (if true
    // private.constructingStaticItem then
       (if currentFocus[] <> none then
           (if currentFocus.theDiagram <> none then
               currentFocus.theDiagram->theListDiagram[];
               (if currentFocus## <= theListDiagram.SimpleNode## then
                   currentFocus[]->theSimpleNode[];
                   (theSimpleNode.theDeclaration).getSon2->anAST[];
                   (if currentFocus.SifEditorInstanceNo <> 0 then
                       false->private.constructingStaticItem;
                       (currentFocus.SifEditorInstanceNo,anAST.index)
                         ->changeASTFocus;
                       '# '->t[];
                       currentFocus.SifEditorInstanceNo->t.putint;
                       ' expandNormal '->t.append;
                       betaGram.StaticItem->t.putint;
                       t[]->theController.sendSifCommand;
                       
                   if)
               if)
           if)
       if)
    // private.constructingDynamicItem then
       (if currentFocus[] <> none then
           (if currentFocus.theDiagram <> none then
               currentFocus.theDiagram->theListDiagram[];
               (if currentFocus## <= theListDiagram.SimpleNode## then
                   currentFocus[]->theSimpleNode[];
                   (theSimpleNode.theDeclaration).getSon2->anAST[];
                   (if currentFocus.SifEditorInstanceNo <> 0 then
                       false->private.constructingDynamicItem;
                       (currentFocus.SifEditorInstanceNo,anAST.index)
                         ->changeASTFocus;
                       '# '->t[];
                       currentFocus.SifEditorInstanceNo->t.putint;
                       ' expandNormal '->t.append;
                       betaGram.DynamicItem->t.putint;
                       t[]->theController.sendSifCommand;
                       
                   if)
               if)
           if)
       if)
    else
       (currentFocus[],currentFocus[])->changedFocus
   if)
#)  

-- FrejaOADPagePrivate: Descriptor --
(#
   constructingStaticItem: @Boolean;
   constructingDynamicItem: @Boolean;
   performingInsertAfter: @Boolean;
   performingInsertBefore: @Boolean;
   performingCut: @Boolean;
   performingCopy: @Boolean;
   performingPaste: @Boolean;
   performingExpand: @Boolean;
   ExpandNormal: @Boolean;
   ExpandSynCatNo: @Integer;
   performingNewPatternExpAfter: @Boolean;
   performingNewPatternDetail: @Boolean;
   performingPartObjectExpAfter: @Boolean;
   performingPartObjectStaticItemExp: @Boolean;
   performingDynamicReferenceExpAfter: @Boolean;
   performingDynamicReferenceDynamicItemExp: @Boolean;
   performingVirtualPatternExpAfter: @Boolean;
   performingVirtualPatternObjectDescExp: @Boolean;
   newAssociationNode: ^AssociationNode;
   
#)  

-- FrejaOADDocumentOnInit: Descriptor --
(# 
do
(* DocCreateMenu.init;
 *                   DocMakeupMenu.init;
 *                   DocPageMenu.init;
 *                   DocGroupMenu.init;
 *) (if not isBigEndian then DocTextMenu.init if);
   (UserMenu3,'File')->theFileMenu.init;
   (UserMenu2,'Edit')->FrejaEditMenu.init;
   DocAlignMenu.init;
   DocMakeUpMenu.init;
   DocCreateMenu.init;
   (UserMenu8,'Expand')->theExpandMenu.Init;
   (UserMenu6,'Relations')->RelationsMenu.init;
   (UserMenu9,'Templates')->AttributeKindMenu.init;
   MenuID.CreateMenu->RelationsMenu.insertBefore;
   UserMenu6->theExpandMenu.insertBefore;
   UserMenu8->AttributeKindMenu.insertBefore;
   UserMenu9->FrejaEditMenu.insertBefore;
   UserMenu2->theFileMenu.insertBefore;
   (*  (UserMenu2,'Sif')->EditorMenu.init; *)
   (*  (UserMenu5,'Create') -> ObjectCreateMenu.init;*)
   
#)  

-- FrejaConnEndsGrammar: Descriptor --
(#
   thePage: ^theDocument.Page;
   theOADPage: ^theOADDocument.OADPage;
   theObject,theNode: ^thePage.DesignObject;
   delCon: ^theOADPage.DeletableConnector
do
   (if callbackVerbose then
       'callback ConnEndsGrammar'->putline;
       'conn: '->puttext;
       conn->putint;
       newline;
       'whichEnd: '->puttext;
       whichEnd->putint;
       newline;
       'nodeID: '->puttext;
       nodeID->putint;
       newline;
       'primNode: '->puttext;
       primNode->putint;
       newline
   if);
   theDocument.currentPage->thePage[];
   conn->theDocument.theObjectList.find->theObject[];
   (if theObject[] <> none then
       theDocument[]->theOADDocument[];
       (if thePage## <= theOADDocument.OADpage## then
           thePage[]->theOADPage[];
           (if theObject## <= theOADPage.deletableConnector## then
               NodeID->theDocument.theObjectList.find->theNode[];
               (if theNode[] <> none then
                   theObject[]->delCon[];
                   (theNode[],WhichEnd)->delCon.onReattach->ok
                else
                   'Cannot find new connector end '->puttext;
                   nodeID->putint;
                   newline
               if)
            else
               (if switch[1] then
                   'callback ConnEndsGrammar: it is not a deletableConnector'
                     ->putline
               if)
           if)
       if)
    else
       'Cannot find reattached connector '->puttext; conn->putint; newline
   if)
#)  

-- FrejaKbdEvent: Descriptor --
(# L: [1] @integer; aPtr: @externalRecord
do (*'KbdEvent, frejaLocked is: '->putText;
    Frejalocked->putInt;
    newLine;*)
   (if FrejaLocked = 0 then
       (if callbackVerbose then 'Callback KbdEvent'->putLine if);
       (1,keyNrP)->getIntList->L;
       theDocument[]->theOADDocument[];
       (if kbdstateP.controlKey = 1 then
           (if L[1]
            // 32 then
               theOADDocument.FrejaEditMenu.iTextEdit.hit
            // 117 then
               theOADDocument.FrejaEditMenu.iUndo.hit
            // 107 then
               theOADDocument.FrejaEditMenu.iCut.hit
            // 99 then
               theOADDocument.FrejaEditMenu.iCopy.hit
            // 121 then
               theOADDocument.FrejaEditMenu.iPaste.hit
            // 100 then
               theOADDocument.FrejaEditMenu.iClear.hit
            // 97 then
               theOADDocument.FrejaEditMenu.insertAfter.hit
            // 98 then
               theOADDocument.FrejaEditMenu.insertBeforeItem.hit
           if)
       if);
       (if theOADDocument.FrejaEditMenu.TextModeOn then
           (if kbdstateP.controlKey = 1 then
               (if L[1]
                // 114 then theOADDocument.FrejaEditMenu.iRevertTextEdit.hit
               if)
           if)
       if);
       
    else
       ascii.bel->screen.put
   if)
#)  

-- FrejaMouseDown: Descriptor --
(#  do (if (FrejaLocked > 0)->locked then  if) #)  

-- FrejaDoubleClick: Descriptor --
(# 
do
   (if (FrejaLocked > 0)->locked then
   (* nothing,  it is allowed if
    it is the "second" click in a double-click, see in designEnv *)
       
   if)
#)  

