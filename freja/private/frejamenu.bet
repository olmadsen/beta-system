ORIGIN '../freja';
INCLUDE 'frejabody'
        '~toby/beta/designenv/v2.2/private/designobjectbody';
-- FrejaFileMenuNewBETAProgram: Descriptor --
(# (*t: @text*) theOADDocument: ^OADDocument
do
   (if switch[1] then 'Freja: Create a new fragment'->putline if);
   none ->theController.globalSifCommands.newBETAProgram;
   (if (theDocument[] <> none ) and (currentDiagramName[] = none ) then
       theDocument[]->theOADDocument[];
       theOADDocument.theGroupPage.patternDiagrams.theList.scanFragmentDiagrams
         (#  do ((thisDiagram.theGroup).name).copy->currentDiagramName[] #);
       (if currentDiagramName[] <> none then
           '.diag'->currentDiagramName.append
        else
           'New BETA Program: Group has no name?!'->putline
       if)
   if);
   (*  (if theDocument[]
    // none then
    &OADDocument[]->theDocument[]->theOADDocument[];
    theDocument.new;
    theOADDocument.CurrentPage->theOADDocument.theWorkPage[];
    'WorkSheet'->theOADDocument.theWorkPage.PageTitle;
    &theOADDocument.OADPage[]->theOADDocument.theGroupPage[];
    theOADDocument.theGroupPage.InvisibleNew;
    theOADDocument.theWorkPage[]->theOADDocument.CurrentPage;
    'Group Window'->theOADDocument.theGroupPage.PageTitle;
    
    if);
    ('Enter file name:','')
    ->FrejaPromptForText
    (#
    confirm::< 
    (# 
    do
    theText->t;
    t[]->theController.globalSifCommands.newBETAProgram;
    (if currentDiagramName[] = none then
    theText[]->currentDiagramName[];
    '.diag'->currentDiagramName.append
    if)
    #)
    #)*)
   
#)  

-- FrejaFileMenuNewBETALibrary: Descriptor --
(# (*t: @text;*) theOADDocument: ^OADDocument
do
   (if switch[1] then 'Freja: Create a new fragment'->putline if);
   none ->theController.globalSifCommands.newBETALibrary;
   (if (theDocument[] <> none ) and (currentDiagramName[] = none ) then
       theDocument[]->theOADDocument[];
       theOADDocument.theGroupPage.patternDiagrams.theList.scanFragmentDiagrams
         (#  do ((thisDiagram.theGroup).name).copy->currentDiagramName[] #);
       (if currentDiagramName[] <> none then
           '.diag'->currentDiagramName.append
        else
           'New BETA Library: Group has no name?!'->putline
       if)
   if);
   (*  (if theDocument[]
    // none then
    &OADDocument[]->theDocument[]->theOADDocument[];
    theDocument.new;
    theOADDocument.CurrentPage->theOADDocument.theWorkPage[];
    'WorkSheet'->theOADDocument.theWorkPage.PageTitle;
    &theOADDocument.OADPage[]->theOADDocument.theGroupPage[];
    theOADDocument.theGroupPage.InvisibleNew;
    theOADDocument.theWorkPage[]->theOADDocument.CurrentPage;
    'Group Window'->theOADDocument.theGroupPage.PageTitle;
    
    if);
    ('Enter file name:','')
    ->FrejaPromptForText
    (#
    confirm::<
    (# 
    do
    theText->t;
    t[]->theController.globalSifCommands.newBETALibrary;
    (if currentDiagramName[] = none then
    theText[]->currentDiagramName[];
    '.diag'->currentDiagramName.append
    if)
    #)
    #)*)
   
#)  

-- frejaHideShowSifItem: DoPart --
do
   (if sifHidden then
       false->sifHidden; theFragmentBrowser.ymerBrowser.show; 'Hide Sif'->rename
    else
       true->sifHidden; theFragmentBrowser.ymerBrowser.hide; 'Show Sif'->rename
   if)  

-- FrejaFileMenuQuit: Descriptor --
(#
   ok: @Boolean;
   frejaFile,autosaveFrejaFile,diagFile,autosaveDiagFile: @file;
   groupFile,autosaveGroupFile: @file;
   groupName,frejaFileName,autoSaveFrejaFileName,help: ^text;
   doNotSave,askSave: @boolean
do
   doSave:
   (if currentDiagramName[] <> none then
       currentDiagramName[]->diagFile.name;
       '#'->(currentDiagramName.copy).append->autosaveDiagFile.name;
       (if switch[17] then
           'Freja FrejaFileMenuQuit:'->putLine;
           diagFile.name->putLine;
           autosaveDiagFile.name->putLine;
           
       if);
       (if autosaveDiagFile.entry.exists then
           (if DSStrGetDiagModified then
               true->askSave
            else
               (if diagFile.entry.exists then
                   (if autosaveDiagFile.entry.modtime > diagFile.entry.modtime
                    then (* the diagram has been modified *)
                       true->askSave
                    else
                       true->doNotSave
                   if)
                else
                   true->askSave
               if)
           if);
           (if askSave then
               (none ,'Quit','Save Current Diagram?')
                 ->theFragmentBrowser.promptForBoolean
                   (#
                      ok::<  (#  do true->doQuit; Save.hit #);
                      notOK::<  (#  do true->doNotSave #);
                      
                   #)
            else
               true->doNotSave
           if)
        else
           true->doNotSave
       if);
       (if doNotSave then
           currentDiagramName.copy->groupName[];
           groupName->removeExtension->groupName;
           '.freja'->(groupName.copy).append->frejaFileName[]->frejaFile.name;
           '.freja#'->(groupName.copy).append->autosaveFrejaFileName[]
             ->autosaveFrejaFile.name;
           (if autosaveFrejaFile.entry.exists then
               autosaveFrejaFileName
                 ->scanAstFiles
                   (# 
                   do
                      currentGroupName->groupName;
                      '.ast'->groupName.append;
                      groupName[]->groupFile.name;
                      '#'->(groupName.copy).append->autosaveGroupFile.name;
                      (if switch[17] then
                          groupName[]->putLine;
                          autosaveGroupFile.name->putLine;
                          (* tildeGroupFile.name->putLine*)
                          
                      if);
                      (if autosaveGroupFile.entry.exists then
                          'rm .ast#'->putLine; autosaveGroupFile.delete
                      if)
                      (* no not anymore 
                       (if tildeGroupFile.entry.exists and
                       groupFile.entry.exists then
                       'mv .ast~ .ast'->putLine;
                       groupFile.name
                       ->tildeGroupFile.entry.rename
                       if)
                       *)
                   #);
               (if autosaveDiagFile.entry.exists then
                   'rm .diag#'->putLine; autoSaveDiagFile.delete
               if);
               'rm .freja#'->putLine;
               autosaveFrejaFile.delete
           if);
           (normal,' ')->stop
       if)
    else
       (normal,' ')->stop
   if)
#)
(*
 -- FrejaOptionsMenuInit: Descriptor --
 (#  do (UserMenu3+13,'With Dexter')->WithDexterItem.init;  #)  
 
 -- FrejaOptionsMenuCheckMarks: Descriptor --
 (#  do withDexter->WithDexterItem.check #)  
 *)  

-- FrejaUndoItem: Descriptor --
(#
   thePage: ^Page;
   theOADPage: ^OADPage;
   theObject: ^theOADPage.DesignObject;
   theNode: ^theOADPage.PatternDiagramNode;
   se: ^sifEditor
do
   currentPage->thePage[];
   (if thePage[] <> none then
       (if thePage## <= OADPage## then
           thePage[]->theOADPage[];
           (if theOADPage.canUndo then
               theOADPage.CurrentObject->theObject[];
               (if theObject[] <> none then
                   (if theObject## <= theOADPage.PatternDiagramNode## then
                       theObject[]->theNode[];
                       theNode.theSifEditor->se[];
                       (if se[] <> none then
                           se.undo
                        else
                           'Undo: sifEditor is none??'->putline
                       if)
                   if)
                else
                   'No current object - can not undo'->putline
               if)
           if)
        else
           'Undo not implemented on this type of page'->alertUser
       if)
    else
       'Undo: no currentPage!'->alertUser
   if)
#)  

-- FrejaUndoGraphicalOperationItem: Descriptor --
(#  do menuID.EditMenu.undo->DSUIMenuExecute #)  

-- FrejaCutItem: Descriptor --
(#
   thePage: ^Page;
   theOADPage: ^OADPage;
   theObjectPage: ^ObjectPage;
   theObject: ^thePage.DesignObject;
   theNode: ^theOADPage.PatternDiagramNode;
   theListDiagram: ^theOADPage.ListDiagram;
   thePatternNode: ^theListDiagram.PatternNode;
   deletableConnector: ^theOADPage.DeletableConnector;
   anAST: ^MPS.AST;
   t: ^Text;
   group: [0] @Integer;
   count: @ShortRef;
   list: @IntegerRef;
   isGroup: @boolean
do
   thisOp:
     (# 
     do
        currentPage->thePage[];
        (if thePage[] <> none then
            (if thePage## <= OADPage## then
                thePage[]->theOADPage[];
                (if (count[],list[])->DSStrGetCurGroup then
                    true->isGroup;
                    (count,list)->GetIntList->group;
                    (for i: group.range repeat
                      group[i]->theObjectList.find->theObject[];
                      (if theObject[] <> none then
                          (if (theObject## <= theOADPage.UserDataNode##) or
                          (theObject## <= theOADPage.DeletableConnector##) then
                              'Cutting groups including parts of diagrams is not allowed'
                                ->alertUser;
                              leave thisOp
                          if)
                      if);
                      
                    for)
                if);
                (if isGroup then
                    false->doOADPaste;
                    false->doObjectPaste;
                    false->pasteGroupWithOAD;
                    menuID.EditMenu.cut->DSUIMenuExecute;
                    FrejaEditMenu.iPaste.enable
                 else
                    theOADPage.CurrentObject->theObject[];
                    (if theObject[] <> none then
                        doCut:
                        (if theObject## <= theOADPage.PatternDiagramNode## then
                            theObject[]->theNode[];
                            theNode.theDiagram->theListDiagram[];
                            (if theNode## <= theListDiagram.title## then
                                (if theListDiagram.theParentNode <> none then
                                    theListDiagram.theParentNode
                                      ->theOADPage.currentObject;
                                    (theNode[],theListDiagram.theParentNode)
                                      ->theOADPage.changedFocus;
                                    theListDiagram.theParentNode->theNode[];
                                    (theListDiagram.theParentNode).theDiagram
                                      ->theListDiagram[]
                                      (* this is realy ugly and except from that
                                       cheating the compiler,
                                       but what the heck, it works! :-) *)
                                 else
                                    'Only diagrams that correspond to patterns can be cut'
                                      ->alertUser;
                                    leave doCut
                                if)
                            if);
                            (if theNode## <= theListDiagram.PatternNode## then
                                theNode[]->thePatternNode[];
                                (if thePatternNode.theAssociationNode <> none
                                 then
                                    (thePatternNode.theAssociationNode).delete
                                if)
                            if);
                            theNode.getASTNode->anAST[];
                            (if anAST[] <> none then
                                (anAST[],1)->(theNode.theSifEditor).changeFocus
                            if);
                            true->doOADPaste;
                            false->doObjectPaste;
                            false->pasteGroupWithOAD;
                            menuID.EditMenu.copy->DSUIMenuExecute;
                            FrejaEditMenu.iPaste.enable;
                            (theNode.theSifEditor).cut
                         else
                            (if theObject## <= theOADPage.DeletableConnector##
                             then
                                'Relations cannot be cut - use clear instead'
                                  ->alertUser
                             else
                                (if theObject## <= theOADPage.AssociationNode##
                                 then
                                    'Relations cannot be cut - use clear instead'
                                      ->alertUser
                                 else
                                    false->doOADPaste;
                                    false->doObjectPaste;
                                    false->pasteGroupWithOAD;
                                    menuID.EditMenu.cut->DSUIMenuExecute;
                                    FrejaEditMenu.iPaste.enable
                                if)
                            if)
                        if)
                     else
                        false->doOADPaste;
                        false->doObjectPaste;
                        false->pasteGroupWithOAD;
                        menuID.EditMenu.cut->DSUIMenuExecute;
                        FrejaEditMenu.iPaste.enable
                    if)
                if)
             else
                (if thePage## <= ObjectPage## then
                    thePage[]->theObjectPage[];
                    (if (count[],list[])->DSStrGetCurGroup then
                        true->isGroup;
                        (count,list)->GetIntList->group;
                        (for i: group.range repeat
                          group[i]->theObjectList.find->theObject[];
                          (if theObject[] <> none then
                              (if
                              (theObject## <= theObjectPage.ObjectDiagramNode##)
                               then
                                  'Cutting groups including parts of diagrams is not allowed'
                                    ->alertUser;
                                  leave thisOp
                              if)
                          if);
                          
                        for)
                    if);
                    (if isGroup then
                        false->doOADPaste;
                        false->doObjectPaste;
                        false->pasteGroupWithOAD;
                        menuID.EditMenu.cut->DSUIMenuExecute;
                        FrejaEditMenu.iPaste.enable
                     else
                        theObjectPage.CurrentObject->theObject[];
                        (if theObject[] <> none then
                            (if theObject## <= theObjectPage.ObjectDiagramNode##
                             then
                                'Cutting nodes in object diagrams not yet implemented'
                                  ->alertUser
                             else
                                false->doOADPaste;
                                false->doObjectPaste;
                                false->pasteGroupWithOAD;
                                menuID.EditMenu.cut->DSUIMenuExecute;
                                FrejaEditMenu.iPaste.enable
                            if)
                         else
                            false->doOADPaste;
                            false->doObjectPaste;
                            false->pasteGroupWithOAD;
                            menuID.EditMenu.cut->DSUIMenuExecute;
                            FrejaEditMenu.iPaste.enable
                        if)
                    if)
                 else
                    false->doOADPaste;
                    false->doObjectPaste;
                    false->pasteGroupWithOAD;
                    menuID.EditMenu.cut->DSUIMenuExecute;
                    FrejaEditMenu.iPaste.enable
                if)
            if)
         else
            'No current page'->alertUser
        if)
     #)
#)  

-- FrejaCopyItem: Descriptor --
(#
   thePage: ^Page;
   theOADPage: ^OADPage;
   theObjectPage: ^ObjectPage;
   theObject: ^thePage.DesignObject;
   theNode: ^theOADPage.PatternDiagramNode;
   anAST: ^MPS.AST;
   t: ^Text;
   group: [0] @Integer;
   count: @ShortRef;
   list: @IntegerRef;
   isGroup: @boolean
do
   thisOp:
     (# 
     do
        currentPage->thePage[];
        (if thePage[] <> none then
            (if thePage## <= OADPage## then
                thePage[]->theOADPage[];
                (if (count[],list[])->DSStrGetCurGroup then
                    true->isGroup;
                    false->pasteGroupWithOAD;
                    (count,list)->GetIntList->group;
                    (for i: group.range repeat
                      group[i]->theObjectList.find->theObject[];
                      (if (theObject## <= theOADPage.UserDataNode##) or
                      (theObject## <= theOADPage.DeletableConnector##) then
                          true->pasteGroupWithOAD
                      if);
                      
                    for)
                if);
                (if isGroup then
                    false->doOADPaste;
                    false->doObjectPaste;
                    menuID.EditMenu.copy->DSUIMenuExecute;
                    FrejaEditMenu.iPaste.enable
                 else
                    theOADPage.CurrentObject->theObject[];
                    (if theObject[] <> none then
                        (if theObject## <= theOADPage.PatternDiagramNode## then
                            theObject[]->theNode[];
                            theNode.getASTNode->anAST[];
                            (if anAST[] <> none then
                                (anAST[],1)->(theNode.theSifEditor).changeFocus
                            if);
                            true->doOADPaste;
                            false->doObjectPaste;
                            false->pasteGroupWithOAD;
                            (theNode.theSifEditor).copy;
                            menuID.EditMenu.copy->DSUIMenuExecute;
                            FrejaEditMenu.iPaste.enable
                         else
                            false->doOADPaste;
                            false->doObjectPaste;
                            false->pasteGroupWithOAD;
                            menuID.EditMenu.copy->DSUIMenuExecute;
                            FrejaEditMenu.iPaste.enable
                        if)
                     else
                        false->doOADPaste;
                        false->doObjectPaste;
                        false->pasteGroupWithOAD;
                        menuID.EditMenu.copy->DSUIMenuExecute;
                        FrejaEditMenu.iPaste.enable
                    if)
                if)
             else
                (if thePage## <= ObjectPage## then
                    thePage[]->theObjectPage[];
                    (if (count[],list[])->DSStrGetCurGroup then
                        true->isGroup;
                        false->pasteGroupWithOAD;
                        (count,list)->GetIntList->group;
                        (for i: group.range repeat
                          group[i]->theObjectList.find->theObject[];
                          (if theObject[] <> none then
                              (if
                              (theObject## <= theObjectPage.ObjectDiagramNode##)
                               then
                                  true->pasteGroupWithOAD
                              if)
                          if);
                          
                        for)
                    if);
                    (if isGroup then
                        false->doOADPaste;
                        false->doObjectPaste;
                        menuID.EditMenu.copy->DSUIMenuExecute;
                        FrejaEditMenu.iPaste.enable
                     else
                        theObjectPage.CurrentObject->theObject[];
                        (if theObject[] <> none then
                            (if theObject## <= theObjectPage.ObjectDiagramNode##
                             then
                                true->doObjectPaste;
                                false->doOADPaste;
                                false->pasteGroupWithOAD;
                                menuID.EditMenu.copy->DSUIMenuExecute;
                                FrejaEditMenu.iPaste.enable
                             else
                                false->doOADPaste;
                                false->doObjectPaste;
                                false->pasteGroupWithOAD;
                                menuID.EditMenu.copy->DSUIMenuExecute;
                                FrejaEditMenu.iPaste.enable
                            if)
                         else
                            false->doOADPaste;
                            false->doObjectPaste;
                            false->pasteGroupWithOAD;
                            menuID.EditMenu.copy->DSUIMenuExecute;
                            FrejaEditMenu.iPaste.enable
                        if)
                    if)
                 else
                    false->doOADPaste;
                    false->doObjectPaste;
                    false->pasteGroupWithOAD;
                    menuID.EditMenu.copy->DSUIMenuExecute;
                    FrejaEditMenu.iPaste.enable
                if)
            if)
         else
            'No current page'->alertUser
        if)
     #)
#)  

-- FrejaPasteBeforeItem: Descriptor --
(#
   thePage: ^Page;
   theOADPage: ^OADPage;
   theObject: ^theOADPage.DesignObject;
   theNode: ^theOADPage.PatternDiagramNode;
   anAST: ^MPS.AST;
   t: ^Text
do
   currentPage->thePage[];
   (if thePage[] <> none then
       (if thePage## <= OADPage## then
           thePage[]->theOADPage[];
           theOADPage.CurrentObject->theObject[];
           (if doOADPaste then
               (if theObject[] <> none then
                   (if theObject## <= theOADPage.PatternDiagramNode## then
                       (if theOADPage.canPaste then
                           theObject[]->theNode[];
                           theNode.getASTNode->anAST[];
                           (if anAST[] <> none then
                               (anAST[],1)->(theNode.theSifEditor).changeFocus
                           if);
                           (if theOADPage.canListInsert then
                               (theNode.theSifEditor).before;
                               (theNode.theSifEditor).paste
                           if)
                       if)
                   if)
                else
                   'No current object!'->putline
               if)
            else
               menuID.EditMenu.paste->DSUIMenuExecute
           if)
        else
           'Paste Before not implemented on this type of page'->alertUser
       if)
    else
       'No current page'->alertUser
   if)
#)  

-- FrejaPasteItem: Descriptor --
(#
   thePage: ^Page;
   theOADPage: ^OADPage;
   theObject,theRegionObject: ^thePage.DesignObject;
   thePatternDiagramNode: ^theOADPage.PatternDiagramNode;
   anAST: ^MPS.AST;
   group,connectorsInGroup,connectorsInRegion: [0] @Integer;
   regions: [0] @Integer;
   theRegions: @ObjectList;
   count,connectorCount,regionConnectorCount: @ShortRef;
   list,connectorList,regionConnectorList: @IntegerRef;
   isGroup: @Boolean;
   ID: @integer;
   theIDObject: ^IDObject;
   theRegionIDMap: ^regionIDMap;
   regionIDMap: (* Same as UserDataIDMap - should be generalized! *)
     (#
        impl: [0] @Integer;
        putID:
          (# oldID,newID: @integer
          enter (oldID,newID)
          do
             (if oldID <> 0 then
                 (if oldID > impl.range then
                     oldID+impl.range->impl.extend
                 if);
                 newID->impl[oldID]
             if)
          #);
        getID: (# oldID: @integer enter oldID exit impl[oldID] #)
     #);
   visualizeObject:
     (#
        theObject: ^thePage.DesignObject;
        theNode,node1,node2: ^thePage.Node;
        theRndRectNode: ^thePage.RndRectNode;
        theWedgeNode: ^thePage.WedgeNode;
        thePolygonNode: ^thePage.PolygonNode;
        theRegPolyNode: ^thePage.RegPolyNode;
        theLabel: ^thePage.LabelNode;
        theConn: ^thePage.connector;
        t: @Text;
        x,y,w,h,selectable,lineThickness,lineType,fillType,borderVisible,wRound,
          hRound,start,end,orient,HeadHeight,HeadWidth,shape,textBoxW,textBoxH,
          curvature: @integer;
        font,size,style,just: @shortInt;
        nd1,nd2: @IntegerRef;
        points: [0] @Integer;
        getConnVisuals:
          (# 
          do
             theConn.orient->orient;
             theConn.Points->Points;
             theConn.HeadWidth->HeadWidth;
             theConn.HeadHeight->HeadHeight;
             theConn.shape->shape;
             theConn.TextBox->(textBoxW,textBoxH);
             theConn.Curvature->curvature
          #);
        setConnVisuals:
          (# 
          do
             orient->theConn.orient;
             (for i: points.range repeat points[i]+5->points[i] for);
             points->theConn.Points;
             HeadWidth->theConn.HeadWidth;
             HeadHeight->theConn.HeadHeight;
             shape->theConn.shape;
             (textBoxW,textBoxH)->theConn.TextBox;
             curvature->theConn.Curvature
          #);
        getVisuals:
          (# 
          do
             theObject.LineThickness->lineThickness;
             theObject.LineType->lineType;
             theObject.FillType->fillType;
             theObject.BorderVisible->borderVisible
          #);
        setVisuals:
          (# 
          do
             lineThickness->theObject.LineThickness;
             lineType->theObject.LineType;
             fillType->theObject.FillType;
             borderVisible->theObject.BorderVisible
          #);
        getText:
          (# fontRef,sizeRef,styleRef,justRef,heightRef,scBarRef: @ShortRef
          do
             (if theObject.theText.length > 0 then
                 theObject.theText.get->t;
                 (theObject.ID,fontRef[],sizeRef[],styleRef[],justRef[],
                  heightRef[],scBarRef[])->DSTextGetAttr;
                 (fontRef,sizeRef,styleRef,justRef)->(font,size,style,just)
             if)
          #);
        setText:
          (# 
          do
             (if t.length > 0 then
                 t->theObject.theText.set;
                 (theObject.ID,font,size,style,just)->DSTextSetAttr
             if)
          #);
        moveDelta:
          (# x,y,w,h: @integer enter (x,y,w,h) exit (x+5,y+5,w,h) #)
     enter theObject[]
     do
        (if true
         // theObject## <= thePage.Rectnode##
         // theObject## <= thePage.EllipseNode## then
            theObject[]->theNode[];
            getVisuals;
            getText;
            theNode.geometry->moveDelta->theNode.new;
            setVisuals;
            setText
         // theObject## <= thePage.RndRectNode## then
            theObject[]->theRndRectNode[];
            getVisuals;
            getText;
            theRndRectNode.Roundness->(wRound,hRound);
            theRndRectNode.geometry->moveDelta->theRndRectNode.new;
            (wRound,hRound)->theRndRectNode.Roundness;
            setVisuals;
            setText
         // theObject## <= thePage.WedgeNode## then
            theObject[]->theWedgeNode[];
            getVisuals;
            getText;
            theWedgeNode.Angles->(start,end);
            start->DSUtilWorldToPoints->start;
            (if start <> 0 then start div 2->start if);
            end->DSUtilWorldToPoints->end;
            (if end <> 0 then end div 2->end if);
            theWedgeNode.geometry->moveDelta->theWedgeNode.new;
            (start,end)->theWedgeNode.Angles;
            setVisuals;
            setText
         // theObject## <= thePage.PolygonNode## then
            theObject[]->thePolygonNode[];
            getVisuals;
            getText;
            thePolygonNode.Points->points;
            (if points.range > 0 then
                thePolygonNode.geometry->moveDelta->(x,y,w,h);
                (for i: points.range repeat points[i]->wcoord->points[i] for);
                &thePage.Node[]->theNode[];
                (thePage.ID,points.range div 2,@@ points[1])->DSStrCreatePolygon
                  ->theNode.onInit;
                (x,y)->theNode.move;
                theNode[]->theObject[];
                setVisuals;
                setText
             else
                'Trying to paste line - not yet implemented'->alertUser
            if)
         // theObject## <= thePage.RegPolyNode## then
            theObject[]->theRegPolyNode[];
            getVisuals;
            getText;
            2*theRegPolyNode.NoOfPoints->points.extend;
            theRegPolyNode.Points->points;
            (if points.range > 0 then
                theRegPolyNode.geometry->moveDelta->(x,y,w,h);
                (for i: points.range repeat points[i]->wcoord->points[i] for);
                &thePage.Node[]->theNode[];
                (thePage.ID,points.range div 2,@@ points[1])->DSStrCreatePolygon
                  ->theNode.onInit;
                (x,y)->theNode.move;
                theNode[]->theObject[];
                setVisuals;
                setText
             else
                'Trying to paste line - not yet implemented'->alertUser
            if)
         // theObject## <= thePage.LabelNode## then
            theObject[]->theLabel[];
            getVisuals;
            getText;
            theLabel.geometry->moveDelta->(x,y,w,h);
            (x,y,w,h,t)->theLabel.new;
            setVisuals;
            setText
         else
            (if theObject## <= thePage.Connector## then
                theObject[]->theConn[];
                getConnVisuals;
                getVisuals;
                getText;
                true->theConn.getEnds->(node1[],node2[]);
                (if (node1[] = none ) and (node2[] = none ) then
                (* iff node1 and node2 none then a single connector is on the clipboard *)
                    menuID.EditMenu.paste->DSUIMenuExecute
                 else
                    node1.ID->theRegionIDMap.getID->theObjectList.find->node1[];
                    node2.ID->theRegionIDMap.getID->theObjectList.find->node2[];
                    (node1[],node2[])->theConn.new;
                    setConnVisuals;
                    setVisuals;
                    setText
                if)
             else
                'Trying to paste unknown type of node'->alertUser
            if)
        if)
     #);
   makeRegions:
     (#
        ID: @integer;
        count: @ShortRef;
        list: @IntegerRef;
        regions: [0] @Integer;
        theObject,theDesignObject,returnObject: ^thePage.DesignObject;
        theRegions: @ObjectList
     enter ID
     do
        (if (ID,count[],list[])->DSStrGetObjectRegionList then
            (if count > 0 then
                (count,list)->GetIntList->regions;
                (for i: regions.range repeat
                  regions[i]->makeRegions->returnObject[];
                  returnObject[]->theRegions.insert;
                  
                for);
                
            if)
        if);
        ID->thePage.PageCallBack.MakeDesignObject->theObject[]->visualizeObject;
        (ID,theObject.ID)->theRegionIDMap.putID;
        theRegions.scan
          (# 
          do
             current[]->theDesignObject[];
             theObject[]->theDesignObject.createRegion
          #)
     exit theObject[]
     #);
   designPaste:
     (# 
     do
        DSStrGetCutOrCopiedObject->ID;
        (ID,count[],list[])->DSStrGetNodeList;
        &RegionIDMap[]->theRegionIDMap[];
        (if count > 0 then
            (count,list)->GetIntList->group;
            (@@ group[1],count,connectorList[],connectorCount[])
              ->DSStrGetInternalConnList;
            (connectorCount,connectorList)->GetIntList->connectorsInGroup;
            (for i: group.range repeat
              (@@ group[i],1,regionConnectorList[],regionConnectorCount[])
                ->DSStrGetInternalConnList;
              (regionConnectorCount,regionConnectorList)->GetIntList
                ->connectorsInRegion;
              group[i]->makeRegions->theObject[];
              theObject.ID->group[i];
              (theObject.ID,theObject.ID)->theRegionIDMap.putID;
              (for i: connectorsInRegion.range repeat
                connectorsInRegion[i]->thePage.PageCallBack.MakeDesignObject
                  ->visualizeObject
              for)
            for);
            (for i: connectorsInGroup.range repeat
              connectorsInGroup[i]->thePage.PageCallBack.MakeDesignObject
                ->visualizeObject
            for);
            group.range->count;
            (count,@@ group[1])->DSStrSetCurGroup;
            
         else
            (if ID <> 0 then
                (@@ ID,1,regionConnectorList[],regionConnectorCount[])
                  ->DSStrGetInternalConnList;
                (regionConnectorCount,regionConnectorList)->GetIntList
                  ->connectorsInRegion;
                ID->makeRegions->theObject[];
                (theObject.ID,theObject.ID)->theRegionIDMap.putID;
                (for i: connectorsInRegion.range repeat
                  connectorsInRegion[i]->thePage.PageCallBack.MakeDesignObject
                    ->visualizeObject
                for)
             else
                FrejaEditMenu.iPaste.disable
            if);
            (* theObject[]->thePage.currentObject *)
            
        if)
     #)
do
   currentPage->thePage[];
   (if thePage[] <> none then
       (if thePage## <= OADPage## then
           thePage[]->theOADPage[];
           (if doOADPaste then
               theOADPage.CurrentObject->theObject[];
               (if theObject[] <> none then
                   (if theObject## <= theOADPage.PatternDiagramNode## then
                       (if theOADPage.canPaste then
                           theObject[]->thePatternDiagramNode[];
                           thePatternDiagramNode.getASTNode->anAST[];
                           (if anAST[] <> none then
                               (anAST[],1)
                                 ->
                                   (thePatternDiagramNode.theSifEditor).
                                   changeFocus
                           if);
                           (thePatternDiagramNode.theSifEditor).paste
                       if)
                   if)
                else
                   'No current object!'->alertUser
               if)
            else
           (* menuID.EditMenu.paste->DSUIMenuExecute *)
               (if doObjectPaste then
                   'Clipboard contains object from object diagram - can not paste on Work Sheet'
                     ->alertUser
                else
                   (if not pasteGroupWithOAD then
                       designPaste
                    else
                       'Clipboard contains group with parts of diagram - can only paste on graphics page'
                         ->alertUser
                   if)
               if);
               
           if)
        else
           (if thePage## <= ObjectPage## then
               (if doObjectPaste then
                   'Clipboard contains object from object diagram - only paste on graphics page currently implemented'
                     ->alertUser
                else
                   (if doOADPaste then
                       'Clipboard contains part of pattern diagram - can not paste on Object Page'
                         ->alertUser
                    else
                       (if not pasteGroupWithOAD then
                           designPaste
                        else
                           'Clipboard contains group with parts of diagram - can only paste on graphics page'
                             ->alertUser
                       if)
                   if)
               if)
            else
               designPaste
           if)
       if)
    else
       'No current page'->alertUser
   if)
#)  

-- FrejaPasteAfterItem: Descriptor --
(#
   thePage: ^Page;
   theOADPage: ^OADPage;
   theObject: ^theOADPage.DesignObject;
   theNode: ^theOADPage.PatternDiagramNode;
   anAST: ^MPS.AST;
   t: ^Text
do
   currentPage->thePage[];
   (if thePage[] <> none then
       (if thePage## <= OADPage## then
           thePage[]->theOADPage[];
           theOADPage.CurrentObject->theObject[];
           (if doOADPaste then
               (if theObject[] <> none then
                   (if theObject## <= theOADPage.PatternDiagramNode## then
                       (if theOADPage.canPaste then
                           theObject[]->theNode[];
                           theNode.getASTNode->anAST[];
                           (if anAST[] <> none then
                               (anAST[],1)->(theNode.theSifEditor).changeFocus
                           if);
                           (if theOADPage.canListInsert then
                               (theNode.theSifEditor).after;
                               (theNode.theSifEditor).paste
                           if)
                       if)
                   if)
                else
                   'No current object!'->putline
               if)
            else
               menuID.EditMenu.paste->DSUIMenuExecute
           if)
        else
           'Paste After not implemented on this type of page'->alertUser
       if)
    else
       'No current page'->alertUser
   if)
#)  

-- FrejaClearItem: Descriptor --
(#
   thePage: ^Page;
   theOADPage: ^OADPage;
   theObjectPage: ^ObjectPage;
   theObject: ^thePage.DesignObject;
   theNode,thePatternNode: ^theOADPage.PatternDiagramNode;
   theAssociationNode: ^theOADPage.AssociationNode;
   deletableConnector: ^theOADPage.DeletableConnector;
   regionList: ^ObjectList;
   anAST: ^MPS.AST;
   t: ^Text
do
   currentPage->thePage[];
   (if thePage[] <> none then
       (if thePage## <= OADPage## then
           thePage[]->theOADPage[];
           theOADPage.CurrentObject->theObject[];
           (if theObject[] <> none then
               (if theObject## <= theOADPage.PatternDiagramNode## then
                   'Nodes in pattern diagrams can currently not be cleared, only cut'
                     ->alertUser
                else
                   (if theObject## <= theOADPage.DeletableConnector## then
                       theObject[]->deletableConnector[];
                       deletableConnector.onDelete
                   if);
                   (if theObject## <= theOADPage.AssociationNode## then
                       theObject[]->theAssociationNode[];
                       (if theAssociationNode.thePatternNode <> none then
                           theAssociationNode.thePatternNode->thePatternNode[]
                       if);
                       theObject.delete;
                       (if thePatternNode[] <> none then
                           thePatternNode[]->theOADPage.currentObject;
                           thePatternNode.getASTNode->anAST[];
                           (if anAST[] <> none then
                               true->doOADPaste;
                               (anAST[],1)
                                 ->(thePatternNode.theSifEditor).changeFocus;
                               (thePatternNode.theSifEditor).cut
                           if)
                       if)
                    else
                       theObject.delete
                   if)
               if)
            else
               menuID.EditMenu.clear->DSUIMenuExecute
           if)
        else
           'Clear not implemented on this type of page'->alertUser;
           (if thePage## <= ObjectPage## then
               thePage[]->theObjectPage[];
               theObjectPage.currentObject->theObject[];
               (if theObject[] <> none then
                   (if theObject## <= theObjectPage.ObjectDiagramNode## then
                       'Clear on objects in object diagrams not implemented yet'
                         ->alertUser
                    else
                       theObject.delete
                   if)
                else
                   'No current object'->alertUser
               if)
            else
               thePage.currentObject->theObject[];
               (if theObject[] <> none then
                   theObject.delete
                else
                   'No current object'->alertUser
               if)
           if)
       if)
    else
       'No current page'->alertUser
   if)
#)  

-- InsertBeforeHit: Descriptor --
(#
   thePage: ^Page;
   theOADPage: ^OADPage;
   theObject: ^theOADPage.PatternDiagramNode;
   theDesObj: ^theOADPage.DesignObject;
   t: ^text;
   anAST: ^MPS.AST
do
   (if switch[1] then 'InsertBefore'->putline if);
   currentPage->thePage[];
   (if thePage[] <> none then
       (if thePage## <= OADPage## then
           thePage[]->theOADPage[];
           theOADPage.CurrentObject->theDesObj[];
           (if theDesObj[] <> none then
               (if theDesObj## <= theOADPage.PatternDiagramNode## then
                   theDesObj[]->theObject[];
                   theObject.getASTNode->anAST[];
                   (if anAST[] <> none then
                       (anAST[],1)->(theObject.theSifEditor).changeFocus
                   if);
                   (if theOADPage.canListInsert then
                       (theObject.theSifEditor).before
                   if)
                else
                   'Current focus is not a pattern diagram node!'->putline
               if)
           if)
        else
           'Insert Before not implemented on this type of page'->alertUser
       if)
    else
       'No current page'->alertUser
   if);
   
#)  

-- EditMenuInit: Descriptor --
(# 
do (* design gets internal error for items above status+3! Why? *)
(* (UserMenu2+2,'-')->sep1.init;
 sep1.disable; *)
   (UserMenu2+1,'Undo                     Alt-z')->iUndo.init;
   (UserMenu2+2,'Cut                      Alt-x')->iCut.init;
   (UserMenu2+3,'Copy                     Alt-c')->iCopy.init;
   (UserMenu2+4,'Paste Before             Alt-U')->iPasteBefore.init;
   (UserMenu2+5,'Paste                    Alt-v')->iPaste.init;
   (UserMenu2+6,'Paste After              Alt-A')->iPasteAfter.init;
   (UserMenu2+7,'Clear                    Alt-q')->iClear.init;
   (UserMenu2+8,'-')->sep2.init;
   sep2.disable;
   (UserMenu2+9,'Edit Name                Alt-w')->iEditName.init;
   (UserMenu2+10,'Open Subeditor           Alt-j')->iTextEdit.init;
   (UserMenu2+11,'Edit Other Text          Alt-t')->iEditOtherText.init;
   (*  (UserMenu2+10,'Revert Textediting       (ctrl+r)')->irevertTextEdit.init;*)
   (UserMenu2+12,'-')->sep3.init;
   sep3.disable;
   (UserMenu2+13,'Insert Before            Alt-u')->insertbeforeItem.init;
   (UserMenu2+14,'Insert After             Alt-a')->insertafter.init;
   (UserMenu2+15,'-')->sep4.init;
   sep4.disable;
   (UserMenu2+16,'Remove Optionals         Alt-n')->iRemoveOptionals.init;
   (UserMenu2+17,'Show Optionals           Alt-l')->iShowOptionals.init;
   iClear.enable;
   (UserMenu2+18,'-')->sep5.init;
   (UserMenu2+19,'Check')->iCheck.init;
   
#)  

-- FrejaEditMenuIEditName: DoPart --
do
     (#
        thePage: ^Page;
        p: ^OADPage;
        thePatternDiagramNode: ^p.PatternDiagramNode;
        theDiagram: ^p.Diagram;
        theTitle: ^theDiagram.title;
        c: ^p.DesignObject;
        doNotEdit,didCancel: @Boolean;
        anAST: ^mps.ast;
        anExp: ^mps.expanded;
        theNameDcl: ^betaGram.NameDcl;
        message: ^text;
        t: ^text;
        ok: @boolean;
        errorPos: @integer;
        parseErrorText: ^Text
     do
        CurrentPage->thePage[];
        (if thePage[] <> none then
            (if thePage## <= OADPage## then
                thePage[]->p[];
                (if p[] <> theGroupPage[] then
                    p.CurrentObject->c[];
                    (if c[] <> none then
                        (if c## <= p.PatternDiagramNode## then
                            c[]->thePatternDiagramNode[];
                            thePatternDiagramNode.theDiagram->theDiagram[];
                            (if thePatternDiagramNode## <= theDiagram.title##
                             then
                                (if (theDiagram## < p.PatternAttDiagram##) or
                                (theDiagram.theParentNode = none ) then
                                    'Textediting fragmentform name is currently disabled'
                                      ->alertUser;
                                    true->doNotEdit
                                 else
                                    thePatternDiagramNode[]->theTitle[]
                                if)
                            if)
                        if);
                        (if (thePatternDiagramNode[] <> none ) and
                        (not doNotEdit) then
                            (if thePatternDiagramNode.theSifEditor <> none then
                                (if (thePatternDiagramNode.theSifEditor).fe[] <>
                                none then
                                    thePatternDiagramNode.getASTNode->anAST[];
                                    (if theTitle[] <> none then
                                        anAST.father->anExp[];
                                        (if anExp.symbol = betaGram.StaticItem
                                         then
                                            anExp.father->anExp[]
                                        if);
                                        anExp.getSon1->anExp[];
                                        anExp.getSon1->theNameDcl[]
                                     else
                                        (if anAST[] <> none then
                                            anAST[]->anExp[];
                                            anExp.getSon1->anExp[];
                                            anExp.getSon1->theNameDcl[]
                                         else
                                            'IEditName: Should not happen - getASTNode returned none'
                                              ->putline
                                        if)
                                    if);
                                    (if theNameDcl[] <> none then
                                        theNameDcl.getNameDecl->anAST[];
                                        (if anAST.kind = mps.kinds.unExpanded
                                         then
                                            '<<NameDecl>>'->t[]
                                         else
                                            theNameDcl.getText->t[]
                                        if);
                                        'Edit Name: '->message[];
                                        doPrompt:
                                          (# 
                                          do
                                             (message[],t[])
                                               ->FrejaPromptForText
                                                 (#
                                                    confirm::< 
                                                      (# 
                                                      do
                                                         (if theText[] <> none
                                                          then
                                                             (if theText.length
                                                             > 0 then
                                                                 theText[]->t[];
                                                                 (theNameDcl[],
                                                                  theText)
                                                                   ->
                                                                     (
                                                                     thePatternDiagramNode
                                                                     .
                                                                       theSifEditor
                                                                     ).parse
                                                                   ->
                                                                     (ok,
                                                                      errorPos,
                                                                      parseErrorText[])
                                                             if)
                                                         if)
                                                      #);
                                                    cancel::< 
                                                      (# 
                                                      do true->didCancel
                                                      #)
                                                 #);
                                             (if didCancel then
                                                 leave doPrompt
                                              else
                                                 (if not ok then
                                                     'Edit Name: '->message[];
                                                     parseErrorText[]
                                                       ->message.append;
                                                     restart doPrompt
                                                  else
                                                     (if theTitle[] <> none
                                                      then
                                                     (* set focus on title not on parentnode of title *)
                                                         theTitle[]
                                                           ->p.currentObject
                                                             (# 
                                                             do true->autoPan
                                                             #);
                                                         theTitle.onSelect
                                                     if)
                                                 if)
                                             if)
                                          #)
                                    if)
                                 else
                                    'iTextEdit: No codeeditor for theSifEditor!'
                                      ->putline
                                if)
                             else
                                'iTextEdit: theSifEditor is none'->putline
                            if)
                            (*(if TextModeOn then
                             c.theText.modeOff; 
                             else
                             c.theText.modeOn; 
                             if);
                             (if not p.parseErrorOccurred then
                             not TextModeOn->TextModeOn; TextModeOn->Check
                             else
                             [* c.theText.modeOn *]
                             not TextModeOn->TextModeOn;
                             TextModeOn->Check;
                             false->p.parseErrorOccurred;
                             hit
                             if);*)
                        if);
                        
                    if)
                 else
                    'Textediting on Group Page is currently disabled'->alertUser
                if)
             else
                'Edit Name not implemented on this type of page'->alertUser
            if)
         else
            'No current page'->alertUser
        if);
        
     #)  

-- FrejaEditMenuITextEdit: Descriptor --
(#
   thePage: ^Page;
   p: ^OADPage;
   thePatternDiagramNode: ^p.PatternDiagramNode;
   theDiagram: ^p.Diagram;
   theTitle: ^theDiagram.title;
   c: ^p.DesignObject;
   doNotEdit: @Boolean;
   anAST: ^mps.ast;
   anExp: ^mps.expanded
do
   CurrentPage->thePage[];
   (if thePage[] <> none then
       (if thePage## <= OADPage## then
           thePage[]->p[];
           (if p[] <> theGroupPage[] then
               p.CurrentObject->c[];
               (if c[] <> none then
                   (if c## <= p.PatternDiagramNode## then
                       c[]->thePatternDiagramNode[];
                       thePatternDiagramNode.theDiagram->theDiagram[];
                       (if thePatternDiagramNode## <= theDiagram.title## then
                           (if (theDiagram## < p.PatternAttDiagram##) or
                           (theDiagram.theParentNode = none ) then
                               'Textediting fragmentform name is currently disabled'
                                 ->alertUser;
                               true->doNotEdit
                            else
                               thePatternDiagramNode[]->theTitle[]
                           if)
                       if)
                   if);
                   (if (thePatternDiagramNode[] <> none ) and (not doNotEdit)
                    then
                       (if thePatternDiagramNode.theSifEditor <> none then
                           (if (thePatternDiagramNode.theSifEditor).fe[] <> none
                           then
                               thePatternDiagramNode.getASTNode->anAST[];
                               (if anAST[] <> none then
                                   (anAST[],1)
                                     ->
                                       (thePatternDiagramNode.theSifEditor).
                                       changeFocus
                               if);
                               (thePatternDiagramNode.theSifEditor).fe.
                                 openSubeditor
                            else
                               'iTextEdit: No codeeditor for theSifEditor!'
                                 ->putline
                           if)
                        else
                           'iTextEdit: theSifEditor is none'->putline
                       if)
                       (*(if TextModeOn then
                        c.theText.modeOff; 
                        else
                        c.theText.modeOn; 
                        if);
                        (if not p.parseErrorOccurred then
                        not TextModeOn->TextModeOn; TextModeOn->Check
                        else
                        [* c.theText.modeOn *]
                        not TextModeOn->TextModeOn;
                        TextModeOn->Check;
                        false->p.parseErrorOccurred;
                        hit
                        if);*)
                   if);
                   
               if)
            else
               'Textediting on Group Page is currently disabled'->alertUser
           if)
        else
           'Open Subeditor not implemented on this type of page'->alertUser
       if)
    else
       'No current page'->alertUser
   if);
   
#)  

-- iEditOtherText: DoPart --
do
     (#
        thePage: ^Page;
        theOADPage: ^OADPage;
        theObjectPage: ^ObjectPage;
        theObject: ^thePage.DesignObject
     do
        currentPage->thePage[];
        (if thePage[] <> none then
            thePage.CurrentObject->theObject[];
            (if theObject[] <> none then
                (if thePage## <= OADPage## then
                    thePage[]->theOADPage[];
                    (if theObject## <= theOADPage.UserDataNode## then
                        'Can not be text edited using this command'->alertUser
                     else
                        (if theObject.theText.isModeOn then
                            theObject.theText.modeOff
                         else
                            theObject.theText.modeOn
                        if)
                    if)
                 else
                    (if thePage## <= ObjectPage## then
                        thePage[]->theObjectPage[];
                        (if theObject## <= theObjectPage.ObjectDiagramNode##
                         then
                            'Can not be text edited using this command'
                              ->alertUser
                         else
                            (if theObject.theText.isModeOn then
                                theObject.theText.modeOff
                             else
                                theObject.theText.modeOn
                            if)
                        if)
                     else
                        'Unknown type of page'->alertUser
                    if)
                if)
             else
                'No current object'->alertUser
            if)
         else
            'No current page'->alertUser
        if)
     #)  

-- iRevertTextEdit: Descriptor --
(#
   p: ^OADPage;
   c: ^p.DesignObject;
   thePatternDiagramNode: ^p.PatternDiagramNode;
   theListDiagram: ^p.ListDiagram;
   theAbstractNode: ^theListDiagram.AbstractNode;
   theDoc: ^OADdocument
do
   (if switch[1] then 'revert text edit'->putLine if);
   CurrentPage->p[];
   p.CurrentObject->c[];
   (if c[]
    // none then 
    else
       (if TextModeOn
        // true then
           false->p.ongoingTextediting;
           false->p.onGoingTitleEditing;
           false->p.parseErrorOccurred;
           p.theTextBefore->c.theText.set;
           c.theText.modeOff;
           (if c## <= p.PatternDiagramNode## then
               c[]->thePatternDiagramNode[];
               thePatternDiagramNode.theDiagram->theListDiagram[];
               (if thePatternDiagramNode## <= theListDiagram.AbstractNode## then
                   thePatternDiagramNode[]->theAbstractNode[];
                   (theAbstractNode.theText.oldWidth,
                    theAbstractNode.theText.oldHeight)->theAbstractNode.size
               if)
           if)
       if);
       theDocument[]->theDoc[];
       false->TextModeOn->theDoc.FrejaEditMenu.iTextedit.Check;
       
   if)
#)  

-- InsertAfterHit: Descriptor --
(#
   thePage: ^Page;
   theOADPage: ^OADPage;
   theObject: ^theOADPage.PatternDiagramNode;
   theDesObj: ^theOADPage.DesignObject;
   t: ^text;
   anAST: ^MPS.AST
do
   (if switch[1] then 'insertAfter'->putline if);
   currentPage->thePage[];
   (if thePage[] <> none then
       (if thePage## <= OADPage## then
           thePage[]->theOADPage[];
           theOADPage.CurrentObject->theDesObj[];
           (if theDesObj[] <> none then
               (if theDesObj## <= theOADPage.PatternDiagramNode## then
                   theDesObj[]->theObject[];
                   theObject.getASTNode->anAST[];
                   (if anAST[] <> none then
                       (anAST[],1)->(theObject.theSifEditor).changeFocus
                   if);
                   (if theOADPage.canListInsert then
                       (theObject.theSifEditor).after
                   if)
                else
                   'Current focus is not a pattern diagram node!'->putline
               if)
           if)
        else
           'Insert After not implemented on this type of page'->alertUser
       if)
    else
       'No current page'->alertUser
   if);
   
#)  

-- FrejaRemoveOptionalsItem: Descriptor --
(#
   thePage: ^Page;
   theOADPage: ^OADPage;
   theObject: ^theOADPage.PatternDiagramNode;
   theDesObj: ^theOADPage.DesignObject;
   t: ^text;
   anAST: ^MPS.AST
do
   (if switch[1] then 'removeOptionals'->putline if);
   currentPage->thePage[];
   (if thePage[] <> none then
       (if thePage## <= OADPage## then
           thePage[]->theOADPage[];
           theOADPage.CurrentObject->theDesObj[];
           (if theDesObj[] <> none then
               (if theDesObj## <= theOADPage.PatternDiagramNode## then
                   theDesObj[]->theObject[];
                   theObject.getASTNode->anAST[];
                   (if anAST[] <> none then
                       (anAST[],1)->(theObject.theSifEditor).changeFocus
                   if);
                   (theObject.theSifEditor).removeOptionals
                else
                   'Current focus is not a pattern diagram node!'->putline
               if)
           if)
        else
           'Remove Optionals not implemented on this type of page'->alertUser
       if)
    else
       'No current page'->alertUser
   if);
   
#)  

-- FrejaShowOptionalsItem: Descriptor --
(#
   thePage: ^Page;
   theOADPage: ^OADPage;
   theObject: ^theOADPage.PatternDiagramNode;
   theDesObj: ^theOADPage.DesignObject;
   t: ^text;
   anAST: ^MPS.AST
do
   (if switch[1] then 'insertOptionals'->putline if);
   currentPage->thePage[];
   (if thePage[] <> none then
       (if thePage## <= OADPage## then
           thePage[]->theOADPage[];
           theOADPage.CurrentObject->theDesObj[];
           (if theDesObj[] <> none then
               (if theDesObj## <= theOADPage.PatternDiagramNode## then
                   theDesObj[]->theObject[];
                   theObject.getASTNode->anAST[];
                   (if anAST[] <> none then
                       (anAST[],1)->(theObject.theSifEditor).changeFocus
                   if);
                   (theObject.theSifEditor).insertOptionals
                else
                   'Current focus is not a pattern diagram node!'->putline
               if)
           if)
        else
           'Show Optionals not implemented on this type of page'->alertUser
       if)
    else
       'No current page'->alertUser
   if);
   
#)  

-- FrejaCheckItem: Descriptor --
(#
   thePage: ^Page;
   theOADPage: ^OADPage;
   theObject: ^theOADPage.PatternDiagramNode;
   theDesObj: ^theOADPage.DesignObject;
   anAST: ^MPS.AST;
   fg: ^mps.fragmentGroup;
   theListDiagram: ^theOADPage.ListDiagram;
   theNonTerminalNode: ^theListDiagram.NonTerminalNode
do
   (if switch[1] then 'check'->putline if);
   currentPage->thePage[];
   (if thePage[] <> none then
       (if thePage## <= OADPage## then
           thePage[]->theOADPage[];
           theOADPage.CurrentObject->theDesObj[];
           (if theDesObj[] <> none then
               (if theDesObj## <= theOADPage.PatternDiagramNode## then
                   theDesObj[]->theObject[];
                   theObject.getASTNode->anAST[];
                   (if anAST[] <> none then
                       anAST.frag.father->fg[]
                    else
                       theObject.theDiagram->theListDiagram[];
                       theObject[]->theNonTerminalNode[];
                       (theNonTerminalNode.unexp).frag.father->fg[]
                   if);
                   fg[]->theController.globalSifCommands.check
                else
                   'Current focus is not a pattern diagram node!'->putline
               if)
           if)
        else
           'Check can not be invoked from this type of page'->alertUser
       if)
    else
       'No current page'->alertUser
   if);
   
#)  

-- CreateNewPage: Descriptor --
(# p: ^OADObjectPage; 
do
   &OADObjectPage[]->p[];
   p.new;
   CreatePassiveObject.enable;
   CreateMultipleObject.enable;
   CreateConcurrentObject.enable;
   CreateInteractionRelation.enable;
   CreateTwoWayInteractionRelation.enable;
   CreateDistributedInteractionRelation.enable;
   CreateTwoWayDistributedInteractionRelation.enable;
   
#)  

-- CreatePassiveObject: Descriptor --
(# p: ^Page; op: ^OADObjectPage; 
do
   'Create Passive hit'->screen.putline;
   CurrentPage->p[];
   (if p## <= OADObjectPage##
    // true then
       p[]->op[];
         (# pas: ^op.PassiveObject; 
         do
            &op.PassiveObject[]->pas[];
            'Create Passive Object'->pas.interactivenew;
            
         #);
       
    else
       'Cannot create Object on active page'->AlertUser; 
   if);
   
#)  

-- CreateMultipleObject: Descriptor --
(# p: ^Page; op: ^OADObjectPage; 
do
   'Create Multiple hit'->screen.putline;
   CurrentPage->p[];
   (if p## <= OADObjectPage##
    // true then
       p[]->op[];
         (# mult: ^op.MultipleObject; 
         do
            &op.MultipleObject[]->mult[];
            'Create Multiple Object'->mult.interactivenew;
            
         #);
       
    else
       'Cannot create Object on active page'->AlertUser; 
   if);
   
#)  

-- CreateConcurrentObject: Descriptor --
(# p: ^Page; op: ^OADObjectPage; 
do
   'Create Concurrent hit'->screen.putline;
   CurrentPage->p[];
   (if p## <= OADObjectPage##
    // true then
       p[]->op[];
         (# con: ^op.ConcurrentObject; 
         do
            &op.ConcurrentObject[]->con[];
            'Create Concurrent Object'->con.interactivenew;
            
         #);
       
    else
       'Cannot create Object on active page'->AlertUser; 
   if);
   
#)  

-- CreateInteractionRelation: Descriptor --
(# p: ^Page; op: ^OADObjectPage; 
do
   'Create Relation hit'->screen.putline;
   CurrentPage->p[];
   (if p## <= OADObjectPage##
    // true then
       p[]->op[];
         (# rel: ^op.InteractionRelation; 
         do
            &op.InteractionRelation[]->rel[];
            'Create Interaction Relation Between two Objects '
              ->rel.interactivenew;
            
         #);
       
    else
       'Cannot create Relation on active page'->AlertUser; 
   if);
   
#)  

-- CreateTwoWayInteractionRelation: Descriptor --
(# p: ^Page; op: ^OADObjectPage; 
do
   'Create Relation hit'->screen.putline;
   CurrentPage->p[];
   (if p## <= OADObjectPage##
    // true then
       p[]->op[];
         (# rel: ^op.TwoWayInteractionRelation; 
         do
            &op.TwoWayInteractionRelation[]->rel[];
            'Create Interaction Relation Between two Objects '
              ->rel.interactivenew;
            
         #);
       
    else
       'Cannot create Relation on active page'->AlertUser; 
   if);
   
#)  

-- CreateDistributedInteractionRelation: Descriptor --
(# p: ^Page; op: ^OADObjectPage; 
do
   'Create Relation hit'->screen.putline;
   CurrentPage->p[];
   (if p## <= OADObjectPage##
    // true then
       p[]->op[];
         (# rel: ^op.DistributedInteractionRelation; 
         do
            &op.DistributedInteractionRelation[]->rel[];
            'Create Interaction Relation Between two Objects '
              ->rel.interactivenew;
            
         #);
       
    else
       'Cannot create Relation on active page'->AlertUser; 
   if);
   
#)  

-- CreateTwoWayDistributedInteractionRelation: Descriptor --
(# p: ^Page; op: ^OADObjectPage; 
do
   'Create Relation hit'->screen.putline;
   CurrentPage->p[];
   (if p## <= OADObjectPage##
    // true then
       p[]->op[];
         (# rel: ^op.TwoWayDistributedInteractionRelation; 
         do
            &op.TwoWayDistributedInteractionRelation[]->rel[];
            'Create Interaction Relation Between two Objects '
              ->rel.interactivenew;
            
         #);
       
    else
       'Cannot create Relation on active page'->AlertUser; 
   if);
   
#)  

-- CreatePattern: Descriptor --
(# p: ^Page; op: ^OADObjectPage; 
do
   'Create Pattern hit'->screen.putline;
   CurrentPage->p[];
   (if p## <= OADObjectPage##
    // true then
       p[]->op[];
         (# pp: ^op.PatternPattern; 
         do &op.PatternPattern[]->pp[]; 'Create Pattern'->pp.interactivenew; 
         #);
       
    else
       'Cannot create Relation on active page'->AlertUser; 
   if);
   
#)  

-- CreatePatternPrefix: Descriptor --
(# p: ^Page; op: ^OADObjectPage; oad: ^OADPage; 
do
   'Create Pattern Prefix hit'->screen.putline;
   CurrentPage->p[];
   (if true
    // (p## <= OADObjectPage##) then
       
    // (p## <= OADPage##) then
       p[]->oad[]; oad.StartCreatePrefix; 
    else
       'Cannot create Relation on active page'->AlertUser; 
   if);
   
#)  

-- CreateVirtualPattern: Descriptor --
(# p: ^Page; op: ^OADObjectPage; 
do
   'Create Virtual hit'->screen.putline;
   CurrentPage->p[];
   (if p## <= OADObjectPage##
    // true then
       p[]->op[];
         (# vp: ^op.VirtualPattern; 
         do
            &op.VirtualPattern[]->vp[];
            'Create Virtual Pattern '->vp.interactivenew;
            
         #);
       
    else
       'Cannot create Relation on active page'->AlertUser; 
   if);
   
#)  

-- ObjectCreateMenuInit: Descriptor --
(# separator1: @Item; 
do
   (UserMenu5+1,'New Design Page')->CreateNewPage.init;
   (UserMenu5+2,'Object')->CreatePassiveObject.init;
   (UserMenu5+3,'Multiple Objects')->CreateMultipleObject.init;
   (UserMenu5+4,'Concurrent Object')->CreateConcurrentObject.init;
   (UserMenu5+6,'Interaction')->CreateInteractionRelation.init;
   (UserMenu5+7,'Two-way Interaction')->CreateTwoWayInteractionRelation.init;
   (UserMenu5+8,'Distributed Interaction')
     ->CreateDistributedInteractionRelation.init;
   (UserMenu5+9,'Two-way Distributed Interaction')
     ->CreateTwoWayDistributedInteractionRelation.init;
   (UserMenu5+10,'-')->separator1.init;
   separator1.disable;
   (UserMenu5+11,'Create Pattern')->CreatePattern.init;
   (UserMenu5+12,'Create Pattern Prefix')->CreatePatternPrefix.init;
   (UserMenu5+13,'Create Virtual Pattern')->CreateVirtualPattern.init;
   CreatePassiveObject.disable;
   CreateMultipleObject.disable;
   CreateConcurrentObject.disable;
   CreateInteractionRelation.disable;
   CreatePattern.disable;
   CreateVirtualPattern.disable;
   
#)  

-- ExpandMenuInit: Descriptor --
(# 
do
   (for i: noOfItems repeat
     &ExpandItem[]->theItems[i][];
     (UserMenu8+i,'                                 ')->theItems[i].init
   for)
#)  

-- ExpandMenuCreateItems: Descriptor --
(# tt,category: ^Text; aItem: ^ExpandItem; symbol,i: @Integer; 
do
   (if list[] <> none then
       (if list.length > 0 then
           (if theGraphicalInterface.switch[12] then
               'Freja: expandmenu.init: '->putText; list[]->putLine; 
           if);
           list.reset;
           list.getatom->tt[];
           (if tt[]
            // none then 
            else
               (if ('Enter'->tt.equal)
                // true then theexpandmenu.deletemenu; 
                else
                   list.reset;
                   1->i;
                   loop:
                   (if 1
                    // 1 then
                       list.getInt->symbol;
                       list.getAtom->category[];
                       (i,symbol,category[])->theItems[i].create;
                       (if list.pos+1 < list.length
                        // true then i+1->i; restart loop
                       if)
                   if)
               if)
           if)
       if)
   if)
#)  

-- ExpandItemCreate: Descriptor --
(# 
do
   (if (1->syncatname.inxget) = '-'
    // false then
       (if switch[1] then
           'Expand menu create: '->puttext;
           syncatno->putint;
           ' '->puttext;
           syncatname[]->putline
       if);
       (ItemNumber,syncatname,0)->DSMenuItemRename;
       
    // true then
       (ItemNumber,'--',0)->DSMenuItemRename; Disable; 
   if)
#)  

-- ExpandItemHit: Descriptor --
(# p: ^Page; op: ^OADPage; 
do
(* (if SynCatNo
 // 13 then
 'expanding to RepetitionDecl is not yet implemented!'->AlertUser
 else
 
 if); *)
   (if SynCatNo <> 0
    // true then
       currentpage->p[];
       (if p[] <> none
        // true then
           (if p## <= Palette##
            // true then 'CurrentPage is a Palette'->putline; 
            else
               (if switch[1] then
                   'Expand menu item hit: '->puttext;
                   SynCatNo->putint;
                   ' '->puttext;
                   synCatName[]->putline
               if);
               p[]->op[];
               (SynCatNo,false)->op.doExpand;
               
           if)
       if)
   if)
#)  

-- ExpandMenuDelete: Descriptor --
(# 
do
   (for i: noOfItems repeat
     (theItems[i].ItemNumber,' ',0)->DSMenuItemRename;
     0->theItems[i].synCatNo;
     none ->theItems[i].synCatName[]
   for)
#)  

-- AttributeKindMenuInit: Descriptor --
(# 
do
   (UserMenu9+1,'New pattern                       Alt-p')->NewPattern.init;
   (UserMenu9+2,'Local pattern                     Alt-h')->LocalPattern.init;
   (UserMenu9+3,'Part object                       Alt-o')->PartObject.init;
   (UserMenu9+4,'Dynamic reference                 Alt-r')
     ->DynamicReference.init;
   (UserMenu9+5,'Virtual pattern                   Alt-i')->VirtualPattern.init;
   (UserMenu9+6,'Binding of virtual pattern        Alt-m')
     ->BindingOfVirtualPattern.init;
   (UserMenu9+7,'Final binding of virtual pattern  Alt-f')
     ->FinalBindOfVirtPattern.init
#)  

-- AttributeKindMenuNewPattern: Descriptor --
(#
   theParentNode: ^op.PatternDiagramNode;
   anAST: ^MPS.AST;
   p: ^Page;
   op: ^OADPage;
   theDesignObject: ^op.DesignObject;
   theListDiagram: ^op.ListDiagram;
   theNonTerminalNode: ^theListDiagram.NonTerminalNode;
   optionalInserted: @boolean
do
   currentpage->p[];
   (if p[] <> none then
       (if p## <= OADPage## then
           p[]->op[];
           (if op.currentObject <> none then
               op.currentObject->theDesignObject[];
               (if theDesignObject## <= op.PatternDiagramNode## then
                   op.currentFocus[]->op.oldFocus[];
                   theDesignObject[]->op.currentFocus[]
               if)
            else
               'No current object'->alertUser
           if);
           (if op.currentFocus[] <> none then
               (if op.currentFocus.theDiagram <> none then
                   op.currentFocus.theDiagram->theListDiagram[];
                   getTopMostDiagram:
                     (# b1,b2: @Boolean
                     do
                        (theListDiagram## <= op.PatternAttDiagram##)->b1;
                        theListDiagram[]->theListDiagram.isDescriptorDiagram
                          ->b2;
                        (if b1 or b2 then
                            (if theListDiagram.LocalNodes.empty then
                                op.currentFocus.getASTNode->anAST[];
                                (if anAST[] <> none then
                                    (anAST[],1)
                                      ->
                                        (op.currentFocus.theSifEditor).
                                        changeFocus
                                if);
                                (op.currentFocus.theSifEditor).insertOptionals;
                                true->optionalInserted
                            if);
                            op.currentFocus[]->op.oldFocus[];
                            (theListDiagram.LocalNodes.last).elm[]
                              ->op.currentFocus[]->op.currentObject;
                            op.currentFocus.getASTNode->anAST[];
                            (if anAST[] <> none then
                                (anAST[],1)
                                  ->(op.currentFocus.theSifEditor).changeFocus
                             else
                                op.currentFocus.theDiagram->theListDiagram[];
                                op.currentFocus[]->theNonTerminalNode[];
                                (theNonTerminalNode.unExp,1)
                                  ->(op.currentFocus.theSifEditor).changeFocus
                            if);
                            (if op.canListInsert then
                                (if not optionalInserted then
                                    (op.currentFocus.theSifEditor).after
                                if);
                                betaGram.PatternDecl
                                  ->(op.currentFocus.theSifEditor).expandNormal;
                                op.currentFocus.detail;
                                FrejaEditMenu.iEditName.hit
                            if)
                         else
                            theListDiagram.theParentNode->theParentNode[];
                            (if theParentNode[] <> none then
                                theParentNode.theDiagram->theListDiagram[];
                                restart getTopMostDiagram
                            if)
                        if)
                     #)
                else
                   'NewPatternHit: theDiagram is NONE'->putline
               if)
            else
               'No current object'->alertUser
           if)
        else
           'New Pattern not possible on this type of page'->alertUser
       if)
    else
       'No current page'->alertUser
   if)
#)  

-- AttributeKindMenuPartObject: Descriptor --
(#
   theParentNode: ^op.PatternDiagramNode;
   anAST: ^MPS.AST;
   p: ^Page;
   op: ^OADPage;
   theDesignObject: ^op.DesignObject;
   theListDiagram: ^op.ListDiagram;
   theNonTerminalNode: ^theListDiagram.NonTerminalNode;
   optionalInserted: @boolean
do
   currentpage->p[];
   (if p[] <> none then
       (if p## <= OADPage## then
           p[]->op[];
           (if op.currentObject <> none then
               op.currentObject->theDesignObject[];
               (if theDesignObject## <= op.PatternDiagramNode## then
                   op.currentFocus[]->op.oldFocus[];
                   theDesignObject[]->op.currentFocus[]
               if)
            else
               'No current object'->alertUser
           if);
           (if op.currentFocus[] <> none then
               (if op.currentFocus.theDiagram <> none then
                   op.currentFocus.theDiagram->theListDiagram[];
                   (if theListDiagram.LocalNodes.empty then
                       op.currentFocus.getASTNode->anAST[];
                       (if anAST[] <> none then
                           (anAST[],1)
                             ->(op.currentFocus.theSifEditor).changeFocus
                       if);
                       (op.currentFocus.theSifEditor).insertOptionals;
                       true->optionalInserted
                   if);
                   op.currentFocus[]->op.oldFocus[];
                   (theListDiagram.LocalNodes.last).elm[]->op.currentFocus[]
                     ->op.currentObject;
                   op.currentFocus.getASTNode->anAST[];
                   (if anAST[] <> none then
                       (anAST[],1)->(op.currentFocus.theSifEditor).changeFocus
                    else
                       op.currentFocus.theDiagram->theListDiagram[];
                       op.currentFocus[]->theNonTerminalNode[];
                       (theNonTerminalNode.unExp,1)
                         ->(op.currentFocus.theSifEditor).changeFocus
                   if);
                   (if op.canListInsert then
                       (if not optionalInserted then
                           (op.currentFocus.theSifEditor).after
                       if);
                       betaGram.SimpleDecl
                         ->(op.currentFocus.theSifEditor).expandNormal;
                       betaGram.StaticItem
                         ->(op.currentFocus.theSifEditor).expandNormal
                   if)
                else
                   'theDiagram is NONE'->putline
               if)
            else
               'No current object'->alertUser
           if)
        else
           'Part Object not possible on this type of page'->alertUser
       if)
    else
       'No current page'->alertUser
   if)
#)  

-- AttributeKindMenuDynamicReference: Descriptor --
(#
   theParentNode: ^op.PatternDiagramNode;
   anAST: ^MPS.AST;
   p: ^Page;
   op: ^OADPage;
   theDesignObject: ^op.DesignObject;
   theListDiagram: ^op.ListDiagram;
   theNonTerminalNode: ^theListDiagram.NonTerminalNode;
   optionalInserted: @boolean
do
   currentpage->p[];
   (if p[] <> none then
       (if p## <= OADPage## then
           p[]->op[];
           (if op.currentObject <> none then
               op.currentObject->theDesignObject[];
               (if theDesignObject## <= op.PatternDiagramNode## then
                   op.currentFocus[]->op.oldFocus[];
                   theDesignObject[]->op.currentFocus[]
               if)
            else
               'No current object'->alertUser
           if);
           (if op.currentFocus[] <> none then
               (if op.currentFocus.theDiagram <> none then
                   op.currentFocus.theDiagram->theListDiagram[];
                   (if theListDiagram.LocalNodes.empty then
                       op.currentFocus.getASTNode->anAST[];
                       (if anAST[] <> none then
                           (anAST[],1)
                             ->(op.currentFocus.theSifEditor).changeFocus
                       if);
                       (op.currentFocus.theSifEditor).insertOptionals;
                       true->optionalInserted
                   if);
                   op.currentFocus[]->op.oldFocus[];
                   (theListDiagram.LocalNodes.last).elm[]->op.currentFocus[]
                     ->op.currentObject;
                   op.currentFocus.getASTNode->anAST[];
                   (if anAST[] <> none then
                       (anAST[],1)->(op.currentFocus.theSifEditor).changeFocus
                    else
                       op.currentFocus.theDiagram->theListDiagram[];
                       op.currentFocus[]->theNonTerminalNode[];
                       (theNonTerminalNode.unExp,1)
                         ->(op.currentFocus.theSifEditor).changeFocus
                   if);
                   (if op.canListInsert then
                       (if not optionalInserted then
                           (op.currentFocus.theSifEditor).after
                       if);
                       betaGram.SimpleDecl
                         ->(op.currentFocus.theSifEditor).expandNormal;
                       betaGram.DynamicItem
                         ->(op.currentFocus.theSifEditor).expandNormal
                   if)
                else
                   'theDiagram is NONE'->putline
               if)
            else
               'No current object'->alertUser
           if)
        else
           'Dynamic Reference not possible on this type of page'->alertUser
       if)
    else
       'No current page'->alertUser
   if)
#)  

-- AttributeKindMenuLocalPattern: Descriptor --
(#
   theParentNode: ^op.PatternDiagramNode;
   anAST: ^MPS.AST;
   p: ^Page;
   op: ^OADPage;
   theDesignObject: ^op.DesignObject;
   theListDiagram: ^op.ListDiagram;
   theNonTerminalNode: ^theListDiagram.NonTerminalNode;
   optionalInserted: @boolean
do
   currentpage->p[];
   (if p[] <> none then
       (if p## <= OADPage## then
           p[]->op[];
           (if op.currentObject <> none then
               op.currentObject->theDesignObject[];
               (if theDesignObject## <= op.PatternDiagramNode## then
                   op.currentFocus[]->op.oldFocus[];
                   theDesignObject[]->op.currentFocus[]
               if)
            else
               'No current object'->alertUser
           if);
           (if op.currentFocus[] <> none then
               (if op.currentFocus.theDiagram <> none then
                   op.currentFocus.theDiagram->theListDiagram[];
                   (if theListDiagram.LocalNodes.empty then
                       op.currentFocus.getASTNode->anAST[];
                       (if anAST[] <> none then
                           (anAST[],1)
                             ->(op.currentFocus.theSifEditor).changeFocus
                       if);
                       (op.currentFocus.theSifEditor).insertOptionals;
                       true->optionalInserted
                   if);
                   op.currentFocus[]->op.oldFocus[];
                   (theListDiagram.LocalNodes.last).elm[]->op.currentFocus[]
                     ->op.currentObject;
                   op.currentFocus.getASTNode->anAST[];
                   (if anAST[] <> none then
                       (anAST[],1)->(op.currentFocus.theSifEditor).changeFocus
                    else
                       op.currentFocus.theDiagram->theListDiagram[];
                       op.currentFocus[]->theNonTerminalNode[];
                       (theNonTerminalNode.unExp,1)
                         ->(op.currentFocus.theSifEditor).changeFocus
                   if);
                   (if op.canListInsert then
                       (if not optionalInserted then
                           (op.currentFocus.theSifEditor).after
                       if);
                       betaGram.PatternDecl
                         ->(op.currentFocus.theSifEditor).expandNormal;
                       op.currentFocus.detail;
                       FrejaEditMenu.iEditName.hit
                   if)
                else
                   'theDiagram is NONE'->putline
               if)
            else
               'No current object'->alertUser
           if)
        else
           'Local Pattern not possible on this type of page'->alertUser
       if)
    else
       'No current page'->alertUser
   if)
#)  

-- AttributeKindMenuVirtualPattern: Descriptor --
(#
   theParentNode: ^op.PatternDiagramNode;
   anAST: ^MPS.AST;
   p: ^Page;
   op: ^OADPage;
   theDesignObject: ^op.DesignObject;
   theListDiagram: ^op.ListDiagram;
   theNonTerminalNode: ^theListDiagram.NonTerminalNode;
   optionalInserted: @boolean
do
   currentpage->p[];
   (if p[] <> none then
       (if p## <= OADPage## then
           p[]->op[];
           (if op.currentObject <> none then
               op.currentObject->theDesignObject[];
               (if theDesignObject## <= op.PatternDiagramNode## then
                   op.currentFocus[]->op.oldFocus[];
                   theDesignObject[]->op.currentFocus[]
               if)
            else
               'No current object'->alertUser
           if);
           (if op.currentFocus[] <> none then
               (if op.currentFocus.theDiagram <> none then
                   op.currentFocus.theDiagram->theListDiagram[];
                   (if theListDiagram.LocalNodes.empty then
                       op.currentFocus.getASTNode->anAST[];
                       (if anAST[] <> none then
                           (anAST[],1)
                             ->(op.currentFocus.theSifEditor).changeFocus
                       if);
                       (op.currentFocus.theSifEditor).insertOptionals;
                       true->optionalInserted
                   if);
                   op.currentFocus[]->op.oldFocus[];
                   (theListDiagram.LocalNodes.last).elm[]->op.currentFocus[]
                     ->op.currentObject;
                   op.currentFocus.getASTNode->anAST[];
                   (if anAST[] <> none then
                       (anAST[],1)->(op.currentFocus.theSifEditor).changeFocus
                    else
                       op.currentFocus.theDiagram->theListDiagram[];
                       op.currentFocus[]->theNonTerminalNode[];
                       (theNonTerminalNode.unExp,1)
                         ->(op.currentFocus.theSifEditor).changeFocus
                   if);
                   (if op.canListInsert then
                       (if not optionalInserted then
                           (op.currentFocus.theSifEditor).after
                       if);
                       betaGram.VirtualDecl
                         ->(op.currentFocus.theSifEditor).expandNormal
                   if)
                else
                   'theDiagram is NONE'->putline
               if)
            else
               'No current object'->alertUser
           if)
        else
           'Virtual Pattern not possible on this type of page'->alertUser
       if)
    else
       'No current page'->alertUser
   if)
#)  

-- AttributeKindMenuBindingOfVirtualPattern: Descriptor --
(#
   theParentNode: ^op.PatternDiagramNode;
   anAST: ^MPS.AST;
   p: ^Page;
   op: ^OADPage;
   theDesignObject: ^op.DesignObject;
   theListDiagram: ^op.ListDiagram;
   theNonTerminalNode: ^theListDiagram.NonTerminalNode;
   optionalInserted: @boolean
do
   currentpage->p[];
   (if p[] <> none then
       (if p## <= OADPage## then
           p[]->op[];
           (if op.currentObject <> none then
               op.currentObject->theDesignObject[];
               (if theDesignObject## <= op.PatternDiagramNode## then
                   op.currentFocus[]->op.oldFocus[];
                   theDesignObject[]->op.currentFocus[]
               if)
            else
               'No current object'->alertUser
           if);
           (if op.currentFocus[] <> none then
               (if op.currentFocus.theDiagram <> none then
                   op.currentFocus.theDiagram->theListDiagram[];
                   (if theListDiagram.LocalNodes.empty then
                       op.currentFocus.getASTNode->anAST[];
                       (if anAST[] <> none then
                           (anAST[],1)
                             ->(op.currentFocus.theSifEditor).changeFocus
                       if);
                       (op.currentFocus.theSifEditor).insertOptionals;
                       true->optionalInserted
                   if);
                   op.currentFocus[]->op.oldFocus[];
                   (theListDiagram.LocalNodes.last).elm[]->op.currentFocus[]
                     ->op.currentObject;
                   op.currentFocus.getASTNode->anAST[];
                   (if anAST[] <> none then
                       (anAST[],1)->(op.currentFocus.theSifEditor).changeFocus
                    else
                       op.currentFocus.theDiagram->theListDiagram[];
                       op.currentFocus[]->theNonTerminalNode[];
                       (theNonTerminalNode.unExp,1)
                         ->(op.currentFocus.theSifEditor).changeFocus
                   if);
                   (if op.canListInsert then
                       (if not optionalInserted then
                           (op.currentFocus.theSifEditor).after
                       if);
                       betaGram.BindingDecl
                         ->(op.currentFocus.theSifEditor).expandNormal
                   if)
                else
                   'theDiagram is NONE'->putline
               if)
            else
               'No current object'->alertUser
           if)
        else
           'Binding of Virtual Pattern not possible on this type of page'
             ->alertUser
       if)
    else
       'No current page'->alertUser
   if)
#)  

-- AttributeKindMenuFinalBindOfVirtPattern: Descriptor --
(#
   theParentNode: ^op.PatternDiagramNode;
   anAST: ^MPS.AST;
   p: ^Page;
   op: ^OADPage;
   theDesignObject: ^op.DesignObject;
   theListDiagram: ^op.ListDiagram;
   theNonTerminalNode: ^theListDiagram.NonTerminalNode;
   optionalInserted: @boolean
do
   currentpage->p[];
   (if p[] <> none then
       (if p## <= OADPage## then
           p[]->op[];
           (if op.currentObject <> none then
               op.currentObject->theDesignObject[];
               (if theDesignObject## <= op.PatternDiagramNode## then
                   op.currentFocus[]->op.oldFocus[];
                   theDesignObject[]->op.currentFocus[]
               if)
            else
               'No current object'->alertUser
           if);
           (if op.currentFocus[] <> none then
               (if op.currentFocus.theDiagram <> none then
                   op.currentFocus.theDiagram->theListDiagram[];
                   (if theListDiagram.LocalNodes.empty then
                       op.currentFocus.getASTNode->anAST[];
                       (if anAST[] <> none then
                           (anAST[],1)
                             ->(op.currentFocus.theSifEditor).changeFocus
                       if);
                       (op.currentFocus.theSifEditor).insertOptionals;
                       true->optionalInserted
                   if);
                   op.currentFocus[]->op.oldFocus[];
                   (theListDiagram.LocalNodes.last).elm[]->op.currentFocus[]
                     ->op.currentObject;
                   op.currentFocus.getASTNode->anAST[];
                   (if anAST[] <> none then
                       (anAST[],1)->(op.currentFocus.theSifEditor).changeFocus
                    else
                       op.currentFocus.theDiagram->theListDiagram[];
                       op.currentFocus[]->theNonTerminalNode[];
                       (theNonTerminalNode.unExp,1)
                         ->(op.currentFocus.theSifEditor).changeFocus
                   if);
                   (if op.canListInsert then
                       (if not optionalInserted then
                           (op.currentFocus.theSifEditor).after
                       if);
                       betaGram.FinalDecl
                         ->(op.currentFocus.theSifEditor).expandNormal
                   if)
                else
                   'theDiagram is NONE'->putline
               if)
            else
               'No current object'->alertUser
           if)
        else
           'Final Binding of Virtual Pattern not possible on this type of page'
             ->alertUser
       if)
    else
       'No current page'->alertUser
   if)
#)  

-- RelationsMenuDynamicItem: Descriptor --
(# p: ^Page; op: ^OADPage; theConnector: ^op.DynamicItemConnector
do
   currentpage->p[];
   (if p[] <> none then
       (if p## <= OADPage## then
           p[]->op[];
           &op.DynamicItemConnector[]->theConnector[];
           theConnector.InteractiveNew
        else
           'Dynamic Item not possible on this type of page'->alertUser
       if)
    else
       'No current page'->alertUser
   if)
#)  

-- RelationsMenuDynamicComponent: Descriptor --
(# p: ^Page; op: ^OADPage; theConnector: ^op.DynamicComponentConnector
do
   currentpage->p[];
   (if p[] <> none then
       (if p## <= OADPage## then
           p[]->op[];
           &op.DynamicComponentConnector[]->theConnector[];
           theConnector.InteractiveNew
        else
           'Dynamic Component not possible on this type of page'->alertUser
       if)
    else
       'No current page'->alertUser
   if)
#)  

-- RelationsMenuStaticItem: Descriptor --
(# p: ^Page; op: ^OADPage; theConnector: ^op.StaticItemConnector
do
   currentpage->p[];
   (if p[] <> none then
       (if p## <= OADPage## then
           p[]->op[];
           &op.StaticItemConnector[]->theConnector[];
           theConnector.InteractiveNew
        else
           'Static Item not possible on this type of page'->alertUser
       if)
    else
       'No current page'->alertUser
   if)
#)  

-- RelationsMenuStaticComponent: Descriptor --
(# p: ^Page; op: ^OADPage; theConnector: ^op.StaticComponentConnector
do
   currentpage->p[];
   (if p[] <> none then
       (if p## <= OADPage## then
           p[]->op[];
           &op.StaticComponentConnector[]->theConnector[];
           theConnector.InteractiveNew
        else
           'Static Component not possible on this type of page'->alertUser
       if)
    else
       'No current page'->alertUser
   if)
#)  

-- RelationsMenuSpecialization: Descriptor --
(# p: ^Page; op: ^OADPage; theConnector: ^op.SpecializationConnector
do
   currentpage->p[];
   (if p[] <> none then
       (if p## <= OADPage## then
           p[]->op[];
           &op.SpecializationConnector[]->theConnector[];
           theConnector.InteractiveNew
        else
           'Specialization not possible on this type of page'->alertUser
       if)
    else
       'No current page'->alertUser
   if)
#)  

-- RelationsMenuBind: Descriptor --
(# p: ^Page; op: ^OADPage; theConnector: ^op.BindingConnector
do
   currentpage->p[];
   (if p[] <> none then
       (if p## <= OADPage## then
           p[]->op[];
           &op.BindingConnector[]->theConnector[];
           theConnector.InteractiveNew
        else
           'Binding of Virtual not possible on this type of page'->alertUser
       if)
    else
       'No current page'->alertUser
   if)
#)  

-- RelationsMenuFinal: Descriptor --
(# p: ^Page; op: ^OADPage; theConnector: ^op.FinalBindingConnector
do
   currentpage->p[];
   (if p[] <> none then
       (if p## <= OADPage## then
           p[]->op[];
           &op.FinalBindingConnector[]->theConnector[];
           theConnector.InteractiveNew
        else
           'Final Binding of Virtual not possible on this type of page'
             ->alertUser
       if)
    else
       'No current page'->alertUser
   if)
#)  

-- RelationsMenuPattern: Descriptor --
(# p: ^Page; op: ^OADPage; theConnector: ^op.PatternVariableConnector
do
   currentpage->p[];
   (if p[] <> none then
       (if p## <= OADPage## then
           p[]->op[];
           &op.PatternVariableConnector[]->theConnector[];
           theConnector.InteractiveNew
        else
           'Pattern Variable not possible on this type of page'->alertUser
       if)
    else
       'No current page'->alertUser
   if)
#)  

-- RelationsMenuOTOHit: Descriptor --
(# p: ^Page; op: ^OADPage; theConnector: ^op.OTOAssociationRelation
do
   currentpage->p[];
   (if p[] <> none then
       (if p## <= OADPage## then
           p[]->op[];
           &op.OTOAssociationRelation[]->theConnector[];
           theConnector.InteractiveNew
        else
           'One-to-one association not possible on this type of page'->alertUser
       if)
    else
       'No current page'->alertUser
   if)
#)  

-- RelationsMenuOTMHit: Descriptor --
(# p: ^Page; op: ^OADPage; theConnector: ^op.OTMAssociationRelation
do
   currentpage->p[];
   (if p[] <> none then
       (if p## <= OADPage## then
           p[]->op[];
           &op.OTMAssociationRelation[]->theConnector[];
           theConnector.InteractiveNew
        else
           'One-to-many association not possible on this type of page'
             ->alertUser
       if)
    else
       'No current page'->alertUser
   if)
#)  

-- RelationsMenuMTMHit: Descriptor --
(# p: ^Page; op: ^OADPage; theConnector: ^op.MTMAssociationRelation
do
   currentpage->p[];
   (if p[] <> none then
       (if p## <= OADPage## then
           p[]->op[];
           &op.MTMAssociationRelation[]->theConnector[];
           theConnector.InteractiveNew
        else
           'Many-to-many association not possible on this type of page'
             ->alertUser
       if)
    else
       'No current page'->alertUser
   if)
#)  

-- RealtionsMenuSelfAssociateHit: DoPart --
do
     (#
        p: ^Page;
        op: ^OADPage;
        theObject: ^op.DesignObject;
        thePatternDiagramNode: ^op.PatternDiagramNode;
        theListDiagram: ^op.ListDiagram;
        theOADDiagram: ^op.OADDiagram;
        theDesc: ^betaGram.ObjectDescriptor;
        anAST,testAST: ^mps.ast
     do
        currentpage->p[];
        (if p[] <> none then
            (if p## <= OADPage## then
                p[]->op[];
                op.currentObject->theObject[];
                (if theObject[] <> none then
                    (if theObject## <= op.PatternDiagramNode## then
                        theObject[]->thePatternDiagramNode[];
                        thePatternDiagramNode.theDiagram->theListDiagram[];
                        (if theListDiagram## <= op.FragmentDiagram## then
                            'Current diagram is a fragment diagram'->AlertUser
                         else
                            (if theListDiagram## <= op.PatternAttDiagram## then
                                'Current diagram is an attributes form diagram'
                                  ->AlertUser
                             else
                                theListDiagram[]->theOADDiagram[];
                                theOADDiagram.theDescriptor->theDesc[];
                                theDesc.father->anAST[];
                                anAST.father->testAST[];
                                (if testAST[] <> none then
                                    (if anAST.symbol <> betaGram.StaticItem then
                                        (if thePatternDiagramNode## <=
                                        theListDiagram.titleNode## then
                                            &selfAssociateWindow[]->theWindow[];
                                            theWindow.popup
                                         else
                                            'Please select the title of the diagram\nto perform this operation'
                                              ->alertUser
                                        if)
                                     else
                                        'Current diagram is singularly defined'
                                          ->AlertUser
                                    if)
                                 else
                                    'Current diagram is a descriptor form diagram'
                                      ->AlertUser
                                if)
                            if)
                        if)
                     else
                        'Current selection must be the title of a diagram'
                          ->alertUser
                    if)
                 else
                    'No selection'->alertUser
                if)
             else
                'Associate to Self not possible on this type of page'->alertUser
            if)
         else
            'No current page'->alertUser
        if);
        
     #)  

-- RelationsMenuInit: Descriptor --
(# 
do
   (UserMenu6+1,'Static reference')->StaticItem.init;
   (UserMenu6+2,'Static component reference')->StaticComponent.init;
   (UserMenu6+3,'Dynamic reference')->DynamicItem.init;
   (UserMenu6+4,'Dynamic component reference')->DynamicComponent.init;
   (UserMenu6+5,'-')->sep.init;
   (UserMenu6+7,'Specialization')->Specialization.Init;
   (UserMenu6+8,'Binding of Virtual')->bind.Init;
   (UserMenu6+9,'Final Binding of Virtual')->final.Init;
   (UserMenu6+10,'-')->sep1.init;
   (UserMenu6+11,'Pattern Variable')->pattern.Init;
   (UserMenu6+12,'-')->sep2.init;
   (UserMenu6+13,'One-to-One')->oto.init;
   (UserMenu6+14,'One-to-Many')->otm.init;
   (UserMenu6+15,'Many-to-Many')->mtm.init;
   (UserMenu6+16,'Associate to Self')->selfAssociate.init;
   sep.disable;
   sep1.disable;
   sep2.disable
#)  

-- frejaSearchItemDesc: DoPart --
do
   (if switch[1] then 'search'->putline if);
   currentPage->thePage[];
   (if thePage[] <> none then
       (if thePage## <= OADPage## then
           thePage[]->theOADPage[];
           theOADPage.CurrentObject->theDesObj[];
           (if theDesObj[] <> none then
               (if theDesObj## <= theOADPage.PatternDiagramNode## then
                   theDesObj[]->theObject[];
                   (if theObject.theSifEditor <> none then
                       (theObject.theSifEditor).search
                    else
                       'Please select title or attribute in a fragmentform'
                         ->alertUser
                   if)
                else
                   'Current focus is not a pattern diagram node!'->putline
               if)
           if)
        else
           'Search not implemented on this type of page'->alertUser
       if)
    else
       'No current page'->alertUser
   if);
     

-- FrejaLayputPreferencesDesc: DoPart --
do layoutPreferencesDialog.popup  

-- FrejaViewMenuInit: Descriptor --
(#  do (* (UserMenu4+24,'Dump SifEditorList')->DumpSifEditorList.init*)  #)  

