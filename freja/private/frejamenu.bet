ORIGIN '../freja';
INCLUDE 'frejabody';
-- FrejaFileMenuNewBETAProgram: Descriptor --
(# t: ^text
do
   (if switch[1] then 'Freja: Create a new fragment'->putline if);
   (if theDocument[]
    // none then
       &OADDocument[]->theDocument[]->theOADDocument[];
       theDocument.new;
       theOADDocument.CurrentPage->theOADDocument.theWorkPage[];
       'WorkSheet'->theOADDocument.theWorkPage.PageTitle;
       &theOADDocument.OADPage[]->theOADDocument.theGroupPage[];
       theOADDocument.theGroupPage.InvisibleNew;
       theOADDocument.theWorkPage[]->theOADDocument.CurrentPage;
       'Group Window'->theOADDocument.theGroupPage.PageTitle;
       
   if);
   ('Enter file name:','')
     ->FrejaPromptForText
       (#
          confirm::< 
            (# 
            do
               '#0newBETAProgram '->t[];
               theText[]->t.append;
               (if currentDiagramName[] = none then
                   theText[]->currentDiagramName[];
                   '.diag'->currentDiagramName.append
               if);
               t[]->theController.sendSifCommand
            #)
       #)
#)  

-- FrejaFileMenuNewBETALibrary: Descriptor --
(# t: ^text
do
   (if switch[1] then 'Freja: Create a new fragment'->putline if);
   (if theDocument[]
    // none then
       &OADDocument[]->theDocument[]->theOADDocument[];
       theDocument.new;
       theOADDocument.CurrentPage->theOADDocument.theWorkPage[];
       'WorkSheet'->theOADDocument.theWorkPage.PageTitle;
       &theOADDocument.OADPage[]->theOADDocument.theGroupPage[];
       theOADDocument.theGroupPage.InvisibleNew;
       theOADDocument.theWorkPage[]->theOADDocument.CurrentPage;
       'Group Window'->theOADDocument.theGroupPage.PageTitle;
       
   if);
   ('Enter file name:','')
     ->FrejaPromptForText
       (#
          confirm::< 
            (# 
            do
               '#0newBETALib '->t[];
               theText[]->t.append;
               (if currentDiagramName[] = none then
                   theText[]->currentDiagramName[];
                   '.diag'->currentDiagramName.append
               if);
               t[]->theController.sendSifCommand
            #)
       #)
#)  

-- FrejaFileMenuQuit: Descriptor --
(#
   ok: @Boolean;
   frejaFile,autosaveFrejaFile,diagFile,autosaveDiagFile: @file;
   groupFile,autosaveGroupFile: @file;
   groupName,frejaFileName,autoSaveFrejaFileName,help: ^text;
   doNotSave,askSave: @boolean
do
   'Consistency check failure!'->help[];
   'Quit Freja?'->DSUIGetUserYesOrNo->ok->doQuit;
   (if ok then
       (if currentDiagramName[] <> none then
           currentDiagramName[]->diagFile.name;
           '#'->currentDiagramName.copyAppend->autosaveDiagFile.name;
           (* '~'->currentDiagramName.copyAppend->tildeDiagFile.name;*)
           (if switch[17] then
               'Freja FrejaFileMenuQuit:'->putLine;
               diagFile.name->putLine;
               autosaveDiagFile.name->putLine;
               (*tildeDiagFile.name->putLine*)
               
           if);
           (if autosaveDiagFile.entry.exists then
               (if diagFile.entry.exists then
                   (if autosaveDiagFile.entry.modtime > diagFile.entry.modtime
                    then (* the diagram has been modified *)
                       true->askSave
                    else
                       true->doNotSave
                   if)
                else
                   true->askSave
               if);
               (if askSave then
                   'Save Current Diagram?'->DSUIGetUserYesOrNo->ok;
                   (if ok then Save.hit else true->doNotSave if)
                else
                   true->doNotSave
               if)
            else
               true->doNotSave
           if);
           (if doNotSave then
               currentDiagramName.copy->groupName[];
               groupName->removeExtension->groupName;
               '.freja'->groupName.copyAppend->frejaFileName[]->frejaFile.name;
               '.freja#'->groupName.copyAppend->autosaveFrejaFileName[]
                 ->autosaveFrejaFile.name;
               (*'.freja~'->groupName.copyAppend->tildeFrejaFileName[]
                ->tildeFrejaFile.name;*)
               (if autosaveFrejaFile.entry.exists then
                   autosaveFrejaFileName
                     ->scanAstFiles
                       (# 
                       do
                          currentGroupName->groupName;
                          '.ast'->groupName.append;
                          groupName[]->groupFile.name;
                          '#'->groupName.copyAppend->autosaveGroupFile.name;
                          (*'~'->groupName.copyAppend
                           ->tildeGroupFile.name;*)
                          (if switch[17] then
                              groupName[]->putLine;
                              autosaveGroupFile.name->putLine;
                              (* tildeGroupFile.name->putLine*)
                              
                          if);
                          (if autosaveGroupFile.entry.exists then
                              'rm .ast#'->putLine; autosaveGroupFile.delete
                          if)
                          (* no not anymore 
                           (if tildeGroupFile.entry.exists and
                           groupFile.entry.exists then
                           'mv .ast~ .ast'->putLine;
                           groupFile.name
                           ->tildeGroupFile.entry.rename
                           if)
                           *)
                       #);
                   (* no not anymore
                    (if tildeFrejaFile.entry.exists then
                    'mv .freja~ .freja'->putLine;
                    frejaFile.name->tildeFrejaFile.entry.rename
                    else
                    'No .freja~ file!!'->putLine
                    if);
                    *)
                   (if autosaveDiagFile.entry.exists then
                       'rm .diag#'->putLine; autoSaveDiagFile.delete
                   if);
                   'rm .freja#'->putLine;
                   autosaveFrejaFile.delete
               if);
               (normal,' ')->stop
           if)
        else
           (normal,' ')->stop
       if)
   if)
#)
(*
 -- FrejaOptionsMenuInit: Descriptor --
 (#  do (UserMenu3+13,'With Dexter')->WithDexterItem.init;  #)  
 
 -- FrejaOptionsMenuCheckMarks: Descriptor --
 (#  do withDexter->WithDexterItem.check #)  
 *)  

-- EditorMenuInit: Descriptor --
(# 
do
   (UserMenu2+1,'Show code in Sif')->ShowCodeItem.init;
   (UserMenu2+2,'New BETA Program')->NewProgramItem.init;
   (UserMenu2+3,'New BETA Library')->NewLibraryItem.init;
   (UserMenu2+4,'Check diagram')->CheckItem.init;
   (UserMenu2+5,'-')->sep.init;
   (UserMenu2+6,'Send Command...')->SendCommandItem.init;
   (UserMenu2+7,'Show Sif Selection')->SelectItem.init;
   (UserMenu2+8,'Turn off communication with Sif')->OffCommItem.init;
   sep.disable;
   true->ShowSIFSelection;
   
#)  

-- OffCommHit: Descriptor --
(# status: @Text;  do '#0 off'->theController.sendSifCommand;  #)  

-- SendCommandHit: Descriptor --
(# status: @Text; prompt: [1] @char; answer: [64] @Char; t: @Text; 
do
   'Type a command for Sif, no CRs please!'->prompt;
   (if (prompt,@@ answer[1])->DSUIGetString
    // true then
       @@ answer[1]->cStringToCharRep->t; t[]->theController.sendSifCommand; 
   if);
   
#)
(*
 -- WithDexterHit: Descriptor --
 (#  do not WithDexter->WithDexter->Check #)  
 *)  

-- SelectItem: Descriptor --
(# 
do not ShowSIFSelection->ShowSIFSelection->Check; (* and set checkmark *) 
#)  

-- FrejaUndoItem: Descriptor --
(#
   thePage: ^OADPage;
   theObject: ^thePage.DesignObject;
   theNode: ^thePage.PatternDiagramNode;
   anAST: ^MPS.AST;
   t: ^Text
do
   currentPage->thePage[];
   (if thePage.canUndo then
       thePage.CurrentObject->theObject[];
       (if theObject## <= thePage.PatternDiagramNode## then
           theObject[]->theNode[];
           '#'->t[];
           theNode.SifEditorInstanceNo->t.putint;
           ' undo'->t.puttext;
           t[]->theController.sendSifCommand
       if)
   if)
#)  

-- FrejaUndoGraphicalOperationItem: Descriptor --
(#  do menuID.EditMenu.undo->DSUIMenuExecute #)  

-- FrejaCutItem: Descriptor --
(#
   thePage: ^OADPage;
   theObject: ^thePage.DesignObject;
   theNode: ^thePage.PatternDiagramNode;
   theListDiagram: ^thePage.ListDiagram;
   thePatternNode: ^theListDiagram.PatternNode;
   deletableConnector: ^thePage.DeletableConnector;
   anAST: ^MPS.AST;
   t: ^Text
do
   currentPage->thePage[];
   thePage.CurrentObject->theObject[];
   (if theObject[] <> none then
       (if theObject## <= thePage.PatternDiagramNode## then
           theObject[]->theNode[];
           theNode.theDiagram->theListDiagram[];
           (if theNode## <= theListDiagram.PatternNode## then
               theNode[]->thePatternNode[];
               (if thePatternNode.theAssociationNode <> none then
                   (thePatternNode.theAssociationNode).delete
               if)
           if);
           theNode.getASTNode->anAST[];
           (if anAST[] <> none then
               true->thePage.private.performingCut;
               true->thePage.private.doOADPaste;
               (theNode.SifEditorInstanceNo,anAST.index)->changeASTFocus
            else
               true->thePage.private.doOADPaste;
               '#'->t[];
               theNode.SifEditorInstanceNo->t.putint;
               ' cut'->t.puttext;
               t[]->theController.sendSifCommand
           if)
        else
           (if theObject## <= thePage.DeletableConnector## then
               'Relations cannot be cut - use clear instead'->GppAlert
            else
               (if theObject## <= thePage.AssociationNode## then
                   'Relations cannot be cut - use clear instead'->GppAlert
                else
                   false->thePage.private.doOADPaste;
                   menuID.EditMenu.cut->DSUIMenuExecute;
                   FrejaEditMenu.iPaste.enable
               if)
           if)
       if)
    else
       false->thePage.private.doOADPaste; menuID.EditMenu.cut->DSUIMenuExecute
   if)
#)  

-- FrejaCopyItem: Descriptor --
(#
   thePage: ^OADPage;
   theObject: ^thePage.DesignObject;
   theNode: ^thePage.PatternDiagramNode;
   anAST: ^MPS.AST;
   t: ^Text
do
   currentPage->thePage[];
   thePage.CurrentObject->theObject[];
   (if theObject[] <> none then
       (if theObject## <= thePage.PatternDiagramNode## then
           theObject[]->theNode[];
           theNode.getASTNode->anAST[];
           (if anAST[] <> none then
               true->thePage.private.performingCopy;
               true->thePage.private.doOADPaste;
               (theNode.SifEditorInstanceNo,anAST.index)->changeASTFocus
            else
               true->thePage.private.doOADPaste;
               '#'->t[];
               theNode.SifEditorInstanceNo->t.putint;
               ' copy'->t.puttext;
               t[]->theController.sendSifCommand
           if)
        else
           false->thePage.private.doOADPaste;
           menuID.EditMenu.copy->DSUIMenuExecute
       if)
    else
       false->thePage.private.doOADPaste; menuID.EditMenu.copy->DSUIMenuExecute
   if)
#)  

-- FrejaPasteBeforeItem: Descriptor --
(#
   thePage: ^OADPage;
   theObject: ^thePage.DesignObject;
   theNode: ^thePage.PatternDiagramNode;
   anAST: ^MPS.AST;
   t: ^Text
do
   currentPage->thePage[];
   thePage.CurrentObject->theObject[];
   (if theObject[] <> none then
       (if theObject## <= thePage.PatternDiagramNode## then
           theObject[]->theNode[];
           theNode.getASTNode->anAST[];
           (if anAST[] <> none then
               true->thePage.private.performingPasteBefore;
               (theNode.SifEditorInstanceNo,anAST.index)->changeASTFocus
            else
               (if thePage.canListInsert
                // true then
                   '#'->t[];
                   theNode.SifEditorInstanceNo->t.putint;
                   ' pasteBefore'->t.puttext;
                   t[]->theController.sendSifCommand;
                   
               if)
           if)
       if)
    else
       'No current object!'->putline
   if)
#)  

-- FrejaPasteItem: Descriptor --
(#
   thePage: ^OADPage;
   theObject: ^thePage.DesignObject;
   theNode: ^thePage.PatternDiagramNode;
   anAST: ^MPS.AST;
   t: ^Text
do
   currentPage->thePage[];
   thePage.CurrentObject->theObject[];
   (if thePage.private.doOADPaste then
       (if theObject[] <> none then
           (if theObject## <= thePage.PatternDiagramNode## then
               (if thePage.canPaste then
                   theObject[]->theNode[];
                   theNode.getASTNode->anAST[];
                   (if anAST[] <> none then
                       true->thePage.private.performingPaste;
                       (theNode.SifEditorInstanceNo,anAST.index)->changeASTFocus
                    else
                       '#'->t[];
                       theNode.SifEditorInstanceNo->t.putint;
                       ' paste'->t.puttext;
                       t[]->theController.sendSifCommand
                   if)
               if)
           if)
        else
           'No current object!'->putline
       if)
    else
       menuID.EditMenu.paste->DSUIMenuExecute
   if)
#)  

-- FrejaPasteAfterItem: Descriptor --
(#
   thePage: ^OADPage;
   theObject: ^thePage.DesignObject;
   theNode: ^thePage.PatternDiagramNode;
   anAST: ^MPS.AST;
   t: ^Text
do
   currentPage->thePage[];
   thePage.CurrentObject->theObject[];
   (if theObject[] <> none then
       (if theObject## <= thePage.PatternDiagramNode## then
           theObject[]->theNode[];
           theNode.getASTNode->anAST[];
           (if anAST[] <> none then
               true->thePage.private.performingPasteAfter;
               (theNode.SifEditorInstanceNo,anAST.index)->changeASTFocus
            else
               (if thePage.canListInsert
                // true then
                   '#'->t[];
                   theNode.SifEditorInstanceNo->t.putint;
                   ' pasteAfter'->t.puttext;
                   t[]->theController.sendSifCommand;
                   
               if)
           if)
       if)
    else
       'No current object!'->putline
   if)
#)  

-- FrejaClearItem: Descriptor --
(#
   thePage: ^OADPage;
   theObject: ^thePage.DesignObject;
   theNode,thePatternNode: ^thePage.PatternDiagramNode;
   theAssociationNode: ^thePage.AssociationNode;
   deletableConnector: ^thePage.DeletableConnector;
   regionList: ^ObjectList;
   anAST: ^MPS.AST;
   t: ^Text
do
   currentPage->thePage[];
   thePage.CurrentObject->theObject[];
   (if theObject[] <> none then
       (if theObject## <= thePage.PatternDiagramNode## then
           'Nodes in pattern diagrams can currently not be cleared, only cut'
             ->GppAlert
        else
           (if theObject## <= thePage.DeletableConnector## then
               theObject[]->deletableConnector[]; deletableConnector.onDelete
           if);
           (if theObject## <= thePage.AssociationNode## then
               theObject[]->theAssociationNode[];
               (if theAssociationNode.thePatternNode <> none then
                   theAssociationNode.thePatternNode->thePatternNode[]
               if);
               theObject.getRegionList->regionList[];
               (if regionList[] <> none then
                   regionList.scan
                     (# anObj: ^thePage.DesignObject
                     do current[]->anObj[]; anObj.unmakeRegion
                     #)
               if);
               theObject.delete;
               (if thePatternNode[] <> none then
                   thePatternNode[]->thePage.currentObject;
                   thePatternNode.getASTNode->anAST[];
                   (if anAST[] <> none then
                       true->thePage.private.performingCut;
                       true->thePage.private.doOADPaste;
                       (thePatternNode.SifEditorInstanceNo,anAST.index)
                         ->changeASTFocus
                   if)
               if)
            else
               theObject.delete
           if)
       if)
    else
       menuID.EditMenu.clear->DSUIMenuExecute
   if)
#)  

-- InsertBeforeHit: Descriptor --
(#
   thePage: ^OADPage;
   theObject: ^thePage.PatternDiagramNode;
   theDesObj: ^thePage.DesignObject;
   t: ^text;
   anAST: ^MPS.AST
do
   (if switch[1] then 'InsertBefore'->putline if);
   currentPage->thePage[];
   thePage.CurrentObject->theDesObj[];
   (if theDesObj[] <> none then
       (if theDesObj## <= thePage.PatternDiagramNode## then
           theDesObj[]->theObject[];
           theObject.getASTNode->anAST[];
           (if anAST[] <> none then
               true->thePage.private.performingInsertBefore;
               (theObject.SifEditorInstanceNo,anAST.index)
                 ->changeASTFocus
                 (*Actual send of command 'after' to sif is done as response to status
                  'changeFocus' from sif (to deal with synch.)*)
            else
               (if switch[1] then
                   'theObject.getASTNode returned NONE'->putline
               if);
               (if thePage.canListInsert
                // true then
                   '#'->t[];
                   theObject.SifEditorInstanceNo->t.putint;
                   ' before'->t.puttext;
                   t[]->theController.sendSifCommand;
                   
               if)
           if)
        else
           'Current focus is not a pattern diagram node!'->putline
       if)
   if);
   
#)  

-- EditMenuInit: Descriptor --
(# 
do (* design gets internal error for items above status+3! Why? *)
(* (UserMenu2+2,'-')->sep1.init;
 sep1.disable; *)
   (UserMenu2+1,'Undo                     (ctrl+u)')->iUndo.init;
   (UserMenu2+2,'Cut                       (ctrl+k)')->iCut.init;
   (UserMenu2+3,'Copy                     (ctrl+c)')->iCopy.init;
   (UserMenu2+4,'Paste Before             (ctrl+B)')->iPasteBefore.init;
   iPasteBefore.disable;
   (UserMenu2+5,'Paste                    (ctrl+y)')->iPaste.init;
   (UserMenu2+6,'Paste After              (ctrl+A)')->iPasteAfter.init;
   iPasteAfter.disable;
   (UserMenu2+7,'Clear                   (ctrl+d)')->iClear.init;
   (UserMenu2+8,'-')->sep2.init;
   sep2.disable;
   (UserMenu2+9,'Textedit                   (ctrl+space)')->iTextEdit.init;
   (UserMenu2+10,'Revert Textediting   (ctrl+r)')->irevertTextEdit.init;
   (UserMenu2+11,'-')->sep3.init;
   sep3.disable;
   (UserMenu2+12,'Insert Before          (ctrl+b)')->insertbeforeItem.init;
   (UserMenu2+13,'Insert After            (ctrl+a)')->insertafter.init;
   (UserMenu2+14,'-')->sep4.init;
   sep4.disable;
   (UserMenu2+15,'Remove Optionals')->iRemoveOptionals.init;
   (* iRemoveOptionals.disable; *)
   (UserMenu2+16,'Show Optionals')->iShowOptionals.init;
   (*   iShowOptionals.disable; *)
   iClear.enable;
   (UserMenu2+17,'-')->sep5.init;
   (UserMenu2+18,'Check')->iCheck.init;
   
#)  

-- FrejaEditMenuITextEdit: Descriptor --
(#
   p: ^OADPage;
   thePatternDiagramNode: ^p.PatternDiagramNode;
   theDiagram: ^p.Diagram;
   c: ^p.DesignObject;
   doNotEdit: @Boolean;
   
do
   CurrentPage->p[];
   (if p[] <> theGroupPage[] then
       p.CurrentObject->c[];
       (if c[]
        // none then 
        else
           (if c## <= p.PatternDiagramNode## then
               c[]->thePatternDiagramNode[];
               thePatternDiagramNode.theDiagram->theDiagram[];
               (if thePatternDiagramNode## <= theDiagram.title## then
                   (if (theDiagram## < p.PatternAttDiagram##) or
                   (theDiagram.theParentNode = none ) then
                       'Textediting fragmentform name is currently disabled'
                         ->GppAlert;
                       true->doNotEdit
                   if)
               if)
           if);
           (if not doNotEdit then
               (if TextModeOn
                // true then c.theText.modeOff; 
                else
                   c.theText.modeOn; 
               if);
               not TextModeOn->TextModeOn;
               TextModeOn->Check
           if);
           
       if)
    else
       'Textediting on Group Page is currently disbabled'->GppAlert
   if);
   
#)  

-- iRevertTextEdit: Descriptor --
(#
   p: ^OADPage;
   c: ^p.DesignObject;
   thePatternDiagramNode: ^p.PatternDiagramNode;
   theListDiagram: ^p.ListDiagram;
   theAbstractNode: ^theListDiagram.AbstractNode;
   theDoc: ^OADdocument
do
   (if switch[1] then 'revert text edit'->putLine if);
   CurrentPage->p[];
   p.CurrentObject->c[];
   (if c[]
    // none then 
    else
       (if TextModeOn
        // true then
           false->p.ongoingTextediting;
           false->p.onGoingTitleEditing;
           p.theTextBefore->c.theText.set;
           c.theText.modeOff;
           (if c## <= p.PatternDiagramNode## then
               c[]->thePatternDiagramNode[];
               thePatternDiagramNode.theDiagram->theListDiagram[];
               (if thePatternDiagramNode## <= theListDiagram.AbstractNode## then
                   thePatternDiagramNode[]->theAbstractNode[];
                   (theAbstractNode.theText.oldWidth,
                    theAbstractNode.theText.oldHeight)->theAbstractNode.size
               if)
           if)
       if);
       theDocument[]->theDoc[];
       false->TextModeOn->theDoc.FrejaEditMenu.iTextedit.Check;
       
   if)
#)  

-- InsertAfterHit: Descriptor --
(#
   thePage: ^OADPage;
   theObject: ^thePage.PatternDiagramNode;
   theDesObj: ^thePage.DesignObject;
   t: ^text;
   anAST: ^MPS.AST;
   
do
   (if switch[1] then 'InsertAfter'->putline if);
   theDocument.currentPage->thePage[];
   thePage.CurrentObject->theDesObj[];
   (if theDesObj[] <> none then
       (if theDesObj## <= thePage.PatternDiagramNode## then
           theDesObj[]->theObject[];
           theObject.getASTNode->anAST[];
           (if anAST[] <> none then
               true->thePage.private.performingInsertAfter;
               (theObject.SifEditorInstanceNo,anAST.index)
                 ->changeASTFocus
                 (*Actual send of command 'after' to sif is done as response to status
                  'changeFocus' from sif (to deal with synch.)*)
            else
               (if switch[1] then
                   'theObject.getASTNode returned NONE'->putline
               if);
               (if thePage.canListInsert
                // true then
                   '#'->t[];
                   theObject.SifEditorInstanceNo->t.putint;
                   ' after'->t.puttext;
                   t[]->theController.sendSifCommand;
                   
               if)
           if)
        else
           'Current focus is not a pattern diagram node!'->putline
       if)
   if);
   
#)
(*-- opengrouphit: DescriptorForm --
 (#
 t: ^Text;
 g: ^mps.fragmentgroup;
 theObject: ^currentPage.PatternDiagramNode;
 myDocument: ^OADDocument;
 currentPage: ^myDocument.OADPage;
 do
 theDocument[]->myDocument[];
 myDocument.CurrentPage->currentPage[];
 currentPage.CurrentObject->theObject[];
 (if theObject[]
 // none then 'No Fragment Selected'->DSUIUserAckMessage;
 else
 theObject.GetGroup->g[];
 '#0openGroup '->t[];
 g.name->ExpandToFullPath->t.append;
 t[]->theController.sendSifCommand;
 if);
 #)  
 
 -- openFormHit: DescriptorForm --
 (#
 t: ^Text;
 theObject: ^currentPage.PatternDiagramNode;
 myDocument: ^OADDocument;
 currentPage: ^myDocument.OADPage;
 aForm: ^mps.fragment;
 g: ^mps.fragmentgroup;
 do
 '#0openForm '->t[];
 theDocument[]->myDocument[];
 myDocument.CurrentPage->currentPage[];
 currentPage.CurrentObject->theObject[];
 (if theObject[]
 // none then 'No Fragment Selected'->DSUIUserAckMessage;
 else
 theObject.GetFragment->aForm[];
 (if aForm[] <> none
 // true then
 theObject.GetGroup->g[];
 g.name->t.append;
 '-'->t.append;
 aForm.name->t.append;
 ' 0'->t.append;
 t[]->theController.sendSifCommand;
 else
 'Cannot find FragmentForm for selected node'->DSUIUserAckMessage;
 t[]->putline;
 if);
 if);
 #)  
 * *)  

-- FrejaRemoveOptionalsItem: Descriptor --
(#
   thePage: ^OADPage;
   theObject: ^thePage.DesignObject;
   theNode: ^thePage.PatternDiagramNode;
   anAST: ^MPS.AST;
   t: ^Text
do
   currentPage->thePage[];
   thePage.CurrentObject->theObject[];
   (if theObject## <= thePage.PatternDiagramNode## then
       theObject[]->theNode[];
       '#'->t[];
       theNode.SifEditorInstanceNo->t.putint;
       ' removeOptionals'->t.puttext;
       t[]->theController.sendSifCommand
   if)
#)  

-- FrejaShowOptionalsItem: Descriptor --
(#
   thePage: ^OADPage;
   theObject: ^thePage.DesignObject;
   theNode: ^thePage.PatternDiagramNode;
   anAST: ^MPS.AST;
   t: ^Text
do
   currentPage->thePage[];
   thePage.CurrentObject->theObject[];
   (if theObject## <= thePage.PatternDiagramNode## then
       theObject[]->theNode[];
       '#'->t[];
       theNode.SifEditorInstanceNo->t.putint;
       ' insertOptionals'->t.puttext;
       t[]->theController.sendSifCommand
   if)
#)  

-- FrejaCheckItem: Descriptor --
(#
   thePage: ^OADPage;
   theObject: ^thePage.DesignObject;
   theNode: ^thePage.PatternDiagramNode;
   t: ^Text
do
   currentPage->thePage[];
   thePage.CurrentObject->theObject[];
   (if theObject## <= thePage.PatternDiagramNode## then
       theObject[]->theNode[];
       '#'->t[];
       theNode.SifEditorInstanceNo->t.putint;
       ' check'->t.puttext;
       t[]->theController.sendSifCommand
   if)
#)  

-- ShowCodeItem: Descriptor --
(#
   myDocument: ^OADDocument;
   currentPage: ^myDocument.OADPage;
   theObject: ^currentPage.DesignObject;
   
do
   theDocument[]->myDocument[];
   myDocument.CurrentPage->currentPage[];
   (if currentPage.CurrentObject->theObject[]
    // none then 'No selection, please select a node'->DSUIUserAckMessage; 
    else
       theObject[]->currentPage.openObjectInSif; 
   if);
   
#)  

-- NewProgramItem: Descriptor --
(#  do '#0newBETAProgram olsen'->theController.sendSifCommand #)  

-- NewLibraryItem: Descriptor --
(#  do '#0newBETALib hansen'->theController.sendSifCommand #)  

-- CheckItem: Descriptor --
(#
   thePage: ^OADPage;
   theObject: ^thePage.DesignObject;
   theNode: ^thePage.PatternDiagramNode;
   t: ^text
do
   currentPage->thePage[];
   thePage.CurrentObject->theObject[];
   (if theObject[] <> none
    // true then
       (if theObject.struc <= thePage.PatternDiagramNode##
        // true then
           theObject[]->theNode[];
           '#'->t[];
           theNode.SifEditorInstanceNo->t.putint;
           ' check '->t.puttext;
           t[]->theController.sendSifCommand;
           
       if)
   if)
#)
(*
 -- LinkStartHit: Descriptor --
 (#
 thePage: ^OADPage;
 theObject: ^thePage.DesignObject;
 theNode: ^thePage.PatternDiagramNode;
 t: ^text;
 
 do
 (if switch[11] // true then '[[Freja: StartLink: '->puttext;  if);
 currentPage->thePage[];
 thePage.CurrentObject->theObject[];
 (if theObject[] <> none
 // true then
 (if theObject.struc <= thePage.PatternDiagramNode##
 // true then
 theObject[]->theNode[];
 '#'->t[];
 theNode.SifEditorInstanceNo->t.putint;
 ' startLink '->t.puttext;
 t[]->theController.sendSifCommand;
 (if switch[11]
 // true then theNode.astIndex->screen.putint; 
 if);
 
 else
 '[[Freja: StartLink:unknown object type selected]]'->screen.puttext; 
 if);
 
 else
 '[[Freja: StartLink:no object selected]]'->screen.puttext; 
 if);
 (if switch[11] // true then ']]'->screen.putline;  if);
 
 #)  
 
 -- LinkEndHit: Descriptor --
 (#
 thePage: ^OADPage;
 theObject: ^thePage.DesignObject;
 theNode: ^thePage.PatternDiagramNode;
 t: ^text;
 
 do
 (if switch[11] // true then '[[Freja: EndLink: '->puttext;  if);
 currentPage->thePage[];
 thePage.CurrentObject->theObject[];
 (if theObject[] <> none
 // true then
 (if theObject.struc <= thePage.PatternDiagramNode##
 // true then
 theObject[]->theNode[];
 '#'->t[];
 theNode.SifEditorInstanceNo->t.putint;
 ' endLink '->t.puttext;
 t[]->theController.sendSifCommand;
 (if switch[11]
 // true then theNode.astIndex->screen.putint; 
 if);
 
 else
 '[[Freja: EndLink:unknown object type selected]]'->screen.puttext; 
 if);
 
 else
 '[[Freja: EndLink:no object selected]]'->screen.puttext; 
 if);
 (if switch[11] // true then ']]'->screen.putline;  if)
 #)  
 
 -- LinkFollowHit: Descriptor --
 (#
 thePage: ^OADPage;
 theObject: ^thePage.DesignObject;
 theMark: ^thePage.MarkNode;
 theNode: ^thePage.PatternDiagramNode;
 t: ^text;
 
 do
 (if switch[11] // true then '[[Freja: FollowLink: '->puttext;  if);
 currentPage->thePage[];
 thePage.CurrentObject->theObject[];
 (if theObject[] <> none
 // true then
 (if true
 // theObject.struc <= thePage.MarkNode## then
 theObject[]->theMark[];
 (if theMark.thePatternDiagramNode[] <> none
 // true then
 '#'->t[];
 (theMark.thePatternDiagramNode).SifEditorInstanceNo->t.putint;
 ' followLink '->t.puttext;
 (theMark.thePatternDiagramNode).astIndex->t.putint;
 t[]->theController.sendSifCommand;
 (if switch[11]
 // true then
 (theMark.thePatternDiagramNode).astIndex->screen.putint; 
 if);
 
 else
 '[[Freja: FollowLink:theMark has no NodeObject]]'
 ->screen.puttext;
 
 if);
 
 // theObject.struc <= thePage.PatternDiagramNode## then
 theObject[]->theNode[];
 '#'->t[];
 theNode.SifEditorInstanceNo->t.putint;
 ' followLink '->t.puttext;
 theNode.astIndex->t.putint;
 t[]->theController.sendSifCommand;
 (if switch[11]
 // true then theNode.astIndex->screen.putint; 
 if);
 
 else
 '[[Freja: FollowLink:unknown object type selected]]'->screen.puttext;
 
 if);
 
 else
 '[[Freja: FollowLink:no object selected]]'->screen.puttext; 
 if);
 (if switch[11] // true then ']]'->screen.putline;  if);
 
 #)  
 *)  

-- CreateNewPage: Descriptor --
(# p: ^OADObjectPage; 
do
   &OADObjectPage[]->p[];
   p.new;
   CreatePassiveObject.enable;
   CreateMultipleObject.enable;
   CreateConcurrentObject.enable;
   CreateInteractionRelation.enable;
   CreateTwoWayInteractionRelation.enable;
   CreateDistributedInteractionRelation.enable;
   CreateTwoWayDistributedInteractionRelation.enable;
   (*CreatePattern.enable;
    CreateVirtualPattern.enable;*)
   
#)  

-- CreatePassiveObject: Descriptor --
(# p: ^Page; op: ^OADObjectPage; 
do
   'Create Passive hit'->screen.putline;
   CurrentPage->p[];
   (if p.struc <= OADObjectPage##
    // true then
       p[]->op[];
         (# pas: ^op.PassiveObject; 
         do
            &op.PassiveObject[]->pas[];
            'Create Passive Object'->pas.interactivenew;
            
         #);
       
    else
       'Cannot create Object on active page'->DSUIUserAckMessage; 
   if);
   
#)  

-- CreateMultipleObject: Descriptor --
(# p: ^Page; op: ^OADObjectPage; 
do
   'Create Multiple hit'->screen.putline;
   CurrentPage->p[];
   (if p.struc <= OADObjectPage##
    // true then
       p[]->op[];
         (# mult: ^op.MultipleObject; 
         do
            &op.MultipleObject[]->mult[];
            'Create Multiple Object'->mult.interactivenew;
            
         #);
       
    else
       'Cannot create Object on active page'->DSUIUserAckMessage; 
   if);
   
#)  

-- CreateConcurrentObject: Descriptor --
(# p: ^Page; op: ^OADObjectPage; 
do
   'Create Concurrent hit'->screen.putline;
   CurrentPage->p[];
   (if p.struc <= OADObjectPage##
    // true then
       p[]->op[];
         (# con: ^op.ConcurrentObject; 
         do
            &op.ConcurrentObject[]->con[];
            'Create Concurrent Object'->con.interactivenew;
            
         #);
       
    else
       'Cannot create Object on active page'->DSUIUserAckMessage; 
   if);
   
#)  

-- CreateInteractionRelation: Descriptor --
(# p: ^Page; op: ^OADObjectPage; 
do
   'Create Relation hit'->screen.putline;
   CurrentPage->p[];
   (if p.struc <= OADObjectPage##
    // true then
       p[]->op[];
         (# rel: ^op.InteractionRelation; 
         do
            &op.InteractionRelation[]->rel[];
            'Create Interaction Relation Between two Objects '
              ->rel.interactivenew;
            
         #);
       
    else
       'Cannot create Relation on active page'->DSUIUserAckMessage; 
   if);
   
#)  

-- CreateTwoWayInteractionRelation: Descriptor --
(# p: ^Page; op: ^OADObjectPage; 
do
   'Create Relation hit'->screen.putline;
   CurrentPage->p[];
   (if p.struc <= OADObjectPage##
    // true then
       p[]->op[];
         (# rel: ^op.TwoWayInteractionRelation; 
         do
            &op.TwoWayInteractionRelation[]->rel[];
            'Create Interaction Relation Between two Objects '
              ->rel.interactivenew;
            
         #);
       
    else
       'Cannot create Relation on active page'->DSUIUserAckMessage; 
   if);
   
#)  

-- CreateDistributedInteractionRelation: Descriptor --
(# p: ^Page; op: ^OADObjectPage; 
do
   'Create Relation hit'->screen.putline;
   CurrentPage->p[];
   (if p.struc <= OADObjectPage##
    // true then
       p[]->op[];
         (# rel: ^op.DistributedInteractionRelation; 
         do
            &op.DistributedInteractionRelation[]->rel[];
            'Create Interaction Relation Between two Objects '
              ->rel.interactivenew;
            
         #);
       
    else
       'Cannot create Relation on active page'->DSUIUserAckMessage; 
   if);
   
#)  

-- CreateTwoWayDistributedInteractionRelation: Descriptor --
(# p: ^Page; op: ^OADObjectPage; 
do
   'Create Relation hit'->screen.putline;
   CurrentPage->p[];
   (if p.struc <= OADObjectPage##
    // true then
       p[]->op[];
         (# rel: ^op.TwoWayDistributedInteractionRelation; 
         do
            &op.TwoWayDistributedInteractionRelation[]->rel[];
            'Create Interaction Relation Between two Objects '
              ->rel.interactivenew;
            
         #);
       
    else
       'Cannot create Relation on active page'->DSUIUserAckMessage; 
   if);
   
#)  

-- CreatePattern: Descriptor --
(# p: ^Page; op: ^OADObjectPage; 
do
   'Create Pattern hit'->screen.putline;
   CurrentPage->p[];
   (if p.struc <= OADObjectPage##
    // true then
       p[]->op[];
         (# pp: ^op.PatternPattern; 
         do &op.PatternPattern[]->pp[]; 'Create Pattern'->pp.interactivenew; 
         #);
       
    else
       'Cannot create Relation on active page'->DSUIUserAckMessage; 
   if);
   
#)  

-- CreatePatternPrefix: Descriptor --
(# p: ^Page; op: ^OADObjectPage; oad: ^OADPage; 
do
   'Create Pattern Prefix hit'->screen.putline;
   CurrentPage->p[];
   (if true
    // (p.struc <= OADObjectPage##) then
       
    // (p.struc <= OADPage##) then
       p[]->oad[]; oad.StartCreatePrefix; 
    else
       'Cannot create Relation on active page'->DSUIUserAckMessage; 
   if);
   
#)  

-- CreateVirtualPattern: Descriptor --
(# p: ^Page; op: ^OADObjectPage; 
do
   'Create Virtual hit'->screen.putline;
   CurrentPage->p[];
   (if p.struc <= OADObjectPage##
    // true then
       p[]->op[];
         (# vp: ^op.VirtualPattern; 
         do
            &op.VirtualPattern[]->vp[];
            'Create Virtual Pattern '->vp.interactivenew;
            
         #);
       
    else
       'Cannot create Relation on active page'->DSUIUserAckMessage; 
   if);
   
#)  

-- ObjectCreateMenuInit: Descriptor --
(# separator1: @Item; 
do
   (UserMenu5+1,'New Design Page')->CreateNewPage.init;
   (UserMenu5+2,'Object')->CreatePassiveObject.init;
   (UserMenu5+3,'Multiple Objects')->CreateMultipleObject.init;
   (UserMenu5+4,'Concurrent Object')->CreateConcurrentObject.init;
   (UserMenu5+6,'Interaction')->CreateInteractionRelation.init;
   (UserMenu5+7,'Two-way Interaction')->CreateTwoWayInteractionRelation.init;
   (UserMenu5+8,'Distributed Interaction')
     ->CreateDistributedInteractionRelation.init;
   (UserMenu5+9,'Two-way Distributed Interaction')
     ->CreateTwoWayDistributedInteractionRelation.init;
   (UserMenu5+10,'-')->separator1.init;
   separator1.disable;
   (UserMenu5+11,'Create Pattern')->CreatePattern.init;
   (UserMenu5+12,'Create Pattern Prefix')->CreatePatternPrefix.init;
   (UserMenu5+13,'Create Virtual Pattern')->CreateVirtualPattern.init;
   CreatePassiveObject.disable;
   CreateMultipleObject.disable;
   CreateConcurrentObject.disable;
   CreateInteractionRelation.disable;
   CreatePattern.disable;
   CreateVirtualPattern.disable;
   
#)  

-- ExpandMenuInit: Descriptor --
(# 
do
   (for i: noOfItems repeat
     &ExpandItem[]->theItems[i][];
     (UserMenu8+i,'                                 ')->theItems[i].init
   for)
#)  

-- ExpandMenuCreateItems: Descriptor --
(# tt,category: ^Text; aItem: ^ExpandItem; symbol,i: @Integer; 
do
   (if list[]
    // none then 
    else
       (if theGraphicalInterface.switch[12] then
           'Freja: expandmenu.init: '->putText; list[]->putLine; 
       if);
       list.reset;
       list.getatom->tt[];
       (if tt[]
        // none then 
        else
           (if ('Enter'->tt.equal)
            // true then theexpandmenu.deletemenu; 
            else
               list.reset;
               1->i;
               loop:
               (if 1
                // 1 then
                   list.getInt->symbol;
                   list.getAtom->category[];
                   (i,symbol,category[])->theItems[i].create;
                   (if list.pos+1 < list.length
                    // true then i+1->i; restart loop
                   if)
               if)
           if)
       if)
   if)
#)  

-- ExpandItemCreate: Descriptor --
(# 
do
   (if (1->syncatname.inxget) = '-'
    // false then
       (if switch[1] then
           'Expand menu create: '->puttext;
           syncatno->putint;
           ' '->puttext;
           syncatname[]->putline
       if);
       (ItemNumber,syncatname,0)->DSMenuItemRename;
       
    // true then
       (ItemNumber,'--',0)->DSMenuItemRename; Disable; 
   if)
#)  

-- ExpandItemHit: Descriptor --
(# p: ^Page; op: ^OADPage; 
do
(* (if SynCatNo
 // 13 then
 'expanding to RepetitionDecl is not yet implemented!'->DSUIUserAckMessage
 else
 
 if); *)
   (if SynCatNo <> 0
    // true then
       currentpage->p[];
       (if p[] <> none
        // true then
           (if p.struc <= Palette##
            // true then 'CurrentPage is a Palette'->putline; 
            else
               (if switch[1] then
                   'Expand menu item hit: '->puttext;
                   SynCatNo->putint;
                   ' '->puttext;
                   synCatName[]->putline
               if);
               p[]->op[];
               (SynCatNo,normal)->op.doExpand;
               
           if)
       if)
   if)
#)  

-- ExpandMenuDelete: Descriptor --
(# 
do
   (for i: 11 repeat
     (theItems[i].ItemNumber,' ',0)->DSMenuItemRename;
     0->theItems[i].synCatNo;
     none ->theItems[i].synCatName[]
   for)
#)  

-- AttributeKindMenuInit: Descriptor --
(# 
do
   (UserMenu9+1,'New pattern  (ctrl+p)')->NewPattern.init;
   (* (UserMenu9+2,'--')->sep.init;
    sep.disable; *)
   (UserMenu9+2,'Local pattern  (ctrl+l)')->LocalPattern.init;
   (UserMenu9+3,'Part object  (ctrl+o)')->PartObject.init;
   (UserMenu9+4,'Dynamic reference  (ctrl+r)')->DynamicReference.init;
   (UserMenu9+5,'Virtual pattern  (ctrl+v)')->VirtualPattern.init;
   (UserMenu9+6,'Binding of virtual pattern  (ctrl+w)')
     ->BindingOfVirtualPattern.init;
   (UserMenu9+7,'Final binding of virtual pattern  (ctrl+f)')
     ->FinalBindOfVirtPattern.init
#)  

-- AttributeKindMenuNewPattern: Descriptor --
(#
   theParentNode: ^op.PatternDiagramNode;
   anAST: ^MPS.AST;
   p: ^Page;
   op: ^OADPage;
   theListDiagram: ^op.ListDiagram;
   t: ^Text
do
   currentpage->p[];
   (if p[] <> none then
       (if p.struc <= Palette## then
           'CurrentPage is a Palette'->putline; 
        else
           (if p## <= ObjectPage## then
               'CurrentPage is an ObjectPage'->putline
            else
               p[]->op[];
               (if op.currentFocus[] <> none then
                   (if op.currentFocus.theDiagram <> none then
                       op.currentFocus.theDiagram->theListDiagram[];
                       getTopMostDiagram:
                         (# b1,b2: @Boolean
                         do
                            (theListDiagram## <= op.PatternAttDiagram##)->b1;
                            theListDiagram[]->theListDiagram.isDescriptorDiagram
                              ->b2;
                            (if b1 or b2 then
                                (if theListDiagram.LocalNodes.empty then
                                    'Cannot create new pattern - diagram has no attributes'
                                      ->GppAlert
                                 else
                                    op.currentFocus[]->op.oldFocus[];
                                    (theListDiagram.localNodes.last).elm[]
                                      ->op.currentFocus[]->op.currentObject;
                                    op.currentFocus.getASTNode->anAST[];
                                    (if anAST[] <> none then
                                        true
                                          ->
                                            op.private.
                                              performingNewPatternExpAfter;
                                        (op.currentFocus.SifEditorInstanceNo,
                                         anAST.index)
                                          ->changeASTFocus
                                          (*Actual send of command 'after' to sif is done as response to status
                                           'changeFocus' from sif (to deal with synch.)*)
                                     else
                                        (if switch[1] then
                                            'theObject.getASTNode returned NONE'
                                              ->putline
                                        if);
                                        (if op.canListInsert
                                         // true then
                                            '#'->t[];
                                            op.currentFocus.SifEditorInstanceNo
                                              ->t.putint;
                                            ' expandAfter '->t.puttext;
                                            betaGram.PatternDecl->t.putint;
                                            t[]->theController.sendSifCommand;
                                            
                                        if)
                                    if)
                                if)
                             else
                                theListDiagram.theParentNode->theParentNode[];
                                (if theParentNode[] <> none then
                                    theParentNode.theDiagram->theListDiagram[];
                                    restart getTopMostDiagram
                                if)
                            if)
                         #)
                    else
                       'PartObjectHit: theDiagram is NONE'->putline
                   if)
                else
                   'PartObjectHit: CurrentFocus is NONE'->putline
               if)
           if);
           
       if)
   if)
#)  

-- AttributeKindMenuPartObject: Descriptor --
(#
   theParentNode: ^op.PatternDiagramNode;
   anAST: ^MPS.AST;
   p: ^Page;
   op: ^OADPage;
   theListDiagram: ^op.ListDiagram;
   t: ^Text
do
   currentpage->p[];
   (if p[] <> none then
       (if p.struc <= Palette## then
           'CurrentPage is a Palette'->putline; 
        else
           (if p## <= ObjectPage## then
               'CurrentPage is an ObjectPage'->putline
            else
               p[]->op[];
               (if op.currentFocus[] <> none then
                   (if op.currentFocus.theDiagram <> none then
                       op.currentFocus.theDiagram->theListDiagram[];
                       (if theListDiagram.LocalNodes.empty then
                           'Cannot create part object pattern - diagram has no attributes'
                             ->GppAlert
                        else
                           op.currentFocus[]->op.oldFocus[];
                           (theListDiagram.LocalNodes.last).elm[]
                             ->op.currentFocus[]->op.currentObject;
                           op.currentFocus.getASTNode->anAST[];
                           (if anAST[] <> none then
                               true->op.private.performingPartObjectExpAfter;
                               (op.currentFocus.SifEditorInstanceNo,anAST.index)
                                 ->changeASTFocus
                                 (*Actual send of command 'after' to sif is done as response to status
                                  'changeFocus' from sif (to deal with synch.)*)
                            else
                               (if switch[1] then
                                   'theObject.getASTNode returned NONE'->putline
                               if);
                               (if op.canListInsert
                                // true then
                                   '#'->t[];
                                   op.currentFocus.SifEditorInstanceNo
                                     ->t.putint;
                                   ' expandAfter '->t.puttext;
                                   betaGram.StaticItem->t.putint;
                                   t[]->theController.sendSifCommand;
                                   
                               if)
                           if)
                       if)
                    else
                       'PartObjectHit: theDiagram is NONE'->putline
                   if)
                else
                   'PartObjectHit: CurrentFocus is NONE'->putline
               if)
           if);
           
       if)
   if)
#)  

-- AttributeKindMenuDynamicReference: Descriptor --
(#
   theParentNode: ^op.PatternDiagramNode;
   anAST: ^MPS.AST;
   p: ^Page;
   op: ^OADPage;
   theListDiagram: ^op.ListDiagram;
   t: ^Text
do
   currentpage->p[];
   (if p[] <> none then
       (if p.struc <= Palette## then
           'CurrentPage is a Palette'->putline; 
        else
           (if p## <= ObjectPage## then
               'CurrentPage is an ObjectPage'->putline
            else
               p[]->op[];
               (if op.currentFocus[] <> none then
                   (if op.currentFocus.theDiagram <> none then
                       op.currentFocus.theDiagram->theListDiagram[];
                       (if theListDiagram.LocalNodes.empty then
                           'Cannot create dynamic reference - diagram has no attributes'
                             ->GppAlert
                        else
                           op.currentFocus[]->op.oldFocus[];
                           (theListDiagram.LocalNodes.last).elm[]
                             ->op.currentFocus[]->op.currentObject;
                           op.currentFocus.getASTNode->anAST[];
                           (if anAST[] <> none then
                               true
                                 ->
                                   op.private.
                                     performingDynamicReferenceExpAfter;
                               (op.currentFocus.SifEditorInstanceNo,anAST.index)
                                 ->changeASTFocus
                                 (*Actual send of command 'after' to sif is done as response to status
                                  'changeFocus' from sif (to deal with synch.)*)
                            else
                               (if switch[1] then
                                   'theObject.getASTNode returned NONE'->putline
                               if);
                               (if op.canListInsert
                                // true then
                                   '#'->t[];
                                   op.currentFocus.SifEditorInstanceNo
                                     ->t.putint;
                                   ' expandAfter '->t.puttext;
                                   betaGram.DynamicItem->t.putint;
                                   t[]->theController.sendSifCommand;
                                   
                               if)
                           if)
                       if)
                    else
                       'PartObjectHit: theDiagram is NONE'->putline
                   if)
                else
                   'PartObjectHit: CurrentFocus is NONE'->putline
               if)
           if);
           
       if)
   if)
#)  

-- AttributeKindMenuLocalPattern: Descriptor --
(#
   theParentNode: ^op.PatternDiagramNode;
   anAST: ^MPS.AST;
   p: ^Page;
   op: ^OADPage;
   theListDiagram: ^op.ListDiagram;
   t: ^Text
do
   currentpage->p[];
   (if p[] <> none then
       (if p.struc <= Palette## then
           'CurrentPage is a Palette'->putline; 
        else
           (if p## <= ObjectPage## then
               'CurrentPage is an ObjectPage'->putline
            else
               p[]->op[];
               (if op.currentFocus[] <> none then
                   (if op.currentFocus.theDiagram <> none then
                       op.currentFocus.theDiagram->theListDiagram[];
                       (if theListDiagram.LocalNodes.empty then
                           'Cannot create local pattern - diagram has no attributes'
                             ->GppAlert
                        else
                           op.currentFocus[]->op.oldFocus[];
                           (theListDiagram.LocalNodes.last).elm[]
                             ->op.currentFocus[]->op.currentObject;
                           op.currentFocus.getASTNode->anAST[];
                           (if anAST[] <> none then
                               true->op.private.performingNewPatternExpAfter;
                               (op.currentFocus.SifEditorInstanceNo,anAST.index)
                                 ->changeASTFocus
                                 (*Actual send of command 'after' to sif is done as response to status
                                  'changeFocus' from sif (to deal with synch.)*)
                            else
                               (if switch[1] then
                                   'theObject.getASTNode returned NONE'->putline
                               if);
                               (if op.canListInsert
                                // true then
                                   '#'->t[];
                                   op.currentFocus.SifEditorInstanceNo
                                     ->t.putint;
                                   ' expandAfter '->t.puttext;
                                   betaGram.PatternDecl->t.putint;
                                   t[]->theController.sendSifCommand;
                                   
                               if)
                           if)
                       if)
                    else
                       'PartObjectHit: theDiagram is NONE'->putline
                   if)
                else
                   'PartObjectHit: CurrentFocus is NONE'->putline
               if)
           if);
           
       if)
   if)
#)  

-- AttributeKindMenuVirtualPattern: Descriptor --
(#
   theParentNode: ^op.PatternDiagramNode;
   anAST: ^MPS.AST;
   p: ^Page;
   op: ^OADPage;
   theListDiagram: ^op.ListDiagram;
   t: ^Text
do
   currentpage->p[];
   (if p[] <> none then
       (if p.struc <= Palette## then
           'CurrentPage is a Palette'->putline; 
        else
           (if p## <= ObjectPage## then
               'CurrentPage is an ObjectPage'->putline
            else
               p[]->op[];
               (if op.currentFocus[] <> none then
                   (if op.currentFocus.theDiagram <> none then
                       op.currentFocus.theDiagram->theListDiagram[];
                       (if theListDiagram.LocalNodes.empty then
                           'Cannot virtual pattern - diagram has no attributes'
                             ->GppAlert
                        else
                           op.currentFocus[]->op.oldFocus[];
                           (theListDiagram.LocalNodes.last).elm[]
                             ->op.currentFocus[]->op.currentObject;
                           op.currentFocus.getASTNode->anAST[];
                           (if anAST[] <> none then
                               true
                                 ->op.private.performingVirtualPatternExpAfter;
                               (op.currentFocus.SifEditorInstanceNo,anAST.index)
                                 ->changeASTFocus
                                 (*Actual send of command 'after' to sif is done as response to status
                                  'changeFocus' from sif (to deal with synch.)*)
                            else
                               (if switch[1] then
                                   'theObject.getASTNode returned NONE'->putline
                               if);
                               (if op.canListInsert
                                // true then
                                   '#'->t[];
                                   op.currentFocus.SifEditorInstanceNo
                                     ->t.putint;
                                   ' expandAfter '->t.puttext;
                                   betaGram.VirtualDecl->t.putint;
                                   t[]->theController.sendSifCommand;
                                   
                               if)
                           if)
                       if)
                    else
                       'PartObjectHit: theDiagram is NONE'->putline
                   if)
                else
                   'PartObjectHit: CurrentFocus is NONE'->putline
               if)
           if);
           
       if)
   if)
#)  

-- AttributeKindMenuBindingOfVirtualPattern: Descriptor --
(#
   theParentNode: ^op.PatternDiagramNode;
   anAST: ^MPS.AST;
   p: ^Page;
   op: ^OADPage;
   theListDiagram: ^op.ListDiagram;
   t: ^Text
do
   currentpage->p[];
   (if p[] <> none then
       (if p.struc <= Palette## then
           'CurrentPage is a Palette'->putline; 
        else
           (if p## <= ObjectPage## then
               'CurrentPage is an ObjectPage'->putline
            else
               p[]->op[];
               (if op.currentFocus[] <> none then
                   (if op.currentFocus.theDiagram <> none then
                       op.currentFocus.theDiagram->theListDiagram[];
                       (if theListDiagram.LocalNodes.empty then
                           'Cannot create binding of virtual pattern - diagram has no attributes'
                             ->GppAlert
                        else
                           op.currentFocus[]->op.oldFocus[];
                           (theListDiagram.LocalNodes.last).elm[]
                             ->op.currentFocus[]->op.currentObject;
                           op.currentFocus.getASTNode->anAST[];
                           (if anAST[] <> none then
                               true
                                 ->
                                   op.private.
                                     performingBindingOfVirtualPatternExpAfter;
                               (op.currentFocus.SifEditorInstanceNo,anAST.index)
                                 ->changeASTFocus
                                 (*Actual send of command 'after' to sif is done as response to status
                                  'changeFocus' from sif (to deal with synch.)*)
                            else
                               (if switch[1] then
                                   'theObject.getASTNode returned NONE'->putline
                               if);
                               (if op.canListInsert
                                // true then
                                   '#'->t[];
                                   op.currentFocus.SifEditorInstanceNo
                                     ->t.putint;
                                   ' expandAfter '->t.puttext;
                                   betaGram.BindingDecl->t.putint;
                                   t[]->theController.sendSifCommand;
                                   
                               if)
                           if)
                       if)
                    else
                       'PartObjectHit: theDiagram is NONE'->putline
                   if)
                else
                   'PartObjectHit: CurrentFocus is NONE'->putline
               if)
           if);
           
       if)
   if)
#)  

-- AttributeKindMenuFinalBindOfVirtPattern: Descriptor --
(#
   theParentNode: ^op.PatternDiagramNode;
   anAST: ^MPS.AST;
   p: ^Page;
   op: ^OADPage;
   theListDiagram: ^op.ListDiagram;
   t: ^Text
do
   currentpage->p[];
   (if p[] <> none then
       (if p.struc <= Palette## then
           'CurrentPage is a Palette'->putline; 
        else
           (if p## <= ObjectPage## then
               'CurrentPage is an ObjectPage'->putline
            else
               p[]->op[];
               (if op.currentFocus[] <> none then
                   (if op.currentFocus.theDiagram <> none then
                       op.currentFocus.theDiagram->theListDiagram[];
                       (if theListDiagram.LocalNodes.empty then
                           'Cannot create final binding og virtual pattern - diagram has no attributes'
                             ->GppAlert
                        else
                           op.currentFocus[]->op.oldFocus[];
                           (theListDiagram.LocalNodes.last).elm[]
                             ->op.currentFocus[]->op.currentObject;
                           op.currentFocus.getASTNode->anAST[];
                           (if anAST[] <> none then
                               true
                                 ->
                                   op.private.
                                     performingFinalBindingOfVirtualPatternExpAfter;
                               (op.currentFocus.SifEditorInstanceNo,anAST.index)
                                 ->changeASTFocus
                                 (*Actual send of command 'after' to sif is done as response to status
                                  'changeFocus' from sif (to deal with synch.)*)
                            else
                               (if switch[1] then
                                   'theObject.getASTNode returned NONE'->putline
                               if);
                               (if op.canListInsert
                                // true then
                                   '#'->t[];
                                   op.currentFocus.SifEditorInstanceNo
                                     ->t.putint;
                                   ' expandAfter '->t.puttext;
                                   betaGram.FinalDecl->t.putint;
                                   t[]->theController.sendSifCommand;
                                   
                               if)
                           if)
                       if)
                    else
                       'PartObjectHit: theDiagram is NONE'->putline
                   if)
                else
                   'PartObjectHit: CurrentFocus is NONE'->putline
               if)
           if);
           
       if)
   if)
#)  

-- RelationsMenuDynamicItem: Descriptor --
(# p: ^Page; op: ^OADPage; theConnector: ^op.DynamicItemConnector
do
   currentpage->p[];
   (if p[] <> none then
       (if p.struc <= Palette## then
           'CurrentPage is a Palette'->putline; 
        else
           (if p## <= ObjectPage## then
               'CurrentPage is an ObjectPage'->putline
            else
               p[]->op[];
               &op.DynamicItemConnector[]->theConnector[];
               theConnector.InteractiveNew;
               
           if);
           
       if)
   if)
#)  

-- RelationsMenuDynamicComponent: Descriptor --
(# p: ^Page; op: ^OADPage; theConnector: ^op.DynamicComponentConnector
do
   currentpage->p[];
   (if p[] <> none then
       (if p.struc <= Palette## then
           'CurrentPage is a Palette'->putline; 
        else
           (if p## <= ObjectPage## then
               'CurrentPage is an ObjectPage'->putline
            else
               p[]->op[];
               &op.DynamicComponentConnector[]->theConnector[];
               theConnector.InteractiveNew;
               
           if);
           
       if)
   if)
#)  

-- RelationsMenuStaticItem: Descriptor --
(# p: ^Page; op: ^OADPage; theConnector: ^op.StaticItemConnector
do
   currentpage->p[];
   (if p[] <> none then
       (if p.struc <= Palette## then
           'CurrentPage is a Palette'->putline; 
        else
           (if p## <= ObjectPage## then
               'CurrentPage is an ObjectPage'->putline
            else
               p[]->op[];
               &op.StaticItemConnector[]->theConnector[];
               theConnector.InteractiveNew;
               
           if);
           
       if)
   if)
#)  

-- RelationsMenuStaticComponent: Descriptor --
(# p: ^Page; op: ^OADPage; theConnector: ^op.StaticComponentConnector
do
   currentpage->p[];
   (if p[] <> none then
       (if p.struc <= Palette## then
           'CurrentPage is a Palette'->putline; 
        else
           (if p## <= ObjectPage## then
               'CurrentPage is an ObjectPage'->putline
            else
               p[]->op[];
               &op.StaticComponentConnector[]->theConnector[];
               theConnector.InteractiveNew;
               
           if);
           
       if)
   if)
#)  

-- RelationsMenuSpecialization: Descriptor --
(# p: ^Page; op: ^OADPage; theConnector: ^op.SpecializationConnector
do
   currentpage->p[];
   (if p[] <> none then
       (if p.struc <= Palette## then
           'CurrentPage is a Palette'->putline; 
        else
           (if p## <= ObjectPage## then
               'CurrentPage is an ObjectPage'->putline
            else
               p[]->op[];
               &op.SpecializationConnector[]->theConnector[];
               theConnector.InteractiveNew;
               
           if);
           
       if)
   if)
#)  

-- RelationsMenuBind: Descriptor --
(# p: ^Page; op: ^OADPage; theConnector: ^op.BindingConnector
do
   currentpage->p[];
   (if p[] <> none then
       (if p.struc <= Palette## then
           'CurrentPage is a Palette'->putline; 
        else
           (if p## <= ObjectPage## then
               'CurrentPage is an ObjectPage'->putline
            else
               p[]->op[];
               &op.BindingConnector[]->theConnector[];
               theConnector.InteractiveNew;
               
           if);
           
       if)
   if)
#)  

-- RelationsMenuFinal: Descriptor --
(# p: ^Page; op: ^OADPage; theConnector: ^op.FinalBindingConnector
do
   currentpage->p[];
   (if p[] <> none then
       (if p.struc <= Palette## then
           'CurrentPage is a Palette'->putline; 
        else
           (if p## <= ObjectPage## then
               'CurrentPage is an ObjectPage'->putline
            else
               p[]->op[];
               &op.FinalBindingConnector[]->theConnector[];
               theConnector.InteractiveNew;
               
           if);
           
       if)
   if)
#)  

-- RelationsMenuPattern: Descriptor --
(# p: ^Page; op: ^OADPage; theConnector: ^op.PatternVariableConnector
do
   currentpage->p[];
   (if p[] <> none then
       (if p.struc <= Palette## then
           'CurrentPage is a Palette'->putline; 
        else
           (if p## <= ObjectPage## then
               'CurrentPage is an ObjectPage'->putline
            else
               p[]->op[];
               &op.PatternVariableConnector[]->theConnector[];
               theConnector.InteractiveNew;
               
           if);
           
       if)
   if)
#)  

-- RelationsMenuOTOHit: Descriptor --
(# p: ^Page; op: ^OADPage; theConnector: ^op.OTOAssociationRelation
do
   currentpage->p[];
   (if p[] <> none then
       (if p.struc <= Palette## then
           'CurrentPage is a Palette'->putline; 
        else
           (if p## <= ObjectPage## then
               'CurrentPage is an ObjectPage'->putline
            else
               p[]->op[];
               &op.OTOAssociationRelation[]->theConnector[];
               theConnector.InteractiveNew;
               
           if);
           
       if)
   if)
#)  

-- RelationsMenuOTMHit: Descriptor --
(# p: ^Page; op: ^OADPage; theConnector: ^op.OTMAssociationRelation
do
   currentpage->p[];
   (if p[] <> none then
       (if p.struc <= Palette## then
           'CurrentPage is a Palette'->putline; 
        else
           (if p## <= ObjectPage## then
               'CurrentPage is an ObjectPage'->putline
            else
               p[]->op[];
               &op.OTMAssociationRelation[]->theConnector[];
               theConnector.InteractiveNew;
               
           if);
           
       if)
   if)
#)  

-- RelationsMenuMTMHit: Descriptor --
(# p: ^Page; op: ^OADPage; theConnector: ^op.MTMAssociationRelation
do
   currentpage->p[];
   (if p[] <> none then
       (if p.struc <= Palette## then
           'CurrentPage is a Palette'->putline; 
        else
           (if p## <= ObjectPage## then
               'CurrentPage is an ObjectPage'->putline
            else
               p[]->op[];
               &op.MTMAssociationRelation[]->theConnector[];
               theConnector.InteractiveNew;
               
           if);
           
       if)
   if)
#)  

-- RelationsMenuInit: Descriptor --
(# 
do
   (UserMenu6+1,'Static reference')->StaticItem.init;
   (UserMenu6+2,'Static component reference')->StaticComponent.init;
   (UserMenu6+3,'Dynamic reference')->DynamicItem.init;
   (UserMenu6+4,'Dynamic component reference')->DynamicComponent.init;
   (UserMenu6+5,'-')->sep.init;
   (UserMenu6+7,'Specialization')->Specialization.Init;
   (UserMenu6+8,'Binding of Virtual')->bind.Init;
   (UserMenu6+9,'Final Binding of Virtual')->final.Init;
   (UserMenu6+10,'-')->sep1.init;
   (UserMenu6+11,'Pattern Variable')->pattern.Init;
   (UserMenu6+12,'-')->sep2.init;
   (UserMenu6+13,'One-to-One')->oto.init;
   (UserMenu6+14,'One-to-Many')->otm.init;
   (UserMenu6+15,'Many-to-Many')->mtm.init;
   sep.disable;
   sep1.disable;
   sep2.disable
#)  

-- DumpSifEditorList: Descriptor --
(#  do SifEditorList.dump #)  

-- FrejaViewMenuInit: Descriptor --
(#  do (* (UserMenu4+24,'Dump SifEditorList')->DumpSifEditorList.init*)  #)  

