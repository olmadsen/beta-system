ORIGIN '../frejalib';
INCLUDE 'frejabody';
-- FrejaFileMenuNewBETAProgram: Descriptor --
(# (*t: @text*) theOADDocument: ^OADDocument
do
   (if switch[40] then 'Freja: Create a new fragment'->putline if);
   none ->theController.globalSifCommands.newBETAProgram;
   (if (theDocument[] <> none ) and (currentDiagramName[] = none ) then
       theDocument[]->theOADDocument[];
       theOADDocument.theGroupPage.patternDiagrams.theList.scanFragmentDiagrams
         (#  do ((thisDiagram.theGroup).name).copy->currentDiagramName[] #);
       (if currentDiagramName[] <> none then
           '.diag'->currentDiagramName.append;
           (theOADDocument.theWorkPage.currentFocus.theSifEditor).
           removeOptionals
        else
           'New BETA Program: Group has no name?!'->putline
       if)
   if);
   (*  (if theDocument[]
    // none then
    &OADDocument[]->theDocument[]->theOADDocument[];
    theDocument.new;
    theOADDocument.CurrentPage->theOADDocument.theWorkPage[];
    'WorkSheet'->theOADDocument.theWorkPage.PageTitle;
    &theOADDocument.OADPage[]->theOADDocument.theGroupPage[];
    theOADDocument.theGroupPage.InvisibleNew;
    theOADDocument.theWorkPage[]->theOADDocument.CurrentPage;
    'Group Window'->theOADDocument.theGroupPage.PageTitle;
    
    if);
    ('Enter file name:','')
    ->FrejaPromptForText
    (#
    confirm::< 
    (# 
    do
    theText->t;
    t[]->theController.globalSifCommands.newBETAProgram;
    (if currentDiagramName[] = none then
    theText[]->currentDiagramName[];
    '.diag'->currentDiagramName.append
    if)
    #)
    #)*)
   
#)  

-- FrejaFileMenuNewBETALibrary: Descriptor --
(# (*t: @text;*) theOADDocument: ^OADDocument
do
   (if switch[40] then 'Freja: Create a new fragment'->putline if);
   none ->theController.globalSifCommands.newBETALibrary;
   (if (theDocument[] <> none ) and (currentDiagramName[] = none ) then
       theDocument[]->theOADDocument[];
       theOADDocument.theGroupPage.patternDiagrams.theList.scanFragmentDiagrams
         (#  do ((thisDiagram.theGroup).name).copy->currentDiagramName[] #);
       (if currentDiagramName[] <> none then
           '.diag'->currentDiagramName.append;
           (theOADDocument.theWorkPage.currentFocus.theSifEditor).
           removeOptionals
        else
           'New BETA Library: Group has no name?!'->putline
       if)
   if);
   (*  (if theDocument[]
    // none then
    &OADDocument[]->theDocument[]->theOADDocument[];
    theDocument.new;
    theOADDocument.CurrentPage->theOADDocument.theWorkPage[];
    'WorkSheet'->theOADDocument.theWorkPage.PageTitle;
    &theOADDocument.OADPage[]->theOADDocument.theGroupPage[];
    theOADDocument.theGroupPage.InvisibleNew;
    theOADDocument.theWorkPage[]->theOADDocument.CurrentPage;
    'Group Window'->theOADDocument.theGroupPage.PageTitle;
    
    if);
    ('Enter file name:','')
    ->FrejaPromptForText
    (#
    confirm::<
    (# 
    do
    theText->t;
    t[]->theController.globalSifCommands.newBETALibrary;
    (if currentDiagramName[] = none then
    theText[]->currentDiagramName[];
    '.diag'->currentDiagramName.append
    if)
    #)
    #)*)
   
#)  

-- frejaHideShowSifItem: DoPart --
do
   (if sifHidden then
       false->sifHidden; theFragmentBrowser.ymerBrowser.show; 'Hide Sif'->rename
    else
       true->sifHidden; theFragmentBrowser.ymerBrowser.hide; 'Show Sif'->rename
   if)  

-- FrejaFileMenuQuit: Descriptor --
(#
   ok: @Boolean;
   frejaFile,autosaveFrejaFile,diagFile,autosaveDiagFile: @file;
   groupFile,autosaveGroupFile: @file;
   groupName,frejaFileName,autoSaveFrejaFileName,help: ^text;
   doNotSave,askSave: @boolean
do
   doSave:
   (if currentDiagramName[] <> none then
       currentDiagramName->prependCurrentPath->diagFile.name;
       '#'->((diagFile.name).copy).append->autosaveDiagFile.name;
       (if switch[17] then
           'Freja FrejaFileMenuQuit:'->putLine;
           diagFile.name->putLine;
           autosaveDiagFile.name->putLine;
           
       if);
       (if theDocument[] <> none then
           (if theDocument.Modified then
               (none ,'Quit','Save Current Diagram?')
                 ->theFragmentBrowser.promptForBoolean
                   (#
                      ok::<  (#  do true->doQuit; Save.hit #);
                      notOK::<  (#  do true->doNotSave #);
                      
                   #)
            else
               (if autosaveDiagFile.entry.exists then
                   (if diagFile.entry.exists then
                       (if autosaveDiagFile.entry.modtime >
                       diagFile.entry.modtime then
                       (* the diagram has been modified *)
                           true->askSave
                        else
                           true->doNotSave
                       if)
                    else
                       true->askSave
                   if);
                   (if askSave then
                       (none ,'Quit','Save Current Diagram?')
                         ->theFragmentBrowser.promptForBoolean
                           (#
                              ok::<  (#  do true->doQuit; Save.hit #);
                              notOK::<  (#  do true->doNotSave #);
                              
                           #)
                    else
                       true->doNotSave
                   if)
                else
                   true->doNotSave
               if)
           if);
           (if doNotSave then
               currentDiagramName.copy->groupName[];
               groupName->removeExtension->groupName;
               '.freja'->(groupName.copy).append->frejaFileName[];
               frejaFileName->prependCurrentPath->frejaFile.name;
               '.freja#'->((frejaFile.name).copy).append
                 ->autosaveFrejaFileName[]->autosaveFrejaFile.name;
               (if autosaveFrejaFile.entry.exists then
                   autosaveFrejaFileName
                     ->scanAstFiles
                       (# 
                       do
                          currentGroupName->groupName;
                          mps.astFileExtension->groupName.append;
                          groupName->prependCurrentPath->groupFile.name;
                          '#'->((groupFile.name).copy).append
                            ->autosaveGroupFile.name;
                          (if switch[17] then
                              groupName[]->putLine;
                              autosaveGroupFile.name->putLine;
                              (* tildeGroupFile.name->putLine*)
                              
                          if);
                          (if autosaveGroupFile.entry.exists then
                              'rm '->help[];
                              mps.astFileExtension->help.puttext;
                              '#'->help.puttext;
                              help[]->putLine;
                              autosaveGroupFile.delete
                          if)
                          (* no not anymore 
                           (if tildeGroupFile.entry.exists and
                           groupFile.entry.exists then
                           'mv .ast~ .ast'->putLine;
                           groupFile.name
                           ->tildeGroupFile.entry.rename
                           if)
                           *)
                       #);
                   (if autosaveDiagFile.entry.exists then
                       'rm .diag#'->putLine; autoSaveDiagFile.delete
                   if);
                   'rm .freja#'->putLine;
                   autosaveFrejaFile.delete
               if);
               (normal,' ')->stop
           if)
        else
           (normal,' ')->stop
       if)
    else
       (normal,' ')->stop
   if)
#)
(*
 -- FrejaOptionsMenuInit: Descriptor --
 (#  do (UserMenu3+13,'With Dexter')->WithDexterItem.init;  #)  
 
 -- FrejaOptionsMenuCheckMarks: Descriptor --
 (#  do withDexter->WithDexterItem.check #)  
 *)  

-- FrejaUndoItem: Descriptor --
(#
   thePage: ^Page;
   theOADPage: ^OADPage;
   theObject: ^theOADPage.DesignObject;
   theNode: ^theOADPage.PatternDiagramNode;
   se: ^sifEditor
do
   currentPage->thePage[];
   (if thePage[] <> none then
       (if thePage## <= OADPage## then
           thePage[]->theOADPage[];
           (if theOADPage.canUndo then
               theOADPage.CurrentObject->theObject[];
               (if theObject[] <> none then
                   (if theObject## <= theOADPage.PatternDiagramNode## then
                       theObject[]->theNode[];
                       theNode.theSifEditor->se[];
                       (if se[] <> none then
                           se.undo
                        else
                           'Undo: sifEditor is none??'->putline
                       if)
                   if)
                else
                   'No current object - can not undo'->putline
               if)
           if)
        else
           'Undo not implemented on this type of page'->alertUser
       if)
    else
       'Undo: no currentPage!'->alertUser
   if)
#)  

-- FrejaCutItem: Descriptor --
(#
   thePage: ^Page;
   theOADPage: ^OADPage;
   theObjectPage: ^ObjectPage;
   theObject: ^thePage.DesignObject;
   theNode: ^theOADPage.PatternDiagramNode;
   theListDiagram: ^theOADPage.ListDiagram;
   thePatternNode: ^theListDiagram.PatternNode;
   deletableConnector: ^theOADPage.DeletableConnector;
   anAST: ^MPS.AST;
   t: ^Text;
   group: ^ObjectList;
   isGroup: @boolean
do
   thisOp:
     (# 
     do
        currentPage->thePage[];
        (if thePage[] <> none then
            (if thePage## <= OADPage## then
                thePage[]->theOADPage[];
                (if (theOADPage.currentGroup->group[]) <> none then
                    true->isGroup;
                    group.scan
                      (# 
                      do
                         (if (current## <= theOADPage.UserDataNode##) or
                         (current## <= theOADPage.DeletableConnector##) then
                             'Cutting groups including parts of diagrams is not allowed'
                               ->alertUser;
                             leave thisOp
                         if)
                      #)
                if);
                (if isGroup then
                    false->doOADPaste;
                    false->doObjectPaste;
                    false->pasteGroupWithOAD;
                    docEditMenu.cutItem.execute;
                    FrejaEditMenu.iPaste.enable
                 else
                    theOADPage.CurrentObject->theObject[];
                    (if theObject[] <> none then
                        doCut:
                        (if theObject## <= theOADPage.PatternDiagramNode## then
                            theObject[]->theNode[];
                            theNode.theDiagram->theListDiagram[];
                            (if theNode## <= theListDiagram.title## then
                                (if theListDiagram.theParentNode <> none then
                                    theListDiagram.theParentNode
                                      ->theOADPage.currentObject;
                                    (theNode[],theListDiagram.theParentNode)
                                      ->theOADPage.changedFocus;
                                    theListDiagram.theParentNode->theNode[];
                                    (theListDiagram.theParentNode).theDiagram
                                      ->theListDiagram[]
                                      (* this is realy ugly and except from that
                                       cheating the compiler,
                                       but what the heck, it works! :-) *)
                                 else
                                    'Only diagrams that correspond to patterns can be cut'
                                      ->alertUser;
                                    leave doCut
                                if)
                            if);
                            theNode.getASTNode->anAST[];
                            (if anAST[] <> none then
                                (anAST[],1)->(theNode.theSifEditor).changeFocus
                            if);
                            true->doOADPaste;
                            false->doObjectPaste;
                            false->pasteGroupWithOAD;
                            docEditMenu.copyItem.execute;
                            FrejaEditMenu.iPaste.enable;
                            (theNode.theSifEditor).cut
                         else
                            (if theObject## <= theOADPage.DeletableConnector##
                             then
                                'Relations cannot be cut - use clear instead'
                                  ->alertUser
                             else
                                false->doOADPaste;
                                false->doObjectPaste;
                                false->pasteGroupWithOAD;
                                docEditMenu.cutItem.execute;
                                FrejaEditMenu.iPaste.enable
                            if)
                        if)
                     else
                        false->doOADPaste;
                        false->doObjectPaste;
                        false->pasteGroupWithOAD;
                        docEditMenu.cutItem.execute;
                        FrejaEditMenu.iPaste.enable
                    if)
                if)
             else
                (if thePage## <= ObjectPage## then
                    thePage[]->theObjectPage[];
                    (if (theObjectPage.currentGroup->group[]) <> none then
                        true->isGroup;
                        group.scan
                          (# 
                          do
                             (if
                             (current## <= theObjectPage.ObjectDiagramNode##)
                              then
                                 'Cutting groups including parts of diagrams is not allowed'
                                   ->alertUser;
                                 leave thisOp
                             if)
                          #)
                    if);
                    (if isGroup then
                        false->doOADPaste;
                        false->doObjectPaste;
                        false->pasteGroupWithOAD;
                        docEditMenu.cutItem.execute;
                        FrejaEditMenu.iPaste.enable
                     else
                        theObjectPage.CurrentObject->theObject[];
                        (if theObject[] <> none then
                            (if theObject## <= theObjectPage.ObjectDiagramNode##
                             then
                                'Cutting nodes in object diagrams not yet implemented'
                                  ->alertUser
                             else
                                false->doOADPaste;
                                false->doObjectPaste;
                                false->pasteGroupWithOAD;
                                docEditMenu.cutItem.execute;
                                FrejaEditMenu.iPaste.enable
                            if)
                         else
                            false->doOADPaste;
                            false->doObjectPaste;
                            false->pasteGroupWithOAD;
                            docEditMenu.cutItem.execute;
                            FrejaEditMenu.iPaste.enable
                        if)
                    if)
                 else
                    false->doOADPaste;
                    false->doObjectPaste;
                    false->pasteGroupWithOAD;
                    docEditMenu.cutItem.execute;
                    FrejaEditMenu.iPaste.enable
                if)
            if)
         else
            'No current page'->alertUser
        if)
     #)
#)  

-- FrejaCopyItem: Descriptor --
(#
   thePage: ^Page;
   theOADPage: ^OADPage;
   theObjectPage: ^ObjectPage;
   theObject: ^thePage.DesignObject;
   theNode: ^theOADPage.PatternDiagramNode;
   anAST: ^MPS.AST;
   t: ^Text;
   group: ^ObjectList;
   isGroup: @boolean
do
   thisOp:
     (# 
     do
        currentPage->thePage[];
        (if thePage[] <> none then
            (if thePage## <= OADPage## then
                thePage[]->theOADPage[];
                (if (theOADPage.currentGroup->group[]) <> none then
                    true->isGroup;
                    false->pasteGroupWithOAD;
                    group.scan
                      (# 
                      do
                         (if (current## <= theOADPage.UserDataNode##) or
                         (current## <= theOADPage.DeletableConnector##) then
                             true->pasteGroupWithOAD
                         if)
                      #)
                if);
                (if isGroup then
                    false->doOADPaste;
                    false->doObjectPaste;
                    docEditMenu.copyItem.execute;
                    FrejaEditMenu.iPaste.enable
                 else
                    theOADPage.CurrentObject->theObject[];
                    (if theObject[] <> none then
                        (if theObject## <= theOADPage.PatternDiagramNode## then
                            theObject[]->theNode[];
                            theNode.getASTNode->anAST[];
                            (if anAST[] <> none then
                                (anAST[],1)->(theNode.theSifEditor).changeFocus
                            if);
                            true->doOADPaste;
                            false->doObjectPaste;
                            false->pasteGroupWithOAD;
                            (theNode.theSifEditor).copy;
                            docEditMenu.copyItem.execute;
                            FrejaEditMenu.iPaste.enable
                         else
                            false->doOADPaste;
                            false->doObjectPaste;
                            false->pasteGroupWithOAD;
                            docEditMenu.copyItem.execute;
                            FrejaEditMenu.iPaste.enable
                        if)
                     else
                        false->doOADPaste;
                        false->doObjectPaste;
                        false->pasteGroupWithOAD;
                        docEditMenu.copyItem.execute;
                        FrejaEditMenu.iPaste.enable
                    if)
                if)
             else
                (if thePage## <= ObjectPage## then
                    thePage[]->theObjectPage[];
                    (if (theObjectPage.currentGroup->group[]) <> none then
                        true->isGroup;
                        false->pasteGroupWithOAD;
                        group.scan
                          (# 
                          do
                             (if
                             (current## <= theObjectPage.ObjectDiagramNode##)
                              then
                                 true->pasteGroupWithOAD
                             if)
                          #)
                    if);
                    (if isGroup then
                        false->doOADPaste;
                        false->doObjectPaste;
                        docEditMenu.copyItem.execute;
                        FrejaEditMenu.iPaste.enable
                     else
                        theObjectPage.CurrentObject->theObject[];
                        (if theObject[] <> none then
                            (if theObject## <= theObjectPage.ObjectDiagramNode##
                             then
                                true->doObjectPaste;
                                false->doOADPaste;
                                false->pasteGroupWithOAD;
                                docEditMenu.copyItem.execute;
                                FrejaEditMenu.iPaste.enable
                             else
                                false->doOADPaste;
                                false->doObjectPaste;
                                false->pasteGroupWithOAD;
                                docEditMenu.copyItem.execute;
                                FrejaEditMenu.iPaste.enable
                            if)
                         else
                            false->doOADPaste;
                            false->doObjectPaste;
                            false->pasteGroupWithOAD;
                            docEditMenu.copyItem.execute;
                            FrejaEditMenu.iPaste.enable
                        if)
                    if)
                 else
                    false->doOADPaste;
                    false->doObjectPaste;
                    false->pasteGroupWithOAD;
                    docEditMenu.copyItem.execute;
                    FrejaEditMenu.iPaste.enable
                if)
            if)
         else
            'No current page'->alertUser
        if)
     #)
#)  

-- FrejaPasteBeforeItem: Descriptor --
(#
   thePage: ^Page;
   theOADPage: ^OADPage;
   theObject: ^theOADPage.DesignObject;
   theNode: ^theOADPage.PatternDiagramNode;
   anAST: ^MPS.AST;
   t: ^Text
do
   currentPage->thePage[];
   (if thePage[] <> none then
       (if thePage## <= OADPage## then
           thePage[]->theOADPage[];
           theOADPage.CurrentObject->theObject[];
           (if doOADPaste then
               (if theObject[] <> none then
                   (if theObject## <= theOADPage.PatternDiagramNode## then
                       theObject[]->theNode[];
                       theNode.getASTNode->anAST[];
                       (if anAST[] <> none then
                           (anAST[],1)->(theNode.theSifEditor).changeFocus
                       if);
                       (if theOADPage.canPaste then
                           (if theOADPage.canListInsert then
                               (theNode.theSifEditor).before;
                               (theNode.theSifEditor).paste
                           if)
                       if)
                   if)
                else
                   'No current object!'->putline
               if)
            else
               docEditMenu.pasteItem.execute
           if)
        else
           'Paste Before not implemented on this type of page'->alertUser
       if)
    else
       'No current page'->alertUser
   if)
#)  

-- FrejaPasteItem: Descriptor --
(#
   thePage: ^Page;
   theOADPage: ^OADPage;
   theObject: ^thePage.DesignObject;
   thePatternDiagramNode: ^theOADPage.PatternDiagramNode;
   anAST: ^MPS.AST
do
   currentPage->thePage[];
   (if thePage[] <> none then
       (if thePage## <= OADPage## then
           thePage[]->theOADPage[];
           (if doOADPaste then
               theOADPage.CurrentObject->theObject[];
               (if theObject[] <> none then
                   (if theObject## <= theOADPage.PatternDiagramNode## then
                       theObject[]->thePatternDiagramNode[];
                       thePatternDiagramNode.getASTNode->anAST[];
                       (if anAST[] <> none then
                           (anAST[],1)
                             ->(thePatternDiagramNode.theSifEditor).changeFocus
                       if);
                       (if theOADPage.canPaste then
                           (thePatternDiagramNode.theSifEditor).paste
                       if)
                   if)
                else
                   'No current object!'->alertUser
               if)
            else
           (* menuID.EditMenu.paste->DSUIMenuExecute *)
               (if doObjectPaste then
                   'Clipboard contains object from object diagram - can not paste on Work Sheet'
                     ->alertUser
                else
                   (if not pasteGroupWithOAD then
                       thePage.designPaste
                    else
                       'Clipboard contains group with parts of diagram - can only paste on graphics page'
                         ->alertUser
                   if)
               if);
               
           if)
        else
           (if thePage## <= ObjectPage## then
               (if doObjectPaste then
                   'Clipboard contains object from object diagram - only paste on graphics page currently implemented'
                     ->alertUser
                else
                   (if doOADPaste then
                       'Clipboard contains part of pattern diagram - can not paste on Object Page'
                         ->alertUser
                    else
                       (if not pasteGroupWithOAD then
                           thePage.designPaste
                        else
                           'Clipboard contains group with parts of diagram - can only paste on graphics page'
                             ->alertUser
                       if)
                   if)
               if)
            else
               thePage.designPaste
           if)
       if)
    else
       'No current page'->alertUser
   if)
#)  

-- FrejaPasteAfterItem: Descriptor --
(#
   thePage: ^Page;
   theOADPage: ^OADPage;
   theObject: ^theOADPage.DesignObject;
   theNode: ^theOADPage.PatternDiagramNode;
   anAST: ^MPS.AST;
   t: ^Text
do
   currentPage->thePage[];
   (if thePage[] <> none then
       (if thePage## <= OADPage## then
           thePage[]->theOADPage[];
           theOADPage.CurrentObject->theObject[];
           (if doOADPaste then
               (if theObject[] <> none then
                   (if theObject## <= theOADPage.PatternDiagramNode## then
                       theObject[]->theNode[];
                       theNode.getASTNode->anAST[];
                       (if anAST[] <> none then
                           (anAST[],1)->(theNode.theSifEditor).changeFocus
                       if);
                       (if theOADPage.canPaste then
                           (if theOADPage.canListInsert then
                               (theNode.theSifEditor).after;
                               (theNode.theSifEditor).paste
                           if)
                       if)
                   if)
                else
                   'No current object!'->putline
               if)
            else
               docEditMenu.pasteItem.execute
           if)
        else
           'Paste After not implemented on this type of page'->alertUser
       if)
    else
       'No current page'->alertUser
   if)
#)  

-- FrejaClearItem: Descriptor --
(#
   thePage: ^Page;
   theOADPage: ^OADPage;
   theObjectPage: ^ObjectPage;
   theObject: ^thePage.DesignObject;
   theNode,thePatternNode: ^theOADPage.PatternDiagramNode;
   deletableConnector: ^theOADPage.DeletableConnector;
   regionList: ^ObjectList;
   anAST: ^MPS.AST;
   t: ^Text;
   theListDiagram: ^theOADPage.ListDiagram
do
   currentPage->thePage[];
   (if thePage[] <> none then
       (if thePage## <= OADPage## then
           thePage[]->theOADPage[];
           theOADPage.CurrentObject->theObject[];
           (if theObject[] <> none then
               doClear:
               (if theObject## <= theOADPage.PatternDiagramNode## then
                   theObject[]->theNode[];
                   theNode.theDiagram->theListDiagram[];
                   (if theNode## <= theListDiagram.title## then
                       (if theListDiagram.theParentNode <> none then
                           theListDiagram.theParentNode
                             ->theOADPage.currentObject;
                           (theNode[],theListDiagram.theParentNode)
                             ->theOADPage.changedFocus;
                           theListDiagram.theParentNode->theNode[];
                           (theListDiagram.theParentNode).theDiagram
                             ->theListDiagram[]
                             (* this is realy ugly and except from that
                              cheating the compiler,
                              but what the heck, it works! :-) *)
                        else
                           'Only diagrams that correspond to patterns can be cleared'
                             ->alertUser;
                           leave doClear
                       if)
                   if);
                   theNode.getASTNode->anAST[];
                   (if anAST[] <> none then
                       (anAST[],1)->(theNode.theSifEditor).changeFocus
                   if);
                   (theNode.theSifEditor).clear
                else
                   (if theObject## <= theOADPage.DeletableConnector## then
                       theObject[]->deletableConnector[];
                       deletableConnector.onDelete
                   if);
                   (if
                   (not (theObject## <= theOADPage.AssociationConnector##))
                   (* associationConn.'s are deleted by onDelete
                    because endpoints are deleted here *) and
                   (not (theObject## <= theOADPage.UserDataLabelNode##)) then
                       theObject.delete
                    else
                       (if theObject## <= theOADPage.UserDataLabelNode## then
                           theFragmentBrowser.system.beep
                       if)
                   if)
               if)
            else
               docEditMenu.clearItem.execute
           if)
        else
           (if thePage## <= ObjectPage## then
               thePage[]->theObjectPage[];
               theObjectPage.currentObject->theObject[];
               (if theObject[] <> none then
                   (if theObject## <= theObjectPage.ObjectDiagramNode## then
                       'Clear on objects in object diagrams not implemented yet'
                         ->alertUser
                    else
                       theObject.delete
                   if)
                else
                   'No current object'->alertUser
               if)
            else
               thePage.currentObject->theObject[];
               (if theObject[] <> none then
                   theObject.delete
                else
                   'No current object'->alertUser
               if)
           if)
       if)
    else
       'No current page'->alertUser
   if)
#)  

-- InsertBeforeHit: Descriptor --
(#
   thePage: ^Page;
   theOADPage: ^OADPage;
   theObject: ^theOADPage.PatternDiagramNode;
   theDesObj: ^theOADPage.DesignObject;
   t: ^text;
   anAST: ^MPS.AST
do
   (if switch[60] then 'InsertBefore'->putline if);
   currentPage->thePage[];
   (if thePage[] <> none then
       (if thePage## <= OADPage## then
           thePage[]->theOADPage[];
           theOADPage.CurrentObject->theDesObj[];
           (if theDesObj[] <> none then
               (if theDesObj## <= theOADPage.PatternDiagramNode## then
                   theDesObj[]->theObject[];
                   theObject.getASTNode->anAST[];
                   (if anAST[] <> none then
                       (anAST[],1)->(theObject.theSifEditor).changeFocus
                   if);
                   (if theOADPage.canListInsert then
                       (theObject.theSifEditor).before
                   if)
                else
                   'Current focus is not a pattern diagram node!'->putline
               if)
           if)
        else
           'Insert Before not implemented on this type of page'->alertUser
       if)
    else
       'No current page'->alertUser
   if);
   
#)  

-- EditMenuInit: Descriptor --
(# 
do (* design gets internal error for items above status+3! Why? *)
(* (UserMenu2+2,'-')->sep1.init;
 sep1.disable; *)
   (UserMenu2+1,'Undo                     Alt-z')->iUndo.init;
   (UserMenu2+2,'Cut                      Alt-x')->iCut.init;
   (UserMenu2+3,'Copy                     Alt-c')->iCopy.init;
   (UserMenu2+4,'Paste Before             Alt-U')->iPasteBefore.init;
   (UserMenu2+5,'Paste                    Alt-v')->iPaste.init;
   (UserMenu2+6,'Paste After              Alt-A')->iPasteAfter.init;
   (UserMenu2+7,'Clear                      DEL')->iClear.init;
   (UserMenu2+8,'-')->sep2.init;
   sep2.disable;
   (UserMenu2+9,'Edit Name                Alt-w')->iEditName.init;
   (UserMenu2+10,'Open Subeditor           Alt-j')->iTextEdit.init;
   (UserMenu2+11,'Edit Other Text          Alt-t')->iEditOtherText.init;
   (*  (UserMenu2+10,'Revert Textediting       (ctrl+r)')->irevertTextEdit.init;*)
   (UserMenu2+12,'-')->sep3.init;
   sep3.disable;
   (UserMenu2+13,'Insert Before            Alt-u')->insertbeforeItem.init;
   (UserMenu2+14,'Insert After             Alt-a')->insertafter.init;
   (UserMenu2+15,'-')->sep4.init;
   sep4.disable;
   (UserMenu2+16,'Remove Optionals         Alt-n')->iRemoveOptionals.init;
   (UserMenu2+17,'Show Optionals           Alt-l')->iShowOptionals.init;
   iClear.enable;
   (UserMenu2+18,'-')->sep5.init;
   (UserMenu2+19,'Check')->iCheck.init;
   iUndo.disable;
   
#)  

-- FrejaEditMenuIEditName: DoPart --
do
     (#
        thePage: ^Page;
        p: ^OADPage;
        thePatternDiagramNode: ^p.PatternDiagramNode;
        theDiagram: ^p.Diagram;
        theTitle: ^theDiagram.title;
        c: ^p.DesignObject;
        doNotEdit,didCancel: @Boolean;
        anAST: ^mps.ast;
        anExp: ^mps.expanded;
        theNameDcl: ^betaGram.NameDcl;
        message: ^text;
        t: ^text;
        ok: @boolean;
        errorPos: @integer;
        parseErrorText: ^Text
     do
        CurrentPage->thePage[];
        (if thePage[] <> none then
            (if thePage## <= OADPage## then
                thePage[]->p[];
                (if p[] <> theGroupPage[] then
                    p.CurrentObject->c[];
                    (if c[] <> none then
                        (if c## <= p.PatternDiagramNode## then
                            c[]->thePatternDiagramNode[];
                            thePatternDiagramNode.theDiagram->theDiagram[];
                            (if thePatternDiagramNode## <= theDiagram.title##
                             then
                                (if (theDiagram## < p.PatternAttDiagram##) or
                                (theDiagram.theParentNode = none ) then
                                    'Textediting fragmentform name is currently disabled'
                                      ->alertUser;
                                    true->doNotEdit
                                 else
                                    thePatternDiagramNode[]->theTitle[]
                                if)
                            if)
                        if);
                        (if (thePatternDiagramNode[] <> none ) and
                        (not doNotEdit) then
                            (if thePatternDiagramNode.theSifEditor <> none then
                                (if (thePatternDiagramNode.theSifEditor).fe[] <>
                                none then
                                    thePatternDiagramNode.getASTNode->anAST[];
                                    (if theTitle[] <> none then
                                        anAST.father->anExp[];
                                        (if anExp.symbol = betaGram.StaticItem
                                         then
                                            anExp.father->anExp[]
                                        if);
                                        anExp.getSon1->anExp[];
                                        anExp.getSon1->theNameDcl[]
                                     else
                                        (if anAST[] <> none then
                                            anAST[]->anExp[];
                                            anExp.getSon1->anExp[];
                                            anExp.getSon1->theNameDcl[]
                                        if)
                                    if);
                                    (if theNameDcl[] <> none then
                                        theNameDcl.getNameDecl->anAST[];
                                        (if anAST.kind = mps.kinds.unExpanded
                                         then
                                            '<<NameDecl>>'->t[]
                                         else
                                            theNameDcl.getText->t[]
                                        if);
                                        'Name: '->message[];
                                        doPrompt:
                                          (# 
                                          do
                                             (message[],t[])
                                               ->FrejaPromptForText
                                                 (#
                                                    confirm::< 
                                                      (# 
                                                      do
                                                         (if theText[] <> none
                                                          then
                                                             (if theText.length
                                                             > 0 then
                                                                 theText[]->t[];
                                                                 (theNameDcl[],
                                                                  theText)
                                                                   ->
                                                                     (
                                                                     thePatternDiagramNode
                                                                     .
                                                                       theSifEditor
                                                                     ).parse
                                                                   ->
                                                                     (ok,
                                                                      errorPos,
                                                                      parseErrorText[])
                                                             if)
                                                         if)
                                                      #);
                                                    cancel::< 
                                                      (# 
                                                      do true->didCancel
                                                      #)
                                                 #);
                                             (if didCancel then
                                                 leave doPrompt
                                              else
                                                 (if not ok then
                                                     'Edit Name: '->message[];
                                                     parseErrorText[]
                                                       ->message.append;
                                                     restart doPrompt
                                                  else
                                                     thePatternDiagramNode[]
                                                       ->p.currentObject
                                                         (# 
                                                         do true->autoPan
                                                         #);
                                                     thePatternDiagramNode.
                                                       onSelect
                                                     (*(if theTitle[] <> none
                                                      then
                                                      [* set focus on title not on parentnode of title *]
                                                      theTitle[]
                                                      ->p.currentObject
                                                      (# 
                                                      do true->autoPan
                                                      #);
                                                      theTitle.onSelect 
                                                      if)*)
                                                 if)
                                             if)
                                          #)
                                    if)
                                 else
                                    'iTextEdit: No codeeditor for theSifEditor!'
                                      ->putline
                                if)
                             else
                                'iTextEdit: theSifEditor is none'->putline
                            if)
                            (*(if TextModeOn then
                             c.theText.modeOff; 
                             else
                             c.theText.modeOn; 
                             if);
                             (if not p.parseErrorOccurred then
                             not TextModeOn->TextModeOn; TextModeOn->Check
                             else
                             [* c.theText.modeOn *]
                             not TextModeOn->TextModeOn;
                             TextModeOn->Check;
                             false->p.parseErrorOccurred;
                             hit
                             if);*)
                        if);
                        
                    if)
                 else
                    'Textediting on Group Page is currently disabled'->alertUser
                if)
             else
                'Edit Name not implemented on this type of page'->alertUser
            if)
         else
            'No current page'->alertUser
        if);
        
     #)  

-- FrejaEditMenuITextEdit: Descriptor --
(#
   thePage: ^Page;
   p: ^OADPage;
   thePatternDiagramNode: ^p.PatternDiagramNode;
   theDiagram: ^p.Diagram;
   theTitle: ^theDiagram.title;
   c: ^p.DesignObject;
   doNotEdit: @Boolean;
   anAST: ^mps.ast;
   anExp: ^mps.expanded
do
   CurrentPage->thePage[];
   (if thePage[] <> none then
       (if thePage## <= OADPage## then
           thePage[]->p[];
           (if p[] <> theGroupPage[] then
               p.CurrentObject->c[];
               (if c[] <> none then
                   (if c## <= p.PatternDiagramNode## then
                       c[]->thePatternDiagramNode[];
                       thePatternDiagramNode.theDiagram->theDiagram[];
                       (if thePatternDiagramNode## <= theDiagram.title## then
                           (if (theDiagram## < p.PatternAttDiagram##) or
                           (theDiagram.theParentNode = none ) then
                               'Textediting fragmentform name is currently disabled'
                                 ->alertUser;
                               true->doNotEdit
                            else
                               thePatternDiagramNode[]->theTitle[]
                           if)
                       if)
                   if);
                   (if (thePatternDiagramNode[] <> none ) and (not doNotEdit)
                    then
                       (if thePatternDiagramNode.theSifEditor <> none then
                           (if (thePatternDiagramNode.theSifEditor).fe[] <> none
                           then
                               thePatternDiagramNode.getASTNode->anAST[];
                               (if anAST[] <> none then
                                   (anAST[],1)
                                     ->
                                       (thePatternDiagramNode.theSifEditor).
                                       changeFocus
                               if);
                               (thePatternDiagramNode.theSifEditor).fe.
                                 openSubeditor
                            else
                               'iTextEdit: No codeeditor for theSifEditor!'
                                 ->putline
                           if)
                        else
                           'iTextEdit: theSifEditor is none'->putline
                       if)
                       (*(if TextModeOn then
                        c.theText.modeOff; 
                        else
                        c.theText.modeOn; 
                        if);
                        (if not p.parseErrorOccurred then
                        not TextModeOn->TextModeOn; TextModeOn->Check
                        else
                        [* c.theText.modeOn *]
                        not TextModeOn->TextModeOn;
                        TextModeOn->Check;
                        false->p.parseErrorOccurred;
                        hit
                        if);*)
                   if);
                   
               if)
            else
               'Textediting on Group Page is currently disabled'->alertUser
           if)
        else
           'Open Subeditor not implemented on this type of page'->alertUser
       if)
    else
       'No current page'->alertUser
   if);
   
#)  

-- iEditOtherText: DoPart --
do
     (#
        thePage: ^Page;
        theOADPage: ^OADPage;
        theObjectPage: ^ObjectPage;
        theObject: ^thePage.DesignObject
     do
        currentPage->thePage[];
        (if thePage[] <> none then
            thePage.CurrentObject->theObject[];
            (if theObject[] <> none then
                (if thePage## <= OADPage## then
                    thePage[]->theOADPage[];
                    (if (theObject## <= theOADPage.UserDataNode##) or
                    (theObject## <= theOADPage.UserDataLabelNode##) then
                        theFragmentBrowser.system.beep
                     else
                        (if theObject.theText.isModeOn then
                            theObject.theText.modeOff
                         else
                            theObject.theText.modeOn
                        if)
                    if)
                 else
                    (if thePage## <= ObjectPage## then
                        thePage[]->theObjectPage[];
                        (if theObject## <= theObjectPage.ObjectDiagramNode##
                         then
                            'Can not be text edited using this command'
                              ->alertUser
                         else
                            (if theObject.theText.isModeOn then
                                theObject.theText.modeOff
                             else
                                theObject.theText.modeOn
                            if)
                        if)
                     else
                        (if theObject.theText.isModeOn then
                            theObject.theText.modeOff
                         else
                            theObject.theText.modeOn
                        if)
                    if)
                if)
             else
                'No current object'->alertUser
            if)
         else
            'No current page'->alertUser
        if)
     #)  

-- iRevertTextEdit: Descriptor --
(#
   p: ^OADPage;
   c: ^p.DesignObject;
   thePatternDiagramNode: ^p.PatternDiagramNode;
   theListDiagram: ^p.ListDiagram;
   theAbstractNode: ^theListDiagram.AbstractNode;
   theDoc: ^OADdocument
do
   (if switch[60] then 'revert text edit'->putLine if);
   CurrentPage->p[];
   p.CurrentObject->c[];
   (if c[]
    // none then 
    else
       (if TextModeOn
        // true then
           false->p.ongoingTextediting;
           false->p.onGoingTitleEditing;
           false->p.parseErrorOccurred;
           p.theTextBefore->c.theText.set;
           c.theText.modeOff;
           (if c## <= p.PatternDiagramNode## then
               c[]->thePatternDiagramNode[];
               thePatternDiagramNode.theDiagram->theListDiagram[];
               (if thePatternDiagramNode## <= theListDiagram.AbstractNode## then
                   thePatternDiagramNode[]->theAbstractNode[];
                   (theAbstractNode.theText.oldWidth,
                    theAbstractNode.theText.oldHeight)->theAbstractNode.size
               if)
           if)
       if);
       theDocument[]->theDoc[];
       false->TextModeOn->theDoc.FrejaEditMenu.iTextedit.Check;
       
   if)
#)  

-- InsertAfterHit: Descriptor --
(#
   thePage: ^Page;
   theOADPage: ^OADPage;
   theObject: ^theOADPage.PatternDiagramNode;
   theDesObj: ^theOADPage.DesignObject;
   t: ^text;
   anAST: ^MPS.AST
do
   (if switch[60] then 'insertAfter'->putline if);
   currentPage->thePage[];
   (if thePage[] <> none then
       (if thePage## <= OADPage## then
           thePage[]->theOADPage[];
           theOADPage.CurrentObject->theDesObj[];
           (if theDesObj[] <> none then
               (if theDesObj## <= theOADPage.PatternDiagramNode## then
                   theDesObj[]->theObject[];
                   theObject.getASTNode->anAST[];
                   (if anAST[] <> none then
                       (anAST[],1)->(theObject.theSifEditor).changeFocus
                   if);
                   (if theOADPage.canListInsert then
                       (theObject.theSifEditor).after
                   if)
                else
                   'Current focus is not a pattern diagram node!'->putline
               if)
           if)
        else
           'Insert After not implemented on this type of page'->alertUser
       if)
    else
       'No current page'->alertUser
   if);
   
#)  

-- FrejaRemoveOptionalsItem: Descriptor --
(#
   thePage: ^Page;
   theOADPage: ^OADPage;
   theObject: ^theOADPage.PatternDiagramNode;
   theDesObj: ^theOADPage.DesignObject;
   t: ^text;
   anAST: ^MPS.AST
do
   (if switch[60] then 'removeOptionals'->putline if);
   currentPage->thePage[];
   (if thePage[] <> none then
       (if thePage## <= OADPage## then
           thePage[]->theOADPage[];
           theOADPage.CurrentObject->theDesObj[];
           (if theDesObj[] <> none then
               (if theDesObj## <= theOADPage.PatternDiagramNode## then
                   theDesObj[]->theObject[];
                   theObject.getASTNode->anAST[];
                   (if anAST[] <> none then
                       (anAST[],1)->(theObject.theSifEditor).changeFocus
                   if);
                   (theObject.theSifEditor).removeOptionals
                else
                   'Current focus is not a pattern diagram node!'->putline
               if)
           if)
        else
           'Remove Optionals not implemented on this type of page'->alertUser
       if)
    else
       'No current page'->alertUser
   if);
   
#)  

-- FrejaShowOptionalsItem: Descriptor --
(#
   thePage: ^Page;
   theOADPage: ^OADPage;
   theObject: ^theOADPage.PatternDiagramNode;
   theDesObj: ^theOADPage.DesignObject;
   t: ^text;
   anAST: ^MPS.AST
do
   (if switch[60] then 'insertOptionals'->putline if);
   currentPage->thePage[];
   (if thePage[] <> none then
       (if thePage## <= OADPage## then
           thePage[]->theOADPage[];
           theOADPage.CurrentObject->theDesObj[];
           (if theDesObj[] <> none then
               (if theDesObj## <= theOADPage.PatternDiagramNode## then
                   theDesObj[]->theObject[];
                   theObject.getASTNode->anAST[];
                   (if anAST[] <> none then
                       (anAST[],1)->(theObject.theSifEditor).changeFocus
                   if);
                   (theObject.theSifEditor).insertOptionals
                else
                   'Current focus is not a pattern diagram node!'->putline
               if)
           if)
        else
           'Show Optionals not implemented on this type of page'->alertUser
       if)
    else
       'No current page'->alertUser
   if);
   
#)  

-- FrejaCheckItem: Descriptor --
(#
   thePage: ^Page;
   theOADPage: ^OADPage;
   theObject: ^theOADPage.PatternDiagramNode;
   theDesObj: ^theOADPage.DesignObject;
   anAST: ^MPS.AST;
   fg: ^mps.fragmentGroup;
   theListDiagram: ^theOADPage.ListDiagram;
   theNonTerminalNode: ^theListDiagram.NonTerminalNode
do
   (if switch[40] then 'check'->putline if);
   currentPage->thePage[];
   (if thePage[] <> none then
       (if thePage## <= OADPage## then
           thePage[]->theOADPage[];
           theOADPage.CurrentObject->theDesObj[];
           (if theDesObj[] <> none then
               (if theDesObj## <= theOADPage.PatternDiagramNode## then
                   theDesObj[]->theObject[];
                   theObject.getASTNode->anAST[];
                   (if anAST[] <> none then
                       anAST.frag.father->fg[]
                    else
                       theObject.theDiagram->theListDiagram[];
                       theObject[]->theNonTerminalNode[];
                       (theNonTerminalNode.unexp).frag.father->fg[]
                   if);
                   fg[]->theController.globalSifCommands.check
                else
                   'Current focus is not a pattern diagram node!'->putline
               if)
           if)
        else
           'Check can not be invoked from this type of page'->alertUser
       if)
    else
       'No current page'->alertUser
   if);
   
#)  

-- ExpandMenuInit: Descriptor --
(# 
do
   (for i: noOfItems repeat
     &ExpandItem[]->theItems[i][];
     (UserMenu8+i,'                                 ')->theItems[i].init
   for)
#)  

-- ExpandMenuCreateItems: Descriptor --
(# tt,category: ^Text; aItem: ^ExpandItem; symbol,i: @Integer; 
do
   (if list[] <> none then
       (if list.length > 0 then
           (if theGraphicalInterface.switch[12] then
               'Freja: expandmenu.init: '->putText; list[]->putLine; 
           if);
           list.reset;
           list.getatom->tt[];
           (if tt[]
            // none then 
            else
               (if ('Enter'->tt.equal)
                // true then theexpandmenu.deletemenu; 
                else
                   list.reset;
                   1->i;
                   loop:
                   (if 1
                    // 1 then
                       list.getInt->symbol;
                       list.getAtom->category[];
                       (i,symbol,category[])->theItems[i].create;
                       (if list.pos+1 < list.length
                        // true then i+1->i; restart loop
                       if)
                   if)
               if)
           if)
       if)
   if)
#)  

-- ExpandItemCreate: Descriptor --
(# help: ^text
do
   (if (1->syncatname.inxget) = '-'
    // false then
       (if switch[12] then
           'Expand menu create: '->puttext;
           syncatno->putint;
           ' '->puttext;
           syncatname[]->putline
       if);
       syncatname->rename;
       
    // true then
       '--'->help[]; help->rename; Disable; 
   if)
#)  

-- ExpandItemHit: Descriptor --
(# p: ^Page; op: ^OADPage; 
do
(* (if SynCatNo
 // 13 then
 'expanding to RepetitionDecl is not yet implemented!'->AlertUser
 else
 
 if); *)
   (if SynCatNo <> 0
    // true then
       currentpage->p[];
       (if p[] <> none
        // true then
           (if p## <= Palette##
            // true then 'CurrentPage is a Palette'->putline; 
            else
               (if switch[12] then
                   'Expand menu item hit: '->puttext;
                   SynCatNo->putint;
                   ' '->puttext;
                   synCatName[]->putline
               if);
               p[]->op[];
               (SynCatNo,false)->op.doExpand;
               
           if)
       if)
   if)
#)  

-- ExpandMenuDelete: Descriptor --
(# 
do
   (for i: noOfItems repeat
     ' '->theItems[i].rename;
     0->theItems[i].synCatNo;
     none ->theItems[i].synCatName[]
   for)
#)  

-- FrejaViewMenuTraceItem: DoPart --
do theController.globalSifCommands.toggleDebug  

-- AttributeKindMenuInit: Descriptor --
(# 
do
   (UserMenu9+1,'Class                                     Alt-p')
     ->NewPattern.init;
   (UserMenu9+2,'Operation / Local Class                   Alt-h')
     ->LocalPattern.init;
   (UserMenu9+3,'Static Reference Attribute                Alt-o')
     ->PartObject.init;
   (UserMenu9+4,'Dynamic Reference Attribute               Alt-r')
     ->DynamicReference.init;
   (UserMenu9+5,'Virtual Operation/Class                   Alt-i')
     ->VirtualPattern.init;
   (UserMenu9+6,'Binding of Virtual Operation/Class        Alt-m')
     ->BindingOfVirtualPattern.init;
   (UserMenu9+7,'Final Binding of Virtual Operation/Class  Alt-f')
     ->FinalBindOfVirtPattern.init
#)  

-- attrKindItem: DoPart --
do
     (#
        theParentNode: ^op.PatternDiagramNode;
        anAST,keepAST: ^MPS.AST;
        p: ^Page;
        theDesignObject: ^op.DesignObject;
        theListDiagram: ^op.ListDiagram;
        thePatternAttDiagram: ^op.PatternAttDiagram;
        theNonTerminalNode: ^theListDiagram.NonTerminalNode;
        optionalInserted: @boolean;
        theAttributes: ^betaGram.Attributes
     do
        currentpage->p[];
        (if p[] <> none then
            (if p## <= OADPage## then
                (if p[] <> theGroupPage[] then
                    p[]->op[];
                    (if op.currentObject <> none then
                        op.currentObject->theDesignObject[];
                        (if theDesignObject## <= op.PatternDiagramNode## then
                            op.currentFocus[]->op.oldFocus[];
                            theDesignObject[]->op.currentFocus[]
                        if)
                     else
                        'No current object'->alertUser
                    if);
                    (if op.currentFocus[] <> none then
                        (if op.currentFocus.theDiagram <> none then
                            op.currentFocus.theDiagram->theListDiagram[];
                            (if theListDiagram.LocalNodes.empty then
                                (if theListDiagram## <= op.PatternAttDiagram##
                                 then
                                    theListDiagram[]->thePatternAttDiagram[];
                                    (if (thePatternAttDiagram.theAST).symbol =
                                    betaGram.Attributes then
                                        thePatternAttDiagram.theAST
                                          ->theAttributes[];
                                        theAttributes.getSon1->anAST[]
                                          ->keepAST[];
                                        (if anAST.kind = mps.kinds.optional then
                                            (anAST[],'<<AttributeDeclOpt>>')
                                              ->
                                                (op.currentFocus.theSifEditor).
                                                parse
                                        if)
                                    if)
                                 else
                                    op.currentFocus.getASTNode->keepAST[];
                                    (if keepAST[] <> none then
                                        (keepAST[],1)
                                          ->
                                            (op.currentFocus.theSifEditor).
                                            changeFocus
                                    if);
                                    (op.currentFocus.theSifEditor).
                                    insertOptionals
                                if);
                                true->optionalInserted
                            if);
                            op.currentFocus[]->op.oldFocus[];
                            (if theListDiagram.LocalNodes.last <> none then
                                (theListDiagram.LocalNodes.last).elm[]
                                  ->op.currentFocus[]->op.currentObject;
                                op.currentFocus.getASTNode->anAST[];
                                (if anAST[] <> none then
                                    (anAST[],1)
                                      ->
                                        (op.currentFocus.theSifEditor).
                                        changeFocus
                                 else
                                    op.currentFocus.theDiagram
                                      ->theListDiagram[];
                                    op.currentFocus[]->theNonTerminalNode[];
                                    (theNonTerminalNode.unExp,1)
                                      ->
                                        (op.currentFocus.theSifEditor).
                                        changeFocus
                                if);
                                (if op.canListInsert then
                                    (if not optionalInserted then
                                        (op.currentFocus.theSifEditor).after
                                    if);
                                    INNER hit;
                                    FrejaEditMenu.iEditName.hit;
                                    (if optionalInserted then
                                        (if keepAST[] <> none then
                                            (keepAST[],1)
                                              ->
                                                (op.currentFocus.theSifEditor).
                                                changeFocus
                                        if);
                                        (op.currentFocus.theSifEditor).
                                        removeOptionals;
                                        op.oldFocus[]
                                          ->op.currentObject
                                            (#  do true->autoPan #);
                                        op.oldFocus.onSelect
                                     else
                                        op.currentFocus[]
                                          ->op.currentObject
                                            (#  do true->autoPan #);
                                        op.currentFocus.onSelect
                                    if)
                                if)
                             else
                                'Can not insert attributes in diagram - should not happen!'
                                  ->alertUser;
                                'Can not insert attributes in diagram - should not happen!'
                                  ->stdErr.putline
                            if)
                         else
                            'theDiagram is NONE'->putline
                        if)
                     else
                        'No current object'->alertUser
                    if)
                if)
             else
                'Operation not possible on this type of page'->alertUser
            if)
         else
            'No current page'->alertUser
        if)
     #)  

-- AttributeKindMenuNewPattern: Descriptor --
(#
   theParentNode: ^op.PatternDiagramNode;
   anAST,keepAST: ^MPS.AST;
   p: ^Page;
   op: ^OADPage;
   theDesignObject: ^op.DesignObject;
   theListDiagram: ^op.ListDiagram;
   thePatternAttDiagram: ^op.PatternAttDiagram;
   theNonTerminalNode: ^theListDiagram.NonTerminalNode;
   optionalInserted: @boolean;
   theAttributes: ^betaGram.Attributes
do
   currentpage->p[];
   (if p[] <> none then
       (if p## <= OADPage## then
           (if p[] <> theGroupPage[] then
               p[]->op[];
               (if op.currentObject <> none then
                   op.currentObject->theDesignObject[];
                   (if theDesignObject## <= op.PatternDiagramNode## then
                       op.currentFocus[]->op.oldFocus[];
                       theDesignObject[]->op.currentFocus[]
                   if)
                else
                   'No current object'->alertUser
               if);
               (if op.currentFocus[] <> none then
                   (if op.currentFocus.theDiagram <> none then
                       op.currentFocus.theDiagram->theListDiagram[];
                       getTopMostDiagram:
                         (# b1,b2: @Boolean
                         do
                            (theListDiagram## <= op.PatternAttDiagram##)->b1;
                            theListDiagram[]->theListDiagram.isDescriptorDiagram
                              ->b2;
                            (if b1 or b2 then
                                (if theListDiagram.LocalNodes.empty then
                                    (if theListDiagram## <=
                                    op.PatternAttDiagram## then
                                        theListDiagram[]
                                          ->thePatternAttDiagram[];
                                        (if
                                        (thePatternAttDiagram.theAST).symbol =
                                        betaGram.Attributes then
                                            thePatternAttDiagram.theAST
                                              ->theAttributes[];
                                            theAttributes.getSon1->anAST[]
                                              ->keepAST[];
                                            (if anAST.kind = mps.kinds.optional
                                             then
                                                (anAST[],'<<AttributeDeclOpt>>')
                                                  ->
                                                    (
                                                    op.currentFocus.theSifEditor
                                                    ).parse
                                            if)
                                        if)
                                     else
                                        op.currentFocus.getASTNode->keepAST[];
                                        (if keepAST[] <> none then
                                            (keepAST[],1)
                                              ->
                                                (op.currentFocus.theSifEditor).
                                                changeFocus
                                        if);
                                        (op.currentFocus.theSifEditor).
                                        insertOptionals
                                    if);
                                    true->optionalInserted
                                if);
                                op.currentFocus[]->op.oldFocus[];
                                (theListDiagram.LocalNodes.last).elm[]
                                  ->op.currentFocus[]->op.currentObject;
                                op.currentFocus.getASTNode->anAST[];
                                (if anAST[] <> none then
                                    (anAST[],1)
                                      ->
                                        (op.currentFocus.theSifEditor).
                                        changeFocus
                                 else
                                    op.currentFocus.theDiagram
                                      ->theListDiagram[];
                                    op.currentFocus[]->theNonTerminalNode[];
                                    (theNonTerminalNode.unExp,1)
                                      ->
                                        (op.currentFocus.theSifEditor).
                                        changeFocus
                                if);
                                (if op.canListInsert then
                                    (if not optionalInserted then
                                        (op.currentFocus.theSifEditor).after
                                    if);
                                    betaGram.PatternDecl
                                      ->
                                        (op.currentFocus.theSifEditor).
                                        expandNormal;
                                    (op.currentFocus.theSifEditor).
                                    removeOptionals;
                                    op.currentFocus.detail;
                                    FrejaEditMenu.iEditName.hit;
                                    (if optionalInserted then
                                        (if keepAST[] <> none then
                                            (if keepAST[] <> none then
                                                (keepAST[],1)
                                                  ->
                                                    (
                                                    op.currentFocus.theSifEditor
                                                    ).changeFocus
                                            if);
                                            (op.currentFocus.theSifEditor).
                                            removeOptionals
                                        if)
                                    if)
                                if)
                             else
                                theListDiagram.theParentNode->theParentNode[];
                                (if theParentNode[] <> none then
                                    theParentNode.theDiagram->theListDiagram[];
                                    restart getTopMostDiagram
                                if)
                            if)
                         #)
                    else
                       'NewPatternHit: theDiagram is NONE'->putline
                   if)
                else
                   'No current object'->alertUser
               if)
           if)
        else
           'New Pattern not possible on this type of page'->alertUser
       if)
    else
       'No current page'->alertUser
   if)
#)  

-- AttributeKindMenuPartObject: DoPart --
do
   betaGram.SimpleDecl->(op.currentFocus.theSifEditor).expandNormal;
   betaGram.StaticItem->(op.currentFocus.theSifEditor).expandNormal  

-- AttributeKindMenuDynamicReference: DoPart --
do
   betaGram.SimpleDecl->(op.currentFocus.theSifEditor).expandNormal;
   betaGram.DynamicItem->(op.currentFocus.theSifEditor).expandNormal  

-- AttributeKindMenuLocalPattern: DoPart --
do
   betaGram.PatternDecl->(op.currentFocus.theSifEditor).expandNormal;
   (op.currentFocus.theSifEditor).removeOptionals  

-- AttributeKindMenuVirtualPattern: DoPart --
do betaGram.VirtualDecl->(op.currentFocus.theSifEditor).expandNormal  

-- AttributeKindMenuBindingOfVirtualPattern: DoPart --
do betaGram.BindingDecl->(op.currentFocus.theSifEditor).expandNormal  

-- AttributeKindMenuFinalBindOfVirtPattern: DoPart --
do betaGram.FinalDecl->(op.currentFocus.theSifEditor).expandNormal  

-- GeneralRelationshipItem: DoPart --
do
     (#
        p: ^Page;
        op: ^OADPage;
        theConnector: ^op.GeneralRelationshipConnector
     do
        currentpage->p[];
        (if p[] <> none then
            (if p## <= OADPage## then
                p[]->op[];
                &op.GeneralRelationshipConnector[]->theConnector[];
                theConnector.InteractiveNew
             else
                'Creating general relationship is not possible on this type of page'
                  ->alertUser
            if)
         else
            'No current page'->alertUser
        if)
     #)  

-- RelationsMenuAggregationItem: DoPart --
do
     (# theDialog: ^AggregationDialog
     do
        &AggregationDialog[]->theDialog[];
        (none ,none ,0,0,0,0,0,0,none )->theDialog.open
     #)  

-- RelationsMenuAssociationItem: DoPart --
do
     (# theDialog: ^AssociationDialog
     do
        &AssociationDialog[]->theDialog[];
        (none ,none ,none ,none ,0,0,0,0,0,false,none )->theDialog.open
     #)  

-- RelationsMenuSpecialization: Descriptor --
(# p: ^Page; op: ^OADPage; theConnector: ^op.PrefixConnector
do
   currentpage->p[];
   (if p[] <> none then
       (if p## <= OADPage## then
           p[]->op[];
           &op.PrefixConnector[]->theConnector[];
           'Drag connector from subclass to superclass'
             ->theConnector.InteractiveNew
        else
           'Specialization not possible on this type of page'->alertUser
       if)
    else
       'No current page'->alertUser
   if)
#)  

-- RelationsMenuBind: Descriptor --
(# p: ^Page; op: ^OADPage; theConnector: ^op.BindingConnector
do
   currentpage->p[];
   (if p[] <> none then
       (if p## <= OADPage## then
           p[]->op[];
           &op.BindingConnector[]->theConnector[];
           theConnector.InteractiveNew
        else
           'Binding of Virtual not possible on this type of page'->alertUser
       if)
    else
       'No current page'->alertUser
   if)
#)  

-- RelationsMenuFinal: Descriptor --
(# p: ^Page; op: ^OADPage; theConnector: ^op.FinalBindingConnector
do
   currentpage->p[];
   (if p[] <> none then
       (if p## <= OADPage## then
           p[]->op[];
           &op.FinalBindingConnector[]->theConnector[];
           theConnector.InteractiveNew
        else
           'Final Binding of Virtual not possible on this type of page'
             ->alertUser
       if)
    else
       'No current page'->alertUser
   if)
#)  

-- RelationsMenuPattern: Descriptor --
(# p: ^Page; op: ^OADPage; theConnector: ^op.PatternVariableConnector
do
   currentpage->p[];
   (if p[] <> none then
       (if p## <= OADPage## then
           p[]->op[];
           &op.PatternVariableConnector[]->theConnector[];
           theConnector.InteractiveNew
        else
           'Pattern Variable not possible on this type of page'->alertUser
       if)
    else
       'No current page'->alertUser
   if)
#)  

-- RealtionsMenuSelfAssociateHit: DoPart --
do
     (#
        p: ^Page;
        op: ^OADPage;
        theObject: ^op.DesignObject;
        thePatternDiagramNode: ^op.PatternDiagramNode;
        theListDiagram: ^op.ListDiagram;
        theOADDiagram: ^op.OADDiagram;
        theDesc: ^betaGram.ObjectDescriptor;
        anAST,testAST: ^mps.ast
     do
        currentpage->p[];
        (if p[] <> none then
            (if p## <= OADPage## then
                p[]->op[];
                op.currentObject->theObject[];
                (if theObject[] <> none then
                    (if theObject## <= op.PatternDiagramNode## then
                        theObject[]->thePatternDiagramNode[];
                        thePatternDiagramNode.theDiagram->theListDiagram[];
                        (if theListDiagram## <= op.FragmentDiagram## then
                            'Current diagram is a fragment diagram'->AlertUser
                         else
                            (if theListDiagram## <= op.PatternAttDiagram## then
                                'Current diagram is an attributes form diagram'
                                  ->AlertUser
                             else
                                theListDiagram[]->theOADDiagram[];
                                theOADDiagram.theDescriptor->theDesc[];
                                theDesc.father->anAST[];
                                anAST.father->testAST[];
                                (if testAST[] <> none then
                                    (if anAST.symbol <> betaGram.StaticItem then
                                        (if thePatternDiagramNode## <=
                                        theListDiagram.titleNode## then
                                            &selfAssociateWindow[]->theWindow[];
                                            theWindow.popup
                                         else
                                            'Please select the title of the diagram\nto perform this operation'
                                              ->alertUser
                                        if)
                                     else
                                        'Current diagram is singularly defined'
                                          ->AlertUser
                                    if)
                                 else
                                    'Current diagram is a descriptor form diagram'
                                      ->AlertUser
                                if)
                            if)
                        if)
                     else
                        'Current selection must be the title of a diagram'
                          ->alertUser
                    if)
                 else
                    'No selection'->alertUser
                if)
             else
                'Associate to Self not possible on this type of page'->alertUser
            if)
         else
            'No current page'->alertUser
        if);
        
     #)  

-- RelationsMenuInit: Descriptor --
(# i: @integer
do
   (UserMenu6+(i+1->i),'General Relationship')->GeneralRelationship.init;
   (UserMenu6+(i+1->i),'Aggregation')->Aggregation.init;
   (UserMenu6+(i+1->i),'Association')->Association.init;
   (UserMenu6+(i+1->i),'-')->sep.init;
   (UserMenu6+(i+1->i),'Specialization')->Specialization.Init;
   (UserMenu6+(i+1->i),'-')->sep1.init;
   (UserMenu6+(i+1->i),'Binding of Virtual')->bind.Init;
   (UserMenu6+(i+1->i),'Final Binding of Virtual')->final.Init;
   (UserMenu6+(i+1->i),'-')->sep2.init;
   (UserMenu6+(i+1->i),'Pattern Variable')->pattern.Init;
   sep.disable;
   sep1.disable;
   sep2.disable
#)  

-- frejaSearchItemDesc: DoPart --
do
   (if switch[40] then 'search'->putline if);
   currentPage->thePage[];
   (if thePage[] <> none then
       (if thePage## <= OADPage## then
           thePage[]->theOADPage[];
           theOADPage.CurrentObject->theDesObj[];
           (if theDesObj[] <> none then
               (if theDesObj## <= theOADPage.PatternDiagramNode## then
                   theDesObj[]->theObject[];
                   (if theObject.theSifEditor <> none then
                       (theObject.theSifEditor).search
                    else
                       'Please select title or attribute in a fragmentform'
                         ->alertUser
                   if)
                else
                   'Current focus is not a pattern diagram node!'->putline
               if)
           if)
        else
           'Search not implemented on this type of page'->alertUser
       if)
    else
       'No current page'->alertUser
   if);
     

-- FrejaLayputPreferencesDesc: DoPart --
do layoutPreferencesDialog.popup  

-- FrejaViewMenuInit: Descriptor --
(#  do (* (UserMenu4+24,'Dump SifEditorList')->DumpSifEditorList.init*)  #)  

