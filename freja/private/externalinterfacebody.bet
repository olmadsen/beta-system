ORIGIN '../frejalib';
INCLUDE 'frejabody';
LIB_ITEM 'frejalib';
-- globalSifCommandsOpenForm: DoPart --
do
   doOpen:
     (#
        se: ^codeEditor;
        theOADDoc:
          ^theModel.theGraphicalInterface.theDesignInterface.OADDocument
     do
        (if theModel.theGraphicalInterface.switch[40] then
            '###### Freja-globalSifCommand: openForm: ##### '->puttext;
            name[]->putline
        if);
        (name[],node[])->ymerBrowserInt.sifExternalInterface.openForm->se[];
        (if se[] = none then
            'Editor could not be opened'
              ->theModel.theGraphicalInterface.alertUser;
            leave doOpen
        if);
        (* 'openForm: frejaMark is '->puttext;
         se.frag.father->getFrejaMark->putint;
         newline;*)
        theModel.theGraphicalInterface.theDesignInterface.theDocument[]
          ->theOADDoc[];
        searchFrag:
        theOADDoc.theGroupPage.patternDiagrams.theList.scanFragmentDiagrams
          (# 
          do
             thisDiagram.localNodes.scan
               (#
                  fn: ^thisDiagram.fragmentNode;
                  aSifEditor: ^theModel.theGraphicalInterface.sifEditor
               do
                  (if current## <= thisDiagram.fragmentNode## then
                      current[]->fn[];
                      (if fn.theFragment = se.frag[] then
                          (if fn.theSifEditor = none then
                              40
                                ->theModel.theGraphicalInterface.trace
                                  (# 
                                  do
                                     'openForm: attaching sifEditor to fragmentNode'
                                       ->t
                                  #);
                              &theModel.theGraphicalInterface.sifEditor[]
                                ->aSifEditor[]->fn.theSifEditor;
                              se[]->aSifEditor.init;
                              true->se.isAFrejaEditor
                                ->se.thisGroupEditor.isAFrejaEditor
                           else
                              40
                                ->theModel.theGraphicalInterface.trace
                                  (# 
                                  do
                                     'openForm: sifEditor already attached to fragmentNode'
                                       ->t
                                  #)
                          if);
                          leave searchFrag
                      if)
                  if)
               #)
          #);
        (if theModel.theGraphicalInterface.switch[40] then
            '###### Freja-globalSifCommand: openForm END#####'->putline
        if)
     #)  

-- globalSifCommandsGetEditorForForm: DoPart --
do
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-globalSifCommand: getEditorForForm: #####'->puttext;
       ff.fullname->putline
   if);
   (ff[],node[])->ymerBrowserInt.sifExternalInterface.getEditorForForm->se[];
   (if se[] = none then
       'Could not get editor'->theModel.theGraphicalInterface.alertUser
   if);
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-globalSifCommand: getEditorForForm END#####'->putline
   if)  

-- globalSifCommandsNewBETAProgram: DoPart --
do
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-globalSifCommand: newBETAProgram: #####'->puttext;
       name[]->putline
   if);
   (if not (name[]->ymerBrowserInt.sifExternalInterface.newBETAProgram) then
       'Freja: NewBetaProgram failed'->screen.putLine
   if);
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-globalSifCommand: newBETAProgram END#####'->putline
   if)  

-- globalSifCommandsNewBETALibrary: DoPart --
do
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-globalSifCommand: newBETALibrary: #####'->puttext;
       name[]->putline
   if);
   (if not (name[]->ymerBrowserInt.sifExternalInterface.newBETALibrary) then
       'Freja: NewBetaProgram failed'->screen.putLine
   if);
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-globalSifCommand: newBETALibrary END#####'->putline
   if);
     

-- globalSifCommandsSaveAndQuit: DoPart --
do
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-globalSifCommand: saveAndQuit#####'->putline
   if);
   ymerBrowserInt.sifExternalInterface.saveAndQuit;
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-globalSifCommand: saveAndQuit END#####'->putline
   if)  

-- globalSifCommandsSave: DoPart --
do
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-globalSifCommand: save#####'->putline
   if);
   theModel.theGraphicalInterface.theDesignInterface.theDocument[]
     ->theModel.theGraphicalInterface.theDesignInterface.theOADDocument[];
   ymerBrowserInt.sifExternalInterface.save;
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-globalSifCommand: save END#####'->putline
   if)  

-- globalSifCommandsAutoSave: DoPart --
do
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-globalSifCommand: autosave#####'->putline
   if);
   ymerBrowserInt.sifExternalInterface.autoSave;
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-globalSifCommand: autosave END#####'->putline
   if)  

-- globalSifCommandsCheckAutoSaveFile: DoPart --
do
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-globalSifCommand: checkAutoSaveFile#####'->putline
   if);
   fg[]->ymerBrowserInt.sifExternalInterface.checkAutoSaveFile->didRecover;
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-globalSifCommand: checkAutoSaveFile END#####'->putline
   if)  

-- globalSifCommandsCheck: DoPart --
do
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-globalSifCommand: check #####'->putline
   if);
   fg[]->ymerBrowserInt.sifExternalInterface.simplecheck;
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-globalSifCommand: check END #####'->putline
   if)  

-- globalSifCommandsToggleDedug: DoPart --
do
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-globalSifCommand: toggleDebug#####'->putline
   if);
   ymerBrowserInt.sifExternalInterface.toggleDebug;
     

-- globalSifCommandsAddProp: DoPart --
do
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-globalSifCommand: addProp: #####\n %s\n%s %s\n'
         ->putformat (#  do fg.name->s; propName[]->s; propString[]->s #)
   if);
   (fg[],propName[],propString[],false)
     ->ymerBrowserInt.sifExternalInterface.addProp;
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-globalSifCommand: addProp END#####'->putline
   if)  

-- globalSifCommandsDeleteProp: DoPart --
do
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-globalSifCommand: addProp: #####\n %s\n%s %s\n'
         ->putformat (#  do fg.name->s; propName[]->s; propString[]->s #)
   if);
   (fg[],propName[],propString[])
     ->ymerBrowserInt.sifExternalInterface.deleteProp;
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-globalSifCommand: addProp END#####'->putline
   if)  

-- globalSifCommandsSetFrejaMark: DoPart --
do
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-globalSifCommand: setFrejaMark: #####\n %s %i\n'
         ->putformat
           (# 
           do
              fg.name->s;
              theModel.theGraphicalInterface.theDesignInterface.UniqueDiagramID
                ->i
           #)
   if);
   (if false then
       (frejamark,fg[])->ymerBrowserInt.sifExternalInterface.setFrejaMark
    else
       'frejamark'
         ->FG.prop.addprop
           (# ifPropExist::  (#  do true->delete #)
           do
              theModel.theGraphicalInterface.theDesignInterface.UniqueDiagramID
                ->addConst
           #)
   if);
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-globalSifCommand: setFrejaMark END#####'->putline
   if)  

-- globalSifCommandsGetFrejaMark: DoPart --
do
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-globalSifCommand: getFrejaMark: #####\n %s\n'
         ->putformat (#  do fg.name->s #)
   if);
   (if false then
       fg[]->ymerBrowserInt.sifExternalInterface.getFrejaMark->bool2int
         ->frejamark
    else
         (#
            GetProp:
              (#
                 fg: ^theModel.theGraphicalInterface.mps.fragmentGroup;
                 P: @Text;
                 res: @integer;
                 Txt: ^Text;
                 
              enter (P,fg[])
              do
                 &Text[]->Txt[];
                 L: FG.prop.scanProp
                   (#
                      doProp::< 
                        (# 
                        do
                           (if (P[]->Prop.equal) then
                               scanParameters
                                 (#
                                    doConst::<  (#  do C->res; leave L #);
                                    doString::< 
                                      (#  do S[]->Txt[]; leave L #)
                                 #);
                               
                           if);
                           
                        #);
                      
                   #);
                 INNER (* ugly *)
              exit res
              #)
         do ('frejamark',FG[])->getProp->frejamark
         #)
   if);
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-globalSifCommand: getFrejaMark END: %i #####\n'
         ->putformat (#  do frejamark->i #)
   if)  

-- theExternalInterfaceNewFragment: DoPart --
do
     (#
        thePage:
          ^theModel.theGraphicalInterface.theDesignInterface.theDocument.Page;
        t: ^text
     do
        (if theModel.theGraphicalInterface.switch[40] then
            '###### Freja-externalInterface: newFragment: #####'->puttext;
            ff.fullname->putline
        if);
        ff.fullname->t[];
        (t,false)
          ->theModel.theGraphicalInterface.theDesignInterface.openFragmentForm;
        (if theModel.theGraphicalInterface.theDesignInterface.theDocument[] =
        none then
            'Freja ------ NO DOCUMENT after newFragment'->screen.putline; 
         else
            theModel.theGraphicalInterface.theDesignInterface.theDocument[]
              ->theDoc[];
            theDoc.CurrentPage->thePage[];
            (if thePage## <= theDoc.OADPage## then
                thePage[]->theOADPage[]
             else
                (if theDoc.theWorkPage[] <> none then
                    theDoc.theWorkPage[]->theOADPage[]
                 else
                    (if theDoc.theGroupPage[] <> none then
                        theDoc.theGroupPage[]->theOADPage[]
                    if)
                if)
            if);
            (if theOADPage[] <> none then
                (if node[] <> none then
                    (node[],1)->theOADPage.onFocusChange; 
                if)
            if);
            INNER NewFragment
        if);
        (if theModel.theGraphicalInterface.switch[40] then
            '###### Freja-externalInterface: newFragment END#####'->putline
        if)
     #)  

-- theExternalInterfaceAstReplaced: DoPart --
do
     (#
        theOADDocument:
          ^theModel.theGraphicalInterface.theDesignInterface.OADDocument;
        theOADPage: ^theOADDocument.OADPage;
        thePage: ^theOADDocument.Page
     do
        (if theModel.theGraphicalInterface.switch[40] then
            '###### Freja-externalInterface: astReplaced: ##### '->puttext;
            oldAst.index->putint;
            '  '->puttext;
            newAst.index->putint;
            newline
        if);
        (if oldAst[]->visibleInFreja then
            theModel.theGraphicalInterface.theDesignInterface.theDocument[]
              ->theOADDocument[];
            theOADDocument.currentPage->thePage[];
            (if thePage## <= theOADDocument.OADPage## then
                thePage[]->theOADPage[]
             else
                (if theOADDocument.theWorkPage[] <> none then
                    theOADDocument.theWorkPage[]->theOADPage[]
                 else
                    (if theOADDocument.theGroupPage[] <> none then
                        theOADDocument.theGroupPage[]->theOADPage[]
                    if)
                if)
            if);
            (if theOADPage[] <> none then
                (oldAst[],newAst[])->theOADPage.astReplaced;
                INNER onAstReplaced
            if)
        if);
        (if theModel.theGraphicalInterface.switch[40] then
            '###### Freja-externalInterface: astReplaced END#####'->putline
        if)
     #)  

-- theExternalInterfaceAstReplacedSequence: DoPart --
do
     (#
        theOADDocument:
          ^theModel.theGraphicalInterface.theDesignInterface.OADDocument;
        theOADPage: ^theOADDocument.OADPage;
        thePage: ^theOADDocument.Page
     do
        (if theModel.theGraphicalInterface.switch[40] then
            '###### Freja-externalInterface: astReplacedSequence: ##### '
              ->puttext
        if);
        theModel.theGraphicalInterface.theDesignInterface.theDocument[]
          ->theOADDocument[];
        theOADDocument.currentPage->thePage[];
        (if thePage## <= theOADDocument.OADPage## then
            thePage[]->theOADPage[]
         else
            (if theOADDocument.theWorkPage[] <> none then
                theOADDocument.theWorkPage[]->theOADPage[]
             else
                (if theOADDocument.theGroupPage[] <> none then
                    theOADDocument.theGroupPage[]->theOADPage[]
                if)
            if)
        if);
        (if theOADPage[] <> none then
            (if theSequence.size > 0 then
                theSequence.scan
                  (# 
                  do
                     (if current.oldAst[]->visibleInFreja then
                         (current.oldAst[],current.newAst[])
                           ->theOADPage.astReplaced
                     if)
                  #);
                INNER onAstReplacedSequence
             else
                (if theModel.theGraphicalInterface.switch[40] then
                    'no events in astReplacedList'->screen.putLine
                if)
            if)
        if);
        (if theModel.theGraphicalInterface.switch[40] then
            '###### Freja-externalInterface: astReplaced END#####'->putline
        if)
     #)  

-- theExternalInterfaceListElementInserted: DoPart --
do
     (#
        theOADDocument:
          ^theModel.theGraphicalInterface.theDesignInterface.OADDocument;
        theOADPage: ^theOADDocument.OADPage;
        thePage: ^theOADDocument.Page
     do
        (if theModel.theGraphicalInterface.switch[40] then
            '###### Freja-externalInterface: listElementInserted: ##### '
              ->puttext;
            node.index->putint;
            '  '->puttext;
            position->putint;
            newline
        if);
        (if position->node.get->visibleInFreja then
            theModel.theGraphicalInterface.theDesignInterface.theDocument[]
              ->theOADDocument[];
            theOADDocument.currentPage->thePage[];
            (if thePage## <= theOADDocument.OADPage## then
                thePage[]->theOADPage[]
             else
                (if theOADDocument.theWorkPage[] <> none then
                    theOADDocument.theWorkPage[]->theOADPage[]
                 else
                    (if theOADDocument.theGroupPage[] <> none then
                        theOADDocument.theGroupPage[]->theOADPage[]
                    if)
                if)
            if);
            (if theOADPage[] <> none then
                (node[],position)->theOADPage.listElementInserted;
                INNER onListElementInserted
            if)
        if);
        (if theModel.theGraphicalInterface.switch[40] then
            '###### Freja-externalInterface: listElementInserted END#####'
              ->putline
        if)
     #)  

-- theExternalInterfaceListElementsDeleted: DoPart --
do
     (#
        theOADDocument:
          ^theModel.theGraphicalInterface.theDesignInterface.OADDocument;
        theOADPage: ^theOADDocument.OADPage;
        thePage: ^theOADDocument.Page
     do
        (if theModel.theGraphicalInterface.switch[40] then
            '###### Freja-externalInterface: listElementsDeleted: ##### '
              ->puttext;
            node.index->putint;
            '  '->puttext;
            position->putint;
            '  '->puttext;
            length->putint;
            '  '->puttext;
            (for i: length repeat
              oldElements.elm[i].index->putint; ' '->puttext
            for);
            newline
        if);
        (if oldElements.elm[length][]->visibleInFreja then
            theModel.theGraphicalInterface.theDesignInterface.theDocument[]
              ->theOADDocument[];
            theOADDocument.currentPage->thePage[];
            (if thePage## <= theOADDocument.OADPage## then
                thePage[]->theOADPage[]
             else
                (if theOADDocument.theWorkPage[] <> none then
                    theOADDocument.theWorkPage[]->theOADPage[]
                 else
                    (if theOADDocument.theGroupPage[] <> none then
                        theOADDocument.theGroupPage[]->theOADPage[]
                    if)
                if)
            if);
            (if theOADPage[] <> none then
                (node[],position,length,oldElements[])
                  ->theOADPage.listElementsDeleted;
                INNER onListElementsDeleted
            if)
        if);
        (if theModel.theGraphicalInterface.switch[40] then
            '###### Freja-externalInterface: listElementsDeleted END#####'
              ->putline
        if)
     #)  

-- theExternalInterfaceListElementsReplaced: DoPart --
do
     (#
        theOADDocument:
          ^theModel.theGraphicalInterface.theDesignInterface.OADDocument;
        theOADPage: ^theOADDocument.OADPage;
        thePage: ^theOADDocument.Page
     do
        (if theModel.theGraphicalInterface.switch[40] then
            '###### Freja-externalInterface: listElementsReplaced: ##### '
              ->puttext;
            node.index->putint;
            '  '->puttext;
            position->putint;
            '  '->puttext;
            length->putint;
            '  '->puttext;
            newLength->putint;
            '  '->puttext;
            (for i: length repeat
              oldElements.elm[i].index->putint; ' '->puttext
            for);
            newline
        if);
        (if (length = 0) and (newLength = 1) then
            'converting listElementsReplacedEvent to listElemenInsertedEvent'
              ->screen.putline;
            (if position->node.get->visibleInFreja then
                theModel.theGraphicalInterface.theDesignInterface.theDocument[]
                  ->theOADDocument[];
                theOADDocument.currentPage->thePage[];
                (if thePage## <= theOADDocument.OADPage## then
                    thePage[]->theOADPage[]
                 else
                    (if theOADDocument.theWorkPage[] <> none then
                        theOADDocument.theWorkPage[]->theOADPage[]
                     else
                        (if theOADDocument.theGroupPage[] <> none then
                            theOADDocument.theGroupPage[]->theOADPage[]
                        if)
                    if)
                if);
                (if theOADPage[] <> none then
                    (node[],position)->theOADPage.listElementInserted
                if)
            if)
         else
            (if oldElements.elm[length][]->visibleInFreja then
                theModel.theGraphicalInterface.theDesignInterface.theDocument[]
                  ->theOADDocument[];
                theOADDocument.currentPage->thePage[];
                (if thePage## <= theOADDocument.OADPage## then
                    thePage[]->theOADPage[]
                 else
                    (if theOADDocument.theWorkPage[] <> none then
                        theOADDocument.theWorkPage[]->theOADPage[]
                     else
                        (if theOADDocument.theGroupPage[] <> none then
                            theOADDocument.theGroupPage[]->theOADPage[]
                        if)
                    if)
                if);
                (if theOADPage[] <> none then
                    (node[],position,length,oldElements[],newLength)
                      ->theOADPage.listElementsReplaced;
                    INNER onListElementsReplaced
                if)
            if)
        if);
        (if theModel.theGraphicalInterface.switch[40] then
            '###### Freja-externalInterface: listElementsDeleted END#####'
              ->putline
        if)
     #)  

-- theExternalInterfaceFocusChanged: DoPart --
do
     (#
        theOADDocument:
          ^theModel.theGraphicalInterface.theDesignInterface.OADDocument;
        theOADPage: ^theOADDocument.OADPage;
        thePage: ^theOADDocument.Page;
        status: @boolean
     do
        (if theModel.theGraphicalInterface.switch[40] then
            '###### Freja-externalInterface: focusChanged: ##### '->puttext;
            newCS.node.index->putint;
            '  '->puttext;
            newCS.length->putint;
            newline
        if);
        theModel.theGraphicalInterface.theDesignInterface.theDocument[]
          ->theOADDocument[];
        (if theOADDocument[] <> none then
            (if not theOADDocument.gppProp.ignoreFocusChanged then
                theOADDocument.currentPage->thePage[];
                (if thePage## <= theOADDocument.OADPage## then
                    thePage[]->theOADPage[]
                 else
                    (if theOADDocument.theWorkPage[] <> none then
                        theOADDocument.theWorkPage[]->theOADPage[]
                     else
                        (if theOADDocument.theGroupPage[] <> none then
                            theOADDocument.theGroupPage[]->theOADPage[]
                        if)
                    if)
                if);
                (if theOADPage[] <> none then
                    (newCS.node[],newCS.length)->theOADPage.onFocusChange
                      ->status;
                    (if status then
                        theOADPage.CurrentObject->theOADPage.GetStatus
                    if);
                    INNER onFocusChanged
                if)
             else
                40
                  ->theModel.theGraphicalInterface.trace
                    (#  do 'focusChanged ignored!'->t #)
            if)
         else
            (if theModel.theGraphicalInterface.switch[40] then
                'theDocument was none'->putline
            if)
        if);
        (if theModel.theGraphicalInterface.switch[40] then
            '###### Freja-externalInterface: focusChange END#####'->putline
        if)
     #)  

-- theExternalInterfaceNewDiagram: DoPart --
do
   theModel.theGraphicalInterface.theDesignInterface.theFileMenu.NewBETALibrary.
     hit  

-- theExternalInterfaceShowDiagram: DoPart --
do FrejaShowClassDiag  

-- theExternalInterfaceOpenForm: DoPart --
do
     (#
        thePage:
          ^theModel.theGraphicalInterface.theDesignInterface.theDocument.Page;
        t: ^text
     do
        (if theModel.theGraphicalInterface.switch[40] then
            '###### Freja-externalInterface: openForm: #####'->putline;
            'ff: %s node: %i\n'
              ->putformat (#  do ff.fullname->s; node.index->i #)
        if);
        (if theModel.theGraphicalInterface.theDesignInterface.theDocument[] <>
        none then
            theModel.theGraphicalInterface.theDesignInterface.theDocument[]
              ->theDoc[];
            (if theDoc.theGroupPage[] <> none then
                theDoc.theGroupPage.patternDiagrams.theList.scanFragmentDiagrams
                  (# 
                  do
                     (if thisDiagram.theGroup = ff.father then
                         true->alreadyOpenInFreja
                     if)
                  #)
            if)
        if);
        (if not alreadyOpenInFreja then
            ((ff.father).name).copy
              ->theModel.theGraphicalInterface.theDesignInterface.openFile;
            theModel.theGraphicalInterface.theDesignInterface.theDocument[]
              ->theDoc[];
            (if theDoc[] <> none then
                (if theDoc.theWorkPage[] <> none then
                    (if not theDoc.theWorkPage.visible then
                        true->theDoc.theWorkPage.visible
                    if);
                    (node[],1)->theDoc.theWorkPage.onFocusChange
                if)
            if)
         else
            (if not theDoc.theWorkPage.visible then
                true->theDoc.theWorkPage.visible
            if);
            (node[],1)->theDoc.theWorkPage.onFocusChange
        if);
        (if theModel.theGraphicalInterface.switch[40] then
            '###### Freja-externalInterface: openForm END#####'->putline
        if)
     #)  

-- theExternalInterfaceGroupChecked: DoPart --
do
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-externalInterface: groupChecked #####'->putline
   if);
   theModel.theGraphicalInterface.theDesignInterface.theDocument[]->theOADDoc[];
   (if theOADDoc[] <> none then
       (if not semanticErrors then
           (if theOADDoc.theWorkPage[] <> none then
               theOADDoc.theWorkPage.patterndiagrams.redisplayRelations
           if)
       if);
       INNER groupChecked;
       theModel.theGraphicalInterface.theDesignInterface.saveFiles
   if);
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-externalInterface: groupChecked END#####'->putline
   if)  

-- theExternalInterfaceGroupNotSaved: DoPart --
do
     (#
        currentDiagramName: ^text;
        msg: @text;
        ok: @integer;
        diagFile,f: @file
     do
        (if theModel.theGraphicalInterface.switch[40] then
            '###### Freja-externalInterface: groupNotSaved #####'->putline
        if);
        theModel.theGraphicalInterface.theDesignInterface.currentDiagramName[]
          ->currentDiagramName[];
        (if currentDiagramName[] <> none then
            currentDiagramName
              ->theModel.theGraphicalInterface.prependCurrentPath
              ->diagFile.name;
            '#'->((diagFile.name).copy).append->f.name;
            (if f.entry.exists then f.delete if)
        if);
        (if theModel.theGraphicalInterface.switch[40] then
            '###### Freja-externalInterface: groupNotSaved END#####'->putline
        if)
     #)  

-- theExternalInterfaceCloseUntouchedGroup: DoPart --
do
     (#
        currentDiagramName: ^text;
        msg: @text;
        ok: @integer;
        diagFile,f: @file
     do
        (if theModel.theGraphicalInterface.switch[40] then
            '###### Freja-externalInterface: groupNotSaved #####'->putline
        if);
        theModel.theGraphicalInterface.theDesignInterface.currentDiagramName[]
          ->currentDiagramName[];
        (if currentDiagramName[] <> none then
            'Save diagram: %s?'
              ->msg.putformat (#  do currentDiagramName[]->s #);
            ('Save?',msg[])->theModel.theGraphicalInterface.promptForYesNo->ok;
            (if ok
             // theModel.theGraphicalInterface.yes then
                theModel.theGraphicalInterface.theDesignInterface.saveFiles;
                theModel.theGraphicalInterface.doIgnoreGroupSaved
                  (#  do theModel.theGraphicalInterface.sifSave #)
             // theModel.theGraphicalInterface.no then
                currentDiagramName
                  ->theModel.theGraphicalInterface.prependCurrentPath
                  ->diagFile.name;
                '#'->((diagFile.name).copy).append->f.name;
                (if f.entry.exists then f.delete if)
            if)
        if);
        (if theModel.theGraphicalInterface.switch[40] then
            '###### Freja-externalInterface: groupNotSaved END#####'->putline
        if)
     #)  

-- theExternalInterfaceGroupSaved: DoPart --
do
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-externalInterface: groupSaved #####'->putline
   if);
   (if not ignoreGroupSaved then
       theModel.theGraphicalInterface.theDesignInterface.theDocument[]
         ->theOADDoc[];
       (if theOADDoc[] <> none then
           INNER groupSaved;
           theModel.theGraphicalInterface.theDesignInterface.saveFiles
       if)
   if);
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-externalInterface: groupSaved END#####'->putline
   if)  

-- theExternalInterfaceGroupAutoSaved: DoPart --
do
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-externalInterface: groupAutosaved #####'->putline
   if);
   theModel.theGraphicalInterface.theDesignInterface.theDocument[]->theOADDoc[];
   (if theOADDoc[] <> none then
       INNER groupAutosaved;
       true->theModel.theGraphicalInterface.theDesignInterface.autosave
   if);
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-externalInterface: groupAutosaved END#####'->putline
   if)  

-- theExternalInterfacePropertiesChanged: DoPart --
do
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-externalInterface: propertiesChanged: %s #####\n'
         ->putformat (#  do fg.name->s #)
   if);
   theModel.theGraphicalInterface.theDesignInterface.theDocument[]->theDoc[];
   (if theDoc.theGroupPage[] <> none then
       fg[]->theDoc.theGroupPage.propertiesChanged; INNER propertiesChanged
    else
       'PropertiesChanged: theGroupPage is none!'->putline
   if);
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-externalInterface: propertiesChanged END #####'->putline
   if)  

-- theExternalInterfaceFragmentChanged: DoPart --
do
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-externalInterface: fragmentChanged #####'->putline
   if);
   theModel.theGraphicalInterface.theDesignInterface.theDocument[]->theDoc[];
   (if theDoc.theGroupPage[] <> none then
       ff[]->theDoc.theGroupPage.fragmentChanged; INNER fragmentChanged
    else
       'FragmentChanged: theGroupPage is none!'->putline
   if);
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-externalInterface: fragmentChanged END #####'->putline
   if)  

-- theExternalInterfaceFragmentInserted: DoPart --
do
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-externalInterface: fragmentInserted #####'->putline
   if);
   theModel.theGraphicalInterface.theDesignInterface.theDocument[]->theDoc[];
   (if theDoc.theGroupPage[] <> none then
       ff[]->theDoc.theGroupPage.fragmentInserted; INNER fragmentInserted
    else
       'FragmentInserted: theGroupPage is none!'->putline
   if);
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-externalInterface: fragmentInserted END #####'->putline
   if)  

-- theExternalInterfaceFragmentDeleted: DoPart --
do
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-externalInterface: fragmentDeleted #####'->putline
   if);
   theModel.theGraphicalInterface.theDesignInterface.theDocument[]->theDoc[];
   (if theDoc.theGroupPage[] <> none then
       ff[]->theDoc.theGroupPage.fragmentDeleted; INNER fragmentDeleted
    else
       'FragmentDeleted: theGroupPage is none!'->putline
   if);
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-externalInterface: fragmentDeleted END #####'->putline
   if)  

-- theExternalInterfaceAskBeforeTextEditing: DoPart --
do
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-externalInterface: askBeforeTextEditing #####'->putline
   if);
   (if node[]->visibleInFreja then true->value if);
   INNER askBeforeTextEditing;
   (if theModel.theGraphicalInterface.switch[40] then
       '###### Freja-externalInterface: askBeforeTextEditing END #####'->putline
   if)  

-- SifEditorVisibleInFreja: Descriptor --
(#
   nontNode: ^astInterface.unExpanded;
   synCatNo: @integer;
   gi: ^gppinterface;
   
do
   theModel.theGraphicalInterface[]->gi[];
   true->value;
   loop:
     (# 
     do
        (if
        ((node.kind = gi.mps.kinds.unexpanded) or
         (node.kind = gi.mps.kinds.optional)) then
            node[]->nontNode[]; nontNode.nonterminalSymbol->synCatNo
         else
            node.symbol->synCatNo
        if);
        (if synCatNo
         // gi.gram.imperatives // gi.gram.enterPart // gi.gram.enterPartOpt
         // gi.gram.exitPart // gi.gram.exitPartOpt // gi.gram.doPart
         // gi.gram.doPartOpt then
            false->value; 
         else
            (if node.father = none then
            (* imperatives, enterpart or exitpart was not found *)
                
             else
                node.father->node[]; restart loop
            if)
        if)
     #)
#)  

-- SifEditorUndo: DoPart --
do
   (if switch[40] then '###### Freja-sifEditor: undo #####'->putline;  if);
   assertFEexists
     (#
        doesNotExist:: 
          (# 
          do
             'No codeeditor for theSifEditor!'
               ->theModel.theGraphicalInterface.stdErr.putline
          #)
     do fe.externalInterface.undo
     #);
   (if switch[40] then '###### Freja-sifEditor: undo END#####'->putline;  if)  

-- sifEditorRedo: DoPart --
do
   (if switch[40] then '###### Freja-sifEditor: redo #####'->putline;  if);
   assertFEexists
     (#
        doesNotExist:: 
          (# 
          do
             'No codeeditor for theSifEditor!'
               ->theModel.theGraphicalInterface.stdErr.putline
          #)
     do fe.externalInterface.redo
     #);
   (if switch[40] then '###### Freja-sifEditor: redo END#####'->putline;  if)  

-- sifEditorCut: DoPart --
do
   (if switch[40] then '###### Freja-sifEditor: cut #####'->putline;  if);
   assertFEexists
     (#
        doesNotExist:: 
          (# 
          do
             'No codeeditor for theSifEditor!'
               ->theModel.theGraphicalInterface.stdErr.putline
          #)
     do fe.externalInterface.cut
     #);
   (if switch[40] then '###### Freja-sifEditor: cut END#####'->putline;  if)  

-- sifEditorCopy: DoPart --
do
   (if switch[40] then '###### Freja-sifEditor: copy#####'->putline;  if);
   assertFEexists
     (#
        doesNotExist:: 
          (# 
          do
             'No codeeditor for theSifEditor!'
               ->theModel.theGraphicalInterface.stdErr.putline
          #)
     do fe.externalInterface.copy
     #);
   (if switch[40] then '###### Freja-sifEditor: copy END#####'->putline;  if)  

-- sifEditorPaste: DoPart --
do
   (if switch[40] then '###### Freja-sifEditor: paste#####'->putline;  if);
   assertFEexists
     (#
        doesNotExist:: 
          (# 
          do
             'No codeeditor for theSifEditor!'
               ->theModel.theGraphicalInterface.stdErr.putline
          #)
     do fe.externalInterface.paste
     #);
   (if switch[40] then '###### Freja-sifEditor: paste END#####'->putline;  if)  

-- SifEditorClear: DoPart --
do
   (if switch[40] then '###### Freja-sifEditor: clear#####'->putline;  if);
   assertFEexists
     (#
        doesNotExist:: 
          (# 
          do
             'No codeeditor for theSifEditor!'
               ->theModel.theGraphicalInterface.stdErr.putline
          #)
     do fe.externalInterface.clear
     #);
   (if switch[40] then '###### Freja-sifEditor: clear END#####'->putline;  if)  

-- sifEditorBefore: DoPart --
do
   (if switch[40] then '###### Freja-sifEditor: before#####'->putline;  if);
   assertFEexists
     (#
        doesNotExist:: 
          (# 
          do
             'No codeeditor for theSifEditor!'
               ->theModel.theGraphicalInterface.stdErr.putline
          #)
     do fe.externalInterface.before
     #);
   (if switch[40] then
       '###### Freja-sifEditor: before END#####'->putline; 
   if)  

-- sifEditorAfter: DoPart --
do
   (if switch[40] then '###### Freja-sifEditor: after#####'->putline;  if);
   assertFEexists
     (#
        doesNotExist:: 
          (# 
          do
             'No codeeditor for theSifEditor!'
               ->theModel.theGraphicalInterface.stdErr.putline
          #)
     do fe.externalInterface.after
     #);
   (if switch[40] then '###### Freja-sifEditor: after END#####'->putline;  if)  

-- sifEditorChangeFocus: DoPart --
do
   assertFEexists
     (#
        doesNotExist:: 
          (# 
          do
             'No codeeditor for theSifEditor!'
               ->theModel.theGraphicalInterface.stdErr.putline
          #)
     do
          (#
             theDoc:
               ^theModel.theGraphicalInterface.theDesignInterface.OADDocument;
             thePage: ^theDoc.Page;
             theOADPage: ^theDoc.OADPage;
             edittype,expandStatus: ^text
          do
             (if switch[40] then
                 '###### Freja-sifEditor: changeFocus:#####'->puttext;
                 node.index->putint;
                 '  '->puttext;
                 length->putint;
                 newline
             if);
             theModel.theGraphicalInterface.theDesignInterface.theDocument[]
               ->theDoc[];
             theDoc.CurrentPage->thePage[];
             (if thePage## <= theDoc.OADPage## then
                 true->ffObserver.ignoreEvents;
                 thePage[]->theOADPage[];
                 fe[]->ymerBrowserInt.sifExternalInterface.selectEditor;
                 (node[],length)->fe.externalInterface.changeFocus
                   ->
                     (editType[],theOADPage.canUndo,theOADPage.canPaste,
                      theOADPage.canListInsert,expandStatus[]);
                 false->ffObserver.ignoreEvents;
                 (if switch[40] then
                     'changeFocus returned from Sif: '->putline;
                     'editType: '->puttext;
                     editType[]->putline;
                     'expandStatus: '->putline;
                     expandStatus[]->putline
                 if);
                 (if theOADPage.canUndo then
                     theDoc.FrejaEditMenu.iUndo.enable;
                     (if theGraphicalInterface.switch[40] then
                         'EditMenu: Undo enabled'->putline
                     if)
                  else
                     theDoc.FrejaEditMenu.iUndo.disable;
                     (if theGraphicalInterface.switch[40] then
                         'EditMenu: Undo disabled'->putline
                     if)
                 if);
                 (if theOADPage.canPaste then
                     theDoc.FrejaEditMenu.iPaste.enable;
                     (if theGraphicalInterface.switch[40] then
                         'EditMenu: Paste enabled'->putline
                     if)
                  else
                     (if theDoc.doOADPaste then
                         theDoc.FrejaEditMenu.iPaste.disable;
                         (if theGraphicalInterface.switch[40] then
                             'EditMenu: Paste disabled'->putline
                         if)
                     if)
                 if);
                 (if ('expanded'->edittype.equal) or ('lexem'->edittype.equal)
                  then
                     (if theDoc.GppProp.usingExpandMenu then
                         theDoc.theexpandmenu.deletemenu; 
                     if);
                     
                  else
                     (if not ('lexem'->editType.equal) then
                         (if theDoc.GppProp.usingExpandMenu then
                             theDoc.theexpandmenu.deletemenu;
                             expandStatus[]->theDoc.theExpandMenu.CreateItems;
                             
                         if)
                     if);
                     
                 if)
              else
                 ' changeFocus: thePage is not an OADPage'->screen.putline
             if);
             (if switch[40] then
                 '###### Freja-sifEditor: changeFocus END#####'->putline
             if)
          #)
     #)  

-- sifEditorGetStatus: DoPart --
do
   assertFEexists
     (#
        doesNotExist:: 
          (# 
          do
             'No codeeditor for theSifEditor!'
               ->theModel.theGraphicalInterface.stdErr.putline
          #)
     do
          (#
             theDoc:
               ^theModel.theGraphicalInterface.theDesignInterface.OADDocument;
             thePage: ^theDoc.Page;
             theOADPage: ^theDoc.OADPage;
             node: ^mps.ast;
             length: @integer;
             editType,expandStatus: ^text
          do
             (if switch[40] then
                 '###### Freja-sifEditor: getStatus#####'->putline
             if);
             theModel.theGraphicalInterface.theDesignInterface.theDocument[]
               ->theDoc[];
             theDoc.CurrentPage->thePage[];
             (if thePage## = theDoc.OADPage## then
                 thePage[]->theOADPage[];
                 fe.externalInterface.getStatus
                   ->
                     (node[],length,editType[],theOADPage.canUndo,
                      theOADPage.canPaste,theOADPage.canListInsert,
                      expandStatus[]);
                 (if switch[40] then
                     'getStatus returned from Sif: '->putline;
                     'node: '->puttext;
                     node.index->putint;
                     ' length'->puttext;
                     length->putint;
                     newline;
                     'editType: '->puttext;
                     editType[]->putline;
                     'expandStatus: '->putline;
                     expandStatus[]->putline
                 if);
                 (if theOADPage.canUndo then
                     theDoc.FrejaEditMenu.iUndo.enable;
                     (if theGraphicalInterface.switch[40] then
                         'EditMenu: Undo enabled'->putline
                     if)
                  else
                     theDoc.FrejaEditMenu.iUndo.disable;
                     (if theGraphicalInterface.switch[40] then
                         'EditMenu: Undo disabled'->putline
                     if)
                 if);
                 (if theOADPage.canPaste then
                     theDoc.FrejaEditMenu.iPaste.enable;
                     (if theGraphicalInterface.switch[40] then
                         'EditMenu: Paste enabled'->putline
                     if)
                  else
                     (if theDoc.doOADPaste then
                         theDoc.FrejaEditMenu.iPaste.disable;
                         (if theGraphicalInterface.switch[40] then
                             'EditMenu: Paste disabled'->putline
                         if)
                     if)
                 if);
                 (if 'expanded'->edittype.equal then
                     (if theDoc.GppProp.usingExpandMenu then
                         theDoc.theexpandmenu.deletemenu; 
                      else
                         
                     if);
                     
                  else
                     (if not ('lexem'->editType.equal) then
                         (if theDoc.GppProp.usingExpandMenu then
                             theDoc.theexpandmenu.deletemenu;
                             expandStatus[]->theDoc.theExpandMenu.CreateItems;
                             
                         if)
                     if);
                     
                 if)
              else
                 'getStatus: GetStatus: thePage is not an OADPage'
                   ->screen.putline;
                 
             if);
             (if switch[40] then
                 '###### Freja-sifEditor: getStatus END#####'->putline
             if)
          #)
     #)  

-- sifEditorExpandNormal: DoPart --
do
   (if switch[40] then
       '###### Freja-sifEditor: expandNormal ##### '->putline; 
   if);
   assertFEexists
     (#
        doesNotExist:: 
          (# 
          do
             'No codeeditor for theSifEditor!'
               ->theModel.theGraphicalInterface.stdErr.putline
          #)
     do
        synCatNo->fe.externalInterface.expandNormal;
        theDesignInterface.theDocument[]->theOADDocument[];
        theOADDocument.currentPage->theOADPage[];
        (theOADPage.currentFocus[],theOADPage.currentFocus[])
          ->theOADPage.changedFocus
     #);
   (if switch[40] then
       '###### Freja-sifEditor: expnadNormal END ##### '->putline; 
   if)  

-- sifEditorExpandOptional: DoPart --
do
   (if switch[40] then
       '###### Freja-sifEditor: expandOptional ##### '->putline; 
   if);
   assertFEexists
     (#
        doesNotExist:: 
          (# 
          do
             'No codeeditor for theSifEditor!'
               ->theModel.theGraphicalInterface.stdErr.putline
          #)
     do
        synCatNo->fe.externalInterface.expandOptional;
        theDesignInterface.theDocument[]->theOADDocument[];
        theOADDocument.currentPage->theOADPage[];
        (theOADPage.currentFocus[],theOADPage.currentFocus[])
          ->theOADPage.changedFocus
     #);
   (if switch[40] then
       '###### Freja-sifEditor: expandOptional END ##### '->putline; 
   if)  

-- sifEditorExpandLexem: DoPart --
do
   (if switch[40] then
       '###### Freja-sifEditor: expandLexem ##### '->putline; 
   if);
   assertFEexists
     (#
        doesNotExist:: 
          (# 
          do
             'No codeeditor for theSifEditor!'
               ->theModel.theGraphicalInterface.stdErr.putline
          #)
     do
        theText[]->fe.externalInterface.expandLexem;
        theDesignInterface.theDocument[]->theOADDocument[];
        theOADDocument.currentPage->theOADPage[];
        (theOADPage.currentFocus[],theOADPage.currentFocus[])
          ->theOADPage.changedFocus
     #);
   (if switch[40] then
       '###### Freja-sifEditor: expandLexem END ##### '->putline; 
   if)  

-- sifEditorInsertOptionals: DoPart --
do
   (if switch[40] then
       '###### Freja-sifEditor: insertoptionals ##### '->putline; 
   if);
   assertFEexists
     (#
        doesNotExist:: 
          (# 
          do
             'No codeeditor for theSifEditor!'
               ->theModel.theGraphicalInterface.stdErr.putline
          #)
     do fe.externalInterface.insertOptionals
     #);
   (if switch[40] then
       '###### Freja-sifEditor: insertOptionals END ##### '->putline; 
   if)  

-- sifEditorRemoveOptionals: DoPart --
do
   (if switch[40] then
       '###### Freja-sifEditor: removeoptionals ##### '->putline; 
   if);
   assertFEexists
     (#
        doesNotExist:: 
          (# 
          do
             'No codeeditor for theSifEditor!'
               ->theModel.theGraphicalInterface.stdErr.putline
          #)
     do fe.externalInterface.removeOptionals
     #);
   (if switch[40] then
       '###### Freja-sifEditor: removeOptionals END ##### '->putline; 
   if)  

-- sifEditorParse: DoPart --
do
   assertFEexists
     (#
        doesNotExist:: 
          (# 
          do
             'No codeeditor for theSifEditor!'
               ->theModel.theGraphicalInterface.stdErr.putline
          #)
     do
        (node[],parseText[])->fe.externalInterface.parse
          ->(ok,errorPos,parseErrorText[]);
        theDesignInterface.theDocument[]->theOADDocument[];
        theOADDocument.CurrentPage->theOADPage[];
        (if ok then
            theOADPage.theTextBefore.clear;
            theOADPage.parseableText.clear;
            (if theOADPage.onGoingTitleEditing then
                false->theOADPage.onGoingTitleEditing
             else
                (if theOADPage.ongoingTextediting then
                    theOADPage.CurrentFocus.abstract
                if)
            if);
            false->theOADPage.ongoingTextediting;
            false->theOADPage.parseErrorOccurred
         else
            theOADPage.CurrentObject->theObject[];
            true->theOADPage.parseErrorOccurred
        if)
     #)  

-- sifEditorSearch: DoPart --
do
   assertFEexists
     (#
        doesNotExist:: 
          (# 
          do
             'No codeeditor for theSifEditor!'
               ->theModel.theGraphicalInterface.stdErr.putline
          #)
     do fe.externalInterface.search
     #)  

-- SifEditorIsReadOnly: DoPart --
do
   assertFEexists
     (#
        doesNotExist:: 
          (# 
          do
             'No codeeditor for theSifEditor!'
               ->theModel.theGraphicalInterface.stdErr.putline
          #)
     do (fe.isReadOnly or THIS(sifeditor).sifisEditingMode)->value
     #)  

-- sifEditorOpenSubEditor: DoPart --
do
   assertFEexists
     (#
        doesNotExist:: 
          (# 
          do
             'No codeeditor for theSifEditor!'
               ->theModel.theGraphicalInterface.stdErr.putline
          #)
     do
        (if anAST[] <> none then (anAST[],1)->changeFocus if);
        fe.openSubeditor
     #)  

-- sifEditorFragmentTouched: DoPart --
do
   assertFEexists
     (#
        doesNotExist:: 
          (# 
          do
             'No codeeditor for theSifEditor!'
               ->theModel.theGraphicalInterface.stdErr.putline
          #)
     do fe.externalInterface.fragmentTouched
     #)  

-- frejalibDesignInterfaceOnInit: DoPart --
do
   (theFragmentBrowser.mps.ast[],theFragmentBrowser.mps.betaCFL[])
     ->(mps[],betaGram[]);
   (*
    theExternalInterface[]
    ->theFragmentBrowser.ymerBrowser.edenv.frejaInterface[]; *)
   theFragmentBrowser.gui[]->thegui  

-- frejaShowClassDiag: DoPart --
do
   true->theModel.theGraphicalInterface.showDiagramCalled;
   ymerBrowserInt.sifExternalInterface.showDiagram;
   false->theModel.theGraphicalInterface.showDiagramCalled;
     

