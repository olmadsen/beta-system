ORIGIN '~beta/basiclib/v1.4/betaenv';
BODY 'private/frejamenu'
     'private/frejabody';
INCLUDE '~beta/gpp/v1.5.toby/gppinterface'
        'sdecommunication'
        '~beta/sysutils/v1.4/envstring';
-- lib: Attributes --
freja:
  (#
     sdeModel:<
       (#
          selection: (# #);
          updatePrettyPrint: (# #);
          withDexter:
          (* if true then we start sif with dexter hyperlink support *)
            @Boolean;
          HandleControllerMessage:
            (# t: @Text;
            enter t
            do <<SLOT HandleControllerMessage:ObjectDescriptor>>;
            #);
          parseStatusMessage:
            (#
               status,trailer:
                 ^Text;
               OK: @Boolean;
               editorID: @Integer;
               command: ^Text;
            enter status[]
            do <<SLOT ParseStatusMessage:ObjectDescriptor>>
            exit (command[],ok,editorID,trailer[])
            #);
          theGraphicalInterface: @GraphicalInterface;
          GraphicalInterface:< gppInterface
            (#
               updateFragmentForm::< 
                 (# do (oldff[],ff[])->sifEditorList.updateFragmentForm #);
               sifEditorList: @containerlist
                 (#
                    askedForFragmentForm: ^fragmentForm;
                    element::< 
                      (# editorId: @integer; ff: ^fragmentForm #);
                    findFragmentForm:
                      (# editorId: @integer; ff: ^fragmentForm
                      enter editorId
                      do <<SLOT findFragmentForm:ObjectDescriptor>>
                      exit ff[]
                      #);
                    updateFragmentForm:
                      (# oldff,ff: ^fragmentForm;
                      enter (oldff[],ff[])
                      do <<SLOT updateFragmentForm:ObjectDescriptor>>
                      #);
                    findEditorId:
                      (#
                         ff:
                           ^fragmentForm;
                         editorId: @integer;
                      enter ff[]
                      do <<SLOT findEditorId:ObjectDescriptor>>
                      exit editorId
                      #);
                 #);
               DesignInterface::< 
                 (#
                 (* switches
                  * 10 = sif events
                  * 11 = freja events
                  * 12 = communication
                  *)
                    onInit::<  (# do false->withDexter #);
                    (* make freja dependent user interface here *)
                    FileMenu::< 
                      (#
                         iNew::< 
                           (#
                              hit::< 
                                (#
                                do <<SLOT FrejaFileNew:ObjectDescriptor>>
                                #)
                           #);
                         iQuit::< 
                           (# hit::<  (# do theController.close #) #)
                      #);
                    ShowSIFSelection: @Boolean;
                    (* if true then make selection in SIF Freja follow *)
                    OADDocument::< 
                      (#
                         onInit::< 
                           (#
                           do
                           (* DocCreateMenu.init;
                            *                   DocMakeupMenu.init;
                            *                   DocPageMenu.init;
                            *                   DocGroupMenu.init;
                            *)
                              DocTextMenu.init;
                              DocAlignMenu.init;
                              (UserMenu9,'Attribute Kind')
                                ->AttributeKindMenu.init;
                              (UserMenu6,'Relations')->RelationsMenu.init;
                              (UserMenu2,'Editor')->EditorMenu.init;
                              (*  (UserMenu5,'Create') -> ObjectCreateMenu.init;*)
                           #);
                         EditMenu::< 
                           (#
                              sep1,sep2: @Item;
                              insertBefore: @Item
                                (#
                                   hit::< 
                                     (#
                                     do
                                        <<SLOT InsertBeforeHit:ObjectDescriptor>>
                                     #)
                                #);
                              insertAfter: @Item
                                (#
                                   hit::< 
                                     (#
                                     do
                                        <<SLOT InsertAfterHit:ObjectDescriptor>>
                                     #)
                                #);
                              TextModeOn: @Boolean;
                              ObjectTextEdit: @Item
                                (#
                                   hit::< 
                                     (#
                                     do
                                        <<SLOT ObjectTextEdit:ObjectDescriptor>>
                                     #)
                                #);
                              init::< 
                                (#
                                do <<SLOT EditMenuInit:ObjectDescriptor>>
                                #);
                           #);
                         OptionsMenuDesc::< 
                           (#
                              DebugItemDesc::< 
                                (#
                                   hit::< 
                                     (#
                                     do true->theController.com.debugCOM
                                     #)
                                #);
                              WithDexterItem: @Item
                                (#
                                   hit::< 
                                     (#
                                     do <<SLOT WithDexterHit:ObjectDescriptor>>
                                     #)
                                #);
                              init::< 
                                (#
                                do
                                   <<SLOT FrejaOptionsMenuInit:ObjectDescriptor>>
                                #);
                              CheckCheckMarks::< 
                                (#
                                do
                                   <<SLOT FrejaOptionsMenuCheckMarks:ObjectDescriptor>>
                                #)
                           #);
                         EditorMenu: @UserMenu
                           (#
                              sep: @Item;
                              OpenGroup: @Item
                                (#
                                   hit::< 
                                     (#
                                     do <<SLOT openGroupHit:ObjectDescriptor>>
                                     #)
                                #);
                              OpenForm: @Item
                                (#
                                   hit::< 
                                     (#
                                     do <<SLOT openFormHit:ObjectDescriptor>>
                                     #)
                                #);
                              OpenAST:
                                @Item
                                (#
                                   hit::< 
                                     (#
                                     do <<SLOT openASTHit:ObjectDescriptor>>
                                     #)
                                #);
                              SelectItem:
                                @Item
                                (#
                                   hit::< 
                                     (#
                                     do <<SLOT SelectItem:ObjectDescriptor>>
                                     #)
                                #);
                              OffCommItem:
                                @Item (* temporarily *)
                                (#
                                   hit::< 
                                     (#
                                     do <<SLOT OffCommHit:ObjectDescriptor>>
                                     #)
                                #);
                              SendCommandItem: @Item
                                (#
                                   hit::< 
                                     (#
                                     do
                                        <<SLOT SendCommandHit:ObjectDescriptor>>
                                     #)
                                #);
                              init::< 
                                (#
                                do <<SLOT EditorMenuInit:ObjectDescriptor>>
                                #);
                           #);
                         ObjectCreateMenu: @UserMenu
                           (#
                              CreateNewPage: @Item
                                (#
                                   hit::< 
                                     (#
                                     do <<SLOT CreateNewPage:ObjectDescriptor>>
                                     #)
                                #);
                              CreatePassiveObject: @Item
                                (#
                                   hit::< 
                                     (#
                                     do
                                        <<SLOT CreatePassiveObject:ObjectDescriptor>>
                                     #)
                                #);
                              CreateMultipleObject: @Item
                                (#
                                   hit::< 
                                     (#
                                     do
                                        <<SLOT CreateMultipleObject:ObjectDescriptor>>
                                     #)
                                #);
                              CreateConcurrentObject: @Item
                                (#
                                   hit::< 
                                     (#
                                     do
                                        <<SLOT CreateConcurrentObject:ObjectDescriptor>>
                                     #)
                                #);
                              CreateInteractionRelation: @Item
                                (#
                                   hit::< 
                                     (#
                                     do
                                        <<SLOT CreateInteractionRelation:ObjectDescriptor>>
                                     #)
                                #);
                              CreateTwoWayInteractionRelation: @Item
                                (#
                                   hit::< 
                                     (#
                                     do
                                        <<SLOT CreateTwoWayInteractionRelation:ObjectDescriptor>>
                                     #)
                                #);
                              CreateDistributedInteractionRelation: @Item
                                (#
                                   hit::< 
                                     (#
                                     do
                                        <<SLOT CreateDistributedInteractionRelation:ObjectDescriptor>>
                                     #)
                                #);
                              CreateTwoWayDistributedInteractionRelation: @Item
                                (#
                                   hit::< 
                                     (#
                                     do
                                        <<SLOT CreateTwoWayDistributedInteractionRelation:ObjectDescriptor>>
                                     #)
                                #);
                              CreatePattern: @Item
                                (#
                                   hit::< 
                                     (#
                                     do <<SLOT CreatePattern:ObjectDescriptor>>
                                     #)
                                #);
                              CreatePatternPrefix: @Item
                                (#
                                   hit::< 
                                     (#
                                     do
                                        <<SLOT CreatePatternPrefix:ObjectDescriptor>>
                                     #)
                                #);
                              CreateVirtualPattern: @Item
                                (#
                                   hit::< 
                                     (#
                                     do
                                        <<SLOT CreateVirtualPattern:ObjectDescriptor>>
                                     #)
                                #);
                              init::< 
                                (#
                                do
                                   <<SLOT ObjectCreateMenuInit:ObjectDescriptor>>
                                #);
                           #);
                         AttributeKindMenu: @UserMenu
                           (#
                              Pattern: @Item
                                (#
                                   hit::< 
                                     (#
                                     do
                                        <<SLOT AttributeKindMenuPattern:ObjectDescriptor>>;
                                     #)
                                #);
                              PartObject: @Item
                                (#
                                   hit::< 
                                     (#
                                     do
                                        <<SLOT AttributeKindMenuPartObject:ObjectDescriptor>>;
                                     #)
                                #);
                              ReferenceToObject: @Item
                                (#
                                   hit::< 
                                     (#
                                     do
                                        <<SLOT AttributeKindMenuReferenceToObject:ObjectDescriptor>>;
                                     #)
                                #);
                              VirtualPattern: @Item
                                (#
                                   hit::< 
                                     (#
                                     do
                                        <<SLOT AttributeKindMenuVirtualPattern:ObjectDescriptor>>;
                                     #)
                                #);
                              BindingOfVirtualPattern: @Item
                                (#
                                   hit::< 
                                     (#
                                     do
                                        <<SLOT AttributeKindMenuBindingOfVirtualPattern:ObjectDescriptor>>;
                                     #)
                                #);
                              FinalBindOfVirtPattern: @Item
                                (#
                                   hit::< 
                                     (#
                                     do
                                        <<SLOT AttributeKindMenuFinalBindOfVirtPattern:ObjectDescriptor>>;
                                     #)
                                #);
                              init::< 
                                (#
                                do
                                   <<SLOT AttributeKindMenuInit:ObjectDescriptor>>;
                                #)
                           #);
                         RelationsMenu: @UserMenu
                           (#
                              ObjectReference: @Item
                                (#
                                   hit::< 
                                     (#
                                     do
                                        <<SLOT RelationsMenuObjectReference:ObjectDescriptor>>;
                                     #)
                                #);
                              init::< 
                                (#
                                do
                                   <<SLOT RelationsMenuInit:ObjectDescriptor>>;
                                #)
                           #);
                         ExpandMenu: UserMenu
                           (#
                              ExpandItem: Item
                                (#
                                   synCatNo: @Integer;
                                   syncatName: ^Text;
                                   hit::< 
                                     (#
                                     do <<SLOT ExpandItemHit:ObjectDescriptor>>
                                     #);
                                   create:
                                     (# i: @Integer;
                                     enter (i,syncatno,syncatname[])
                                     do
                                        <<SLOT ExpandItemCreate:ObjectDescriptor>>
                                     #);
                                #);
                              init::< 
                                (# list: ^Text;
                                enter list[]
                                do <<SLOT ExpandMenuInit:ObjectDescriptor>>
                                #);
                           #);
                         theExpandMenu:
                           ^ExpandMenu;
                         MarkMenuDesc::< 
                           (#
                              dummy: @Item;
                              start: @Item
                                (#
                                   hit::< 
                                     (#
                                     do <<SLOT LinkStartHit:ObjectDescriptor>>
                                     #)
                                #);
                              end: @Item
                                (#
                                   hit::< 
                                     (#
                                     do <<SLOT LinkEndHit:ObjectDescriptor>>
                                     #)
                                #);
                              follow: @Item
                                (#
                                   hit::< 
                                     (#
                                     do
                                        <<SLOT LinkFollowHit:ObjectDescriptor>>
                                     #)
                                #);
                              init::< 
                                (#
                                do
                                   (Usermenu5+4,'-')->dummy.init;
                                   dummy.disable;
                                   (UserMenu5+5,'Start Link')->start.init;
                                   (UserMenu5+6,'End Link')->end.init;
                                   (UserMenu5+7,'Follow Link')->follow.init;
                                #);
                           #);
                         OADPalette: @Palette
                           (#
                              normal: @Boolean;
                              lastfree: @Point;
                              width: (# exit 150 #);
                              height: (# exit 20 #);
                              RightOnPage: (# exit 80 #);
                              OADPaletteObject: RectNode
                                (#
                                   SynCatNo: @Integer;
                                   onInit::< 
                                     (#
                                     do
                                        false->moveable;
                                        false->sizeable;
                                        false->BorderVisible;
                                        10->theText.size;
                                        1->LineType;
                                        (* dashed *)
                                     #)
                                #);
                              obj: ^OADPaletteObject;
                              Title: (# enter pagetitle #);
                              Add:
                                (# t: ^Text; no: @Integer;
                                enter (no,t[])
                                do
                                   (if (1->t.inxget) = '-'
                                    // false then
                                       &OADPaletteObject[]->obj[];
                                       no->obj.SynCatNo;
                                       (lastfree.x,lastfree.y,width,height)
                                         ->obj.new;
                                       t->obj.theText.set;
                                       height*2+lastfree.y->lastfree.y;
                                   if);
                                #);
                              Clear:
                                (# x,y,w,h: @Integer;
                                do
                                   (if isopen
                                    // true then
                                       cleanup;
                                       (* set up lastfree *)
                                       geometry->(x,y,w,h);
                                       (x-(w div 2)+RightOnPage,y-(h div 2)+
                                        RightOnPage)->lastfree;
                                       none ->obj[]
                                   if);
                                #);
                              Reset:
                                (#
                                do
                                   DSUIAbortCommand;
                                   (* like pressing cmd-. or ESC 
                                    * on keyboard *)
                                #);
                              onInit::< 
                                (# x,y,w,h: @Integer;
                                do (* set up lastfree *)
                                   geometry->(x,y,w,h);
                                   (x-(w div 2)+RightOnPage,y-(h div 2)+
                                    RightOnPage)->lastfree;
                                #);
                              onSelect::< 
                                (# p: ^Page; op: ^OADPage;
                                do
                                   theObject[]->obj[];
                                   (if switch[1]
                                    // true then
                                       'Selected syntatical cat.: '->puttext;
                                       obj.SynCatNo->putint;
                                       newline;
                                   if);
                                   (if obj.SynCatNo <> 0
                                    // true then
                                       currentpage->p[];
                                       (if p[] <> none
                                        // true then
                                           (if p.struc <= Palette##
                                            // true then
                                               'CurrentPage is a Palette'
                                                 ->putline;
                                            else
                                               p[]->op[];
                                               (obj.SynCatNo,normal)
                                                 ->op.doExpand;
                                           if)
                                       if)
                                   if)
                                #);
                           #);
                         changeASTFocus:<
                           (# SifEditorInstanceNo,ASTIndex: @integer
                           enter (SifEditorInstanceNo,ASTIndex)
                           do <<SLOT changeASTFocus:ObjectDescriptor>>;
                           #);
                         OADPage::< 
                           (#
                              canUndo,
                                canPaste,canListInsert: @Boolean;
                              insertedObject: ^PatternDiagramNode;
                              nonTerminalCatName: ^Text;
                              concludeExpansion:
                                (#
                                do
                                   <<SLOT concludeExpansion:ObjectDescriptor>>;
                                #);
                              (* operations on gSif *)
                              openObjectInSif:
                                (# theObject: ^PatternDiagramNode;
                                enter theObject[]
                                do <<SLOT OpenObjectInSif:ObjectDescriptor>>;
                                #);
                              getStatus:
                                (# theObject: ^DesignObject;
                                enter theObject[]
                                do <<SLOT GetStatusFromSif:ObjectDescriptor>>;
                                #);
                              doExpand:
                                (# synCatNo: @Integer; normal: @Boolean;
                                enter (synCatNo,normal)
                                do <<SLOT DoExpand:ObjectDescriptor>>;
                                #);
                              doExpandLexem:
                                (#
                                   name:
                                     @Text;
                                enter name
                                do <<SLOT DoExpandLexem:ObjectDescriptor>>;
                                #);
                              MakeAPalette:
                                (# t: ^Text;
                                enter t[]
                                do <<SLOT MakeAPalette:ObjectDescriptor>>;
                                #);
                              getDexterAnchors::< 
                                (#
                                do <<SLOT GetDexterAnchors:ObjectDescriptor>>;
                                #);
                              (* events from freja *)
                              changedFocus::< 
                                (#
                                do <<SLOT ChangedFocus:ObjectDescriptor>>
                                #);
                              lexemExpand::< 
                                (#
                                do <<SLOT lexemExpand:ObjectDescriptor>>
                                #);
                              prefixExpand::< 
                                (#
                                do <<SLOT prefixExpand:ObjectDescriptor>>
                                #);
                              copy::< 
                                (# do <<SLOT copy:ObjectDescriptor>> #);
                              (* events from gSIF *)
                              onFocusChange:<
                                (#
                                   astindex,length,editorId: @Integer;
                                   status: @Boolean;
                                enter (editorId,astIndex,length)
                                do <<SLOT onFocusChange:ObjectDescriptor>>
                                exit
                                status
                                #);
                              astReplaced::< 
                                (#
                                do <<SLOT frejaAstReplaced:ObjectDescriptor>>
                                #);
                              MakeAnchors::<  (# do INNER #);
                              presentAnchor:<
                                (# theIndex: @Integer;
                                enter theIndex
                                do <<SLOT presentAnchor:ObjectDescriptor>>
                                #);
                              private:
                                @<<SLOT FrejaOADPagePrivate:ObjectDescriptor>>
                           #)
                      #);
                    activatedFromSif::< 
                      (# do <<SLOT activatedFromSif:ObjectDescriptor>> #);
                    dexterOn::< 
                      (#
                      do
                         true
                           ->
                             withDexter
                      #);
                 do
                    true->switch[10]->switch[11]->switch[12];
                    true->switch[1]->switch[2]->switch[20]->switch[22]
                      ->switch[23];
                    (* true->switch[31];
                     do not use expand menu/palette *)
                 #);
               (* end DesignInterface *)
            do <<SLOT FrejaDoPart:ObjectDescriptor>>
            #);
          (* end GraphicalInterface *)
       do theGraphicalInterface;
       #);
     (* end sdeModel *)
     sdeControl:<
       (#
          startedFromProgram: @Boolean;
          com: @sdeCommunication
            (#
               onInput::< 
                 (#
                 do
                    msg
                      ->
                        theModel.
                          HandleControllerMessage;
                 #);
            #);
          init: (# do <<SLOT ControllerInit:ObjectDescriptor>> #);
          close:
            (#
            do
               <<SLOT ControllerClose:ObjectDescriptor>>
            #);
          sendSifCommand:
            (# t: ^Text;
            enter t[]
            do <<SLOT ControllerSendSifCommand:ObjectDescriptor>>
            #);
          sendSifStatus:
            (# t: ^Text;
            enter t[]
            do
               t[]
                 ->
                   com.
                     putline;
            #);
       #);
     theModel: @sdeModel;
     theController:
       @sdeControl;
  do theMod