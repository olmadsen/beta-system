(* OBJFILE default '~beta/designOA/v1.0/$/getarg.o';*)
ORIGIN '~beta/basiclib/basicsystemenv';
INCLUDE 'frejaenv'
        'frejainterface'
        '~beta/editor/sifnotifications'
        '~beta/sourcebrowser/ymerInterface';
LIB_DEF 'frejalib' '../lib';
BODY 'private/externalinterfacebody';
(* '~beta/guienv/v1.6/utils/designsupport' *)
(* '~beta/Xt/v1.10/xlib' *)
(* 'private/frejaxtbody' *)
-- lib: Attributes --
freja: frejaenv
  (#
     frejaShowClassDiag::<  (#  <<SLOT frejaShowClassDiag:DoPart>> #);
     visibleInFreja:
       (#
          node: ^astInterface.ast;
          value: @boolean;
          
       enter node[]
       do
          <<SLOT SifEditorVisibleInFreja:Descriptor>>
       exit value
       #);
     SifInterface:< frejaInterface
       (#
          ignoreGroupSaved: @boolean;
          newDiagram::< 
            (#  <<SLOT theExternalInterfaceNewDiagram:DoPart>> #);
          showDiagram::< 
            (# 
            <<SLOT theExternalInterfaceShowDiagram:DoPart>>
            #);
          newFragment::< 
            (#
               se: ^codeEditor;
               aSifEditor: ^theModel.theGraphicalInterface.sifEditor;
               theDoc:
                 ^theModel.theGraphicalInterface.theDesignInterface.OADDocument;
               theOADPage: ^theDoc.OADPage
            <<SLOT theExternalInterfaceNewFragment:DoPart>>
            #);
          openForm::< 
            (#
               se:
                 ^codeEditor;
               aSifEditor: ^theModel.theGraphicalInterface.sifEditor;
               theDoc:
                 ^theModel.theGraphicalInterface.theDesignInterface.OADDocument;
               theOADPage: ^theDoc.OADPage;
               alreadyOpenInFreja: @boolean
            <<SLOT theExternalInterfaceOpenForm:DoPart>>
            #);
          groupChecked::< 
            (#
               theOADDoc:
                 ^theModel.
                    theGraphicalInterface.theDesignInterface.OADDocument
            <<SLOT theExternalInterfaceGroupChecked:DoPart>>
            #);
          groupNotSaved::< 
            (# 
            <<SLOT theExternalInterfaceGroupNotSaved:DoPart>>
            #);
          closeUntouchedGroup::< 
            (#  <<SLOT theExternalInterfaceCloseUntouchedGroup:DoPart>> #);
          groupSaved::< 
            (#
               theOADDoc:
                 ^theModel.theGraphicalInterface.theDesignInterface.OADDocument
            <<SLOT theExternalInterfaceGroupSaved:DoPart>>
            #);
          groupAutoSaved::< 
            (#
               theOADDoc:
                 ^theModel.
                    theGraphicalInterface.theDesignInterface.OADDocument
            <<SLOT theExternalInterfaceGroupAutoSaved:DoPart>>
            #);
          propertiesChanged::<
           
            (#
               theDoc:
                 ^theModel.theGraphicalInterface.theDesignInterface.OADDocument
            <<SLOT theExternalInterfacePropertiesChanged:DoPart>>
            #);
          fragmentChanged::< 
            (#
               theDoc:
                 ^theModel.theGraphicalInterface.theDesignInterface.OADDocument
            <<SLOT theExternalInterfaceFragmentChanged:DoPart>>
            #);
          fragmentInserted::<
           
            (#
               theDoc:
                 ^theModel.theGraphicalInterface.theDesignInterface.OADDocument
            <<SLOT theExternalInterfaceFragmentInserted:DoPart>>
            #);
          fragmentDeleted::<
           
            (#
               theDoc:
                 ^theModel.theGraphicalInterface.theDesignInterface.OADDocument
            <<SLOT theExternalInterfaceFragmentDeleted:DoPart>>
            #);
          askBeforeTextEditing::< 
            (#  <<SLOT theExternalInterfaceAskBeforeTextEditing:DoPart>> #);
          
       #);
     theExternalInterface: @SifInterface;
     sdeModel::< 
       (#
          GraphicalInterface::< 
            (#
               sifInsertInWindowsMenu::< 
                 (# 
                 do win[]->ymerBrowserInt.WindowsMenuInsertWindow; 
                 #);
               sifGetWindowsMenu::< 
                 (# 
                 do ymerBrowserInt.getWindowsMenu->winMenu[]; 
                 #);
               ignoreGroupSavedFromSif::< 
                 (#  do value->theExternalInterface.ignoreGroupSaved #);
               sifEditor::< 
                 (#
                    fe: ^codeEditor;
                    assertFEexists:
                      (# doesNotExist:< (#  do INNER doesNotExist #)
                      do
                         (if fe[] <> none then
                             INNER assertFEexists
                          else
                             doesNotExist
                         if)
                      #);
                    ffObserverType:< fe.frag.sifFragmentFormObserver
                      (#
                         ignoreEvents: @boolean;
                         ignore::<  (#  do ignoreEvents->value #);
                         onFocusChanged::< 
                           (# 
                           <<SLOT theExternalInterfaceFocusChanged:DoPart>>
                           #);
                         onAstReplaced::< 
                           (# 
                           <<SLOT theExternalInterfaceAstReplaced:DoPart>>
                           #);
                         onAstReplacedSequence::< 
                           (# 
                           <<SLOT theExternalInterfaceAstReplacedSequence:DoPart>>
                           #);
                         onListElementInserted::< 
                           (# 
                           <<SLOT theExternalInterfaceListElementInserted:DoPart>>
                           #);
                         onListElementsDeleted::< 
                           (# 
                           <<SLOT theExternalInterfaceListElementsDeleted:DoPart>>
                           #);
                         onListElementsReplaced::< 
                           (# 
                           <<SLOT theExternalInterfaceListElementsReplaced:DoPart>>
                           #);
                         onEnterTextediting::< 
                           (#  do true->sifisEditingMode #);
                         onExitTextediting::< 
                           (#  do false->sifisEditingMode #)
                      #);
                    ffObserver: ^ffObserverType;
                    undo::<  (#  <<SLOT SifEditorUndo:DoPart>> #);
                    redo::< 
                      (# 
                      <<SLOT sifEditorRedo:DoPart>>
                      #);
                    cut::<  (#  <<SLOT sifEditorCut:DoPart>> #);
                    copy::< 
                      (# 
                      <<SLOT sifEditorCopy:DoPart>>
                      #);
                    paste::<  (#  <<SLOT sifEditorPaste:DoPart>> #);
                    clear::< 
                      (# 
                      <<SLOT sifEditorClear:DoPart>>
                      #);
                    before::<  (#  <<SLOT sifEditorBefore:DoPart>> #);
                    after::<  (#  <<SLOT sifEditorAfter:DoPart>> #);
                    changeFocus::< 
                      (# 
                      <<SLOT sifEditorChangeFocus:DoPart>>
                      #);
                    getStatus::<  (#  <<SLOT sifEditorGetStatus:DoPart>> #);
                    expandNormal::< 
                      (#
                         theOADDocument: ^theDesignInterface.OADDocument;
                         theOADPage: ^theOADDocument.OADPage
                      <<SLOT sifEditorExpandNormal:DoPart>>
                      #);
                    expandOptional::< 
                      (#
                         theOADDocument:
                           ^theDesignInterface.OADDocument;
                         theOADPage: ^theOADDocument.OADPage
                      <<SLOT sifEditorExpandOptional:DoPart>>
                      #);
                    expandLexem::< 
                      (#
                         theOADDocument:
                           ^theDesignInterface.OADDocument;
                         theOADPage: ^theOADDocument.OADPage
                      <<SLOT sifEditorExpandLexem:DoPart>>
                      #);
                    insertOptionals::< 
                      (# 
                      <<SLOT sifEditorInsertOptionals:DoPart>>
                      #);
                    removeOptionals::< 
                      (#  <<SLOT sifEditorRemoveOptionals:DoPart>> #);
                    parse::< 
                      (#
                         theOADDocument:
                           ^theDesignInterface.OADDocument;
                         theOADPage: ^theOADDocument.OADPage;
                         theObject: ^theOADPage.PatternDiagramNode
                      <<SLOT sifEditorParse:DoPart>>
                      #);
                    search::< 
                      (# 
                      <<SLOT sifEditorSearch:DoPart>>
                      #);
                    isReadOnly::< 
                      (#  <<SLOT SifEditorIsReadOnly:DoPart>> #);
                    openSubEditor::< 
                      (# 
                      <<SLOT sifEditorOpenSubEditor:DoPart>>
                      #);
                    fragmentTouched::< 
                      (#  <<SLOT sifEditorFragmentTouched:DoPart>> #);
                    init::< 
                      (# 
                      enter fe[]
                      do
                         &
                            ffObserverType[]->ffObserver[]
                           ->fe.frag.attachObserver
                      #)
                 #);
               DesignInterface::< 
                 (#
                    OADDocument::< 
                      (#
                         onKeyDown::< 
                           (# 
                           do
                              theFragmentBrowser.isActive
                                ->fragmentBrowserIsActive
                           #)
                      #);
                    onInit::< 
                      (#  <<SLOT frejalibDesignInterfaceOnInit:DoPart>> #)
                 #)
            #)
       do INNER sdeModel
       #);
     sdeControl::< 
       (#
          globalSifCommandsDesc::<
           
            (#
               openForm::<  (#  <<SLOT globalSifCommandsOpenForm:DoPart>> #);
               getEditorForForm:
                 (#
                    ff: ^theModel.theGraphicalInterface.mps.fragmentForm;
                    node: ^theModel.theGraphicalInterface.mps.ast;
                    se: ^codeEditor
                 enter (ff[],node[])
                 <<SLOT globalSifCommandsGetEditorForForm:DoPart>>
                 exit se[]
                 #);
               newBETAProgram::< 
                 (#  <<SLOT globalSifCommandsNewBETAProgram:DoPart>> #);
               newBETALibrary::<
                 (#  <<SLOT globalSifCommandsNewBETALibrary:DoPart>> #);
               toggleDebug::< 
                 (# 
                 <<SLOT globalSifCommandsToggleDedug:DoPart>>
                 #);
               saveAndQuit::< 
                 (# filename: @text
                 <<SLOT globalSifCommandsSaveAndQuit:DoPart>>
                 #);
               save::< 
                 (#
                    filename: @text
                 <<SLOT globalSifCommandsSave:DoPart>>
                 #);
               autoSave::< 
                 (# filename: @text
                 <<SLOT globalSifCommandsAutoSave:DoPart>>
                 #);
               checkAutoSaveFile::< 
                 (#  <<SLOT globalSifCommandsCheckAutoSaveFile:DoPart>> #);
               check::< 
                 (# 
                 <<SLOT globalSifCommandsCheck:DoPart>>
                 #);
               addProp::<  (#  <<SLOT globalSifCommandsAddProp:DoPart>> #);
               deleteProp::< 
                 (# 
                 <<SLOT globalSifCommandsDeleteProp:DoPart>>
                 #);
               setFrejaMark::< 
                 (#  <<SLOT globalSifCommandsSetFrejaMark:DoPart>> #);
               getFrejaMark::< 
                 (# 
                 <<SLOT globalSifCommandsGetFrejaMark:DoPart>>
                 #)
            #)
       #);
     sifHidden: @boolean;
     gui: ^guienv;
     theFragmentBrowser: ^ymerEnvInterface;
     ymerBrowserInt: ^ymerBrowserInterface;
     browserWindow: ^gui.window;
     (* to allow Sif and bifrost design to share the same guienv,
      * theFragmentBrowser needs to be run instead of theModel.
      * theFragmentBrowser should instead call theModel.
      * Also note that theFragmentBrowser will never return, as it
      * is a specialisation of guienv.
      *)
     init:
       (# 
       enter theFragmentBrowser[]
       do
          theFragmentBrowser.gui[]->gui[];
          false->theModel.theGraphicalInterface.isStandAloneFreja;
          themodel;
          
       exit theExternalInterface[]
       #);
     initFrejaWindow:
       (# 
       enter ymerBrowserInt[]
       do ymerBrowserInt.ymerBrowser[]->browserWindow[]; 
       #);
     setupmenus:
       (# 
       do
          &gui.MenubarAppendMenuAction
            (#
               frejaMenu: gui.Menu
                 (#
                    iNewLib: @item
                      (# onSelect::  (#  do FrejaNewLib #) #);
                    iNewProgram: @item
                      (# onSelect::  (#  do FrejaNewProgram #) #);
                    iNewGraphicsPage: @item
                      (# onSelect::  (#  do FrejaNewGraphicsPage #) #);
                    iOpen: @item (# onSelect::  (#  do FrejaOpen #) #);
                    iShowClassDiag: @item
                      (#
                         onStatus:: 
                           (# 
                           do
                           (* currently disabled because
                            lock is also set when readnoly
                            (if (ymerBrowserInt[] <> none ) and
                            (ymerBrowserInt.cfe[] <> none ) and
                            (ymerBrowserInt.cfe.frag[] <> none ) then
                            not ymerBrowserInt.cfe.frag.locked->value
                            if)*) 
                           #);
                         onSelect::  (#  do FrejaShowClassDiag #)
                      #);
                    iShowObjectDiag: @item
                      (# onSelect::  (#  do FrejaShowObjectDiag #) #);
                    iLoadGraphics: @item
                      (# onSelect::  (#  do FrejaLoadGraphics #) #);
                    open:: 
                      (# 
                      do
                         'New Diagram...'->iNewLib.new;
                         (* 'New Program...'->iNewProgram.new; *)
                         (* 'New Graphics Page...'->iNewGraphicsPage.new; *)
                         'Open Diagram...'->iOpen.new;
                         newSeparator;
                         'Show Diagram...'->iShowClassDiag.new;
                         (* 'Show Object Diagram...'->iShowObjectDiag.new; *)
                         (* newSeparator;
                          'Load Graphics...'->iLoadGraphics.new;*)
                         'Diagrams'->name
                      #)
                 #);
               fm: ^frejamenu
            do &frejamenu[]->fm[]; fm.open; fm[]->themenubar.append; 
            #)[]->theFragmentBrowser.addMenuAction;
          
       #);
     
  enter theModel.theGraphicalInterface.isStandAloneFreja
  do <<SLOT frejalibdopart:Descriptor>>; INNER ; (* theFragmentBrowser *) 
  #)  

