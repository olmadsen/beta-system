# BETA RUNTIME SYSTEM, Copyright (C) 1991-2000 Mjolner Informatics A/S
# ymakefile-GC
# by Lars Bak, Peter Andersen, Tommy Thorn and Peter Oerbaek
# 
# datpete:
# After having fixed sparc stack layout to match gcc, none of the
# files in the GC directory need be compiled with optimization in
# debug versions of RTS anymore.
# 
# Heavily modified and renamed to Makefile-vpath by Erik Corry

vpath %.h $(BETARUN)/C
vpath %.gen $(BETARUN)/C
vpath %.c $(BETARUN)/P
vpath %.h $(BETARUN)/P

MAKEFILE = $(BETARUN)/P/Makefile-vpath

ORD_SRC  = \
	PSfile.c \
	des.c \
	cache.c \
	storageblock.c \
	sequenceTable.c \
	misc.c \
	PExport.c \
	objectTable.c \
	PImport.c \
	PException.c \
	referenceTable.c \
	unswizzle.c \
	proto.c \
	storagemanager.c \
	transitObjectTable.c \
	specialObjectsTable.c \
	trie.c \
	pit.c

GEN_SRC  = data.gen export.h declare.h

INC_SRC  := \
	macro.h \
	beta.h \
	define.h \
	constant.h \
	heap.h \
	object.h \
	function.h \
	registers.h

ifeq ($(ARCH), sun4s)

INC_SRC := $(INC_SRC) \
	sparcdep.h \
	PException.h \
	storagemanager.h \
	PException.h \
	sequenceTable.h \
	PExport.h \
	transitObjectTable.h \
	specialObjectsTable.h \
	PImport.h \
	misc.h \
	error.h \
	PSfile.h \
	objectTable.h \
	trie.h \
	proto.h \
	unswizzle.h \
	referenceTable.h
endif

ifeq ($(ARCH), hpux9pa)
INC_SRC  := $(INC_SRC) snakedep.h
endif

OBJFILES  = $(ORD_SRC:.c=.$(DOTO))

SOURCES  = $(MAKEFILE) $(ORD_SRC)

ifeq ($(GNUC), yes)
CC	= gcc
CC_OPT	:= -Wall -Werror $(CC_OPT)
endif

ifeq ($(ARCH), macosx)
  CC_OPT := $(CC_OPT) -D$(ARCH)
  OPTIMISEOPT := -O2
endif

ifeq ($(ARCH), sgi)
CC	= cc
CC_OPT	:= $(ABI) $(CC_OPT)
endif

ifeq ($(ARCH), nti_ms)
CC	= cl /W3 /nologo
endif

INCLUDES = $(INC_SRC) data.h

all: print_info c.p.o

c.p.o: $(OBJFILES) $(MAKEFILE)
ifeq ($(ARCH), sgi)
	ld $(ABI) -r -o $@ $(OBJFILES)
else
ifeq ($(ARCH), sun4s)
	# touch $@ # no need to link - we use "ar -r" from top directory
else
  ifneq ($(ARCH), nti_ms)
	ld -r -o $@ $(OBJFILES)
  endif
endif
endif

CC_OPT    := $(CC_OPT) -I$(BETARUN)/P -I$(BETARUN)/C $(EXTRA_C_OPTIONS)

ifeq ($(MAJORARCH), nti)
  CC_OPT := $(CC_OPT) -D$(MAJORARCH) -D$(MAJORARCH)_$(MINORARCH) -DWIN32
endif

ifeq ($(RTDEBUG), yes)
CC_OPT := $(CC_OPT) -DRTDEBUG
endif

ifeq ($(ALLOC_TRACE), yes)
  CC_OPT := $(CC_OPT) -DALLOC_TRACE
endif

ifeq ($(CDEBUG), yes)
CC_OPT := $(CC_OPT) $(DEBUGOPT) $(PROF)
else
CC_OPT := $(CC_OPT) $(OPTIMISEOPT) $(PROF)
endif

ifeq ($(VALHALLA), yes)
CC_OPT := $(CC_OPT) -DRTVALHALLA
endif

ifeq ($(UGC), yes)
CC_OPT := $(CC_OPT) -Ddo_unconditional_gc
endif

$(OBJFILES): %$(DOTO): %c $(INCLUDES) $(MAKEFILE)
	@$(ECHO) $(CC) ... -c $< $(ECHOEND)
	@$(CC) $(CC_OPT) -c -o $@ $<

print_info:
	@$(ECHO) '' $(ECHOEND)
	@$(ECHON)    '   Compiling in: ' $(ECHONEND)
	@$(PWDCMD)
	@$(ECHON)    '   With command line: ' $(ECHONEND)
	@$(ECHO) $(CC) $(CC_OPT) -c -o file.$(DOTO) /path/to/file.c $(ECHOEND)
	@$(ECHO) '' $(ECHOEND)

clean: 
	@-$(RM) $(OBJFILES) *~ *.s *.i *.o *.gen *.obj

srclist:
	@echo $(SOURCES)    | tr -s " " "\012"
