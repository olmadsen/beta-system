/*
 * BETA C RUNTIME SYSTEM, Copyright (C) 1990,91,92 Mjolner Informatics Aps.
 * by Peter Andersen and Tommy Thorn.
 */

MAKEFILE = Makefile

#ifdef hppa
ORD_SRC = AllocateComponent.c AllocateItem.c AllocateRefRep.c \
 AllocateStackObject.c AllocateValRep.c AllocateDopartObject.c AttachBasicComponent.c \
 CInterface.c CopyCtext.c CallBack.c CopySliceRefRep.c CopySliceValRep.c\
 CopyText.c CopyValRep.c CopyRefRep.c ExtendRefRep.c \
 ExtendValRep.c	Misc.c	NewRefRep.c NewValRep.c PerformGC.c Structure.c \
 CheckReferenceAssignment.c MakeTextObj.c HandleIndexErr.c Qua.c
#else
ORD_SRC  = AllocateComponent.c AllocateItem.c AllocateRefRep.c \
 AllocateStackObject.c AllocateValRep.c AllocateDopartObject.c \
 Attach.c AttachBasicComponent.c \
 CInterface.c CopyCtext.c CallBack.c CopySliceRefRep.c CopySliceValRep.c\
 CopyText.c CopyValRep.c CopyRefRep.c ExitObjects.c ExtendRefRep.c \
 ExtendValRep.c	\
 Misc.c	NewRefRep.c NewValRep.c PerformGC.c Structure.c Suspend.c \
 CheckReferenceAssignment.c MakeTextObj.c HandleIndexErr.c Qua.c
#endif

#ifdef sun
#  ifndef sparc
#    define sun3
#  endif
#endif

ORD_OBJ  = $(ORD_SRC:.c=.o) 

INC_SRC  = ../C/macro.h ../C/beta.h ../C/define.h ../C/constant.h \
           ../C/heap.h ../C/object.h ../C/function.h crun.h

#ifdef hpux
CC       = cc
CPP      = /lib/cpp -P $(C_FLAGS)
#endif

#ifdef hppa
CC	 = gcc
CPP      = /lib/cpp -P $(C_FLAGS)
ASM_SRC = SnakeAdditions.S
ASM_OBJ = SnakeAdditions.o
#endif

#ifdef sun3
CC       = cc
CPP      = /usr/lib/cpp -P $(C_FLAGS)
#endif

#ifdef sparc
CC       = gcc
CPP      = cc -E $(C_FLAGS)
#endif

#ifdef sun4s
CC       = gcc
CPP      = ccc -E $(C_FLAGS)
#endif

#ifdef crts
CC       = gcc
CPP      = gcc -E $(C_FLAGS)
#endif

#ifdef apollo
CC       = cc
CPP      = /usr/lib/cpp -P $(C_FLAGS)
#endif

#ifdef macintosh
CC       = C
CPP      = /lib/cpp -P -Dmacintosh $(CPP_FLAGS)
#endif

SOURCES  = $(Makefile) $(ORD_SRC)
OBJFILES = $(ORD_OBJ) $(ASM_OBJ)


#ifdef sparc
INCLUDES = $(INC_SRC) ../C/sparcdep.h
#else
#  ifdef snake
     INCLUDES = $(INC_SRC) ../C/snakedep.h
#  else
     INCLUDES = $(INC_SRC)
#  endif
#endif

CC_OPT  = $(C_OPT) $(C_FLAGS)

$(MAIN): $(OBJFILES)
#ifdef macintosh
	lib -o $@ $(OBJFILES)
#else
	ld -r -o $@ $(OBJFILES)
#endif

$(ORD_OBJ): $($@:.o=.c) $(INCLUDES)
#ifdef macintosh
	$(CC) -o $@ $(CC_OPT) $(@:.o=.c)
#else
	$(CC) -c $(CC_OPT) $(@:.o=.c)
#endif

#ifdef hppa
$(ASM_OBJ): $(ASM_SRC) $(INCLUDES)
	#$(CPP) $(@:.o=.S) > $(@:.o=.s); cc -c $(@:.o=.s)
	$(CPP) $(@:.o=.S) > $(@:.o=.s); gas -o $@ $(@:.o=.s)
#endif

clean: 
	-rm -f $(OBJFILES) *~

srclist:
	@echo $(SOURCES) | tr -s " " "\012"

CheckGCable:
	# only SPARC !!
	gcc2 -S -O3 -I../C -DLVR_Area -DAO_Area -DRTINFO $(SOURCES)
	grep '%fp' *.s|grep -v 'add %fp,-64,%sp'
