/*
 * BETA C RUNTIME SYSTEM, Copyright (C) 1990,91,92 Mjolner Informatics Aps.
 * by Peter Andersen and Tommy Thorn.
 */

MAKEFILE = Makefile

/* datpete:
 * All allocation routines must be compiled with full optimization,
 * even for debug RTS.
 * A few files could be compiled with -O0; the following, I think:
 *  AttachBasicComponent.c CInterface.c CallBack.c Misc.c PerformGC.c 
 *  CheckReferenceAssignment.c HandleIndexErr.c Qua.c 
 * But the split in OPTA and OPTB has not yet been done.
 */

#ifdef hppa
ORD_SRC = AllocateComponent.c AllocateItem.c AllocateRefRep.c \
 AllocateObjectRep.c \
 AllocateStackObject.c AllocateValRep.c AllocateDopartObject.c AttachBasicComponent.c \
 CInterface.c CopyCtext.c CallBack.c CopySliceRefRep.c CopySliceValRep.c\
 CopyText.c CopyValRep.c CopyRefRep.c ExtendRefRep.c \
 ExtendValRep.c	Misc.c	NewRefRep.c NewValRep.c PerformGC.c Structure.c \
 CheckReferenceAssignment.c MakeTextObj.c HandleIndexErr.c Qua.c \
 COM.c
#else
ORD_SRC  = AllocateComponent.c AllocateItem.c AllocateRefRep.c \
 AllocateObjectRep.c \
 AllocateStackObject.c AllocateValRep.c AllocateDopartObject.c \
 Attach.c AttachBasicComponent.c \
 CInterface.c CopyCtext.c CallBack.c CopySliceRefRep.c CopySliceValRep.c\
 CopyText.c CopyValRep.c CopyRefRep.c ExitObjects.c ExtendRefRep.c \
 ExtendValRep.c	\
 Misc.c	NewRefRep.c NewValRep.c PerformGC.c Structure.c Suspend.c \
 CheckReferenceAssignment.c MakeTextObj.c HandleIndexErr.c Qua.c \
 COM.c
#endif

ORD_OBJ  = $(ORD_SRC:.c=.o) 

#ifdef sparc
INC_SRC  = ../C/macro.h ../C/beta.h ../C/define.h ../C/constant.h \
           ../C/heap.h ../C/object.h ../C/function.h crun.h IOAAlloc.h \
           ../C/registers.h ../C/sparcdep.h ../P/PException.h ../P/referenceTable.h
#endif

#ifdef hppa
INC_SRC  = ../C/macro.h ../C/beta.h ../C/define.h ../C/constant.h \
           ../C/heap.h ../C/object.h ../C/function.h crun.h IOAAlloc.h \
           ../C/registers.h ../C/snakedep.h
#endif

#if ((!defined(sparc)) && (!defined(hppa)))
INC_SRC  = ../C/macro.h ../C/beta.h ../C/define.h ../C/constant.h \
           ../C/heap.h ../C/object.h ../C/function.h crun.h IOAAlloc.h \
           ../C/registers.h
#endif

#ifdef __GNUC__
#if defined(__svr4__) /* solaris */ || defined(linux) || defined(hppa)
CC	 = gcc -Wall -Werror /* cannot use -Werror and -pedantic together */
CPP      = gcc -E -P $(C_FLAGS)
#endif
#endif

#ifdef hppa
ASM_SRC = SnakeAdditions.S
ASM_OBJ = SnakeAdditions.o
/* SnakeAdditions.S cannot be preprocessed by gcc */
CPP	 = cc -E -P $(C_FLAGS)
#endif

SOURCES  = $(Makefile) $(ORD_SRC)
OBJFILES = $(ORD_OBJ) $(ASM_OBJ)

#ifdef sparc
  INCLUDES = $(INC_SRC) ../C/sparcdep.h
#endif
#ifdef hppa
  INCLUDES = $(INC_SRC) ../C/snakedep.h
#endif

CC_OPT  = $(C_OPT) $(C_FLAGS)

$(MAIN): $(OBJFILES)
#ifdef hppa
	ld -r -o $@ $(OBJFILES)
#else
	touch $@ /* no need to link - we use "ar -r" from top directory */
#endif

$(ORD_OBJ): $($@:.o=.c) $(INCLUDES)
	$(CC) -c $(CC_OPT) $(@:.o=.c)

#ifdef hppa
$(ASM_OBJ): $(ASM_SRC) $(INCLUDES)
	$(CPP) $(@:.o=.S) > $(@:.o=.s); /usr/local/gnu/bin/as -o $@ $(@:.o=.s)
#endif

clean: 
	@-rm -f $(OBJFILES) *~ *.s *.i

srclist:
	@echo $(SOURCES) | tr -s " " "\012"

#ifdef sparc
CheckGCable:
	-objdump -dr *.o | grep '%fp' | sh -c "grep -v 'add  -64, %fp, %sp'; exit 0"
CheckSave:
	-objdump -dr *.o | grep 'save' | sh -c "grep -v '%sp, -112, %sp'; exit 0"
#endif
