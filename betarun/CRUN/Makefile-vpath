# 
#  BETA C RUNTIME SYSTEM, Copyright (C) 1990,91,92,2000,01 Mjolner Informatics A/S.
#  by Peter Andersen and Tommy Thorn.
# 
#  Heavily modified by Erik Corry

MAKEFILE = $(BETARUN)/CRUN/Makefile-vpath

vpath %.h $(BETARUN)/CRUN
vpath %.c $(BETARUN)/CRUN
vpath %.S $(BETARUN)/CRUN
vpath %.h $(BETARUN)/C
vpath %.h $(BETARUN)/P
vpath %.gen $(BETARUN)/C
vpath %.h $(BETARUN)/GC
vpath %.c $(BETARUN)/GC

#  datpete:
#  All allocation routines must be compiled with full optimization,
#  even for debug RTS.
#  A few files could be compiled with -O0; the following, I think:
#   AttachBasicComponent.c CInterface.c CallBack.c Misc.c PerformGC.c 
#   CheckReferenceAssignment.c HandleIndexErr.c Qua.c 
#  But the split in OPTA and OPTB has not yet been done.

ORD_SRC := \
	AllocateComponent.c \
	AllocateItem.c \
	AllocateRefRep.c \
	AllocateObjectRep.c \
	AllocateStackObject.c \
	AllocateValRep.c \
	AllocateDopartObject.c \
	AttachBasicComponent.c \
	CInterface.c \
	CopyCtext.c \
	CallBack.c \
	CopySliceRefRep.c \
	CopySliceValRep.c\
	CopyText.c \
	CopyValRep.c \
	CopyRefRep.c \
	ExitObjects.c \
	ExtendRefRep.c \
	ExtendValRep.c \
	Misc.c \
	NewRefRep.c \
	NewValRep.c \
	PerformGC.c \
	Structure.c \
	CheckReferenceAssignment.c \
	MakeTextObj.c \
	HandleIndexErr.c \
	Qua.c \
	COM.c

ifeq ($(ARCH), sun4s)
   ORD_SRC := $(ORD_SRC) \
        Attach.c \
        Suspend.c
endif
        
ORD_OBJ  = $(ORD_SRC:.c=.o) 

INC_SRC  := \
        ../C/macro.h \
        ../C/beta.h \
        ../C/define.h \
        ../C/constant.h \
	../C/heap.h \
        ../C/object.h \
        ../C/function.h \
        crun.h \
        IOAAlloc.h \
	../C/registers.h


ifeq ($(ARCH), sun4s)
INC_SRC := $(INC_SRC) ../C/sparcdep.h ../P/PException.h ../P/referenceTable.h
endif

ifeq ($(ARCH), hpux9pa)
INC_SRC := $(INC_SRC) ../C/snakedep.h
endif

ifeq ($(GNUC), yes)
ifeq ($(ARCH), sun4s) # can't use Werror on Solaris due to unint vars
CC_OPT	 := -Wall -pedantic $(CC_OPT) $(EXTRA_C_OPTIONS)
CC	 = gcc
CPP      = gcc -E -P $(CC_OPT)
else
CC_OPT	 := -Wall -pedantic -Werror $(CC_OPT)
CC	 = gcc
CPP      = gcc -E -P $(CC_OPT)
endif
endif

ifeq ($(ARCH), hpux9pa)
ASM_SRC = SnakeAdditions.S
ASM_OBJ = SnakeAdditions.o
# SnakeAdditions.S cannot be preprocessed by gcc */
CPP	 = cc -E -P $(CC_OPT)
endif

SOURCES  = $(ORD_SRC)
OBJFILES = $(ORD_OBJ) $(ASM_OBJ)

ifeq ($(ARCH), sun4s)
  INCLUDES = $(INC_SRC) ../C/sparcdep.h
else
ifeq ($(ARCH), hpux9pa)
  INCLUDES = $(INC_SRC) ../C/snakedep.h
else
  INCLUDES = $(INC_SRC)
endif
endif

ifeq ($(ARCH), sun4s)
CC_OPT := $(CC_OPT) -O6
endif

ifeq ($(RTDEBUG), yes)
CC_OPT := $(CC_OPT) -DRTDEBUG
endif

ifeq ($(CDEBUG), yes)
CC_OPT := $(CC_OPT) -g $(PROF)
else
ifeq ($(ARCH), sgi)
CC_OPT := $(CC_OPT) -O2 $(PROF)
else
CC_OPT := $(CC_OPT) -O6 $(PROF)
endif

endif

ifeq ($(VALHALLA), yes)
CC_OPT := $(CC_OPT) -DRTVALHALLA
endif

ifeq ($(UGC), yes)
CC_OPT := $(CC_OPT) -Ddo_unconditional_gc
endif

all: print_info c.run.o

c.run.o: $(OBJFILES) $(MAKEFILE)
ifeq ($(ARCH), hpux9pa)
	ld -r -o $@ $(OBJFILES)
else
#	touch $@ # no need to link - we use "ar -r" from top directory
endif

CC_OPT := $(CC_OPT) \
	 -I$(BETARUN)/CRUN \
	 -I$(BETARUN)/C \
	 -I$(BETARUN)/GC \
	 -I$(BETARUN)/P

$(ORD_OBJ): %o: %c $(INCLUDES) $(MAKEFILE)
	@$(ECHO) $(CC) -c ... $< $(ECHOEND)
	@$(CC) -c $(CC_OPT) -o $@ $<

print_info:
	@$(ECHON)        Compiling in: $(ECHONEND)
	@$(PWDCMD)
	@$(ECHON)        With command line: $(ECHONEND)
	@$(ECHO) $(CC) -c $(CC_OPT) -o file.o /path/to/file.c $(ECHOEND)


ifeq ($(ARCH), hpux9pa)
$(ASM_OBJ): $(ASM_SRC) $(INCLUDES) $(MAKEFILE)
	$(CPP) $< > $(@:.o=.s)
	/usr/local/gnu/bin/as -o $@ $(@:.o=.s)
endif

clean: 
	@-$(RM) $(OBJFILES) *~ *.s *.i *.gen *.o *.obj

srclist:
	@echo $(SOURCES) | tr -s " " "\012"

ifeq ($(ARCH), sun4s)
CheckGCable:
	-objdump -dr *.o | grep '%fp' | sh -c "grep -v 'add  -64, %fp, %sp'; exit 0"
CheckSave:
	-objdump -dr *.o | grep 'save' | sh -c "grep -v '%sp, -112, %sp'; exit 0"
endif
