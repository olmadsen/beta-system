# Making a profiling betarun:
#   setenv PROF -pg
#   build betarun(s) as usual
#   compile program with "beta -s 31 foo"
#   gprof foo gmon.out
#
# Likewise extra gdb debug info can be produced by 
#   setenv PROF "-g3 -ggdb"
# before building betarun_debug.a

RM = rm -f

#########  betarun.a  ########

betarun.a: C/c.common.o CRUN/c.run.o GC/c.gc.o P/c.p.o
	$(RM) betarun.a C/c.common.o CRUN/c.run.o GC/c.gc.o P/c.p.o
	ar -r betarun.a C/*.o GC/*.o CRUN/*.o P/*.o

C/c.common.o: ALWAYS
	cd C;  make -f Makefile-sun4s PROF="$(PROF)" PE=$(PE)

CRUN/c.run.o: ALWAYS
	cd CRUN; make -f Makefile-sun4s PROF="$(PROF)"

GC/c.gc.o: ALWAYS
	cd GC; make -f Makefile-sun4s PROF="$(PROF)" 

P/c.p.o: ALWAYS
	cd P; make -f Makefile-sun4s PROF="$(PROF)" 

######### betarun_v.a / betarun_pe.a #########

betarun_v.a: C/c.common.valhalla CRUN/c.run.valhalla GC/c.gc.valhalla P/c.p.valhalla
	$(RM) betarun_v.a C/c.common.valhalla CRUN/c.run.valhalla GC/c.gc.valhalla P/c.p.valhalla
	ar -r betarun_v.a C/*.o GC/*.o CRUN/*.o P/*.o

betarun_pe.a: C/c.common.valhalla CRUN/c.run.valhalla GC/c.gc.valhalla P/c.p.valhalla
	$(RM) betarun_pe.a C/c.common.valhalla CRUN/c.run.valhalla GC/c.gc.valhalla P/c.p.valhalla
	ar -r betarun_pe.a C/*.o GC/*.o CRUN/*.o P/*.o

C/c.common.valhalla: ALWAYS
	cd C;  make -f Makefile-sun4s valhalla PROF="$(PROF)" PE=$(PE)

CRUN/c.run.valhalla: ALWAYS
	cd CRUN; make -f Makefile-sun4s valhalla PROF="$(PROF)"

GC/c.gc.valhalla: ALWAYS
	cd GC; make -f Makefile-sun4s valhalla PROF="$(PROF)"

P/c.p.valhalla: ALWAYS
	cd P; make -f Makefile-sun4s valhalla PROF="$(PROF)"

valhalla: betarun_v.a

pe:
	$(RM) -f C/c.common.valhalla C/initialize.o
	PE="-DPE"; export PE; make -f Makefile-sun4s betarun_pe.a
	$(RM) -f C/c.common.valhalla C/initialize.o

######### betarun_mt.a  #########

betarun_mt.a: C/c.common.mt CRUN/c.run.mt GC/c.gc.mt P/c.p.mt
	$(RM) betarun_mt.a C/c.common.mt CRUN/c.run.mt GC/c.gc.mt P/c.p.mt betarun_mt.a
	ar -r betarun_mt.a C/*.o GC/*.o CRUN/*.o P/*.o
	
C/c.common.mt: ALWAYS
	cd C;  make -f Makefile-sun4s mt PROF="$(PROF)" PE=$(PE)

CRUN/c.run.mt: ALWAYS
	cd CRUN; make -f Makefile-sun4s mt PROF="$(PROF)"

GC/c.gc.mt: ALWAYS
	cd GC; make -f Makefile-sun4s mt PROF="$(PROF)"

P/c.p.mt: ALWAYS
	cd P; make -f Makefile-sun4s mt PROF="$(PROF)"

mt: betarun_mt.a

######### betarun_v_mt.a  #########

betarun_v_mt.a: C/c.common.v_mt CRUN/c.run.v_mt GC/c.gc.v_mt P/c.p.v_mt
	$(RM) betarun_v_mt.a C/c.common.v_mt CRUN/c.run.v_mt GC/c.gc.v_mt P/c.p.v_mt
	ar -r betarun_v_mt.a C/*.o GC/*.o CRUN/*.o P/*.o

C/c.common.v_mt: ALWAYS
	cd C;  make -f Makefile-sun4s v_mt PROF="$(PROF)" PE=$(PE)

CRUN/c.run.v_mt: ALWAYS
	cd CRUN; make -f Makefile-sun4s v_mt PROF="$(PROF)"

GC/c.gc.v_mt: ALWAYS
	cd GC; make -f Makefile-sun4s v_mt PROF="$(PROF)"

P/c.p.v_mt: ALWAYS
	cd P; make -f Makefile-sun4s v_mt PROF="$(PROF)"

v_mt: betarun_v_mt.a

######### betarun_debug_mt.a  #########

betarun_debug_mt.a: C/c.common.debug_mt CRUN/c.run.debug_mt GC/c.gc.debug_mt P/c.p.debug_mt
	$(RM) betarun_debug_mt.a C/c.common.debug_mt CRUN/c.run.debug_mt GC/c.gc.debug_mt P/c.p.debug_mt
	ar -r betarun_debug_mt.a C/*.o GC/*.o CRUN/*.o P/*.o

C/c.common.debug_mt: ALWAYS
	cd C;  make -f Makefile-sun4s debug_mt PROF="$(PROF)" PE=$(PE)

CRUN/c.run.debug_mt: ALWAYS
	cd CRUN; make -f Makefile-sun4s debug_mt PROF="$(PROF)"

GC/c.gc.debug_mt: ALWAYS
	cd GC; make -f Makefile-sun4s debug_mt PROF="$(PROF)"

P/c.p.debug_mt: ALWAYS
	cd P; make -f Makefile-sun4s debug_mt PROF="$(PROF)"

debug_mt: betarun_debug_mt.a

######### betarun_debug.a ##########

betarun_debug.a: C/c.common.debug GC/c.gc.debug P/c.p.debug CRUN/c.run.debug
	$(RM) betarun_debug.a C/c.common.debug GC/c.gc.debug P/c.p.debug CRUN/c.run.debug
	ar -r betarun_debug.a C/*.o GC/*.o CRUN/*.o P/*.o

C/c.common.debug: ALWAYS
	cd C; make -f Makefile-sun4s debug PROF="$(PROF)"

CRUN/c.run.debug: ALWAYS
	cd CRUN; make -f Makefile-sun4s debug PROF="$(PROF)" 

GC/c.gc.debug: ALWAYS
	cd GC; make -f Makefile-sun4s debug PROF="$(PROF)"

P/c.p.debug: ALWAYS
	cd P; make -f Makefile-sun4s debug PROF="$(PROF)"

debug: betarun_debug.a

######### betarun_ugc.a (variant of betarun_debug.a) ##########

betarun_ugc.a: C/c.common.ugc GC/c.gc.ugc P/c.p.ugc CRUN/c.run.ugc
	$(RM) betarun_ugc.a C/c.common.debug GC/c.gc.debug P/c.p.debug CRUN/c.run.debug
	ar -r betarun_ugc.a C/*.o GC/*.o CRUN/*.o P/*.o

C/c.common.ugc: ALWAYS
	cd C; make -f Makefile-sun4s debug PROF="-Ddo_unconditional_gc $(PROF)"

CRUN/c.run.ugc: ALWAYS
	cd CRUN; make -f Makefile-sun4s debug PROF="-Ddo_unconditional_gc $(PROF)" 

GC/c.gc.ugc: ALWAYS
	cd GC; make -f Makefile-sun4s debug PROF="-Ddo_unconditional_gc $(PROF)"

P/c.p.ugc: ALWAYS
	cd P; make -f Makefile-sun4s debug PROF="-Ddo_unconditional_gc $(PROF)"

ugc: betarun_ugc.a

######### betarun_try.a (variant of betarun_debug.a) ##########

betarun_try.a: C/c.common.try GC/c.gc.try P/c.p.try CRUN/c.run.try
	$(RM) betarun_try.a C/c.common.debug GC/c.gc.debug P/c.p.debug CRUN/c.run.debug
	ar -r betarun_try.a C/*.o GC/*.o CRUN/*.o P/*.o

C/c.common.try: ALWAYS
	cd C; make -f Makefile-sun4s debug PROF="-DBETAENV_RUNTIME_HANDLER $(PROF)"

CRUN/c.run.try: ALWAYS
	cd CRUN; make -f Makefile-sun4s debug PROF="-DBETAENV_RUNTIME_HANDLER $(PROF)" 

GC/c.gc.try: ALWAYS
	cd GC; make -f Makefile-sun4s debug PROF="-DBETAENV_RUNTIME_HANDLER $(PROF)"

P/c.p.try: ALWAYS
	cd P; make -f Makefile-sun4s debug PROF="-DBETAENV_RUNTIME_HANDLER $(PROF)"

try: betarun_try.a

########## All ###########

all:
	make -f Makefile-sun4s clean
	make -f Makefile-sun4s
	make -f Makefile-sun4s save-check
#
	make -f Makefile-sun4s clean
	make -f Makefile-sun4s valhalla
	make -f Makefile-sun4s save-check
#	make -f Makefile-sun4s pe
#
#	make -f Makefile-sun4s all_mt
#
	make -f Makefile-sun4s clean
	make -f Makefile-sun4s ugc
	make -f Makefile-sun4s save-check

	make -f Makefile-sun4s clean
	make -f Makefile-sun4s debug
	make -f Makefile-sun4s save-check

all_mt:
	make -f Makefile-sun4s clean
	make -f Makefile-sun4s mt
#
	make -f Makefile-sun4s clean
	make -f Makefile-sun4s v_mt
#
	make -f Makefile-sun4s clean
	make -f Makefile-sun4s debug_mt

########## Misc ##########

tags:
	etags GC/*.[hc] P/*.[hc] CRUN/*.[hc] C/*.[hc] C/data.gen Makefile-* C/Makefile-* GC/Makefile-* P/Makefile-* CRUN/Makefile-*

clean: ALWAYS
	-/bin/rm -f *~
	-/bin/rm -f C/xmakefile GC/xmakefile P/xmakefile NEWRUN/xmakefile CRUN/xmakefile
	cd C; make -f Makefile-sun4s clean
	cd CRUN; make -f Makefile-sun4s clean
	cd GC; make -f Makefile-sun4s clean
	cd P; make -f Makefile-sun4s clean
	sh -c 'if [ -d TST ]; then cd TST; make clean; fi'

commit:
	cvscom

com:
	cvscom

fp-check: 
	@echo Checking stack \(%fp\) usage in allocation routines \(CRUN\).
	@echo Should report no lines:
	-@cd CRUN; make -f Makefile-sun4s fp-check
save-check: 
	@echo Checking non-standard frames in allocation routines \(CRUN\).
	@echo Should report no lines:
	-@cd CRUN; make -f Makefile-sun4s save-check

ALWAYS:
	@echo ""
