# Top level makefile for making BETA runtime.  This makefile 
# is designed to be used by the mbs_make script using the vpath
# feature.

# This makefile requires GNU make or compatible.  If your make
# program barfs on it then that may be the problem.  Set your
# GNUMAKE variable and try again.

# (c) 2000,2001 Mjølner Informatics
# by Erik Corry

export ARCH
export BETALIB
export BETARUN
export RUNTYPE
export PROF
export GNUC
export RM
export MV
export CP
export BETARUN_SUFFIX
export EXE
export ECHO
export ECHON
export ECHOEND
export ECHONEND
export PWDCMD

VPATH=$(BETARUN)

ifeq ($(ARCH), nti_gnu)
    # No echo command on DOS
    ECHO=perl -e 'print "
    ECHON=perl -e 'print "
    ECHOEND=\n";'
    ECHONEND=";'
    PWDCMD=perl -e 'use Cwd; print cwd . "\n";'
else
    ifeq ($(ARCH), nti_ms)
	# No echo command on DOS
	ECHO=perl -e 'print "
	ECHON=perl -e 'print "
	ECHOEND=\n";'
	ECHONEND=";'
	PWDCMD=perl -e 'use Cwd; print cwd . "\n";'
    else
	# Echo is faster on Unix
	ECHO=echo 
	ECHON=echo -n 
	ECHOEND=| fmt -t -w 78
	ECHONEND=
	PWDCMD=pwd
	#ECHO=perl -e 'print "
	#ECHON=perl -e 'print "
	#ECHOEND=\n";'
	#ECHONEND=";'
    endif
endif

ifeq ($(ARCH), nti_gnu)
CP=copy
MV=rename
RM=delete
EXE=.exe
else
ifeq ($(ARCH), nti_ms)
CP=copy
MV=rename
RM=delete
EXE=.exe
else
CP=cp
MV=mv
RM=rm -f
EXE=
endif
endif

ifeq ($(ARCH), nti_ms)
  BETARUN_SUFFIX=lib
else
  ifeq ($(ARCH), sun4s)
    BETARUN_SUFFIX=a
  else
    BETARUN_SUFFIX=o
  endif
endif

all: nodebug debug nodebug_g novalhalla ugc

clean: nodebug_clean debug_clean debug_g_clean
	$(RM) *.a *.o


# Normal betarun, which includes hooks for BETA debugging

nodebug::
	@mbs_mkdir nodebug
	(cd nodebug; $(MAKE) VARIANT=$@ UGC=no VALHALLA=yes RTDEBUG=no CDEBUG=no -f $(BETARUN)/Makefile-vpath)
	@mbs_mkdir $(BETALIB)/betarun
	@mbs_mkdir $(BETALIB)/betarun/$(ARCH)
	$(CP) nodebug/betarun.$(BETARUN_SUFFIX) $(BETALIB)/betarun/$(ARCH)/betarun_v.$(BETARUN_SUFFIX)

nodebug_clean::
	@mbs_mkdir nodebug
	@(cd nodebug; $(MAKE) VARIANT=$@ -f $(BETARUN)/Makefile-vpath clean)

# Debugging betarun, which is very slow

debug::
	@mbs_mkdir debug
	@(cd debug; $(MAKE) VARIANT=$@ UGC=no VALHALLA=yes RTDEBUG=yes CDEBUG=yes -f $(BETARUN)/Makefile-vpath)
	@mbs_mkdir $(BETALIB)/betarun
	@mbs_mkdir $(BETALIB)/betarun/$(ARCH)
	$(CP) debug/betarun.$(BETARUN_SUFFIX) $(BETALIB)/betarun/$(ARCH)/betarun_debug.$(BETARUN_SUFFIX)

debug_clean::
	@mbs_mkdir debug
	@(cd debug; $(MAKE) VARIANT=$@ -f $(BETARUN)/Makefile-vpath clean)

# Debugging betarun, which is very slow, with unconditional GC

ugc::
	@mbs_mkdir ugc
	@(cd ugc; $(MAKE) VARIANT=$@ UGC=yes VALHALLA=yes RTDEBUG=yes CDEBUG=yes -f $(BETARUN)/Makefile-vpath)
	@mbs_mkdir $(BETALIB)/betarun
	@mbs_mkdir $(BETALIB)/betarun/$(ARCH)
	$(CP) ugc/betarun.$(BETARUN_SUFFIX) $(BETALIB)/betarun/$(ARCH)/betarun_ugc.$(BETARUN_SUFFIX)

ugc_clean::
	@mbs_mkdir ugc
	@(cd ugc; $(MAKE) VARIANT=$@ -f $(BETARUN)/Makefile-vpath clean)

# Nondebugging betarun, which is fast but has symbols for C debugger

nodebug_g::
	@mbs_mkdir nodebug_g
	@(cd nodebug_g; $(MAKE) VARIANT=$@ UGC=no VALHALLA=yes RTDEBUG=no CDEBUG=yes -f $(BETARUN)/Makefile-vpath)
	@mbs_mkdir $(BETALIB)/betarun
	@mbs_mkdir $(BETALIB)/betarun/$(ARCH)
	$(CP) nodebug_g/betarun.$(BETARUN_SUFFIX) $(BETALIB)/betarun/$(ARCH)/betarun_sym.$(BETARUN_SUFFIX)

nodebug_g_clean::
	@mbs_mkdir nodebug_g
	@(cd nodebug_g; $(MAKE) VARIANT=$@ -f $(BETARUN)/Makefile-vpath clean)

# Nondebugging betarun, no symbols for C debugger, no valhalla support

novalhalla::
	@mbs_mkdir novalhalla
	@(cd novalhalla; $(MAKE) VARIANT=$@ UGC=no VALHALLA=no RTDEBUG=no CDEBUG=no -f $(BETARUN)/Makefile-vpath)
	@mbs_mkdir $(BETALIB)/betarun
	@mbs_mkdir $(BETALIB)/betarun/$(ARCH)
	$(CP) nodebug_g/betarun.$(BETARUN_SUFFIX) $(BETALIB)/betarun/$(ARCH)/betarun.$(BETARUN_SUFFIX)

novalhalla_clean::
	@mbs_mkdir novalhalla
	@(cd novalhalla; $(MAKE) VARIANT=$@ -f $(BETARUN)/Makefile-vpath clean)
