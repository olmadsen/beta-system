# Top level makefile for making BETA runtime.  This makefile 
# is designed to be used by the mbs_make script using the vpath
# feature.

# This makefile requires GNU make or compatible.  If your make
# program barfs on it then that may be the problem.  Set your
# GNUMAKE variable and try again.

export ARCH
export BETALIB
export BETARUN
export RUNTYPE
export PROF
export GNUC

VPATH=$(BETARUN)

ifeq ($(ARCH), nti_gnu)
CP=copy
else
ifeq ($(ARCH), nti_ms)
CP=copy
else
CP=cp
endif
endif

ifeq ($(ARCH), nti_ms)
BETARUN_SUFFIX=lib
else
ifeq ($(ARCH), sun4s)
BETARUN_SUFFIX=a
else
BETARUN_SUFFIX=o
endif
endif

all: nodebug debug nodebug_g novalhalla # ugc

clean: nodebug_clean debug_clean debug_g_clean
	rm *.a *.o

# Normal betarun, which includes hooks for BETA debugging

nodebug::
	@mbs_mkdir nodebug
	(cd nodebug; $(MAKE) VARIANT=$@ UGC=no VALHALLA=yes RTDEBUG=no CDEBUG=no -f $(BETARUN)/Makefile-vpath)
	@mbs_mkdir $(BETALIB)/betarun
	@mbs_mkdir $(BETALIB)/betarun/linux
	$(CP) nodebug/betarun.$(BETARUN_SUFFIX) $(BETALIB)/betarun/linux/betarun_v.$(BETARUN_SUFFIX)

nodebug_clean::
	@mbs_mkdir nodebug
	@(cd nodebug; $(MAKE) VARIANT=$@ -f $(BETARUN)/Makefile-vpath clean)

# Debugging betarun, which is very slow

debug::
	@mbs_mkdir debug
	@(cd debug; $(MAKE) VARIANT=$@ UGC=no VALHALLA=yes RTDEBUG=yes CDEBUG=yes -f $(BETARUN)/Makefile-vpath)
	@mbs_mkdir $(BETALIB)/betarun
	@mbs_mkdir $(BETALIB)/betarun/linux
	$(CP) debug/betarun.$(BETARUN_SUFFIX) $(BETALIB)/betarun/linux/betarun_debug.$(BETARUN_SUFFIX)

debug_clean::
	@mbs_mkdir debug
	@(cd debug; $(MAKE) VARIANT=$@ -f $(BETARUN)/Makefile-vpath clean)

# Debugging betarun, which is very slow, with uconditional GC

ugc::
	@mbs_mkdir ugc
	@(cd ugc; $(MAKE) VARIANT=$@ UGC=yes VALHALLA=yes RTDEBUG=yes CDEBUG=yes -f $(BETARUN)/Makefile-vpath)
	@mbs_mkdir $(BETALIB)/betarun
	@mbs_mkdir $(BETALIB)/betarun/linux
	$(CP) ugc/betarun.$(BETARUN_SUFFIX) $(BETALIB)/betarun/linux/betarun_ugc.$(BETARUN_SUFFIX)

ugc_clean::
	@mbs_mkdir ugc
	@(cd ugc; $(MAKE) VARIANT=$@ -f $(BETARUN)/Makefile-vpath clean)

# Nondebugging betarun, which is fast but has symbols for C debugger

nodebug_g::
	@mbs_mkdir nodebug_g
	@(cd nodebug_g; $(MAKE) VARIANT=$@ UGC=no VALHALLA=yes RTDEBUG=no CDEBUG=yes -f $(BETARUN)/Makefile-vpath)
	@mbs_mkdir $(BETALIB)/betarun
	@mbs_mkdir $(BETALIB)/betarun/linux
	$(CP) nodebug_g/betarun.$(BETARUN_SUFFIX) $(BETALIB)/betarun/linux/betarun_sym.$(BETARUN_SUFFIX)

nodebug_g_clean::
	@mbs_mkdir nodebug_g
	@(cd nodebug_g; $(MAKE) VARIANT=$@ -f $(BETARUN)/Makefile-vpath clean)

# Nondebugging betarun, no symbols for C debugger, no valhalla support

novalhalla::
	@mbs_mkdir novalhalla
	@(cd novalhalla; $(MAKE) VARIANT=$@ UGC=no VALHALLA=no RTDEBUG=no CDEBUG=no -f $(BETARUN)/Makefile-vpath)
	@mbs_mkdir $(BETALIB)/betarun
	@mbs_mkdir $(BETALIB)/betarun/linux
	$(CP) nodebug_g/betarun.$(BETARUN_SUFFIX) $(BETALIB)/betarun/linux/betarun.$(BETARUN_SUFFIX)

novalhalla_clean::
	@mbs_mkdir novalhalla
	@(cd novalhalla; $(MAKE) VARIANT=$@ -f $(BETARUN)/Makefile-vpath clean)
