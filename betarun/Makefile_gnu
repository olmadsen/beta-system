RUNDEPS= \
..\GEN\nti\gen.exe \
RUN/AllocateComponent.run \
RUN/AllocateDopartObject.run \
RUN/AllocateItem.run \
RUN/AllocateRefRep.run \
RUN/AllocateStackObject.run \
RUN/AllocateValRep.run \
RUN/Attach.run \
RUN/AttachBasicComponent.run \
RUN/Basics.run \
RUN/CInterface.run \
RUN/CheckReferenceAssignment.run \
RUN/ComponentStack.run \
RUN/Constant.run \
RUN/CopyCText.run \
RUN/CopyRefRep.run \
RUN/CopySliceRefRep.run \
RUN/CopySliceValRep.run \
RUN/CopyText.run \
RUN/CopyValRep.run \
RUN/DataRegs.run \
RUN/Declaration.run \
RUN/ExitObjects.run \
RUN/ExtendRefRep.run \
RUN/ExtendValRep.run \
RUN/MakeTextObj.run \
RUN/Misc.run \
RUN/NewRefRep.run \
RUN/NewValRep.run \
RUN/PerformGC.run \
RUN/Structure.run \
RUN/Qua.run \
RUN/Suspend.run

gnu/betarun_pe.lib:
	make -f Makefile_gnu common \
	"CURRENT_OBJ := $@"

gnu/betarun.lib:
	make -f Makefile_gnu common \
	"CURRENT_OBJ := $@"

gnu/betarun_v.lib:
	make -f Makefile_gnu common \
	"CURRENT_OBJ := $@"

gnu/betarun_debug.lib:
	make -f Makefile_gnu debugpart \
	"CURRENT_OBJ := $@"

common: nti.o
	cd C; $(MAKE) -f Makefile_gnu $(CURRENT_OBJ)
	cd GC; $(MAKE) -f Makefile_gnu $(CURRENT_OBJ)
	-mkdir gnu
	ar -r $(CURRENT_OBJ) C/*.o GC/*.o nti.o

debugpart: ntidebug.o
	cd C; $(MAKE) -f Makefile_gnu clean $(CURRENT_OBJ)
	cd GC; $(MAKE) -f Makefile_gnu clean $(CURRENT_OBJ)
	-mkdir gnu
	ar -r $(CURRENT_OBJ) C/*.o GC/*.o ntidebug.o

nti.o: nti.asm
	ml /c /coff /Cp /nologo /w /Fonti.o /Tanti.asm

ntidebug.o: ntidebug.asm
	ml /Zi /c /coff /Cp /nologo /w /Fontidebug.o /Tantidebug.asm

nti.asm: RUN/nti.run RUN/ntiadditions.run $(RUNDEPS)
	- ../GEN/nti/gen -o nti.asm RUN/nti

ntidebug.asm: RUN/nti.run RUN/ntiadditions.run $(RUNDEPS)
	- ../GEN/nti/gen -debug -o ntidebug.asm RUN/nti

gen:
	cd ..\GEN\nti 
	make
	cd ..\..\nti

all:
	rm -rf gnu/
	make -f Makefile_gnu clean
	make -f Makefile_gnu gnu/betarun_pe.lib
	make -f Makefile_gnu clean
	make -f Makefile_gnu gnu/betarun.lib
	make -f Makefile_gnu clean
	make -f Makefile_gnu gnu/betarun_v.lib
	make -f Makefile_gnu clean
	make -f Makefile_gnu gnu/betarun_debug.lib
#	make -f Makefile_gnu clean

tags:
	etags RUN/*.run GC/*.[hc] C/*.[hc] C/data.gen

check:
	@echo generating list of undefined labels
	@nm betarun.o | grep ' U ' > .new-undefined
	@echo find difference between .old-undefined and .new-undefined
	@diff .old-undefined .new-undefined

gendef:
	@echo generating list of undefined labels
	@nm betarun.o | grep ' U ' > .old-undefined

clean: 
	cd C; make -f Makefile_gnu clean MAIN=dummy
	cd GC; make -f Makefile_gnu clean MAIN=dummy
	- rm -f *.group *.lst core *~ \#* nti* *.dump
	- rm -f RUN/*.group RUN/*~ RUN/*.lst RUN/core
#	sh -c 'if [ -d TST ]; then cd TST; make -f Makefile_gnu clean; fi'
