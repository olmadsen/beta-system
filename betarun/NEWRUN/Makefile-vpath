#
#  BETA C RUNTIME SYSTEM, Copyright (C) 1990,91,92,2000,01 Mjolner Informatics A/S
#  by Peter Andersen and Tommy Thorn.
#
# Heavily modified by Erik Corry

all:  print_info c.run.o

vpath %.h $(BETARUN)/NEWRUN
vpath %.c $(BETARUN)/NEWRUN
vpath %.h $(BETARUN)/C
vpath %.h $(BETARUN)/P
vpath %.gen $(BETARUN)/C
vpath %.h $(BETARUN)/GC
vpath %.c $(BETARUN)/GC

MAKEFILE = $(BETARUN)/NEWRUN/Makefile-vpath

ORD_SRC  = \
	AllocateComponent.c \
	AllocateItem.c  \
	AllocateValRep.c \
	AllocateObjectRep.c \
	AllocateRefRep.c \
	AllocateStackObject.c \
	AllocateDopartObject.c \
	CInterface.c \
	CopyCtext.c \
	CopySliceRefRep.c \
	CopySliceValRep.c \
	CopyText.c \
	CopyValRep.c \
	CopyRefRep.c  \
	ExtendRefRep.c \
	ExtendValRep.c \
	NewRefRep.c \
	NewValRep.c  \
	Structure.c \
	Misc.c \
	COM.c \
	CheckReferenceAssignment.c \
	MakeTextObj.c \
	Qua.c \
	PerformGC.c \
	CallBack.c \
	ExitObjects.c \
	Attach.c \
	Suspend.c \
	Main.c

ORD_OBJ  = $(ORD_SRC:.c=.$(DOTO)) 

INC_SRC  = ../C/macro.h ../C/beta.h ../C/define.h ../C/constant.h \
           ../C/heap.h ../C/object.h ../C/function.h ../C/data.h \
           crun.h IOAAlloc.h

ifeq ($(GNUC), yes)
CC	 = gcc-2.5.8
CC_OPT	 := -Wall $(CC_OPT)
CPP      = gcc-2.5.8 -E -P $(CC_OPT)
endif

ifeq ($(ARCH), macosx)
  CC          =  cc  # but it's really gcc
  CC_OPT      := $(CC_OPT) -D$(ARCH)
  OPTIMISEOPT := -O2
  CPP         = cc -E -P $(CC_OPT)
endif

ifeq ($(ARCH), sgi)
CC	= cc
CC_OPT	:= $(ABI) $(CC_OPT)
CPP	= cc -E -P $(CC_OPT)
endif

ifeq ($(ARCH), hpux9pa)
CC	 = gcc-2.5.8
CC_OPT	 := -Wall $(CC_OPT)
CPP      = cc -E $(CC_OPT)
ASM_SRC = SnakeAdditions.S
ASM_OBJ = SnakeAdditions.o
endif

SOURCES  = $(ORD_SRC)
OBJFILES = $(ORD_OBJ) $(ASM_OBJ)

ifeq ($(ARCH), sun4s)
  INCLUDES = $(INC_SRC) ../C/sparcdep.h
endif
ifeq ($(ARCH), hpux9pa)
  INCLUDES = $(INC_SRC) ../C/snakedep.h
endif
ifeq ($(ARCH), crts)       # ?????????
  INCLUDES = $(INC_SRC) ../C/crtsdep.h
else
  INCLUDES = $(INC_SRC)
endif

CC_OPT  := $(CC_OPT) -I$(BETARUN)/C -I$(BETARUN)/P -I$(BETARUN)/GC $(EXTRA_C_OPTIONS)

ifeq ($(RTDEBUG), yes)
CC_OPT := $(CC_OPT) -DRTDEBUG
endif

ifeq ($(ALLOC_TRACE), yes)
  CC_OPT := $(CC_OPT) -DALLOC_TRACE
endif

ifeq ($(CDEBUG), yes)
CC_OPT := $(CC_OPT) $(DEBUGOPT) $(PROF)
else
CC_OPT := $(CC_OPT) $(OPTIMISEOPT) $(PROF)
endif

ifeq ($(VALHALLA), yes)
CC_OPT := $(CC_OPT) -DRTVALHALLA
endif

ifeq ($(UGC), yes)
CC_OPT := $(CC_OPT) -Ddo_unconditional_gc
endif

c.run.o: $(OBJFILES) $(MAKEFILE)
ifeq ($(ARCH), macintosh)
	lib -o $@ $(OBJFILES)
else
ifeq ($(ARCH), sgi)
	ld $(ABI) -r -o $@ $(OBJFILES)
else
	ld -r -o $@ $(OBJFILES)
endif
endif

$(ORD_OBJ): %o: %c $(INCLUDES) $(MAKEFILE)
	@$(ECHO) $(CC) ... -c $< $(ECHOEND)
	@$(CC) $(CC_OPT) -c -o $@ $<

print_info:
	@$(ECHO) '' $(ECHOEND)
	@$(ECHON)    '   Compiling in: ' $(ECHONEND)
	@$(PWDCMD)
	@$(ECHON)    '   With command line: ' $(ECHONEND)
	@$(ECHO) $(CC) $(CC_OPT) -c -o file.$(DOTO) /path/to/file.c $(ECHOEND)
	@$(ECHO) '' $(ECHOEND)

ifeq ($(ARCH), hpux9pa)
$(ASM_OBJ): $(ASM_SRC) $(INCLUDES) $(MAKEFILE)
	$(CPP) $(@:.o=.S) > $(@:.o=.s)
	gas -o $@ $(@:.o=.s)
endif

clean: 
	-@$(RM) $(OBJFILES) *~ *.s *.i *.o *.obj *.gen

srclist:
	@echo $(SOURCES) | tr -s " " "\012"

CheckGCable:
	echo only SPARC !!
	gcc2 -S -O3 -I$(BETARUN)/C -DLVR_Area -DAO_Area -DRTINFO $(SOURCES)
	grep '%fp' *.s|grep -v 'add %fp,-64,%sp'
