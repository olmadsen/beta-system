/*
 * BETA RUNTIME SYSTEM, Copyright (C) 1991 Mjolner Informatics Aps.
 * ymakefile-C
 * by Lars Bak
 */
MAKEFILE = Makefile

#include "define.h"

/* datpete:
 * After having fixed sparc stack layout to match gcc, none of the
 * files in the C directory need be compiled with optimization in
 * debug versions of RTS anymore.
 */

/* ORD_SRC_OPTA must not be empty - otherwise SGI complains */
ORD_SRC_OPTA  = betaerror.c property.c initialize.c betaenv.c argument.c \
		group.c exit.c cbfa.c floats.c multithread.c \
		sighandler.c dot.c sockets.c outpattern.c \
		valhallaComm.c valhallaFindComp.c valhallaSOCKETS.c \
		lazyref_gc.c scanobjects.c labelnametable.c 

ORD_SRC_OPTB  = heapview.c 

GEN_SRC  = data.gen export.h declare.h

#ifdef sparc
INC_SRC  = macro.h beta.h define.h constant.h heap.h object.h function.h valhallaComm.h valhallaFindComp.h valhallaSOCKETS.h sparcdep.h registers.h dot.h
#endif

#ifdef hppa
INC_SRC  = macro.h beta.h define.h constant.h heap.h object.h function.h valhallaComm.h valhallaFindComp.h valhallaSOCKETS.h snakedep.h registers.h dot.h
#endif

#if ((!defined(sparc)) && (!defined(hppa)))
INC_SRC  = macro.h beta.h define.h constant.h heap.h object.h function.h valhallaComm.h valhallaFindComp.h valhallaSOCKETS.h registers.h dot.h
#endif

SOURCES_OPTA  = $(Makefile) $(ORD_SRC_OPTA) $(GEN_SRC) $(INC_SRC)
OBJFILES_OPTA  = $(ORD_SRC_OPTA:.c=.o)

SOURCES_OPTB  = $(Makefile) $(ORD_SRC_OPTB) $(GEN_SRC) $(INC_SRC)
OBJFILES_OPTB  =  data.o $(ORD_SRC_OPTB:.c=.o)

#ifdef sgi
CC	= cc $(ABI) 
CPP	= cc -E $(C_FLAGS)
#endif

#ifdef __GNUC__
  #if defined(nti_gnu) || defined(linux)
    CC	 = gcc -Wall -pedantic
  #else
    CC	 = gcc -Wall -Werror -pedantic
  #endif
  CPP      = gcc -E -P $(C_FLAGS)
#endif

INCLUDES = $(INC_SRC)

CC_OPTA  = $(C_OPTA) $(C_FLAGS)
CC_OPTB  = $(C_OPTB) $(C_FLAGS)

#ifdef nti_gnu
all: $(OBJFILES_OPTA) $(OBJFILES_OPTB)
#else
$(MAIN): $(OBJFILES_OPTA) $(OBJFILES_OPTB)
#endif
#ifdef sgi
	ld $(ABI) -r -o $@ $(OBJFILES_OPTA) $(OBJFILES_OPTB)
#else
#ifdef sun4s
	touch $@ /* no need to link - we use "ar -r" from top directory */
#else
# ifndef nti_gnu
	ld -r -o $@ $(OBJFILES_OPTA) $(OBJFILES_OPTB)
# endif /* nti_gnu */
#endif
#endif

/*
 * The new make (version 3.77) that ships with mingw32 version 2.95.2
 * is very allergic to double quotes (").  Since it would compilcate the
 * build process even more to start insisting on specific versions of make
 * we do a little perl hackery (thanks LBR) to avoid this terrible character
 * qq(text) is the same as "text" and 34 is the ASCII code for the double quote
 */

data.c: data.gen declare.h
	@echo 'generating data.c'
	@perl -e 'printf qq(#include %cdefine.h%c\n), 34, 34'   > data.c
	@echo '#include <stdio.h>'   >> data.c
	@perl -e 'printf qq(#include %cheap.h%c\n), 34, 34'    >> data.c
	@perl -e 'printf qq(#include %cmacro.h%c\n), 34, 34'   >> data.c
	@echo '#ifdef MT'            >> data.c
	@echo '#include <thread.h>' >> data.c
	@echo '#endif'               >> data.c
	@cat declare.h data.gen > tmpdata.c
	@$(CPP) tmpdata.c | sed -n -e '/^..*$$/p' >> data.c
	@rm -f tmpdata.c
	@echo done

data.h: data.gen data.c export.h
	@echo 'generating data.h'
	@cat export.h data.gen > tmpdata.c
	@$(CPP) tmpdata.c | sed -n -e '/^..*$$/p' > data.h
	@rm -f tmpdata.c
	@echo done

scramble: scramble.c
	$(CC) -o scramble scramble.c

#ifdef linux
/* Using gmake, .o.c deps cannot be specified as in old make style */
$(OBJFILES_OPTA): %.o: %.c data.c data.h $(INCLUDES) $(GEN_SRC)
	$(CC) -c $(CC_OPTA) $(@:.o=.c)
$(OBJFILES_OPTB): %.o: %.c data.c data.h $(INCLUDES) $(GEN_SRC)
	$(CC) -c $(CC_OPTB) $(@:.o=.c)
#else
#ifdef sgi
$(OBJFILES_OPTA): $(@:.o=.c) data.c data.h $(INCLUDES) $(GEN_SRC)
	$(CC) -c $(CC_OPTA) $(@:.o=.c)
$(OBJFILES_OPTB): $(@:.o=.c) data.c data.h $(INCLUDES) $(GEN_SRC)
	$(CC) -c $(CC_OPTB) $(@:.o=.c)
#else /* not sgi */
$(OBJFILES_OPTA): $($@:.o=.c) data.c data.h $(INCLUDES) $(GEN_SRC)
	$(CC) -c $(CC_OPTA) $(@:.o=.c)
$(OBJFILES_OPTB): $($@:.o=.c) data.c data.h $(INCLUDES) $(GEN_SRC)
	$(CC) -c $(CC_OPTB) $(@:.o=.c)
#endif /* sgi */
#endif /* linux */

clean: 
	@-rm -f $(OBJFILES_OPTA) $(OBJFILES_OPTB) *~ *.s *.i; touch data.gen

srclist:
	@echo $(SOURCES_OPTA) $(SOURCES_OPTB) | tr -s " " "\012"
