/*
 * BETA RUNTIME SYSTEM, Copyright (C) 1991 Mjolner Informatics Aps.
 * Mod: $RCSfile: ymakefile-C,v $, rel: %R%, date: $Date: 1992-08-24 15:30:04 $, SID: $Revision: 1.13 $
 * by Lars Bak
 */
MAKEFILE = Makefile

ORD_SRC  = initialize.c betaenv.c outpattern.c argument.c property.c \
           exit.c cbfa.c

#ifdef sun
#  ifndef sparc
#    define sun3
#  endif
#endif

#ifdef sun3
EXT_SRC  =  stat.c sighandler.c dumper.c
#else
#ifndef macintosh
EXT_SRC  =  sighandler.c dumper.c
#endif
#endif

GEN_SRC  = data.gen export.h declare.h
INC_SRC  = macro.h beta.h define.h constant.h heap.h object.h \
 function.h sparcdep.h

RST_SRC  =

ORD_OBJ  = $(ORD_SRC:.c=.o) data.o
EXT_OBJ  = $(EXT_SRC:.c=.o)

SOURCES  = $(Makefile) $(ORD_SRC) $(EXT_SRC) $(GEN_SRC) $(INC_SRC)
OBJFILES = $(ORD_OBJ) $(EXT_OBJ)

#ifdef hpux
CC       = cc
CPP      = /lib/cpp -P $(C_FLAGS)
#endif

#ifdef sun3
CC       = cc
CPP      = /usr/lib/cpp -P $(C_FLAGS)
#endif

#ifdef sparc
CC       = gcc2 -O3
CPP      = /usr/lib/cpp -P $(C_FLAGS)
#endif

#ifdef apollo
CC       = cc
CPP      = /usr/lib/cpp -P $(C_FLAGS)
#endif

#ifdef macintosh
CC       = C
CPP      = /lib/cpp -P -Dmacintosh $(CPP_FLAGS)
#endif

INCLUDES = $(INC_SRC) data.h

CC_OPT  = $(C_OPT) $(C_FLAGS)

$(MAIN): $(OBJFILES)
#ifdef macintosh
	lib -o $@ $(OBJFILES)
#else
	ld -r -o $@ $(OBJFILES)
#endif

data.c: data.gen declare.h
	@echo 'generating data.c'
	@echo '#include <stdio.h>'	>  data.c
	@echo '#include "heap.h"'	>> data.c
	@echo '#include "macro.h"'	>> data.c
	cat declare.h data.gen | $(CPP) |\
	sed -n -e '/^..*$$/p'		>> data.c

data.h: data.gen export.h
	@echo 'generating data.h'
	cat export.h data.gen | $(CPP) |\
	sed -n -e '/^..*$$/p'		>  data.h

$(ORD_OBJ) $(EXT_OBJ): $($@:.o=.c) $(INCLUDES) $(GEN_SRC) $(RST_SRC)
#ifdef macintosh
	$(CC) -o $@ $(CC_OPT) $(@:.o=.c)
#else
	$(CC) -c $(CC_OPT) $(@:.o=.c)
#endif

#$(SOURCES):
#	sccs get $@

clean: 
#	sccs clean
	-rm -f data.h data.c $(OBJFILES) *~

srclist:
	@echo $(SOURCES) | tr -s " " "\012"
