/*
 * BETA RUNTIME SYSTEM, Copyright (C) 1991 Mjolner Informatics Aps.
 * ymakefile-C
 * by Lars Bak
 */
MAKEFILE = Makefile

#include "define.h"

ORD_SRC  = property.c initialize.c betaenv.c outpattern.c argument.c \
           group.c exit.c cbfa.c wordsort.c floats.c multithread.c \
	   dot.c valhallaComm.c valhallaFindComp.c valhallaSOCKETS.c \
           lazyref_gc.c scanobjects.c heapview.c

#ifdef sun
#  ifndef sparc
#    define sun3
#  endif
#endif

#ifdef sun3
EXT_SRC  =  stat.c sighandler.c
#else
#ifndef macintosh
EXT_SRC  =  sighandler.c
#endif
#endif

GEN_SRC  = data.gen export.h declare.h

#ifdef sparc
INC_SRC  = macro.h beta.h define.h constant.h heap.h object.h function.h valhallaComm.h valhallaFindComp.h valhallaSOCKETS.h sparcdep.h registers.h
#endif

#ifdef hppa
INC_SRC  = macro.h beta.h define.h constant.h heap.h object.h function.h valhallaComm.h valhallaFindComp.h valhallaSOCKETS.h snakedep.h registers.h
#endif

#if ((!defined(sparc)) && (!defined(hppa)))
INC_SRC  = macro.h beta.h define.h constant.h heap.h object.h function.h valhallaComm.h valhallaFindComp.h valhallaSOCKETS.h registers.h
#endif

SOURCES  = $(Makefile) $(ORD_SRC) $(EXT_SRC) $(GEN_SRC) $(INC_SRC)
OBJFILES  = $(ORD_SRC:.c=.o) $(EXT_SRC:.c=.o) data.o

#ifdef sgi
CC	= cc
CPP	= cc -E -P $(C_FLAGS)
#endif

#ifdef __GNUC__
#if defined(__svr4__) /* solaris */ || defined(linux) || defined(hppa)
CC	 = gcc -Wall -pedantic
CPP      = gcc -E -P $(C_FLAGS)
#else
/* sun4, hpux9mc */
CC	 = gcc-2.5.8 -Wall -pedantic
CPP      = gcc-2.5.8 -E -P $(C_FLAGS)
#endif
#endif

#ifdef macintosh
CC       = C
CPP      = gcc -E -P -Dmacintosh $(CPP_FLAGS)
#endif

INCLUDES = $(INC_SRC)

CC_OPT  = $(C_OPT) $(C_FLAGS)

$(MAIN): $(OBJFILES)

#ifdef macintosh
	lib -o $@ $(OBJFILES)
#else
#ifdef sun4s
	ld -dn -r -o $@ $(OBJFILES)
#else
	ld -r -o $@ $(OBJFILES)
#endif
#endif

data.c: data.gen declare.h
	@echo 'generating data.c'
	@echo '#include "define.h"' > data.c
	@echo '#include <stdio.h>' >> data.c
	@echo '#include "heap.h"'  >> data.c
	@echo '#include "macro.h"' >> data.c
	cat declare.h data.gen > tmpdata.c
	$(CPP) tmpdata.c | sed -n -e '/^..*$$/p' >> data.c
	rm -f tmpdata.c
	@echo done

data.h: data.gen export.h
	@echo 'generating data.h'
	cat export.h data.gen > tmpdata.c
	$(CPP) tmpdata.c |\
	sed -n -e '/^..*$$/p' > data.h
	rm -f tmpdata.c
	@echo done

scramble: scramble.c
	$(CC) -o scramble scramble.c

$(OBJFILES): $($@:.o=.c) data.c data.h $(INCLUDES) $(GEN_SRC)
#ifdef macintosh
	$(CC) -o $@ $(CC_OPT) $(@:.o=.c)
#else
	$(CC) -c $(CC_OPT) $(@:.o=.c)
#endif

clean: 
	-rm -f $(OBJFILES) *~ *.s *.i; touch data.gen

srclist:
	@echo $(SOURCES) | tr -s " " "\012"
