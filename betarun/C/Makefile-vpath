# 
#  BETA RUNTIME SYSTEM, Copyright (C) 1991-2001 Mjolner Informatics A/S
#  Makefile-vpath
#  by Lars Bak
#  heavily modified by Erik Corry
#

VPATH=$(BETARUN)/C

MAKEFILE = $(BETARUN)/C/Makefile-vpath

ORD_SRC = \
        betaerror.c \
        property.c \
        initialize.c \
        betaenv.c \
        argument.c \
        group.c \
        exit.c \
        cbfa.c \
        floats.c \
        multithread.c \
        sighandler.c \
        dot.c \
        data.c \
        sockets.c \
        outpattern.c \
        valhallaComm.c \
        valhallaSOCKETS.c \
        scanobjects.c \
        labelnametable.c \
        rtdebug.c \
        version.c \
        heapview.c

GEN_SRC  = data.gen export.h declare.h

INC_SRC  := \
        macro.h \
        beta.h \
        define.h \
        data.h \
        data.gen \
        constant.h \
        heap.h \
        object.h \
        function.h \
	valhallaComm.h \
        valhallaSOCKETS.h \
        registers.h \
	dot.h \
	trace-types.h

ifeq ($(ARCH), sun4s)
INC_SRC  := $(INC_SRC) sparcdep.h
endif
ifeq ($(ARCH), hpux9pa)
INC_SRC  := $(INC_SRC) snakedep.h
endif

SOURCES  = $(Makefile) $(ORD_SRC) $(GEN_SRC) $(INC_SRC)
OBJFILES  = $(ORD_SRC:.c=.$(DOTO))

CC_OPT := -I$(BETARUN)/C -I$(BETARUN)/P $(CFLAGS) $(EXTRA_C_OPTIONS)

ifeq ($(MAJORARCH), nti)
  CC_OPT := $(CC_OPT) -D$(MAJORARCH) -D$(MAJORARCH)_$(MINORARCH)
endif

ifeq ($(RTDEBUG), yes)
  CC_OPT := $(CC_OPT) -DRTDEBUG
endif

ifeq ($(ALLOC_TRACE), yes)
  CC_OPT := $(CC_OPT) -DALLOC_TRACE
endif

ifeq ($(VALHALLA), yes)
  CC_OPT := $(CC_OPT) -DRTVALHALLA
endif

ifeq ($(UGC), yes)
  CC_OPT := $(CC_OPT) -Ddo_unconditional_gc
endif

ifeq ($(CDEBUG), yes)
  CC_OPT := $(CC_OPT) $(DEBUGOPT) $(PROF)
else
  CC_OPT := $(CC_OPT) $(OPTIMISEOPT) $(PROF)
endif
  
# nti:
# CC_OPT  :== -I..\C -I..\P $(CC_OPT)


ifeq ($(GNUC), yes)
  ifneq ($(ARCH), linux)
    ifeq ($(ARCH), nti_gnu)
      # -pedantic on Mingw32 causes lots of warnings, so it's no fun at all
      CC_OPT := -Wall $(CC_OPT)
    else
      CC_OPT := -Wall -pedantic $(CC_OPT)
    endif
  else
    # don't use -Werror and -pedantic together on Linux glibc2.1 due to buglet in socket.h
    CC_OPT := -Wall -Werror $(CC_OPT)
  endif
  CC = gcc
else  # not gcc - sgi
  CC_OPT := $(ABI) $(CC_OPT)
  CC = cc
  ifeq ($(ARCH), nti_ms)
    CC = cl
  endif
endif

INCLUDES = $(INC_SRC)

all: print_info c.common.o $(MAKEFILE)

c.common.o: $(OBJFILES) $(MAKEFILE)
ifeq ($(ARCH), sgi)
	ld $(ABI) -r -o $@ $(OBJFILES)
else
  ifeq ($(ARCH), sun4s)
	#touch $@ # no need to link - we use "ar -r" from top directory
  else
    ifneq ($(ARCH), nti_ms)
	ld -r -o $@ $(OBJFILES)
    endif
  endif # sun
endif # sgi

print_info: $(ORD_SRC) $(GEN_SRC) $(INC_SRC) $(MAKEFILE)
	@$(ECHON)       Compiling in: $(ECHONEND)
	@$(PWDCMD)
	@$(ECHON)       With command line: $(ECHONEND)
	@$(ECHO) $(CC) -c $(CC_OPT) -o file.$(DOTO) /path/to/file.c $(ECHOEND)
	

$(OBJFILES): %.$(DOTO): %.c $(INCLUDES) $(GEN_SRC) $(MAKEFILE) $(BETARUN)/version.c
	@$(ECHO) $(CC) ... -c -I... $<$ $(ECHOEND)
	@$(CC) -c $(CC_OPT) -o $@ $<

clean: 
	@-(RM) $(OBJFILES) *~ *.s *.i *.gen *.o *.obj

# Unix only at the moment.  TODO, do tr with perl.
srclist:
	@$(ECHO) $(SOURCES) | tr -s " " "\012" $(ECHOEND)

