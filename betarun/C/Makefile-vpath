# 
#  BETA RUNTIME SYSTEM, Copyright (C) 1991-2001 Mjolner Informatics A/S
#  Makefile-vpath
#  by Lars Bak
#  heavily modified by Erik Corry
#

VPATH=$(BETARUN)/C

MAKEFILE = $(BETARUN)/C/Makefile-vpath

ORD_SRC = \
        betaerror.c \
        property.c \
        initialize.c \
        betaenv.c \
        argument.c \
        group.c \
        exit.c \
        cbfa.c \
        floats.c \
        multithread.c \
        sighandler.c \
        dot.c \
        data.c \
        sockets.c \
        outpattern.c \
        valhallaComm.c \
        valhallaSOCKETS.c \
        scanobjects.c \
        labelnametable.c \
        rtdebug.c \
        version.c \
        heapview.c

GEN_SRC  = data.gen export.h declare.h

INC_SRC  := \
        macro.h \
        beta.h \
        define.h \
        data.h \
        data.gen \
        constant.h \
        heap.h \
        object.h \
        function.h \
	valhallaComm.h \
        valhallaSOCKETS.h \
        registers.h \
	dot.h

ifeq ($(ARCH), sun4s)
INC_SRC  := $(INC_SRC) sparcdep.h
endif
ifeq ($(ARCH), hpux9pa)
INC_SRC  := $(INC_SRC) snakedep.h
endif

SOURCES  = $(Makefile) $(ORD_SRC) $(GEN_SRC) $(INC_SRC)
OBJFILES  = $(ORD_SRC:.c=.o)

CC_OPT := -I$(BETARUN)/C -I$(BETARUN)/P $(CFLAGS)

ifeq ($(RTDEBUG), yes)
  CC_OPT := $(CC_OPT) -DRTDEBUG
endif

ifeq ($(VALHALLA), yes)
  CC_OPT := $(CC_OPT) -DRTVALHALLA
endif

ifeq ($(UGC), yes)
  CC_OPT := $(CC_OPT) -Ddo_unconditional_gc
endif

ifeq ($(CDEBUG), yes)
  CC_OPT := $(CC_OPT) -g $(PROF)
else
ifeq ($(ARCH), sgi)
CC_OPT := $(CC_OPT) -O2
else
CC_OPT := $(CC_OPT) -O6
endif
endif
  
# nti:
# CC_OPT  :== -I..\C -I..\P $(CC_OPT)


ifeq ($(GNUC), yes)
  ifneq ($(ARCH), linux)
    CC_OPT := -Wall -pedantic $(CC_OPT)
    CC = gcc
  else
    # don't use -Werror and -pedantic together on Linux glibc2.1 due to buglet in socket.h
    CC_OPT := -Wall -Werror $(CC_OPT)
    CC = gcc
  endif
else  # not gcc - sgi
  CC_OPT := $(ABI) $(CC_OPT)
  CC = cc
endif

INCLUDES = $(INC_SRC)

all: c.common.o $(MAKEFILE)

c.common.o: $(OBJFILES) $(MAKEFILE)
ifeq ($(ARCH), sgi)
	ld $(ABI) -r -o $@ $(OBJFILES)
else
ifeq ($(ARCH), sun4s)
	#touch $@ # no need to link - we use "ar -r" from top directory
else
	ld -r -o $@ $(OBJFILES)
endif # sun
endif # sgi

$(OBJFILES): %.o: %.c $(INCLUDES) $(GEN_SRC) $(MAKEFILE) print_info
	@echo $(CC) ... -c -I... $<
	@$(CC) -c $(CC_OPT) -o $@ $<

print_info:
	@echo -n "***Compiling in "
	@pwd
	@echo With command line
	@echo $(CC) -c $(CC_OPT) -o file.o /path/to/file.c

clean: 
	@-rm -f $(OBJFILES) *~ *.s *.i *.gen *.o *.obj

srclist:
	@echo $(SOURCES) | tr -s " " "\012"
