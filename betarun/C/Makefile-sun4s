#
# Generic Makefile for betarun/C
#

CPP  = gcc -E
MAKE = make

all: xmakefile
	@$(MAKE) -f xmakefile\
        "C_FLAGS  = -I../C -I../P"\
        "C_OPTA = -O6 $(PROF) $(PE)" \
        "C_OPTB = -O6 $(PROF) $(PE)" \
	"MAIN   = c.common.o"

valhalla: xmakefile
	@$(MAKE) -f xmakefile\
        "C_FLAGS  = -I../C -I../P -DRTVALHALLA"\
        "C_OPTA   = -O6 $(PROF) $(PE)" \
        "C_OPTB   = -O6 $(PROF) $(PE)" \
	"MAIN     = c.common.valhalla"

mt: xmakefile
	@csh -f -c 'make -f xmakefile\
        "C_FLAGS = -I../C -I../P -DMT" \
        "C_OPTA  = -O6 $(PROF) $(PE)" \
        "C_OPTB  = -O6 $(PROF) $(PE)" \
	"MAIN    = c.common.mt" |& egrep -v "(call-clobbered|included from|                 from )"'

debug_mt: xmakefile
	@csh -f -c 'make -f xmakefile\
        "C_FLAGS = -I../C -I../P -DMT -DRTDEBUG" \
        "C_OPTA  = -O6 -g $(PROF) $(PE)" \
        "C_OPTB  = -O0 -g $(PROF) $(PE)" \
	"MAIN    = c.common.debug_mt" |& egrep -v "(call-clobbered|included from|                 from )"'

v_mt: xmakefile
	@csh -f -c 'make -f xmakefile\
        "C_FLAGS = -I../C -I../P -DMT -DRTVALHALLA" \
        "C_OPTA  = -O6 $(PROF) $(PE)" \
        "C_OPTB  = -O6 $(PROF) $(PE)" \
	"MAIN    = c.common.v_mt" |& egrep -v "(call-clobbered|included from|                 from )"'

debug: xmakefile
	@$(MAKE) -f xmakefile \
        "C_FLAGS  = -I../C -I../P -DRTDEBUG"\
        "C_OPTA   = -O6 -g $(PROF)" \
        "C_OPTB   = -O0 -g $(PROF)" \
	"MAIN     = c.common.debug"

fastdebug: xmakefile
	@$(MAKE) -f xmakefile \
        "C_FLAGS  = -I../C -I../P -DRTDEBUG -DFASTDEBUG"\
        "C_OPTA   = -O6 -g $(PROF)" \
        "C_OPTB   = -O0 -g $(PROF)" \
	"MAIN     = c.common.fastdebug"

xmakefile: ymakefile-C
	@echo "Making xmakefile"
	@rm -f xmakefile
	@cp ymakefile-C ymakefile.c
	@$(CPP) ymakefile.c |\
		sed -e 's/^#.*//' -e 's/^[ \f\t][ \f\t]*$$//' -e 's/^ //' |\
		sed -n -e '/^..*$$/p' > xmakefile
	@rm ymakefile.c

clean: xmakefile
	@$(MAKE) -f xmakefile clean MAIN=dummy
	-@rm -f xmakefile *.o *.debug *.valhalla *.mt
	-@rm -f tmpdata.c scramble

ymakefile-C:
	touch ymakefile-C

