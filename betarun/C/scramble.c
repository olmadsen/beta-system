/*
 * BETA RUNTIME SYSTEM, Copyright (C) 1990-94 Mjolner Informatics Aps.
 * scramble.c
 * by Jacob Seligmann
 */

#include <stdio.h>

/*
 * This program is used to generate scrambled strings for C/initialize.c
 * 
 * Instructions: 
 * 1) Replace SCRAMBLETEMPLATE below with string to be scrambled
 * 2) Compile and run program
 * 3) Incorporate output into SCRAMBLE{STRING,LEN,CHK} below
 * 4) Compile and run program
 * 5) Incorporate output into C/initialize.c
 * Note: Steps 3 and 4 above are not needed, but recommended as verification
 *
 * Scramble algorithm:
 * Simple. Each character is xor'ed with the value of the previous 
 * (scrambled) character, and 41 is added to the result (modulo 256).
 * [The first character is xor'ed with 0.] In addition, the sum of 
 * the unscrambled characters is maintained as a checksum.
 */

#ifdef DEMO

#define SCRAMBLETEMPLATE "\
Mj\277lner BETA System\r\
DEMO VERSION release 3.0\
\r\r"

#else

#define SCRAMBLETEMPLATE "\
\n\
*******************************************************************\n\
* Note: This program was compiled using a Personal Edition of the *\n\
* Mjolner BETA System and may not be used for commercial purposes *\n\
*******************************************************************\n\
\n"

#endif

#ifdef DEMO

#define SCRAMBLESTRING {\
0x76, 0x45, 0x23, 0x78, 0x3f, 0x83, 0x1a, 0x63, 0x4a, 0x38, \
0x95, 0xfd, 0x06, 0x7e, 0x30, 0x6c, 0x41, 0x4d, 0x49, 0x6d, \
0x52, 0x40, 0x36, 0xa2, 0xab, 0x26, 0x8c, 0x07, 0x7d, 0x5d, \
0x3b, 0x9e, 0xe7, 0xbe, 0x04, 0x91, 0x1d, 0xa5, 0xff, 0xc3, \
0x0c, 0x68, 0x6f, 0x88, 0xae, 0xcc }
#define SCRAMBLELEN 46
#define SCRAMBLECHK 3660

#else

#define SCRAMBLESTRING {\
0x33, 0x42, 0x91, 0xe4, 0xf7, 0x06, 0x55, 0xa8, 0xab, 0xaa, \
0xa9, 0xac, 0xaf, 0xae, 0xad, 0xb0, 0xc3, 0x12, 0x61, 0x74, \
0x87, 0xd6, 0x25, 0x38, 0x3b, 0x3a, 0x39, 0x3c, 0x3f, 0x3e, \
0x3d, 0x40, 0x93, 0xe2, 0xf1, 0x04, 0x57, 0xa6, 0xb5, 0xc8, \
0x0b, 0x4a, 0x89, 0xcc, 0x0f, 0x4e, 0x8d, 0xd0, 0x23, 0x32, \
0x41, 0x94, 0xe7, 0xf6, 0x05, 0x58, 0x9b, 0xda, 0x19, 0x5c, \
0x9f, 0xde, 0x1d, 0x60, 0x73, 0x82, 0xd1, 0x24, 0x57, 0xa6, \
0xaf, 0x0a, 0x8e, 0x23, 0x6f, 0x7e, 0x87, 0xfc, 0xbd, 0xfd, \
0xb7, 0xc0, 0xd9, 0xd4, 0xe4, 0xac, 0x07, 0x8f, 0x0b, 0x54, \
0x4c, 0x56, 0x4e, 0x97, 0x1d, 0x9b, 0x1f, 0x98, 0x1a, 0x9f, \
0x23, 0x70, 0x79, 0x35, 0x6f, 0x2f, 0x6a, 0x36, 0x3f, 0x87, \
0xd0, 0xa9, 0xf5, 0xb0, 0xec, 0xac, 0xeb, 0xb3, 0x08, 0x51, \
0x3d, 0x82, 0x14, 0x89, 0x09, 0x8f, 0x0a, 0x53, 0x65, 0x2c, \
0x35, 0x6a, 0x2b, 0x77, 0x80, 0xd3, 0x02, 0x51, 0x9a, 0x00, \
0x93, 0x25, 0x72, 0x45, 0x49, 0x64, 0x6d, 0x58, 0x46, 0x3b, \
0xa3, 0xac, 0x28, 0x7a, 0x32, 0x6f, 0x33, 0x87, 0xd0, 0xda, \
0xdd, 0xe2, 0xeb, 0xaf, 0xf7, 0xb7, 0xc0, 0xd7, 0xe1, 0xbe, \
0xc7, 0xce, 0xd4, 0x1d, 0x91, 0x0b, 0x97, 0x1c, 0x65, 0x2c, \
0x6c, 0x47, 0x90, 0x1c, 0x9c, 0x1a, 0xa0, 0xee, 0xc5, 0xcf, \
0xcf, 0xd7, 0xe4, 0xed, 0xc6, 0xdc, 0xd7, 0xd0, 0xe8, 0xc4, \
0xca, 0xe2, 0xeb, 0xea, 0x09, 0x4c, 0x8f, 0xce, 0x0d, 0x50, \
0xa3, 0xb2, 0xc1, 0x14, 0x67, 0x76, 0x85, 0xd8, 0x1b, 0x5a, \
0x99, 0xdc, 0x1f, 0x5e, 0x9d, 0xe0, 0xf3, 0x02, 0x51, 0xa4, \
0xb7, 0xc6, 0x15, 0x68, 0x6b, 0x6a, 0x69, 0x6c, 0x6f, 0x6e, \
0x6d, 0x70, 0x83, 0xd2, 0x21, 0x34, 0x47, 0x96, 0xe5, 0xf8, \
0xfb, 0xfa, 0xf9, 0xfc, 0xff, 0xfe, 0xfd, 0x00, 0x53, 0xa2, \
0xb1, 0xc4, 0x17, 0x66, 0x75, 0x88, 0xcb, 0x0a, 0x49, 0x8c, \
0xcf, 0x0e, 0x2d, 0x50 }
#define SCRAMBLELEN 274
#define SCRAMBLECHK 17700

#endif

void encode(void)
{
  int len, chk;
  unsigned char enc, oldenc, dec;
  unsigned char c, *p;

  printf("Template:\n%s\n", SCRAMBLETEMPLATE);

  printf("Encoding:\n\n");

  printf("#define SCRAMBLESTRING {");
  len = chk = 0;
  enc = dec = 0;
  p = SCRAMBLETEMPLATE;
  while ((c=*p++) != '\0') {
    if (len % 10 == 0)
      printf("\\\n");
    len++;
    oldenc = enc;
    enc = ((c ^ oldenc) + 41);
    dec = ((enc - 41) ^ oldenc);
    if (c != dec) {
      printf("Oops, encoding error!");
      exit(1);
    }
    chk += c;
    printf("0x%02x", enc);
    if (*p != '\0')
      printf(", ");
  }
  printf(" }\n");
  printf("#define SCRAMBLELEN %d\n", len);
  printf("#define SCRAMBLECHK %d\n", chk);
}


void decode(void)
{
  int i, chk;
  unsigned char c, foo[] = SCRAMBLESTRING;
  
  printf("\nDecoding:\n");

  chk = 0;
  for (i=0; i<SCRAMBLELEN; i++) {
    c = (foo[i] - 41) ^ (i?foo[i-1]:0);
    if (c != (unsigned char)SCRAMBLETEMPLATE[i]) {
      fprintf(stderr,"Decoding FAILED: c='%c', template='%c'\n", 
	     c, SCRAMBLETEMPLATE[i]);
      exit(1);
    }
    chk += c;
    putchar(c);
  }
  if (chk != SCRAMBLECHK) {
    fprintf(stderr, "Consistency check FAILED: chk==%d, SCRAMBLECHK=%d\n", 
	    chk, SCRAMBLECHK);
    exit(1);
  }
  printf("Decoding OK!\n");
}


void main(void)
{
  encode();
  decode();
}
