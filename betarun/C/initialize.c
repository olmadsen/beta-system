/*
 * BETA RUNTIME SYSTEM, Copyright (C) 1990-94 Mjolner Informatics Aps.
 * initialize.c
 * by Lars Bak, Peter Andersen, Peter Orbaek, Tommy Thorn, and Jacob Seligmann
 */
#include "beta.h"

#if defined(UNIX) /*|| defined (crts)*/

#ifdef sg
/* Added for silicon graphics */
typedef union sigval {
        long    sival_int;
        void    *sival_ptr;
} sigval;
typedef struct {
        unsigned long sigbits[4];
} sigset_t;
#endif

#include <signal.h>
#endif

#ifdef macintosh
#include <Quickdraw.h>
#include <TextEdit.h>
#include <Fonts.h>
#include <Dialogs.h>
#include <CursorCtl.h>
#include <Menus.h>
#include <Windows.h>
#include <SegLoad.h>
#include <StdLib.h>
#include <String.h>
extern void _DataInit();
#ifdef crts
extern void initJmpPool();
#endif

#define PromptID  7129
#define CPromptID 7130

/* Prompt four C Strings */
void CPrompt(char *msg1, char *msg2, char *msg3, char *msg4)
{ Str255 m1, m2, m3, m4;
  if (msg1) sprintf(m1, "%c%s", strlen(msg1), msg1);
  if (msg2) sprintf(m2, "%c%s", strlen(msg2), msg2);
  if (msg3) sprintf(m3, "%c%s", strlen(msg3), msg3);
  if (msg4) sprintf(m4, "%c%s", strlen(msg4), msg4);
  ParamText(m1, m2, m3, m4);
  Alert(CPromptID,0);
}
/* Prompt four Pascal Strings */
void Prompt(char *msg1, char *msg2, char *msg3, char *msg4)
{
  ParamText(msg1, msg2, msg3, msg4);
  Alert(PromptID,0);
}
#endif

#ifdef DEMO
#ifdef macintosh

#define DEMOSTRING1 "\p\
Mj\277lner BETA System - DEMO VERSION rel. 2.6\n\
\n\
This program is constructed using a DEMO version "
  
#define DEMOSTRING2 "\p\
of the Mj\277lner BETA System and may only be used \
for evaluation purposes and not for any teaching \
or commercial purposes. Use of the program is "
  
#define DEMOSTRING3 "\p\
subject to the restrictions in the demo license."
  
#define DEMOSTRING4 ""
#else /* macintosh */
/* The following data was created using C/scramble.c with template
#define TEMPLATE "\n\
  ******************************************************\n\
  *    Mjolner BETA System - DEMO VERSION rel. 3.0     *\n\
  ******************************************************\n\
  *  This program is constructed using a DEMO version  *\n\
  *  of the Mjolner BETA System and may only be used   *\n\
  *  for evaluation purposes and not for any teaching  *\n\
  *  or commercial purposes. Use of the program is     *\n\
  *  subject to the restrictions in the demo license.  *\n\
  ******************************************************\n\
\n"
*/
#define DEMOSTRING {\
0x33, 0x3c, 0x45, 0x98, 0xdb, 0x1a, 0x59, 0x9c, 0xdf, 0x1e, \
0x5d, 0xa0, 0xb3, 0xc2, 0x11, 0x64, 0x77, 0x86, 0xd5, 0x28, \
0x2b, 0x2a, 0x29, 0x2c, 0x2f, 0x2e, 0x2d, 0x30, 0x43, 0x92, \
0xe1, 0xf4, 0x07, 0x56, 0xa5, 0xb8, 0xbb, 0xba, 0xb9, 0xbc, \
0xbf, 0xbe, 0xbd, 0xc0, 0x13, 0x62, 0x71, 0x84, 0xd7, 0x26, \
0x35, 0x48, 0x8b, 0xca, 0x09, 0x4c, 0x8f, 0xae, 0xb7, 0xc0, \
0x13, 0x5c, 0xa5, 0xae, 0xb7, 0x23, 0x72, 0x46, 0x53, 0x66, \
0x2c, 0x87, 0xd0, 0xbb, 0x27, 0x9c, 0x06, 0x4f, 0x45, 0x65, \
0x3f, 0x74, 0x3a, 0x80, 0xc9, 0x0d, 0x56, 0x3b, 0xa7, 0x13, \
0x85, 0xce, 0xc1, 0xad, 0x28, 0xa4, 0x16, 0x82, 0xf5, 0xfe, \
0xb5, 0xf9, 0xbe, 0xb9, 0xc2, 0x1a, 0x5d, 0x96, 0xdf, 0x28, \
0x31, 0x3a, 0x43, 0x92, 0xc1, 0x0a, 0x53, 0xa2, 0xb1, 0xc4, \
0x17, 0x66, 0x75, 0x88, 0xcb, 0x0a, 0x49, 0x8c, 0xcf, 0x0e, \
0x4d, 0x90, 0xe3, 0xf2, 0x01, 0x54, 0xa7, 0xb6, 0xc5, 0x18, \
0x5b, 0x9a, 0xd9, 0x1c, 0x5f, 0x9e, 0xdd, 0x20, 0x33, 0x42, \
0x91, 0xe4, 0xf7, 0x06, 0x55, 0xa8, 0xab, 0xaa, 0xa9, 0xac, \
0xaf, 0xae, 0xad, 0xb0, 0xc3, 0x12, 0x61, 0x74, 0x87, 0xd6, \
0x25, 0x58, 0xa1, 0xaa, 0xa9, 0xb2, 0xbb, 0x18, 0x99, 0x19, \
0x93, 0xdc, 0xd5, 0xd0, 0xe8, 0xb8, 0xf3, 0xbb, 0xff, 0x08, \
0x8a, 0x22, 0x2b, 0x71, 0x47, 0x52, 0x4a, 0x67, 0x3e, 0x74, \
0x40, 0x5d, 0x61, 0x2e, 0x37, 0x6b, 0x41, 0x51, 0x68, 0x38, \
0x41, 0x49, 0x92, 0xff, 0xe3, 0xd7, 0xc1, 0x0a, 0xa5, 0xe9, \
0xc4, 0xe0, 0xb2, 0x06, 0x91, 0xda, 0x23, 0x32, 0x61, 0x6a, \
0x73, 0x82, 0xcb, 0x14, 0xa4, 0xeb, 0xf4, 0xa9, 0xea, 0xb8, \
0xc1, 0xb5, 0x08, 0x90, 0x25, 0x74, 0x3a, 0x71, 0x7a, 0x61, \
0x4d, 0x42, 0x2c, 0x35, 0x8f, 0x1f, 0x95, 0x0a, 0x98, 0x1e, \
0x67, 0x2f, 0x6a, 0x37, 0x40, 0x56, 0x60, 0x42, 0x8b, 0x0d, \
0x8c, 0x09, 0x99, 0xe2, 0xa9, 0xf5, 0xfe, 0xb4, 0xf0, 0xbe, \
0x03, 0x4c, 0x95, 0xde, 0x1d, 0x40, 0x89, 0xd2, 0x21, 0x2a, \
0x33, 0x7e, 0x3a, 0x71, 0x7a, 0x48, 0x67, 0x2f, 0x6c, 0x42, \
0x4c, 0x61, 0x31, 0x87, 0x12, 0x5b, 0x54, 0x4a, 0x61, 0x3a, \
0x7e, 0x36, 0x7c, 0x38, 0x41, 0x49, 0x50, 0x5d, 0xa6, 0xf1, \
0xc7, 0xdc, 0x25, 0x6c, 0x2c, 0x87, 0xd0, 0xda, 0xdd, 0xcd, \
0x16, 0x8b, 0x17, 0x9f, 0x25, 0x76, 0x48, 0x4f, 0x51, 0x9a, \
0xe3, 0xf2, 0x21, 0x2a, 0x33, 0x42, 0x8b, 0xd4, 0xe4, 0xbf, \
0xc8, 0xd4, 0xe4, 0xb2, 0x08, 0x96, 0x0d, 0x97, 0x27, 0x6f, \
0x2c, 0x35, 0x6e, 0x44, 0x5f, 0x58, 0x60, 0x3c, 0x82, 0x1a, \
0x5d, 0xa6, 0x1c, 0x98, 0x26, 0x2f, 0x69, 0x38, 0x41, 0x5e, \
0x5f, 0x63, 0x6c, 0x45, 0x60, 0x38, 0x88, 0x23, 0x6b, 0x2f, \
0x38, 0x7a, 0x32, 0x3b, 0x44, 0x8d, 0xd6, 0x1f, 0x5e, 0x7d, \
0x86, 0xcf, 0x0e, 0x57, 0xa0, 0xfc, 0xb2, 0xf9, 0xbc, 0x02, \
0x8a, 0x27, 0x30, 0x6d, 0x2b, 0x34, 0x69, 0x2a, 0x78, 0x81, \
0x1c, 0xa2, 0xfa, 0xb7, 0xee, 0xb0, 0xfc, 0xb1, 0x01, 0x97, \
0x22, 0x7a, 0x83, 0x13, 0xa6, 0xaf, 0x04, 0x95, 0x19, 0x62, \
0x2f, 0x73, 0x47, 0x51, 0x9a, 0x1f, 0x9f, 0x25, 0x69, 0x30, \
0x6c, 0x32, 0x45, 0x8e, 0xd7, 0x26, 0x55, 0x9e, 0xe7, 0xf6, \
0x05, 0x58, 0x9b, 0xda, 0x19, 0x5c, 0x9f, 0xde, 0x1d, 0x60, \
0x73, 0x82, 0xd1, 0x24, 0x37, 0x46, 0x95, 0xe8, 0xeb, 0xea, \
0xe9, 0xec, 0xef, 0xee, 0xed, 0xf0, 0x03, 0x52, 0xa1, 0xb4, \
0xc7, 0x16, 0x65, 0x78, 0x7b, 0x7a, 0x79, 0x7c, 0x7f, 0x7e, \
0x7d, 0x80, 0xd3, 0x22, 0x31, 0x44, 0x97, 0xe6, 0xf5, 0x08, \
0x4b, 0x8a, 0xc9, 0xec, 0x0f }
#define DEMOLEN 515
#define DEMOCHK 34558
#endif /* macintosh */
#endif /* DEMO */
  
#ifdef PE
/* The following data was created using C/scramble.c with template
#define TEMPLATE "\n\
*******************************************************************\n\
* Note: This program was compiled using a Personal Edition of the *\n\
* Mjolner BETA System and may not be used for commercial purposes *\n\
*******************************************************************\n\
\n"
*/
#define PESTRING {\
0x33, 0x42, 0x91, 0xe4, 0xf7, 0x06, 0x55, 0xa8, 0xab, 0xaa, \
0xa9, 0xac, 0xaf, 0xae, 0xad, 0xb0, 0xc3, 0x12, 0x61, 0x74, \
0x87, 0xd6, 0x25, 0x38, 0x3b, 0x3a, 0x39, 0x3c, 0x3f, 0x3e, \
0x3d, 0x40, 0x93, 0xe2, 0xf1, 0x04, 0x57, 0xa6, 0xb5, 0xc8, \
0x0b, 0x4a, 0x89, 0xcc, 0x0f, 0x4e, 0x8d, 0xd0, 0x23, 0x32, \
0x41, 0x94, 0xe7, 0xf6, 0x05, 0x58, 0x9b, 0xda, 0x19, 0x5c, \
0x9f, 0xde, 0x1d, 0x60, 0x73, 0x82, 0xd1, 0x24, 0x57, 0xa6, \
0xaf, 0x0a, 0x8e, 0x23, 0x6f, 0x7e, 0x87, 0xfc, 0xbd, 0xfd, \
0xb7, 0xc0, 0xd9, 0xd4, 0xe4, 0xac, 0x07, 0x8f, 0x0b, 0x54, \
0x4c, 0x56, 0x4e, 0x97, 0x1d, 0x9b, 0x1f, 0x98, 0x1a, 0x9f, \
0x23, 0x70, 0x79, 0x35, 0x6f, 0x2f, 0x6a, 0x36, 0x3f, 0x87, \
0xd0, 0xa9, 0xf5, 0xb0, 0xec, 0xac, 0xeb, 0xb3, 0x08, 0x51, \
0x3d, 0x82, 0x14, 0x89, 0x09, 0x8f, 0x0a, 0x53, 0x65, 0x2c, \
0x35, 0x6a, 0x2b, 0x77, 0x80, 0xd3, 0x02, 0x51, 0x9a, 0x00, \
0x93, 0x25, 0x72, 0x45, 0x49, 0x64, 0x6d, 0x58, 0x46, 0x3b, \
0xa3, 0xac, 0x28, 0x7a, 0x32, 0x6f, 0x33, 0x87, 0xd0, 0xda, \
0xdd, 0xe2, 0xeb, 0xaf, 0xf7, 0xb7, 0xc0, 0xd7, 0xe1, 0xbe, \
0xc7, 0xce, 0xd4, 0x1d, 0x91, 0x0b, 0x97, 0x1c, 0x65, 0x2c, \
0x6c, 0x47, 0x90, 0x1c, 0x9c, 0x1a, 0xa0, 0xee, 0xc5, 0xcf, \
0xcf, 0xd7, 0xe4, 0xed, 0xc6, 0xdc, 0xd7, 0xd0, 0xe8, 0xc4, \
0xca, 0xe2, 0xeb, 0xea, 0x09, 0x4c, 0x8f, 0xce, 0x0d, 0x50, \
0xa3, 0xb2, 0xc1, 0x14, 0x67, 0x76, 0x85, 0xd8, 0x1b, 0x5a, \
0x99, 0xdc, 0x1f, 0x5e, 0x9d, 0xe0, 0xf3, 0x02, 0x51, 0xa4, \
0xb7, 0xc6, 0x15, 0x68, 0x6b, 0x6a, 0x69, 0x6c, 0x6f, 0x6e, \
0x6d, 0x70, 0x83, 0xd2, 0x21, 0x34, 0x47, 0x96, 0xe5, 0xf8, \
0xfb, 0xfa, 0xf9, 0xfc, 0xff, 0xfe, 0xfd, 0x00, 0x53, 0xa2, \
0xb1, 0xc4, 0x17, 0x66, 0x75, 0x88, 0xcb, 0x0a, 0x49, 0x8c, \
0xcf, 0x0e, 0x2d, 0x50 }
#define PELEN 274
#define PECHK 17700
#endif /* PE */

  long AllocateHeap( base, top, limit, size)
ptr(long) base; /* points out a cell which should refer the base. */
     ptr(long) top;
     ptr(long) limit;
     long size;      /* the size of the requested heap in bytes.       */
{
  if( (*base = (long) MALLOC( size)) != 0){
    *top   = *base;
    
    *limit = *base + size; 
    return *base;
  }else
    return 0;
}

#if defined(PE) || defined(DEMO)&&!defined(macintosh)
static void showScrambledString(unsigned char *p, int len, int sum)
{
  int i, chk;
  unsigned char c;
  
  chk = 0;
  for (i=0; i<len; i++) {
    c = (p[i] - 41) ^ (i?p[i-1]:0);
    chk += c;
    putchar(c);
  }
  if (chk != sum)
    exit(1);
  fflush(stdout);
}
#endif /* defined(PE) || defined(DEMO)&&!defined(macintosh) */

#ifdef macintosh
/*
 * PatchDataLabels by Per Jessen Schmidt
 * Fix BETA_data labels for the Macintosh
 */

//#include <osUtils.h>

extern long *BETA_data1; /* C-variable */
extern long *BETA_end;

void PatchDataLabels(void)
{ long *start;
  long temp;

  //Debugger();
  start = (long *)&BETA_data1;
  *start = (long *)&BETA_data1;
  *(start+1) = *start+*(start+1);
  *(start+2) = *start+*(start+2);
  
  while(*(start+2) != (long)&BETA_end) {
    temp = *(start+2);
    start = (long *)*(start+2);
	*start = temp;
    *(start+1) = *start+*(start+1);
    *(start+2) = *start+*(start+2);
  }//while
}
#endif /* macintosh */

Initialize()
{
  /* This hack is to cope with the sparc, where
     IOA and IOATop(off) is register vars */
  
  long *tmpIOA, *tmpIOATop;
#ifdef macintosh
  InitGraf((Ptr) &qd.thePort);
  InitFonts();
  InitWindows();
  InitMenus();
  TEInit();
  InitDialogs(nil);
  InitCursor();
  InitTheCursor();
  UnloadSeg((Ptr)_DataInit); /* Unload %A5Init% segment */
  PatchDataLabels ();
#endif
  
  GetBetaEnv();
  
#ifdef DEMO
#ifdef macintosh
  Prompt(DEMOSTRING1, DEMOSTRING2, DEMOSTRING3, DEMOSTRING4);
#else
  {
    unsigned char peMessage[] = DEMOSTRING;
    showScrambledString(peMessage,DEMOLEN, DEMOCHK);
  }
#endif /* macintosh */
#endif /* DEMO */

#ifdef PE  
  {
    unsigned char peMessage[] = PESTRING;
    showScrambledString(peMessage,PELEN, PECHK);
  }
#endif /* PE */

  InterpretItem[0] = 0;
  InterpretItem[1] = 0;
  
#ifdef RTDEBUG
  Notify("RTS: Garbage collector may perform consistency checks on heaps (use BETART).");
#endif
  
  INFO( fprintf( output, "#(Heap info: IOA=2*%dKb", IOASize/Kb) );
  INFO( fprintf( output, ", AOABlock=%dKb", AOABlockSize/Kb) );
  INFO( fprintf( output, ", LVRABlock=%dKb", LVRABlockSize/Kb) );
  INFO( fprintf( output, ", CBFABlock=%dKb\n", CBFABlockSize/Kb) );
  
  /* Setup the Infant Object Area */
  if ( IOASize <= 0 ) {
    char buf[100];
    sprintf(buf,"Too small IOA size specified: %dKb", IOASize/Kb);
    Notify2(buf, "Check your BETART environment variable.");
    exit(1);
  }
  if( !AllocateHeap( &tmpIOA,     &tmpIOATop,     &IOALimit, IOASize ) ){
    char buf[100];
    sprintf(buf,"Couldn't allocate IOA (%dKb)", IOASize/Kb);
    Notify(buf);
    exit(1);
  }

#ifdef sparc
  IOA = tmpIOA;
  IOATopoff = tmpIOATop - IOA;
#else
#ifdef hppa
  /*setIOAReg(tmpIOA);
  setIOATopoffReg(tmpIOATop - tmpIOA);*/
  IOA = tmpIOA;
  IOATop = tmpIOATop;
  RefSP=(long *)&ReferenceStack[0];
  /*setRefSP((void *)RefSP);*/
#else
  IOA = tmpIOA;
  IOATop = tmpIOATop;
#endif
#endif

  if( !AllocateHeap( &ToSpace, &ToSpaceTop, &ToSpaceLimit, IOASize ) ){
    char buf[100];
    sprintf(buf,"Couldn't allocate ToSpace (%dKb)\n", IOASize/Kb);
    Notify(buf);
    exit(1);
  }
  
  /* Allocate the Callback Function Area */
  CBFAAlloc();
  
#ifndef sun4s
#if defined(UNIX) || defined(crts)
   { /* Setup signal handles for the Beta system */
#ifdef SIGFPE
     signal( SIGFPE,  BetaSignalHandler);
#endif
#ifdef SIGILL
     signal( SIGILL,  BetaSignalHandler);
#endif
#ifdef SIGBUS
     signal( SIGBUS,  BetaSignalHandler);
#endif
#ifdef SIGSEGV
     signal( SIGSEGV, BetaSignalHandler);
#endif
#ifdef SIGEMT
     signal( SIGEMT,  BetaSignalHandler);
#endif

#ifdef apollo
     signal( SIGINT,  BetaSignalHandler);
     signal( SIGQUIT, BetaSignalHandler);
#endif /* apollo */
   }
#endif /* UNIX || crts */

#else /* sun4s */
  /* sbrandt 9/7 93. See man sigaction and <sys/signal.h>. */
  { /* Setup signal handlers for the Beta system */
    struct sigaction sa;

    /* Specify that we want full info about the signal, and that
     * the handled signal should not be blocked while being handled: */
    sa.sa_flags = SA_SIGINFO | SA_NODEFER;

    /* No further signals should be blocked while handling the specified
     * signals. */
    sigemptyset(&sa.sa_mask); 

    /* Specify handler: */
    sa.sa_handler = BetaSignalHandler;
    
    sigaction( SIGFPE,  &sa, 0);
    sigaction( SIGILL,  &sa, 0);
    sigaction( SIGBUS,  &sa, 0);
    sigaction( SIGSEGV, &sa, 0);
    sigaction( SIGEMT,  &sa, 0);
  }
#endif /* sun4s */

#ifdef crts
  /* Initialize pool of jump buffers */
  initJmpPool();
#endif /* crts */

  InfoS_Start();

}

