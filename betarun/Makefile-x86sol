RUNDEPS= \
../GEN/x86sol/gen \
RUN/AllocateComponent.run \
RUN/AllocateDopartObject.run \
RUN/AllocateItem.run \
RUN/AllocateHeap.run \
RUN/AllocateRefRep.run \
RUN/AllocateStackObject.run \
RUN/AllocateValRep.run \
RUN/AllocateObjectRep.run \
RUN/Attach.run \
RUN/AttachBasicComponent.run \
RUN/Basics.run \
RUN/Callback.run \
RUN/CInterface.run \
RUN/CheckReferenceAssignment.run \
RUN/COM.run \
RUN/ComponentStack.run \
RUN/Constant.run \
RUN/CopyCText.run \
RUN/CopyRefRep.run \
RUN/CopySliceRefRep.run \
RUN/CopySliceValRep.run \
RUN/CopyText.run \
RUN/CopyValRep.run \
RUN/DataRegs.run \
RUN/Declaration.run \
RUN/ExitObjects.run \
RUN/ExtendRefRep.run \
RUN/ExtendValRep.run \
RUN/MakeTextObj.run \
RUN/Misc.run \
RUN/NewRefRep.run \
RUN/NewValRep.run \
RUN/PerformGC.run \
RUN/Structure.run \
RUN/Qua.run \
RUN/Suspend.run \
RUN/x86soladditions.run

MAKE = make --no-print-directory

######### betarun.o #########

betarun.o: x86sol.o C/c.common.o P/c.p.o GC/c.gc.o 
	/usr/ccs/bin/ld -r -o betarun.o C/c.common.o P/c.p.o GC/c.gc.o x86sol.o

x86sol.o: x86sol.asm
	cp x86sol.asm x86sol.c
	gcc -E x86sol.c > x86sol.s
	gas -o x86sol.o x86sol.s
	rm x86sol.c x86sol.s

x86sol.asm: RUN/x86sol.run RUN/x86soladditions.run $(RUNDEPS)
	../GEN/x86sol/gen -o x86sol.asm RUN/x86sol

C/c.common.o: ALWAYS
	cd C; $(MAKE) -f Makefile-x86sol

P/c.p.o: ALWAYS
	cd P; $(MAKE) -f Makefile-x86sol

GC/c.gc.o: ALWAYS
	cd GC; $(MAKE) -f Makefile-x86sol

######### betarun_v.o #########

betarun_v.o: x86sol.o C/c.common.valhalla P/c.p.valhalla GC/c.gc.valhalla
	/usr/ccs/bin/ld -dn -r -o betarun_v.o C/c.common.valhalla P/c.p.valhalla GC/c.gc.valhalla x86sol.o

betarunv.a: C/c.common.valhalla P/c.p.valhalla GC/c.gc.valhalla x86sol.o
	mv C/end.o end.o
	rm C/c.common.valhalla P/c.p.valhalla GC/c.gc.valhalla betarunv.a 
	ar -r betarunv.a C/*.o GC/*.o x86sol.o

C/c.common.valhalla: ALWAYS
	@cd C;  $(MAKE) -f Makefile-x86sol valhalla PROF="$(PROF)" PE=$(PE)

P/c.p.valhalla: ALWAYS
	@cd P;  $(MAKE) -f Makefile-x86sol valhalla PROF="$(PROF)" PE=$(PE)

GC/c.gc.valhalla: ALWAYS
	@cd GC; $(MAKE) -f Makefile-x86sol valhalla PROF="$(PROF)"

# valhalla: betarun_v.o
valhalla: ALWAYS
	$(MAKE) x86sol.o 
	@cd C;  PROF="$(PROF)" PE=$(PE)
	$(MAKE) -j 1 betarun_v.o

######### betarun_sym.o (variant of betarun_v.o) #########

betarun_sym.o: C/c.common.sym GC/c.gc.sym P/c.p.sym x86sol.o
	/usr/ccs/bin/ld -r -o betarun_sym.o C/c.common.valhalla GC/c.gc.valhalla P/c.p.valhalla x86sol.o

C/c.common.sym: ALWAYS
	cd C;  make -f Makefile-sun4s valhalla PROF="-g $(PROF)" 

GC/c.gc.sym: ALWAYS
	cd GC; make -f Makefile-sun4s valhalla PROF="-g $(PROF)"

P/c.p.sym: ALWAYS
	cd P;  make -f Makefile-sun4s valhalla PROF="-g $(PROF)" 

sym: betarun_sym.o

######### betarun_debug.o ###################

betarun_debug.o: C/c.common.debug P/c.p.debug GC/c.gc.debug x86sol-debug.o
	/usr/ccs/bin/ld -r -o betarun_debug.o C/c.common.debug P/c.p.debug GC/c.gc.debug x86sol-debug.o

C/c.common.debug: ALWAYS
	cd C; $(MAKE) -f Makefile-x86sol debug

P/c.p.debug: ALWAYS
	cd P; $(MAKE) -f Makefile-x86sol debug

GC/c.gc.debug: ALWAYS
	cd GC; $(MAKE) -f Makefile-x86sol debug

x86sol-debug.o: x86sol-debug.asm
	cp x86sol-debug.asm x86sol-debug.c
	gcc -E x86sol-debug.c > x86sol-debug.s
	gas -o x86sol-debug.o x86sol-debug.s
	rm x86sol-debug.c x86sol-debug.s

x86sol-debug.asm: RUN/x86sol.run RUN/x86soladditions.run $(RUNDEPS)
	../GEN/x86sol/gen -debug -o x86sol-debug.asm RUN/x86sol

asm: x86sol-debug.asm

debug: betarun_debug.o

######### betarun_ugc.o (variant of betarun_debug.o) ##########

betarun_ugc.o: C/c.common.ugc GC/c.gc.ugc P/c.p.ugc x86sol-ugc.o
	/usr/ccs/bin/ld -r -o betarun_ugc.o x86sol-ugc.o C/c.common.debug GC/c.gc.debug P/c.p.debug

C/c.common.ugc: ALWAYS
	cd C; $(MAKE) -f Makefile-x86sol debug PROF="-Ddo_unconditional_gc $(PROF)"

GC/c.gc.ugc: ALWAYS
	cd GC; $(MAKE) -f Makefile-x86sol debug PROF="-Ddo_unconditional_gc $(PROF)"

P/c.p.ugc: ALWAYS
	cd P; $(MAKE) -f Makefile-x86sol debug PROF="-Ddo_unconditional_gc $(PROF)"

x86sol-ugc.o: x86sol-ugc.asm
	cp x86sol-ugc.asm x86sol-ugc.c
	gcc -E x86sol-ugc.c > x86sol-ugc.s
	gas -o x86sol-ugc.o x86sol-ugc.s
	rm x86sol-ugc.c x86sol-ugc.s

x86sol-ugc.asm: RUN/x86sol.run RUN/x86soladditions.run $(RUNDEPS)
	../GEN/x86sol/gen -debug -ugc -o x86sol-ugc.asm RUN/x86sol

ugc: betarun_ugc.o


########## All ###########

all:
	make -f Makefile-x86sol clean
	make
	make -f Makefile-x86sol clean
	make -f Makefile-x86sol valhalla
	make -f Makefile-x86sol clean
	make -f Makefile-x86sol ugc
	make -f Makefile-x86sol clean
	make -f Makefile-x86sol debug

######### Generator #########

gen:
	cd ../GEN/x86sol; make

#############################

tags:
	etags RUN/*.run GC/*.[hc] C/*.[hc] P/*.[hc] C/data.gen

check:
	@echo generating list of undefined labels
	@nm betarun.o | grep ' U ' > .new-undefined
	@echo find difference between .old-undefined and .new-undefined
	@diff .old-undefined .new-undefined

gendef:
	@echo generating list of undefined labels
	@nm betarun.o | grep ' U ' > .old-undefined

clean: ALWAYS
	-rm -f *.group *.lst core *~ x86sol.s x86sol-debug.s *.dump
	-rm -f C/xmakefile GC/xmakefile P/xmakefile NEWRUN/xmakefile CRUN/xmakefile
	cd C; make -f Makefile-x86sol clean MAIN=dummy
	cd P; make -f Makefile-x86sol clean MAIN=dummy
	cd GC; make -f Makefile-x86sol clean MAIN=dummy
	@sh -c 'if [ -d TST ]; then cd TST; make clean; fi'

# ALWAYS works with gmake - see section Force Targets in *info*
ALWAYS:
