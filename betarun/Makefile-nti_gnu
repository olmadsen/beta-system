RUNDEPS= \
..\GEN\nti\gen.exe \
RUN/AllocateComponent.run \
RUN/AllocateDopartObject.run \
RUN/AllocateItem.run \
RUN/AllocateRefRep.run \
RUN/AllocateStackObject.run \
RUN/AllocateValRep.run \
RUN/Attach.run \
RUN/AttachBasicComponent.run \
RUN/Basics.run \
RUN/Callback.run \
RUN/CInterface.run \
RUN/CheckReferenceAssignment.run \
RUN/ComponentStack.run \
RUN/COM.run \
RUN/Constant.run \
RUN/CopyCText.run \
RUN/CopyRefRep.run \
RUN/CopySliceRefRep.run \
RUN/CopySliceValRep.run \
RUN/CopyText.run \
RUN/CopyValRep.run \
RUN/Declaration.run \
RUN/ExitObjects.run \
RUN/ExtendRefRep.run \
RUN/ExtendValRep.run \
RUN/MakeTextObj.run \
RUN/Misc.run \
RUN/NewRefRep.run \
RUN/NewValRep.run \
RUN/PerformGC.run \
RUN/RunAlloc.run \
RUN/Structure.run \
RUN/Qua.run \
RUN/Suspend.run \
RUN/ntiadditions.run

normal: betarun_v.lib

all:	
	rm -f betarun.lib betarun_v.lib betarun_pe.lib betarun_debug.lib
#	$(MAKE) -f Makefile-nti_gnu clean
#	$(MAKE) -f Makefile-nti_gnu betarun_pe.lib
	$(MAKE) -f Makefile-nti_gnu clean
	$(MAKE) -f Makefile-nti_gnu betarun.lib
	$(MAKE) -f Makefile-nti_gnu clean
	$(MAKE) -f Makefile-nti_gnu betarun_v.lib
	$(MAKE) -f Makefile-nti_gnu clean
	$(MAKE) -f Makefile-nti_gnu betarun_debug.lib

debug:	
	rm -f betarun_debug.lib
	$(MAKE) -f Makefile-nti_gnu betarun_debug.lib

valhalla:
	rm -f betarun_v.lib
	$(MAKE) -f Makefile-nti_gnu betarun_v.lib 

betarun_debug.lib:
	$(MAKE) -f Makefile-nti_gnu debugpart 'CURRENT_OBJ:=$@'

pe: betarun_pe.lib

betarun_pe.lib:
	$(MAKE) -f Makefile-nti_gnu common 'CURRENT_OBJ:=$@'

betarun_v.lib:
	$(MAKE) -f Makefile-nti_gnu common 'CURRENT_OBJ:=$@'

betarun.lib:
	$(MAKE) -f Makefile-nti_gnu common 'CURRENT_OBJ:=$@'


common: nti.o
	cd C; $(MAKE) -f Makefile-nti_gnu $(CURRENT_OBJ)
	cd P; $(MAKE) -f Makefile-nti_gnu $(CURRENT_OBJ)
	cd GC; $(MAKE) -f Makefile-nti_gnu $(CURRENT_OBJ)
	ar -r $(CURRENT_OBJ) C/*.o GC/*.o P/*.o nti.o

debugpart: ntidebug.o
	cd C; $(MAKE) -f Makefile-nti_gnu clean $(CURRENT_OBJ)
	cd P; $(MAKE) -f Makefile-nti_gnu clean $(CURRENT_OBJ)
	cd GC; $(MAKE) -f Makefile-nti_gnu clean $(CURRENT_OBJ)
	ar -r $(CURRENT_OBJ) C/*.o GC/*.o P/*.o ntidebug.o

nti.o: nti.asm
	ml /c /coff /Cp /nologo /w /Fonti.o /Tanti.asm

ntidebug.o: ntidebug.asm
	ml /Zi /c /coff /Cp /nologo /w /Fontidebug.o /Tantidebug.asm

nti.asm: RUN/nti.run RUN/ntiadditions.run $(RUNDEPS)
	../GEN/nti/gen -o nti.asm RUN/nti

ntidebug.asm: RUN/nti.run RUN/ntiadditions.run $(RUNDEPS)
	../GEN/nti/gen -debug -o ntidebug.asm RUN/nti

gen:
	cd ../GEN/nti; $(MAKE)

tags:
	etags RUN/*.run GC/*.c C/*.h C/*.c C/data.gen P/*.c P/*.h


check:
	@echo generating list of undefined labels
	@nm betarun.o | grep ' U ' > .new-undefined
	@echo find difference between .old-undefined and .new-undefined
	@diff .old-undefined .new-undefined

gendef:
	@echo generating list of undefined labels
	@nm betarun.o | grep ' U ' > .old-undefined

#clean: 
#	cd C; $(MAKE) -f Makefile-nti_gnu clean
#	cd GC; $(MAKE) -f Makefile-nti_gnu clean
#	- rm -f *.group *.lst core *~ \#* nti* *.dump
#	- rm -f RUN/*.group RUN/*~ RUN/*.lst RUN/core
#	sh -c 'if [ -d TST ]; then cd TST; $(MAKE) -f Makefile-nti_gnu clean; fi'

runclean:
	-rm -f nti.asm ntidebug.asm *.dump *.lst core *.group *~ #*# 
	-rm -f RUN/core RUN/*~ RUN/*.lst RUN/*.astL

clean:  runclean
	cd C; $(MAKE) -f Makefile-nti_gnu clean
	cd GC; $(MAKE) -f Makefile-nti_gnu clean
	cd P; $(MAKE) -f Makefile-nti_gnu clean
