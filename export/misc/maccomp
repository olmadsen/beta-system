#!/usr/local/bin/perl5

# usage: maccomp pack-file-name
# standard input should be one line of whitespace separated 
# file names.


# Allow multiline matching
$*=1;

$packfile = $ARGV[0];

# open pack file
open(PACK, ">$packfile") || die "cannot open $packfile for writing";

# read line from standard input
$files = <STDIN>;

# change whitespace into one space
$files =~ s%\s+% %g;	

# one file for each line         
@FILES = split(/ /, $files);
$files = join("\n", @FILES);  


# remove initial "./"
$files =~ s%^\.\/%%g;

# substitute bin/ with scripts/
$files =~ s%^bin/%scripts/%g;

# change '/' to ':'                      
$files =~ s%\/%\:%g;

# build MPW command line
$files =~ s%^(.+)\:([^\:]+)$%duplicate {betalib}$1\:$2 {newbeta}$1%g;

# Add locking of files if specified in environment (see ppcmac.dotar)
if ($ENV{'BETALOCK'} eq "yes"){
    $files =~ 
	s%(duplicate )(\{betalib\}.+)( {newbeta}.+)%$1$2$3\nsetfile -a L$3\:\211%g;
}

# Add setting of file types to be MPW files:
$files =~ s%(duplicate )(\{betalib\}.+\:)([^:]+\.bet)( {newbeta}.+)%$1$2$3$4\nsetfile -t TEXT -c 'MPS '$4\:$3%g;
$files =~ s%(duplicate )(\{betalib\}.+\:)([^:]+\.c)( {newbeta}.+)%$1$2$3$4\nsetfile -t TEXT -c 'MPS '$4\:$3%g;
$files =~ s%(duplicate )(\{betalib\}.+\:)([^:]+\.h)( {newbeta}.+)%$1$2$3$4\nsetfile -t TEXT -c 'MPS '$4\:$3%g;

# change '*' to '\211'                      
$files =~ s%\*%\211%g;

# print header for pack file
#print PACK "directory {betalib}\n\n";

# print out directory creation commands
foreach $path (@FILES){
    $path =~ s%^\.\/%%g;
    $path =~ s%\/$%%g;
    $path =~ s%\/[^\/]*$%%g;
    $full = '';
    foreach $dir (split '/', $path) {
	$full .= $dir . ':';
	if (!$doneflag{$full}){
	    print PACK "newfolder {newbeta}$full „ Dev:Null \|\|\;\n";
	    $doneflag{$full}=1;
	}
    }
}
print PACK "\n";

# print out the files
print PACK $files;
print PACK "\n";

# close pack file
close(PACK);
