#!/usr/local/bin/perl5 -s
#-*-Perl-*-

require "dirlist";

open(FULL, "<$betalib/AllFilesInMBS.lst") or die "$betalib/AllFilesInMbs.lst: $!";

foreach $file (<FULL>) {
    next if ($file =~ /\/test\//); # Never pack files in test directories.
    next if ($file =~ /\~$/);	  # Never pack ~ files.
    if ($file =~ /$betalib(.*)$/) {
	# push (@AllFiles, $file);
	$AllFiles{$file} = 1;
    }
}
close FULL;

foreach $arch (@ARGV) {
    if (!open(PACKED, "cat $arch/*.lst |")) {
	print "Warning: Unable to open arch: $arch\n";
	next;
    }

    foreach $line (<PACKED>) {
	if ($line =~ /^a\s*(\S+)/) {
	    $file = $1;
	    if (!defined $AllFiles{$file}) {
		print "File packed, not in $betalib: $file\n";
	    } else {
		$AllFiles{$file}=$arch;
	    }
	} else {
	    print "Unable to parse: \"$line\"\n";
	}
    }

    foreach $file (sort keys %AllFiles) {
	if ($AllFiles{$file} ne $arch) {
	    print "Missing: $file\n";
	}
    }
}
