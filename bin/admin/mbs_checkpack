#!/usr/local/bin/perl5 -s
#-*-Perl-*-

require "dirlist";

open(FULL, "<$betalib/AllFilesInMBS.lst") or die "$betalib/AllFilesInMbs.lst: $!";

foreach $file (<FULL>) {
    chop $file;
    next if ($file =~ /\/(test|TST|CVS)\//); # Never pack files in these dirs.
    next if ($file =~ /\~$/);	  # Never pack ~ files.
    # push (@AllFiles, $file);
    $AllFiles{$file} = 1;
}
close FULL;

foreach $arch (@ARGV) {
    if (!open(PACKED, "cat $arch/*.lst |")) {
	print "Warning: Unable to open arch: $arch\n";
	next;
    }

    foreach $line (<PACKED>) {
	chop $line;
	next if ($line =~ /\/$/);	  # Ignore directories.
	if ($line =~ /^a\s*(\.\/)?(\S+)/) {
	    $file = $2;
	    if (!defined $AllFiles{$file}) {
		print "File packed, not in betalib: \"$file\"\n";
	    } else {
		$AllFiles{$file}=$arch;
	    }
	} else {
	    print "Unable to parse: \"$line\"\n";
	}
    }

    @archs = ('linux', 'sun4s', 'hpux9pa', 'sgi');
    
    File:foreach $file (sort keys %AllFiles) {
	foreach $a (@archs) {
	    if ($a ne $arch) {
		next File if ($file =~ /\/$a\//);
	    }
	}
	if ($AllFiles{$file} ne $arch) {
	    print "Missing: $file\n";
	}
    }
}
