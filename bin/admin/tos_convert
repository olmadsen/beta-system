#!/usr/local/bin/perl -s
use Text::Tabs;

sub usage()
{
    print "usage:\n";
    print "tos_convert [-h][-r][-n][-d] files/directories\n";
    print "  -h  print this help\n";
    print "  -r  recurse into subdirectories\n";
    print "  -I  Non-interactive mode (do not ask before replacing)\n";
    print "  -q  quiet mode\n";
    print "  -d  debug mode\n";
    print "  -n  simulate: do nothing\n";
}

push(@INC, $ENV{'BETALIB'} . "/bin/admin");
require "env.perl";

&usage()      if (defined($h)); 

my ($recurse, $simulate, $verbose, $debug, $interactive);
$verbose  = 1;
$interactive = 1;

$recurse     = 1 if (defined($r));
$simulate    = 1 if (defined($n));
$verbose     = 0 if (defined($q));
$debug       = 1 if (defined($d));

$verbose  = 1 if ($debug);
$simulate = 1 if ($debug);

foreach $f (@ARGV){
    if ( -d $f ){
	tos_convert_directory($f);
    } elsif ( -f $f ){
	tos_convert($f);
    } else {
	print "\"$f\" is not a regular file/directory\n";
    }
}

local $substitution = 0;

sub replace(){
    my ($file, $lineno, $line) = @_;

    # ignore tos_converted comment lines
    return $line if ($line =~ /\(\* Above line tos_converted from:/);

    chomp $line;
    my $orig = $line;
    my $orig_substitution = $substitution;

    ##### Byte

    # replace "(@@X,val)->TOS'%putByte[byteNo]'" with "(val,byteNo)->X.%putByte" (X variable)
    if ($line =~ /\(\s*\@\@\s*([\w\.]+)\s*,\s*([^\)]+)\)\s*->\s*tos\s*\'\%putByte\[([^\]]+)\]\'/i){
	$replace = "($2,$3)->$1.%putByte";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }
    
    # replace "(addr,val)->TOS'%putByte[byteNo]'" with "(val) %putByteAt(addr+byteno)" (addr expression)
    if ($line =~ /\(\s*(.+?)\s*,\s*([^\)]+)\)\s*->\s*tos\s*\'\%putByte\[([^\]]+)\]\'/i){
	$replace = "($2) %putByteAt($1+$3)";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "(@@X,val)->TOS'%putByte'" with "(val,0)->X.%putByte" (X variable)
    if ($line =~ /\(\s*\@\@\s*([\w\.]+)\s*,\s*([^\)]+)\)\s*->\s*tos\s*\'\%putByte\'/i){
	$replace = "($2,0)->$1.%putByte";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "(addr,val)->TOS'%putByte'" with "(val) %putByteAt(addr)" (addr expression)
    if ($line =~ /\(\s*(.+?)\s*,\s*([^\)]+)\)\s*->\s*tos\s*\'\%putByte\'/i){
	$replace = "($2) %putByteAt($1)";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "X->TOS'%getByte[byteNo]'" with "(byteNo->X.%getByte)"
    if ($line =~ /([\w\.]+)\s*->\s*tos\s*\'\%getByte\[([^\]]+)\]\'/i){
	$replace = "($2->$1.%getByte)";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "R[expression]->TOS'%getByte[byteNo]'" with "(byteNo->R[expression].%getByte)"
    if ($line =~ /([\w\.]+\[[^\]]+\])\s*->\s*tos\s*\'\%getByte\[([^\]]+)\]\'/i){
	$replace =  "($2->$1.%getByte)";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "@@X->TOS'%adrGetByte[n]'" with n -> X.%getByte
    if ($line =~ /\@\@\s*([\w\.\[\]]+)\s*->\s*tos\s*\'\%adrGetByte\[([^\]]+)\]\'/i){
	$replace = "($2->$1.%getByte)";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "@@X->TOS'%adrGetSignedByte[n]'" with n -> X.%getSignedByte
    if ($line =~ /\@\@\s*([\w\.\[\]]+)\s*->\s*tos\s*\'\%adrGetSignedByte\[([^\]]+)\]\'/i){
	$replace = "($2->$1.%getSignedByte)";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "@@X->TOS'%adrGetSignedByte'" with 0 -> X.%getSignedByte
    if ($line =~ /\@\@\s*([\w\.\[\]]+)\s*->\s*tos\s*\'\%adrGetSignedByte\'/i){
	$replace = "(0->$1.%getSignedByte)";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "addr+off->TOS'%adrGetByte'" with "%getByteAt(addr+off)";
    if ($line =~ /([\w\.\[\]]+)\s*\+\s*(.+?)\s*->\s*tos\s*\'\%adrGetByte\'/i){
	$replace = "(%getByteAt($1+$2))";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "addr->TOS'%adrGetByte'" with "%getByteAt(addr)";
    if ($line =~ /([\w\.\[\]]+)\s*->\s*tos\s*\'\%adrGetByte\'/i){
	$replace = "(%getByteAt($1))";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "addr->TOS'%adrGetByte[n]'" with "%getByteAt(addr+n)";
    if ($line =~ /([\w\.\[\]]+)\s*->\s*tos\s*\'\%adrGetByte\[([^\]]+)\]\'/i){
	$replace = "(%getByteAt($1+$2))";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "addr+off->TOS'%adrGetSignedByte'" with "%getSignedByteAt(addr+off)";
    if ($line =~ /([\w\.\[\]]+)\s*\+\s*(.+?)\s*->\s*tos\s*\'\%adrGetSignedByte\'/i){
	$replace = "(%getSignedByteAt($1+$2))";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "addr->TOS'%adrGetSignedByte'" with "%getSignedByteAt(addr)";
    if ($line =~ /([\w\.\[\]]+)\s*->\s*tos\s*\'\%adrGetSignedByte\'/i){
	$replace = "(%getSignedByteAt($1))";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "(R,byteno,val)->TOS'%inxPutByte'" with (val,byteno)-> R.%putByte
    if ($line =~ /\(([^,]+)\s*,\s*([^,]+)\s*,\s*([^,]+)\s*\)\s*->\s*tos\s*\'\%inxPutByte\'/i){
	$replace = "($3, $2) -> $1.%putByte";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "(R,byteno)->TOS'%inxGetByte'" with byteno-> R.%getByte
    if ($line =~ /\(([^,]+)\s*,\s*([^,]+)\s*\)\s*->\s*tos\s*\'\%inxGetByte\'/i){
	$replace = "$2 -> $1.%getByte";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "(R,byteno)->TOS'%inxGetSignedByte'" with byteno-> R.%getSignedByte
    if ($line =~ /\(([^,]+)\s*,\s*([^,]+)\s*\)\s*->\s*tos\s*\'\%inxGetSignedByte\'/i){
	$replace = "$2 -> $1.%getSignedByte";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }



    ##### Short

    # replace "(@@X,val)->TOS'%putShort[shortNo]'" with "(val,shortNo)->X.%putShort" (X variable)
    if ($line =~ /\(\s*\@\@\s*([\w\.]+)\s*,\s*([^\)]+)\)\s*->\s*tos\s*\'\%putShort\[([^\]]+)\]\'/i){
	$replace = "($2,$3)->$1.%putShort";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "(addr,val)->TOS'%putShort[shortNo]'" with "(val) %putShortAt(addr+2*shortno)" (addr expression)
    if ($line =~ /\(\s*(.+?)\s*,\s*([^\)]+)\)\s*->\s*tos\s*\'\%putShort\[([^\]]+)\]\'/i){
	$replace = "($2) %putShortAt($1+2*$3)";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "(@@X,val)->TOS'%putShort'" with "(val,0)->X.%putShort" (X variable)
    if ($line =~ /\(\s*\@\@\s*([\w\.]+)\s*,\s*([^\)]+)\)\s*->\s*tos\s*\'\%putShort\'/i){
	$replace = "($2,0)->$1.%putShort";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "(addr,val)->TOS'%putShort'" with "(val) %putShortAt(addr)" (addr expression)
    if ($line =~ /\(\s*(.+?)\s*,\s*([^\)]+)\)\s*->\s*tos\s*\'\%putShort\'/i){
	$replace = "($2) %putShortAt($1)";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "X->TOS'%getShort[shortNo]'" with "(shortNo->X.%getShort)"
    if ($line =~ /([\w\.]+)\s*->\s*tos\s*\'\%getShort\[([^\]]+)\]\'/i){
	$replace = "($2->$1.%getShort)";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "R[expression]->TOS'%getShort[shortNo]'" with "(shortNo->R[expression].%getShort)"
    if ($line =~ /([\w\.]+\[[^\]]+\])\s*->\s*tos\s*\'\%getShort\[([^\]]+)\]\'/i){
	$replace = "($2->$1.%getShort)";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "@@X->TOS'%adrGetShort[n]'" with n -> X.%getShort
    if ($line =~ /\@\@\s*([\w\.\[\]]+)\s*->\s*tos\s*\'\%adrGetShort\[([^\]]+)\]\'/i){
	$replace = "($2->$1.%getShort)";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "@@X->TOS'%adrGetSignedShort[n]'" with n -> X.%getSignedShort
    if ($line =~ /\@\@\s*([\w\.\[\]]+)\s*->\s*tos\s*\'\%adrGetSignedShort\[([^\]]+)\]\'/i){
	$replace = "($2->$1.%getSignedShort)";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "@@X->TOS'%adrGetSignedShort'" with 0 -> X.%getSignedShort
    if ($line =~ /\@\@\s*([\w\.\[\]]+)\s*->\s*tos\s*\'\%adrGetSignedShort\'/i){
	$replace = "(0->$1.%getSignedShort)";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "addr+off->TOS'%adrGetShort'" with "%getShortAt(addr+off)";
    if ($line =~ /([\w\.\[\]]+)\s*\+\s*(.+?)\s*->\s*tos\s*\'\%adrGetShort\'/i){
	$replace = "(%getShortAt($1+$2))";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "addr->TOS'%adrGetShort'" with "%getShortAt(addr)";
    if ($line =~ /([\w\.\[\]]+)\s*->\s*tos\s*\'\%adrGetShort\'/i){
	$replace = "(%getShortAt($1))";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "addr->TOS'%adrGetShort[n]'" with "%getShortAt(addr+2*n)";
    if ($line =~ /([\w\.\[\]]+)\s*->\s*tos\s*\'\%adrGetShort\[([^\]]+)\]\'/i){
	$replace = "(%getShortAt($1+2*$2))";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }
    # replace "addr+off->TOS'%adrGetSignedShort'" with "%GetSignedShortAt(addr+off)";
    if ($line =~ /([\w\.\[\]]+)\s*\+\s*(.+?)\s*->\s*tos\s*\'\%adrGetSignedShort\'/i){
	$replace = "(%getSignedShortAt($1+$2))";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "addr->TOS'%adrGetSignedShort'" with "%GetSignedShortAt(addr)";
    if ($line =~ /([\w\.\[\]]+)\s*->\s*tos\s*\'\%adrGetSignedShort\'/i){
	$replace = "(%getSignedShortAt($1))";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "(R,byteno,val)->TOS'%inxPutShort'" with (val,byteno div 2)-> R.%putShort
    if ($line =~ /\(([^,]+)\s*,\s*([^,]+)\s*,\s*([^,]+)\s*\)\s*->\s*tos\s*\'\%inxPutShort\'/i){
	$replace = "($3, ($2) div 2) -> $1.%putShort";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "(R,byteno)->TOS'%inxGetShort'" with (byteno div 2)-> R.%getShort
    if ($line =~ /\(([^,]+)\s*,\s*([^,]+)\s*\)\s*->\s*tos\s*\'\%inxGetShort\'/i){
	$replace = "(($2) div 2) -> $1.%getShort";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "(R,shortno)->TOS'%inxGetSignedShort'" with (byteno div 2)-> R.%getSignedShort
    if ($line =~ /\(([^,]+)\s*,\s*([^,]+)\s*\)\s*->\s*tos\s*\'\%inxGetSignedShort\'/i){
	$replace = "(($2) div 2) -> $1.%getSignedShort";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }
    #### Long

    # replace "(@@X,val)->TOS'%putLong[longNo]'" with "(val,longNo)->X.%putLong" (X variable)
    if ($line =~ /\(\s*\@\@\s*([\w\.]+)\s*,\s*([^\)]+)\)\s*->\s*tos\s*\'\%putLong\[([^\]]+)\]\'/i){
	$replace = "($2,$3)->$1.%putLong";
	$notice = "This will NOT work if \"$1\" is a dynamic reference or array";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno, $notice);
    }

    # replace "(addr,val)->TOS'%putLong[longNo]'" with "(val) %putLongAt(addr+4*longno)" (addr expression)
    if ($line =~ /\(\s*(.+?)\s*,\s*([^\)]+)\)\s*->\s*tos\s*\'\%putLong\[([^\]]+)\]\'/i){
	$replace = "$2 %putLongAt($1+4*$3)";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "(@@X,val)->TOS'%putLong'" with "(val,0)->X.%putLong" (X variable)
    if ($line =~ /\(\s*\@\@\s*([\w\.]+)\s*,\s*([^\)]+)\)\s*->\s*tos\s*\'\%putLong\'/i){
	$replace = "($2,0)->$1.%putLong";
	$notice = "This will NOT work if \"$1\" is a dynamic reference or array";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno, $notice);
    }

    # replace "(addr,val)->TOS'%putLong'" with "(val) %putLongAt(addr)" (addr expression)
    if ($line =~ /\(\s*(.+?)\s*,\s*([^\)]+)\)\s*->\s*tos\s*\'\%putLong\'/i){
	$replace = "($2) %putLongAt($1)";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "@@X->TOS'%adrGetLong[n]'" with n -> X.%getLong
    if ($line =~ /\@\@\s*([\w\.\[\]]+)\s*->\s*tos\s*\'\%adrGetLong\[([^\]]+)\]\'/i){
	$replace = "($2->$1.%getLong)";
	$notice = "This will NOT work if \"$1\" is a dynamic reference or array";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno, $notice);
    }

    # replace "@@X->TOS'%adrGetLong'" with 0 -> X.%getLong
    if ($line =~ /\@\@\s*([\w\.\[\]]+)\s*->\s*tos\s*\'\%adrGetLong\'/i){
	$replace = "(0->$1.%getLong)";
	$notice = "This will NOT work if \"$1\" is a dynamic reference or array";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno, $notice);
    }

    # replace "@@X+off->TOS'%adrGetLong'" with "%getLongAt(addr+off)";
    if ($line =~ /(\@\@\s*[\w\.\[\]]+)\s*\+\s*(.+?)\s*->\s*tos\s*\'\%adrGetLong\'/i){
	$replace = "(%getLongAt($1+$2))";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "addr+off->TOS'%adrGetLong'" with "%getLongAt(addr+off)";
    if ($line =~ /([\@\w\.\[\]]+)\s*\+\s*(.+?)\s*->\s*tos\s*\'\%adrGetLong\'/i){
	$replace = "(%getLongAt($1+$2))";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "addr->TOS'%adrGetLong'" with "%getLongAt(addr)";
    if ($line =~ /([\@\w\.\[\]]+)\s*->\s*tos\s*\'\%adrGetLong\'/i){
	$replace = "(%getLongAt($1))";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "(R,byteno,val)->TOS'%inxPutLong'" with (val,byteno div 4)-> R.%putLong
    if ($line =~ /\(([^,]+)\s*,\s*([^,]+)\s*,\s*([^,]+)\s*\)\s*->\s*tos\s*\'\%inxPutLong\'/i){
	$replace = "($3, ($2) div 4) -> $1.%putLong";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "(R,byteno)->TOS'%inxGetLong'" with (byteno div 4)-> R.%getLong
    if ($line =~ /\(([^,]+)\s*,\s*([^,]+)\s*\)\s*->\s*tos\s*\'\%inxGetLong\'/i){
	$replace = "(($2) div 4) -> $1.%getLong";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }


    #### Bits

    # replace "->TOS'%ShiftLeft[n]'" with " %sll n"
    if ($line =~ /\s*->\s*tos\s*\'\%shiftleft\[([^\]]+)\]\'/i){
	$replace = " %sll $1";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "->TOS'%ShiftRight[n]'" with " %srl n"
    if ($line =~ /\s*->\s*tos\s*\'\%shiftright\[([^\]]+)\]\'/i){
	$replace = " %srl $1";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "->TOS'%AritShiftRight[n]'" with " %sra n"
    if ($line =~ /\s*->\s*tos\s*\'\%aritshiftright\[([^\]]+)\]\'/i){
	$replace = " %sra $1";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "X->TOS'%getSignedBits[bitNo,noOfBits]'" with "((bitNo,noOfBits)->X.%getSignedBits)"
    if ($line =~ /([\w\.\[\]\+]+)\s*->\s*tos\s*\'\%getSignedBits\[([^\]]+\s*,\s*[^\]]+)\]\'/i){
	$replace = "$1; (($2)->$1.%getSignedBits)";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "X->TOS'%getBits[bitNo,noOfBits]'" with "((bitNo,noOfBits)->X.%getBits)"
    if ($line =~ /([\w\.\[\]\+]+)\s*->\s*tos\s*\'\%getBits\[([^\]]+\s*,\s*[^\]]+)\]\'/i){
	$replace = "(($2)->$1.%getBits)";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "(@@X,val)->TOS'%putBits[bitNo,noOfBits]'" with "((val,bitNo,noOfBits)->X.%putBits)"
    if ($line =~ /\(\@\@\s*([\w\.\[\]\+]+)\s*,\s*([\w\.\[\]\+]+\s*)\)\s*->\s*tos\s*\'\%putBits\[([^\]]+\s*,\s*[^\]]+)\]\'/i){
	$replace = "(($2,$3)->$1.%putBits)";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "(x,y)->TOS'%or'" with "x %Bor y" (variables)
    if ($line =~ /\(\s*([\w\.\[\]\+]+)\s*,\s*([\w\.\[\]\+]+)\s*\)\s*->\s*tos\s*\'\%or\'/i){
	$replace = "$1 %Bor $2";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "(e1,e2)->TOS'%or'" with "(e1) %Bor (e2)" (expressions)
    if ($line =~ /\(\s*([^,]+)\s*,\s*([^\)]+)\s*\)\s*->\s*tos\s*\'\%or\'/i){
	$replace = "($1) %Bor ($2)";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "(x,y)->TOS'%and'" with "x %Band y" (variables)
    if ($line =~ /\(\s*([\w\.]+)\s*,\s*([\w\.]+)\s*\)\s*->\s*tos\s*\'\%and\'/i){
	$replace = "$1 %Band $2";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "(e1,e2)->TOS'%and'" with "(e1) %Band (e2)" (expressions)
    if ($line =~ /\(\s*([^,]+)\s*,\s*([^\)]+)\s*\)\s*->\s*tos\s*\'\%and\'/i){
	$replace = "($1) %Band ($2)";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    # replace "x->TOS'%not'" with "%Bnot x" (variables)
    if ($line =~ /\s*([\w\.]+)\s*->\s*tos\s*\'\%not\'/i){
	$replace = "%Bnot $1";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno);
    }

    ####### Special cases of newstyle % identities

    # Replace "(val) %putShortAt (@@R[inx]+2*off)"  with "(val, (inx-1)*2+off)->R.%putShort"
    # ASSUMING R is an integer array
    if ($line =~ /\((.+?)\)\s*%putShortAt\s*\(\@\@(.+?)\[(.+?)\]\s*\+\s*2\*(.+?)\)/i){
	$replace = "($1, ($3-1)*2+$4)->$2.%putShort";
	$notice = "This ASSUMES that \"$2\" is an INTEGER array";
	$line = &ask_replace($`, $&, $', $replace, $file, $lineno, $notice);
    }

    $line .= "\n";

    if ($substitution > $orig_substitution){
	# Add comment decribing change
	$orig =~ s/^(\s*)//; # delete leading whitespace in original line
	my $orig_indent = $&;
	$orig =~ s/\(\*.*\*\)//; # delete comments in original line
	$orig =~ s/(\s*)$//; # delete trailing whitespace in original line
	$line .= $orig_indent . "(* Above line tos_converted from: $orig *)\n";
    }

    return $line;
}

sub ask_replace(){
    my ($before, $match, $after, $replace, $file, $lineno, $notice) = @_;
    my $oldline = $before . $match . $after;
    my $newline = $before . $replace . $after;

    return $oldline if ($quit);
    if ($interactive){
	my $indent = length(expand($before));
	my $oldlen = length(expand($before . $match)) - $indent;
	my $newlen = length(expand($before . $replace)) - $indent;
	print "\n";
	print "-" x 10 . " Replace this original code: " . "-" x 10 . "\n";
	print "$file:$lineno:\n\n";
	print $oldline . "\n";
	print " " x $indent . "^" x $oldlen . "\n\n";
	print "-" x 10 . " with this new code: " . "-" x 10 . "\n\n";
	print $newline . "\n";
	print " " x $indent . "^" x $newlen . "\n\n";
	if (defined($notice)){
	    print "*** NOTICE: $notice\n\n";
	}
      get_answer: 
	{
	    print "-" x 10 . " Answer: (y/n/a/c/q/?) ";
	    my $answer = &GetAnswer();
	    if      ($answer eq "n"){
		return $oldline;
	    } elsif ($answer eq "y"){
		# fall through
	    } elsif ($answer eq "q"){
		$quit = 1;
		return $oldline;
	    } elsif ($answer eq "a"){
		$interactive = 0;
		# fall through
	    } elsif ($answer eq "c"){
		$substitution++;
		return $oldline . "(* FIXME: Missing TOS conversion. Suggestion: $replace *)"
	    } elsif ($answer eq "?"){
		print "Possible answers:\n";
		print "  y  - accept this replacement, ask for subsequent replacements\n";
		print "  n  - reject this replacement, ask for subsequent replacements\n";
		print "  a  - accept this and all subsequent replacements\n";
		print "  c  - reject this replacement but leave FIXME comment\n";
		print "  q  - quit: ignore this and subsequent replacements\n";
		print "  ?  - print this help\n";
		redo get_answer;
	    }
	}
    } 
    $substitution++;
    return $newline;
}

sub tos_convert()
{
    my ($file) = @_;
    my $lineno = 0;
    my @lines;
    $substitution = 0;
    return if ($file !~ /\.bet$/);
    return if ($quit);
    print "Scanning \"$f\"\n" if ($verbose);
    open BETA, "$file" || die "Cannot open $file for reading: $!\n";
    while (<BETA>){
	push @lines, &replace($file, ++$lineno, $_);
    }
    close BETA;
    if ($substitution){
	print "  *** $substitution changes.\n" if ($verbose);
	rename "$file", "${file}~";
	open BETA, ">$file" || die "Cannot open $file for writing: $!\n";
	print BETA join "", @lines;
	close BETA;
    } else {
	print "  (No changes).\n" if ($debug);
    }
	
    
}

sub tos_convert_directory()
{
    my ($dir) = @_;
    my (@files);
    return if ($quit);
    if ($recurse){
	@files = &GetFilesInDirs(&GetDirsRecursively($dir));
    } else {
	@files = &GetFilesInDir($dir);
    }
    foreach $f (@files){
	&tos_convert($f);
    }
}
