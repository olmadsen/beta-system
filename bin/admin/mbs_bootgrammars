#!/usr/local/bin/perl5 -s
#-*-Perl-*-

$UseDefaults = 1 if ($u);

require "env.perl";

sub dogram {
    local ($dir, $grammar) = @_;
    print "\n********* dogram $grammar with BETALIB=$old_betalib\n";
    $ENV{'BETALIB'}=$old_betalib;
    chdir "$new_betalib/grammars/$dir" 
	|| die "Cannot chdir to $new_betalib/grammars/$dir: $!\n";
    system "dogram $grammar";
}

sub bootdogram {
    local ($dir, $grammar) = @_;
    print "\n********* bootdogram $grammar with BETALIB=$new_betalib\n";
    $ENV{'BETALIB'}=$new_betalib;
    chdir "$new_betalib/grammars/$dir" 
	|| die "Cannot chdir to $new_betalib/grammars/$dir: $!\n";
    system "bootdogram $grammar";
}

################# main: ###########################

open(STDERR, ">&STDOUT") || die "Can't dup stdout";
select(STDERR); $| = 1;       # make unbuffered
select(STDOUT); $| = 1;       # make unbuffered

print "This tool will boot the grammars\n";
print "\tmetagrammar\n";
print "\tprettyprint\n";
print "\tbeta\n";
print "\tproperty\n";
print "\tmylang\n";
print "\tidl\n";
print "in BETALIB: $betalib.\n";

if (!$UseDefaults){
    print "\nProceed (y/n/q)? ";
    $answer = &GetAnswer();
    if ($answer eq "q") { exit(0); }
    if ($answer eq "n") { exit(0); }
}

$new_betalib = $betalib;
$old_betalib=$ENV{'OLD_BETALIB'};

print "\nYou will need a boot-release to boot the grammars.\n";
print "Type full path of top-directory in boot-release";
if ("$old_betalib" eq ""){
    print "( <RETURN> to quit):\n";
    $old_betalib = &GetAnswer();
    if ($old_betalib eq "") { exit(0); }
} else {
    if ($UseDefaults){
	print ": $old_betalib\n";
    } else {
	print "( $old_betalib):\n";
	$answer = &GetAnswer();
	if ($answer ne "") {
	    $old_betalib = $answer;
	}
    }
}

if (! -d "$old_betalib"){
    print "$old_betalib is not a directory.\n";
    exit (1);
}
   
&dogram(metagram,metagrammar);
&dogram(pretty,prettyprint);
&bootdogram(beta,beta);
&bootdogram(property,property);
&bootdogram(mylang,mylang);
&bootdogram(idl,idl);
print "NOTICE: You will need to fix idl grammar once \"dogram\"\n";
print "        has been build, by issuing:\n";
print "            cd $betalib/grammars/idl\n";
print "            perl do-idl-gram.perl\n";

print "\nBasic grammars booted.\n";
