#!/usr/local/bin/perl5 -s
#-*-Perl-*-
#...

#use strict;

push(@INC, $ENV{'BETALIB'} . "/bin/admin");

if ($h){
    print "Usage: mbs_bootgrammars [-h][-u]\n";
    print "          -h   Print this help\n";
    print "          -v   Verbose output\n";
    print "          -n   No effects - only print what would be done\n";
    print "       Boots grammars in BETALIB using a boot-release\n";
    exit 0;
}

$UseDefaults = 1 if ($u);

require "env.perl";

sub dogram {
    local ($dir, $grammar) = @_;
    print "\n********* dogram $grammar with BETALIB=$old_betalib\n";
    $ENV{'BETALIB'}=$old_betalib;
    chdir "$new_betalib/$dir" 
	|| die "Cannot chdir to $new_betalib/$dir: $!\n";
    &execute_script("dogram $grammar");
    print "dogram done\n";
}

sub bootdogram {
    local ($dir, $grammar) = @_;
    print "\n********* bootdogram $grammar with BETALIB=$new_betalib\n";
    $ENV{'BETALIB'}=$new_betalib;
    chdir "$new_betalib/$dir" 
	|| die "Cannot chdir to $new_betalib/$dir: $!\n";
    &execute_script("bootdogram $grammar");
    print "bootdogram done\n";
}

################# main: ###########################

open(STDERR, ">&STDOUT") || die "Can't dup stdout";
select(STDERR); $| = 1;       # make unbuffered
select(STDOUT); $| = 1;       # make unbuffered

print "This tool will boot the grammars\n";
print "\tmetagrammar\n";
print "\tprettyprint\n";
print "\tbeta\n";
print "\tproperty\n";
if (($objdir eq "linux") || ($OS eq "WIN")) {
    print "\truntime\n";
}print "\tmylang\n";
print "\tidl\n";
print "in BETALIB: $betalib.\n";

if (!$UseDefaults){
    print "\nProceed (y/n/q)? ";
    $answer = &GetAnswer();
    if ($answer eq "q") { exit(0); }
    if ($answer eq "n") { exit(0); }
}

$new_betalib = $betalib;
$old_betalib=$ENV{'OLD_BETALIB'};

print "\nYou will need a boot-release to boot the grammars.\n";
print "Type full path of top-directory in boot-release";
if ("$old_betalib" eq ""){
    if ($OS="UNIX"){
	$default = "/users/beta/" . $RELEASE . ".boot";
    } else {
	$default = $betalib . ".boot";
    }
} else {
    $default = $old_betalib;
}
if ($UseDefaults){
    print ": $default\n";
    $old_betalib = $default;
} else {
    print " (default: $default):\n";
    $answer = &GetAnswer();
    if ($answer eq "") {
	$old_betalib = $default;
    } else {
	$old_betalib = $answer;
    }
}

if ($OS eq 'WIN'){
    $new_betalib =~ s#/#\\#g;
}

if (! (-d $old_betalib)){
    print "\"$old_betalib\" is not a directory.\n";
    exit (1);
}

$ENV{'OLD_BETALIB'} = $old_betalib;

&dogram("grammars/metagram","metagrammar");
&dogram("grammars/pretty","prettyprint");
&dogram("grammars/beta","beta");
&dogram("grammars/property","property");
if (($objdir eq "linux") || ($OS eq "WIN")) {
    &dogram("betarun/GEN/GRAMMAR/","runtime");
}
&dogram("grammars/mylang","mylang");
&dogram("grammars/idl","idl");
print "NOTICE: You will need to fix idl grammar once \"dogram\"\n";
print "        has been build, by issuing:\n";
print "            cd $betalib/grammars/idl\n";
print "            perl do-idl-gram.perl\n";

print "\nBasic grammars booted.\n";
