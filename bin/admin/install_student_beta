#!/bin/sh

# config:

KEY=86C-9E8-4BEA # Look it up in export.
BETALIB=/usr/local/lib/beta/r5.0a          # destination BETALIB
HOST=origo				    # host for BETALIB
DECRYPT=/users/beta/r5.0/crypt/sgi/decrypt
SOURCE=/users/beta/r5.0/export/tarfiles    # where to find the files
ARCHITECTURES="sgi sun4s linux hpux9pa"
PACKAGES="bifrost contrib frigg lib lidskjalv mjolnertool system xt yggdrasil"
#Non-installed packages: doc

# don't change below

if [ `hostname` != $HOST ]
then
  echo $0: only on $HOST
  exit 1
fi

if [ ! -d $BETALIB ]
then
  echo $0: the new betalib "$BETALIB" does not exist.
  exit 1
fi

echo ""
echo "****** THIS WILL INSTALL BETA IN $BETALIB *****"
echo ""
echo -n "Are you sure that this is what you want to do? "
read answer 
if [ "$answer" != "yes" ]
then
  exit 0
fi

cd $BETALIB

echo ""
echo Changing access permissions for $BETALIB.
echo If this script fails or is interrupted, please issue the
echo command \'chmod 755 $BETALIB\' 
echo to re-open for access to $BETALIB.

chmod 700 $BETALIB

echo ""
echo Changing permissions in $BETALIB...
chmod -R u+w .

for machine in $ARCHITECTURES
do
  echo Installing for $machine
  for package in $PACKAGES
  do
     echo Installing $package for $machine ....
     cat $SOURCE/${machine}.pe/$package.tar.* | gunzip | tar xf -
  done
done

echo ""
for machine in $ARCHITECTURES
do
  echo decrypting betarun for $machine
  cd $BETALIB/betarun/$machine
  chmod u+w .
  $DECRYPT $KEY betarun_o.crypt betarun.o
  $DECRYPT $KEY betarun_v_o.crypt betarun_v.o
  cd $BETALIB
done

echo ""
echo Restoring access permissions for $BETALIB.

chmod 755 $BETALIB
  
echo ""
echo Edit configuration/homeDirectories to match the installation path.
echo ""
echo Verify that the statictics-directory is present.
echo   - If it isnt, get it using "cvs export"  OR by copy from
echo     the previous release OR by softlinking to a shared directory
echo ""
echo   - Make sure everyone has write-permission to all files in stat:
echo        chmod -R a+w statistics
echo ""
echo Make sure statistics is on in all toolscripts, check for:
echo     'BETASTAT=${BETASTAT-yes}'  
echo     'BETAREPORT=${BETAREPORT-yes}'  
echo in {beta,frigg,freja,sif,mjolner,valhalla}
echo ""
echo Then manually compile contrib for the architectures: $ARCHITECTURES.
echo ""
echo Then check using the sigurd account that it is working, including the
echo statistics by using 'tail' on the stat-files.  To do this:
echo      setenv BETALIB $BETALIB
echo On SGI, also: setenv LD_LIBRARY_PATH $BETALIB/lib/sgi
echo ""
