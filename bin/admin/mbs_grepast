#! /usr/local/bin/perl5
#-*-Perl-*-

$betalib=$ENV{'BETALIB'}  || die "BETALIB must be set!\n";
$betalib =~ s#\\#/#g;
$dirs=require "$betalib/bin/admin/dirlist";

if ($#ARGV != 0) {
    print "Usage $0 pattern\n";
    exit 1;
}

$pat = shift @ARGV;

print "Ast files in $RELEASE matching \"$pat\":\n";

foreach $dir (split ' ', $dirs) {
    @todo=('.');
    ($basedir ="$betalib/$dir") =~ s#/$##;
    next if (! -d $basedir);
    while ($curdir = pop @todo) {
	$curdir .= '/';
	$curdir =~ s#^\./$##;
	$ntdirfix = "$basedir/$curdir";
	chdir $ntdirfix or die "Unable to chdir: $!";
	opendir DIR, '.' or die "Unable to readdir $!";
	@files=readdir(DIR);
	closedir DIR;
	foreach $file (@files) {
	    next if ($file =~ /^\./);
	    if (-d $file) {
		push @todo, "$curdir$file";
	    }
	    elsif ($file =~ /\.(ast[lL]?)$/) {
		open IN, $file;
		$n = 1;
		foreach (<IN>) {
		    if (/$pat/oi) {
			print substr("$basedir/${curdir}$file", length($betalib)), "\n";
			next;
		    }
		    $n++;
		}
		close IN;
	    }
	}
    }
}
