#!/usr/local/bin/perl5 -s
#-*-Perl-*-

push(@INC, $ENV{'BETALIB'} . "/bin/admin");

if ($h){
    print "Usage: mbs_checkbet [-h] [dirs]\n";
    print "          -h   Print this help\n";
    print "          -v   Verbose output\n";
    print "          -n   No effects - only print what would be done\n";
    print "       Checks that .bet file is present for each .ast(L) file in dirs (default BETALIB)\n";
    exit 0;
}

if ($#ARGV>-1){
    require "env.perl";
    @Dirs = @ARGV;
    print "Checking that .bet file is present for each .ast(L) file in ";
    print join ' ', @Dirs;
    print "\n";
} else {
    require "dirlist";
    print "Checking that .bet file is present for each .ast(L) file in $RELEASE\n";
}

$match = "\\.ast[lL]?\$";

foreach $dir (@Dirs) {
    if ($#ARGV>-1){
	$basedir = $dir;
    } else { 
	# next if (!$CompileFlag{$dir});
	$basedir = "$betalib/$dir";
    }
    next if (!-d &path($basedir));
    print "*** Checking $basedir ***\n";
    foreach $curdir (&GetDirsRecursively($basedir)) {
	@files = &GetFilesInDirs($curdir);
	FILE: foreach $file (@files) {
	    if ($file =~ /$match/) {
                foreach $ext ('.bet', '.text', '.gram', '.pgram', '-meta.gram', '.run', '.pretty') {
		    ($srcfile  = $file) =~ s/$match/$ext/g;
		    next FILE if (-f $srcfile);
		}
		$file =~ s#\\#/#g;
		foreach $f (@errors) {
		    next FILE if ($f eq $file);
		}
		$numerrs++;
		print "ERROR#$numerrs: Missing source file for:\n  $file\n";
		push (@errors, $file);
	    }
	}
    }
}

if ($numerrs > 0) {
    print "\n$numerrs errors found\n";
    print "delete the following files:\n";
    while ($file = shift @errors) {
        next if (! -f $file);
        print "$file? (y/n/A/q) ";
	$answer = &GetAnswer();
	if ($answer eq "y") {
	    # just go on
	} elsif ($answer eq "A") {
	    unshift(@errors, $file);
	    foreach $f (@errors) {
		print "$f\n";
	    }
	    print "\nReally delete the all these files? (y/n/q) ";
	    $answer = &GetAnswer();
	    if ($answer eq "y") {
		foreach $f (@errors) {
		    print "deleting $f\n";
		    unlink $f or die "$!";
		}
		print "done.\n";
		exit 0;
	    } elsif ($answer eq "n") {
		next;
	    }
	    exit 1;	    
	} elsif ($answer eq "n") {
	    next;
	} elsif ($answer eq "q") {
	    exit 0;
	}
        unlink $file or die "$!";
    }
} else {
    print "\nNo errors found\n";
}
1;
