#! /usr/local/bin/perl -Ps

# Globals
$lastarchival=0;
@exec_files=();
@directories=();
@other_files=();
@directories_to_examine=();
@tmp=();            # Local in sub mtime, sub glob
@allfiles=();       # Local in sub enumerate_files
@tmp1=();           # Local in sub glob
$cfiles{''};
$cdirs{''};
$startdir=`pwd`; chop($startdir);
$currentdir="";

$|=1;

sub cd {
    local($dir)=@_;
    #print "cd ".$dir."\n";
    if (chdir($startdir.'/'.$dir)){
	$currentdir .= $dir."/";
	#print "currentdir: ".$currentdir."\n";
	1;
    } else {
	print "Couldn't chdir to $startdir/$dir: $!";
	0;
    }
}			     

sub descend {
  local($from)=shift(@_);
  local($dir);
  
  while($#_>=$[) {
    $dir=shift(@_);
    unshift(@directories_to_examine, ($from eq '.')?$dir:$from.'/'.$dir);
  }
# print "Descend: directories_to_examine are now: ",
#      join(', ',@directories_to_examine), "\n\n";
}

sub enumerate_files {
  local($file);
  
  open(filepipe, "/bin/ls -A1 |");
  @allfiles=<filepipe>;
  close(filepipe);
  
  @exec_files=();
  @directories=();
  @other_files=();

  while ($#allfiles>=$[) {
    $file=shift(@allfiles);
    chop($file);
    if (-l $file) {push(@other_files, $file); next;}
    if (-d $file) {push(@directories, $file); next;}
    if ((-x $file) || (-X $file)) {push(@exec_files, $file); next;}
    push(@other_files, $file);
  }
# print "Enumerate:\n Exec files: ",
#      join(', ', @exec_files),
#      "\n Directories: ",
#      join(', ', @directories),
#      "\n Other files: ",
#      join(', ', @other_files),
#      "\n\n";
}

sub askremove {	
    chdir($startdir) || print "Couldn't chdir to $startdir";
    foreach $file (@_) {
	($dev,$ino,$mode,$nlink,$uid,$gid,$rdev,$size,@rest)
	    = stat("$currentdir$file");
	printf ("%9s $currentdir$file*\n", $size);
	printf("remove ");
	system ("/bin/rm -i $currentdir$file");
    }	
    chdir($startdir."/".$currentdir) || print "Couldn't chdir to $startdir/$currentdir";

}			      

sub do_dir {
  local($dir)=@_;
  
  if (do cd($dir)){
      do enumerate_files();
      do askremove(@exec_files);
      do descend($dir, @directories);
      do cd();
  }
}  

# main

do do_dir(".");

$currentdir="";

while ($#directories_to_examine>=$[) {
    #print "Main: ", join(', ', @directories_to_examine), "\n\n";
    printf "Examine %s\n", $directories_to_examine[$[] if $verbose;
    $cur = $currentdir;
    do do_dir(shift(@directories_to_examine));
    $currentdir = $cur;
}
