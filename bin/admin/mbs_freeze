#!/usr/local/bin/perl -s
#-*-Perl-*-

push(@INC, $ENV{'BETALIB'} . "/bin/admin");

require "env.perl";

if ($h){
    print "Usage: mbs_freeze [-h][-u]\n";
    print "          -h   Print this help\n";
    print "          -v   Verbose output\n";
    print "          -n   No effects - only print what would be done\n";
    print "          -u   Use defaults - ask no questions\n";
    print "          -U   Unfreeze\n";
    print "       Remove write permission for all files in BETALIB.\n";
    exit 0;
}

if ($U) {
    $verb = "add";
} else {
    $verb = "remove";
}


if ($MACHINETYPE eq "NTI"){
    # windows
    if ($U) {
	$command="attrib -r /s .";
    } else {
	$command="attrib +r /s .";
    }
} else {
    # unix
    if ($U) {
	$command='chmod -Rf u+w .';
    } else {
	$command='chmod -Rf a-w .';
    }
}

#--------- don't change below 

if (!$UseDefaults) {
    print "This script will recursively $verb write-permission for\n";
    print "all files and directories in MBS $RELEASE.\n\n";
    print "Only simulating, though...\n\n" if ($simulate);
    print "Are you sure that you want to do this? (no/yes) ";
    
    $yes = &GetAnswer();
    exit if ($yes ne 'yes');
    
    print "\nWould you like to be prompted for each directory? (yes/no) ";
    $doprompt = &GetAnswer();
}

chdir($betalib) || die "Where did betalib go?";
opendir(BETALIB, ".") || die "Can't read . in betalib";
@betalibdirs = readdir BETALIB;
closedir(BETALIB);

foreach $dir (@betalibdirs) {
    next if ($dir eq ".");
    next if ($dir eq "..");
    if ($dir eq "export") {
	print "---- Skipping $dir...\n";
	next;
    }
    $basedir = "$betalib/$dir";
    next if (!-d &path($basedir));
    if (!$UseDefaults && $doprompt eq "yes"){
	print "\nRecursively $verb write-permission for\n";	
	print "all files and directories in \n";
	print "  $basedir? (y/n/q) ";
	$answer = &GetAnswer();
	if ($answer eq "y"){
	    # just go on
	} elsif ($answer eq "n"){
	    next;
	} elsif ($answer eq "q"){
	    exit 0;
	}
    } else {
	print "**** Changing permissions in $basedir\n";
    }
    chdir(&path($basedir)) || die "cannot chdir($basedir)";
    print "$command\n" if ($verbose);
    system "$command" if (!$simulate);
    exit(1) if ($?);
}
