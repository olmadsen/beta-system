#!/usr/local/bin/perl5
#-*-Perl-*-

#----- configuration

$betalib=$ENV{'BETALIB'}  || "/users/beta";
$betalib =~ s#\\#/#g;

$RELEASE="r4.0";
$BETARUN="v2.9";
$COMPILER="v5.2";

$dirs=require "$betalib/bin/admin/dirlist4.0";

# add some directories if needed
# the folowing dirs are not included in dirs4.0, since
# not all files are in a state where they can be compiled.
# And since dirs4.0 is used by compile4.0 etc. they are left 
# out from dirs4.0, but included here.

$dirs .= "\
designlib/v2.2 \
designenv/v2.2 \
gpp/v2.2 \
freja/v2.2 \
system/v5.2 \
demo/r4.0/beta \
demo/r4.0/tutorial \
configuration/r4.0 \
";

if ($MACHINETYPE eq "NTI"){
    # windows
    $command="attrib +r /s *";
} else {
    # unix
    $command='find . -follow -type f -print -exec chmod a-w \{\} \;';
}

#--------- don't change below 

print  "This script will recursively remove write-permission for\n";
print  "all executable files and plain files in MBS $RELEASE:\n\n";

foreach $dir (split ' ', $dirs) {
    if (-d "$betalib/$dir") {
	print "$dir\n";
    } else {
	print "$dir   -- does not exist\n";
    }
}

print "\nAre you sure that you want to recursively remove write-permission for\n";
print "all executable files and plain files in these directories? (no/yes) ";

$yes = <STDIN>;
chop $yes;
exit if ($yes ne 'yes');

print "Really sure? ";
$yes = <STDIN>;
chop $yes;
exit if ($yes ne 'yes');

print "\nWould you like to be prompted for each directory? (yes/no) ";
$doprompt = <STDIN>;
chop $doprompt;

foreach $dir (split ' ', $dirs) {
    ($basedir ="$betalib/$dir") =~ s#/$##;
    next if (! -d $basedir);
    if ($doprompt eq "yes"){
	print "\nRecursively remove write-permission for\n";	
	print "all executable files and plain files in \n";
	print "  $basedir? (y/n/q) ";
	$answer=<STDIN>;
	chop $answer;
	if ($answer eq "y"){
	    # just go on
	} elsif ($answer eq "n"){
	    next;
	} elsif ($answer eq "q"){
	    exit 0;
	}
    } else {
	print "*********** Changing permissions in $basedir ***************\n";
    }
    chdir("$basedir") || die "cannot chdir($basedir)";
    print "$command\n";
    system "$command";
}
	    

print "REMEMBER manual freeze of\n";
print "   ~beta/betarun/$BETARUN\n";
