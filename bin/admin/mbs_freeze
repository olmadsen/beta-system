#!/usr/local/bin/perl5 -s
#-*-Perl-*-

push(@INC, $ENV{'BETALIB'} . "/bin/admin");

if ($h){
    print "Usage: mbs_freeze [-h][-u]\n";
    print "          -h   Print this help\n";
    print "          -v   Verbose output\n";
    print "          -n   No effects - only print what would be done\n";
    print "          -u   Use defaults - ask no questions\n";
    print "       Remove write permission for all files in BETALIB.\n";
    exit 0;
}

require "dirlist";

if ($MACHINETYPE eq "NTI"){
    # windows
    $command="attrib +r /s .";
} else {
    # unix
    $command='chmod -Rf a-w .';
}

#--------- don't change below 

if (!$UseDefaults) {
    print "This script will recursively remove write-permission for\n";
    print "all files and directories in MBS $RELEASE.\n\n";
    print "Only simulating, though...\n\n" if ($simulate);
    print "Are you sure that you want to do this? (no/yes) ";
    
    $yes = &GetAnswer();
    exit if ($yes ne 'yes');
    
    print "\nWould you like to be prompted for each directory? (yes/no) ";
    $doprompt = &GetAnswer();
}

foreach $dir (@Dirs) {
    if ($dir eq "export") {
	print "---- Skipping $dir...\n";
	next;
    }
    $basedir = "$betalib/$dir";
    next if (!-d &path($basedir));
    if (!$UseDefaults && $doprompt eq "yes"){
	print "\nRecursively remove write-permission for\n";	
	print "all files and directories in \n";
	print "  $basedir? (y/n/q) ";
	$answer = &GetAnswer();
	if ($answer eq "y"){
	    # just go on
	} elsif ($answer eq "n"){
	    next;
	} elsif ($answer eq "q"){
	    exit 0;
	}
    } else {
	print "**** Changing permissions in $basedir\n";
    }
    chdir(&path($basedir)) || die "cannot chdir($basedir)";
    print "$command\n" if ($verbose);
    system "$command" if (!$simulate);
    exit(1) if ($?);
}
