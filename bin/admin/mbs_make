#!/usr/local/bin/perl

# Script to compile betarun

$betalib = $ENV{"BETALIB"};
$betalib =~ s/\\/\//g;
if ($betalib eq "") { die "\$BETALIB is not set" }
$ENV{"BETALIB"} = $betalib;

$betarun_dir_name = "betarun";
# Delete this 1 line (it was put in for backwards compatibility 03-01-2002)
# $betarun_dir_name = "betarun-src" if ( -d "$betalib/betarun-src");
$betarun_dir = "$betalib/$betarun_dir_name";

$arch = $^O;
$make = "gmake";
$gnuc = "yes";
$gcc = "gcc";

# For some reason $Config{'archname'} doesn't work (is empty) on noatun...
if ($arch eq "solaris") {
  $is_little_endian = unpack("h*", pack("s", 1)) =~ /^1/;
  $arch = "x86sol" if ($is_little_endian);
}


if ($arch eq "darwin") {
  $arch = "macosx";
  $make = "/usr/bin/make";
  $runtype = "newrun";
} elsif ($arch =~ /win/i) {
  $arch = "nti_" . $ENV{"MIASDK"};
  $arch =~ tr/A-Z/a-z/;
  $runtype = "run";
  if ($arch eq "nti_ms") {
    $gnuc = "no";
    $gcc = "gcc-3";
    $make = "gnumake";
  } elsif ($arch eq "nti_gnu") {
    $make = "gnumake";
  } else {
    die "\$MIASDK is not set";
  }
} elsif ($arch eq "linux") {
  $make = "make";
  $runtype = "run";
} elsif ($arch eq "x86sol") {
  $make = "/usr/local/bin/make";
  $runtype = "run";
} elsif ($arch eq "irix") {
  $arch = "sgi";
  $runtype = "newrun";
  $gnuc = "no";
} elsif ($arch eq "solaris") {
  $arch = "sun4s";
  $runtype = "crun";
  if (-f "/usr/local/bin/make" && ! -f "/usr/local/bin/gmake" ) {
    $make="/usr/local/bin/make";
  }
} elsif ($arch eq "hpux") {
  $arch = "hpux9pa";
  $runtype = "crun";
} else {
  die "Couldn't recognise $arch as a valid BETA-supported architecture";
}

if ($ARGV[0] =~ /^--?V/ ||
    $ARGV[0] =~ /^--?h/ ||
    $ARGV[0] =~ /^--?u/) {
    print stderr "mbs_make: Make betarun runtime system\n";
    print stderr "\n";
    print stderr "Directory layout:\n";
    print stderr " |-\$BETALIB              # top level betarun dir\n";
    print stderr "   |-betarun              # betarun source for all arch's\n";
    print stderr "     |-linux              # betarun object files per arch\n";
    print stderr "       |-debug            # debug betarun, C compiled with -g\n";
    print stderr "       |-nodebug          # normal betarun\n";
    print stderr "       |-novalhalla       # small betarun with no valhalla (debugger) support\n";
    print stderr "       |-nodebug_g        # normal betarun, C compiled with -g\n";
    print stderr "     |-sun4s\n";
    print stderr "       |-...\n";
    print stderr "\n";
    print stderr "Targets (parameters)\n";
    print stderr "nodebug debug nodebug_g novalhalla ugc (uconditional GC)\n";
    exit 1;
}


print "Building betarun on $arch\n";

if ($ENV{"GNUMAKE"} eq "") {
  $ENV{"GNUMAKE"} = $make;
  print "Using $make for GNU make.  Set GNUMAKE in environment to change this.\n";
} else {
  print "Using value of GNUMAKE from environment ($ENV{GNUMAKE}) instead of $make\n";
  $make = $ENV{"GNUMAKE"};
}

chdir($betalib) || die "Couldn't change directory to BETALIB ($betalib)";

mkdir ("betarun", 0777) if (! -d "betarun");
if (! -d "betarun/GEN" && $betarun_dir_name ne "betarun") {
    # If you fall over this on a non-unix system, get rid of betarun-src -
    # you are supposed to have betarun checked out in $betalib/betarun now
    symlink ("../$betarun_dir_name/GEN", "betarun/GEN")
}

mkdir("lib", 0777);
mkdir("lib/$arch", 0777);
mkdir("betarun/$arch", 0777);

foreach $arg (@ARGV) {
    if ($arg !~ /^\s*$/) {
	push @args, $arg;
    }
}

if ($#args < 0) {
    push @args, "all";
}

print join(" ", ("$make", '-f', $betarun_dir . '/Makefile-toplev', "BETARUN=$betarun_dir", "ARCH=$arch", "RUNTYPE=$runtype", "GNUC=$gnuc", @args, "\n"));
chdir("betarun/$arch") || die "Couldn't change directory to betarun/$arch";

system($make, '-f', $betarun_dir . '/Makefile-toplev', "BETARUN=$betarun_dir", "ARCH=$arch", "RUNTYPE=$runtype", "GNUC=$gnuc", "GCC=$gcc",@args) && die("Failed to start $make -f $betarun_dir/Makefile-toplev ...");
