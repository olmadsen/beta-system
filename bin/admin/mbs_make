#! /usr/local/bin/perl

# Script to compile betarun

$betalib = $ENV{"BETALIB"};
$betalib =~ s/\\/\//g;
if ($betalib eq "") { die "\$BETALIB is not set" }

$betarun_dir = $betalib . "/betarun/";

$arch = $^O;
$make = "gmake";

if ($arch =~ /win/i) {
  $arch = "nti_" . $ENV{"MIA_SDK"};
  $arch =~ tr/A-Z/a-z/;
  $arch eq "nti_ms" || $arch eq "nti_gnu" || die "\$MIA_SDK is not set";
} elsif ($arch eq "linux") {
  $make = "make";
} elsif ($arch eq "irix") {
  $arch = "sgi";
} elsif ($arch eq "solaris") {
  $arch = "sun4s";
} elsif ($arch eq "hpux") {
  $arch = "hpux9pa";
} else {
  die "Couldn't recognise $arch as a valid BETA-supported architecture";
}

print "Building betarun on $arch\n";

if ($ENV{"GNUMAKE"} eq "") {
  $ENV{"GNUMAKE"} = $make;
  print "Using $make for GNU make.  Set GNUMAKE in environment to change this.\n";
} else {
  print "Using value of GNUMAKE from environment ($ENV{GNUMAKE}) instead of $make\n";
  $make = $ENV{"GNUMAKE"};
}

chdir($betalib) || die "Couldn't change directory to BETALIN ($betalib)";

mkdir("betarun-$arch", 0777);

chdir("betarun-$arch") || die "Couldn't change directory to betarun-$arch";

mkdir("debug", 0777);
mkdir("nodebug", 0777);
mkdir("nodebug-g", 0777);

exec "$make", '-f', '../betarun/Makefile-toplev', @ARGV;

die("Failed to start $make -f ../betarun/Makefile-toplev ...");
