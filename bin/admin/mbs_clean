#! /usr/local/bin/perl
#-*-Perl-*-

$betalib=$ENV{'BETALIB'}  || die "BETALIB must be set!\n";
$betalib =~ s#\\#/#g;

$dirs=require "$betalib/bin/admin/dirlist";

$match='(\~$)|(^\#.*\#$)|(\.lst$)|(\.\.job$)|(\.dump$)|(\.\.gs$)|(\.\.s$)|(\.\.dbc$)';

print "$MACHINETYPE\n";
if ("$MACHINETYPE" eq "NTI"){
    $match .= '|(\.rr$)|(\.ro$)|(\.pdb$)|(\.ilk$)|(\.rsp$)';
}

print "This script will recursively remove files matching \n  $match\nfrom $RELEASE.\n\n";

print "Are you sure that you want to do this (no/yes) ";

$yes = <STDIN>;
chop $yes;
exit if ($yes ne 'yes');

print "Really sure? ";
$yes = <STDIN>;
chop $yes;
exit if ($yes ne 'yes');

print "\nWould you like to be prompted for each directory? (yes/no) ";
$doprompt = <STDIN>;
chop $doprompt;

foreach $dir (split(' ', $dirs)) {
    ($basedir ="$betalib/$dir") =~ s#/$##;
    next if (! -d $basedir);
    if ($doprompt eq "yes"){
	print  "Recursively remove files matching\n\t$match\n";
	print "  from $basedir? (y/n/q) ";
	$answer=<STDIN>;
	chop $answer;
	if ($answer eq "y"){
	    # just go on
	} elsif ($answer eq "n"){
	    next;
	} elsif ($answer eq "q"){
	    exit 0;
	}
    } else {
	print "**** Removing from $basedir ****\n";
    }
    @todo=('.');
    ($basedir ="$betalib/$dir") =~ s#/$##;
    next if (! -d $basedir);
    while ($curdir = pop @todo) {
	$curdir .= '/';
	$curdir =~ s#^\./$##;
	$ntdirfix = "$basedir/$curdir";
	#$ntdirfix =~ s/^.\://;
	#$ntdirfix =~ s#\/#\\#g;
	#print "Scanning $ntdirfix\n";
	chdir $ntdirfix || die "Unable to chdir: $!";
	opendir(DIR, '.') || die "Unable to readdir $!";
	@files=readdir(DIR);
	closedir DIR;
	foreach $file (@files) {
	    next if ($file =~ /^\./);
	    if (-d $file) {
		push(@todo, "$curdir$file");
		#print "Pushing $file\n";
	    }
	    elsif ($file =~ /$match/) {
		print "$file\n";
		unlink $file || print "Unable to delete file $file\n";
	    }
	}
    }
}
