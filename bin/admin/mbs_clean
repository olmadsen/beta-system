#!/usr/local/bin/perl -s
#-*-Perl-*-

push(@INC, $ENV{'BETALIB'} . "/bin/admin");

require "dirlist";

# Do _not_ remove objectfiles, etc.  Only remove real garbage ;)

$basematch='(\~$)|(^\#.*\#$)|(\.lst$)|(\.\.job$)|(\.\.gs$)|(\.\.s$)|(\.\.dbc$)|(\.s\.db$)';

if ("$MACHINETYPE" eq "NTI"){
    $basematch .= '|(\.rr$)|(\.ro$)|(\.pdb$)|(\.ilk$)|(\.rsp$)';
}

$UseDefaults = 1 if ($u);
$basematch = $basematch . '|(untitled)' if ($f);
$basematch = $basematch . '|(\.recentProject\.pjt$)' if ($r);

$match = $basematch . '|(\.dump$)'; # for print outs

if ($h){
    print "Usage: mbs_clean [-h][-u]\n";
    print "          -h   Print this help\n";
    print "          -v   Verbose output\n";
    print "          -n   No effects - only print what would be done\n";
    print "          -f   Remove 'untitled.*' files too\n";
    print "          -r   Remove '.recentProject.pjt' files too\n";
    print "          -u   Use defaults - ask no questions\n";
    print "       Remove garbage files from BETALIB:\n";
    print "       $basematch\n";
    exit 0;
}

if (!$UseDefaults) {
    print "This script will recursively remove files matching \n  $match\nfrom $RELEASE.\n\n";
    
    print "Are you sure that you want to do this (no/yes) ";
    
    $yes = &GetAnswer();
    exit if ($yes ne 'yes');
    
    print "\nWould you like to be prompted for each directory? (yes/no) ";
    $doprompt = &GetAnswer();
}

foreach $dir (@Dirs) {
    $basedir = "$betalib/$dir";
    next if (!-d &path($basedir));
    if (!$UseDefaults && $doprompt eq "yes") {
	print  "Recursively remove files matching\n\t$match\n";
	print "  from $basedir? (y/n/q) ";
	$answer = &GetAnswer();
	if ($answer eq "y"){
	    # just go on
	} elsif ($answer eq "n"){
	    next;
	} elsif ($answer eq "q"){
	    exit 0;
	}
    } else {
	print "**** Removing from $basedir ****\n";
    }
    if ($dir =~ /(betarun|compiler|TST)/){
	print 
	    "  [.dump files kept - TST/tstdump contains a number of " .
	    "reference .dump file]\n";
	$match = $basematch;
    } else {
	$match = $basematch . '|(\.dump$)'; 
    }
    foreach $curdir (&GetDirsRecursively($basedir)) {
	@files = &GetFilesInDirs($curdir);
	foreach $file (@files) {
	    if ($file =~ /$match/) {
		print "$file\n";
		if (!$simulate) {
		    unlink $file || print "Unable to delete file $file\n";
		}
	    }
	}
    }
}
