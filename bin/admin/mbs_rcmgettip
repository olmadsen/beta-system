#! /usr/local/bin/perl

# Script to get latest version of the compiler checked-out
# to the directory where $BETALIB points. Assumes that a
# script: server_rcmgettip.pl is installed on the server side that
# 1) Ask rcm to get at tip checked out 2) Zips the result
# into a zipfile.

# Original Author: Henrik Bærbak Christensen, Year 2000
# Permission is hereby granted to hack this as you like :)

# WARNING: THE COMPILER COPY MADE USING THIS SCRIPT IS A READ-ONLY
# COPY OF THE COMPILER. AS RCM CANNOT TRACK CHANGES IN A WORKSPACE
# NOT UNDER ITS DIRECT CONTROL, YOU CANNOT CHECK-IN CHANGES YOU
# MAKE IN IT!

# Remember that ssh and scp needs the env $HOME to be set.

$betalib = $ENV{BETALIB};
$betalib =~ s/\\/\//g;
if ($betalib eq "") { die "\$BETALIB is not set" }

$rcmcommand = '818';	# get specific version. 
#$rcmcommand = '';	# Do gettip.

$rcmserver = "alex.daimi.au.dk";

$betacompiler_dir = $betalib . "/compiler/";

chdir $betacompiler_dir or 
    (mkdir ($betacompiler_dir, 0755) and chdir $betacompiler_dir) or 
    die "0: Could not change to directory: ".$betacompiler_dir."\n";

if (-e ".Ragn.wst") {
    print "Running rcm locally\n";
    system 'rcm -do "$rcmcommand;q"';
    return 1;
}

if (!defined($ENV{'HOME'})){
    print "Warning: Environment variable HOME is not set.\n";
    print "SSH needs a place to put a directory with temporary files.\n";
    print "OK to use C:\\ for this? [y]/n ";
    $answer=<STDIN>;
    if ("$answer" eq "n"){
	print "Please set HOME and start again.\n";
	exit 1;
    } else {
	$ENV{'HOME'} = "C:\\";
    }
}

print STDERR "Executing ssh -l beta $rcmserver:\n" ;
$result = `ssh -l beta $rcmserver /users/beta/bin/admin/rcm_servergettip $rcmcommand`;

if ($result !~ /1: OK/) {
    warn "mbs_rcmgettip: Server side problems, try again later...\n";
    return 1;
}

print STDERR "Copying ZIP file from $rcmserver with scp:\n";
$result = `scp beta\@$rcmserver:/users/beta/compiler.src/PACK.zip PACK.zip`;

if (! -e "PACK.zip") {
    die "0: Remote copy failed. Output from command:\n".$result;
}

chdir $betalib or {
    die "Cannot change to \$BETALIB:".$betalib
};

`unzip -oaq compiler/PACK.zip`;
unlink "compiler/PACK.zip";


