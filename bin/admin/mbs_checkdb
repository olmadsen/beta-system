#!/usr/local/bin/perl5 -s
#-*-Perl-*-

push(@INC, $ENV{'BETALIB'} . "/bin/admin");

if ($h){
    print "Usage: mbs_checkdb [-h] [dirs]\n";
    print "          -h   Print this help\n";
    print "          -v   Verbose output\n";
    print "          -n   No effects - only print what would be done\n";
    print "       Checks that .db file is present for each .bet file in dirs (default BETALIB)\n";
    exit 0;
}

if ($#ARGV>-1){
    require "env.perl";
    @Dirs = @ARGV;
    print "Checking that .db file is present for each .bet file in ";
    print join ' ', @Dirs;
    print "\n";
} else {
    require "dirlist";
    print "Checking that .db file is present for each .bet file in $RELEASE\n";
}

$match="\.bet\$";
    
foreach $dir (@Dirs) 
{
    next if ($dir =~ /betarun/);
    next if ($dir =~ /compiler/);
    if ($#ARGV>-1){
	$basedir = $dir;
    } else { 
	# next if (!$CompileFlag{$dir});
	$basedir = "$betalib/$dir";
    }
    next if (!-d &path($basedir));
    print "*** Checking $basedir ***\n";
    foreach $curdir (&GetDirsRecursively($basedir)) {
	$curdir =~ s/\\/\//g;
	if ($curdir =~ /\/demo\//) {
	    print "  [skipped $curdir]\n" if ($verbose);
	    next;
	}
	@files = &GetFilesInDirs($curdir);
	foreach $file (@files) {
	    $file =~ s/\\/\//g;
	    next if (!($file =~ /$match/));
	    if ($file =~ /^$curdir\/(.*)$/) {
		$file = $1;
	    } else {
		print "Cannot find $curdir in $file\n";
	    }
	    foreach $type (@ObjDirs) {
		next if ($type eq "hpux9pa");
		$dir = "$curdir/$type";
		next if (!-d $dir);
		($basefile = "$curdir/$file") =~ s/$match//g;
		$astfile   = "$basefile.$AstExt{$type}";
		($basefile = "$dir/$file") =~ s/$match//g;
		$objfile   = "$basefile.$ObjExt{$type}";
		$dbfile    = "$basefile.db";
		if (-f "$objfile"){
		    if ((-M "$astfile") >= (-M "$objfile")){
			# object file is not as old as astfile, i.e. up-to-date
			if (-f "$dbfile") {
			    if ((-M "$astfile") < (-M "$dbfile")){
				# db file older than ast file
				$numerrs++;
				print "ERROR#$numerrs: db file too old:\n  $dbfile\n";
				#printf("  (%.8g < %.8g)\n", -M "$astfile", -M "$dbfile");
				if ($debug){
				    printf "$astfile: %.8g\n", (-M $astfile);
				    printf "$objfile: %.8g\n", (-M $objfile);
				    printf "$dbfile: %.8g\n", (-M $dbfile);
				}
			    }
			} else {
			    $numerrs++;
			    print "ERROR#$numerrs: Missing db file:\n  $dbfile\n";
			}
		    } else {
			$numerrs++;
			print "ERROR#$numerrs: object file too old:\n  $objfile\n";
		    }
		} 
	    }
	}
    }
}

if ($numerrs > 0) {
    print "\n$numerrs errors found.\n";
} else {
    print "\nNo errors found.\n";
}

1;
