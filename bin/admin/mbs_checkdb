#!/usr/local/bin/perl5 -s
#-*-Perl-*-

require "dirlist";

print "Checking that .db file is present for each .bet file in $RELEASE\n";

$match="\.bet\$";
    
foreach $dir (@Dirs) 
{
    next if ($dir =~ /betarun/);
    next if ($dir =~ /compiler/);
    # next if (!$CompileFlag{$dir});
    $basedir = "$betalib/$dir";
    next if (!-d &path($basedir));
    print "*** Checking $basedir ***\n";
    foreach $curdir (&GetDirsRecursively($basedir)) {
	$curdir =~ s/\\/\//g;
	if ($curdir =~ /\/demo\//) {
	    print "  [skipped $curdir]\n" if ($verbose);
	    next;
	}
	@files = &GetFilesInDirs($curdir);
	foreach $file (@files) {
	    $file =~ s/\\/\//g;
	    next if (!($file =~ /$match/));
	    if ($file =~ /^$curdir\/(.*)$/) {
		$file = $1;
	    } else {
		print "Cannot find $curdir in $file\n";
	    }
	    foreach $type (@ObjDirs) {
		next if ($type eq "hpux9pa");
		$dir = "$curdir/$type";
		next if (!-d $dir);
		($basefile = "$curdir/$file") =~ s/$match//g;
		$astfile  = "$basefile.$AstExt{$type}";
		($basefile = "$dir/$file") =~ s/$match//g;
		$objfile   = "$basefile.$ObjExt{$type}";
		$dbfile    = "$basefile.db";
		if (-f "$objfile"){
		    if ((-M $astfile) <= (-M $objfile)){
			# object file is up-to-date. Check db file
			if (-f "$dbfile") {
			    if ((-M "$astfile") < (-M "$dbfile")){
				$numerrs++;
				print "ERROR#$numerrs: db file too old:\n  $dbfile\n";
				#printf("  (%.8g < %.8g)\n", -M "$astfile", -M "$dbfile");
			    }
			} else {
			    $numerrs++;
			    print "ERROR#$numerrs: Missing db file:\n  $dbfile\n";
			}
		    } 
		}
	    }
	}
    }
}

if ($numerrs > 0) {
    print "\n$numerrs errors found.\n";
} else {
    print "\nNo errors found.\n";
}

1;
