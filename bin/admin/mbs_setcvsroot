#!/usr/local/bin/perl5 -s
#-*-Perl-*-

push(@INC, $ENV{'BETALIB'} . "/bin/admin");

if ($h){
    print "Usage: mbs_setcvsroot [-h][-u]\n";
    print "          -h   Print this help\n";
    print "          -v   Verbose output\n";
    print "          -n   No effects - only print what would be done\n";
    print "          -u   Use defaults - ask no questions\n";
    print "       Change CVSROOT in all CVS directories in BETALIB\n";
    exit 0;
}


$UseDefaults = 1 if ($u);

require "dirlist";

if ($FromAnotherScript && $NewCVSRoot) {
    $doprompt = 'n';
} else {
    print "This script will recursively change all CVSROOT files in $betalib.\n\n";

    print "Do you want to do this? (no/yes) ";

    $yes = &GetAnswer();
    exit if ($yes ne 'yes');

    # Get rid of trailing spaces!
    $ENV{'CVSROOT'} =~ s/\s+$//;

    print "Change the CVSROOT to what? ";
    if (defined $ENV{'CVSROOT'}) {
	print "(default \"", $ENV{'CVSROOT'}, "\")";
    }
    $NewCVSRoot = &GetAnswer();
    print "\n\"$NewCVSRoot\"\n";
    if ($NewCVSRoot =~ /^$/) {
	if (defined $ENV{'CVSROOT'}) {
	    $NewCVSRoot = $ENV{'CVSROOT'};
	} else {
	    print "Will not set empty root\n";
	    exit;
	}
    }
    print "\n\"$NewCVSRoot\"\n";
}

foreach $dir (@Dirs) {
    $basedir = "$betalib/$dir";
    next if (!-d &path($basedir));
    print "*********** Changing $basedir ***************\n";
    foreach $curdir (&GetDirsRecursively($basedir)) {
	if ($curdir =~ /CVS/) {
	    if (open (ROOT, "<$curdir/Root")) {
		$line=<ROOT>;
		close ROOT;
		if ($line =~ /\/users\/beta\/\.CVSHOME/) {
		    open(ROOT, ">$curdir/Root") || die "Unable to write: $!";
		    print ROOT "$NewCVSRoot\n";
		} else {
		    print "[Skipping, not from /users/beta/.CVSHOME]\n";
		}
	    } else {
		print "Unable to open $curdir/Root: $!";
	    }
	}
    }
}
	    
1;
