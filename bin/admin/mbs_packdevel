#!/usr/local/bin/perl5 -s
#-*-Perl-*-

require "dirlist";

sub help {
    print "Usage: $0 [-bscnuv] machinetype+\n\n";
    print "-b   Pack bootpackage only.(betarun,bin,configuration,grammars)\n";
    print "-e   Pack easy-update only. (betarun,bin,compiler,grammars)\n";
    print "-f   Pack full system.  Rather large.\n";
    print "-s   Pack separate package for each machinetype.\n";
    print "\n";
    print "Give a number of machinetypes as argument.\n";
}

sub ConstructExtraDirs {
    $targetstring = "@_";
    @ExtraDirs =();
    if ($targetstring =~ /sgi/) {
	push (@ExtraDirs, 'lib/sgi');
    }
}

sub ExcludeByDirectory {
    if ($dir =~ /grammar/i) {
	$exludepat = "\\.(lst|dump|asm|bat|job|gz)\$";
    } elsif ($dir =~ /betarun/) {
	$exludepat = "\\.(ast[lL]?|db|lst|dump|asm|bat|job|gz)\$";
    } else {
	$exludepat = "\\.(o|obj|db|ast[lL]?|lst|dump|asm|bat|job|gz)\$";
    }
};

@ExcludeDirs = ('demo', 'export', 'doc', 'oodb');

sub packone {
    @targetlist = @_;
    undef @filelist;
    undef %packeddirs;
    $totalsize = 0;

    print "Now packing for machinetypes @targetlist...\n";
    &ConstructExtraDirs(@targetlist);
    Chdir($betalib);
DIR:
    foreach $dir (sort (@ExtraDirs, @PackDirs)) {
	foreach $ex (@ExcludeDirs) {
	    next DIR if ($dir =~ /^$ex/);
	}
	print "\r                                          ";
	print "\rScanning $dir...";
	if ($dir =~ /^([^\/]+)\/?/) {
	    $prefix = $1;
	    if (defined $packeddirs{$prefix}) {
		print " [Skipping $dir]\n" if ($verbose);
		next;
	    }
	} else {
	    print "Unable to find prefix in $dir\n";
	    exit 1;
	}
	$packeddirs{$dir} = 1;
	$basedir = "$betalib/$dir";
	&ExcludeByDirectory;
	foreach $curdir (sort &GetDirsRecursively($basedir)) {
	    $include = 0;
	    foreach $target (@targetlist) {
		if ($curdir =~ m/$target/) {		
		    $include = 1;
		}
	    }
	    if ($include == 0) {
		$include = 1;
		foreach $target (@ObjDirs) {
		    if ($curdir =~ /$target/) {		
			$include = 0;
		    }
		}
	    }
	    if ($include) {
		if ($dir eq 'bin' or $dir =~ /^lib/) {
		    $maxsize = 1024*1024*1024;
		} else {
		    $maxsize = 4*1024*1024;
	        }
	        @files = &GetFilesInDirs($curdir);
	        foreach $file (@files) {
                    next if ($file =~ /(.Ragn.wst)/i);
		    next if ($file =~ /\/\.\#/);
		    next if ($file =~ /\~$/);
		    $file =~ s/\\/\//g;	     
		    if ($file =~ /^$betalib\/(.*)$/) {
			$file ="./" . $1;
			next if ($file =~ /$exludepat/);
			if (-x $file) {
			    undef $oneup;
			    if ($curdir =~ /^(.*)\/[^\/]+\/(.*)$/) {
				$oneup = "$1/$2.bet";
			    }
			    if (-e "$file.bet" || -e $oneup) {
				if ($verbose) {
				    print "[Skipping executable $file]\n";
				}
				next;
			    }
			}
			if (-f $file) {
			    $size = -s $file;
			} else {
			    $size = 0;
			}
			if ($size > $maxsize) {
			    if ($verbose) {
				print "[Skipping large file $file]\n";
			    }
			    next;
			}
			$totalsize += $size;
			push (@filelist, $file);
		    } else {
			print "\nUnable to find BETALIB in $file\n";
			exit 1;
		    }
		}
	    }
	}
    }
    
    print "\nNumber of files found: $#filelist.  Total ";
    print int(($totalsize+(1024*1024)-1)/(1024*1024));
    print "MB.  Packing, please be patient...\n";
    if ($simulate) {
        print "Simualting only, skipping packing fase\n\n";
        return;
    }
    
    $outputfile = $outputfilebase;
    foreach $target (@targetlist) {
	$outputfile .= $target . "-";
    }
    chop $outputfile;
    
    $donesize = 0;
    if ($OS eq 'WIN') {
	open (TAR, "|zip -q -@ $outputfile.zip");
    } else {
	open (TAR, "|gtar -czf $outputfile.tar.gz -T -");
    }
    select(TAR); $| = 1;       # make unbuffered
    select(STDOUT); 
    @filelist = sort @filelist;
    for ($i = 0; $i < $#filelist; $i++) {
	$file  = $filelist[$i];
	if (-f $file) {
	    $donesize += -s $file;
	}
	print  "\r", int(100*$donesize/$totalsize), "%";
	print TAR "$file\n";
    }
    print "\r100%.  Closing tar/zip. This may take a while...";
    close TAR;
    print "\nPackage ready at $betalib/$outputfile.tar.gz\n";
}

sub packit {
    if ($separate) {
	foreach $arg (@ARGV) {
	    &packone($arg);
	}
    } else {
	&packone(@ARGV);
    }
}



# --- PROGRAM:DESCRIPTOR ---
$packboot = 1 if (defined $b);
$packeasy = 1 if (defined $e);
$packfull = 1 if (defined $f);
$separate = 1 if (defined $s);

if ($#ARGV == -1) {
    &help;
    exit 1;
}

foreach $target (@ARGV) {
    if (($target != "\L$target") or !LegalMach("\U$target")) {
	print "$0: $target is not a valid machinetype.\n\n";
	&help;
	exit 1;
    }
}

if ($packeasy) {
    print "Packing easy-update:\n";
    @PackDirs = ('bin', 'compiler', 'betarun', 'grammars');
    $outputfilebase = 'updatesystem-';
    &packit;
}
if ($packboot) {
    print "Packing bootpack:\n";
    @PackDirs = ('bin', 'configuration', 'grammars', 'betarun');
    $outputfilebase = 'bootsystem-';
    &packit;
}
if ($packfull) {
    print "Packing complete development pack:\n";
    @PackDirs = @Dirs;
    $outputfilebase = 'completesystem-';
    &packit;
}


1;


