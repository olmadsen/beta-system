#!/usr/local/bin/perl5 -s
#-*-Perl-*-

require "dirlist";

sub help {
    print "Usage: $0 [-bscnuv] machinetype+\n\n";
    print "-b   Pack bootpackage only.\n";
    print "-s   Pack separate package for each machinetype.\n";
    print "\n";
    print "Give a number of machinetypes as argument.\n";
}

sub ConstructExtraDirs {
    $targetstring = "@_";
    @ExtraDirs =();
    if ($targetstring =~ /sgi/) {
	push (@ExtraDirs, 'lib/sgi');
    }
}

@ExcludeDirs = ('demo', 'export', 'doc', 'oodb');

sub packit {
    @targetlist = @_;
    &ConstructExtraDirs(@targetlist);
    print "\nNow packing for machinetypes @targetlist...\n";
    undef %packeddirs;
    $totalsize = 0;
    Chdir($betalib);
DIR:
    foreach $dir (@ExtraDirs, @Dirs) {
	foreach $ex (@ExcludeDirs) {
	    next DIR if ($dir eq $ex);
	}
	print "\r                                          ";
	print "\rScanning $dir...";
	if ($dir =~ /^([^\/]+)\/?/) {
	    $prefix = $1;
	    if (defined $packeddirs{$prefix}) {
		print " [Skipping $dir]\n" if ($verbose);
		next;
	    }
	} else {
	    print "Unable to find prefix in $dir\n";
	    exit 1;
	}
	$packeddirs{$dir} = 1;
	$basedir = "$betalib/$dir";
	foreach $curdir (&GetDirsRecursively($basedir)) {
	    $include = 0;
	    foreach $target (@targetlist) {
		if ($curdir =~ m/$target/) {		
		    $include = 1;
		}
	    }
	    if ($include == 0) {
		$include = 1;
		foreach $target (@ObjDirs) {
		    if ($curdir =~ /$target/) {		
			$include = 0;
		    }
		}
	    }
	    if ($include) {
		if ($curdir =~ /grammar/i) {
		    $exludepat = '\.(lst|dump|asm|bat|job|gz)$';
                } elsif ($curdir =~ /betarun/) {
		    $exludepat = '\.(ast[lL]?|db|lst|dump|asm|bat|job|gz)$';
		} else {
		    $exludepat = '\.(o|obj|db|ast[lL]?|lst|dump|asm|bat|job|gz)$';
	        }
		if ($dir eq 'bin' or $dir =~ /^lib/) {
		    $maxsize = 1024*1024*1024;
		} else {
		    $maxsize = 1024*1024;
		}
	        @files = &GetFilesInDirs($curdir);
	        foreach $file (@files) {
                    next if ($file =~ /(.Ragn.wst)|(^\.\#)|(\~$)/);
		    if ($file =~ /^$betalib\/(.*)$/) {
			$file ="./" . $1;
			next if ($file =~ /$exludepat/);
			if (-x $file) {
			    undef $oneup;
			    if ($curdir =~ /^(.*)\/[^\/]+\/(.*)$/) {
				$oneup = "$1/$2.bet";
			    }
			    if (-e "$file.bet" || -e $oneup) {
				if ($verbose) {
				    print "[Skipping executable $file]\n";
				}
				next;
			    }
			}
			if (-f $file) {
			    $size = -s $file;
			} else {
			    $size = 0;
			}
			if ($size > $maxsize) {
			    if ($verbose) {
				print "[Skipping large file $file]\n";
			    }
			    next;
			}
			$totalsize += $size;
			push (@filelist, $file);
		    } else {
			print "\nUnable to find BETALIB in $file\n";
			exit 1;
		    }
		}
	    }
	}
    }
    print "\nNumber of files found: $#filelist.  Total ";
    print int(($totalsize+(1024*1024)-1)/(1024*1024));
    print "MB.  Packing, please be patient...\n";
    if ($simulate) {
        print "Simualting only, skipping packing fase\n\n";
        return;
    }
    
    if ($packboot) {
        $outputfile = "bootsystem-";
    } else {
        $outputfile = "devsystem-";
    }
    foreach $target (@ARGV) {
	$outputfile .= $target . "-";
    }
    chop $outputfile;
    
    $donesize = 0;
    open (TAR, "|gtar -czf $outputfile.tar.gz -T -");
    for ($i = 0; $i < $#filelist; $i++) {
	$file  = $filelist[$i];
	if (-f $file) {
	    $donesize += -s $file;
	}
	print  "\r", int(100*$donesize/$totalsize), "%";
	print TAR "$file\n";
    }
    print "\r100%\nPackage ready at $betalib/$outputfile.tar.gz\n";
}


# --- PROGRAM:DESCRIPTOR ---
$packboot = 1 if (defined $b);
$separate = 1 if (defined $s);

if ($#ARGV == -1) {
    &help;
    exit 1;
}

foreach $target (@ARGV) {
    if (($target != "\L$target") or !LegalMach("\U$target")) {
	print "$0: $target is not a valid machinetype.\n\n";
	&help;
	exit 1;
    }
}

if ($packboot) {
    print "Packing bootpack only\n";
    @Dirs = ('bin', 'configuration', 'grammars', 'betarun');
} else {
    print "Packing complete development pack\n";
}

if ($separate) {
    foreach $arg (@ARGV) {
	&packit($arg);
    }
} else {
    &packit(@ARGV);
}

1;

