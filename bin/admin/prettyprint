#!/usr/local/bin/perl5 -s

# Prettyprint argument file(s) using BETA pretty printer,
# but correct some details in the output.
# Automatically backs up old .bet file.
# 
# usage: prettyprint file

while ($file=shift){

    if ( ! -e $file ){
	print "$0: no such file: $file\n";
	next;
    }
    
    # delete extension
    $file =~ s/\.bet$//i;
    $file =~ s/\.ast$//i;
    $file =~ s/\.astL$//i;
    
    print "$file.bet\n";
    
    # start BETA prettyprinter on $file and read it into $line
    $betalib=$ENV{'BETALIB'} || die "BETALIB not set\n";
    open(PP, "$betalib/bin/pp -w 80 $file |") || die "cannot start $betalib/bin/pp\n";
    $line="";
    while (<PP>){ $line.=$_; }
    $_=$line;
    
    # correct: too many spaces after '(#'
    s/\(# +/(# /g;
    # correct: too many spaces after ';'
    s/; +/; /g;
    # correct: blank lines and spaces after 'do'(except for emptydopart slot)
    s/\bdo\b\s+([^-])/do \1/gi;
    # correct: SLOTS should not be prettyprinted
    s/SLOTS '[^']*';*//g;

    # print file

    if ( -e "$file.bet" ){
	system("cp $file.bet $file.bet~");
    }

    open(FILE, ">$file.bet") || die "$0: cannot open $file.bet for writing\n";
    print FILE;
    close(FILE);
}
