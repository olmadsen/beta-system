#!/usr/local/bin/perl -s

use File::Copy;

push(@INC, $ENV{'BETALIB'} . "/bin/admin");

if ($h){
    print "Usage: mbs_boottrack [-h]\n";
    print "          -h   Print this help\n";
    print "          -g   Skip metagrammar boot and grammar tool compilation\n";
    print "          -r   Skip betarun build\n";
    print "          -a   Skip removal of asts before compiling libraries \n";
    print "               and tools (phase 2)\n";
    print "       Get a newly checked out BETA track working:\n";
    print "          Phase 1:\n";
    print "            1. boot metagrammar and beta grammar\n";
    print "               using boot grammar tools\n";
    print "            2. (windows) establish betacc.exe\n";
    print "            3. (linux/windows) create runtime generator\n";
    print "            4. generate betarun (unless -r)\n";
    print "            5. compile compiler using boot compiler\n";
    print "            6. (windows) recompile betacc.exe\n";
    print "            7. Generate metaprogramming tools (unless -g)\n";
    print "            8. boot all grammars using newly generated grammar tools\n";
    print "               (unless -g)\n";
    print "          Phase 2:\n";
    print "            1. remove all .ast(L) files from track except grammar asts\n";
    print "               (unless -a)\n";
    print "            2. compile all libraries\n";
    print "            3. compile all tools except compiler\n";

    exit 0;
}

require "env.perl";

$shortobjdir = $objdir;
$shortobjdir = "nti" if ($shortobjdir =~ /nti/);

$BETALIB = $ENV{'BETALIB'};

if (!$g) {

	chdir("$BETALIB/grammars/metagram") || die "Where is the BETALIB/grammars/metagram directory?";
	$grammarname = "metagrammar";
	do "$BETALIB/boot/grammars/bootbobsit.pl";
	do "$BETALIB/boot/grammars/bootdogram.pl";

	chdir("$BETALIB/grammars/beta") || die "Where is the BETALIB/grammars/beta directory?";
	$grammarname = "beta";
	do "$BETALIB/boot/grammars/bootdogram.pl";

}

if ($objdir =~ /nti/) {
    # On NTI we need to add this dir to the path so the compiler can find
    # betacc.  This is ugly, since we could pick up other stuff from the
    # boot dir inadvertently.  Better would be to add an option to beta
    # for specifying where betacc is.
    $savedpath = $ENV{'PATH'};
    if ($cygwin){
	if (! -f "$BETALIB/bin/$objdir/betacc.exe"){
	    print "Cygwin: copying betacc.exe from boot directory\n";
	    mkdir("$BETALIB/bin/$objdir", 0777) unless (-d "$BETALIB/bin/$objdir"); 
	    system "cp $BETALIB/boot/bin/$objdir/betacc.exe $BETALIB/bin/$objdir";
	    # Copy will be regenerated by mbs_compiletools
	}
    } else {

	$ENV{'PATH'} = "$BETALIB\\boot\\bin\\$objdir;" . $ENV{'PATH'};
    }
}

if (! $r && $RUNTYPE eq "run") {
    if (! $g) {
        chdir("$BETALIB/betarun/GEN/GRAMMAR") || die "Where is the BETALIB/betarun/GEN/GRAMMAR directory?";
	$grammarname = "runtime";
	do "$BETALIB/boot/grammars/bootdogram.pl";
    }
    chdir("$BETALIB/betarun/GEN/gas") || die "Where is the BETALIB/betarun/GEN/gas directory?";
    system("$BETALIB/boot/bin/$objdir/beta -qwlp --betarun $BETALIB/boot/bin/$objdir/betarun$BETARUNSUFFIX rungen") &&
        &compilingfailed("rungen", " (the RUN compiler)");
    if (! -d "$BETALIB/bin/$objdir") {
	mkdir("$BETALIB/bin/$objdir", 0777) || die "Couldn't make the directory for exe files ($BETALIB/bin/$objdir)\n";
    }
    copy("rungen$EXESUFFIX", "$BETALIB/bin/$objdir/rungen$EXESUFFIX") || die "Couldn't move rungen$EXESUFFIX over to $BETALIB/bin/$objdir/rungen$EXESUFFIX";
    chmod 0755, "$BETALIB/bin/$objdir/rungen$EXESUFFIX";
}

if (!$r) {
	system("mbs_make") && die("Couldn't make betarun\n");
}

chdir("$BETALIB/compiler") || die "Couldn't find compiler directory\n";

system("$BETALIB/boot/bin/$objdir/beta -qwl beta") &&
    &compilingfailed("beta", " (the BETA compiler)");

if (! -d "$BETALIB/bin/$objdir") {
    mkdir("$BETALIB/bin/$objdir", 0777) || die "Couldn't make the directory for exe files ($BETALIB/bin/$objdir)\n";
}

copy("beta$EXESUFFIX", "$BETALIB/bin/$objdir/beta$EXESUFFIX") || die "Couldn't move beta$EXESUFFIX over to $BETALIB/bin/$objdir/beta$EXESUFFIX";
chmod 0755, "$BETALIB/bin/$objdir/beta$EXESUFFIX";

if ($objdir =~ /nti/) {
    system("mbs_compiletools betacc") &&
        &compilingfailed("betacc", " (the BETA compiler helper)");
    $ENV{'PATH'} = $savedpath if ($savedpath ne "");
}

if (!$g) {
	system("mbs_compiletools exbobs") && &compilingfailed("exbobs", "");
	system("mbs_compiletools tabc") && &compilingfailed("tabc", "");
	system("mbs_compiletools gen") && &compilingfailed("gen", " (the grammar tool)");
	system("mbs_compiletools makepretty") && &compilingfailed("makepretty", "");
	system("mbs_compiletools morepretty") && &compilingfailed("morepretty", "");
	system("mbs_compiletools dogram") && &compilingfailed("dogram", "");

	chdir("$BETALIB/grammars/pretty") || die "chdir $BETALIB/grammars/pretty";
	system("dogram prettyprint") && die "building pretty grammar";
	chdir("$BETALIB/grammars/metagram") || die "chdir $BETALIB/grammars/metagram";
	system("dogram metagrammar") && die "building metagrammar";
	chdir("$BETALIB/grammars/beta") || die "chdir $BETALIB/grammars/beta";
	system("dogram beta") && die "building beta grammar";
	chdir("$BETALIB/grammars/property") || die "chdir $BETALIB/grammars/property";
	system("dogram property") && die "building property grammar";
}

if ($a){
    print "********************************************************\n";
    print "*** Finished booting track sucessfully (phase 1)\n";
    print "*** Not removing asts before compiling tools (-a option)\n";
    print "********************************************************\n";
} else {
    print "********************************************************\n";
    print "*** Finished booting track sucessfully (phase 1)\n";
    print "*** Now all asts will be removed and recompiled with the new compiler\n";
    print "********************************************************\n";
    
    system("mbs_rmast -u -c") && die "rmast";
    chdir("$BETALIB/compiler") || die "chdir $BETALIB/compiler";
    unlink("beta$EXESUFFIX");
    system("$BETALIB/bin/$objdir/beta -qwl beta") && die "$BETALIB/bin/$objdir/beta -qwl beta";
    move("$BETALIB/bin/$objdir/beta$EXESUFFIX", "$BETALIB/bin/$objdir/beta-compiled-by-boot-compiler$EXESUFFIX") || die "Couldn't move $BETALIB/bin/$objdir/beta$EXESUFFIX out of the way";
    copy("beta$EXESUFFIX", "$BETALIB/bin/$objdir/beta$EXESUFFIX") || die "Couldn't move beta$EXESUFFIX over to $BETALIB/bin/$objdir/beta$EXESUFFIX";
    chmod 0755, "$BETALIB/bin/$objdir/beta$EXESUFFIX";
    
}

system("mbs_compile -u") && die "mbs_compile";
system("mbs_compiletools -u") && die "mbs_compiletools";

exit(0);












sub compilingfailed
{
    my($prog, $progdesc) = @_;
    print "Compiling $prog$progdesc failed\n";
    print "*************************\n";
    print "*** If you got an error saying the prettyprinter is missing then that\n";
    print "*** means there are errors in $prog$progdesc\n";
    print "*** you can either fix the errors in $prog in another track\n";
    print "*** or you can get the prettyprinter grammar files you\n";
    print "*** need from another track so you can see the real error messages\n";
    print "\n";
    print "*** Alternatively you could just complain to Ole :-)\n" if ($prog eq "beta");
    print "\n";
    exit(2);
}
