#!/usr/local/bin/perl -s

use File::Copy;

push(@INC, $ENV{'BETALIB'} . "/bin/admin");

if ($h){
    print "Usage: mbs_boottrack [-h]\n";
    print "          -h   Print this help\n";
    print "          -g   Skip metagrammar boot and grammar tool compilation\n";
    print "          -r   Skip betarun build\n";
    print "          -a   Skip removal of asts before compiling libraries \n";
    print "               and tools (phase 2)\n";
    print "       Get a newly checked out BETA track working:\n";
    print "          Phase 1:\n";
    print "            1. boot metagrammar and beta grammar\n";
    print "               using boot grammar tools\n";
    print "            2. (windows) establish betacc.exe\n";
    print "            3. (linux/windows) create runtime generator\n";
    print "            4. generate betarun (unless -r)\n";
    print "            5. compile compiler using boot compiler\n";
    print "            6. (windows) recompile betacc.exe\n";
    print "            7. Generate metaprogramming tools (unless -g)\n";
    print "            8. boot all grammars using newly generated grammar tools\n";
    print "               (unless -g)\n";
    print "          Phase 2:\n";
    print "            1. remove all .ast(L) files from track except grammar asts\n";
    print "               (unless -a)\n";
    print "            2. compile all libraries\n";
    print "            3. compile all tools except compiler\n";

    exit 0;
}

require "env.perl";

$shortobjdir = $objdir;
$shortobjdir = "nti" if ($shortobjdir =~ /nti/);

$BETALIB = $ENV{'BETALIB'};

print "Booting BETALIB: $BETALIB\n\n";

if (!$g) {

    &progress(1, 1, "Booting metagrammar and beta grammar using boot grammar tools");

    chdir("$BETALIB/grammars/metagram") || die "Where is the BETALIB/grammars/metagram directory?";
    $grammarname = "metagrammar";
    do "$BETALIB/boot/grammars/bootbobsit.pl";
    do "$BETALIB/boot/grammars/bootdogram.pl";
    
    chdir("$BETALIB/grammars/beta") || die "Where is the BETALIB/grammars/beta directory?";
    $grammarname = "beta";
    do "$BETALIB/boot/grammars/bootdogram.pl";

}

if ($objdir =~ /nti/) {
    &progress(1, 2, "Establishing betacc.exe");

    # On NTI we need to add this dir to the path so the compiler can find
    # betacc.  This is ugly, since we could pick up other stuff from the
    # boot dir inadvertently.  Better would be to add an option to beta
    # for specifying where betacc is.
    $savedpath = $ENV{'PATH'};
    if ($cygwin){
	if (! -f "$BETALIB/bin/$objdir/betacc.exe"){
	    print "Cygwin: copying betacc.exe from boot directory\n";
	    mkdir("$BETALIB/bin/$objdir", 0777) unless (-d "$BETALIB/bin/$objdir"); 
	    system "cp $BETALIB/boot/bin/$objdir/betacc.exe $BETALIB/bin/$objdir";
	    # Copy will be regenerated by mbs_compiletools
	}
    } else {

	$ENV{'PATH'} = "$BETALIB\\boot\\bin\\$objdir;" . $ENV{'PATH'};
    }
}

if (!$r) {
    if ($RUNTYPE eq "run") {
	&progress(1, 3, "Creating runtime generator");
	system("mbs_compiletools rungen") && die("Couldn't make runtime generator\n");
    }
    &progress(1, 4, "Generating betarun");
    system("mbs_make") && die("Couldn't make betarun\n");
}

&progress(1, 5, "Compiling compiler using boot compiler");
chdir("$BETALIB/compiler") || die "Couldn't find compiler directory\n";

system("$BETALIB/boot/bin/$objdir/beta -qwl beta") &&
    &compilingfailed("beta", " (the BETA compiler)");

if (! -d "$BETALIB/bin/$objdir") {
    mkdir("$BETALIB/bin/$objdir", 0777) || die "Couldn't make the directory for exe files ($BETALIB/bin/$objdir)\n";
}

copy("beta$EXESUFFIX", "$BETALIB/bin/$objdir/beta$EXESUFFIX") || die "Couldn't move beta$EXESUFFIX over to $BETALIB/bin/$objdir/beta$EXESUFFIX";
chmod 0755, "$BETALIB/bin/$objdir/beta$EXESUFFIX";


if ($objdir =~ /nti/) {
    &progress(1, 6, "Recompiling betacc.exe");
    system("mbs_compiletools betacc") &&
        &compilingfailed("betacc", " (the BETA compiler helper)");
    $ENV{'PATH'} = $savedpath if ($savedpath ne "");
}

if (!$g) {
    &progress(1, 7, "Generating remaining metaprogramming tools");

    system("mbs_compiletools exbobs") && &compilingfailed("exbobs", "");
    system("mbs_compiletools tabc") && &compilingfailed("tabc", "");
    system("mbs_compiletools gen") && &compilingfailed("gen", " (the grammar tool)");
    system("mbs_compiletools makepretty") && &compilingfailed("makepretty", "");
    system("mbs_compiletools morepretty") && &compilingfailed("morepretty", "");
    system("mbs_compiletools dogram") && &compilingfailed("dogram", "");
    
    &progress(1, 8, "Booting all grammars using newly generated grammar tools");
    chdir("$BETALIB/grammars/pretty") || die "chdir $BETALIB/grammars/pretty";
    system("dogram prettyprint") && die "building pretty grammar";
    chdir("$BETALIB/grammars/metagram") || die "chdir $BETALIB/grammars/metagram";
    system("dogram metagrammar") && die "building metagrammar";
    chdir("$BETALIB/grammars/beta") || die "chdir $BETALIB/grammars/beta";
    system("dogram beta") && die "building beta grammar";
    chdir("$BETALIB/grammars/property") || die "chdir $BETALIB/grammars/property";
    system("dogram property") && die "building property grammar";
}

if ($a){
    print "********************************************************\n";
    print "*** Finished booting track sucessfully (phase 1)\n";
    print "*** Not removing asts before compiling tools (-a option)\n";
    print "********************************************************\n";
} else {
    print "********************************************************\n";
    print "*** Finished booting track sucessfully (phase 1)\n";
    print "*** Now all asts will be removed and recompiled with the new compiler\n";
    print "********************************************************\n";
    
    &progress(2, 1, "Removing all .ast(L) files from track except grammar asts");

    system("mbs_rmast -u -c") && die "rmast";
    chdir("$BETALIB/compiler") || die "chdir $BETALIB/compiler";
    unlink("beta$EXESUFFIX");
    system("$BETALIB/bin/$objdir/beta -qwl beta") && die "$BETALIB/bin/$objdir/beta -qwl beta";
    move("$BETALIB/bin/$objdir/beta$EXESUFFIX", "$BETALIB/bin/$objdir/beta-compiled-by-boot-compiler$EXESUFFIX") || die "Couldn't move $BETALIB/bin/$objdir/beta$EXESUFFIX out of the way";
    copy("beta$EXESUFFIX", "$BETALIB/bin/$objdir/beta$EXESUFFIX") || die "Couldn't move beta$EXESUFFIX over to $BETALIB/bin/$objdir/beta$EXESUFFIX";
    chmod 0755, "$BETALIB/bin/$objdir/beta$EXESUFFIX";
    
}

&progress(2, 2, "Compiling all libraries");
system("mbs_compile -u") && die "mbs_compile";
&progress(2, 3, "Compiling all tools except compiler");
system("mbs_compiletools -u") && die "mbs_compiletools";
&progress(2, 4, "done");

exit(0);









sub progress
{
    my ($phase, $item, $msg) = @_;
    print "\n\n";
    print '*'x70;
    print "\nPhase $phase: $item:\n$msg\n";
    print '*'x70;
    print "\n\n";

}


sub compilingfailed
{
    my($prog, $progdesc) = @_;
    print "Compiling $prog$progdesc failed\n";
    print "*************************\n";
    print "*** If you got an error saying the prettyprinter is missing then that\n";
    print "*** means there are errors in $prog$progdesc\n";
    print "*** you can either fix the errors in $prog in another track\n";
    print "*** or you can get the prettyprinter grammar files you\n";
    print "*** need from another track so you can see the real error messages\n";
    print "\n";
    print "*** Alternatively you could just complain to Ole :-)\n" if ($prog eq "beta");
    print "\n";
    exit(2);
}
