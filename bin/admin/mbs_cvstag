#!/usr/local/bin/perl -s
#-*-Perl-*-

require("env.perl");

push(@INC, $ENV{'BETALIB'} . "/bin/admin");

if ($h){
    print "Usage: mbs_cvstag [-h]\n";
    print "          -h   Print this help\n";
    print "          -v   Verbose output\n";
    print "          -n   No effects - only print what would be done\n";
    print "          -d   Delete a CVS tag\n";
    print "          -f   Overwrite existing tag of same name\n";
    print "       Add/delete a CVS tag for all files in BETALIB\n";
    exit 0;
}

$Dirlist_IncludeAll = 1;	# Include ALL repositories on any archs.

($defaulttag = $RELEASE . "a") =~ s/\./\_/g;

$|=1;

$delete = 1 if ($d);
$forcemove = 1 if ($f);

if ($delete){
    print "This script will DELETE a CVS-tag in $RELEASE.\n";
} else {
    print "This script will CVS-tag in $RELEASE.\n";
}

if ($simulate){
    print "I will only simulate this, however (-n option). Go on (no/yes)? ";
    $nflag = "-n ";
} else {
    print "Are you sure that you want to do this (no/yes)? ";
    $nflag = "";
}
$yes = &GetAnswer();
exit if ($yes ne 'yes');

if ($delete){
    print "\nTag to delete (default \"$defaulttag\"): ";
    $read = &GetAnswer();
    if ($read eq ""){ 
	$deletetag = $defaulttag;
    } else {
	$deletetag = $read; 
    }
} else {
    print "Should the tag be a *branch* tag (no/yes)? ";
    $branch = &GetAnswer();
    if ($branch eq "yes"){
	$branch=1;
    } else {
	$branch=0;
    }
    
    if ($forcemove){
	print "Forcing existing tags to be moved (-f switch)\n.";
	$forcemove="-F ";
    } else {
	print "Force existing tags to be moved [not recommended] (no/yes)? ";
	$forcemove = &GetAnswer();
	if ($forcemove eq "yes"){
	    $forcemove="-F ";
	} else {
	    $forcemove="";
	}
    }
    
    if ($branch) {
	print "\nExisting tag to branch from (default \"$defaulttag\"): ";
	$read = &GetAnswer();
	if ($read eq ""){ 
	    $branchtag = $defaulttag;
	} else {
	    $branchtag = $read; 
	}
	$defaulttag .= "_correction_branch";
    } else {
	print "\nExisting tag to copy (default \"none\"): ";
	$read = &GetAnswer();
	if ($read ne "") { 
	    $copytag = $read; 
	}
	$defaulttag .= "_correction_branch";
    }
    print "\nNew tag to use (default \"$defaulttag\"): ";
    $read = &GetAnswer();
    if ($read eq ""){ 
	$newtag = $defaulttag;
    } else {
	$newtag = $read; 
    }
    print "Updating $betalib/configuration/mbs_id...\n";
    print "echo '$newtag'>$betalib/configuration/mbs_id\n" if ($verbose);
    system "echo '$newtag'>$betalib/configuration/mbs_id" if (!$simulate);
    print "Committing configuration...\n";
    print "chdir $betalib/configuration\n" if ($verbose);
    chdir "$betalib/configuration" or die $!;
    print "cvs com -m 'Tagging of $newtag' mbs_id\n" if ($verbose);
    system "cvs com -m 'Tagging of $newtag' mbs_id" if (!$simulate);
    print "Done\n";	
}

# enough talk - let's go to work ...

chdir($betalib) || die "Where did BETALIB go?";

if ($delete){
    $cvscmd = "cvs $nflag-Q rtag -d $deletetag beta_project";
} else {
    if ($branch){
	$cvscmd = "cvs $nflag-Q rtag ${forcemove}-b -r $branchtag $newtag beta_project";
    } elsif (defined $copytag) {
	$cvscmd = "cvs $nflag-Q rtag ${forcemove}-r $copytag $newtag beta_project";
    } else {
	$cvscmd = "cvs $nflag-Q rtag ${forcemove}$newtag beta_project";
    }
}
print "$cvscmd\n";
system("$cvscmd")
exit(1) if ($?);

print <<EOF;

REMEMBER to update Quality/releases.html!

EOF
