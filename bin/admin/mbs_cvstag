#!/usr/local/bin/perl5 -s
#-*-Perl-*-

$simulate=$n; # -n option

$betalib=$ENV{'BETALIB'} || die "BETALIB must be set!\n";
$betalib =~ s#\\#/#g;
$dirs=require "$betalib/bin/admin/dirlist";

$|=1;

print "This script will CVS-tag each repository in $RELEASE.\n";

if ($simulate){
    print "I will only simulate this, however (-n option). Go on (no/yes)? ";
} else {
    print "Are you sure that you want to do this (no/yes)? ";
}

$yes = <STDIN>;
chop $yes;
exit if ($yes ne 'yes');

if (!$simulate){
    print "Really sure? ";
    $yes = <STDIN>;
    chop $yes;
    exit if ($yes ne 'yes');
}

print "Should the tags be *branch* tags (no/yes)? ";
$branch = <STDIN>;
chop $branch;
if ($branch eq "yes"){
    $branch=1;
} else {
    $branch=0;
}

print "Force existing tags to be moved [not recommended] (no/yes)? ";
$forcemove = <STDIN>;
chop $forcemove;
if ($forcemove eq "yes"){
    $forcemove="-F ";
} else {
    $forcemove="";
}

print "Use a common tag for all repositories (yes/no)? ";
$onetag = <STDIN>;
chop $onetag;

($defaulttag = $RELEASE . "a") =~ s/\./\_/g;

if ($onetag ne "no"){
    if ($branch){
	print "\nExisting tag to branch from (default \"$defaulttag\"): ";
	$read = <STDIN>;
	chop $read;
	if ($read eq ""){ 
	    $branchtag = $defaulttag;
	} else {
	    $branchtag = $read; 
	}
	$defaulttag .= "_correction_branch";
    }
    print "\nNew tag to use (default \"$defaulttag\"): ";
    $read = <STDIN>;
    chop $read;
    if ($read eq ""){ 
	$newtag = $defaulttag;
    } else {
	$newtag = $read; 
    }
} else {
    print "\nPrefix to use in new tags (default \"$defaulttag\"): ";
    $read = <STDIN>;
    chop $read;
    if ($read eq ""){ 
	$tagprefix = $defaulttag;
    } else {
	$tagprefix = $read; 
    }
}

# enough talk - let's go to work ...

foreach $dir (split ' ', $dirs) {
    if ($CvsTags{$dir} =~ /^\%(\S+)/) {
	next if ($1 eq 'IGNORE');
	next if ($1 eq 'NONCVS');
	print "  [Unknown '%'-tag in CvsTag: \"$1\", skipping $dir]\n";
	next;
    }
    ($cvsmodule, $tag) = split(/\@/,$CvsTags{$dir});
    if ($cvsmodule =~ /\w+\/\w+/){
	print "  [$cvsmodule is a sub-repository, skipped]\n";
	next;
    }
    if ($doneflag{$cvsmodule}){
	print "  [$cvsmodule tagged once, skipped]\n";
	next;
    }
    if ($onetag eq "no"){
	# ask for individual tag
	$defaulttag = $tagprefix;
	if ($dir =~ /\/([v|r|\d|\.]+)\/?/) {
	    $defaulttag .= "_$1";
	}
	$defaulttag =~ s/\./\_/g;
	if ($branch){
	    print "\nExisting tag to branch $cvsmodule from (default \"$defaulttag\"): ";
	    $read = <STDIN>;
	    chop $read;
	    if ($read eq ""){ 
		$branchtag = $defaulttag;
	    } else {
		$branchtag = $read; 
	    }
	    $defaulttag .= "_correction_branch";
	}
	print "\nNew tag to use for $cvsmodule (default \"$defaulttag\"): ";
	$read = <STDIN>;
	chop $read;
	if ($read eq ""){ 
	    $newtag = $defaulttag;
	} else {
	    $newtag = $read; 
	}
    }
    # construct CVS command
    if ($branch){
	$cvscmd = "cvs -Q rtag ${forcemove}-b -r $branchtag $newtag $cvsmodule";
    } elsif ($tag eq "HEAD"){
	$cvscmd = "cvs -Q rtag $newtag $cvsmodule";
    } else {
	$cvscmd = "cvs -Q rtag ${forcemove}-r $tag $newtag $cvsmodule";
    }
    print "$cvscmd\n";
    system("$cvscmd") if (!$simulate);
    exit(1) if ($? && (!$simulate));
    $doneflag{$cvsmodule}=1;
}
