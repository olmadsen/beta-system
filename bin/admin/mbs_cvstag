#!/usr/local/bin/perl5
#-*-Perl-*-

$betalib=$ENV{'BETALIB'} || die "BETALIB must be set!\n";
$betalib =~ s#\\#/#g;
$dirs=require "$betalib/bin/admin/dirlist";

$|=1;

print "This script will CVS-tag each repository in $RELEASE.\n";

print "Are you sure that you want to do this (no/yes)? ";

$yes = <STDIN>;
chop $yes;
exit if ($yes ne 'yes');

print "Really sure? ";
$yes = <STDIN>;
chop $yes;
exit if ($yes ne 'yes');

print "Use a common tag for all repositories (yes/no)? ";
$onetag = <STDIN>;
chop $onetag;

($defaulttag = $RELEASE . "a") =~ s/\./\_/g;
if ($onetag ne "no"){
    print "\nTag to use (default \"$defaulttag\"): ";
    $read = <STDIN>;
    chop $read;
    if ($read eq ""){ 
	$newtag = $defaulttag;
    } else {
	$newtag = $read; 
    }
} else {
    print "\nPrefix to use in tags (default \"$defaulttag\"): ";
    $read = <STDIN>;
    chop $read;
    if ($read eq ""){ 
	$tagprefix = $defaulttag;
    } else {
	$tagprefix = $read; 
    }
}

foreach $dir (split ' ', $dirs) {
    if ($CvsTags{$dir} =~ /^\%(\S+)/) {
	next if ($1 eq 'IGNORE');
	next if ($1 eq 'NONCVS');
	print "  [Unknown '%'-tag in CvsTag: \"$1\", skipping $dir]\n";
	next;
    }
    ($cvsmodule, $tag) = split(/\@/,$CvsTags{$dir});
    if ($cvsmodule =~ /\w+\/\w+/){
	print "  [$cvsmodule is a sub-repository, skipped]\n";
	next;
    }
    if ($doneflag{$cvsmodule}){
	print "  [$cvsmodule tagged once, skipped]\n";
	next;
    }
    if ($onetag eq "no"){
	# ask for individual tag
	$defaulttag = $tagprefix;
	if ($dir =~ /\/([v|r|\d|\.]+)\/?/) {
	    $defaulttag .= "_$1";
	}
	$defaulttag =~ s/\./\_/g;
	print "\nTag to use for $cvsmodule (default \"$defaulttag\"): ";
	$read = <STDIN>;
	chop $read;
	if ($read eq ""){ 
	    $newtag = $defaulttag;
	} else {
	    $newtag = $read; 
	}
    }
    # construct CVS command
    if ($tag eq "HEAD"){
	$cvscmd = "cvs -Q rtag $newtag $cvsmodule";
    } else {
	$cvscmd = "cvs -Q rtag -r $tag $newtag $cvsmodule";
    }
    print "$cvscmd\n";
    system("");
    exit(1) if ($?);
    $doneflag{$cvsmodule}=1;
}
