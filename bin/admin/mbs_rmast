#!/usr/local/bin/perl -s
#-*-Perl-*-

push(@INC, $ENV{'BETALIB'} . "/bin/admin");

if ($h){
    print "Usage: mbs_rmast [-h][-u][-l][-b][-a]\n";
    print "          -h   Print this help\n";
    print "          -v   Verbose output\n";
    print "          -n   No effects - only print what would be done\n";
    print "          -u   Use defaults - ask no questions; remove big-endian\n";
    print "          -l   remove little-endian ast files (.astL)\n";
    print "          -c   remove only .ast or .astL based on current architecture\n";
    print "          -b   remove big-endian ast files (.ast); default\n";
    print "          -a   Do not remove .a2s files\n";
    print "       Remove all .ast(L) files in BETALIB except the ones for grammars\n";
    exit 0;
}

require "dirlist";

$UseDefaults = 1 if ($u);

if ($c){
    # mbs_rmast -c
    if ($ENDIAN eq "L"){
	$match='\.ast[lL]';
	$desc="little endian"; 
    } else {
	$match='\.ast';
	$desc="big endian"; 
    }
} elsif ($l){
    # mbs_rmast -l
    $match='\.ast[lL]';
    $desc="little endian"; 
} elsif ($b){
    # mbs_rmast -b
    $match='\.ast';
    $desc="big endian";
} else {
    $match='\.ast[lL]?';
    $desc="all";
}

if ($a) {
    # mbs_rmast -a
    $a2sdesc='';
} else {
    $match = "($match)|(\.a2s)";
    $a2sdesc='and .a2s ';
}
    
$match .= '$';

if ($FromAnotherScript || $UseDefaults) {
    $doprompt = 'n';
} else {
    print "This script will recursively remove $desc AST ${a2sdesc}files\n";
    print "i.e. files matching \n";
    print "\t$match\nfrom\n\t$betalib.\n\n";

    print "Do you want to do this? (no/yes) ";

    $yes = &GetAnswer();
    exit if ($yes ne 'yes');

    print "\nWould you like to be prompted for each directory? (yes/no) ";
    $doprompt = &GetAnswer();
}

foreach $dir (@Dirs) {
    next if (!$CompileFlag{$dir});
    $basedir = "$betalib/$dir";
    next if (!-d &path($basedir));
    if ($doprompt eq "yes"){
	print  "\nRecursively remove files matching $match from\n";
	print "  $basedir? (y/n/q) ";
	$answer = &GetAnswer();
	if ($answer eq "y"){
	    # just go on
	} elsif ($answer eq "n"){
	    next;
	} elsif ($answer eq "q"){
	    exit 0;
	}
    } else {
	print "*********** Removing from $basedir ***************\n";
    }
    foreach $curdir (&GetDirsRecursively($basedir)) {
	@files = &GetFilesInDirs($curdir);
	foreach $file (@files) {
	    if ($file =~ /$match/) {
		print "$file\n" if ($verbose);
		if (!$simulate) {
                    unlink $file or print "Unable to delete file $file\n";
                }
	    }
	}
    }
}
	    
1;
