#!/usr/local/bin/perl5
#-*-Perl-*-


if ($#ARGV == -1) {
    print "Usage: $0 targets\n";
    exit 1;
}

foreach $target (@ARGV) {
    $target =~ s/(\W)/\\$1/g; # Quote nonwords.
    push (@Targets, $target);
}

$betalib=$ENV{'BETALIB'}  || die "BETALIB must be set!\n";
$betalib =~ s#\\#/#g;

$dirs=require "$betalib/bin/admin/dirlist";

if ($MACHINETYPE eq 'NTI') {
    $match='\.((obj)|(asm))$';    
} else {
    $match='\.((\.gs)|(\.s)|(o)|(go)|(\.db)|(job)|(so)|(gso))$';
}

print "This script will recursively remove files matching $match from $RELEASE.\n\n";

print "Are you sure you want to do this? (no/yes) ";

$yes = <STDIN>;
chop $yes;
exit if ($yes ne 'yes');

print "Really sure? ";
$yes = <STDIN>;
chop $yes;
exit if ($yes ne 'yes');

print "\nWould you like to be prompted for each directory? (yes/no) ";
$doprompt = <STDIN>;
chop $doprompt;

foreach $dir (split ' ', $dirs) {
    next if (!$CompileFlag{$dir});
    ($basedir ="$betalib/$dir") =~ s#/$##;
    next if (! -d $basedir);
    if ($doprompt eq "yes"){
	print  "\nRecursively remove files matching $match from\n";
	print "  $basedir? (y/n/q) ";
	$answer=<STDIN>;
	chop $answer;
	if ($answer eq "y"){
	    # just go on
	} elsif ($answer eq "n"){
	    next;
	} elsif ($answer eq "q"){
	    exit 0;
	}
    } else {
	print "*********** Removing from $basedir ***************\n";
    }
    @todo=('.');
    while ($curdir = pop @todo) {
	$CurrentPath = $curdir;
	$curdir .= '/';
	$curdir =~ s#^\./$##;
	$ntdirfix = "$basedir/$curdir";
	#$ntdirfix =~ s/^.\://;
	#$ntdirfix =~ s#\/#\\#g;
	#print "Scanning $ntdirfix\n";
	chdir $ntdirfix or die "Unable to chdir: $!";
	opendir DIR, '.' or die "Unable to readdir $!";
	@files=readdir(DIR);
	closedir DIR;
	foreach $file (@files) {
	    next if ($file =~ /^\./);
	    if (-d $file) {
		push @todo, "$curdir$file";
		#print "Pushing $file\n";
	    }
	    elsif ($file =~ /$match/) {
		foreach $target (@Targets) {
		    if ($CurrentPath =~ /${target}\/?$/) {		
		        print "$file\n";
			unlink $file or print "Unable to delete file $file\n";
		    }
		}
	    }
	}
    }
}
	    





