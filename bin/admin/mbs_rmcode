#!/usr/local/bin/perl5 -s
#-*-Perl-*-

push(@INC, $ENV{'BETALIB'} . "/bin/admin");
require "dirlist";

if ($h || ($#ARGV == -1)){
    print "Usage: mbs_rmcode $std_options targets\n";
    print_stdoptions();
    print "       targets are one or more of sun4s, linux, ...\n";
    exit 0;
}

$UseDefaults = 1 if ($u);

foreach $target (@ARGV) {
    next if ($target =~ /^\-/);
    $target =~ s/(\W)/\\$1/g; # Quote nonwords.
    push (@Targets, $target);
}

# Temporarily comment out following line to make emacs indentation work
$match='\.(\.gs|\.s|o|go|db|job|obj|asm|bat|dep|class|clst|bin|jar|jat|\.j|dll)$';

if ($FromAnotherScript || $UseDefaults) {
    $doprompt = 'n';
} else {
    print "This script will recursively remove files matching\n";
    print "   $match\nfrom codedirectories named\n";
    print "   @Targets\nin $betalib.\n\n";

    print "Are you sure you want to do this? (no/yes) ";

    $yes = &GetAnswer();
    exit if ($yes ne 'yes');

    print "\nWould you like to be prompted for each directory? (yes/no) ";
    $doprompt = &GetAnswer();
}

$FromAnotherScript = 0;

foreach $dir (@Dirs) {
    next if (!$CompileFlag{$dir});
    $basedir = "$betalib/$dir";
    next if (!-d &path($basedir));
    if ($doprompt eq "yes"){
	print  "\nRecursively remove files matching $match from\n";
	print "  $basedir? (y/n/q) ";
	$answer = &GetAnswer();
	if ($answer eq "y"){
	    # just go on
	} elsif ($answer eq "n"){
	    next;
	} elsif ($answer eq "q"){
	    exit 0;
	}
    } else {
	print "*** Removing from $basedir ***\n";
    }
    foreach $curdir (&GetDirsRecursively($basedir)) {
	foreach $target (@Targets) {
            local $orig_match = $match;
            if ($target eq "jvm"){
                $match =~ s/jat/jat|h/; # remove .h files too (JNI)
            }
	    if ($curdir =~ m/$target$/) {
		# We are in a target code directory
		foreach $file (&GetFilesInDirs($curdir)) {
		    if ($file =~ /$match/) {
		        print "    $file\n" if ($verbose);
			next if ($simulate);
			unlink $file or print "    Unable to delete file $file\n";
		    }
		}
		# Special case for jvm: remove subdirectory beta too
		if ($curdir =~ m/jvm$/ && -d "$curdir/beta") {
                    print "    jvm: Removing $curdir/beta ***\n" if ($verbose);
		    &SmartRmDir("$curdir/beta") unless ($simulate);
		}
	    }
            $match = $orig_match;
	}
    }
}

1;
