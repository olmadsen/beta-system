#! perl

# Configure all these to suit local needs:

# Program locations:
$ISBase = "U:\\win32app\\InstallShield Professional 6";
$ISCom = "w:\\program files\\common files\\installshield";
$PFTWbase = "U:\\win32app\\InstallShield Professional 6\\packagefortheweb";

# Location of installshield project definition (.ipr file)
$InstBase = "d:\\My Installations\\Mjolner System";

# Temporary files:
$ExtractedFiles = "U:\\beta-export";
$Destination = "u:\\tmp";

# Final resulting package location:
$PackagePath = "Z:\\public_html\\beta";

# Version to display in installer. Must match value in installshield GUI.
$version = "5.2";



##############################################################
# Impl, do not touch.
##############################################################

use File::DosGlob;
use File::Copy;
use File::Basename;
use File::stat;

sub mayrm {
    foreach $file (@_) {
	unlink $file if -e $file;
    }
}

sub SmartRmDir {
    my ($path) = @_;
    if ($ENV{'COMSPEC'} =~ /4nt/i) {
	system "$ENV{'COMSPEC'} /C del /S /Q /X /Y $path";
    } elsif ($ENV{'COMSPEC'} =~ /cmd/i) {
	
    } else {
	
    }
}

sub Usage {
    print "extractexportfiles. Usage:\n";
    print "Normally, just say:\n\n";
    print "extractexportfiles ms *.cmd      or maybe\n\n";
    print "extractexportfiles -u ms *.cmd\n\n";
    print "Which extracts the files for a complete system for nti_ms\n";
    print "The files are copied to \"$ExtractedFiles\"\n";
# not yet ;)    print "If in doubt, check Quality pages!\n";
    exit 1;
}

$UseDefaults = 1 if ($u);   # perl -s does this to options...
$Force = 1 if ($f);

&Usage if ($#ARGV <= 0);
$MIASDK = shift @ARGV;
if ($MIASDK !~ /^(ms|gnu|bor)$/) {
    &Usage;
}

warn "\nIS 6 pro base not found." if (! -d $ISBase);
warn "\nIS 6 pro common not found." if (! -d $ISCom);
warn "\nWhere are the IS data files" if (! -d $InstBase);
warn "\nDestination \"$Destination\" is missing" if (! -d $Destination);

$Destination .= "\\$MIASDK";
mkdir($Destination, 0777) if (!-d $Destination);
die "Destination \"$Destination\" is missing" if (! -d $Destination);


$ENV{'MIASDK'} = $MIASDK; # Export to other programs, if any should need it.
$| = 1;   # Flush all read/writes
$betalib = $ENV{'BETALIB'};
$CWD = `cd`; chop $CWD;
$log = "beta_${MIASDK}.lst";

# $ExtractedFiles .= '\\' . $MIASDK;

foreach $f (@ARGV) {
    if ($f =~ /cmd$/i) {
	foreach $file (&File::DosGlob::doglob(1,$f)) {
	    if ($f =~ /^(.*)\.cmd$/i) {
		push(@FileList, $1);
	    }
	}
    } elsif ($f eq "-u") {
	$UseDefaults = 1;
	print "Using auto-chosen defaults!\n";
    } elsif ($f eq "-f") {
	$Force = 1;
	print "Using Force mode!\n";
    } else {
	print "Unable to handle argument '$f'.\n";
	exit 1;
    }
}

# Check existance of some critical files:
mkdir($ExtractedFiles, 0777) if (!-d $ExtractedFiles);

if (-d "$ExtractedFiles/$MIASDK/base/basiclib" && !$Force) {
    print "There is already a set of extracted files in $ExtractedFiles.\n";
    print "Please delete these and restart this script.\n";
    exit 1;
}

foreach $file (@FileList) {
    open (CMD, "<$file.cmd") || die "Unable to read $file: $!";
    $nam = <CMD>;
    close CMD;
    chop $nam;

    if ($nam =~ /^(doc)\d+$/) {
	$part = "doc";
    } else {
	$part = "base";
    }


    print "\n------Packing $nam:\n";
    open (IN, "<$file.cmd") || die "unable to read $file.cmd: $!";
    $quale = <IN>; # Skip name of old .z file.
    chdir $betalib;
    foreach $line (<IN>) {
	chop $line;
	next if ($line =~ /^$/);
	$line =~ s/%MIASDK%/$ENV{'MIASDK'}/gi;
	if ($line =~ /^icomp\s+\.[\\\/]([^ ]+)\s/i) {
	    # Here: parse line, create directories and copy files...
	    $fullfile = $1;
	    $file = $fullfile;
	    $dir = "$ExtractedFiles/$MIASDK";
	    mkdir($dir, 0777) if (!-d $dir);
	    $dir = "$ExtractedFiles/$MIASDK/$part/";
	    mkdir($dir, 0777) if (!-d $dir);
	    while ($file =~ /^([^\\\/]+)[\\\/](.*)$/) {
		$dir .= "$1/";
		$file = $2;
		mkdir($dir, 0777) if (!-d $dir);
	    }
	    $dst = $dir;
	    $dst =~ s/\//\\/g;
	    print "copying $fullfile: ";
	    foreach $file (&File::DosGlob::doglob(1,$fullfile)) {
		print ".";
		($bname, $pname, $tname) = fileparse($file);
		$basefile = $bname . $tname;
		&File::Copy::copy($file, $dst);
		$st = stat($file) || die "Failed to stat $file";
		utime $st->atime, $st->mtime, "$dst/$basefile" || die "Failed to set time on $dst/$basefile";
	    }
	    print "\n";

	} elsif ($line =~ /(^(del|ren|copy))|encrypt.exe/) {
	    print "$line\n";
	    system($line);
	} elsif ($line =~ /^cd\s+(.*)$/) {	
	    $newpath=$1;
	    $newpath =~ s/\%([^\%]+)\%/\$ENV\{\'$1\'\}/ig;
	    $newpath =~ s#\\#/#g;
	    $newpath = eval("\"$newpath\"\;");
	    print "cd $newpath\n";
	    chdir $newpath;
	} else {
	    print "\nERROR:Unable to parse \"$line\"\n\n";
	}
    }
    close(IN);
    chdir $CWD;
}


sub DanceWithInstallShield {
# Order InstallShield to build media from these files.
# Preliminary support! Not well-tested.
# Requirements:
# Need project built using IS IDE specifying everything...

    open (FGL, ">$InstBase/File Groups/BaseSystem.fgl") || die "base: $!";
    print FGL<<"EOT";
[DYNAMIC]
WILDCARD0=*.*
INCLUDESUBDIR=YES
FOLDER=$ExtractedFiles\\$MIASDK\\base
[GENERAL]
VERSION=1.10.000
TYPE=FILELIST
EOT

    close FGL;

    open (FGL, ">$InstBase/File Groups/doc.fgl") || die "base: $!";
    print FGL<<"EOT";
[DYNAMIC]
WILDCARD0=*.*
INCLUDESUBDIR=YES
FOLDER=$ExtractedFiles\\$MIASDK\\doc
[GENERAL]
VERSION=1.10.000
TYPE=FILELIST
EOT

    close FGL;
	
    $arg .="\"$InstBase\\Script Files\\setup.rul\" ";
    $arg .="\"$ISBase\\Script\\Ifx\\Lib\\Ifx.obl\" ";
    $arg .="\"$ISBase\\Script\\Isrt\\Lib\\Isrt.obl\" ";
    $arg .="\"-i$ISBase\\script\\ifx\\Include\" ";
    $arg .="\"-i$ISBase\\script\\isrt\\Include\" ";
    $arg .="\"-i$ISBase\\Include\" ";
    $arg .="\"-i$InstBase\\Script Files\" ";
    $arg .="-dMIASDK=\\\"$MIASDK\\\"";
    $cmd = "\"$ISCom\\iscript\\Compile.exe\" $arg";
    print "$cmd\n";
    system $cmd;

    $cmd = "\"$ISBase\\Program\\isbuild\"";
    $cmd .= " \"-p$InstBase\"";
    $cmd .= " \"-b$Destination\"";
    if ($MIASDK =~ /ms/) {
	$cmd .= ' "-mMjolner MS"';
    } else {
	$cmd .= ' "-mMjolner GNU"';
    }

    print "$cmd\n";
    system $cmd;

    open (PFW, ">$InstBase/MjolnerSystem-$MIASDK.pfw") || die "PFW: $!";
    print PFW<<"EOT";
[PackageForTheWeb]
Version=2.0
[Options]
Title=MjolnerSystem-$MIASDK
BasePath=$Destination\\Disk Images
ImportPath=$Destination\\
OutputSpec=$PackagePath\\MjolnerSystem-$MIASDK.exe
Version=$version
Company=Mjølner Informatics
UseRTF=0
SaveFiles=0
SubFolders=1
ApplicationName=Mjolner System
Description=
Comments=
Notice=
GUIDs=0
Type=2
Compress=1
Sign=0
Transfer=0
Files=9

[Engine]
Setup=Disk1\\Setup.exe

[Web Page]
Generate=1
Template=
MSClient=
NClient=

[Runtime]
Welcome=
License=
Prompt=
Password=
DefaultPath=
Language=English
WindowStyle=0
Options=51
Execute=Disk1\\Setup.exe
CmdLine=

[Extension]
Server=
Calls=0

[Code Signing]
CompanyURL=
SpecFile=
KeyFile=
Method=0

; ~~~~~~~~~~ File Section ~~~~~~~~~~~
[SubFolders]
Count=1
Folder1=Disk1

[File 1]
Name=Setup.exe
Path=$Destination\\Disk Images\\Disk1\\
Flags=589825
Disk=0
EOT
    
    close PFW;

    $cmd = "\"$PFTWbase\\pftwwiz.exe\"";
    $cmd .= " \"$InstBase\\MjolnerSystem-$MIASDK.pfw\"";
    $cmd .= " -a -s";

    print "$cmd\n";
    system $cmd;
}

&DanceWithInstallShield;

