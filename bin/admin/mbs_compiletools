#!/usr/local/bin/perl5 -s
#-*-Perl-*-

require "env.perl";

$betaopts="-qwl";

#---------- don't change below (except maybe after "main:") -------


sub CompileExbobs 
{
    local ($dir, $fragment, $name, $inCodeDir) = @_;
    if ($ask eq "y"){
	print "\n***** Build $name in $betalib/$dir (y/n/q)? ";
	$answer = &GetAnswer();
	if ($answer eq "q") { exit(0); }
	if ($answer eq "n") { return; }
    } else {
	print "\n***** Building $name in $betalib/$dir *****\n";
    }
    if (!chdir(&path("$betalib/$dir"))) { print "unable to chdir to $betalib/$dir\n"; return; }
    if ($MACHINETYPE eq "NTI"){
	print "C compiling\n";

	$ccmd="cl /c p2c\\p2clib.c /nologo /w /I. /O2 /Zd /DWIN32 /D${MACHINETYPE} /D${MACHINETYPE}_${SDK} /Zp4";
	print "$ccmd\n";
	system($ccmd);

	$ccmd="cl /c $fragment /nologo /w /I. /O2 /Zd /DWIN32 /D${MACHINETYPE} /D${MACHINETYPE}_${SDK} /Zp4";
	print "$ccmd\n";
	system($ccmd);

	$ccmd="cl /Fo${name}.exe ${name}.obj p2clib.obj /nologo /w /I. /O2 /Zd /DWIN32 /D${MACHINETYPE} /D${MACHINETYPE}_${SDK} /Zp4";
	print "$ccmd\n";
	system($ccmd);

    } else {
	# UNIX
	print "Calling Makefile\n";
	system(make);
    }
    if ($inCodeDir){
	if ("$MACHINETYPE" eq "NTI"){ 
	    $name .= ".exe";
	}
	print "Moving $name to $objdir/$name\n";
	unlink "$objdir/$name" if (-e "$objdir/$name");
	if (!rename ("$name", "$objdir/$name")){ print "cannot move $name to $objdir\n"; return; }
    }
}

sub CompileAppl 
{
    local ($dir, $fragment, $name, $inCodeDir) = @_;
    local ($tempname);
    if ($ask eq "y"){
	print "\n***** Build $name in $betalib/$dir (y/n/q)? ";
	$answer = &GetAnswer();
	if ($answer eq "q") { exit(0); }
	if ($answer eq "n") { return; }
    } else {
	print "\n***** Building $name in $betalib/$dir *****\n";
    }
    if (!chdir(&path("$betalib/$dir"))) { print "unable to chdir to $betalib/$dir\n"; return; }
    if (-d &path($objdir)){
	if (!opendir (DIR, $objdir)){ print "Unable to readdir $dir/$objdir: $!"; return }
	foreach (readdir(DIR)) {
	    unlink($_) if (/\.gso$/);
	}
    }
    if ($MACHINETYPE eq "NTI") {
	# "beta -o name" will lowercase "name"
	print "beta $betaopts $fragment\n";
	&beta("$betaopts $fragment");
	exit(1) if ($?);
	if ($fragment ne $name){
	    print "Moving $fragment.exe to $name.exe\n";
	    unlink "$name.exe" if (-e "$name.exe");
	    if (!rename ("$fragment.exe", "$name.exe")){ 
		print "cannot rename $fragment.exe to $name.exe\n"; 
		return; 
	    }
	}
	$tempname = "$name.exe";
    } else {
	# Temporary name used so that this script may be run in parallel.
	$tempname = $name;
	$tempname = $MACHINETYPE . "_" . $name if ($name !~ /^$MACHINETYPE/);
	print "beta $betaopts -o $tempname $fragment\n";
	&beta("$betaopts -o $tempname $fragment");
	exit(1) if ($?);
    }
    if ($inCodeDir){
	if ("$MACHINETYPE" eq "NTI"){ 
	    $name .= ".exe";
	}
	print "Moving $tempname to $objdir/$name\n";
	unlink "$objdir/$name" if (-e "$objdir/$name");
	if (!rename ("$tempname", "$objdir/$name")){ print "cannot move $tempname to $objdir\n"; return; }
    }
}
sub CompileCompiler
{
    local ($dir, $fragment, $name, $inCodeDir) = @_;
    local ($tempname);
    print "\n***** Building $name in $betalib/$dir *****\n";
    if (!chdir(&path("$betalib/$dir"))) { print "unable to chdir to $betalib/$dir\n"; return; }
    if ($MACHINETYPE eq "NTI") {
	# "beta -o name" will lowercase "name"
	print "bootbeta $betaopts -d $fragment\n";
	&bootbeta("$betaopts $fragment");
	exit(1) if ($?);
	if ($fragment ne $name){
	    print "Moving $fragment.exe to $name.exe\n";
	    unlink "$name.exe" if (-e "$name.exe");
	    if (!rename ("$fragment.exe", "$name.exe")){ 
		print "cannot rename $fragment.exe to $name.exe\n"; 
		return; 
	    }
	}
	$tempname = "$name.exe";
    } else {
	# Temporary name used so that this script may be run in parallel.
	$tempname = $name;
	$tempname = $MACHINETYPE . "_" . $name if ($name !~ /^$MACHINETYPE/);
	print "bootbeta $betaopts -o $tempname $fragment\n";
	&bootbeta("$betaopts -o $tempname $fragment");
	exit(1) if ($?);
    }
    if ($inCodeDir){
	if ("$MACHINETYPE" eq "NTI"){ 
	    $name .= ".exe";
	}
	print "Moving $tempname to $objdir/$name\n";
	unlink "$objdir/$name" if (-e "$objdir/$name");
	if (!rename ("$tempname", "$objdir/$name")){ print "cannot move $tempname to $objdir\n"; return; }
    }
}
	    
sub CompileFile {
    local ($dir, $fragment) = @_;
    if (!chdir(&path("$betalib/$dir"))) { print "unable to chdir to $betalib/$dir\n"; return; }
    print "BETA $betaopts -p --nolink $fragment\n";
    &beta("$betaopts -p --nolink $fragment");
}

sub SetWindowsBetalinkOptions {
    if ("$MACHINETYPE" eq "NTI"){
	# link as windows application, ie. without a console-window.
	# NO!  You cannot see the linkermessages then...
	if ("$SDK" eq "bor"){
	    #$ENV{'BETALINKOPTIONS'}='-aa -c -n -Tpe';
	} else {
	    #$ENV{'BETALINKOPTIONS'}="/NOLOGO /MACHINE:ix86 /SUBSYSTEM:WINDOWS /ENTRY:WinMainCRTStartup /INCREMENTAL:no";
	}
    }
}
    
sub SetNormalBetalinkOptions {
    $ENV{'BETALINKOPTIONS'}='';
}

################# main: ###########################

open(STDERR, ">&STDOUT") || die "Can't dup stdout";
select(STDERR); $| = 1;       # make unbuffered
select(STDOUT); $| = 1;       # make unbuffered

print "$0 STARTED\n";
&PrintDate;

if ( "$MACHINETYPE" ne "SGI" ){
    $betaopts .= "d"; # link with betarun.o and strip
}
if ($#ARGV>-1) { $betaopts .= " @ARGV"; }

print "\nCompiling tools in $betalib with options \"$betaopts\"\n";

if (($MACHINETYPE eq "NTI") && ($SDK eq "ms")){
    print "NTI: setting ASM_VERSION to 6\n";
    $ENV{'ASM_VERSION'}="6";
}

$rmast=0; $rmcode=0;
print "\n***** Build a new compiler (y/n/q)? ";
$answer = &GetAnswer();
if ($answer eq "q") { exit(0); }
if ($answer eq "y") { 
    print "Do you want to REMOVE ALL ast-files\n";
    print "when the compiler has been created (y/n/q)? ";
    $answer = &GetAnswer();
    if ($answer eq "q") { exit(0); }
    if ($answer eq "y") { 
	$rmast=1;
    } else {
	print "Do you want to REMOVE ALL object-files for this machinetype ($objdir)\n";
	print "when the compiler has been created (y/n/q)? ";
	$answer = &GetAnswer();
	if ($answer eq "q") { exit(0); }
	if ($answer eq "y") { 
	    $rmcode=1;
	}
    }
    # Build the new compiler:
    $binary = 1;
    if ($MACHINETYPE eq "NTI" && $SDK eq "bor") {
	$binary = 0;
    }
    $oldask = $ask; $ask = 'n';
    if ($binary) {
	&CompileCompiler("compiler", "beta", "beta", 1);
    } else {
	&CompileCompiler("compiler", "abeta", "beta", 1);
    }
    $ask = $oldask;
    if ($rmast) {
	$FromAnotherScript = 1;
	require "mbs_rmast";
    }
    if ($rmcode) {
	$FromAnotherScript = 1;
	require "mbs_rmcode";
    }
    
}

print "\nAsk for each remaining tool (y/n/q)? ";
$ask = &GetAnswer();
if ($ask eq "q"){ exit(0); }
if ($ask ne "n"){ $ask="y"; }

# exbobs: MACHINETYPE prefix maintained to avoid having to change UNIX makefile
&CompileExbobs("bobsgen/v1.6", "${MACHINETYPE}exbobs.c", "${MACHINETYPE}exbobs", 1);
&CompileAppl("bobsgen/v1.6", "tabc", "tabc", 1);
&CompileAppl("meta/v5.2", "gen", "gen", 1);
&CompileAppl("prettygen/v5.2", "makepretty", "makepretty", 1);
&CompileAppl("prettygen/v5.2", "morepretty", "morepretty", 1);
&CompileAppl("pretty/v5.2", "pp", "pp", 1);
&CompileAppl("objectbrowser/v2.2/psbrowser", "psbrowser", "psbrowser", 1);
&CompileAppl("utils/betafs/v1.2", "betafs", "betafs", 1);
&CompileAppl("utils/betatar/v1.2", "betatar", "betatar", 1);
&CompileAppl("utils/betawc/v1.2", "betawc", "betawc", 1);
&CompileAppl("distribution/v1.6", "ensembleDeamon", "ensembleDeamon", 1);
if ("$MACHINETYPE" ne "NTI"){
    &CompileAppl("debugger/v2.3", "valhalla", "valhalla", 1);
    &CompileAppl("editor/v5.2", "sif", "${MACHINETYPE}sif", 1);
    &CompileAppl("interfacebuilder/v1.6", "frigg", "${MACHINETYPE}frigg", 0);
} else {
    if ("$SDK" eq "bor"){
	&SetWindowsBetalinkOptions;
	&CompileAppl("editor/v5.2", "asif", "sif", 1);
	&CompileAppl("interfacebuilder/v1.6", "afrigg", "frigg", 1);
	&SetNormalBetalinkOptions;
    } else {
	&SetWindowsBetalinkOptions;
	&CompileAppl("editor/v5.2", "sif", "sif", 1);
    	&CompileAppl("interfacebuilder/v1.6", "frigg", "frigg", 1);
	&SetNormalBetalinkOptions;
    }
    
}
if ($MACHINETYPE eq "SUN4S" || $MACHINETYPE eq "SGI" || $MACHINETYPE eq "LINUX"){
    &CompileAppl("freja/v3.1", "${MACHINETYPE}freja", "${MACHINETYPE}freja", 1);
}

&CompileFile("freja/v3.1", "associations");

print "\n";
&PrintDate;
print "$0 COMPLETE\n";
