#!/usr/local/bin/perl

use File::Copy;

require "env.perl";

# Script to compile betarun

$betalib = $ENV{"BETALIB"};
$betalib =~ s/\\/\//g;
if ($betalib eq "") { die "\$BETALIB is not set" }
$ENV{"BETALIB"} = $betalib;

$betarun_dir = $betalib . "/betarun-src";

$make = "gmake";

if ($objdir eq "linux") {
  $make = "make";
}

if ($ARGV[0] =~ /^--?V/ ||
    $ARGV[0] =~ /^--?h/ ||
    $ARGV[0] =~ /^--?u/) {
    print stderr "mbs_mkboot: Move current files to boot area for checking in.\n";
    exit 1;
}

chdir($betalib) || die "Couldn't change directory to BETALIB ($betalib)";

&copybin("beta");
&copybin("rungen") if ($RUNTYPE eq "run");
&copybin("gen");
&copybin("exbobs");
&copybin("tabc");
&copybin("makepretty");
&copybin("morepretty");

&copygrammar("grammars/beta", "beta");
&copygrammar("grammars/metagram", "metagrammar");
&copygrammar("grammars/pretty", "prettyprint");
&copygrammar("betarun-src/GEN/GRAMMAR/", "runtime");

copy("$betalib/betarun-$objdir/nodebug/betarun$BETARUNSUFFIX",
     "$betalib/boot/bin/$objdir/betarun$BETARUNSUFFIX") ||
            die ("$betalib/betarun-$objdir/nodebug/betarun$BETARUNSUFFIX");


sub copybin
{
    my($exename) = @_;
    copy("$betalib/bin/$objdir/$exename$EXESUFFIX", "$betalib/boot/bin/$objdir/$exename$EXESUFFIX") ||
    die ("$exename$EXESUFFIX");
}

sub copygrammar
{
    my($dir, $name) = @_;
    $sdir = "$betalib/$dir/";
    $ddir = "$betalib/boot/grammars/$name/";
    copy("$sdir/$name-meta.ast$ENDIAN", "$ddir/$name-meta.ast$ENDIAN") ||
        die ("$name-meta");
    copy("$sdir/$name-pretty.ast$ENDIAN", "$ddir/$name-pretty.ast$ENDIAN") ||
        die ("$name-pretty");
    copy("$sdir/$name.ast$ENDIAN", "$ddir/$name.ast$ENDIAN") ||
        die ("$name");
    copy("$sdir/$name-meta.gram", "$ddir/$name-meta.gram") ||
        die ("$name-meta");
    copy("$sdir/$name-pretty.pgram", "$ddir/$name-pretty.pgram") ||
        die ("$name-pretty");
    copy("$sdir/$name-parser.bobs", "$ddir/$name-parser.bobs") ||
        die ("$name-parser.bobs");
    copy("$sdir/$name-parser.btab$ENDIAN", "$ddir/$name-parser.btab$ENDIAN") ||
        die ("$name-parser.btab$ENDIAN");
    copy("$sdir/$name-parser.lst", "$ddir/$name-parser.lst") ||
        die ("$name-parser.lst");
    #copy("$sdir/$name-pretty.auto", "$ddir/$name-pretty.auto") ||
        #die ("$name-pretty.auto");
    copy("$sdir/$name-pretty.lst", "$ddir/$name-pretty.lst") ||
        die ("$name-pretty.lst");
    #copy("$sdir/$name-pretty.pretty", "$ddir/$name-pretty.pretty") ||
        #die ("$name-pretty.pretty");
    copy("$sdir/$name-pretty.ptbl$ENDIAN", "$ddir/$name-pretty.ptbl$ENDIAN") ||
        die ("$name-pretty.ptbl$ENDIAN");
    copy("$sdir/${name}cfl.bet", "$ddir/${name}cfl.bet") ||
        die ("${name}cfl.bet");
    copy("$sdir/${name}traverse.bet", "$ddir/${name}traverse.bet") ||
        die ("${name}traverse.bet");
    copy("$sdir/tables", "$ddir/tables") ||
        die ("tables");
}
