#!/usr/local/bin/perl

use File::Copy;

# Script to compile betarun

$betalib = $ENV{"BETALIB"};
$betalib =~ s/\\/\//g;
if ($betalib eq "") { die "\$BETALIB is not set" }
$ENV{"BETALIB"} = $betalib;

$betarun_dir = $betalib . "/betarun-src";

$arch = $^O;
$make = "gmake";
$gnuc = "yes";
$exe = "";
$endian = "";

if ($arch =~ /win/i) {
  $endian = "L";
  $btabtype = "btabL";
  $exe = ".exe";
  $arch = "nti_" . $ENV{"MIA_SDK"};
  $arch =~ tr/A-Z/a-z/;
  $runtype = "run";
  if ($arch eq "nti_ms") {
    $gnuc = "no";
  } elsif ($runtype eq "nti_gnu") {
  } else {
    die "\$MIA_SDK is not set";
  }
} elsif ($arch eq "linux") {
  $endian = "L";
  $make = "make";
  $runtype = "run";
} elsif ($arch eq "irix") {
  $arch = "sgi";
  $runtype = "newrun";
  $gnuc = "no";
} elsif ($arch eq "solaris") {
  $arch = "sun4s";
  $runtype = "crun";
} elsif ($arch eq "hpux") {
  $arch = "hpux9pa";
  $runtype = "crun";
} else {
  die "Couldn't recognise $arch as a valid BETA-supported architecture";
}

if ($ARGV[0] =~ /^--?V/ ||
    $ARGV[0] =~ /^--?h/ ||
    $ARGV[0] =~ /^--?u/) {
    print stderr "mbs_mkboot: Move current files to boot area for checking in.\n";
    exit 1;
}

chdir($betalib) || die "Couldn't change directory to BETALIB ($betalib)";

&copybin("beta");
&copybin("rungen") if ($runtype eq "run");
&copybin("gen");
&copybin("exbobs");
&copybin("tabc");
&copybin("makepretty");
&copybin("morepretty");

&copygrammar("grammars/beta", "beta");
&copygrammar("grammars/metagram", "metagrammar");
&copygrammar("grammars/pretty", "prettyprint");
&copygrammar("betarun-src/GEN/GRAMMAR/", "runtime");


sub copybin
{
    my($exename) = @_;
    copy("$betalib/bin/$arch/$exename$exe", "$betalib/boot/bin/$arch/$exename$exe") ||
    die ("$exename$exe");
}

sub copygrammar
{
    my($dir, $name) = @_;
    $sdir = "$betalib/$dir/";
    $ddir = "$betalib/boot/grammars/$name/";
    copy("$sdir/$name-meta.ast$endian", "$ddir/$name-meta.ast$endian") ||
        die ("$name-meta");
    copy("$sdir/$name-pretty.ast$endian", "$ddir/$name-pretty.ast$endian") ||
        die ("$name-pretty");
    copy("$sdir/$name.ast$endian", "$ddir/$name.ast$endian") ||
        die ("$name");
    copy("$sdir/$name-meta.gram", "$ddir/$name-meta.gram") ||
        die ("$name-meta");
    copy("$sdir/$name-pretty.pgram", "$ddir/$name-pretty.pgram") ||
        die ("$name-pretty");
    copy("$sdir/$name-parser.bobs", "$ddir/$name-parser.bobs") ||
        die ("$name-parser.bobs");
    copy("$sdir/$name-parser.btab$endian", "$ddir/$name-parser.btab$endian") ||
        die ("$name-parser.btab$endian");
    copy("$sdir/$name-parser.lst", "$ddir/$name-parser.lst") ||
        die ("$name-parser.lst");
    #copy("$sdir/$name-pretty.auto", "$ddir/$name-pretty.auto") ||
        #die ("$name-pretty.auto");
    copy("$sdir/$name-pretty.lst", "$ddir/$name-pretty.lst") ||
        die ("$name-pretty.lst");
    #copy("$sdir/$name-pretty.pretty", "$ddir/$name-pretty.pretty") ||
        #die ("$name-pretty.pretty");
    copy("$sdir/$name-pretty.ptbl$endian", "$ddir/$name-pretty.ptbl$endian") ||
        die ("$name-pretty.ptbl$endian");
    copy("$sdir/${name}cfl.bet", "$ddir/${name}cfl.bet") ||
        die ("${name}cfl.bet");
    copy("$sdir/${name}traverse.bet", "$ddir/${name}traverse.bet") ||
        die ("${name}traverse.bet");
    copy("$sdir/tables", "$ddir/tables") ||
        die ("tables");
}
