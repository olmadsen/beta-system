#!/usr/local/bin/perl5 -s
#-*-Perl-*-

require "dirlist";

# '-a' makes it read from "$BETALIB/mbs_cvscommit.logmsg"
$readfromfile = 1 if (defined $a);

$|=1;

sub getlines {
    local($result);
    if ($readfromfile) {
	$result = `cat $betalib/mbs_cvscommit.logmsg`;
	return $result;
    }
    print "Newlines are accepted. ";
    print "End by typing Cntl-D or '.' alone on a line:\n";
    while(<STDIN>){
        if ($_ eq ".\n"){
            last;
        } else {
	    chop $_;
            $result .= "$_\n";
        }
    }
    chop $result;
    return $result;
}

if ($readfromfile) {
    print "\nFound '-a' on commandline!\n";
    print "Using \"$betalib/mbs_cvscommit.logmsg\" as logmsg.\n";
}
print "This script will do a 'cvs commit' in each directory in $betalib.\n";

print "Are you sure that you want to commit in all of these directories? (no/yes) ";

$yes = &GetAnswer();
exit if ($yes ne 'yes');

print "\nWould you like to see local changes before committing? (yes/no) ";
$doprompt = &GetAnswer();

foreach $dir (@Dirs) {
    if ($CvsTags{$dir} =~ /^\%(\S+)/) {
	next if ($1 eq 'IGNORE');
	next if ($1 eq 'NONCVS');
	print "Unknown '%'-tag in CvsTag: \"$1\", skipping $dir\n";
	next;
    }
    ($cvsmodule, $tag) = split(/\@/,$CvsTags{$dir});
    if ($cvsmodule =~ /\//){
	print "  [$cvsmodule is a sub-repository, skipped]\n";
	next;
    }
    $basedir = "$betalib/$dir";
    next if (!-d &path($basedir));
    print "**** Examining $basedir ****\n";
    chdir &path($basedir) or die "Unable to chdir: $!";
    @diff = &cvsoutput('-Q diff');
    $diff = "";
    foreach $line (@diff) {
	if ($line =~ /^\?/) {
	    print $line;
	} else {
	    $diff .= $line;
	}
    }
    if (2 < length($diff)) {
	print "Commit needed.\n";
	if ($doprompt eq 'yes') {
	    print "Local changes:\n$diff\n";	    
	}
	print  "\nIn $basedir:\nUpdate & Commit local changes? (y/n/q) ";
	$answer = &GetAnswer();
	if ($answer eq "y"){
	    # just go on
	} elsif ($answer eq "n"){
	    next;
	} elsif ($answer eq "q"){
	    exit 0;
	}
	&cvs('up');
	if ($MACHINETYPE ne 'NTI') {
	    print "\nEnter logmessage for commit:\n" unless ($readfromfile);
	    $msg = &getlines;
	    #print "cvs -q commit -m '$msg'\n";
	    &cvs("-q commit -m '$msg'");
	    exit(1) if ($?);
	} else {
	    # '-m' does not work with stupid PC-shell.
	    &cvs("-q commit");
	}
    }
}

