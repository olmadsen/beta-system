#!/usr/local/bin/perl5 -s
#-*-Perl-*-

push(@INC, $ENV{'BETALIB'} . "/bin/admin");

if ($h){
    print "Usage: mbs_cvscommit [-h][-u][-a]\n";
    print "          -h   Print this help\n";
    print "          -v   Verbose output\n";
    print "          -n   No effects - only print what would be done\n";
    print "          -u   Use defaults - ask no questions\n";
    print "          -a   Use BETALIB/mbs_cvscommit.logmsg as logmsg.\n";
    exit 0;
}

require "dirlist";

# '-a' makes it read from "$BETALIB/mbs_cvscommit.logmsg"
$readfromfile = 1 if (defined $a);
$DontAskStupid = 1 if (defined $u);
$nflag = "-n " if (defined $n);

$|=1;

sub getlines {
    local($result);
    if ($readfromfile) {
	$result = `cat $betalib/mbs_cvscommit.logmsg`;
	return $result;
    }
    print "Newlines are accepted. ";
    print "End by typing Cntl-D or '.' alone on a line:\n";
    while(<STDIN>){
        if ($_ eq ".\n"){
            last;
        } else {
	    chop $_;
            $result .= "$_\n";
        }
    }
    chop $result;
    return $result;
}

if ($readfromfile) {
    print "\nFound '-a' on commandline!\n";
    print "Using \"$betalib/mbs_cvscommit.logmsg\" as logmsg.\n";
}
print "This script will do a 'cvs commit' in each directory in $betalib.\n";

print "Are you sure that you want to commit in all of these directories? (no/yes) ";

$yes = &GetAnswer();
exit if ($yes ne 'yes');

print "\nWould you like to see local changes before committing? (yes/no) ";
$doprompt = &GetAnswer();

foreach $basedir ("$betalib/compiler", "$betalib/betarun", $betalib) {
    next if (!-d &path($basedir));
    print "**** Examining $basedir ****\n";
    chdir &path($basedir) or die "Unable to chdir: $!";
    @diff = &cvsoutput('-Q diff');
    $diff = "";
    foreach $line (@diff) {
	if ($line =~ /^\?/) {
	    print $line;
	} else {
	    $diff .= $line;
	}
    }
    if (2 < length($diff)) {
	print "Commit needed.\n";
	if ($doprompt eq 'yes') {
	    print "Local changes:\n$diff\n";	    
	}
	if (!$DontAskStupid) {
	    print  "\nIn $basedir:\nUpdate & Commit local changes? (y/n/q) ";
	    $answer = &GetAnswer();
	    if ($answer eq "y"){
		# just go on
	    } elsif ($answer eq "n"){
		next;
	    } elsif ($answer eq "q"){
		exit 0;
	    }
	}
	&cvs('up');
	if ($MACHINETYPE ne 'NTI') {
	    print "\nEnter logmessage for commit:\n" unless ($readfromfile);
	    $msg = &getlines;
	    #print "cvs -q commit -m '$msg'\n";
	    if ($basedir eq $betalib) {
		&cvs("$nflag-q commit -m '$msg'");
	    } else {
	        system("mbs_commit $nflag-d -m '$msg'");
	    }
	    exit(1) if ($?);
	} else {
	    # '-m' does not work with stupid PC-shell.
	    if ($basedir eq $betalib) {
		&cvs("$nflag-q commit");
	    } else {
	        system("mbs_commit $nflag-d");
	    }
	}
    }
}

