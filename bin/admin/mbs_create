#!/usr/local/bin/perl5
#-*-Perl-*-

$betalib=$ENV{'BETALIB'} || die "$0: BETALIB must be set!\n";
$betalib =~ s#\\#/#g;

if (-e "c:\\") {
    $MACHINETYPE = "NTI";
} else {
    $MACHINETYPE = "NONNTI";
}

print "\nThis script will checkout a complete source file directory\n";
print "for the Mjolner BETA System from cvs using DEFAULT cvs tags as\n";
print "specified in the current head-revision of bin_admin/dirlist.txt.\n";
print "The directory will be placed where BETALIB indicates.\n";
print "The current value of BETALIB is\n";
print "\t$betalib\n\n";

print "Are you sure that you want to do this? (no/yes) ";
$yes = <STDIN>;
chop $yes;
exit if ($yes ne 'yes');

#if (-d "$betalib/basiclib"){
#    print "\n$betalib/basiclib already exists.\n";
#    print "I will not overwrite an existing BETALIB containing a basiclib directory.\n";
#    print "You should set BETALIB to identify the NEW directory,\n";
#    print "you wish to create.\n\n";
#    exit(1);
#}


if (-d "$betalib/bin/admin"){
    print "\nUsing existing $betalib/bin/admin.\n";
    print "\tchdir $betalib/bin\n";
    chdir ("$betalib/bin") || die "failed to chdir($betalib/bin)\n";
    print "\tcvs -Q update\n";
    system("cvs -Q update"); 
    print "\n";
} else {
    print "Setting up initial bin directory:\n";
    if (!-d "$betalib"){
	print "\tmkdir $betalib\n";
	mkdir ("$betalib", 0755) || die "failed to mkdir($betalib)\n";
    }
    
    if (!-d "$betalib/bin"){
	print "\tchdir $betalib \n";
	chdir ("$betalib") || die "failed to chdir($betalib)\n";
	if ("$MACHINETYPE" eq "NTI"){
	    print "\tcvs -Q get -d bin bin_nti\n";
	    system("cvs -Q get -d bin bin_nti"); 
	} else {
	    print "\tcvs -Q get -d bin bin_unix\n";
	    system("cvs -Q get -d bin bin_unix"); 
	}
    }
    
    print "\tchdir $betalib/bin\n";
    chdir ("$betalib/bin") || die "failed to chdir($betalib/bin)\n";
    
    print "\tcvs -Q get -d admin bin_admin\n";
    system("cvs -Q get -d admin bin_admin"); 
    
    print "Initial setup completed.\n\n";
    chdir ("$betalib");
}

print "The rest of the checkout will be performed using\n";
print "\t$betalib/bin/admin/mbs_cvsget\n";
print "which reads the text file\n";
print "\t$betalib/bin/admin/dirlist.txt\n\n";

print "Please inspect this file, and verify that it is correct.\n";
print "Type \'g\' to go on, and any other letter to quit: ";
$go = <STDIN>;
chop $go;
exit if ($go ne 'g');

print "\nInvoking $betalib/bin/admin/mbs_cvsget:\n\n";

if ("$MACHINETYPE" eq "NTI"){
    system("perl $betalib/bin/admin/mbs_cvsget --usedefaults");
} else {
    system("$betalib/bin/admin/mbs_cvsget --usedefaults");
}

print "\n----\n\n";
print "MBS checkout completed.\n\n";
print "Notice that $betalib/bitmap contains a PACKED file for NTI\n";
print "Please inspect the file $betalib/bitmap/README.nti for details.\n\n";

print "To build the software in $betalib, please consult the web page:\n\n";
print "\thttp://www.mjolner.dk/Quality/mbsboot.html\n\n";

