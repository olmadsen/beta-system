#!/usr/local/bin/perl5 -s -I/users/beta/r4.0.3/bin/admin
#-*-Perl-*-

$betalib=$ENV{'BETALIB'} || die "$0: BETALIB must be set!\n";
$|=1;

if (-e "c:\\") {
    $OS = 'WIN';
    $betalib =~ s#\\#/#g;
} elsif (-e "/etc") {
    $OS = 'UNIX';
} else {
    $OS = 'MAC';
    $betalib =~ s#:#/#g;
}
$betalib =~ s#/$##g;

sub cvs {		# SPECIAL hacked version due to merge...
  if ($OS eq 'MAC'){
      $maccvs=$ENV{'maccvs'}."MacCvs";
      $cwd=`Directory`; chop $cwd;
      $outfile=$ENV{'tempfolder'}."cvs.out";
      
      unlink($outfile) if (-f "$outfile");
      $script  = "tell application \"$maccvs\"\n";
      $script .= "do script { \"@_\" } environment { \"CVSROOT\", \"ariel:/users/beta/.CVSHOME\" } pathway \"$cwd\" mode file filename \"$outfile\"\n";
      $script .= "end tell";
      &MacPerl::DoAppleScript($script);
      while(! -f "$outfile") { sleep(1) }
      open (OUT, "<$outfile") || die "cvs: cannot open $outfile\n";
      @output = <OUT>;
      close OUT;
  } elsif ($OS eq 'UNIX') {
      @output = `cvs @_ 2>&1`;
  } else {
      @output = `cvs @_ `;
  }
  push(@CvsResults, @output);
  return @output;
}

sub path { 
    my($p)=@_;
    if ($OS eq 'WIN'){
	$p =~ s#/#\\#g;
    } elsif ($OS eq 'MAC'){
	$p =~ s#/#:#g;
    } 
    return $p;
}

sub GetAnswer
{
    local ($answer);
    if ($OS eq 'MAC'){
	print "\n";
    }
    $answer=<STDIN>; chop $answer;
    return $answer;
}

print "\nThis script will checkout a complete source file directory\n";
print "for the Mjolner BETA System from cvs using DEFAULT cvs tags as\n";
print "specified in the file bin_admin/dirlist.txt.\n";
print "The directory will be placed where BETALIB indicates.\n";
print "The current value of BETALIB is\n";
print "\t$betalib\n\n";

print "Are you sure that you want to do this? (no/yes) ";
$yes = &GetAnswer();
exit if ($yes ne 'yes');

print "Enter CVS tag to merge into ALL that is created (default: NONE) ";
$mergeFrom = &GetAnswer();
if ($mergeFrom eq "" || $mergeFrom eq "NONE"){
    $mergeFrom = "";
} else {
    $mergeFrom = "-j $mergeFrom ";
    if ($OS ne 'UNIX') {   
	print "Don't run a merging get on anything but unix!\n";
	exit(1);
    }
}

if (-d &path("$betalib/bin/admin")){
    print "\nUsing existing $betalib/bin/admin.\n";
    print "\tchdir $betalib/bin\n";
    chdir (&path("$betalib/bin")) || die "failed to chdir($betalib/bin)\n";
    print "\tcvs -Q update\n";
    print &cvs("-Q update"); 
    print "\n";
} else {
    print "Setting up initial bin directory.\n";
    print "Enter CVS tag for bin and bin_admin repositories (default: HEAD) ";
    $bintag = &GetAnswer();
    if ($bintag eq "" || $bintag eq "HEAD"){
	$bintag = "";
    } else {
	$bintag = "-r $bintag ";
    }

    $bintag .= $mergeFrom;

    if (!-d &path("$betalib")){
	print "\tmkdir $betalib\n";
	mkdir (&path($betalib), 0750) || die "failed to mkdir($betalib)\n";
    }
    
    if (!-d &path("$betalib/bin")){
	print "\tchdir $betalib \n";
	chdir (&path("$betalib")) || die "failed to chdir($betalib)\n";
	if ("$OS" eq "WIN"){
	    print "\tcvs -Q get ${bintag}-d bin bin_nti\n";
	    &cvs("-Q get ${bintag}-d bin bin_nti"); 
	} elsif ("$OS" eq "MAC"){
	    print "\tcvs -Q get ${bintag}-d bin bin_mpw\n";
	    &cvs("-Q get ${bintag}-d bin bin_mpw");
	} else {
	    print "\tcvs -Q get ${bintag}-d bin bin_unix\n";
	    &cvs("-Q get ${bintag}-d bin bin_unix"); 
	}
    }
    
    print "\tchdir $betalib/bin\n";
    chdir (&path("$betalib/bin")) || die "failed to chdir($betalib/bin)\n";
    
    print "\tcvs -Q get ${bintag}-d admin bin_admin\n";
    &cvs("-Q get ${bintag}-d admin bin_admin"); 
    
    print "Initial setup completed.\n\n";
    chdir (&path("$betalib"));
}

if ($mergeFrom) {
    $conflicts = 0;
    foreach $line (@CvsResults) {
	chop $line;
	if ($line =~ /^rcsmerge\: warning\: conflicts during merge/) {
	    if (!$conflicts) {
		$conflicts=1;
		print "There were mergeconflicts in the following files:\n";
	    }
	    print "$prev:\n";
	}
	$prev = $line;
    }
    print "\n";
    if ($conflicts) {
	print "Fix these now, and commit them,\n ";
	print "\tIF YOU KNOW WHAT YOU ARE DOING!\n";
	print "Then restart the process...\n";
	exit(0);
    }
}

print "The rest of the checkout will be performed using\n";
print "\t$betalib/bin/admin/mbs_cvsget\n";
print "which reads the text file\n";
print "\t$betalib/bin/admin/dirlist.txt\n\n";

print "Please inspect this file, and verify that it is correct.\n";
print "Type \'g\' to go on, and any other letter to quit: ";
$go = &GetAnswer();
exit if ($go ne 'g');

print "\nInvoking $betalib/bin/admin/mbs_cvsget:\n\n";

$UseDefaults=1;
require &path("$betalib/bin/admin/mbs_cvsget");

exit (1) if ($?);

print "\n----\n\n";
print "MBS checkout completed.\n\n";

print "To build the software in $betalib, please consult the web page:\n\n";
print "\thttp://www.mjolner.dk/Quality/mbsboot.html\n\n";

