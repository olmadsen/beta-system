#!/usr/local/bin/perl -s

#---------- configuration ------------

# compiler options
$betaopts="-qwlx";

push(@INC, $ENV{'BETALIB'} . "/bin/admin");
require "dirlist";

if ($h){
    print "Usage: mbs_compile ${std_options}[-j][-d][-c]\n";
    print_stdoptions();
    print "          -j   Target jvm\n";
    print "          -d   Target clr\n";
    print "          -c   Continue after compilation errors\n";
    print "       Compile all libraries in BETALIB using \"beta $betaopts\"\n";
    exit 0;
}



#---------- don't change below -------

if (length($ENV{'BETART'})>0){
    print "mbs_compile:\n   ***warning: ignoring old setting of BETART: " . $ENV{'BETART'} . "\n";
    $ENV{'BETART'} = "";
}

open(STDERR, ">&STDOUT") || die "Can't dup stdout";
select(STDERR); $| = 1;       # make unbuffered
select(STDOUT); $| = 1;       # make unbuffered

# $LinkAllFlag = 1 if ($OS ne "MAC");

foreach $arg (@ARGV) {
    if ($arg =~ /^\-\-startfrom=(.+)$/) {
	$StartFromDir = $1;
    } else {
	print "Did not understand argument \"$arg\", forwarding it to beta\n";
	$betaopts .= " $arg";
    }
}

sub DoLinkAll {
    local ($files) = @_;
    local ($fragment, $doit);
    local (@files) = split(' ', $files);
    $linkdir = "linkall-$MACHINETYPE";
    mkdir ($linkdir, 0755);
    chdir $linkdir or die "$!";
    print "Performing a linkall to create shared libraries\n";
    open ALL, ">mbs_linkall.bet" or die "$!";
    print ALL "ORIGIN '~beta/basiclib/systemenv';\n";
    foreach $file (@files) {
	if ($file =~ /^([^.]+).bet$/) {
	    $fragment = $1;
	    open F, "<../$file" || die "$!";
	    $doit = 1;
	    while ($line = <F>) {
		if ($line =~ /program:\s*descriptor/i) {
		    $doit = 0;
		}
	    }
	    if ($doit) {
		print ALL "INCLUDE '../$fragment';\n";
	    }
	} else {
	    print "'$file' is not a bet file?\n";
	}
    }
    print ALL "--PROGRAM: descriptor--\n(#\ndo\n#)\n";
    close ALL;
    &beta("mbs_linkall") if ($doit);
    chdir '..';
    SmartRmDir($linkdir);
}

&PrintDate;
print "$0 STARTED\n";
print "compiling $RELEASE with command \"" . &compiler_name() . " $betaopts\"\n";

if ($MACHINETYPE =~ /^nti/ && $ENV{'MIASDK'} ne 'bor') {
    chdir "$betalib/bin" || die "chdir $betalib/bin: $!";
    if ((!-e "betacc.exe") || (-M "betacc.bet" < -M "betacc.exe")) {
	print "Building betacc...\n";
	system("beta -qwl betacc");
	print "Copying to s:/betabin for local use\n";
	system("copy %BETALIB%\\bin\\betacc.exe s:\\betabin\\betacc.exe");
    }
}

print "\n";
print "doing libraries WITH debug info...\n";
foreach $dir (@Dirs) {
    next if (!$CompileFlag{$dir});
    $basedir = "$betalib/$dir";
    next if (!-d &path($basedir));
    if ($StartFromDir) {
	if (substr($dir,0,length($StartFromDir)) eq $StartFromDir) {
	    undef $StartFromDir;
	} else {
	    print "StartFrom: skipping $dir\n";
	    next;
	}
    }
    print "**** $basedir (with debug) ****\n";
    chdir &path($basedir) || die "Unable to chdir: $!";
    opendir (DIR, &path($basedir)) || die "Unable to readdir: $!";
    undef $files;
    foreach (readdir(DIR)) {
	$files .= " $_" if (/\.bet$/);
    }
    &beta("$betaopts $files") if ($files);
    exit(1) if ($? && !defined($continue));
    &DoLinkAll($files) if ($LinkAllFlag);
}
print "libraries with debug info COMPLETE\n";

if ($OS eq "UNIX"){
    print "\n";
    print "Not doing libraries WITHOUT debug info anymore (obsolete)...\n";
}

print "\n";
&PrintDate;
print "$0 COMPLETE\n";
