#!/usr/local/bin/perl
#-*-Perl-*-

$betalib=$ENV{'BETALIB'}  || "/users/beta";
$betalib =~ s#\\#/#g;

#---------- configuration ------------

$dirs=require "$betalib/bin/admin/dirlist4.0";

# compiler version
$BETA="beta -qwlx";
$RELEASE="r4.0";

#---------- don't change below -------

open(STDERR, ">&STDOUT") || die "Can't dup stdout";
select(STDERR); $| = 1;       # make unbuffered
select(STDOUT); $| = 1;       # make unbuffered

print "compiling $RELEASE using \"$BETA $*\"\n";

system("date");
print "$0 STARTED\n";

if ($MACHINETYPE ne "NTI"){
    print "\n";
    print "doing libraries WITH debug info...\n";
    foreach $dir (split(' ', $dirs)) {
	($basedir ="$betalib/$dir") =~ s#/$##;
	next if (! -d $basedir);
	print "**************** $basedir *****************\n";
	chdir $basedir || die "Unable to chdir: $!";
	opendir (DIR, "$basedir") || die "Unable to readdir: $!";
	undef $files;
	foreach (readdir(DIR)) {
	    $files .= " $_" if (/\.bet$/);
	}
	system "$BETA $files" if ($files);
    }
    print "libraries with debug info COMPLETE\n";
}

print "\n";
print "doing libraries WITHOUT debug info...\n";
foreach $dir (split(' ', $dirs)) {
    ($basedir ="$betalib/$dir") =~ s#/$##;
    next if (! -d $basedir);
    print "**************** $basedir *****************\n";
    chdir $basedir || die "Unable to chdir: $!";
    opendir (DIR, "$basedir") || die "Unable to readdir: $!";
    undef $files;
    foreach (readdir(DIR)) {
	$files .= " $_" if (/\.bet$/);
    }
    system "$BETA -d $files" if ($files);
}
print "libraries with debug info COMPLETE\n";


print "\n";
system 'date';
print "$0 COMPLETE\n";
