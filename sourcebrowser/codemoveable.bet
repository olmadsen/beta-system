ORIGIN '~beta/guienv/v1.2/guienv';
BODY 'private/codemoveablebody';

INCLUDE '~beta/objectbrowser/v2.0/UI/moveable';
INCLUDE '~beta/objectbrowser/v2.0/UI/icons';
INCLUDE '~beta/objectbrowser/v2.0/options';
INCLUDE '~beta/editor/v5.0/codeviewer';

INCLUDE '~beta/guienv/v1.2/utils/guienvadds';
(* windowItem.{PreferredSize,BringToFront} *)

--- guienvlib:attributes ---

codemoveableEditorList: List 
  (# (*element:: window.codemoveableEditor;*)
     onInsert:<
       (# theCodemoveableEditor: ^window.codemoveableEditor;
       enter theCodemoveableEditor[]
       do INNER
       #);
     onDelete:<
       (# theCodemoveableEditor: ^window.codemoveableEditor;
       enter theCodemoveableEditor[]
       do INNER
       #); 
     newscan: scan
       (# cur: ^window.codemoveableEditor;
       do current[]->cur[]; INNER;
       #);
  #);

getcodemoveableEditorList: objectPool.get
  (# type::< codemoveableEditorList; init:: (# do obj.init #)#);

--- windowLib:attributes ---

codemoveableEditor: sifTextEditor
  (#
     <<SLOT codemoveableEditorLib:attributes>>;
     open::< 
       (# defaultSize:: (# do mysize->value #);
          mysize: @Point;
       enter mysize
       do <<SLOT codemoveableEditorOpen:descriptor>> 
       #);
     close::<
       (# 
       do <<SLOT codemoveableEditorClose:descriptor>>
       #);
     cmeprivate: @<<SLOT codemoveableEditorPrivate:descriptor>>;
     contentsType::<
       (# eventHandler::<
            (# onMouseDown::<
                 (# 
                 <<SLOT codemoveableEditorOnMouseDown:dopart>>
                 #);
               onKeyDown::<
                 (# 
                 <<SLOT codemoveableEditorOnKeyDown:dopart>>
                 #);
            #);
       #);
     codeViewerType::< codeviewer
       (# selectNode::<
            (# do node[]->this(codemoveableEditor).selectNode #)
       #);
     selectNode:< 
       (# node: ^astInterface.ast
       enter node[]
       do INNER
       #);
     select:
       (# node: ^astInterface.ast;
       enter node[]
       <<SLOT codemoveableEditorSelect:dopart>>
       #);
     update:
       (# 
       <<SLOT codemoveableEditorUpdate:dopart>>
       #);
     
     encl: ^codemoveableEditorEncloser;
     getencloser:<
       (# theEncloser: ^codemoveableEditorEncloser;
       do INNER; theEncloser[]->encl[];
       exit theEncloser[]
       #);
  #);

codemoveableEditorEncloser:
  (# tryclose:< (* Called when this codeview should be closed. *) 
       Object;
     onHighLight:< (* Called when this codeview should attract attention. *)
       Object;
     getAST:< (* Should return the astInterface used. *)
       (# AST: ^astInterface;
       do INNER
       exit AST[]
       #);
     getBETACFL:< (* Should return the BETA grammar used. *)
       (# BETACFL: ^astInterface.beta;
       do INNER
       exit BETACFL[]
       #);
  #);

codemoveable: moveable
  (# contentsType::<
       (# initialNode: ^astInterface.ast;
          editorType:< codeMoveableEditor
            (# charWidthType:: (# do moveableHeader.style->ts[] #);
               getencloser:: (# do editorEncloser[]->theEncloser[] #);
            #);
          editor: @editorType;
          open::<
            (# 
            do <<SLOT codemoveableContentsOpen:descriptor>>
            #);
          dobindings::<
            (# 
            <<SLOT codemotabledobindings:dopart>>
            #);
       #);
     
     editorEncloserType:< codemoveableEditorEncloser
       (# onHighLight:: (# do wriggle #);
          tryclose:: (# do THIS(codemoveable).close #);
       #);
     editorEncloser: @editorEncloserType;
     
     
     moveableMenu::<
       (# open::<
            (# mi: ^actionedMenuItem;
            do &actionedMenuItem[]->mi[];
               (codemoveableFitAction##,NONE,NONE,'Fit to contents')->mi.open;
               INNER;
            #);
       #);
     codemoveableFitAction: actionedMenuItemAction
       (# 
       do contents.editor.preferredSize->newPreferredContentsSize;
       #);
     codemoveableOpenInWindowAction: actionedMenuItemAction
       (# 
       <<SLOT codemoveableOpenInWindowAction:dopart>>
       #);
     open::<
       (#
       enter contents.initialnode[]
       do <<SLOT codemoveableopen:descriptor>>
       #);
     close::<
       (# 
       do <<SLOT codemoveableclose:descriptor>>
       #);
     icon::
       (#
       do 'CodeView_Icon'->(getIconDB).getIcon->theIcon[];
       #);
  #);
