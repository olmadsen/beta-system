ORIGIN '~beta/basiclib/v1.4/betaenv';
BODY 'private/ymerBody'
     'private/ymerMenus'
     'private/parseProjects'
     'private/splitDependency';
INCLUDE '~beta/objectbrowser/v2.0/mpsinterface'
        '~beta/objectbrowser/v2.0/betagrammarinit'
        '~beta/objectbrowser/v2.0/UI/labelled'
        '~beta/dependency/v1.0/dependency'
        'xprompts'
        'sourcebrowser';
-- lib: Attributes --
ymerApplication: guienv
  (#
     <<SLOT ymerApplicationLib:Attributes>>;
     mps: @mpsinterface
       (#
          onOldGroup:: 
            (# t: @text
            do
               'Fragment not parsed.\nShould this be done?'->t;
               (ymerBrowser[],'Notification',t[])
                 ->promptForBoolean
                   (#
                      ok::  (#  do true->allowParsing #);
                      notok:: 
                        (# 
                        do
                           false->allowParsing;
                           (ymerBrowser.browser.currentProject[],none )
                             ->ymerBrowser.browser.setGroup
                        #);
                      cancel:: 
                        (# 
                        do
                           false->allowParsing;
                           (ymerBrowser.browser.currentProject[],none )
                             ->ymerBrowser.browser.setGroup
                        #);
                      
                   #);
               true->continue
            #);
          onUncheckedGroup:: 
            (# t: @text
            do
            (* 'Fragment not checked (i.e. no semantic information available).\nShould this be done?'
             ->t;
             (ymerBrowser[],'Notification',t[])
             ->promptForBoolean
             (#
             ok::  (#  do true->allowChecking #);
             notok::  (#  do true->allowChecking #);
             cancel::  (#  do false->allowChecking #);
             
             #);
             *) true->allowChecking; true->continue
            #);
          onParseErrors::  (#  <<SLOT ymerMPSparseErrors:DoPart>> #);
          onNewGroup:: 
            (# 
            do (*true->continue*) 
            #);
          onOtherError:: 
            (# 
            do
               (none ,errorText[],
                'Error during opening of group')->alertUser;
               true->continue
            #);
          betaparserinit: <<SLOT ymerMPSbetaparserinit:Descriptor>>;
          init:: 
            (# 
            do
               betagrammarinit;
               betaparserinit;
               dg.graphInit
            #);
          dg: @AST.dependencyGraph;
          
       #);
     browsers: @list (# element:: ymerBrowserWindow #);
     ymerBrowser: @ymerBrowserWindow;
     ymerBrowserWindowCount: @integer;
     ymerBrowserWindow:< window
       (#
          <<SLOT fragmentBrowserLib:Attributes>>;
          ymerLocalWindow: window
            (#
               open::< 
                 (# 
                 do
                    INNER ;
                    THIS(ymerLocalWindow
                    )[]
                      ->
                        (THIS(ymerBrowserWindow).theMenubar).windowsMenu.
                          insertWindow;
                    
                 #);
               eventhandler::< 
                 (#
                    onAboutToClose::< 
                      (# 
                      do
                         INNER ;
                         (if okToClose then
                             THIS(ymerLocalWindow)[]
                               ->
                                 (THIS(ymerBrowserWindow).theMenubar).
                                 windowsMenu.deleteWindow
                         if);
                         
                      #)
                 #);
               close::< 
                 (# 
                 do
                    THIS(ymerLocalWindow)[]
                      ->
                        (THIS(ymerBrowserWindow).theMenubar).windowsMenu.
                          deleteWindow
                 #)
            #);
          addProject:
            (# name,location: ^text; newProj: ^browser.projects.project; 
            enter (name[],location[])
            <<SLOT ymerAddProject:DoPart>>
            #);
          ph: @pathHandler;
          browser: @sourcebrowser
            (#
               <<SLOT browserLib:Attributes>>;
               selectNode:: 
                 (# 
                 do
                    (((node.frag.father).fullName).copy,(node.frag.name).copy)
                      ->selectFragmentForm;
                    (node[],1,0,0)->(getFragmentFormEditor).SifViewer.setFocus;
                    
                 #);
               followLink::  (#  do groupname[]->selectFragmentGroup #);
               makeFileEdit::  (#  <<SLOT browserFileEdit:DoPart>> #);
               projectInfoType:: 
                 (#
                    <<SLOT projectInfoLib:Attributes>>;
                    formList: list
                      (# element::  (# location: @text #) #);
                    groupList: list (# element:: group #);
                    projectList: list
                      (#
                         element:: project;
                         <<SLOT parseDefn:Attributes>>;
                         parseProjectFile:
                           (#
                              projectFile: ^text;
                              newProj: ^project
                           enter
                           (projectFile[],
                            newProj[])
                           <<SLOT ymerParseProjectFile:DoPart>>
                           #);
                         parseProjectsRC:
                          <<SLOT ymerParseProjectsRC:Descriptor>>;
                         
                      #);
                    theProjects: @projectList;
                    project:: 
                      (#
                         location: @text;
                         isDirectory,isDotDotDirectory,
                         isProjectFile: @boolean;
                         isRoot,isExtent,isDomain: @boolean;
                         hasSubprojects: @boolean;
                         subprojects: @projectList;
                         superProject: ^project;
                         level: @integer;
                         unfolded: @boolean;
                         groups: @groupList;
                         scanGroupsImpl:: 
                           (#
                              newGroup: ^group;
                              dependencyPrivate:
                                @<<SLOT dependencyPrivate:Descriptor>>;
                              dependencyRegister:
                                (# fgName: ^text
                                enter fgName[]
                                <<SLOT dependencyRegister:DoPart>>
                                #);
                              dependencyCreateSubprojects:
                                (# selectedProj: ^projects.project; 
                                do
                                   THIS(project)[]->selectedProj[];
                                   selectedProj.subProjects.clear;
                                   <<SLOT dependencyCreateSubprojects:Descriptor>>
                                #);
                              
                           <<SLOT scanGroupsImpl:DoPart>>
                           #)
                      #);
                    group:: 
                      (#
                         location: @text;
                         temporary: @boolean;
                         forms: @formList;
                         getfg:: 
                           (#
                              doRealOpen:
                                (#
                                   g:
                                     ^mps.AST.
                                        FragmentGroup;
                                   isRealOpen:
                                     (# isOpen: @Boolean; 
                                     do
                                        scanner: g.fragmentList.scan
                                          (# 
                                          do
                                             (if current.type
                                              // mps.AST.formType then
                                                 (if current.f[] <> none then
                                                     true->isOpen; leave scanner
                                                 if)
                                             if)
                                          #)
                                     exit isOpen
                                     #)
                                enter g[]
                                do
                                   (if not isRealOpen then (* open g real *)
                                       g.realOpen; 
                                   if);
                                   
                                #);
                              
                           do
                              (if not THIS(Group).location.empty then
                                  THIS(Group).location[]
                                    ->mps.fragmentGroupTable.getFragmentGroup
                                    ->fg[];
                                  (if fg[] <> none then fg[]->doRealOpen if)
                              if);
                              
                           #);
                         
                      #);
                    scanProjectsImpl:: 
                      (# 
                      do
                         theProjects.scan
                           (#  do current[]->thescan.foreach #)
                      #);
                    init:: 
                      (# 
                      do
                         ph.init;
                         theProjects.init;
                         theProjects.parseProjectsRC;
                         
                      #);
                    
                 #);
               projectsLabel::  (#  do 'Projects'->t[] #);
               emptyProjectListLabel:: 
                 (#  do 'No Project selected'->t[] #);
               onGroupListOpen::  (#  <<SLOT onGroupListOpen:DoPart>> #);
               onProjectListOpen:: 
                 (# 
                 <<SLOT onProjectListOpen:DoPart>>
                 #);
               onCurrentProjectChange:: 
                 (# 
                 do
                    (if newProject[] <> none then
                        newProject.location[]->locationView.contents.label
                    if)
                 #);
               onCurrentGroupChange:: 
                 (# 
                 do
                    (if newGroup[] <> none then
                        newGroup.location[]->locationView.contents.label
                    if)
                 #);
               onCurrentFormChange:: 
                 (#  <<SLOT onCurrentFormChange:DoPart>> #);
               selectFragmentGroup:
                 (# fgName: ^text
                 enter fgName[]
                 <<SLOT selectFragmentGroup:DoPart>>
                 #);
               selectFragmentForm:
                 (# fgName: ^text; formName: ^text
                 enter (fgName[],formName[])
                 <<SLOT selectFragmentForm:DoPart>>
                 #);
               eventhandler:: 
                 (#
                    onFatherFrameChanged:: 
                      (# 
                      do
                         THIS(
                         ymerBrowserWindow).size->size
                      #)
                 #);
               open::  (# w,h: @integer <<SLOT browserOpen:DoPart>> #);
               editorEncloserType:: 
                 (#
                    tryclose:: 
                      (# 
                      do
                         THIS(ymerBrowserWindow).
                           close
                      #);
                    onHighLight:: 
                      (#  do THIS(ymerBrowserWindow).wriggle #);
                    getAST::  (#  do mps.AST[]->AST[] #);
                    getBETACFL::  (#  do mps.BETACFL[]->BETACFL[] #);
                    
                 #);
               
            #);
          locationView: @labelled
            (#
               contentsType:: staticText
                 (# open::  (#  do ''->label #) #);
               open:: 
                 (# sz: @point; 
                 enter sz
                 do 'Current location'->label; sz->size; INNER
                 #)
            #);
          infoView: @labelled
            (#
               contentsType:: staticText
                 (# open::  (#  do ''->label #) #);
               open:: 
                 (# sz: @point; 
                 enter sz
                 do 'Info'->label; sz->size; INNER
                 #)
            #);
          eventhandler::< 
            (#
               onAboutToClose::< 
                 (# 
                 do
                    INNER ;
                    (if okToClose then
                        THIS(ymerBrowserWindow)[]->browsers.at->browsers.delete;
                        (if browsers.empty then
                            terminate
                         else
                            browsers.scan
                              (# 
                              do
                                 THIS(ymerBrowserWindow)[]
                                   ->
                                     (current.theMenubar).windowsMenu.
                                       deleteWindow
                              #)
                        if)
                    if)
                 #)
            #);
          close::< 
            (# 
            do
               THIS(ymerBrowserWindow)[]->browsers.at->browsers.delete;
               (if browsers.empty then
                   terminate
                else
                   browsers.scan
                     (# 
                     do
                        THIS(ymerBrowserWindow)[]
                          ->(current.theMenubar).windowsMenu.deleteWindow
                     #)
               if)
            #);
          open::< 
            (# t: ^text; w,h: @integer; 
            do
               'Mjølner Fragment Browser and Editor'->t[];
               ymerBrowserWindowCount+1->ymerBrowserWindowCount;
               (if ymerBrowserWindowCount > 1 then
                   '<'->t.put; ymerBrowserWindowCount->t.putint; '>'->t.put
               if);
               t[]->title;
               browser.open;
               browser.size-> (*(w,h);(w,h+60)->*) THIS(ymerBrowserWindow).size;
               INNER ;
               browsers.scan
                 (# 
                 do
                    THIS(ymerBrowserWindow)[]
                      ->(current.theMenubar).windowsMenu.insertWindow;
                    current[]
                      ->
                        (THIS(ymerBrowserWindow).theMenubar).windowsMenu.
                          insertWindow;
                    
                 #);
               THIS(ymerBrowserWindow)[]->browsers.append;
               
            #);
          ymerPrivate: @<<SLOT ymerPrivate:Descriptor>>;
          menubarType::< 
            (#
               fileMenu: @menu
                 (#
                    iSaveSettings: @menuItem
                      (#
                         eventhandler:: 
                           (#
                              onSelect:: 
                                (# 
                                <<SLOT menuFileSaveSettingsOnselect:DoPart>>
                                #)
                           #);
                         open::  (#  do 'Save settings'->name #)
                      #);
                    iReloadSettings: @menuItem
                      (#
                         eventhandler:: 
                           (#
                              onSelect:: 
                                (# 
                                <<SLOT menuFileReloadSettingsOnselect:DoPart>>
                                #)
                           #);
                         open::  (#  do 'Reset settings'->name #)
                      #);
                    iQuit: @menuitem
                      (#
                         eventhandler:: 
                           (#
                              onSelect:: 
                                (# cancelQuit: @boolean
                                <<SLOT menuFileQuitOnselect:DoPart>>
                                #)
                           #);
                         open:: 
                           (# 
                           do 'Close'->name
                           #)
                      #);
                    open:: 
                      (# sep: ^menuItem
                      do
                         'File'->name;
                         iSaveSettings.open;
                         iSaveSettings[]->append;
                         iReloadSettings.open;
                         iReloadSettings[]->append;
                         &separator[]->sep[];
                         sep.open;
                         sep[]->append;
                         iQuit.open;
                         iQuit[]->append;
                         
                      #);
                    
                 #);
               projectsMenu: @menu
                 (#
                    iLoad: @menuItem
                      (#
                         eventhandler:: 
                           (#
                              onSelect:: 
                                (#
                                   t: ^text;
                                   newProj: ^browser.projects.project;
                                   
                                <<SLOT menuProjectsLoadOnselect:DoPart>>
                                #)
                           #);
                         open:: 
                           (# 
                           do
                              'Load existing project'->name
                           #)
                      #);
                    iLoadStd: @menuItem
                      (#
                         eventhandler:: 
                           (#
                              onSelect:: 
                                (#
                                   projectFile: ^text;
                                   newProj: ^browser.projects.project;
                                   
                                <<SLOT menuProjectsLoadStdOnselect:DoPart>>
                                #)
                           #);
                         open:: 
                           (# 
                           do
                              'Load standard libraries'->name
                           #)
                      #);
                    iNew: @menuItem
                      (#
                         eventhandler:: 
                           (#
                              onStatus:: 
                                (# 
                                do
                                   ((browser.currentProject[] = none ) or
                                    browser.currentProject.hasSubProjects)
                                     ->value
                                #);
                              onSelect:: 
                                (#
                                   cp: ^browser.projects.project;
                                   newProjectWindow: @ymerLocalWindow
                                     (#
                                        switchWidth: @integer;
                                        height,distance,windowWidth,
                                          windowHeight: @integer;
                                        setFrame:
                                          (# 
                                          do
                                             recalc;
                                             8*height+4*distance->windowHeight;
                                             (windowWidth,windowHeight)->size;
                                             
                                          #);
                                        recalc:
                                          (# 
                                          do
                                             3->distance;
                                             (switchWidth*3)+distance*4
                                               ->windowWidth;
                                             
                                          #);
                                        bCancel: @pushButton
                                          (#
                                             setFrame:
                                               (# x,y,w,h: @integer
                                               do
                                                  recalc;
                                                  distance->x;
                                                  distance->y;
                                                  (windowWidth-3*distance) / 2
                                                    ->w;
                                                  height->h;
                                                  ((x,y),(x+w,y+h))->frame;
                                                  
                                               #);
                                             open:: 
                                               (# 
                                               do setFrame; 'Cancel'->label
                                               #);
                                             eventhandler:: 
                                               (#
                                                  onMouseUp:: 
                                                    (# 
                                                    do newProjectWindow.hide
                                                    #);
                                                  onFatherFrameChanged:: 
                                                    (#  do setFrame #)
                                               #)
                                          #);
                                        bOk: @pushButton
                                          (#
                                             setFrame:
                                               (# x,y,w,h: @integer
                                               do
                                                  recalc;
                                                  distance+
                                                  (windowWidth-3*distance)->x;
                                                  distance->y;
                                                  (windowWidth-3*distance) / 2
                                                    ->w;
                                                  height->h;
                                                  ((x,y),(x+w,y+h))->frame;
                                                  
                                               #);
                                             open:: 
                                               (# 
                                               do setFrame; 'OK'->label
                                               #);
                                             eventhandler:: 
                                               (#
                                                  onMouseUp:: 
                                                    (# 
                                                    do
                                                       switchEdit.contents.
                                                         contents->cp.name[];
                                                       (if
                                                       browser.currentProject[]
                                                       = none then
                                                           cp[]
                                                             ->
                                                               browser.projects.
                                                                 theProjects.
                                                                 append;
                                                           
                                                        else
                                                           (if
                                                           browser.
                                                             currentProject.
                                                             hasSubProjects then
                                                               cp[]
                                                                 ->
                                                                   browser.
                                                                     currentProject
                                                                   .subProjects.
                                                                     append;
                                                               
                                                           if)
                                                       if);
                                                       browser.projectsChanged;
                                                       cp[]->browser.setProject;
                                                       newProjectWindow.close
                                                    #);
                                                  onFatherFrameChanged:: 
                                                    (#  do setFrame #)
                                               #)
                                          #);
                                        switchesFrame: @labelled
                                          (#
                                             contentsType:: canvas
                                               (#
                                                  projectFileBox: @radioButton
                                                    (#
                                                       setFrame:
                                                         (# x,y,w,h: @integer
                                                         do
                                                            recalc;
                                                            0->x;
                                                            distance->y;
                                                            switchWidth->w;
                                                            height->h;
                                                            ((x,y),(x+w,y+h))
                                                              ->frame;
                                                            
                                                         #);
                                                       open:: 
                                                         (# 
                                                         do
                                                            setFrame;
                                                            'project file'
                                                              ->label
                                                         #);
                                                       eventhandler:: 
                                                         (#
                                                            onMouseUp:: 
                                                              (# 
                                                              do
                                                                 true
                                                                   ->
                                                                     cp.
                                                                       isProjectFile
                                                              #);
                                                            onFatherFrameChanged::
                                                             
                                                              (# 
                                                              do setFrame
                                                              #)
                                                         #)
                                                    #);
                                                  rootBox: @radioButton
                                                    (#
                                                       setFrame:
                                                         (# x,y,w,h: @integer
                                                         do
                                                            recalc;
                                                            0->x;
                                                            height+distance->y;
                                                            switchWidth->w;
                                                            height->h;
                                                            ((x,y),(x+w,y+h))
                                                              ->frame;
                                                            
                                                         #);
                                                       open:: 
                                                         (# 
                                                         do
                                                            setFrame;
                                                            'root project'
                                                              ->label
                                                         #);
                                                       eventhandler:: 
                                                         (#
                                                            onMouseUp:: 
                                                              (# 
                                                              do
                                                                 true->cp.isRoot
                                                              #);
                                                            onFatherFrameChanged::
                                                             
                                                              (# 
                                                              do setFrame
                                                              #)
                                                         #)
                                                    #);
                                                  subProjectBox: @radioButton
                                                    (#
                                                       setFrame:
                                                         (# x,y,w,h: @integer
                                                         do
                                                            recalc;
                                                            0->x;
                                                            (height+distance)*2
                                                              ->y;
                                                            switchWidth->w;
                                                            height->h;
                                                            ((x,y),(x+w,y+h))
                                                              ->frame;
                                                            
                                                         #);
                                                       open:: 
                                                         (# 
                                                         do
                                                            setFrame;
                                                            'sub project'->label
                                                         #);
                                                       eventhandler:: 
                                                         (#
                                                            onMouseUp:: 
                                                              (# 
                                                              do
                                                                 true
                                                                   ->
                                                                     cp.
                                                                       hasSubprojects
                                                              #);
                                                            onFatherFrameChanged::
                                                             
                                                              (# 
                                                              do setFrame
                                                              #)
                                                         #)
                                                    #);
                                                  open:: 
                                                    (# 
                                                    do
                                                       projectFileBox.open;
                                                       rootBox.open;
                                                       subProjectBox.open;
                                                       
                                                    #)
                                               #);
                                             setFrame:
                                               (# x,y,w,h: @integer
                                               do
                                                  recalc;
                                                  distance->x;
                                                  distance+height->y;
                                                  windowWidth-2*distance->w;
                                                  height*5+distance->h;
                                                  ((x,y),(x+w,y+h))->frame;
                                                  
                                               #);
                                             open:: 
                                               (# 
                                               do
                                                  setFrame;
                                                  'Project Type'->label
                                               #);
                                             eventhandler:: 
                                               (#
                                                  onFatherFrameChanged:: 
                                                    (#  do setFrame #)
                                               #)
                                          #);
                                        switchEdit: @labelled
                                          (#
                                             contentsType:: editText;
                                             setFrame:
                                               (# x,y,w,h: @integer
                                               do
                                                  recalc;
                                                  distance->x;
                                                  height*6+distance*3->y;
                                                  windowWidth-2*distance->w;
                                                  height*2->h;
                                                  ((x,y),(x+w,y+h))->frame;
                                                  
                                               #);
                                             open:: 
                                               (# 
                                               do
                                                  setFrame;
                                                  'Project name'->label
                                               #);
                                             eventhandler:: 
                                               (#
                                                  onFatherFrameChanged:: 
                                                    (#  do setFrame #)
                                               #)
                                          #);
                                        tst: @pushButton
                                          (#
                                             open:: 
                                               (#
                                                  ts: ^textStyle;
                                                  buttonLabel:
                                                    (# 
                                                    exit 'more choises'
                                                    #);
                                                  buttonWidth: @integer
                                               do
                                                  buttonLabel->label;
                                                  style->ts[];
                                                  ((buttonLabel->ts.widthOfText)
                                                   +5,ts.lineHeight+3)
                                                    ->(switchWidth,height);
                                                  switchWidth+8->switchWidth;
                                                  height+8->height;
                                                  
                                               #)
                                          #);
                                        open::< 
                                          (# 
                                          do
                                             tst.open;
                                             tst.hide;
                                             tst.close;
                                             setFrame;
                                             newProjectWindow.contents
                                               ->bCancel.open;
                                             newProjectWindow.contents
                                               ->bOk.open;
                                             newProjectWindow.contents
                                               ->switchesFrame.open;
                                             newProjectWindow.contents
                                               ->switchEdit.open;
                                             'New Project'->title;
                                             hide;
                                             INNER
                                          #)
                                     #);
                                   
                                do
                                   &browser.projects.project[]->cp[];
                                   newProjectWindow.open;
                                   newProjectWindow.showmodal;
                                   
                                #)
                           #);
                         open::  (#  do 'Create new project'->name #)
                      #);
                    iSave: @menuItem
                      (#
                         eventhandler:: 
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false and (browser.currentProject[] <> none )
                                     ->value
                                #);
                              onSelect::  (#  do  #)
                           #);
                         open::  (#  do 'Save project'->name #)
                      #);
                    iRename: @menuItem
                      (#
                         eventhandler:: 
                           (#
                              onStatus:: 
                                (# 
                                do browser.currentProject[] <> none ->value
                                #);
                              onSelect:: 
                                (# 
                                do
                                   (THIS(ymerBrowserWindow)[],'Project Rename',
                                    'New project name','')
                                     ->promptForText
                                       (#
                                          ok:: 
                                            (#
                                               cp: ^browser.projects.project;
                                               ch: @char
                                            do
                                               browser.currentProject[]->cp[];
                                               usertext->cp.name;
                                               (if true
                                                //
                                                cp.isDirectory
                                                and
                                                (cp.name.length > 0)
                                                and
                                                ((cp.name.length
                                                    ->cp.name.inxGet) <> '/')
                                                then
                                                   '/'->cp.name.append
                                                //
                                                cp.isRoot
                                                and
                                                (cp.name.length > 0)
                                                and
                                                ((cp.name.length
                                                    ->cp.name.inxGet) <> '*')
                                                then
                                                   '*'->cp.name.put
                                               if);
                                               browser.projectsChanged;
                                               cp[]->browser.setProject;
                                               
                                            #)
                                       #);
                                   
                                #)
                           #);
                         open::  (#  do 'Rename project'->name #)
                      #);
                    iRelocate: @menuItem
                      (#
                         eventhandler:: 
                           (#
                              onStatus:: 
                                (# 
                                do browser.currentProject[] <> none ->value
                                #);
                              onSelect:: 
                                (# cp: ^browser.projects.project; t: ^text
                                <<SLOT menuProjectsRelocateOnselect:DoPart>>
                                #)
                           #);
                         open:: 
                           (# 
                           do
                              'Relocate project'->name
                           #)
                      #);
                    iDelete: @menuitem
                      (#
                         eventhandler:: 
                           (#
                              onStatus:: 
                                (# 
                                do browser.currentProject[] <> none ->value
                                #);
                              onSelect:: 
                                (# cp: ^browser.projects.project
                                <<SLOT menuProjectsDeleteOnselect:DoPart>>
                                #)
                           #);
                         open:: 
                           (# 
                           do
                              'Delete project'->name
                           #)
                      #);
                    open:: 
                      (# sep: ^menuItem
                      do
                         'Project'->name;
                         iNew.open;
                         iNew[]->append;
                         iLoad.open;
                         iLoad[]->append;
                         iLoadStd.open;
                         iLoadStd[]->append;
                         iSave.open;
                         iSave[]->append;
                         &separator[]->sep[];
                         sep.open;
                         sep[]->append;
                         iRename.open;
                         iRename[]->append;
                         iRelocate.open;
                         iRelocate[]->append;
                         iDelete.open;
                         iDelete[]->append;
                         
                      #);
                    
                 #);
               groupsMenu: @menu
                 (#
                    iNew: @menuItem
                      (#
                         eventhandler:: 
                           (#
                              onStatus:: 
                                (# 
                                do
                                   (browser.currentProject[] <> none ) and
                                   (browser.currentProject.isProjectFile or
                                    browser.currentProject.isDirectory)->value
                                #);
                              onSelect:: 
                                (#
                                   t: ^text;
                                   newGroup: ^browser.projects.group;
                                   
                                <<SLOT menuGroupsNewOnselect:DoPart>>
                                #)
                           #);
                         open:: 
                           (# 
                           do
                              'New group'
                                ->name
                           #)
                      #);
                    iAdd: @menuItem
                      (#
                         eventhandler:: 
                           (#
                              onStatus:: 
                                (# 
                                do
                                   (browser
                                    .currentProject[] <> none ) and
                                   (browser.currentProject.isProjectFile)->value
                                #);
                              onSelect:: 
                                (#  <<SLOT menuGroupsAddOnselect:DoPart>> #)
                           #);
                         open:: 
                           (# 
                           do
                              'Add group'
                                ->name
                           #)
                      #);
                    iDelete: @menuItem
                      (#
                         eventhandler:: 
                           (#
                              onStatus:: 
                                (# 
                                do
                                   true
                                   (*(browser.currentProject[]<>NONE) and
                                    (browser.currentProject.isProjectFile or
                                    browser.currentProject.isDirectory)*)
                                     ->value
                                #);
                              onSelect:: 
                                (# 
                                <<SLOT menuGroupsDeleteOnselect:DoPart>>
                                #)
                           #);
                         open:: 
                           (# 
                           do
                              'Delete group'->name
                           #)
                      #);
                    iSemantic: @menuItem
                      (#
                         eventhandler:: 
                           (#
                              onStatus:: 
                                (# 
                                <<SLOT menuGroupsSemanticOnstatus:DoPart>>
                                #);
                              onSelect:: 
                                (# 
                                <<SLOT menuGroupsSemanticOnselect:DoPart>>
                                #)
                           #);
                         open::  (#  do 'Viev Semantic Errors'->name #)
                      #);
                    open:: 
                      (# sep: ^menuItem
                      do
                         'Group'->name;
                         iNew.open;
                         iNew[]->append;
                         iAdd.open;
                         iAdd[]->append;
                         iDelete.open;
                         iDelete[]->append;
                         &separator[]->sep[];
                         sep.open;
                         sep[]->append;
                         iSemantic.open;
                         iSemantic[]->append;
                         
                      #);
                    
                 #);
               historyMenu: @menu
                 (#
                    addHistoryElement:
                     <<SLOT historyMenuAddHistoryElement:Descriptor>>;
                    open::  (#  do 'History'->name #);
                    
                 #);
               windowsMenu: @menu
                 (#
                    <<SLOT windowsMenuPrivate:Attributes>>;
                    insertWindow:
                      (# win: ^window
                      enter win[]
                      do
                         <<SLOT windowsMenuInsertWindow:Descriptor>>
                      #);
                    deleteWindow:
                      (# win: ^window
                      enter win[]
                      <<SLOT windowsMenuDeleteWindow:DoPart>>
                      #);
                    iSeparateBrowser:
                      @menuItem
                      (#
                         eventhandler:: 
                           (#
                              onSelect:: 
                                (# 
                                <<SLOT windowsMenuSeparateBrowser:DoPart>>
                                #)
                           #);
                         open::  (#  do 'Open Separate Browser'->name #)
                      #);
                    iSeparateCodeView: @menuItem
                      (#
                         eventhandler:: 
                           (#
                              onStatus:: 
                                (# 
                                do browser.currentForm[] <> none ->value
                                #);
                              onSelect:: 
                                (# 
                                <<SLOT windowsMenuSeparateCodeView:DoPart>>
                                #)
                           #);
                         open:: 
                           (# 
                           do
                              'Open Separate Code Viewer'->name
                           #)
                      #);
                    iWorkspace: @menuItem
                      (#
                         eventhandler:: 
                           (#
                              onSelect:: 
                                (#  <<SLOT windowsMenuWorkspace:DoPart>> #)
                           #);
                         open:: 
                           (# 
                           do
                              'Open Workspace'->name;
                              
                           #)
                      #);
                    open:: 
                      (# sep: ^menuItem
                      do
                         'Windows'->name;
                         iWorkspace.open;
                         iWorkspace[]->append;
                         iSeparateBrowser.open;
                         iSeparateBrowser[]->append;
                         iSeparateCodeView.open;
                         iSeparateCodeView[]->append;
                         &separator[]->sep[];
                         sep.open;
                         sep[]->append;
                         
                      #);
                    
                 #);
               <<SLOT additionalMenus:Attributes>>;
               open::< 
                 (# 
                 do
                    fileMenu.open;
                    fileMenu[]->append;
                    projectsMenu.open;
                    projectsMenu[]->append;
                    (* groupsMenu.open;
                     * groupsMenu[]->append;
                     *)
                    historyMenu.open;
                    historyMenu[]->append;
                    INNER ;
                    windowsMenu.open;
                    windowsMenu[]->append;
                    
                 #)
            #);
          
       #);
     BETAlib,BETAexecutable,SIFexecutable,
       FREJAexecutable,INTERFACEBUILDERexecutable,VALHALLAexecutable,
       TEXTexecutable,BETAWCexecutable: ^text;
     machineType: @text;
     init:< (#  do <<SLOT ymerInit:Descriptor>> #);
     
  do INNER ymerApplication
  #)  

