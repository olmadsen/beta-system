ORIGIN '~beta/basiclib/v1.5/betaenv';
BODY 'private/ymerBody'
'private/ymerMenus'
'private/parseProjects'
'private/splitDependency';
INCLUDE '~beta/basiclib/v1.5/formatio'
        '~beta/objectbrowser/v2.1/mpsinterface'
        '~beta/objectbrowser/v2.1/betagrammarinit'
        '~beta/objectbrowser/v2.1/UI/labelled'
        '~beta/dependency/v1.2/dependency'
        '~beta/guienv/v1.4/utils/prompts'
        'sourcebrowser';
(*
 * COPYRIGHT
 *   Copyright Mjolner Informatics, 1995-96
 *   All rights reserved.
 *)
-- lib: Attributes --
ymerApplication: guienv
  (#
     <<SLOT ymerApplicationLib:Attributes>>;
     ymerVersion:
       (# exit '1.1 (rev. 1.63)' #);
     mps: @mpsType;
     mpsType:< mpsinterface
       (#
          onGroupNotFound::< 
            (# t: @text; doneInInner: @boolean
            do INNER;
               (if not doneInInner then
                   'Fragment: '->t.puttext;
                   groupName[]->t.puttext;
                   ' does not exist.'->t.putline;
                   'Fragment ignored'->t.puttext;
                   (none ,t[],'Notification')->alertUser;
                   true->continue
               if);
            #);
          onOldGroup::<
            (# t: @text; doneInInner: @boolean
            do INNER;
               (if not doneInInner then
                   'Fragment: '->t.puttext;
                   groupName[]->t.puttext;
                   ' need to be parsed.'->t.putline;
                   'Should this be done?'->t.puttext;
                   (none,'Notification',t[])
                     ->promptForBoolean
                   (#
                      ok::  (#  do true->allowParsing #);
                      notok:: 
                        (# 
                        do
                           false->allowParsing;
                        #);
                      cancel:: 
                        (# 
                        do
                           false->allowParsing;
                        #);
                      
                   #);
                   true->continue
               if)
            #);
          onParseErrors::<
            (#  <<SLOT ymerMPSparseErrors:DoPart>> #);
          onFatalParseError::<
            (# do true->continue; INNER #);
          onUncheckedGroup::<
            (# do true->continue; true->allowChecking; INNER #);
          onNewGroup::< 
            (# 
            do true->continue; true->allowNewGroup; INNER 
            #);
          onOtherError::<
            (# doneInInner: @boolean
            do INNER;
               (if not doneInInner then
                   (none ,errorText[],
                   'Error during opening of group')->alertUser;
                   true->continue
               if);
            #);
          betaparserinit: <<SLOT ymerMPSbetaparserinit:Descriptor>>;
          init::<
            (# 
            do
               betagrammarinit;
               betaparserinit;
               dg.init; dg.xverboselevel.nothing->dg.xverboselevel;
	       machineType->dg.TargetMachine;
	       machineType->dg.TargetDirectory;
               INNER
            #);
          dg: @AST.dependencyGraph;
          
       #);
     browsers: @list (# element:: ymerBrowserWindow #);
     browserCount: @integer (* private *) ;
     isActive: @boolean (* true, iff any of ymer's windows are active *);
     editMode:< (* trueObject => all code views are read only *)
       booleanObject; 
     readOnlyMode: booleanObject(# do true->value #);
     writeMode: booleanObject(# do false->value #);
     helpDocument:
       (# title, path: ^text
       enter (title[], path[])
       <<SLOT ymerHelpDocument: dopart>>
       #);
     ymerBrowserWindow:< window
       (#
          <<SLOT fragmentBrowserLib:Attributes>>;
          browserTitle:<
            (# title: ^text
            do 'Mjølner Source Browser'->title[];
               INNER
            exit title[]
            #);
          workspace:< ymerLocalWindow
            (# cfe: ^codeeditor;
               workspacePrivate: @<<SLOT workspacePrivate: descriptor>>;
               menubarType::< 
                 (# fileMenu: @menu
                      (# quitItem: @menuItem
                           (# eventHandler:: 
                                (# onSelect::
                                     (# <<SLOT workspaceFileQuitSelect: dopart>> #)
                                #);
                              open::  (#  do 'w'->key;  'Close'->name #)
                           #);
                         open:: 
                           (# <<SLOT workspaceFileOpen: dopart>> #);
                         setup: (# do open; fileMenu[]->this(menubarType).append #);
                      #);
                    importMenu: @menu
                      (# iImportCurrentGroup: @menuItem
                           (# eventhandler:: 
                                (# onStatus:: 
                                     (# <<SLOT workspaceImportAllStatus: dopart>> #);
                                   onSelect:: 
                                     (# <<SLOT workspaceImportAllSelect: dopart>> #);
                                #);
                           #);
                         refresh: <<SLOT workspaceRefreshImportMenu: descriptor>>;
                         <<SLOT workspaceImportItems: attributes>>;
                         open:: 
                           (# <<SLOT workspaceImportOpen: dopart>> #);
                         setup: (# do open; importMenu[]->this(menubarType).append #);
                      #);
                    closeMenu: @menu
                      (# <<SLOT workspaceCloseItems: attributes>>;
                         open::  (#  do 'Close'->name #);
                         setup: (# do open; closeMenu[]->this(menubarType).append #);
                      #);
                    scrollMenu: @menu
                      (# <<SLOT workspaceScrollItems: attributes>>;
                         open::  (#  do 'Scroll'->name #);
                         setup: (# do open; scrollMenu[]->this(menubarType).append #);
                      #);
                 #);
               UI: @<<SLOT workspaceUI: descriptor>>;
               eventhandler:: 
                 (# onAboutToClose:: 
                      (# <<SLOT workspaceOnAboutToClose: dopart>> #);
                    onActivate::
                      (# do (theMenubar).importMenu.refresh #);
                 #); 
               open::<
                 (# <<SLOT workspaceOpen: dopart>>
                 #);
            #) (* workspace *);
          codeViewWindow:< ymerLocalWindow
            (# ff: ^mps.AST.fragmentForm;
               fe: ^codeeditor;
               codeViewWindowPrivate: @<<SLOT codeViewWindowPrivate: descriptor>>;
               menubarType::< 
                 (# fileMenu: @menu
                      (# quitItem: @menuItem
                           (# eventHandler:: 
                                (# onSelect::
                                     (# <<SLOT codeViewWindowFileQuit: dopart>> #)
                                #);
                              open::  (#  do 'w'->key;  'Close'->name #)
                           #);
                         open:: 
                           (# do 'File'->name; quitItem.open; quitItem[]->append #);
                         setup:
                           (# do open; fileMenu[]->this(menubarType).append #)
                      #);
                    buffersMenu: @menu
                      (# <<SLOT codeViewWindowBuffersMenu: attributes>>;
                         open::
                           (# do 'Buffers'->name #);
                         setup:
                           (# do open; buffersMenu[]->this(menubarType).append #)
                      #)
                 #);
               closeDown::<
                 (# <<SLOT codeViewWindowCloseDown: dopart>> #);
               eventhandler::<
                 (# onAboutToClose::< 
                      (# <<SLOT codeViewWindowOnAboutToClose: dopart>> #)
                 #);
               open::< 
                 (# <<SLOT codeViewWindowOpen: dopart>> #);
            #);
          viewSeparate:
            (# ff: ^mps.AST.fragmentForm;
               node: ^mps.AST.ast;
               cVW: ^codeViewWindow;
            enter (ff[],node[])
            <<SLOT viewSeparate: dopart>>
            exit cVW[]
            #);
          edenv: ^editorEnv;
          onCodeViewOpen:<
            (# theCodeView: ^codemoveableeditor
            enter theCodeView[]
            do inner
            #);
          ymerLocalWindow: window
            (#
               opened: @boolean;
               open::< 
                 (# 
                 do
                    true->opened;
                    INNER ;
                    (if opened then
                        (if THIS(ymerBrowserWindow)[]->browsers.has then
                            THIS(ymerLocalWindow)[]
                              ->(THIS(ymerBrowserWindow).theMenubar).windowsMenu.insertWindow
                        if)
                    if);
                    
                 #);
               eventhandler::< 
                 (# onActivate::< (# do true->isActive; INNER #);
                    onDeactivate::< (# do false->isActive; INNER #);
                    onAboutToClose::< 
                      (# 
                      do
                         INNER ;
                         (if okToClose then
                             THIS(ymerLocalWindow).closeDown->okToClose;
                         if)
                      #)
                 #);
               closeDown:<
                 (# okToClose: @boolean
                 do true->okToClose;
                    (if THIS(ymerBrowserWindow)[]->browsers.has then
                        THIS(ymerLocalWindow)[]
                          ->(THIS(ymerBrowserWindow).theMenubar).windowsMenu.deleteWindow
                    if);
                    INNER closeDown;
                 exit okToClose
                 #);
               close::< 
                 (# 
                 do
                    THIS(ymerLocalWindow).closeDown;
                    false->opened
                 #)
            #);
          loadSettings: (#  <<SLOT ymerLoadSettings:DoPart>> #);
          loadProject:
            (# proj: ^browser.projects.project
            enter proj[]
            <<SLOT ymerLoadProject:DoPart>>
            #);
          appendProject:
            (#
               location: ^text;
               newProj (*private*) : ^browser.projects.project;
               
            enter location[]
            <<SLOT ymerAppendProject:DoPart>>
            #);
          appendDone:
            (# 
            <<SLOT ymerAppendDone:DoPart>>
            #);
          addProject:
            (# location: ^text; 
            enter location[]
            <<SLOT ymerAddProject:DoPart>>
            #);
          browser: @browserType;
          browserType:< ymerSourceBrowser;
          ymerSourceBrowser: sourcebrowser
            (#
               <<SLOT browserLib:Attributes>>;
               selectNode:: 
                 (# <<SLOT browserSelectNode: dopart>> #);
               followLink::  (#  do groupname[]->selectFragmentGroup #);
               fileEdit::  (#  <<SLOT browserFileEdit:DoPart>> #);
               viewHTML:: (# <<SLOT browserViewHTML:DoPart>> #);
               projectInfoType:: 
                 (#
                    <<SLOT projectInfoLib:Attributes>>;
                    formList: list
                      (# element::  (# location: @text #) #);
                    groupList: list (# element:: group #);
                    projectList: list
                      (#
                         element:: project;
                         <<SLOT parseDefn:Attributes>>;
                         parseProjectFile:
                           (#
                              projectFile: ^text;
                              newProj: ^project
                           enter
                              (projectFile[],
                              newProj[])
                           <<SLOT ymerParseProjectFile:DoPart>>
                           #);
                         
                      #);
                    theProjects: @projectList;
                    project:: 
                      (#
                         location: @text;
                         isDirectory,isDotDotDirectory,isProjectFile: @boolean;
                         isRoot,isExtent,isDomain: @boolean;
                         hasSubprojects: @boolean;
                         groups: @groupList;
                         subprojects: @projectList;
                         superProject: ^project;
                         level: @integer;
                         unfolded: @boolean;
                         copy:
                           (# newProj: ^project
                           do
                              &project[]->newProj[];
                              name.copy->newProj.name[];
                              location->newProj.location;
                              isDirectory->newProj.isDirectory;
                              isDotDotDirectory->newProj.isDotDotDirectory;
                              isProjectFile->newProj.isProjectFile;
                              isRoot->newProj.isRoot;
                              isExtent->newProj.isExtent;
                              isDomain->newProj.isDomain;
                              hasSubprojects->newProj.hasSubprojects;
                              subprojects->newProj.subprojects;
                              groups->newProj.groups;
                              unfolded->newProj.unfolded;
                              none ->newProj.superProject[];
                              0->newProj.level;
                              
                           exit newProj[]
                           #);
                         scanGroupsImpl:: 
                           (#
                              newGroup: ^group;
                              dependencyPrivate:
                                @<<SLOT dependencyPrivate:Descriptor>>;
                              dependencyRegister:
                                (# fgName: ^text
                                enter fgName[]
                                <<SLOT dependencyRegister:DoPart>>
                                #);
                              dependencyCreateSubprojects:
                                (# selectedProj: ^projects.project; 
                                do
                                   THIS(project)[]->selectedProj[];
                                   selectedProj.subProjects.clear;
                                   <<SLOT dependencyCreateSubprojects:Descriptor>>
                                #);
                              
                           <<SLOT scanGroupsImpl:DoPart>>
                           #)
                      #);
                    group:: 
                      (#
                         temporary: @boolean;
                         forms: @formList;
                         close::
                           (* remove all entries from history, and
                            * deselect project
                            *)
                           (# theForm: ^MPS.ast.fragmentForm
                           enter theForm[]
                           <<SLOT ymerGroupClose:DoPart>>
                           #);
                         getfg:: 
                           (#
                              doRealOpen:
                                (#
                                   g:
                                     ^mps.AST.
                                     FragmentGroup;
                                   isRealOpen:
                                     (# isOpen: @Boolean; 
                                     do
                                        scanner: g.fragmentList.scan
                                          (# 
                                          do
                                             (if current.type
                                              // mps.AST.formType then
                                                 (if current.f[] <> none then
                                                     true->isOpen; leave scanner
                                                 if)
                                             if)
                                          #)
                                     exit isOpen
                                     #)
                                enter g[]
                                do
                                   (if not isRealOpen then (* open g real *)
                                       g.realOpen; 
                                   if);
                                   
                                #);
                              recheck::
                                (# allowReload: @boolean; t: @text; cg: ^group;
                                <<SLOT ymerGroupRecheck: dopart>>
                                #);
                           <<SLOT ymerGroupGetFg: dopart>>
                              
                           #);
                         
                      #);
                    scanProjectsImpl:: 
                      (# 
                      do
                         theProjects.scan
                         (#  do current[]->thescan.foreach #)
                      #);
                    init::  (#  do theProjects.init;  #);
                    
                 #);
               projectsLabel::  (#  do 'Projects'->t[] #);
               emptyProjectListLabel:: 
                 (#  do 'Groups'->t[] #);
               emptyGroupViewLabel:: 
                 (#  do 'Fragments'->t[] #);
               emptyCodeViewLabel:: 
                 (#  do 'Form'->t[] #);
               onProjectListOpen::  (#  <<SLOT onProjectListOpen:DoPart>> #);
               onGroupListOpen::  (#  <<SLOT onGroupListOpen:DoPart>> #);
               onCodeViewOpen::<
                 (#
                 do thecodeview[]->this(ymerBrowserWindow).onCodeViewOpen;
                    INNER
                 #);
               onFragmentgroupViewOpen:: 
                 (# 
                 <<SLOT onFragmentgroupViewOpen:DoPart>>
                 #);
               onCurrentProjectChange:: 
                 (#  <<SLOT onCurrentProjectChange:DoPart>> #);
               onCurrentGroupChange:: 
                 (# 
                 <<SLOT onCurrentGroupChange:DoPart>>
                 #);
               onCurrentFormChange:: 
                 (#  <<SLOT onCurrentFormChange:DoPart>> #);
               selectFragmentGroup:
                 (# fgName: ^text
                 enter fgName[]
                 <<SLOT selectFragmentGroup:DoPart>>
                 #);
               selectFragmentForm:
                 (# fgName: ^text; formName: ^text
                 enter (fgName[],formName[])
                 <<SLOT selectFragmentForm:DoPart>>
                 #);
               eventhandler:: 
                 (# onFatherFrameChanged:: 
                      (# do THIS(ymerBrowserWindow).size->size #)
                 #);
               open::  (# w,h: @integer <<SLOT browserOpen:DoPart>> #);
               editorEncloserType:: 
                 (#
                    tryclose:: 
                      (# do THIS(ymerBrowserWindow).close #);
                    onHighLight:: 
                      (#  do THIS(ymerBrowserWindow).wriggle #);
                    getAST::  (#  do mps.AST[]->AST[] #);
                    getBETACFL::  (#  do mps.BETACFL[]->BETACFL[] #);
                    
                 #);
               
            #);
          eventhandler::< 
            (# onActivate::< (# do true->isActive; INNER #);
               onDeactivate::< (# do false->isActive; INNER #);
               onAboutToClose::<  (#  <<SLOT ymerOnAboutToClose:DoPart>> #)
            #);
          close::<  (#  <<SLOT ymerClose:DoPart>> #);
          closeGroups: booleanValue(#  <<SLOT ymerCloseGroups:DoPart>> #);
          quit: (#  <<SLOT ymerQuit:DoPart>> #);
          onTerminateApplication:< 
            (* is called when this fragmentbrowser is terminated. You
             * can for example further bind this control whether
             * actually to terminate by assigning false to okToTerminate
             *)
            (# okToTerminate: @boolean
            do true -> okToTerminate;
               INNER
            exit okToTerminate
            #);
          open::< 
            (# 
            do
               <<SLOT ymerOpen:Descriptor>>
            #);
          menubarType::< 
            (#
               fileMenu: @menu
                 (#
                    iHelp: @menuItem
                      (#
                         eventhandler:: 
                           (#
                              onSelect:: 
                                (# 
                                <<SLOT menuFileHelp:DoPart>>
                                #)
                           #);
                         open::  (#  do 'Help'->name #)
                      #);
                    iSaveSettings: @menuItem
                      (#
                         eventhandler:: 
                           (#
                              onSelect:: 
                                (# 
                                <<SLOT menuFileSaveSettingsOnselect:DoPart>>
                                #)
                           #);
                         open:: 
                           (# 
                           do
                              'Save settings'->name
                           #)
                      #);
                    iReloadSettings: @menuItem
                      (#
                         eventhandler:: 
                           (#
                              onSelect:: 
                                (# 
                                <<SLOT menuFileReloadSettingsOnselect:DoPart>>
                                #)
                           #);
                         open::  (#  do 'Reset settings'->name #)
                      #);
                    iClose: @menuitem
                      (#
                         eventhandler:: 
                           (#
                              onSelect:: 
                                (# <<SLOT menuFileCloseOnselect:DoPart>> #)
                           #);
                         open:: 
                           (# 
                           do 'w'->key;
                              'Close'->name
                           #)
                      #);
                    iQuit: @menuitem
                      (#
                         eventhandler:: 
                           (#
                              onSelect:: 
                                (# <<SLOT menuFileQuitOnselect:DoPart>> #)
                           #);
                         open:: 
                           (# 
                           do 'q'->key;
                              'Quit'->name
                           #)
                      #);
                    open:: 
                      (# sep: ^menuItem
                      do
                         'File'->name;
                         iHelp.open;
                         iHelp[]->append;
                         &separator[]
                           ->sep[];
                         sep.open;
                         sep[]->append;
                         iSaveSettings.open;
                         iSaveSettings[]->append;
                         iReloadSettings.open;
                         iReloadSettings[]->append;
                         &separator[]->sep[];
                         sep.open;
                         sep[]->append;
                         iClose.open;
                         iClose[]->append;
                         iQuit.open;
                         iQuit[]->append;
                         
                      #);
                    setup: (# do open; fileMenu[]->this(menubarType).append #);
                    
                 #);
               projectMenu: @menu
                 (#
                    iLoad: @menuItem
                      (#
                         eventhandler:: 
                           (#
                              onSelect:: 
                                (#
                                   t: ^text;
                                   newProj: ^browser.projects.project;
                                   
                                <<SLOT menuProjectsLoadOnselect:DoPart>>
                                #)
                           #);
                         open:: 
                           (# 
                           do
                              'Open...'->name
                           #)
                      #);
                    iNew: @menuItem
                      (#
                         eventhandler:: 
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false
                                   (*((browser.currentProject[] = none ) or
                                    browser.currentProject.hasSubProjects)*)
                                     ->value
                                #);
                              onSelect:: 
                                (#
                                   cp: ^browser.projects.project;
                                   newProjectWindow: @ymerLocalWindow
                                     (#
                                        switchWidth: @integer;
                                        height,distance,windowWidth,
                                        windowHeight: @integer;
                                        setFrame:
                                          (# 
                                          do
                                             recalc;
                                             8*height+4*distance->windowHeight;
                                             (windowWidth,windowHeight)->size;
                                             
                                          #);
                                        recalc:
                                          (# 
                                          do
                                             3->distance;
                                             (switchWidth*3)+distance*4
                                               ->windowWidth;
                                             
                                          #);
                                        bCancel: @pushButton
                                          (#
                                             setFrame:
                                               (# x,y,w,h: @integer
                                               do
                                                  recalc;
                                                  distance->x;
                                                  distance->y;
                                                  (windowWidth-3*distance) / 2
                                                    ->w;
                                                  height->h;
                                                  ((x,y),(x+w,y+h))->frame;
                                                  
                                               #);
                                             open:: 
                                               (# 
                                               do setFrame; 'Cancel'->label
                                               #);
                                             eventhandler:: 
                                               (#
                                                  onMouseUp:: 
                                                    (# 
                                                    do newProjectWindow.hide
                                                    #);
                                                  onFatherFrameChanged:: 
                                                    (#  do setFrame #)
                                               #)
                                          #);
                                        bOk: @pushButton
                                          (#
                                             setFrame:
                                               (# x,y,w,h: @integer
                                               do
                                                  recalc;
                                                  distance+
                                                  (windowWidth-3*distance)->x;
                                                  distance->y;
                                                  (windowWidth-3*distance) / 2
                                                    ->w;
                                                  height->h;
                                                  ((x,y),(x+w,y+h))->frame;
                                                  
                                               #);
                                             open:: 
                                               (# 
                                               do setFrame; 'OK'->label
                                               #);
                                             eventhandler:: 
                                               (#
                                                  onMouseUp:: 
                                                    (# 
                                                    do
                                                       switchEdit.contents.
                                                       contents->cp.name[];
                                                       (if
                                                           browser.currentProject[]
                                                           = none then
                                                           cp[]
                                                             ->
                                                           browser.projects.
                                                           theProjects.
                                                           append;
                                                           
                                                        else
                                                           (if
                                                               browser.
                                                               currentProject.
                                                               hasSubProjects then
                                                               cp[]
                                                                 ->
                                                               browser.
                                                               currentProject
                                                               .subProjects.
                                                               append;
                                                               
                                                           if)
                                                       if);
                                                       browser.projectsChanged;
                                                       cp[]->browser.setProject;
                                                       newProjectWindow.close
                                                    #);
                                                  onFatherFrameChanged:: 
                                                    (#  do setFrame #)
                                               #)
                                          #);
                                        switchesFrame: @labelled
                                          (#
                                             contentsType:: canvas
                                               (#
                                                  projectFileBox: @radioButton
                                                    (#
                                                       setFrame:
                                                         (# x,y,w,h: @integer
                                                         do
                                                            recalc;
                                                            0->x;
                                                            distance->y;
                                                            switchWidth->w;
                                                            height->h;
                                                            ((x,y),(x+w,y+h))
                                                              ->frame;
                                                            
                                                         #);
                                                       open:: 
                                                         (# 
                                                         do
                                                            setFrame;
                                                            'project file'
                                                              ->label
                                                         #);
                                                       eventhandler:: 
                                                         (#
                                                            onMouseUp:: 
                                                              (# 
                                                              do
                                                                 true
                                                                   ->
                                                                 cp.
                                                                 isProjectFile
                                                              #);
                                                            onFatherFrameChanged::
                                                              
                                                              (# 
                                                              do setFrame
                                                              #)
                                                         #)
                                                    #);
                                                  rootBox: @radioButton
                                                    (#
                                                       setFrame:
                                                         (# x,y,w,h: @integer
                                                         do
                                                            recalc;
                                                            0->x;
                                                            height+distance->y;
                                                            switchWidth->w;
                                                            height->h;
                                                            ((x,y),(x+w,y+h))
                                                              ->frame;
                                                            
                                                         #);
                                                       open:: 
                                                         (# 
                                                         do
                                                            setFrame;
                                                            'root project'
                                                              ->label
                                                         #);
                                                       eventhandler:: 
                                                         (#
                                                            onMouseUp:: 
                                                              (# 
                                                              do
                                                                 true->cp.isRoot
                                                              #);
                                                            onFatherFrameChanged::
                                                              
                                                              (# 
                                                              do setFrame
                                                              #)
                                                         #)
                                                    #);
                                                  subProjectBox: @radioButton
                                                    (#
                                                       setFrame:
                                                         (# x,y,w,h: @integer
                                                         do
                                                            recalc;
                                                            0->x;
                                                            (height+distance)*2
                                                              ->y;
                                                            switchWidth->w;
                                                            height->h;
                                                            ((x,y),(x+w,y+h))
                                                              ->frame;
                                                            
                                                         #);
                                                       open:: 
                                                         (# 
                                                         do
                                                            setFrame;
                                                            'sub project'->label
                                                         #);
                                                       eventhandler:: 
                                                         (#
                                                            onMouseUp:: 
                                                              (# 
                                                              do
                                                                 true
                                                                   ->
                                                                 cp.
                                                                 hasSubprojects
                                                              #);
                                                            onFatherFrameChanged::
                                                              
                                                              (# 
                                                              do setFrame
                                                              #)
                                                         #)
                                                    #);
                                                  open:: 
                                                    (# 
                                                    do
                                                       projectFileBox.open;
                                                       rootBox.open;
                                                       subProjectBox.open;
                                                       
                                                    #)
                                               #);
                                             setFrame:
                                               (# x,y,w,h: @integer
                                               do
                                                  recalc;
                                                  distance->x;
                                                  distance+height->y;
                                                  windowWidth-2*distance->w;
                                                  height*5+distance->h;
                                                  ((x,y),(x+w,y+h))->frame;
                                                  
                                               #);
                                             open:: 
                                               (# 
                                               do
                                                  setFrame;
                                                  'Project Type'->label
                                               #);
                                             eventhandler:: 
                                               (#
                                                  onFatherFrameChanged:: 
                                                    (#  do setFrame #)
                                               #)
                                          #);
                                        switchEdit: @labelled
                                          (#
                                             contentsType:: editText;
                                             setFrame:
                                               (# x,y,w,h: @integer
                                               do
                                                  recalc;
                                                  distance->x;
                                                  height*6+distance*3->y;
                                                  windowWidth-2*distance->w;
                                                  height*2->h;
                                                  ((x,y),(x+w,y+h))->frame;
                                                  
                                               #);
                                             open:: 
                                               (# 
                                               do
                                                  setFrame;
                                                  'Project name'->label
                                               #);
                                             eventhandler:: 
                                               (#
                                                  onFatherFrameChanged:: 
                                                    (#  do setFrame #)
                                               #)
                                          #);
                                        tst: @pushButton
                                          (#
                                             open:: 
                                               (#
                                                  ts: ^textStyle;
                                                  buttonLabel:
                                                    (# 
                                                    exit 'more choises'
                                                    #);
                                                  buttonWidth: @integer
                                               do
                                                  buttonLabel->label;
                                                  style->ts[];
                                                  ((buttonLabel->ts.widthOfText)
                                                  +5,ts.lineHeight+3)
                                                    ->(switchWidth,height);
                                                  switchWidth+8->switchWidth;
                                                  height+8->height;
                                                  
                                               #)
                                          #);
                                        open::< 
                                          (# 
                                          do
                                             tst.open;
                                             tst.hide;
                                             tst.close;
                                             setFrame;
                                             newProjectWindow.contents
                                               ->bCancel.open;
                                             newProjectWindow.contents
                                               ->bOk.open;
                                             newProjectWindow.contents
                                               ->switchesFrame.open;
                                             newProjectWindow.contents
                                               ->switchEdit.open;
                                             'New Project'->title;
                                             hide;
                                             INNER
                                          #)
                                     #);
                                   
                                do
                                   &browser.projects.project[]->cp[];
                                   newProjectWindow.open;
                                   newProjectWindow.showmodal;
                                   
                                #)
                           #);
                         open::  (#  do 'New...'->name #)
                      #);
                    iSave: @menuItem
                      (#
                         eventhandler:: 
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false and (browser.currentProject[] <> none )
                                     ->value
                                #);
                              onSelect::  (#  do  #)
                           #);
                         open::  (#  do 'Save'->name #)
                      #);
                    iSaveAs: @menuItem
                      (# eventhandler:: 
                           (# onStatus:: 
                                (# 
                                do (browser.currentProject[] <> none) and
                                   (browser.currentProject.isProjectFile)
                                     ->value
                                #);
                              onSelect:: 
                                (# cp: ^browser.projects.project; t: ^text
                                do <<SLOT menuProjectsSaveAsOnselect:Descriptor>>
                                #)
                           #);
                         open::  (#  do 'Save As...'->name #)
                      #);
                    iRename: @menuItem
                      (#
                         eventhandler:: 
                           (#
                              onStatus:: 
                                (# 
                                do browser.currentProject[] <> none ->value
                                #);
                              onSelect:: 
                                (# cp: ^browser.projects.project; t: ^text
                                do <<SLOT menuProjectsRenameOnSelect: descriptor>>
                                #)
                           #);
                         open:: 
                           (# 
                           do
                              'Rename...'->name
                           #)
                      #);
                    iReload: @menuItem
                      (#
                         eventhandler:: 
                           (#
                              onStatus:: 
                                (# 
                                do browser.currentProject[] <> none ->value
                                #);
                              onSelect:: 
                                (# cp: ^browser.projects.project
                                do <<SLOT menuProjectsReloadOnSelect: descriptor>>
                                #)
                           #);
                         open:: 
                           (# 
                           do
                              'Reload'->name
                           #)
                      #);
                    iDelete: @menuitem
                      (#
                         eventhandler:: 
                           (#
                              onStatus:: 
                                (# 
                                do browser.currentProject[] <> none ->value
                                #);
                              onSelect:: 
                                (# cp: ^browser.projects.project
                                  <<SLOT menuProjectsDeleteOnselect:DoPart>>
                                #)
                           #);
                         open:: 
                           (# 
                           do
                              'Close'->name
                           #)
                      #);
                    open:: 
                      (# sep: ^menuItem
                      do
                         'Project'->name;
                         iNew.open;
                         iNew[]->append;
                         iLoad.open;
                         iLoad[]->append;
                         iReload.open;
                         iReload[]->append;
                         &separator[]->sep[];
                         sep.open;
                         sep[]->append;
                         iSave.open;
                         iSave[]->append;
                         iSaveAs.open;
                         iSaveAs[]->append;
                         iRename.open;
                         iRename[]->append;
                         &separator[]->sep[];
                         sep.open;
                         sep[]->append;
                         iDelete.open;
                         iDelete[]->append;
                         
                      #);
                    setup: (# do open; projectMenu[]->this(menubarType).append #);
                 #);
               groupMenu: @menu
                 (#
                    iNew: @menuItem
                      (#
                         eventhandler:: 
                           (#
                              onStatus:: 
                                (# 
                                do
                                   (browser.currentProject[] <> none ) and
                                   (browser.currentProject.isProjectFile or
                                    browser.currentProject.isDirectory)->value
                                #);
                              onSelect:: 
                                (#
                                   t: ^text;
                                   newGroup: ^browser.projects.group;
                                   
                                <<SLOT menuGroupsNewOnselect:DoPart>>
                                #)
                           #);
                         open:: 
                           (# 
                           do
                              'New group'
                                ->name
                           #)
                      #);
                    iAdd: @menuItem
                      (#
                         eventhandler:: 
                           (#
                              onStatus:: 
                                (# 
                                do
                                   (browser
                                    .currentProject[] <> none ) and
                                   (browser.currentProject.isProjectFile)->value
                                #);
                              onSelect:: 
                                (#  <<SLOT menuGroupsAddOnselect:DoPart>> #)
                           #);
                         open:: 
                           (# 
                           do
                              'Add group'
                                ->name
                           #)
                      #);
                    iDelete: @menuItem
                      (#
                         eventhandler:: 
                           (#
                              onStatus:: 
                                (# 
                                do
                                   true
                                   (*(browser.currentProject[]<>NONE) and
                                    (browser.currentProject.isProjectFile or
                                    browser.currentProject.isDirectory)*)
                                     ->value
                                #);
                              onSelect:: 
                                (# 
                                <<SLOT menuGroupsDeleteOnselect:DoPart>>
                                #)
                           #);
                         open:: 
                           (# 
                           do
                              'Delete group'->name
                           #)
                      #);
                    open:: 
                      (# sep: ^menuItem
                      do
                         'Group'->name;
                         iNew.open;
                         iNew[]->append;
                         iAdd.open;
                         iAdd[]->append;
                         iDelete.open;
                         iDelete[]->append;
                         
                      #);
                    setup: (# do open; groupMenu[]->this(menubarType).append #);
                 #);
               historyMenu: @menu
                 (# <<SLOT historyMenuLib: attributes>>;
                    protected: @(* private *)boolean;
                    open::  (# <<SLOT historyMenuOpen: dopart>> #);
                    setup: (# do open; historyMenu[]->this(menubarType).append #);
                 #);
               windowsMenu: @menu
                 (#
                    <<SLOT windowsMenuPrivate:Attributes>>;
                    eventhandler:: 
                      (#
                         onSelect:: 
                           (#  <<SLOT windowsMenuOnSelect:DoPart>> #)
                      #);
                    insertWindow:
                      (# win: ^window
                      enter win[]
                      do
                         <<SLOT windowsMenuInsertWindow:Descriptor>>
                      #);
                    deleteWindow:
                      (# win: ^window
                      enter win[]
                      <<SLOT windowsMenuDeleteWindow:DoPart>>
                      #);
                    iSeparateBrowser:
                      @menuItem
                      (#
                         eventhandler:: 
                           (#
                              onSelect:: 
                                (# 
                                <<SLOT windowsMenuSeparateBrowser:DoPart>>
                                #)
                           #);
                         open::  (#  do 'Open Separate Browser'->name #)
                      #);
                    iGraphBrowser:
                      @menuItem
                      (#
                         eventhandler:: 
                           (#
                              onStatus:: 
                                (# 
                                do browser.currentGroup[] <> none ->value
                                #);
                              onSelect:: 
                                (# 
                                <<SLOT windowsMenuGraphBrowser:DoPart>>
                                #)
                           #);
                         open::  (#  do 'Open Dependency Graph Browser'->name #)
                      #);
                    iSeparateCodeView: @menuItem
                      (#
                         eventhandler:: 
                           (#
                              onStatus:: 
                                (# 
                                do browser.currentForm[] <> none ->value
                                #);
                              onSelect:: 
                                (# 
                                <<SLOT windowsMenuSeparateCodeView:DoPart>>
                                #)
                           #);
                         open:: 
                           (# 
                           do
                              'Open Separate Code Viewer'->name
                           #)
                      #);
                    iWorkspace: @menuItem
                      (#
                         eventhandler:: 
                           (#
                              onSelect:: 
                                (#  <<SLOT windowsMenuWorkspace:DoPart>> #)
                           #);
                         open:: 
                           (# 
                           do
                              'Open Workspace'->name;
                              
                           #)
                      #);
                    iSemanticViewer: @menuItem
                      (#
                         eventhandler:: 
                           (#
                              onStatus:: 
                                (# 
                                do browser.currentGroup[] <> none ->value
                                #);
                              onSelect:: 
                                (# 
                                <<SLOT windowsMenuSemanticViewerOnselect:DoPart>>
                                #)
                           #);
                         open::  (#  do 'Open Semantic Errors Viewer'->name #)
                      #);
                    iSemanticEditor: @menuItem
                      (#
                         eventhandler:: 
                           (#
                              onStatus:: 
                                (# 
                                do browser.currentGroup[] <> none ->value
                                #);
                              onSelect:: 
                                (# 
                                <<SLOT windowsMenuSemanticEditorOnselect:DoPart>>
                                #)
                           #);
                         open:: 
                           (#  do 'Open Semantic Errors Editor'->name #)
                      #);
                    open:: 
                      (# sep: ^menuItem
                      do
                         'Windows'->name;
                         iWorkspace.open;
                         iWorkspace[]->append;
                         iSeparateBrowser.open;
                         iSeparateBrowser[]->append;
                         iGraphBrowser.open;
                         iGraphBrowser[]->append;
                         iSeparateCodeView.open;
                         iSeparateCodeView[]->append;
                         iSemanticViewer.open;
                         iSemanticViewer[]->append;
                         iSemanticEditor.open;
                         iSemanticEditor[]->append;
                         &separator[]->sep[];
                         sep.open;
                         sep[]->append;
                         
                      #);
                    setup: (# do open; windowsMenu[]->this(menubarType).append #);
                 #);
               <<SLOT additionalMenus:Attributes>>;
            #);
     
          ymerBrowserPrivate: @<<SLOT ymerBrowserPrivate:Descriptor>>;
         
       #);
     
     loadEditorEnv: (#  <<SLOT loadEditorEnv:DoPart>> #);
     
     ymerPrivate: @<<SLOT ymerPrivate:Descriptor>>;
     
     BETAexecutable,SIFexecutable,FREJAexecutable,
       INTERFACEBUILDERexecutable,VALHALLAexecutable,TEXTexecutable,
       BETAWCexecutable: ^text;
     machineType: @text;
     userGrammarInit:< object;
     init:<
       (# 
       do <<SLOT ymerInit:Descriptor>>
       #);
     
  do
     INNER
       ymerApplication
  #)  

