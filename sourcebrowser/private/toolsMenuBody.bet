ORIGIN '../toolsMenu';

INCLUDE 'compileWindow';
INCLUDE 'ymerFileUtils';
INCLUDE '~beta/unixlib/v1.6/unixfile';
INCLUDE '~beta/basiclib/v1.6/formatio';
(*
 * COPYRIGHT
 *   Copyright Mjolner Informatics, 1995-96
 *   All rights reserved.
 *)

--- ymerApplicationLib: attributes ---
fileExecutable: 
  (# f: @unixfile
  enter f.name
  exit ('a','x')->f.entry.permission.has
  #);

-- iCompilerSlot: Descriptor --
(# win: ^compileWindow; t: @text; exec: ^text;
do (if (BETAexecutable[] = none) or (BETAexecutable.length=0) then
       '~beta/bin/beta'->BETAexecutable.puttext; 
   if);
   BETAexecutable[]->mps.AST.expandToFullPath->exec[];
   l: 
     (if (exec[]->fileExists) and (exec[]->fileReadable) and
	   (exec[]->fileExecutable) then
       
	 &singleCompileWindow[]->win[];
	 &text[]->win.arguments[];
	 exec.copy->win.BETAprogram[];
	 win.open;
       
	 (if true
	  // browser.currentGroup[] <> none then
	     browser.currentGroup.location.copy->win.files[]; 
	  // browser.currentProject[] <> none then
	     (if true
	      // browser.currentProject.isRoot
              // browser.currentProject.isExtent
	      // browser.currentProject.isDomain then
		 browser.currentProject.location.copy->win.files[]; 
	      // browser.currentProject.isDirectory then
                 (# d: @directory
                 do
                    (if browser.currentProject.location.empty then
                        mps.AST.thePathhandler.currentDirectory
                          ->browser.currentProject.location.puttext;
                        
                    if);
                    browser.currentProject.location[]
                      ->mps.ast.expandtofullpath->d.name;
                    &text[]->win.files[];
                    d.scanEntries
                      (# error:: (# do true->continue #)
                      do
                         select
                           (# error:: (# do true->continue #);
                              whenFile:: 
                                (# f: ^file; ext: ^text; location: @text
                                do
                                   thefile->f[];
                                   f.entry.path.name.suffix->ext[];
                                   f.entry.path.name->location.puttext;
                                   (if '.bet'->ext.equal then
                                       browser.currentProject.location[]
                                         ->location.prepend;
                                       location[]->win.files.puttext;
                                       ' '->win.files.put;
                                       
                                   if);
                                   
                                #)
                           #)
                      #)
                 #)
	     if)
	 if);
	 win.doExecute;
       
      else
	 'BETA compiler\n     "%s"\nnot available'
	   ->t.putformat (#  do exec[]->s #);
	 (none ,t[],'BETA Compiler')->alertUser;
	 &fileSelectionDialog
	   (#  do 'Select BETA compiler executable'->title[] #)
	   ->BETAexecutable[];
	 (if BETAexecutable[] <> none then
	     BETAexecutable[]->mps.AST.expandToFullPath->exec[];
	     restart l
	 if)
     if)
#)  

-- iRepeatingCompilerSlot: Descriptor --
(# win: ^compileWindow; t: @text; exec: ^text;
do
   (if (BETAexecutable[] = none) or (BETAexecutable.length=0) then
       '~beta/bin/beta'->mps.AST.expandToFullPath->BETAexecutable.puttext; 
   if);
   BETAexecutable[]->mps.AST.expandToFullPath->exec[];
   l:
     (if (exec[]->fileExists) and (exec[]->fileReadable) and
	   (exec[]->fileExecutable) then
       
	 &repeatingCompileWindow[]->win[];
	 &text[]->win.arguments[];
	 exec.copy->win.BETAprogram[];
	 win.open;
       
	 (if true
	  // browser.currentGroup[] <> none then
	     browser.currentGroup.location.copy->win.files[]; 
	  // browser.currentProject[] <> none then
	     (if true
	      // browser.currentProject.isRoot
              // browser.currentProject.isExtent
	      // browser.currentProject.isDomain then
		 browser.currentProject.location.copy->win.files[]; 
	      // browser.currentProject.isDirectory then
                 (# d: @directory
                 do
                    (if browser.currentProject.location.empty then
                        mps.AST.thePathhandler.currentDirectory
                          ->browser.currentProject.location.puttext;
                        
                    if);
                    browser.currentProject.location[]
                      ->mps.ast.expandtofullpath->d.name;
                    &text[]->win.files[];
                    d.scanEntries
                      (# error:: (# do true->continue #)
                      do
                         select
                           (# error:: (# do true->continue #);
                              whenFile:: 
                                (# f: ^file; ext: ^text; location: @text
                                do
                                   thefile->f[];
                                   f.entry.path.name.suffix->ext[];
                                   f.entry.path.name->location.puttext;
                                   (if '.bet'->ext.equal then
                                       browser.currentProject.location[]
                                         ->location.prepend;
                                       location[]->win.files.puttext;
                                       ' '->win.files.put;
                                       
                                   if);
                                   
                                #)
                           #)
                      #)
                 #)
	     if)
	 if);
	 win.doExecute;
       
      else
	 'BETA compiler\n     "%s"\nnot available'
	   ->t.putformat (#  do exec[]->s #);
	 (none ,t[],'Repeating BETA Compiler')->alertUser;
	 &fileSelectionDialog
	   (#  do 'Select BETA compiler executable'->title[] #)->BETAexecutable[];
	 (if BETAexecutable[] <> none then
	     BETAexecutable[]->mps.AST.expandToFullPath->exec[];
	     restart l
	 if)
     if)
#)  

-- iExecuteSlot: Descriptor --
(#
   win: @executeWindow (# doRepeat::  (#  do setupNewProcess #);  #);
   t: @text; exec: ^text;
do
   (if true
    // browser.currentGroup[] <> none then
       browser.currentGroup.location[]->exec[]; 
    // browser.currentProject[] <> none then
       (if true
        // browser.currentProject.isRoot
        // browser.currentProject.isExtent
        // browser.currentProject.isDomain then
           browser.currentProject.location[]->exec[]; 
       if)
   if);
   exec[]->mps.AST.expandToFullPath->exec[];
   (if (exec[]->fileExists) and (exec[]->fileReadable) and
	 (exec[]->fileExecutable) then
       &text[]->win.arguments[];
       exec[]->win.BETAprogram[]; win.open; win.doExecute
    else
       'Selected executable\n     "%s"\nnot available'
         ->t.putformat (#  do exec[]->s #);
       (none ,t[],'Execute')->alertUser
   if)
#)  

-- iDebugSlot: Descriptor --
(#
   win: @executeWindow (# doRepeat::  (#  do setupNewProcess #);  #);
   t: @text; exec: ^text;
do
   (if (VALHALLAexecutable[] = none) or (VALHALLAexecutable.length=0) then
       '~beta/bin/valhalla2.1'->mps.AST.expandToFullPath->VALHALLAexecutable.puttext;
       
   if);
   VALHALLAexecutable[]->mps.AST.expandToFullPath->exec[];
   l:
     (if (exec[]->fileExists) and (exec[]->fileReadable) and
	   (exec[]->fileExecutable) then
	 &text[]->win.arguments[];
	 exec.copy->win.BETAprogram[];
	 (if true
	  // browser.currentGroup[] <> none then
	     browser.currentGroup.location[]
               ->mps.AST.expandToFullPath->win.arguments.puttext; 
	  // browser.currentProject[] <> none then
	     (if true
	      // browser.currentProject.isRoot
	      // browser.currentProject.isExtent
	      // browser.currentProject.isDomain then
		 browser.currentProject.location[]
                   ->mps.AST.expandToFullPath->win.arguments.puttext; 
	     if);
           
	 if);
	 win.arguments[]->putline;
	 (if (win.arguments[]->fileExists) and (win.arguments[]->fileReadable) and
	       (win.arguments[]->fileExecutable) then
	     win.open; win.doExecute
	  else
	     'Selected executable\n     "%s"\nnot available'
	       ->t.putformat (#  do win.arguments[]->s #);
	     (none ,t[],'Debug')->alertUser
	 if)
      else
	 'Debugger\n     "%s"\nnot available'
	   ->t.putformat (#  do exec[]->s #);
	 (none ,t[],'Debug')->alertUser;
	 &fileSelectionDialog (#  do 'Select Valhalla executable'->title[] #)
	   ->VALHALLAexecutable[];
	 (if VALHALLAexecutable[] <> none then
	     VALHALLAexecutable[]->mps.AST.expandToFullPath->exec[];
	     restart l
	 if)
     if)
#)  

-- iSifSlot: Descriptor --
(#
   win: @executeWindow
     (# doRepeat::  (#  do setupNewProcess #); open::  (#  do hide #)
     #);
   t: @text; exec: ^text;
   
do
   (if (SIFexecutable[] = none) or (SIFexecutable.length=0) then
       '~beta/bin/sif'->mps.AST.expandToFullPath->SIFexecutable.puttext; 
   if);
   SIFexecutable[]->mps.AST.expandToFullPath->exec[];
   l:
     (if (exec[]->fileExists) and (exec[]->fileReadable) and
	   (exec[]->fileExecutable) then
         &text[]->win.arguments[];
         exec.copy->win.BETAprogram[];
         (if true
          // browser.currentGroup[] <> none then
             browser.currentGroup.location[]->win.arguments.puttext; 
          // browser.currentProject[] <> none then
             (if true
              // browser.currentProject.isRoot
              // browser.currentProject.isExtent
              // browser.currentProject.isDomain then
                 browser.currentProject.location[]->win.arguments.puttext; 
             if)
         if);
         '.bet'->win.arguments.puttext;
         win.open;
         win.doExecute
      else
         'Sif executable\n     "%s"\nnot available'
           ->t.putformat (#  do exec[]->s #);
         (none ,t[],'Edit: Sif')->alertUser;
         &fileSelectionDialog (#  do 'Select Sif executable'->title[] #)
           ->SIFexecutable[];
         (if SIFexecutable[] <> none then
             SIFexecutable[]->mps.AST.expandToFullPath->exec[];
             restart l
         if)
     if);
   
#)  

-- iFrejaSlot: Descriptor --
(#
   win: @executeWindow
     (# doRepeat::  (#  do setupNewProcess #); open::  (#  do hide #)
     #);
   t: @text; exec: ^text;
   
do
   (if (FREJAexecutable[] = none) or (SIFexecutable.length=0) then
       '~beta/bin/freja'->mps.AST.expandToFullPath->FREJAexecutable.puttext; 
   if);
   FREJAexecutable[]->mps.AST.expandToFullPath->exec[];
   l:
     (if (exec[]->fileExists) and (exec[]->fileReadable) and
	   (exec[]->fileExecutable) then
	 &text[]->win.arguments[];
	 exec.copy->win.BETAprogram[];
	 (if true
	  // browser.currentGroup[] <> none then
	     browser.currentGroup.location[]->win.arguments.puttext; 
	  // browser.currentProject[] <> none then
	     (if true
	      // browser.currentProject.isRoot
              // browser.currentProject.isExtent
	      // browser.currentProject.isDomain then
		 browser.currentProject.location[]->win.arguments.puttext; 
	     if)
	 if);
	 '.bet'->win.arguments.puttext;
	 win.open;
	 win.doExecute
      else
	 'Freja executable\n     "%s"\nnot available'
	   ->t.putformat (#  do exec[]->s #);
	 (none ,t[],'Edit: Freja')->alertUser;
	 &fileSelectionDialog (#  do 'Select Freja executable'->title[] #)
	   ->FREJAexecutable[];
	 (if FREJAexecutable[] <> none then
	     FREJAexecutable[]->mps.AST.expandToFullPath->exec[];
	     restart l
	 if)
     if);
   
#)  

-- iInterfacebuilderSlot: Descriptor --
(#
   win: @executeWindow
     (# doRepeat::  (#  do setupNewProcess #); open::  (#  do hide #)
     #);
   t: @text; exec: ^text;
   
do
   (if (INTERFACEBUILDERexecutable[] = none) or (INTERFACEBUILDERexecutable.length=0) then
       '~beta/bin/frigg'->mps.AST.expandToFullPath->INTERFACEBUILDERexecutable.puttext;
       
   if);
   INTERFACEBUILDERexecutable[]->mps.AST.expandToFullPath->exec[];
   l:
     (if (exec[]->fileExists) and (exec[]->fileReadable) and
	   (exec[]->fileExecutable) then
	 &text[]->win.arguments[];
	 exec.copy->win.BETAprogram[];
	 (if true
	  // browser.currentGroup[] <> none then
	     browser.currentGroup.location[]->win.arguments.puttext; 
	  // browser.currentProject[] <> none then
	     (if true
	      // browser.currentProject.isRoot
	      // browser.currentProject.isExtent
	      // browser.currentProject.isDomain then
		 browser.currentProject.location[]->win.arguments.puttext; 
	     if)
	 if);
	 '.bet'->win.arguments.puttext;
	 win.open;
	 win.doExecute
      else
	 'Interfacebuilder executable\n     "%s"\nnot available'
	   ->t.putformat (#  do exec[]->s #);
	 (none ,t[],'Edit: Interfacebuilder')->alertUser;
	 &fileSelectionDialog
	   (#  do 'Select InterfaceBuilder executable'->title[] #)
	   ->INTERFACEBUILDERexecutable[];
	 (if INTERFACEBUILDERexecutable[] <> none then
	     INTERFACEBUILDERexecutable[]->mps.AST.expandToFullPath->exec[];
	     restart l
	 if)
     if);
   
#)  

-- iTextEditSlot: Descriptor --
(#
   win: @executeWindow
     (# doRepeat::  (#  do setupNewProcess #); open::  (#  do hide #)
     #);
   t: @text; exec: ^text;
   
do
   &text[]->win.arguments[];
   (if (TEXTexecutable[] = none) or (TEXTexecutable.length=0) then
       '$(EDITOR)'
         ->expandEnvVar
	     (#
		defaultValue:: 
		  (#  do '/usr/local/bin/emacs'->envvarvalue[] #)
	     #)->TEXTexecutable[];
       
   if);
   TEXTexecutable.copy->win.BETAprogram[];
   l:
     (if (win.BETAprogram[]->fileExists) and (win.BETAprogram[]->fileReadable) and
	   (win.BETAprogram[]->fileExecutable) then
	 (if true
	  // browser.currentGroup[] <> none then
	     browser.currentGroup.location[]->win.arguments.puttext; 
	  // browser.currentProject[] <> none then
	     (if true
	      // browser.currentProject.isRoot
              // browser.currentProject.isExtent
	      // browser.currentProject.isDomain then
		 browser.currentProject.location[]->win.arguments.puttext; 
	     if)
	 if);
	 '.bet'->win.arguments.puttext;
	 win.open;
	 win.doExecute;
       
      else
	 'Text Editor\n     "%s"\nnot available'
	   ->t.putformat (#  do win.BETAprogram[]->s #);
	 (none ,t[],'Edit: Text Editor')->alertUser;
	 &fileSelectionDialog
	   (#  do 'Select TEXT EDITOR executable'->title[] #)->TEXTexecutable[];
	 (if TEXTexecutable[] <> none then
	     TEXTexecutable.copy->win.BETAprogram[]; restart l
	 if)
     if)
#)  

-- iAnalyzeSlot: Descriptor --
(#
   win: @executeWindow
     (#
        executeStartMsg::  (#  do 'Analysis start'->value #);
        executeRestartMsg::  (#  do 'Analysis restart'->value #);
        executeAbortMsg::  (#  do 'Analysis ABORT'->value #);
        executeEndMsg::  (#  do 'Analysis terminated'->value #);
        repeatLabel::  (#  do 'Analyze again'->value #);
        doRepeat::  (#  do setupNewProcess #)
     #);
   t: @text; exec: ^text;
   
do
   (if (BETAWCexecutable[] = none) or (BETAWCexecutable.length=0) then
       '~beta/bin/betawc'->mps.AST.expandToFullPath->BETAWCexecutable.puttext;
       
   if);
   BETAWCexecutable[]->mps.AST.expandToFullPath->exec[];
   l:
     (if (exec[]->fileExists) and (exec[]->fileReadable) and
	   (exec[]->fileExecutable) then
	 &text[]->win.arguments[];
	 exec.copy->win.BETAprogram[];
	 (if true
	  // browser.currentGroup[] <> none then
	     browser.currentGroup.location[]->win.arguments.puttext; 
	  // browser.currentProject[] <> none then
	     (if true
	      // browser.currentProject.isRoot
              // browser.currentProject.isExtent
	      // browser.currentProject.isDomain then
		 browser.currentProject.location[]->win.arguments.puttext; 
	     if)
	 if);
	 win.arguments[]->mps.ast.expandtofullpath
	   ->win.arguments[];
	 win.open;
	 win.doExecute;
       
      else
	 'Analysis tool betawc\n     "%s"\nnot available'
	   ->t.putformat (#  do exec[]->s #);
	 (none ,t[],'Analyze')->alertUser;
	 &fileSelectionDialog (#  do 'Select Analysis executable'->title[] #)
	   ->BETAWCexecutable[];
	 (if BETAWCexecutable[] <> none then
	     BETAWCexecutable[]->mps.AST.expandToFullPath->exec[];
	     restart l
	 if)
     if)
#)  
