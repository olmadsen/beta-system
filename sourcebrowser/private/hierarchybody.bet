ORIGIN 'sourcebrowserbody';
INCLUDE 'setupProjects';

--updateFolderView:dopart--
do 'updatefolderview'->putline;
   (formview[],g[],true)->setupGroup;
   (formView.root).items.clear;
   g.items.scan
   (# 
   do (if current.isFolder then
       else
          current[]->(formView.root).addItem
      if)
   #);
   ''->(formview.root).label[];
   (g.location[],'/fzvsvsvs')
     ->mps.ast.thepathhandler.localpath->fragmentDefaultName
     ->(formview.root).label.append;

   (* (formView.root).onExpand; *)

   (if g.lastSelectedFf[]=none then
       (if (formview.root).items.size=1 then
           ((formview.root).items.head).elm.Select;
           true->didSelect;
           formView.theScroller[]->((formview.root).items.head).elm.scrollIntoView
       if);
    else
       (formview.root).items.scan
       (# form:^formview.form;
       do (if current##=formview.form## then
              current[]->form[];
              (if form.ff[]=g.lastSelectedFf[] then
                  form.select;
                  true->didSelect;
                  formView.theScroller[]->form.scrollIntoView
              if)
          if)
       #)
   if);
   (if not didSelect then formview.changed if)

--- directoryProjectOnExpand: dopart ---
do (hir[],this(directoryProject)[],location[])->setupDirectory;
   (*do (this(contentsType)[],this(directoryProject)[],location[])->setupDirectory*)
   theProjectInfoProject[]->setCP;
   none->Interface.CurrentGroup[];
   none->Interface.CurrentForm[]
   
--- projectFileOnExpand: dopart ---  
do (hir[],this(projectFile)[])->setupProjectFile;
   theProjectInfoProject[]->setCp;
   
--- groupOnExpand: dopart ---
do (hir[],this(group)[],false)->setupGroup;
   fg[]->sbPrivate.geList.findOrCreateGroupEditor
     ->cge;
   
--includeOnExpand:dopart--
do 'INCLUDE-expand, loc:%s\n'->putformat
   (# do pe.location[]->s #);
   (# g: @hir.group
   do (pe.label[],pe.location[])->(g.label[],g.location[]);
      'fgc'->g.label[];
      g[]->getfg;
      (hir[],g[],false)
        ->setupGroup;
      g.items.scan
      (# do current[]->pe.additem #);
      g.fg[]->pe.fg[]
   #)
    
   
--- formOnSelected: dopart ---  
do (* not used anymore, forms are solely in formview!! *)
   ff.father
     ->sbPrivate.geList.findOrCreateGroupEditor
     ->cge;
   (*
    (# o: ^object do ff[]->sbprivate.sourceview.newfragment->(cfe,o[]) #)
    *)
   ff[]->Interface.currentForm[];
   ff[]->this(SourceBrowser).onCurrentFormChange
   
--- formViewOnSelected: dopart ---  
do ff.name->sbprivate.formView.selectedFormName[];
   ff.father
     ->sbPrivate.geList.findOrCreateGroupEditor
     ->cge;
   (*
    (# o: ^object do ff[]->sbprivate.sourceview.newfragment->(cfe,o[]) #)
    *)
   ff[]->theGroup.lastSelectedFf[]->Interface.currentForm[];
   ff[]->this(SourceBrowser).onCurrentFormChange
   
--- directoryProjectSetupListView: dopart ---
do (# dp: ^hierarchy.directoryProject
   do &sourceView.listView.contents.contents.directoryProject[]->dp[];
      
      (label[],location[])->(dp.label[],dp.location[]);
      (sourceView.listView.contents.contents[],dp[],location[])
        ->setupDirectory;
      dp[]->sourceView.listView.install
   #)
   
--- projectFileSetupListView: dopart ---
do (# pf: ^hierarchy.projectFile
   do &sourceView.listView.contents.contents.projectFile[]->pf[];
      
      (label[],location[])->(pf.label[],pf.location[]);
      (sourceView.listView.contents.contents[],pf[])
        ->setupProjectFile;
      pf[]->sourceView.listView.install
   #)
   
--- groupSetupListView: dopart ---
do 'groupSetupListView on %s\n'->putformat(# do location[]->s #);
   findCP;
   location[]->mps.AST.expandToFullPath->mps.fragmentGroupTable.getFragmentGroup
     ->fg[];
   (if fg[]<>selectedFG[] then
       (# g: ^hierarchy.group
       do &sourceView.listView.contents.contents.group[]->g[]; 
          (label[],location[],lastSelectedFF[])->(g.label[],g.location[],g.lastSelectedFf[]);
          (* (sourceView.listView.contents.contents[],g[],true) *)
          (* (formview[],g[],true)->setupGroup; *)
          (* g[]->sourceView.listView.install;*)
          
          this(group)[]->formview.theGroup[];
          g[]->updateFolderView;
          theProjectInfoGroup[]->Interface.currentGroup[]
       #)
   if);
   (if not isinusedGroups then
       (fg.fullname,false)->addToUsedGroups
   if);
   fg[]->selectedFG[]
   
--- originSetupListView: dopart ---
do (# g: ^hierarchy.group
   do &sourceView.listView.contents.contents.group[]->g[];
      
      (label[],location[])->(g.label[],g.location[]);
      g[]->getfg;
      (*(sourceView.listView.contents.contents[],g[],false)
       ->setupGroup;
       g[]->sourceView.listView.install; *)
      (* g[]->updateFolderView; *)
      (g.location[],true)->(*addToGroupDependencyCache*)addToUsedGroups 
   #)
   
--- includeSetupListView: dopart ---
do (# g: ^hierarchy.group
   do &sourceView.listView.contents.contents.group[]->g[];
      (label[],location[])->(g.label[],g.location[]);
      g[]->getfg;
      (* (sourceView.listView.contents.contents[],g[],true)
        ->setupGroup;
       g[]->sourceView.listView.install *)
      g[]->updateFolderView;
      (g.location[],true)->(*addToGroupDependencyCache*)addToUsedGroups
   #)
    
--- bodySetupListView: dopart ---
do (# g: ^hierarchy.group
   do &sourceView.listView.contents.contents.group[]->g[];
      (label[],location[])->(g.label[],g.location[]);
      g[]->getfg;
      (* (sourceView.listView.contents.contents[],g[],true)
        ->setupGroup;
       g[]->sourceView.listView.install *)
      g[]->updateFolderView;
      (g.location[],true)->(* addToGroupDependencyCache *) addToUsedGroups
   #)
  
 
--groupinit:dopart--
do
   &projects.group[]->theProjectInfoGroup[];
   location.copy->theProjectInfoGroup.location.append;
   fg[]->theProjectInfoGroup.fg[];
   &lfmenu.menuitem
   (# eventhandler::
        (# onSelect::
             (# 
             do this(group).father.onCollapse;
                location[]->mps.AST.expandToFullPath->mps.fragmentGroupTable.getFragmentGroup
                  ->fg[];
                (fg.name,true)->addToUsedGroups
             #);
           onStatus::(# do not isInUsedGroups-> value #)
        #);
      open::(# do 'Open in Used-files'->name #)
   #)[]->lfmenuitem[];
   lfmenuitem.open;
   lfmenuitem[]->lfmenu.append
   
--directoryProjectinit:dopart--
do
   &projects.project[]->theProjectInfoProject[];
   showTxtFiles->theProjectInfoProject.showTxtFiles;
   hasSubprojects->theProjectInfoProject.hasSubprojects;
   location.copy->theProjectInfoProject.location.append;
   label.copy->theProjectInfoProject.name[];
   true->theProjectInfoProject.isDirectory;
   'DirectoryProjectinit os %s\n'->putformat(# do label[]->s #)
   
--ProjectFileinit:dopart--
do
   &projects.project[]->theProjectInfoProject[];
   hasSubprojects->theProjectInfoProject.hasSubprojects;
   (if location[]<>none then location.copy->theProjectInfoProject.location.append if);
   (if label[]<>none then label.copy->theProjectInfoProject.name[] if);
   true->theProjectInfoProject.isProjectFile;
   'ProjectFileinit os %s\n'->putformat(# do label[]->s #)
   
   
--temporaryProjectInit:dopart--
do &projects.project[]->theProjectInfoProject[];
   hasSubprojects->theProjectInfoProject.hasSubprojects;
   (if location[]<>none then location.copy->theProjectInfoProject.location.append if);
   (if label[]<>none then label.copy->theProjectInfoProject.name[] if);
   true->theProjectInfoProject.isProjectFile;
   'temporaryProjectInit os %s\n'->putformat(# do label[]->s #);
   lfmenu.open;
   lfmenu[]->popupMenu;
   &lfmenu.menuitem
   (# eventhandler::
        (# onSelect::
             (# 
             do SaveProjectFile 
             #)
        #);
      open::(# do 'Save Project'->name #)
   #)[]->lfmenuitem[];
   lfmenuitem.open;
   lfmenuitem[]->lfmenu.append
   
--temporaryProjectonSelect:dopart--
do
   findcp
   
   
--temporaryProjectSavePrjFile:dopart--
do (# filename:^text;
      prjFile:@file;
   do 'temporaryProjectSavePrjFile'->putline;
      '.recentProject.pjt'->filename[];
      filename[]->prjfile.name; prjfile.openWrite;
      'project Files '->prjfile.putline;
      items.scan
      (# grp:^group 
      do current[]->grp[];
         'group %s \'%s\'\n'->prjfile.putformat
         (# do grp.label[]->s; grp.location[]->s #)
      #);
      prjFile.close
   #)
      
   
