ORIGIN '~beta/guienv/guienv';
LIB_DEF 'srcbrwbrowser' '../lib';
INCLUDE '~beta/mps/astlevel'
        '~beta/betaast/gram'
        '~beta/toollibs/UI/listmoveable'
        '~beta/guienv/utils/labelled'
        'codemoveable'
        'ymerInterface'
        'projects'
        'asciiEditor';
BODY 'private/sourcebrowserbody';
(*
 * COPYRIGHT
 *   Copyright Mjolner Informatics, 1995-96
 *   All rights reserved.
 *)
-- windowlib: Attributes --
sourceBrowser: canvas (* ABSTRACT PATTERN! *)
  (#
     <<SLOT sourcebrowserLib:Attributes>>;
     Interface: ^ymerBrowserInterface;
     (* projectInfoType
      * ===============
      * Must be further bound in specializations. *)
     projectInfoType:< projectInfo;
     projects: @projectInfoType;
     groups: @List
       (#
          <<SLOT sourcebrowsergroupslib:Attributes>>;
          element:: 
            (#
               index: @Integer;
               g: ^projects.group;
               
            #);
          getGroupByIndex:
            (#
               index: @Integer;
               g: ^projects.group;
               
            enter index
            <<SLOT groupsGetGroupByIndex:DoPart>>
            exit g[]
            #);
          getIndexByGroup:
            (# index: @Integer; g: ^projects.group; 
            enter g[]
            <<SLOT groupGetIndexByGroup:DoPart>>
            exit index
            #);
          
       #);
     cge: (* current group editor *)
       (# 
       enter Interface.cge[]
       exit Interface.cge[]
       #);
     cfe: @ (* current code editor *)
       (# 
       enter Interface.cfe[]
       do
          (if not (Interface.cfe[] = none )
           then
              Interface.cfe.theSifTexteditor[]->target
          if)
       exit Interface.cfe[]
       #);
     cte: (* current form editor *) ^asciiEditor;
     edenv: ^editorEnv;
     (* FUNCTIONALITY CONCERNING OPENING:
      * ================================= *)
     open::<  (#  <<SLOT sourcebrowseropen:DoPart>> #);
     onProjectListOpen:<
     (* Called when the project list view is opened. Use it to
      * install actions for the projectlist. *)
       (# theprojectlist: ^listmoveablelist; 
       enter theprojectlist[]
       do INNER
       #);
     onGroupListOpen:<
     (* Called when the group list view is opened. Use it to install
      * actions for the grouplist view. *)
       (# thegrouplist: ^listmoveablelist; 
       enter thegrouplist[]
       do INNER
       #);
     onFragmentgroupViewOpen:<
     (* Called when the fragmentgroup view is opened. Use it to install
      * actions for the fragmentgroup view. *)
       (# thefragmentgroupview: ^listmoveablelist; 
       enter thefragmentgroupview[]
       do INNER
       #);
     onCodeViewOpen:<
     (* Called when the code view is opened. Use it to install
      * actions for the codeview. *)
       (# thecodeview: ^codemoveableEditor; 
       enter thecodeview[]
       do INNER
       #);
     (* CODEVIEWER ENCLOSER (See newcodemoveable.bet)
      * =============================================
      * MUST be further bound in specializations of sourcebrowser. *)
     editorEncloserType:< codemoveableEditorEncloser;
     editorEncloser: @editorEncloserType;
     currentProject: ^projects.project;
     currentGroup: ^projects.group;
     currentForm: @
       (#  enter interface.currentform[] exit interface.currentform[] #);
     ;
     propertySelected: @boolean;
     projectsLabel:<
     (* Further bind to change label on projects list in UI. Default is
      * 'Directories'. *)
       (# t: ^Text;  do 'Directories'->t[]; INNER exit t[] #);
     emptyProjectListLabel:<
     (* Further bind to change label on empty group list in UI. Default
      * is 'No directory selected'. *)
       (# t: ^Text;  do 'No directory selected'->t[]; INNER exit t[] #);
     emptyGroupViewLabel:<
     (* Further bind to change label on empty fragment view in UI. Default
      * is 'No fragment group selected'. *)
       (# t: ^Text; 
       do 'No fragment group selected'->t[]; INNER
       exit t[]
       #);
     emptyCodeViewLabel:<
     (* Further bind to change label on empty fragment view in UI. Default
      * is 'No fragment selected'. *)
       (# t: ^Text;  do 'No fragment selected'->t[]; INNER exit t[] #);
     followLink:<
     (* Called when user double-clicks link in displayed fragment group.
      * Further bind to call setProject. *)
       (#
          groupname: ^Text; (* Name of fragment group pointed out by link. *) 
       enter groupname[]
       do INNER
       #);
     fileEdit:<
     (* Called when user double-clicks make property in displayed
      * fragment group.
      *)
       (# filename: ^Text; (* Name of file to be edited *) 
       enter filename[]
       do INNER
       #);
     selectnode:< (* Called when user double-clicks on an ast node. *)
       (#
          theEditorRoot,node: ^astInterface.ast;
          (* ast node double-clicked at. *)
          separate: @boolean
       enter (theEditorRoot[],node[],separate)
       do INNER
       #);
     onCurrentProjectChange:< (* Called by setProject. *)
       (# newProject: ^projects.project;  enter newProject[] do INNER #);
     onCurrentGroupChange:< (* Called by setGroup after calling setProject. *)
       (# newGroup: ^projects.group; 
       enter newGroup[]
       do
          (if newGroup[] <> none then
              newGroup[]->currentProject.lastGroupSelected[]
          if);
          INNER
       #);
     onCurrentFormChange:<
     (* Called by setFragmentForm after calling setGroup. *)
       (# newForm: ^astInterface.fragmentForm; 
       enter newForm[]
       do
          (if newForm[] <> none then
              newForm[]->currentGroup.lastFormSelected[]
          if);
          INNER
       #);
     projectsChanged: (* Call to notify changes in the project list. *)
       (#  <<SLOT sourcebrowserProjectsChanged:DoPart>> #);
     setProject:
     (* Call to change the project shown. If doscan is TRUE, the list
      * of projects is updated using projects.scanProjects. *)
       (#
          p: ^projects.project;
          setGroupDoneInInner,setFormDoneInInner: @Boolean;
          
       enter p[]
       <<SLOT sourcebrowserSetProject:DoPart>>
       #);
     setGroup: setProject
       (# g: ^projects.group; 
       enter g[]
       <<SLOT sourcebrowserSetGroup:DoPart>>
       #);
     setFragmentForm: setGroup
       (# ff: ^astInterface.fragmentForm; 
       enter ff[]
       <<SLOT sourcebrowserSetFragmentForm:DoPart>>
       #);
     sbprivate:
       @<<SLOT sourcebrowserprivate:Descriptor>>;
     locationView: @sblabelled
       (#
          eventhandler:: 
            (#
               onMouseDown:: 
                 (#  <<SLOT sourcebrowserLocationViewMouseDown:DoPart>> #)
            #);
          private:
            @<<SLOT sourcebrowserLocationViewPrivate:Descriptor>>;
          display:
            (# m: ^text
            enter m[]
            <<SLOT sourcebrowserLocationViewDisplay:DoPart>>
            #);
          clear:
            (# 
            <<SLOT sourcebrowserLocationViewClear:DoPart>>
            #);
          isChanged,isChecked,isLocked: @boolean;
          changed::  (#  <<SLOT sourcebrowserLocationViewChanged:DoPart>> #);
          checked::  (#  <<SLOT sourcebrowserLocationViewChecked:DoPart>> #);
          locked::  (#  <<SLOT sourcebrowserLocationViewLocked:DoPart>> #);
          msg:
            (# msg: ^text
            enter msg[]
            <<SLOT sourcebrowserLocationViewMsg:DoPart>>
            #);
          contentsType:: staticText (# open::  (#  do ''->label #) #);
          open:: 
            (# sz: @point; 
            enter sz
            <<SLOT sourcebrowserLocationViewOpen:DoPart>>
            #)
       #);
     state: @
       (#
          curList: @stack
            (# element:: cursor
            #);
          busy: @
            (# 
            do
               mouse.busyCursor
                 ->curList.push;
               cursors.watch[]
                 ->mouse.busyCursor
            #);
          normal: @
            (# 
            do
               (if curList.empty then
                   none ->mouse.busyCursor
                else
                   curList.pop->mouse.busyCursor
               if);
               
            #)
       #);
     infoView: @sbInfoView
       (#
          msgPush::  (#  do m[]->msgList.prepend; display #);
          msgPop:: 
            (# 
            do
               (if msgList.size > 0 then
                   (msgList.head).elm[]->done; msgList.head->msgList.delete
               if)
            #);
          txt: @text;
          append: @ (# msg: ^text enter msg[] do msg[]->m.append #);
          display: @ (#  do m[]->locationView.display;  #);
          msg::  (#  do display #);
          msgClear::  (#  do locationView.clear #);
          done::  (#  do 'done'->append; display #);
          open: (#  do 'Info: '->locationView.contents.label #)
       #)
  #)  

