ORIGIN 'classfile';
INCLUDE '~beta/containers/hashTable';
--LIB: attributes--

JavaImage:
  (# cf: @ClassFile;
     
     traceClassFile: @boolean;
     
     thisClassIndex, superClassIndex: @integer;
     
     (* Class file structs with tracing controlled by local variable traceClassFile *)
     CF_CONSTANT_Class_info: 
       cf.CONSTANT_Class_info(# trace::(# do traceClassFile->value #)#);
     CF_CONSTANT_ref_info: 
       cf.CONSTANT_ref_info(# trace::(# do traceClassFile->value #)#);
     CF_CONSTANT_Fieldref_info: 
       cf.CONSTANT_Fieldref_info(# trace::(# do traceClassFile->value #)#);
     CF_CONSTANT_Methodref_info: 
       cf.CONSTANT_Methodref_info(# trace::(# do traceClassFile->value #)#);
     CF_CONSTANT_InterfaceMethodref_info: 
       cf.CONSTANT_InterfaceMethodref_info(# trace::(# do traceClassFile->value #)#);
     CF_CONSTANT_String_info: 
       cf.CONSTANT_String_info(# trace::(# do traceClassFile->value #)#);
     CF_CONSTANT_U4_info: 
       cf.CONSTANT_U4_info(# trace::(# do traceClassFile->value #)#);
     CF_CONSTANT_Integer_info: 
       cf.CONSTANT_Integer_info(# trace::(# do traceClassFile->value #)#);
     CF_CONSTANT_Float_info: 
       cf.CONSTANT_Float_info(# trace::(# do traceClassFile->value #)#);
     CF_CONSTANT_Long_info: 
       cf.CONSTANT_Long_info(# trace::(# do traceClassFile->value #)#);
     CF_CONSTANT_Double_info: 
       cf.CONSTANT_Double_info(# trace::(# do traceClassFile->value #)#);
     CF_CONSTANT_NameAndType_info: 
       cf.CONSTANT_NameAndType_info(# trace::(# do traceClassFile->value #)#);
     CF_CONSTANT_Utf8_info: 
       cf.CONSTANT_Utf8_info(# trace::(# do traceClassFile->value #)#);
     CF_field_info: 
       cf.field_info(# trace::(# do traceClassFile->value #)#);
     CF_method_info: 
       cf.method_info(# trace::(# do traceClassFile->value #)#);
     CF_attribute_info:
       cf.attribute_info(# trace::(# do traceClassFile->value #)#);
     CF_Exception_info: 
       cf.Exception_info(# trace::(# do traceClassFile->value #)#);
     CF_InnerClass_info: 
       cf.InnerClass_info(# trace::(# do traceClassFile->value #)#);
     CF_LineNumber_info: 
       cf.LineNumber_info(# trace::(# do traceClassFile->value #)#);
     CF_LocalVariable_info: 
       cf.LocalVariable_info(# trace::(# do traceClassFile->value #)#);
     
     init:<
       (# classfilename: ^text;
       enter classfilename[]
       do classfilename[] -> cf.name;
          constant_pool.init;
          fields.init;
       #);
     
     emitToFile:
       (# 
       do cf.openWrite;
          (JAVA_MAGIC, JAVA_MINOR, JAVA_MAJOR, ACC_SUPER, thisClassIndex, superClassIndex) 
            -> cf.write(# trace::(# do traceClassFile->value #)#);
          cf.close;
       #);
     
     constant_pool: @
       (# 
          strings: @integerHashTable(# entrytype::CF_CONSTANT_String_info #);
          classes: @integerHashTable;
          methodrefs: @integerPairHashTable;
          fieldrefs: @integerPairHashTable;
          doubles: @doubleHashTable;
          name_types: @integerPairHashTable;
          utf8strings: @texthashtable;
          init:
            (# 
            do strings.init;
               classes.init;
               methodrefs.init;
               fieldrefs.init;
               doubles.init;
               name_types.init;
               utf8strings.init;
            #);
       #);
     
     fields: @
       (# init:
            (# 
            #);
       #);
     
     currentmethod: @
       (# info: ^CF_Method_info;
          init: 
            (# 
            do (if info[]<>NONE then
                   info.write;
               if);
               &CF_Method_info[] -> info[];
            #);
          
       #);
     
     textHashTable: hashTable
       (# entrytype:< cf.entry;
          element::
            (# t: ^text;
               index: @integer (* index in cf.constant_pool *);
            #);
       #);
     
     integerHashTable: hashTable
       (# entrytype:< cf.entry;
          element::
            (# i: @integer;
               index: @integer (* index in cf.constant_pool *);
            #);
       #);
     
     integerPairHashTable: hashTable
       (# entrytype:< cf.entry;
          element::
            (# i1, i2: @integer;
               index: @integer (* index in cf.constant_pool *);
            #);
       #);
     
     doubleHashTable: hashTable
       (# entrytype:< cf.entry;
          element::
            (# d: @real;
               index: @integer (* index in cf.constant_pool *);
            #);
       #);
     
  #);
