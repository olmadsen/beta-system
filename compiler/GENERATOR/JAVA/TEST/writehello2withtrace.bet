ORIGIN '../classfile';

(* Writes file HelloWorld.class identical to 
 * the file written by compiling helloworld2.java
 * without debug info.
 * 
 * Examine the generated file using (Sun)
 *   javap -c  -private -s -verbose HelloWorld2 (must be complete file)
 * or (GNU gcc3.1)
 *   jcf-dump -c HelloWorld2 (forgiving)
 * 
 * If file complete, run with
 *    java HelloWorld2
 *)

--program: descriptor--
(# bc: @ClassFile;
   putb: @bc.putbytes;
   mi: ^BinFile.Method_info;
   ca: ^BinFile.Code_attribute;
do 'Writing HelloWorld2.class ... ' -> putline;

   (* Setup Constant Pool *)
   28 -> &bc.CONSTANT_String_info(# trace::(# do true->value #)#)
     -> (*1*) bc.constant_pool.add;
   32 -> &bc.CONSTANT_String_info(# trace::(# do true->value #)#)
     -> (*2*) bc.constant_pool.add;
   
   29 -> &bc.CONSTANT_Class_info(# trace::(# do true->value #)#)
     -> (*3*) bc.constant_pool.add;
   34 -> &bc.CONSTANT_Class_info(# trace::(# do true->value #)#)
     -> (*4*) bc.constant_pool.add;
   35 -> &bc.CONSTANT_Class_info(# trace::(# do true->value #)#)
     -> (*5*) bc.constant_pool.add;
   36 -> &bc.CONSTANT_Class_info(# trace::(# do true->value #)#)
     -> (*6*) bc.constant_pool.add;
   
   (3,15) -> &bc.CONSTANT_Methodref_info(# trace::(# do true->value #)#)
     -> (*7*) bc.constant_pool.add;
   (5,15) -> &bc.CONSTANT_Methodref_info(# trace::(# do true->value #)#)
     -> (*8*) bc.constant_pool.add;
   (3,16) -> &bc.CONSTANT_Fieldref_info(# trace::(# do true->value #)#)
     -> (*9*) bc.constant_pool.add;
   (6,17) -> &bc.CONSTANT_Fieldref_info(# trace::(# do true->value #)#)
     -> (*10*) bc.constant_pool.add;
   (3,18) -> &bc.CONSTANT_Methodref_info(# trace::(# do true->value #)#)
     -> (*11*) bc.constant_pool.add;
   (4,19) -> &bc.CONSTANT_Methodref_info(# trace::(# do true->value #)#)
     -> (*12*) bc.constant_pool.add;
   (4,20) -> &bc.CONSTANT_Methodref_info(# trace::(# do true->value #)#)
     -> (*12*) bc.constant_pool.add;
   (3,21) -> &bc.CONSTANT_Fieldref_info(# trace::(# do true->value #)#)
     -> (*14*) bc.constant_pool.add;
   
   (26,22) -> &bc.CONSTANT_NameAndType_info(# trace::(# do true->value #)#)
     -> (*15*) bc.constant_pool.add;
   (33,31) -> &bc.CONSTANT_NameAndType_info(# trace::(# do true->value #)#)
     -> (*16*) bc.constant_pool.add;
   (38,30) -> &bc.CONSTANT_NameAndType_info(# trace::(# do true->value #)#)
     -> (*17*) bc.constant_pool.add;
   (39,23) -> &bc.CONSTANT_NameAndType_info(# trace::(# do true->value #)#)
     -> (*18*) bc.constant_pool.add;
   (39,24) -> &bc.CONSTANT_NameAndType_info(# trace::(# do true->value #)#)
     -> (*19*) bc.constant_pool.add;
   (40,24) -> &bc.CONSTANT_NameAndType_info(# trace::(# do true->value #)#)
     -> (*20*) bc.constant_pool.add;
   (41,31) -> &bc.CONSTANT_NameAndType_info(# trace::(# do true->value #)#)
     -> (*21*) bc.constant_pool.add;
   
   '()V' -> &bc.CONSTANT_Utf8_info(# trace::(# do true->value #)#)
     -> (*22*) bc.constant_pool.add;
   '(I)V' -> &bc.CONSTANT_Utf8_info(# trace::(# do true->value #)#)
     -> (*23*) bc.constant_pool.add;
   '(Ljava/lang/String;)V' -> &bc.CONSTANT_Utf8_info(# trace::(# do true->value #)#)
     -> (*24*) bc.constant_pool.add;
   '([Ljava/lang/String;)V' -> &bc.CONSTANT_Utf8_info(# trace::(# do true->value #)#)
     -> (*25*) bc.constant_pool.add;
   '<init>' -> &bc.CONSTANT_Utf8_info(# trace::(# do true->value #)#)
     -> (*26*) bc.constant_pool.add;
   'Code' -> &bc.CONSTANT_Utf8_info(# trace::(# do true->value #)#)
     -> (*27*) bc.constant_pool.add;
   'Hello, ' -> &bc.CONSTANT_Utf8_info(# trace::(# do true->value #)#)
     -> (*28*) bc.constant_pool.add;
   'HelloWorld2' -> &bc.CONSTANT_Utf8_info(# trace::(# do true->value #)#)
     -> (*29*) bc.constant_pool.add;
   'Ljava/io/PrintStream;' -> &bc.CONSTANT_Utf8_info(# trace::(# do true->value #)#)
     -> (*30*) bc.constant_pool.add;
   'Ljava/lang/String;' -> &bc.CONSTANT_Utf8_info(# trace::(# do true->value #)#)
     -> (*31*) bc.constant_pool.add;
   'World!' -> &bc.CONSTANT_Utf8_info(# trace::(# do true->value #)#)
     -> (*32*) bc.constant_pool.add;
   'hello' -> &bc.CONSTANT_Utf8_info(# trace::(# do true->value #)#)
     -> (*33*) bc.constant_pool.add;
   'java/io/PrintStream' -> &bc.CONSTANT_Utf8_info(# trace::(# do true->value #)#)
     -> (*34*) bc.constant_pool.add;
   'java/lang/Object' -> &bc.CONSTANT_Utf8_info(# trace::(# do true->value #)#)
     -> (*35*) bc.constant_pool.add;
   'java/lang/System' -> &bc.CONSTANT_Utf8_info(# trace::(# do true->value #)#)
     -> (*36*) bc.constant_pool.add;
   'main' -> &bc.CONSTANT_Utf8_info(# trace::(# do true->value #)#)
     -> (*37*) bc.constant_pool.add;
   'out' -> &bc.CONSTANT_Utf8_info(# trace::(# do true->value #)#)
     -> (*38*) bc.constant_pool.add;
   'print' -> &bc.CONSTANT_Utf8_info(# trace::(# do true->value #)#)
     -> (*39*) bc.constant_pool.add;
   'println' -> &bc.CONSTANT_Utf8_info(# trace::(# do true->value #)#)
     -> (*40*) bc.constant_pool.add;
   'world' -> &bc.CONSTANT_Utf8_info(# trace::(# do true->value #)#)
     -> (*41*) bc.constant_pool.add;

   (* Setup fields *)
   (ACC_PUBLIC, 33(*hello*), 31(*String*)) -> &bc.Field_info(# trace::(# do true->value #)#)
     -> (*1*) bc.fields.add;
   (ACC_PUBLIC, 41(*world*), 31(*String*)) -> &bc.Field_info(# trace::(# do true->value #)#)
     -> (*2*) bc.fields.add;
   
   (* Setup Methods *)
   (* Method: <init> *)
   (0, 26, 22) 
     -> &bc.Method_info(# trace::(# do true->value #)#)
     -> mi[]
     -> bc.methods.add;
   (27 (*Code*), 1(*max_stack*) ,1(*max_locals*) )
     -> &bc.Code_attribute 
     -> ca[]
     -> mi.attributes.add;
   aload_0       -> ca.putByte;
   invokespecial -> ca.putByte; 8 -> ca.putShort;
   return        -> ca.putByte;
   
   (* Method: main *)
   (ACC_PUBLIC %Bor ACC_STATIC, 37, 25) 
     -> &bc.Method_info(# trace::(# do true->value #)#)
     -> mi[]
     -> bc.methods.add;
   (27 (*Code*), 2(*max_stack*) ,2(*max_locals*) )
     -> &bc.Code_attribute 
     -> ca[]
     -> mi.attributes.add;
   new           -> ca.putByte; 3  -> ca.putShort;
   dup           -> ca.putByte;
   invokespecial -> ca.putByte; 7  -> ca.putShort;
   astore_1      -> ca.putByte;
   aload_1       -> ca.putByte;
   ldc           -> ca.putByte; 1  -> ca.putByte;
   putfield      -> ca.putByte; 9  -> ca.putShort;
   aload_1       -> ca.putByte;
   ldc           -> ca.putByte; 2  -> ca.putByte;
   putfield      -> ca.putByte; 14 -> ca.putShort;
   aload_1       -> ca.putByte;
   iconst_0      -> ca.putByte;
   invokevirtual -> ca.putByte; 11 -> ca.putShort;
   aload_1       -> ca.putByte;
   iconst_1      -> ca.putByte;
   invokevirtual -> ca.putByte; 11 -> ca.putShort;
   return        -> ca.putByte;
   
   (* Method: print *)
   (ACC_PUBLIC, 39, 23) 
     -> &bc.Method_info(# trace::(# do true->value #)#)
     -> mi[]
     -> bc.methods.add;
   (27 (*Code*), 2(*max_stack*) ,2(*max_locals*) )
     -> &bc.Code_attribute 
     -> ca[]
     -> mi.attributes.add;
   (*  0 *) iload_1       -> ca.putByte;
   (*  1 *) ifne          -> ca.putByte; 17-1  -> ca.putShort;
   (*  4 *) getstatic     -> ca.putByte; 10    -> ca.putShort;
   (*  7 *) aload_0       -> ca.putByte;
   (*  8 *) getfield      -> ca.putByte; 9     -> ca.putShort;
   (* 11 *) invokevirtual -> ca.putByte; 12    -> ca.putShort;
   (* 14 *) goto          -> ca.putByte; 27-14 -> ca.putShort;
   (* 17 *) getstatic     -> ca.putByte; 10    -> ca.putShort;
   (* 20 *) aload_0       -> ca.putByte;
   (* 21 *) getfield      -> ca.putByte; 14    -> ca.putShort;
   (* 24 *) invokevirtual -> ca.putByte; 13    -> ca.putShort;
   (* 27 *) return        -> ca.putByte;

   (* Now write the class file *)
   'HelloWorld2.class' -> bc.name;
   bc.openWrite;
   (JAVA_MAGIC, JAVA_MINOR, JAVA_MAJOR, ACC_SUPER, 3(*this*), 5(*super*)) 
     -> bc.write(# trace::(# do true->value #)#);
   bc.close;
   
   'done' -> putline;
#)

