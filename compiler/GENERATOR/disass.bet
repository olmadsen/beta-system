ORIGIN '~beta/basiclib/betaenv';
LIB_ITEM 'betacodegen';
MDBODY sgi 'MIPS/mips_disass'
       sun4s 'SPARC/sparc_disass'
       default 'empty_disass'
---LIB:attributes---
disass: 
  (* general machine code disassembler;
   *     instruction -> CT (code text)
   * current version is RISC oriented as it takes a long
   * as input. Currently only tested for MIPS.
   *)
  (# <<SLOT compiler_disass_lib:attributes>>;
     hasDisass: booleanValue(# <<SLOT compiler_hasDisass:doPart>> #);
     PrintLab:< 
       (# isLab:< booleanValue;
          LIP,Lab: @integer
       enter LIP
       do INNER;
          (if isLab then '$L'->CT.putText if);
          Lab -> CT.putInt; 
       exit Lab         
       #);
     Puthex: (* problems with the one in machine for 0xFFC00000*)
       (# n: @integer;
          emit: @
            (# v: @integer;
               put: @
                 (# c: @integer 
                 enter c 
                 do (if c < 10 then '0'+c->S.put else 'A'+c-10->S.put if)
                 #)
            enter v
            do v div 16 -> put;
               v mod 16 -> put          
            #);
          zero: @
            (#
            do (if putLeadingZeros then '0'->S.put; '0'->S.put if)
            #);
          putLeadingZeros: @boolean; v: @integer;
          S: ^stream
       enter(n,putLeadingZeros,S[])
       do '0x'->S.putText;
          (if ((0->n.%getByte)->v) <> 0 then v-> Emit else zero if);    
          (* Above line tos_converted from: (if (@@n->TOS'%adrGetByte[0]'->v) <> 0 then v-> Emit else zero if); *)
          (if ((1->n.%getByte)->v) <> 0 then v-> Emit else zero if);    
          (* Above line tos_converted from: (if (@@n->TOS'%adrGetByte[1]'->v) <> 0 then v-> Emit else zero if); *)
          (if ((2->n.%getByte)->v) <> 0 then v-> Emit else zero if);
          (* Above line tos_converted from: (if (@@n->TOS'%adrGetByte[2]'->v) <> 0 then v-> Emit else zero if); *)
          (3->n.%getByte)->emit
          (* Above line tos_converted from: @@n->TOS'%adrGetByte[3]'->emit *)
       #);
     instruction: @integer;
     CT: @text
  enter instruction
  <<SLOT compiler_disass:doPart>>
  exit CT.copy
  #)
