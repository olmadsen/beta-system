ORIGIN 'BCmachine';
---emitDotNet:doPart---
do (# opMap: [500] ^text;
      init:
        (#
        do 'ldc.i4.' -> opMap[pushCst][];
           'ret'-> opMap[return][];
           'call\t'->opMap[call][];
           '' -> opMap[func][]
        #);
      dumpOpCode:
        (# opCode: @integer
        enter opCode
        do (if opMap[opCode][] <> none then
               opMap[opCode][] -> puttext
            else
               opCode->asText->puttext
        if)#);
      dumpReg:
        (#
        do '%'->put;
           (if BC.get
            // thisO then 'this' ->puttext
            // callO then 'call'->puttext
            else 
               'top'->puttext
           if);
        #);
      getReg: (# exit BC.get #);
      Address:
        (# reg,off,size: @integer;
           get:
             (# 
             do getReg -> reg;
                BC.get -> off;
                BC.get -> size  
             #);
           dump:
             (# 
             do (if size = 0 then 4 ->putint else size->putint if);
                '.'->put;
                (if reg 
                 // thisO then
                 // callO then
                    '%call.'->puttext
                 else
                    '%top.'->puttext
                if);
                off->putint
             #)
        #);
      opCode: @integer;
      A: @Address
   do init;
      read:
        (if opCode <> end then
            BC.get -> opCode;
            (if opCode 
             // entry then
                BC.gettext->puttext; ':'->put;
             // labelDef then 
                'L'->put; BC.get->putint; ':'->put; '\t'->put
             else
                '\t'->put ;
                (if opCode 
                 // pushVal then
                    A.get;
                    'ldloc.i'->puttext;
                    A.dump;
                    
                 // stVal then
                    A.get;
                    'stloc.i'->puttext;
                    A.dump
                 else
                    opCode -> dumpOpCode;
                    (if opCode 
                     // pushCst then BC.get -> putint
                     // pushAdr then A.get
                     // pushReg then dumpReg
                     // pushText
                     // call then BC.gettext -> puttext
                     // callPrim then BC.getText -> puttext
                     // jmp 
                     // cmpAndJmp then BC.get->asText->puttext; BC.get->putint;
                     // func then BC.get -> asText -> puttext

                    if);
                if)
            if);
            newline;
            restart read
        if)
   #)
