ORIGIN 'BCdotnetBody';
INCLUDE '~beta/basiclib/pcre'; 

--ImportAssemblyVersion: descriptor--
(# 
do out.indent.inc;
   ' {' -> out.puttext;
   (if is_external then
       (# version, publickeytoken: ^text;
       do assemblyname[]
            -> lookupAssemblyVersion 
            -> (version[], publickeytoken[]);
          out.nl;
          '.ver %s'
            -> out.putformat(# do version[]->s; #);
          out.nl;
          '.publickeytoken = (%s)'
            -> out.putformat(# do publickeytoken[]->s #);
          out.newline;
       #)
    else
       out.nl;
       '.ver %s'
         -> out.putformat(# do defaultversion->s; #);
       out.newline;                       
   if);
   out.indent.dec;
   '}' -> out.putln;
#)

--GacUtil: descriptor--
(# gac, gacline: ^text;
   cmd: ^text;
   gacutil_output: @file;
   gacutil_found: @boolean;
   system: external
     (# cmd: [0]@char
     enter cmd
     #);
   regexp: @pcre;
   (* FIXME: 
    * could call gacutil -l and match "assemblyname, version=xxxx", 
    * or use IMetaDataAssemblyImport from unmanaged API 
    *)
do '0:0:0:0' -> version[]; (* default *)
   'gacutil.exe' -> gac[];
   lookForGacUtil: scanSearchPath
     (# e: @diskentry;
     do path.length->path.setpos;
        DirectoryChar -> path.put;
        gac[] -> (path.copy).append -> e.path;
        (if e.exists then true->gacutil_found; leave lookForGacUtil if);
     #);
   (if not gacutil_found then
       '\n*** gacutil not found. Using default version for '->puttext;
       assemblyname[]->putline;
    else
       (if false then
           (* Calling execReadText apparently hangs in general in windows,
            * if output is more than one line (:-(  
            *)
           ('gacutil','-l') -> (GetSystemenv).execReadText -> gac[];
        else
           &text[] -> cmd[];
           'gacutil -l %s' -> cmd.putformat(# do assemblyname[]->s #);
           (*'\n' -> (cmd.copy).prepend -> screen.putline;*)
           ' > gacutil.out' -> cmd.append;
           cmd -> system;
           'gacutil.out' -> gacutil_output.name;
           gacutil_output.openread;
           &text[] -> gac[];
           read:
             (if not gacutil_output.eos then
                 gacutil_output.getline -> gac.putline;
                 restart read;
             if);
           gacutil_output.close;
           gacutil_output.delete;  
           (* find last line of gacutil output matching assemblyname *)
           ', Version=(\\d+)\\.(\\d+)\\.(\\d+)\.(\\d+), Culture=.*, PublicKeyToken=(.*),' 
             -> (assemblyname.copy).append 
             -> regexp;
           gac.reset;
           match:
             (if not gac.eos then
                 gac.getline 
                   -> gacline[];
                 (*gacline[] -> screen.putline;*)
                 gacline[]
                   -> regexp.match(# 
                                  do (*'match of version in GAC'->screen.putline;*)
                                     &text[] -> version[];
                                     '%d:%d:%d:%d'
                                       -> version.putformat(# sub: ^text;
                                                           do sub1 -> sub[];
                                                              sub.reset; sub.getint->d;
                                                              sub2 -> sub[];
                                                              sub.reset; sub.getint->d;
                                                              sub3 -> sub[];
                                                              sub.reset; sub.getint->d;
                                                              sub4 -> sub[];
                                                              sub.reset; sub.getint->d;
                                                           #);
                                     sub5 -> publickeytoken[];
                                  #);
                 restart match;
             if);
       if)
   if)
   
#)
