origin 'tstenv';
BUILD jvm 'jvm/Comp.class' 'Comp.java' 'javac Comp.java; mv Comp.class jvm';

---lib:attributes--
Comp: externalClass
  (# _init: (# b: ^Object enter b[]#);
     att: proc(##);
     susp: proc(##)
  do
  #);
Bcomp:
  (# myC: ^Comp;
     init:
       (# BB: ^Bcomp
       do this(bComp)[] -> BB[]; (* BB is neeeded because 
                                  * of code gen error
                                  *)
          BB[] -> &Comp[] -> myC[];          
       #);
     attach: (# do 'attach'->trace; myC.att #);
     susp: (# do 'suspend'->trace; myC.susp #);
     trace:
       (# t: ^text
       enter t[]
       do (if false then t[] -> putline if)
       #)
  do 'Bcomp:' -> trace;
     inner 
  #);
bComp1: Bcomp
  (#      
  do 'bComp1:A' -> putline;
     susp;
     'bComp1:B' -> putline;
  #);
bComp2: Bcomp
  (# b3: @bComp3;
  do b3.init;
     'bComp2:A' -> putline;
     susp;
     'bComp2:B' -> putline;
     susp;
     b3.attach;
     'bComp2:C' -> putline;;
     b3.attach;
  #);
bComp3: Bcomp
  (#
  do 'bComp3:A' -> putline;
     susp;
     'bComp3:B' -> putline;
  #);

---program:descriptor---
(# b1: @bComp1;
   b2: @bComp2;   
do b1.init;
   b2.init;
   b1.attach;
   b2.attach;
   b2.attach;
   b1.attach;
   b2.attach;
   b2.attach;
#)

       
