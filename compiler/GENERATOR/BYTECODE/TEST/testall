#!/usr/local/bin/perl -s
$BETALIB=$ENV{'BETALIB'};
$BETALIB=~s%\\%/%g;
require "$BETALIB/bin/admin/env.perl";

#### Configuration

$beta          = "$BETALIB/boot/bin/$objdir/beta";
$dotnetoptions = "-s 23";
$javaoptions   = "-qwp -s 188 23";

# Files to compile for both java and dotnet
@files    = ("hello", 
	     "Bmini0", 
	     "Bmini1", 
	     "Server", 
	     "Calculator", 
	     "Counter", 
	     "List", 
	     "NumList",
	     "Aclass", 
	     "Singular", 
	     "SuperFields",
	     "Ptn", 
	     "array",
             "small",
	     "stackuser",
	     "multiple",
	     );

# Files currently only working for java, or specific for java
@javaonly =   ("jstring",
	       "greetings"
	       );

# Files specific for dotnet
@dotnetonly = ("nstring"
	       );


##################### Don't change below ########################

$SIG{'INT'}  = 'IntHandler';

sub usage()
{
    local($msg) = @_;
    print "testall: $msg\n" if ($msg ne "");
    print<<EOT;
usage: testall [-h][-v][-r][-c][-C][-x][-d][-k][-j]
     -h  print this help
     -v  verbose mode
     -O  do not display correct outputs, only errors
     -r  run only (do not compile programs)
     -c  compile only (do not execute programs)
     -C  skip compilation of compiler
     -x  use diff with context when reporting errors
     -k  keep programs after execution
     -d  compile for target dotnet
     -j  compile for target javabc
         If no target options given, script will try to guess target
EOT
    exit;
}

&usage("Compile and execute all test programs") if ($h);
&usage("Both -d and -f specified") if ($d && $j);
$target="dotnet" if ($d);
$target="javabc" if ($j);
if ($target eq ""){
    # Try to guess
    if (-d "/cygdrive" || -d "C:"){
	$target = "dotnet";
    } else {
	$target = "javabc";
    }
}
print "*** Testing for target $target ***\n";

$verbose = $v;
$compileonly = $c;
$runonly = $r;
$context = "-c" if (defined($x));
$skipoutput = $O;
$keepprograms = $k;

if ($runonly && $compileonly){
    print "*** Both -c (compile only) and -r (run only) specified.\n";
    print "    Ignoring -c.\n";
    $compileonly=0;
}

if ($target eq "dotnet"){
    $sbetasrc="$BETALIB/compiler/nbeta.bet";
    $sbeta="$BETALIB/compiler/$objdir/nbeta${EXESUFFIX}";
} else {
    $sbetasrc="$BETALIB/compiler/jbeta.bet";
    $sbeta="$BETALIB/compiler/$objdir/jbeta${EXESUFFIX}";
}

unless ($C || $runonly){
    print "*** Compiling $sbeta ***\n" if ($verbose);
    system "$beta -qw -o $sbeta $sbetasrc > bootbeta.out" if (!$verbose);
    system "$beta -qw -o $sbeta $sbetasrc"                if ($verbose);
}

$options = $dotnetoptions  if ($target eq "dotnet");
$options = $javaoptions    if ($target eq "javabc");
push @files, @dotnetonly   if ($target eq "dotnet");
push @files, @javaonly     if ($target eq "javabc");

$compilecmd = "$sbeta $options"; # -t $target 

print "*** Removing ast files ***\n" if ($verbose);
system "rm *.ast *.astL >/dev/null 2>&1";

print "*** Compiling with command ***\n\t$compilecmd\n\n" unless ($runonly);

$f="tstenv";
print "-"x20 . "Compiling $f" . "-"x20  . "\n"; # if ($verbose);
system "$compilecmd $f > $f.out" if (! $verbose);
system "$compilecmd $f" if ($verbose);

foreach $f (@files){
    unless ($runonly){
	# Recompile
	print "-"x20 . "Removing $f/$f.exe" . "-"x20  . "\n" if ($verbose);
	unlink ("$f $f.exe");
	unlink ("program.dll") if (-e "program.dll");
	print "-"x20 . "Compiling $f" . "-"x20  . "\n"; # if ($verbose);
	system "$compilecmd $f > $f.out" if (! $verbose);
	system "$compilecmd $f" if ($verbose);
    }
    unless ($compileonly){
	# Execute
	print "-"x20 . "Executing $f" . "-"x20  . "\n"; # if ($verbose);
	system "./$f > $f.run";
	unless ($keepprograms) {
	    unlink "./$f$EXESUFFIX";
	}
	open(IN, "<$f.run");
	open(OUT, ">$f.out") || die "Unable to write processed output:$!";
	while(<IN>) {
	    s/\015$//;
	    print OUT;
	}
	close IN;
	close OUT;
	if ( -f "reference/$f.run" ){
	    if (system("diff $context reference/$f.run $f.out") == 0){
		system "cat $f.run" unless $skipoutput;
		print "[output is correct]\n";
		system "rm $f.run";
		system "rm $f.out";
		$status{$f} = 1;
	    } else {
		if ($x){
		    print "[Difference in output - see above]\n";
		} else {
		    print "[Difference in output - see above. Correct output below]\n";
		    system "cat -n reference/$f.run";
		}
		# Save diff file for easy lookup
		system "diff $context reference/$f.run $f.out > $f.diff";
		$status{$f} = 0;
	    }
	} else {
	    system "cat $f.run";
	    system "cp $f.run reference";
	    print "[No reference existed. Output above used for future reference]\n";
	    print "[Please do a manual 'cvs add reference/$f.run']\n";
	    $status{$f} = 2;
	}
    }
}

print "\n" . "*"x19 . " Summary " . "*"x19  . "\n";
print "  Succeeded:\n";
foreach $key (keys(%status)){
    print "    $key\n" if ($status{$key} == 1);
}
print "  Failed:\n";
foreach $key (keys(%status)){
    if ($status{$key} == 0){
	print "    $key";
	print " [see $key.diff]" if (-f "$key.diff");
	print "\n";
    }
}
print "\n";

if ($target eq "dotnet"){
    if (scalar @javaonly){
	print "  Not tested for .NET:\n    ";
	print join "\n    ", @javaonly;
	print "\n\n";
    }
}

sub CleanUp()
{

}

sub IntHandler 
{
   print "User interrupt. Exitting.\n";
   exit(1);
}
