#!/usr/local/bin/perl -s
$BETALIB=$ENV{'BETALIB'};
$BETALIB=~s%\\%/%g;
require "$BETALIB/bin/admin/env.perl";

#### Configuration

$beta          = "$BETALIB/boot/bin/$objdir/beta";
$dotnetoptions = "-qw -s 23";
$javaoptions   = "-qw -s 188 23";

# Programs to compile for both java and dotnet
@programs = 
    ("hello", 
     "Bmini0", 
     "Bmini1", 
     "Server", 
     "Calculator", 
     "Counter", 
     "List", 
     "NumList",
     "Aclass", 
     "Singular", 
     "SuperFields",
     "Ptn", 
     "array",
     "small",
     "stackuser",
     "multiple",
     "beer",
     "ECtest", 
     "constructor",
     "real32",
     "faclink",
     );

%programs_with_input =
    ("google" => "",
     );

# Programs currently only working for java, or specific for java
@javaonly =   
    ("jstring",
     "greetings", # currently has hardcoded java string signature
     );

# Programs specific for dotnet
@dotnetonly = 
    ("nstring",
     );

# Programs that need to be tested manually
%manually =
    (
     );
%javamanually =
    ("helloapplet" => "Test by opening helloapplet.html in browser",
     );
%dotnetmanually =
    (
     );

%known_failures =
    ("LL1"     => "use leave out of object",
     "go"      => "dotnet: betaenv.il does not assemble",
     "ECStest" => "javabc: ECStest.<init> wrong signature\n\tdotnet: problem with default location",
     );

##################### Don't change below ########################

$SIG{'INT'}  = 'IntHandler';

sub usage()
{
    local($msg) = @_;
    print "testall: $msg\n" if ($msg ne "");
    print<<EOT;
usage: testall [-h][-v][-r][-c][-C][-x][-d][-k][-j]
     -h  print this help
     -v  verbose mode
     -O  do not display correct outputs, only errors
     -r  run only (do not compile programs)
     -c  compile only (do not execute programs)
     -C  skip compilation of compiler
     -x  use diff with context when reporting errors
     -k  keep programs after execution
     -d  compile for target dotnet
     -j  compile for target javabc
         If no target options given, script will try to guess target
EOT
    exit;
}

&usage("Compile and execute all test programs") if ($h);
if (-d "/cygdrive" || -d "C:"){
    $host   = "windows";
    $target = "dotnet";
} else {
    $host   = "unix";
    $target = "javabc";
}

&usage("Both -d and -f specified") if ($d && $j);
$target="dotnet" if ($d);
$target="javabc" if ($j);

print "*** Testing for target $target ***\n";

$verbose = $v;
$compileonly = $c;
$runonly = $r;
$context = "-c" if (defined($x));
$skipoutput = $O;
$keepprograms = $k;

if ($runonly && $compileonly){
    print "*** Both -c (compile only) and -r (run only) specified.\n";
    print "    Ignoring -c.\n";
    $compileonly=0;
}

if ($target eq "dotnet"){
    $sbetasrc="$BETALIB/compiler/nbeta.bet";
    $sbeta="$BETALIB/bin/$objdir/nbeta${EXESUFFIX}";
} else {
    $sbetasrc="$BETALIB/compiler/jbeta.bet";
    $sbeta="$BETALIB/bin/$objdir/jbeta${EXESUFFIX}";
}

unless ($C || $runonly){
    print "*** Compiling $sbeta ***\n" if ($verbose);
    system "$beta -qw -o $sbeta $sbetasrc > bootbeta.out" if (!$verbose);
    system "$beta -qw -o $sbeta $sbetasrc"                if ($verbose);
}

$options = $dotnetoptions     if ($target eq "dotnet");
$options = $javaoptions       if ($target eq "javabc");
push @programs, keys %programs_with_input;
push @programs, @dotnetonly   if ($target eq "dotnet");
push @programs, @javaonly     if ($target eq "javabc");

if ($target eq "dotnet"){
    foreach $key (keys %dotnetmanually){
	$manually{"$key"} = $dotnetmanually{"$key"};
    }
}
if ($target eq "javabc"){
    foreach $key (keys %javamanually){
	$manually{"$key"} = $javamanually{"$key"};
    }
}

$compilecmd = "$sbeta $options"; # -t $target 

print "*** Removing ast files ***\n" if ($verbose);
system "rm *.ast *.astL >/dev/null 2>&1";

print "*** Compiling with command ***\n\t$compilecmd\n\n" unless ($runonly);

$f="tstenv";
print "-"x20 . "Compiling $f" . "-"x20  . "\n"; # if ($verbose);
system "$compilecmd $f > $f.out" if (! $verbose);
system "$compilecmd $f" if ($verbose);

foreach $f (@programs){
    if ($host eq "windows"){
	if ($target eq "javabc"){
	    $exec = "$f.bat";
	} else {
	    $exec = "$f.exe";
	}
    } else {
	$exec = "$f";
    }
    unless ($runonly){
	# Recompile
	print "-"x20 . "Removing $exec" . "-"x20  . "\n" if ($verbose);
	unlink ("$exec");
	unlink ("program.dll") if (-e "program.dll");
	print "-"x20 . "Compiling $f" . "-"x20  . "\n"; # if ($verbose);
	system "$compilecmd $f > $f.out" if (! $verbose);
	system "$compilecmd $f" if ($verbose);
    }
    unless ($compileonly){
	# Execute
	if (defined($programs_with_input{$f})){
	    print "-"x20 . "Executing $exec with input \"" . $programs_with_input{$f} . "\" " . "-"x20  . "\n"; # if ($verbose);
	    system "echo " . $programs_with_input{$f} . "|./$exec > $f.run";
	} else {
	    print "-"x20 . "Executing $exec" . "-"x20  . "\n"; # if ($verbose);
	    system "./$exec > $f.run";
	};
	unless ($keepprograms) {
	    unlink "./$exec";
	}
	open(IN, "<$f.run");
	open(OUT, ">$f.out") || die "Unable to write processed output:$!";
	while(<IN>) {
	    s/\015$//;
	    print OUT;
	}
	close IN;
	close OUT;
	if ( -f "reference/$f.run" ){
	    if (system("diff $context reference/$f.run $f.out") == 0){
		system "cat $f.run" unless $skipoutput;
		print "[output is correct]\n";
		system "rm $f.run";
		system "rm $f.out";
		$status{$f} = 1;
	    } else {
		if ($x){
		    print "[Difference in output - see above]\n";
		} else {
		    print "[Difference in output - see above. Correct output below]\n";
		    system "cat -n reference/$f.run";
		}
		# Save diff file for easy lookup
		system "diff $context reference/$f.run $f.out > $f.diff";
		$status{$f} = 0;
	    }
	} else {
	    system "cat $f.run";
	    system "cp $f.run reference";
	    print "[No reference existed. Output above used for future reference]\n";
	    print "[Please do a manual 'cvs add reference/$f.run']\n";
	    $status{$f} = 2;
	}
    }
}

print "\n" . "*"x19 . " Summary " . "*"x19  . "\n";
print "  Succeeded:\n";
print "  =========\n";
foreach $key (keys(%status)){
    print "    $key\n" if ($status{$key} == 1);
}

if (scalar %status){
    print "  Failed:\n";
    print "  =======\n";
    foreach $key (keys(%status)){
        if ($status{$key} == 0){
            print "    $key";
            print " [see $key.diff]" if (-f "$key.diff");
            print "\n";
        }
    }
    print "\n";
}

if ($target eq "dotnet"){
    if (scalar @javaonly){
        print "  Not tested for .NET:\n";
        print "  ====================\n";
        print "    " . join "\n    ", @javaonly;
        print "\n\n";
    }
}
if ($target eq "javabc"){
    if (scalar @dotnetonly){
        print "  Not tested for JVM:\n";
        print "  ===================\n";
        print "    " . join "\n    ", @dotnetonly;
        print "\n\n";
    }
}

if (scalar %manually){
    print "  The following must be tested manually:\n";
    print "  ========================================================\n";
    foreach $key (keys(%manually)){
        print "    $key:\n\t" . $manually{$key};
        print "\n";
    }
    print "\n";
}

if (scalar %known_failures){
    print "  Known to fail, not yet part of above test suite (FIXME!):\n";
    print "  ========================================================\n";
    foreach $key (keys(%known_failures)){
        print "    $key:\n\t" . $known_failures{$key};
        print "\n";
    }
}

sub CleanUp()
{

}

sub IntHandler 
{
   print "User interrupt. Exitting.\n";
   exit(1);
}
