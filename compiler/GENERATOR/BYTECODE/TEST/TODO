
BETA Bytecode TODO
==================

A. General
==========

1. Problem med overskrivning af program.il/program.J for hvert
   program.
    -> Muligvis lave subdirectory til denne navngivet udfra exefilen

2. Dependency analyse for .il/.J/.dll/.class filer


B. Java specific
================

1. Generere .class filer direkte (udenom jasmin)


C. .NET specific
================

1. [OLM/PA]
   Jeg måtte udkommentere en række af de basale patterns i tstenv, da
   der genereres ikke-verificerbart kode fir disse. Primært fordi der
   er void funktioner, der efterlader noget på stakken. Det er
   f.eks. state, cstruct, der har problemet. Ikke nogen showstopper,
   da disse ikke kaldes.
   Detaljer (verificeret statig tilstede 31/5)

   ------------------------------------------------------------------------------------
   CStruct::.ctor] [offset 0x0000000D] [opcode callvirt] Stack empty:
   
     .method public rtspecialname specialname hidebysig instance void .ctor(class ['tstenv']'tstenv')
     {
	   ldarg.0
	   call    instance void [mscorlib]System.Object::.ctor()
   
	   ldarg.0
	   ldarg.1
	   stfld   class ['tstenv']'tstenv' class ['tstenv']'CStruct'::origin
	   callvirt instance int32 class ['tstenv']'CStruct'::'byteSize'(int32)
	   ldarg.0
	   newarr int32
	   stfld   int32[] 'CStruct'::F12
	   ret
     }
   
   ------------------------------------------------------------------------------------
   CStruct_Byte::exit] [offset 0x00000000] [opcode dup] Stack underflow:
   
     .method public virtual int32 'exit'() cil managed
     {
	   .maxstack 8
	   dup
	   ldstr "FIXME: IL has no dup_x1/dup_x2 instructions"    <--------
	   call void [mscorlib]System.Console::WriteLine(string)
	   ret
     }
   
   Skulle åbenbart have været dup_x1, men det ville jo også give stack
   underflow
   
   ------------------------------------------------------------------------------------
   Samme er i Cstruct_long.


 
2. [OLM]
   Main() placering delvist fikset, men:
   Jo, det er jo sådan at foo.bet bliver til foo.il og program.il, det
   sidste fordi PROGRAM er et slot.
   Det jeg foreslår er at main() ligger i foo.il, og ikke som nu i
   program.il.
 
3. [OLM]
   FIXED!

4. [OLM]
   GENERATOR/BYTECODE/TEST/multiple fejler
     -> bruger dup_x1/dup_x2

5. [OLM]
   FIXED!

6. [OLM]
   Ved oversættelse af TST/btst crasher compiler under kodegenerering af
   tstvirt2.
   Sker både med nbeta og jbeta på pc men ikke med nogen af dem på sun
     -> Muligvis et problem med fil-stier

7. [OLM]
   Manglende imports
   Ved oversættelse af btst i TST (med tstvirt2 udkommenteret) fås en
   række manglende imports: De er gennemgået nedenfor.
   BEMÆRK: For at kunne komme videre hardkoder jeg pt import af alle
   disse i alle genererede filer - disse er mærket "hardcoded".

     assembling ~beta/compiler/TST/dotnet/slot_fill.il
     C:\beta\r5.3\compiler\TST\dotnet\slot_fill.IL(42) : error -- Undefined assembly ref 'tstenv'
     (4 mere af samme)
        -> led efter "['tstenv']" i slot_fill.il. tstenv refereres som
           location men importeres ikke

     assembling ~beta/compiler/TST/dotnet/program.il
     C:\beta\r5.3\compiler\TST\dotnet\program.IL(74) : error -- Undefined assembly ref 'tstarith'
     C:\beta\r5.3\compiler\TST\dotnet\program.IL(90) : error -- Undefined assembly ref 'tstrelop'
     C:\beta\r5.3\compiler\TST\dotnet\program.IL(106) : error -- Undefined assembly ref 'tstbool'
     C:\beta\r5.3\compiler\TST\dotnet\program.IL(122) : error -- Undefined assembly ref 'tstblock'
     C:\beta\r5.3\compiler\TST\dotnet\program.IL(138) : error -- Undefined assembly ref 'tstvirt'
        -> manglende import af filer der er INCLUDE'ed?

     assembling ~beta/compiler/TST/dotnet/tstvirt.il
     C:\beta\r5.3\compiler\TST\dotnet\tstvirt.IL(114) : error -- Undefined assembly ref 'tstlib'
        -> igen: manglende import af filer der er INCLUDE'ed?

     assembling ~beta/compiler/TST/dotnet/tstarith.il
     C:\beta\r5.3\compiler\TST\dotnet\tstarith.IL(115) : error -- Undefined assembly ref 'tstlib'
     (10 mere af slagsen)
        -> igen: manglende import af filer der er INCLUDE'ed?

     assembling ~beta/compiler/TST/dotnet/tstenv.il
     C:\beta\r5.3\compiler\TST\dotnet\tstenv.IL(1569) : error -- Undefined assembly ref 'isPlatform'
        -> Minder om "en klasse for meget" problemet vi hvade med put:

   	   /********************************************/
   	   /*        Class isPlatform                  */
   	   /********************************************/
   	   .class public auto ansi 'isPlatform' extends [mscorlib]System.Object{
   	     .field public class ['tstenv']'tstenv' origin
   	     .field public class ['tstenv']'text' 'MT'
   	     .field public int32 'b'
   	     ...
   	     .method public virtual void 'slot_isPlatform'() cil managed 
   	     {
 		   .maxstack 8
 		   ldarg.0
   	   
 		   newobj	instance void class ['slot_isPlatform']'slot_isPlatform'::.ctor(class ['isPlatform']'isPlatform')
 		   callvirt instance void class ['slot_isPlatform']'slot_isPlatform'::'do'()
 		   ret
   	     }
   	   }       


     assembling ~beta/compiler/TST/dotnet/tstlib.il
     C:\beta\r5.3\compiler\TST\dotnet\tstlib.IL(119) : error -- Undefined assembly ref 'chk'
     C:\beta\r5.3\compiler\TST\dotnet\tstlib.IL(435) : error -- Undefined assembly ref 'fill'
     C:\beta\r5.3\compiler\TST\dotnet\tstlib.IL(528) : error -- Undefined assembly ref 'exe'
        -> samme som isPlatform problemet?


8. [PA]
   All source files constituting an executable must currently reside
   in the same directory.
   We intent to generate strong assemblies and config files and/or use
   the Global Assembly Cache for solving this later.

9. [OLM]
   Vi skal kunne specificere fil location for en externalclass, og
   denne fil location skal med ind i import listen.
   Senere: Compiler skal kunne læse .Net assemblies direkte, så man ikke
   behøver at skulle erklære eksterne klasser og procedurer [PA]

10.[OLM/PA]
   Der er et problem som jeg kun ser ved oversættelse af
   TST/tstlibbody:
   Ved generering af slot_exe.il fås pludselig en pushVal med et
   offset som er 8 lige inden kaldet
     callvirt instance void slot_exe::do_2()
   i slot_exe::do_1(). Field name er "this".
   Dette resulterer i en "ldloc.-1" instruktion, som er ulovlig.
   jbeta genererer en "iload_0" her(!)
   Detaljer:

       Bind fragments in: 'tstlibbody'Code generation
       *** Address.get: strange offset: 8. Field name: this
       
       ***** FIXME: Negative location/argument number
       mem:8
       noOfArguments:0
       
       Negative memory offset
       
       Call chain: (nti_ms)
       
	 item <stop#> in ~beta/basiclib/betaenv
	 item <emitMemOp#> in ~beta/compiler/GENERATOR/BYTECODE/BCdotnetBody
	 item <load#> in ~beta/compiler/GENERATOR/BYTECODE/BCdotnetBody
	 item <EMITDOTNET-~> in ~beta/compiler/GENERATOR/BYTECODE/BCdotnetBody
	 item <mkAsmFile#> in ~beta/compiler/GENERATOR/BYTECODE/bytecodebackendbody
	 item <*> in ~beta/compiler/GENERATOR/BYTECODE/bytecodebackend
	 item <close#>close# in ~beta/compiler/GENERATOR/BYTECODE/bytecodebackend
	 item close#<close#> in ~beta/compiler/GENERATOR/machine
	 item <*> in ~beta/compiler/SYNTHESIZER/synthesizer
	 item <SYNTHESIZER-~> in ~beta/compiler/SYNTHESIZER/synthesizer
	 item <Synthesizer#> in ~beta/compiler/CONTROL/system
	 item <DoTheCodeGen#> in ~beta/compiler/CONTROL/translate_controlbody
	 item <*> in ~beta/compiler/CONTROL/translate_controlbody
	 item <Translate#>translate# in ~beta/compiler/CONTROL/transDepGraph
	 item Translate#<translate#> in ~beta/dependency/scanNonCompiled
	 item <translate#>Translate# in ~beta/dependency/private/scanNonCompiledBody
	 item translate#<Translate#> in ~beta/dependency/private/dependencyBody
	 item <*>ScanAndClear# in ~beta/dependency/private/controlbody
	 item *<ScanAndClear#> in ~beta/dependency/private/dependencyBody
	 item <CONTROLLERPRIVATE-~> in ~beta/dependency/private/dependencyBody
	 item *<controller#> in ~beta/dependency/private/dependencyBody
	 item handleFragments#<ScanNonCompiled#>scanner# in ~beta/dependency/scanNonCom
       piled
	 item handleFragments#ScanNonCompiled#<scanner#> in ~beta/dependency/dependency
       
	 item <*> in ~beta/compiler/CONTROL/systembody_translatedobody
	 item <doTranslate#> in ~beta/compiler/CONTROL/system
	 item <SYSTEMTRANSLATEBODY-~> in ~beta/compiler/CONTROL/systembody
	 item *translateWithErrorHandling#<translate#> in ~beta/compiler/CONTROL/system
       
	 item <ActivateCompiler#> in ~beta/compiler/compiler
	 item <*> in ~beta/compiler/compiler
	 item <InteractiveCompiler#> in ~beta/compiler/compiler
	 comp <PROGRAM-~>SystemEnv#SysHead# in ~beta/compiler/nbeta
	 comp PROGRAM-~<SystemEnv#>SysHead# in ~beta/basiclib/basicsystemenv
	 comp PROGRAM-~SystemEnv#<SysHead#> in ~beta/basiclib/basicsystemenv
       
	 item <attNext#>realValue# in ~beta/basiclib/private/basicsystemenvbody
	 item attNext#<realValue#> in ~beta/basiclib/betaenv
	 item <*>cycle# in ~beta/basiclib/private/systemenv_ntbody
	 item *<cycle#> in ~beta/basiclib/betaenv
	 comp <BASICSCHEDULER-~> in ~beta/basiclib/private/systemenv_ntbody
       
	 basic component in ~beta/basiclib/betaenv
       
       assembling ~beta/compiler/TST/dotnet/slot_exe.il
       C:\beta\r5.3\compiler\TST\dotnet\slot_exe.IL(92) : error : syntax error at token
	'ldloc' in:    ldloc.-1
