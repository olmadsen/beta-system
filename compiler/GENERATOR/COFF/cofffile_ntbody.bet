ORIGIN 'cofffile';
INCLUDE '~beta/basiclib/private/binfile_ntibody';
INCLUDE 'coff_ms';
--LIB:attributes--
debugcoff: (# exit false #);
puthexa: 
  (# i: @integer;
     printf: external
       (# fmt: [0]@char;
          val: @integer;
       enter (fmt,val)
       #);
  enter i
  do ('0x%x', i) -> printf; 10 -> screen.put;
  #);

-- CoffFilePutFileHdr: dopart --
do (if debugcoff then
       '\nFile: '->screen.puttext; THIS(File).entry.path -> screen.putline;
       'File Header at file address ' -> screen.puttext; getpos->puthexa;
       '\tf_magic: ' -> screen.puttext; f.f_magic->puthexa; 
       '\tf_nscns: ' -> screen.puttext; f.f_nscns->puthexa; 
       '\tf_timdat: ' -> screen.puttext; f.f_timdat->puthexa; 
       '\tf_symptr: ' -> screen.puttext; f.f_symptr->puthexa; 
       '\tf_nsyms: ' -> screen.puttext; f.f_nsyms->puthexa; 
       '\tf_opthdr: ' -> screen.puttext; f.f_opthdr->puthexa; 
       '\tf_flags: ' -> screen.puttext; f.f_flags->puthexa; 
   if);
   (if ((@@f.f_magic, 1, FILHSZ, private.ntStream)
         -> fwrite) <> FILHSZ then
       WriteError;
   if)
-- CoffFileAoutHdr: dopart --
do (if ((@@a.magic, 1, AOUTSZ, private.ntStream)
         -> fwrite) <> AOUTSZ then
       WriteError;
   if)
-- CoffFilePutScnHdr: dopart --
do (if debugcoff then
       'Section Header at file address ' -> screen.puttext; getpos->puthexa;
       '\ts_name1_4: '->screen.puttext; s.s_name1_4->puthexa; 
       '\ts_name5_8: '->screen.puttext; s.s_name5_8->puthexa; 
       '\ts_paddr: '->screen.puttext; s.s_paddr->puthexa; 
       '\ts_vaddr: '->screen.puttext; s.s_vaddr->puthexa; 
       '\ts_size: '->screen.puttext; s.s_size->puthexa; 
       '\ts_scnptr: '->screen.puttext; s.s_scnptr->puthexa; 
       '\ts_relptr: '->screen.puttext; s.s_relptr->puthexa; 
       '\ts_lnnoptr: '->screen.puttext; s.s_lnnoptr->puthexa; 
       '\ts_nreloc: '->screen.puttext; s.s_nreloc->puthexa; 
       '\ts_nlnno: '->screen.puttext; s.s_nlnno->puthexa; 
       '\ts_flags: '->screen.puttext; s.s_flags->puthexa; 
   if);
   (if ((@@s.s_name1_4, 1, SCNHSZ, private.ntStream)
         -> fwrite) <> SCNHSZ then
       WriteError;
   if);
-- CoffFilePutReloc: dopart --
do (if debugcoff then
       'Reloc at file address ' -> screen.puttext; getpos->puthexa;
       '\tr_vaddr: '->screen.puttext; r.r_vaddr->puthexa; 
       '\tr_symndx: '->screen.puttext; r.r_symndx->puthexa; 
       '\tr_type: '->screen.puttext; r.r_type->puthexa; 
   if);
   (if ((@@r.r_vaddr, 1, RELSZ, private.ntStream)
         -> fwrite) <> RELSZ then
       WriteError;
   if)
-- CoffFilePutLineno: dopart --
do (if ((@@l.l_symndx, 1, LINESZ, private.ntStream)
         -> fwrite) <> LINESZ then
       WriteError;
   if)
-- CoffFilePutSyment: dopart --
do (if debugcoff then
       'Syment at file address ' -> screen.puttext; getpos->puthexa;
       '\tn_name1_4: '->screen.puttext; s.n_name1_4->puthexa; 
       '\tn_name5_8: '->screen.puttext; s.n_name5_8->puthexa; 
       '\tn_value: '->screen.puttext; s.n_value->puthexa; 
       '\tn_scnum: '->screen.puttext; s.n_scnum->puthexa; 
       '\tn_type: '->screen.puttext; s.n_type->puthexa; 
       '\tn_sclass: '->screen.puttext; s.n_sclass->puthexa; 
       '\tn_numaux: '->screen.puttext; s.n_numaux->puthexa; 
   if);
   (if ((@@s.n_name1_4, 1, SYMESZ, private.ntStream)
         -> fwrite) <> SYMESZ then
       WriteError;
   if)
-- CoffFilePutAuxent: dopart --
do (if debugcoff then
       (# aux: ^IMAGE_AUX_SYMBOL_SECTION;
       do 'Auxent at file address ' -> screen.puttext; getpos->puthexa;
          a[] -> aux[];
          '\tLength: '->screen.puttext; aux.Length->puthexa;
          '\tNumberOfRelocations: '->screen.puttext; aux.NumberOfRelocations->puthexa;
          '\tNumberOfLinenumbers: '->screen.puttext; aux.NumberOfLinenumbers->puthexa;
          '\tCheckSum: '->screen.puttext; aux.CheckSum->puthexa;
          '\tNumber: '->screen.puttext; aux.Number->puthexa;
          '\tSelection: '->screen.puttext; aux.Selection->puthexa;
       #);
   if);
   (if ((@@a.R[1], 1, AUXESZ, private.ntStream)
         -> fwrite) <> AUXESZ then
       WriteError;
   if)
