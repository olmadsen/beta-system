ORIGIN '~beta/basiclib/external';

(* coff.bet:
 *   Patterns for minipulating COFF objects.
 *   Describes the machine independent COFF definitions, as
 *   described in "Gintaras R. Gircys: Understanding and Using COFF, 
 *   O'Reilly & Associates, Inc., 1988".
 * 
 *   $Id: coff.bet,v 1.2 2001-11-22 13:05:24 corry Exp $
 *)


--LIB: attributes--

SYMNMLEN:	(# exit 8 #);
FILNMLEN:	(# exit 14 #);
DIMNUM:	(# exit 4 #);

filehdr:
  (# 
     f_magic: @int16u;   (* magic number *)
     f_nscns: @int16u;   (* number of sections *)
     f_timdat: @integer;  (* time and date stamp *)
     f_symptr: @integer;  (* file ptr to symtab *)
     f_nsyms: @integer;   (* # symtab entries *)
     f_opthdr: @int16u;  (* sizeof(opt hdr) *)
     f_flags: @int16u;   (* flags *)
  #);

FILHSZ:	(# exit 20 #);

aouthdr:
  (# 
     magic: @int16u;             (* magic number *)
     vstamp: @int16u;            (* version stamp *)
     tsize: @integer;             (* text size in bytes, padded *)
     dsize: @integer;             (* initialized data (.data) *)
     bsize: @integer;             (* uninitialized data (.bss) *)
     entry: @integer;             (* entry point *)
     text_start: @integer;        (* base of text used for this file *)
     data_start: @integer;        (* base of data used for this file *)
  #);


AOUTSZ: (# exit 28 #);
AOUTHDRSZ: (# exit AOUTSZ #);

scnhdr:
  (# 
     s_name1_4: @integer; (* section name *)
     s_name5_8: @integer;
     s_paddr: @integer;    (* physical address *)
     s_vaddr: @integer;    (* virtual address *)
     s_size: @integer;     (* section size *)
     s_scnptr: @integer;   (* file ptr to raw data *)
     s_relptr: @integer;   (* file ptr to relocation *)
     s_lnnoptr: @integer;  (* file ptr to line numbers *)
     s_nreloc: @int16u;   (* # reloc entries *)
     s_nlnno: @int16u;    (* # line number entries *)
     s_flags: @integer;    (* flags *)
  #);


SCNHSZ:	(# exit 40 #); 

reloc:
  (# 
     r_vaddr: @integer;   (* (virtual) address of reference *)
     r_symndx: @integer;  (* index into symbol table *)
     r_type: @int16u;    (* relocation type *)
  #);

RELSZ:	(# exit 10 #); 


lineno: 
  (# 
     l_symndx: @integer;
     l_paddr: (# enter l_symndx exit l_symndx #);
     l_lnno: @int16u;
  #);

LINESZ:	(# exit 6 #); 

syment:
  (# 
     n_name1_4: @integer; (* symbol name or 0L if in string table *)
     n_name5_8: @integer; (* location in string table if so (otherwise
                           * last four bytes of name
                           *)
     n_value: @integer;      (* value of symbol *)
     n_scnum: @int16u;      (* section number *)
     n_type: @int16u;       (* type and derived type *)
     n_sclass: @char;     (* storage class *)
     n_numaux: @char;     (* number of aux entries *)
  #);

SYMESZ:	(# exit 18 #);

T_NULL:	(# exit 0 #);
T_VOID:	(# exit 1 #);
T_CHAR:	(# exit 2 #);
T_SHORT:	(# exit 3 #);
T_INT:	(# exit 4 #);
T_LONG:	(# exit 5 #);
T_FLOAT:	(# exit 6 #);
T_DOUBLE:	(# exit 7 #);
T_STRUCT:	(# exit 8 #);
T_UNION:	(# exit 9 #);
T_ENUM:	(# exit 10 #);
T_MOE:	(# exit 11 #);
T_UCHAR:	(# exit 12 #);
T_USHORT:	(# exit 13 #);
T_UINT:	(# exit 14 #);
T_ULONG:	(# exit 15 #);

auxent: cstruct
  (# bytesize::(# do AUXESZ->value #);
  #);
AUXESZ:	(# exit 18 #); (* sizeof(AUXENT) *)

C_EFCN: (# exit -1 #);    (* physical end of function *)
C_NULL:	(# exit 0 #);
C_AUTO:	(# exit 1 #);       (* automatic variable *)
C_EXT:	(# exit 2 #);       (* external symbol *)
C_STAT:	(# exit 3 #);       (* static *)
C_REG:	(# exit 4 #);       (* register variable *)
C_EXTDEF:	(# exit 5 #);       (* external definition *)
C_LABEL:	(# exit 6 #);       (* label *)
C_ULABEL:	(# exit 7 #);       (* undefined label *)
C_MOS:	(# exit 8 #);       (* member of structure *)
C_ARG:	(# exit 9 #);       (* function argument *)
C_STRTAG:	(# exit 10 #);      (* structure tag *)
C_MOU:	(# exit 11 #);      (* member of union *)
C_UNTAG:	(# exit 12 #);      (* union tag *)
C_TPDEF:	(# exit 13 #);      (* type definition *)
C_USTATIC:	(# exit 14 #);      (* undefined static *)
C_ENTAG:	(# exit 15 #);      (* enumeration tag *)
C_MOE:	(# exit 16 #);      (* member of enumeration *)
C_REGPARM:	(# exit 17 #);      (* register parameter *)
C_FIELD:	(# exit 18 #);      (* bit field *)
C_BLOCK:	(# exit 100 #);     (* ".bb" or ".eb" *)
C_FCN:	(# exit 101 #);     (* ".bf" or ".ef" *)
C_EOS:	(# exit 102 #);     (* end of structure *)
C_FILE:	(# exit 103 #);     (* file name *)

DT_NON:	(# exit 0 #);       (* no derived type *)
DT_PTR:	(# exit 1 #);       (* pointer *)
DT_FCN:	(# exit 2 #);       (* function *)
DT_ARY:	(# exit 3 #);       (* array *)

N_BTMASK:	(# exit 017 #);
N_TMASK:	(# exit 060 #);
N_TMASK1:	(# exit 0300 #);
N_TMASK2:	(# exit 0360 #);
N_BTSHFT:	(# exit 4 #);
N_TSHIFT:	(# exit 2 #);

(* Macros *)

ISPTR:
  (* Is  x  a  pointer ? *)
  (# x: @integer; 
  enter x
  exit ((x %Band N_TMASK) = (DT_PTR %sll N_BTSHFT)) 
  #);

ISFCN:
  (* Is  x  a  function ? *)
  (# x: @integer; 
  enter x
  exit ((x %Band N_TMASK) = (DT_FCN %sll N_BTSHFT)) 
  #);

ISARY:
  (*  Is  x  an  array ? *)
  (# x: @integer; 
  enter x
  exit ((x %Band  N_TMASK) = (DT_ARY %sll N_BTSHFT))
  #);

ISTAG:
  (* Is x a structure, union, or enumeration TAG? *)
  (# x: @integer;  
  enter x
  exit ((x = C_STRTAG) or (x = C_UNTAG) or (x = C_ENTAG))
  #);
