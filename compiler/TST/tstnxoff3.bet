ORIGIN 'tstenv';  
INCLUDE 'tstlib' 
---lib:attributes---
tstnxoff3:
  (# extern: 
       (# giveArg:  External(# a,b,c,d:@char enter (a,b,c) exit d #);
          giveMe2Argument: giveArg(##);  
          A1: (# do exit '!' -> F #);
          A2: (# do exit 'a' -> F #);
          A3: (# do exit '?' -> F #);
          F: (# ch: @char enter ch exit ch #) 
       do (if safeMode and isNEWRUN then
              'a' -> put;
           else
              (* fails with unconditional GC *)
              (A1,A2,A3) -> giveMe2Argument -> put;
          if);
       #); 
     deepNX:
       (# G: (# ch: @char enter ch do #);
          diskEntry:
            (# path: @pathDesc;
               pathDesc:<
                 (# set:< (# ch: @char enter ch do ch -> put; ch+1 -> cname #);
                    get:< (# ch: @char do cname -> ch exit ch #) 
                 enter set
                 exit get
                 #);
               exists: (# b: @boolean; error:< object do exit b #);
               cname: @char 
            #);
          file:  
            (# name: @ (# enter entry.path exit entry.path #);
               entry: @ entryDesc; 
               entryDesc:< diskEntry;    
            #);   
          GG: (# y: @G; b: @boolean enter G exit b #);
          fileExists: 
            (# f: @file
            enter f.name
            exit f.entry.exists(# error:: (# do #) #)
            #);           
       do (# s: @file; b: @boolean  
          do 'b' -> s.name; 
             (# x: @char
             do (S.name -> fileExists) AND (S.name -> fileExists)  -> b
          #)#)
       #);
     inNXlist:
       (* this is why inNXlist was added to chkEval *)
       (# preference: (# do inner #); 
          compilerPreferences: (# betarun:getcmdArgs(# #) #);
          get: 
            (# type:< preference; 
               value: @type; 
            do inner
            exit value
            #);
          cmdArgs: preference
            (# scan: (# ch: @char do 'd'->ch; inner #);
            exit this(cmdArgs)[]
            #);
          getCmdArgs: get(# type::< cmdArgs do INNER #);
          compilerPrefs: @compilerpreferences;
       do (if isBytecodeMode then
              '#' -> puttext
           else
              (compilerPrefs.betarun).scan(#  do ch -> put #)
          if)
       #)
       
  do (if isByteCodeMode then '#' -> put else extern;   (* 'a' *)if);
     deepNX;   (* 'bc' *)
     inNXlist; (* 'd' *)
     'e' -> fill
  #)

  


