ORIGIN 'tstenv' ;
INCLUDE 'tstlib'
---lib:attributes---
TstRefRepLarge:
  (* Allocate a few large refreps, force them to aoa.
   * Then make them all pointto the same object in ioa to
   * stress AOAtoIOAtable and ioagc.
   *)
  (# reflen: (# exit 200*1000 #);
     RRtype: 
       (# R1: [0]^Object;
          init: @
            (# 
            do reflen->R1.new;
               (for i:reflen repeat
                        &IntegerObject[]->R1[i][]
               for);
            #);
          racheck: @
            (# o:^Object;
            enter o[]
            do (for i:reflen repeat
                    o[]->R1[i][]
               for);
            #);
       #);
     RR: [10]@RRtype;
     R2: @RRtype;
     
     o: ^Object;
  do 'Building arrays'->putText;
     (for i: RR.range repeat
          '.'->put;
          RR[i].init;
     for);       
     &IntegerObject[]->o[];
     '\nSetting to point to IOA'->putText;
     (for i: RR.range repeat
          '.'->put;
          o[]->RR[i].racheck;
     for);   
     '\nNow force a few GCs'->putLine;
     R2.init;
  #);
--PROGRAM: descriptor--
(# 
do &TstRefRepLarge;
#)
