ORIGIN 'basicsystemenv';

--basicSystemEnvFork:doPart--
do 'Fork('->puttext;
   (%getLongAt @@S) -> attToThread -> my_tid;
   ')'->put
   
   
--SemaphoreP:dopart--
do private.P
--SemaphoreV:dopart--
do private.V
   
-- SemaphorePrivate:descriptor --
(# strace: (#exit false #);
   mutex: @Integer;
   cnt: @Integer;
   P: (# 
      do L:
           (#
           do mutex.%lock;
              (if (cnt < 1) then
                  (if strace then 'P'->put; cnt -> putint;  if);
                  mutex.%unlock;             
                  Wait;
                  restart L
               else
                  (if strace then 'p'->put if);
                  cnt-1->cnt;
                  mutex.%unlock;
           if)#)
      #);
   V: (# 
      do 
         mutex.%lock;
         (if (cnt < 0) then
             (if strace then 'V'->put; cnt->putint  if);
             cnt+1->cnt;
             mutex.%unlock;
          else
             (if strace then 'v'->put if);
             cnt+1->cnt;
             mutex.%unlock;

         if)
      #);
#)
  

