ORIGIN 'tstenv';          
BUILD  ppcmac	':$$:ctstcproc.obj' 'ctstcproc.c'  'mrc -w 35 -o $0 $1'
       nti      '$$/ctstcproc.obj' 'ctstcproc.c'  'betacc $0 $1'
       default	'$$/ctstcproc.o'   'ctstcproc.c'  '\$CC -c -o $0 $1'
-----LIB:attributes-----
makeCBF: External
  (* Call this external to install a callback and get
   * an int32 pointer to it.
   *)
  (# pat: ##External;
     cb: @int32;
  enter pat##
  exit cb
  #);

freeCBF: External
  (* Call this external with an int32 pointer to an installed
   * callback (obtained via MakeCBF) when it is certain that the
   * callback will NOT be called again.
   * This will free BETA heap space associated with the callback.
   *)
  (# cbf: @int32;
  enter cbf
  #);


doCallBack: External
  (# F: ##foo; ch: @ char 
  enter F## do 'doCallBack'->callC exit ch 
  #);
doCallBackInt: External
  (# F: @Integer; ch: @ char 
  enter F do 'doCallBack'->callC exit ch 
  #);
foo: External   
  (* Note that a :@ char does NOT work. The compiler generates mov.b
   * to pop a from C stack
   *)
  (# a,b:@ integer; T: [1] @ char; 
     x3,x4,x5,x6,x7,x8: @integer
  enter(a,T,x3,x4,x5,x6,x7,x8) 
  do cExternalEntry;
     a->put; T->puttext; x8->put;
     'p'->b
  exit b
  #);

-- program: Descriptor --
(# fooadr, fooadr2: @Integer;
   
do foo##-> makeCBF->fooadr;
   fooadr -> doCallBackInt;
   foo##-> makeCBF->fooadr2;
   fooadr->freeCBF;
   (for i: 100000 repeat 
        foo##-> makeCBF->fooadr;
        fooadr -> doCallBackInt;
        fooadr->freeCBF;
   for);
   fooadr2 -> doCallBackInt;
#)
