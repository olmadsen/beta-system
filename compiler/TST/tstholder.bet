ORIGIN 'tstenv';    
INCLUDE 'tstlib';
---lib:attributes---  
test: (#exit false #);
(* Using: 
 *    holder: (# adr: @integer #)     
 *)
intHolder: holder  
  (# value: @integer;
     isNone: (# exit value = 0 #);
     writeBack: (#do value %putLongAt adr #)
  enter value
  exit value         
  #);
refHolder: holder
  (# type:< object;
     ref: ^type;
     writeBack: (#do (%getLongAt (@@ref)) %putLongAt adr #) 
  enter ref[] 
  exit ref[]
  #); 
tstHolder:
  (# myClass: COM
       (# foo:<      
            (# n: @integer; S: ^intHolder;     
            enter(n,S[])    
            do (if test then
                   n -> putint; ' ' -> put; S -> putint; ' '->put;
               if);
               (if S = 111 then 'a' -> put else '!' -> put if);
               n + S -> S; 
               (if test then S -> putint; newline; if)
               (* S.writeBack;*)
            #);
          bar:<
            (# n: @integer; R: ^myClassHolder       
            enter(n,R[]) 
            do (if test then 'myClass::bar'->putline if);
               &myClass[] -> R; 
               n -> R.ref.kuk;
               (*R.writeBack*)
               (if test then 'myClass::bar:end'->putline if);
            #);    
          foo1:<  
            (# S: ^intHolder 
            enter S[] 
            do (if test then  S -> putInt; newline if);
               (if S = 444 then 'd' -> put else '!' -> put if);
               111 + S -> S; 
               (*S.writeBack *) 
            #);
          foo2:<
            (# n,a,b,c: @integer; S: ^myClassHolder
            enter(n,S[])
            do
               (n,S[]) -> foo3;
            #);
          foo3:<
            (# n: @integer; S: ^myClassHolder
            enter(n,S[])
            do &myClass[] -> S;
               n -> S.ref.kuk;
            #);
               
          kuk: @integer   
       #);  

   TTTT: COM  
     (# foo1:<
          (# S: ^intHolder 
          enter S[]
          do (*n -> putint; ','->put; S -> putint; newline;*)
             (if S.isNone then
                 'i' -> put 
              else
                 (if S = 1010 then 'h' -> put else '!' -> put if);
             if)
          #);
        foo2:<        
            (# S: ^intHolder; n: @integer
            enter (n,S[]  )
            do (if S.isNone then
                   'k'->put
                else
                   (if S = 101 then 'j' -> put else '!' -> put if);
               if)
            #);
     #);

     myClassHolder: refHolder(# type::myClass #);         
     R: @myClass;
     Q: @intHolder; 
     P: @myClassHolder 
  do 111->Q; 
     (if test then 'main 1:'->putline if);
     (11,Q[]) -> R.foo; 
     (if test then
         'main 2:'->putline;
         Q -> putint; newline;
     if);
     (if Q = 122 then 'b' -> put else '!' -> put if);
     (333,P[]) -> R.bar;   
     (if test then P.ref.kuk -> putint; newline; if);
     (if P.ref.kuk = 333 then 'c' -> put else '!' -> put if);
     444 -> Q; 
     Q[] -> R.foo1;
     (*Q -> putint; newline;   *)
     (if Q = 555 then 'e' -> put else '!' -> put if);
     (666,P[]) -> R.foo2;
     (if P.ref.kuk = 666 then 'f' -> put else '!' -> put if);
     (# x: @char; S: ^ myClassHolder
     do &myClassHolder[] -> S[];
        (# y: @char
        do (777,S[]) -> R.foo3;
           (if S.ref.kuk = 777 then 'g' -> put else '!' -> put if);
        #);
     #);
     (# R: @TTTT;
        X: @intHolder;
     do 1010 -> X;
        X[] -> R.foo1;
        none -> R.foo1;
        101 -> X;
        (5,X[]) -> R.foo2; 
        (6,none) -> r.foo2;
     #);

     'l' -> fill;
  #)
