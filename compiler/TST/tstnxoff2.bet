ORIGIN 'tstenv';
INCLUDE 'tstcproc'
---lib:attributes---
tstnxoff2:
  (# test16:
       (# A:
            (# n: @integer; s: ^B
            enter(n,s[])
            exit(n,s[])
            #);
          B: (# m: @integer#);
          newA:
            (# v: @integer; Q: @A; bb: ^B
            enter v
            do &B[] -> bb[]; v*v-> bb.m;
               (v,bb[]) -> Q
            exit Q
            #);
          foo:
            (# Q1,Q2,Q3,Q4,Q5: @A; i,j,k: @integer;
            enter(Q1,Q2,Q3,Q4,Q5,i,j,k)
            do 'a'-1 -> ch;
               Q1 -> check;
               Q4 -> check;
               Q5 -> check;
            #);
          ch: @integer;
          check:
            (# Q: @A
            enter Q
            do (if (Q.n*Q.n) = Q.s.m then
                   ch+1 -> ch -> put
                else '!'->put
               if)
            #);
          W1,W2,W3,W4,W5: @A ;
          bar:
            (# X: @A
            enter X  
            do 
            exit X 
            #);
          genDesc:
            (# bool: @boolean; s: ^text
            enter(W1,bool,s[]) 
            do W1->check  
            #);
          i,j,k: @integer;
          W: ^A;
       do 11 -> newA -> W1;
          22 -> newA -> W2;
          33 -> newA -> W3;
          44 -> newA -> W4;
          55 -> newA -> W5;
          (# x: @char
          do 'a' -> x; (W1,W2,W3,(W4->bar),w5->bar,i,j,k) -> foo       
          #);
          'd'-1->ch;
          (# yyy: @real
          do &A[] -> W[]; 
             66->newA -> W;
             W -> W2;
             W -> Check; (* 'a' *)
             (W,(k<>0),'qwerty') -> gendesc ; (* 'b' *)
          #)
       #);
     testExtText:
       (# ident: External(# r,s:[1]@char enter r  exit s #);  
          t: @text;
          foo: (# t: @text enter t do  t -> puttext; 'l'->t #);
          bar: (# X: @foo enter X do X.t -> puttext #)
       do
          'fg' -> ident -> t; t -> puttext;
          'hi' -> ident -> foo;
          'jk' -> ident -> bar;
       #);
     test17:
       (# stext: 
            (# T: [100]@char; top: @integer;
               setT: (# enter T do T.range -> top #)
            enter setT
            exit t[1:top]
            #);
          index: 
            (# a: @integer; f: ^ index;
               R: [12]@integer;
               son:
                 (#exit
                    (#exit (f.R[a+1]->tos'%getshort[1]'->tos'%shiftleft[1]',f[])#)
                 #);
               init: (#do &index[] -> f[]; 9->f.a; 0x00020002 -> f.R[a+1]#)
            enter(a,f[]) 
            exit(a,f[]) 
            #);
          extCall:
            (# xName: @stext; desc: ^index; extType: @integer;es: @index
            enter(xName,desc[],extType,es)
            do xName -> puttext;
               (if es.a = 4 then 'p' -> put if)
            #);
          desc,ev: ^index;
          kind: @integer;
          sematt: ^semattType;
          semattType: (# virtExt: (#exit 9 #)#)
       do (# CP: @extCall; callId: ^stext;
          do &stext[] -> callId[]; 'mno' -> CallId;
             &index[] -> ev[]; ev.init; &semattType[] -> sematt[];
             (callID,desc[],sematt.virtExt -> kind,ev.son) -> CP
          #)
       #)
  do test16;      (* 'abcde' *)
     testExtText; (* 'fgihijkl' *)
     test17;      (* 'mnop' *)
     'q' -> fill
  #)

