ORIGIN '../tstenv'; 
(* Test dump with external activation record on stack *)

BUILD  ppcmac	'::$$:ctstcproc.obj' '::ctstcproc.c'  'mrc -o $0 $1'
       nti      '..\nti\%SDK%\ctstcproc.obj' '..\ctstcproc.c'  'betacc $0 $1'
       default	'../$$/ctstcproc.o'   '../ctstcproc.c'  '\$CC -c -o $0 $1'
[[
-----program:descriptor-----
(#
   a: @|(# p: (# do inner #);
           pp: @p(# x:^object do suspend; x (* RefNoneErr: Reference is none *) #);
        do pp
        #);
   b: @|(# q: (# do inner #);
           qq: @q(# do a; a #);
        do qq
        #);
   doCallBack: External(# F: ##foo; ch: @ char enter F## do callC exit ch #);
   foo: External
     (* Note that a :@ char does NOT work. The compiler generates mov.b
      * to pop a from C stack
      *)
     (# i,j:@ integer; T: [1] @ char;
        x3,x4,x5,x6,x7,x8: @integer;
        r: [1]@char;;
     enter(i,T,x3,x4,x5,x6,x7,x8)
     do cExternalEntry;
        'Call Back. Now force "reference is NONE"' -> putline;
        b;
     #);
do
   foo##->doCallBack; 
   (* call back from C of ('l','mn','!','!','!','!','!','o')->foo;*)    
#)
---]]

(* stack layout at dump time:
 * 
 *   |    main            |
 *   |____________________|       
 *   |                    |
 *   |    M1BETAENV       |       basic component
 *   |____________________|
 *   |                    |
 *   |    M1PROGRAM       |       <PROGRAM-~>
 *   |____________________| ____
 *   |                    |     |
 *   |    doCallBack      |     |
 *   |____________________|     | External Activation Record
 *   |                    |     |
 *   |    foo             |     |
 *   |____________________|_____|
 *   |                    |
 *   |    M9PROGRAM       |       foo#
 *   |____________________|
 *   |                    |
 *   |    Att             |
 *   |____________________|
 *   |                    |
 *   |    M4PROGRAM       |       b#
 *   |____________________|
 *   |                    |
 *   |    M6PROGRAM       |       q#
 *   |____________________|
 *   |                    |
 *   |    M7PROGRAM       |       qq#
 *   |____________________|
 *   |                    |
 *   |    Att             |
 *   |____________________|
 *   |                    |
 *   |    M2PROGRAM       |       a#
 *   |____________________|
 *   |                    |
 *   |    M3PROGRAM       |       p#
 *   |____________________|
 *   |                    |
 *   |    M4PROGRAM       |       pp#
 *   |____________________|
 * 
 *)

(* Correct dump:
 
  item <pp#>p# in ~beta/betarun/v2.8/sgi/TST/tstdump/tstdump10
    -- a# in ~beta/betarun/v2.8/sgi/TST/tstdump/tstdump10
  item pp#<p#> in ~beta/betarun/v2.8/sgi/TST/tstdump/tstdump10
    -- a# in ~beta/betarun/v2.8/sgi/TST/tstdump/tstdump10
  comp <a#> in ~beta/betarun/v2.8/sgi/TST/tstdump/tstdump10
    -- PROGRAM-~ in ~beta/betarun/v2.8/sgi/TST/tstdump/tstdump10

  item <qq#>q# in ~beta/betarun/v2.8/sgi/TST/tstdump/tstdump10
    -- b# in ~beta/betarun/v2.8/sgi/TST/tstdump/tstdump10
  item qq#<q#> in ~beta/betarun/v2.8/sgi/TST/tstdump/tstdump10
    -- b# in ~beta/betarun/v2.8/sgi/TST/tstdump/tstdump10
  comp <b#> in ~beta/betarun/v2.8/sgi/TST/tstdump/tstdump10
    -- PROGRAM-~ in ~beta/betarun/v2.8/sgi/TST/tstdump/tstdump10

  item <foo#> in ~beta/betarun/v2.8/sgi/TST/tstdump/tstdump10
    -- PROGRAM-~ in ~beta/betarun/v2.8/sgi/TST/tstdump/tstdump10
  [ EXTERNAL ACTIVATION PART ]
  item <PROGRAM-~> in ~beta/betarun/v2.8/sgi/TST/tstdump/tstdump10
    -- BETAENV-~ in ~beta/betarun/v2.8/sgi/TST/tstenv
  basic component in ~beta/betarun/v2.8/sgi/TST/tstenv
 
 *)
