ORIGIN '../tstenv';

--- program: descriptor ---
(# factorial: @|
     (# next:
          (# n, thisF: @integer;
          enter n
          do n*F -> F -> thisF; i+1->i;
             SUSPEND;
             (if i=n//true then n+1->&next if);
             (if true
              // i>n then thisF->F; (for j:i-n repeat factorial for);
                 (*                                   ^^^^^^^^^    *)
                 (* RecursiveAttachErr: 
                  *   Attempt to attach component that is already attached
                  *)
             if);
          #);
        F, i: @integer
     enter i
     do 1->F->&next
     exit F
     #);
   puti: (# i: @integer; enter i do i -> putint; newline; #);
do factorial->puti;
   6->factorial->puti;
#)

(* stack layout at dump time:
 * 
 *   |    main            |
 *   |____________________|       
 *   |                    |
 *   |    M1BETAENV       |       basic component
 *   |____________________|
 *   |                    |
 *   |    M1PROGRAM       |       <PROGRAM-~>
 *   |____________________| 
 *   |                    |
 *   |    Att             |
 *   |____________________|
 *   |                    |
 *   |    M2PROGRAM       |       factorial#
 *   |____________________|
 *   |                    |
 *   |    M3PROGRAM       |       next#
 *   |____________________|
 *   |                    |
 *   |    Att             |
 *   |____________________|
 * 
 *)

(* Correct dump:
 
  item <next#> in ~beta/betarun/v2.8/sgi/TST/tstdump/tstdump11
    -- factorial# in ~beta/betarun/v2.8/sgi/TST/tstdump/tstdump11
  comp <factorial#> in ~beta/betarun/v2.8/sgi/TST/tstdump/tstdump11
    -- PROGRAM-~ in ~beta/betarun/v2.8/sgi/TST/tstdump/tstdump11

  item <PROGRAM-~> in ~beta/betarun/v2.8/sgi/TST/tstdump/tstdump11
    -- BETAENV-~ in ~beta/betarun/v2.8/sgi/TST/tstenv
  basic component in ~beta/betarun/v2.8/sgi/TST/tstenv
 
 *)
