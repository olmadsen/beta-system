ORIGIN '~beta/guienv/guienv';
INCLUDE 'iautomationdemo';
INCLUDE '~beta/comlib/comlib';
INCLUDE '~beta/comlib/OAIdl'
        '~beta/comlib/Unknwn'
        '~beta/comlib/comtypes';
BUILD nti     '$$/copyRef.obj'  'copyRef.c' 'betacc $0 $1'
--PROGRAM: descriptor--
guienv
(# CLSID_simpleserver: ^CLSID;
   IID_UNKNW,SimpleServer_IID: @IID;
   pIUnknown: ^IUnknown;
   pISimpleServer: ^simpleDispatchServer;
   clsstr: @BSTR;
   str: @BSTR;
   hr: @HRESULT; 
   bh: @BSTRHolder;
   ih: @int16Holder;
   
   copyRef: external (# source,dest: @int32 enter(source,dest) #);
   Query: 
     (* More user-friendly version of QueryInterface than the 
     * autogenerated one in Unknwn.bet.
     *)
    (# theIID: ^IID;  
       theUnknown: ^IUnknown;
	   Iptr: ^Idispatch;
       hr: @HRESULT;  
     
    enter (theUnknown[], theIID[])
    do (* <<SLOT IUnknownQuery: descriptor>>*)
  
	   (# ih: @IUnknownHolder;
       do (if ((theIID.binary[], ih[]) -> theUnknown.QueryInterface -> hr).failed then
              ('IUnknownQuery failed', hr.value) -> ComErrorMessage;
              NONE->Iptr[];
          else
              'IUnknownQuery: succes' -> screen.putLine;
              (* ih ->Iptr[];*) 
              (@@ih.ref,@@Iptr) -> copyRef;
			  'Query-1: ' -> puttext;
			    %getLongAt (@@ih.ref) -> putint; ' '->put;
                %getLongAt (@@Iptr) -> putint; newline;
          if);
       #) 
    exit Iptr[]
    #);
   obj: ^object;
   III: @integer;
do 0->CoInitialize;
   
   &CLSID[] -> CLSID_simpleserver[];
   SimpleDispatchServer_CLSID -> CLSID_simpleserver;

   IUnknown_IID -> IID_UNKNW;

   IDispatch_IID -> SimpleServer_IID; 

   'Create simple server instance '->putLine;
   
   (CLSID_simpleserver[], NONE, CLSCTX_LOCAL_SERVER, IID_UNKNW[])
     -> CoCreateInstance
	 -> pIUnknown[];
   
   'CoCreateInstance done'->putLine;

   (if pIUnknown[]<>NONE then
       'Succeeded creating component.'->putLine;
       
       (pIUnknown[], SimpleServer_IID[]) -> Query -> obj[];
	   (@@obj,@@pISimpleServer) -> copyRef;
       'Query-2: ' -> puttext;
	    %getLongAt (@@obj) -> putint; ' '->put;
        %getLongAt (@@pISimpleServer) -> putint; newline;


       (if (pISimpleServer[]<>NONE) then
	       'Calling SimpleDispatchServer.print' -> screen.putline;

		   'Called from BETA automation client' -> str.setText;

           str -> III; III -> pISimpleServer.print;

           'Done calling simpleDispatchServer.print' -> screen.putline;


           'Releasing interfaces' -> putline;
           pISimpleServer.Release;
       if);
       pIUnknown.Release;
    else
       'Could not create component'->putline;
   if); 
   'CoUninitialize'->putline;
   CoUninitialize;
   'CoUninitialize done'->putline;
   stop; 
#)
