ORIGIN 'tstenv';
--PROGRAM: descriptor--
(# 
   Argc: External(# noOfArgs: @integer exit noOfArgs #);
   Argv: External
     (# argNo: @integer;
        theArg: [1]@char
     enter argNo
     do CallC
     exit theArg
     #);
   NoOfArguments:
     (# exit Argc #);
   Arguments:
     (# argNo: @integer;
        theArg: ^text;
     enter argNo
     do (if ((1<=argNo) and (argNo<=ArgC)) then
            &text[]->theArg[]; argNo->Argv->theArg
        if);
     exit theArg[]
     #);
   
   thread: 
     (# my_tid: @integer;
        t:@Integer;
        spawn:
          (* General spawn pattern *)
          (# attToProcessor: external
               (# comp: @integer;
                  tid: @integer;
               enter comp
               exit tid
               #);
             thisthread: ^thread;
          do THIS(thread)[] -> thisthread[];
             (%getLongAt @@thisthread)-24->attToProcessor->my_tid;
          exit my_tid
          #);
     do L: 
          (# 
          do (for 1000000 repeat 
                  1->t;
             for);
             INNER thread;
             restart L
          #)
     #);
   txt2int:
     (# t: ^text;
        value: @integer;
        ch: @char
     enter t[]
     do (for i:t.t.range (* t.lgth is 0 *) repeat
             t.t[i]->ch;
             (if ('0'<ch) and (ch<'9') then
                 value*10+(ch-'0')->value;
             if)
        for)
     exit value
     #);
   numthreads: @integer;
   
do (if NoOfArguments<>2 then
       'Usage: manythreads <number of threads>' -> putline;
    else
       2->Arguments->txt2int->numthreads;
       'Starting '->puttext; numthreads->putint; ' threads.'->putline;
       (# 
          mythread: thread(# ch: @char do ch->put #);
          thread_ids: [numthreads]@integer;
          threads:    [numthreads]^|mythread;
          (* FIXME: cannot use static repetitions - not yet implemented *)
       do 
          (for i:numthreads repeat
               &|mythread[]->threads[i][];
               'a'+i-1 ->threads[i].ch;
               threads[i].spawn -> thread_ids[i];
          for);
       #)
   if)
#)
