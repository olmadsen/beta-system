ORIGIN 'imagepairbody';
INCLUDE '../../GENERATOR/INTEL/intel';
INCLUDE '../../GENERATOR/INTEL/INTELBmachine' (* For themachine.mstate *);
INCLUDE '../../GENERATOR/NTI/WIN32coff' (* For binding slots in INTELBmachine *);

--RelocateMapOffset: dopart--
do 

---NeedsGOT:doPart---
do false -> value
   
--- FlushCodeCache:descriptor---
(#   #)
  
--RelocateBody: descriptor--
(# 
do false->dump;
   (if mark
    // wordMark (* IMAGE_REL_I386_DIR32 *)then
       (if trace then
           'patching wordmark: off='->puttext; relativeOff->puthex;
           ', adr=' -> puttext; xAdr->puthex; newline;
       if);
       ((relativeOff -> getItem)+xAdr, relativeOff) -> patch;
    // jmpMark (* IMAGE_REL_I386_REL32 *) then
       (* Compare with emitrel32off in INTELmstate.bet *)
       (* (adr-(off+4)) %putLongAt (off); *)
       (xAdr-(absAdr+4),relativeOff) -> patch;
       (if trace then
           'patched jmpmark: off='->puttext; relativeOff->puthex;
           ', adr=' -> puttext; xAdr->puthex; 
           '; patched to '->puttext; (xAdr-(absAdr+4)) -> puthex; 
           newline;
       if);
    else
       'unknown mark in RelocateBody' -> screen.putline;
   if);
#)

---PatchGOT:descriptor---
(# #)
