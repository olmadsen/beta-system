#!/usr/local/bin/perl -s
$BETALIB=$ENV{'BETALIB'};
$BETALIB=~s%\\%/%g;
push(@INC, $ENV{'BETALIB'} . "/bin/admin");
if (-e "c:\\" && $ENV{'MIASDK'} eq ""){
    $ENV{'MIASDK'} = ms;
}
require "env.perl";

# -------------- Configuration-----------------------------------------

$dest        = "PRE-BETA";
$beta        = "$BETALIB/boot/bin/$objdir/beta";

# Examples to include from compiler/PRETST
# ls -1 *.bet *.som *.st | perl -ne '{ chomp; print "\t\"$_\",\n"; }'
@examples    = (
        "BetaComponent.st",
        "BetaStructure.st",
        "LL1.bet",
        "List.bet",
        "NumList.bet",
        "Queue.bet",
        "STclass.som",
        "STcoEx.som",
        "STcoExUser.bet",
        "STsuper.som",
        "STuser.bet",
        "Server.bet",
        "beer.bet",
        "conc.bet",
        "faclink.bet",
        "minienv.bet",
        "minienv_prebody.bet",
        "minienvbody.bet",
        "read.bet",
        "stack.bet",
        "stackbody.bet",
        "stackuser.bet",
);

# Stuff to remove from copy before packing
@cleanup = ( "configuration/mbs_id",
	     "configuration/ymer.pjt",
	     );

# -------------- Main -------------------------------------------------


sub usage()
{
    local($msg) = @_;
    print "pack_release: $msg\n" if ($msg ne "");
    print<<EOT;
usage: pack_release [-h][-v][-C][-z][-p]
     -h  print this help
     -v  verbose mode
     -C  skip compilation of compilers
     -Z  skip zipping of directory
EOT
    exit;
}

use File::Path;
use File::Copy;
use File::Find;

&usage() if ($h);

$skipcompilation = $C;
$skipzipping = $Z;
$publish = $p;

$|=1;

print "Creating BETA for pre-vm preliminary distribution in directory $dest\n";
 
if ( -d $dest ){
   print "Deleting existing $dest\n";
   #&rmtree($dest, 0, 1);
   system "rm -rf $dest";
}

if ($skipcompilation){
    print "Skipping recompilation of compilers (-C option)\n";
} else {
    print "Recompiling compilers\n";
    $pbetasrc = "$BETALIB/compiler/pbeta.bet";
    $pbeta    = "$BETALIB/bin/$objdir/pbeta${EXESUFFIX}";
    system "$beta -qwd -o $pbeta $pbetasrc > pbetaboot.out";
}

print "Creating directory $dest\n";
&mkpath($dest, 0, 0755);

print "Copying compiler\n";
&my_copyexecutable("$BETALIB/bin/$objdir", "pbeta${EXESUFFIX}", "bin", "pre-beta${EXESUFFIX}");

print "Copying grammars\n";
&my_copydir("$BETALIB/grammars/metagram", "grammars/metagram");
&my_copydir("$BETALIB/grammars/pretty", "grammars/pretty");
&my_copydir("$BETALIB/grammars/beta", "grammars/beta");

print "Copying configuration\n";
&my_copydir("$BETALIB/configuration", "configuration");

print "Copying setup files\n";
copy("cmd_setup.bat", "$dest/configuration");
copy("cygwin_bash_setup.sh", "$dest/configuration");
copy("tcshrc", "$dest/configuration");
copy("bash_setup.sh", "$dest/configuration");

print "Copying README.txt\n";
copy("README.txt", "$dest");

print "Copying examples\n";
foreach $f (@examples){
    &my_copyfiles("..", $f, "examples");
}

print "Clean up\n";
foreach $f (@cleanup){
    foreach $g (glob("$dest/$f")){
	print "  Deleting $g\n" if ($verbose);
	&rmtree($g, 0, 1);
    }
}

if ($skipzipping){
    print "Skipping zipping of directory (-Z option)\n";
} else {
    local ($sec,$min,$hour,$date,$month,$year,$day,$yday,$isdst) = localtime(time);
    $zipname = sprintf("$dest-%02d-%02d-%02d-%s.zip", 1900+$year, $month+1, $date, ($OS eq "WIN"?"windows":${objdir}));
    unlink "$zipname" if (-e "$zipname");
    print "Zipping directory to $zipname\n";
    system "zip -qr $zipname $dest";
}

# -------------- Routines  ---------------------------------------------

sub my_copydir($srcbase, $destbase){
    my ($srcbase, $destbase) = @_;
    &my_copyfiles($srcbase, "*", $destbase);
}

sub my_copyexecutable($srcbase, $srcfile, $destdir, $destfile){
    my ($srcbase, $file, $destdir, $destfile) = @_;
    &my_copyfiles ($srcbase, $file, $destdir);
    print "  rename $dest/$destdir/$file $dest/$destdir/$destfile\n" if ($verbose);
    rename "$dest/$destdir/$file", "$dest/$destdir/$destfile";
    print "  chmod 0755 $dest/$destdir/$destfile\n" if ($verbose);
    chmod 0755, "$dest/$destdir/$destfile";
}

sub my_copyfiles ($srcbase, $filespec, $destdir){
    my ($srcbase, $filespec, $destdir) = @_;
    foreach $g (glob("$srcbase/$filespec")){
	my ($path) = "$g";
	next if ($path =~ m%~$%); # skip tilde files
	next if ($path =~ m%/CVS%); # skip CVS files
	# skip various autogenerated files:
	next if ($path =~ m%(\.lst$|\.pdb$|\.sln$|\.duo$|\.suo$|\.dln$)%); 
	next if ($path =~ m%\.pdb$%);
	next if ($path =~ m%\.sln$%); 
	$path = substr $path, length($srcbase);  # remove srcbase/ prefix
	$path =~ s%/[^/]*$%%;                    # delete file component
	$path = "$dest/$destdir$path";
	if (! -d "$path"){
	    print "  Making directory $path\n" if ($verbose);
	    &mkpath($path, 0, 0755);
	}
	print "  Copy $g $path\n" if ($verbose);
	# system "/usr/bin/cp -p $g \"$path\""; # very slow
	copy($g, "$path"); 
    }
}

