origin 'minienv';
include 'monitor'
---program:descriptor---
(# trace: (# exit false #);
   M: @monitor
     (# S: ^text;
        set: entry
          (# T: ^text;
          enter T[]
          do (if trace then 'set:'->out.puttext; T[] -> out.putline if);
             T[] -> S[]
          #);
        get: entry
          (# T: ^text
          do S[] -> T[];
             (if trace then 'get:'->out.puttext; T[] -> out.putline if)
          exit T[]
          #);
        init:: (# do 'Go!'-> S[] #)
     #);
   prod: @|beta_system
     (#
     do exclusive(#do 'prod:hello'->out.putline #);
        'hello' -> M.set;
        exclusive(#do 'prod:world'->out.putline #);
        'world' -> M.set;
     #);
   cons: @| beta_system
     (# T: ^text;
     do exclusive(#do 'cons:'->out.puttext #);
        M.get -> T[];
        exclusive(#do T[] -> out.putline #);
        exclusive(#do 'cons:'->out.puttext #);
        M.get -> T[];
        exclusive(#do T[] -> out.putline #);
        exclusive(#do 'cons:'->out.puttext #);
        M.get -> T[];
        exclusive(#do T[] -> out.putline #);
        exclusive(#do 'cons:'->out.puttext #);
        M.get -> T[];
        exclusive(#do T[] -> out.putline #);
        exclusive(#do 'cons:'->out.puttext #);
        M.get -> T[];
        exclusive(#do T[] -> out.putline #);
        exclusive(#do 'cons:'->out.puttext #);
        M.get -> T[];
        exclusive(#do T[] -> out.putline #);
     #)
do M.init;
   'CONS' -> cons.id;
   'PROD' -> prod.id;
   prod[] -> fork;
   cons[] -> fork;
#)
