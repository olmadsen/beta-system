origin 'minienv'; 
include 'monitor'
---program:descriptor---
ConcurrentSystem
(# trace: (# exit false #);
   M: @monitor
     (# S: ^text;
        set: entry
          (# T: ^text;
          enter T[]
          do (if trace then 'set:'->out.puttext; T[] -> out.putline if);
             T[] -> S[]
          #);
        get: entry
          (# T: ^text
          do S[] -> T[];
             (if trace then 'get:'->out.puttext; T[] -> out.putline if)
          exit T[]
          #);
        init:: (# do 'Go!'-> S[] #)
     #);
   prod: @| cThread
     (#
     do 'prod'->out.putline; 
        exclusive(#do 'prod:hello'->out.putline #);
        'hello' -> M.set;
        exclusive(#do 'prod:world'->out.putline #);
        'world' -> M.set;
     #);
   cons: @| cThread
     (# T: ^text;
     do 'cons'->out.putline; 
        exclusive(#do 'cons:'->out.puttext #);
        M.get -> T[];
        exclusive(#do T[] -> out.putline #);
        exclusive(#do 'cons:'->out.puttext #);
        M.get -> T[];
        exclusive(#do T[] -> out.putline #);
        exclusive(#do 'cons:'->out.puttext #);
        M.get -> T[];
        exclusive(#do T[] -> out.putline #);
        exclusive(#do 'cons:'->out.puttext #);
        M.get -> T[];
        exclusive(#do T[] -> out.putline #);
        exclusive(#do 'cons:'->out.puttext #);
        M.get -> T[];
        exclusive(#do T[] -> out.putline #);
        exclusive(#do 'cons:'->out.puttext #);
        M.get -> T[];
        exclusive(#do T[] -> out.putline #);
     #)
do 'Mdemo'->out.putline;
   M.init;
   'Mdemo2'->out.putline;
   'CONS' -> cons.id; cons[] -> cons.thisThread[];
   'PROD' -> prod.id; prod[] -> prod.thisThread[];
   'Mdemo3'->out.putline;
   prod.fork;
   cons.fork;
   'Mdemo4'->out.putline;
#)
