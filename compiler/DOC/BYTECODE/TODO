
BETA Bytecode TODO
==================

Prioriteter: *** Høj
             **  Mellem
             *   Lav

A. General
==========

1. Gøre switch 320 default (uden at sætte den i nbeta/jbeta)

2. Dependency analyse for .il/.dll/.class filer - er det løst generelt?


B. Java specific
================

1. * For hver .bet fil, der oversættes, bliver den *sidste* .class file,
     dette giver anledning til, genereret 2 gange.

C. .NET specific
================

1. * [PA/OLM]
   Problem med overskrivning af program.il/program.class for hvert
   program.
    -> Muligvis lave subdirectory til denne navngivet udfra exefilen
       (ikke problem i java, da program.class er pakket ind i jar filen)

2. * [PA/OLM]
   Hvis man oversætter foo.bet, og siden
   oversætter bar.bet, men bar.class/bar.il er nyere end bar.bet, så
   bliver der ikke genereret en ny program.class/program.il, og
   afvikling af bar vil derfor udføre foo.


3. [PA]
   All source files constituting an executable must currently reside
   in the same directory.
   We intent to generate strong assemblies and config files and/or use
   the Global Assembly Cache for solving this later.

4. * [OLM]
   Vi skal kunne specificere fil location for en externalclass, og
   denne fil location skal med ind i import listen.
   Senere: Compiler skal kunne læse .Net assemblies direkte, så man ikke
   behøver at skulle erklære eksterne klasser og procedurer [PA]

   Vi bør understøtte
      BUILD 'myassembly.dll' 'myassembly.cs' 'csc ...';
   samt
      INCLUDE 'aSystemAssembly.dll'
   som begge bør
      1. Føre til import af assembly
      2. (senere) føre til indlæsning af klasser i assembly og
         opbygning af ast

5.  * [OLM] Lokal location skal ikke med
    Hvis man f.eks. oversætter
	 ORIGIN 'tstlib';         
	 -- program: Descriptor --
	 (# 
	 do 'a' -> put;
	    'b' -> fill;
	 #)  
    så vil der i program.il være en del referencer til klassen
    program, hvor der medtages location ['program'], hvilket ikke
    er nødvendigt, da det jo er i samme fil.
    I visse tilfæde forvirrer dette verifieren.

6. Verification errors ved oversættelse af btst:
    
     a. [tst\dotnet\tstvirt2.dll : tstvirt2$final2virtZ$Xqua::do] [offset 0x00000020] [opcode beq] 
        -> Int32 objref 'BetaObject' Non-compatible types on the stack.

     Detaljer (debug/fixme kode rykket ind for ikke at forvirre):

 	   .method public virtual void 'do'() cil managed 
            {
                  .maxstack 1000
                  ldarg.0
                  ldfld   class ['tstenv']'BetaObject' class ['tstvirt2']'tstvirt2$final2virtZ$Xqua'::'R' 
                          // pushReg %top
                          ldstr "FIXME: Primitive NYI: ObjS(Unknown)"
                          call void [mscorlib]System.Console::WriteLine(string)
                          // pushReg %top
                  newobj  instance void class ['tstenv']'BetaObject'::.ctor()
                          // pushReg %top
                          // pushReg %call
                          ldstr "FIXME: Primitive NYI: leS(Unknown)"
                          call void [mscorlib]System.Console::WriteLine(string)
                  ldc.i4.0
                  beq     L2

     b. [tst\dotnet\tstvirt2.dll : tstvirt2$final2virtZ$Xqua::do] [offset 0x00000056] [opcode ret] 
       -> Stack must be empty on return from a void function.
 
     c. [tst\dotnet\tstvirt2.dll : tstvirt2$future::do] [offset 0x0000000D] [opcode ldfld] 
       -> [found objref 'tstvirt2$future$SmallComputation'] [expected objref 'tstvirt2$future'] Unexpected type on the stack.

          .method public virtual void 'do'() cil managed 
          {
               .maxstack 1000
               ldarg.0
               ldarg.0
               ldfld   class ['tstvirt2']'tstvirt2$future$SmallComputation' class ['tstvirt2']'tstvirt2$future'::'small'
               dup
               callvirt instance void class ['tstvirt2']'tstvirt2$future$FutureComputation'::'do'()
               ldfld    class ['tstvirt2']'tstvirt2$future$SmallComputation' class ['tstvirt2']'tstvirt2$future'::'small' 

     d. [tst\dotnet\tstvirt2.dll : tstvirt2$future::do] [offset 0x00000017] [opcode ldfld] [token  0x0A0001AD] 
       -> Unable to resolve token.

         ldfld	class ['tstvirt2']'tstvirt2$future$FutureComputation$futureType' class ['tstvirt2']'tstvirt2$future'::'this_'
         
         'this_' ????

     e. [tst\dotnet\tstblock.dll : TstBlock$singular_1::do_1] [offset 0x0000003B] [opcode ret] 
       -> Stack must be empty on return from a void function.
     f. [tst\dotnet\tstblock.dll : TstBlock$singular_1::do_1] [offset 0x0000003B] 
       -> Stack depth differs depending on path.

       Detaljer: Forsø på stakhøjde annotering:

  	.method public virtual void 'do_1'() cil managed 
  	{
  		.maxstack 1000
  		ldarg.0 /* 1 */ 
  		ldfld	class ['tstblock']'TstBlock' class ['tstblock']'TstBlock$singular_1'::origin /* 1 */ 
  		ldfld	class ['tstenv']'tstenv' class ['tstblock']'TstBlock'::origin /* 1 */ 
  		ldarg.0 /* 2 */ 
  		ldfld	char class ['tstblock']'TstBlock$Q$scan'::'c' /* 2 */ 
  		callvirt instance void class ['tstenv']'tstenv'::'put'(char) /* 0 */ 
  		ldarg.0 /* 1 */ 
  		ldfld	char class ['tstblock']'TstBlock$Q$scan'::'c'  /* 1 */ 
  		dup /* 2 */ 
  		ldc.i4.s 118  /* 3 */ 
  		bne.un	L14 /* 3 */ 
  		pop /* 2 */ 
  		ldarg.0 /* 3 */ 
  		br	L13 /* 3 */ 
  	L14:    /* 3 (kommer fra bne.un ovenfor */ 
  		dup /* 4 */
  		ldc.i4.s 122  /* 5 */ 
  		bne.un	L15 /* 5 */ 
  		pop /* 4 */ 
  		ldarg.0 /* 5 */ 
  		br	L13 /* 5 */ 
  	L15:    /* 5 (kommer fra bne.un ovenfor) */
  		pop /* 4 */ 
  	L13:
  		ret /* 4 (hvis man kommer fra pop ovenfor) */ /* 5 (hvis man kommer fra br L13 ovenfor) */ 
  	}     

     g. [tst\dotnet\tstlib.dll : chkR::enter] [offset 0x00000009] [opcode ret] 
       -> Stack must be empty on return from a void function.

       .method public virtual void 'enter'(int32,int32,char) cil managed 
       {
             .maxstack 1000
             ldarg.0
             ldarg.0
             ldarg.0
             ldarg.1
             stfld   char class ['tstlib']'chkR'::'ch' 
             ret
       }

       Lige lovligt mange load af this Mystisk!

     h. [tst\dotnet\tstlib.dll : chkR::do] [offset 0x00000057] [opcode ret] 
       -> Stack must be empty on return from a void function.

     Lang - men ligner også for mange load af this.

     i. [tst\dotnet\tstlib.dll : eqR::do] [offset 0x0000002B] [opcode ret] 
       -> Stack must be empty on return from a void function.

     Lang - men ligner også for mange load af this.

     j. [tst\dotnet\tstlib.dll : eqR::enter] [offset 0x00000002] [opcode ret] 
       -> Stack must be empty on return from a void function.
 
	  .method public virtual void 'enter'(int32,int32) cil managed 
	  {
		.maxstack 1000
		ldarg.0
		ldarg.0
		ret
	  }  

     Ligner 6.g problemet.

     k. [tst\dotnet\tstenv.dll : CStruct::.ctor] [offset 0x0000000F] [opcode newobj] 
       -> [found objref ('this' ptr) 'CStruct'] [expected objref 'tstenv'] Unexpected type on the stack.

 	  .method public rtspecialname specialname hidebysig instance void .ctor(class ['tstenv']'tstenv')
 	  {
 	        ldarg.0
 	        call    instance void ['tstenv']'BetaObject'::.ctor()

 	        ldarg.0
 	        ldarg.1
 	        stfld   class ['tstenv']'tstenv' class ['tstenv']'CStruct'::origin 
 	        ldarg.0
 	        ldarg.0    <-- Dette er et Cstruct object (this)

 	        newobj  instance void class ['tstenv']'IntegerObject'::.ctor(class ['tstenv']'tstenv')
              
           IntegerObjects constructor forventer en tstenv origin.

     l. [tst\dotnet\tstenv.dll : CStruct$Byte::exit] [offset 0x00000000] [opcode dup] 
       -> Stack underflow.

 	      .method public virtual int32 'exit'() cil managed 
 	      {
 	            .maxstack 1000
 	            dup
 	            .locals init ([0] int32)
 	            stloc.0

 	            ret
 	      }          

	Der mangler vist noget?

     m. [tst\dotnet\tstenv.dll : CStruct$Long::exit] [offset 0x00000000] [opcode dup] 
       -> Stack underflow.

        Samme som 6.m.
