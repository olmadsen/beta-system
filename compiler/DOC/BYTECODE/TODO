
BETA Bytecode TODO
==================

Prioriteter: *** Høj
             **  Mellem
             *   Lav

A.   General
============

A1.  Missing BETA features
     a. Components
    	Look at 
    	- Michael and Kims beta2java project
 	     http://www.daimi.au.dk/~henryml/oovm
 	     file:///users/henryml/oovm/source/
    	- Discrete Event Simulation in Java
    	     http://www.dat.ruc.dk/~keld/research/JAVASIMULATION/
 	  especially section 3.3f
    	- Multithreading with C#
    	     http://www.oreillynet.com/pub/a/dotnet/2001/08/06/csharp.html
     b. Structure objects
    	Use reflection?
     c. Covariant parameters
    	Ole currently working with it
     d. ...
 
A2.  Interface to external features
     a. Enumerations
    	Problem: The *values* are simple numbers, but they are *typed*
    	in external languages.
    	Currently problem in TEST/hellographics (LinearGradientMode)
	if enumerations_implemented is set to true.
     b. Value types (structs)
    	Handle as dynamic or static beta references?
    	Allocation (does not use new/newobject, but calls constructor)
 
A3.  ** [OLM] 
     Text konstant assignet til static external fejler (se
     udkommenteret kode i jstring.bet).
 
A4.  ** [OLM] 
     GENERATOR/BYTECODE/TEST/javastring: 
     Objekt referencer til External[Class] skal oversættes til native
     object mens andre referencer kvalificeret som Object skal
     oversættes til BetaObject.
     Eller også skal der altid bruges native object, og så laves et
     cast inden man forsøger at udføre et objekt, der faktisk er et
     BETA object.
     Men det er uklart hvor stort et problem det egentlig er.
 
A5.  Gøre switch 320 default (uden at sætte den i nbeta/jbeta)
 
A6.  Method overloading.
     I tilfælde at overloadede metoder i ExternalClass er vi nødt
     til at kunne specificere de forskellige signaturer for disse
     proc's ligesom vi allerede kan i External. I tstenv er den en
     (pt udkommenteret) 'procname', der var tænkt anvendt til
     dette.
     Denne 'procname' burde nok hedde signature, ligesom 'callC' i
     external burde have et alias med navn 'signature'.
     
A7.  Syntax/principle for constructors
     - with or without origin object
     - overloading of multiple constructors
 
A8.  Bobs parser problem
     [Not really bytecode specific, but is a problem for nbeta/jbeta
     too, and thus mentioned here]
     The changes introduced for asIsPrettyPrint in
     bobs/private/pars.bet on 2001/09/21 cause parsing to stop silently
     after certain parse errors.
     Changes can be viewed by
     > cd $BETALIB/bobs/private
     > cvs diff -D '2001/09/20'
 
A9.  TEST/ECStest fails on both javabc and dotnet

A10. All source files constituting an executable must currently reside
     in the same directory.

A11. Introduce properties for patterns in BETA?
     Examples:
       - proc
       - class
       - static
       - byval
       - enum

A12. How to handle static methods?
     Currently declated outside ExternalClass using External/CallC.
     Declare inside ExternalClass with a [static] property?

A13. Detalje med real32 konstanter

     Prøv at oversætte flg. program:

     ORIGIN 'tstenv';
     --LIB:attributes--
     foo: externalclass
     	 (# f: proc
     	    (# x: @real32
     	    enter x
     	    #);
     	 #)
     --PROGRAM: descriptor--
     (# f: ^foo;
     do &foo[] -> f[];
     	  15 -> f.f;
     	  15.0 -> f.f;
     #)
     
     Hvis man ser på det genererede kode kan man se at der ikke overføres
     aktuel parameter af type float32 i det første kald af f.f, men kun i
     det andet, hvor man eksplicit gør det klart at der er tale om en float
     konstant.

A14. Problem med statiske text erklæringer
     Med statiske erklæringer af text, som i
     nedenstående jstring4.bet, får man semantiske fejl:
     
     ORIGIN 'betaenv';
     BUILD javabc 'javabc/jstringuser.class' 
                  'jstringuser.java' 
                  'javac jstringuser.java; mv jstringuser.class javabc';
     INCLUDE 'javastring';
     ---LIB:attributes---
     staticdisplay2: external (* static method in jstringuser *)
       (# S1, S2: ^String
       enter (S1[], S2[])
       do 'static jstringuser/staticdisplay2(Ljava/lang/String;Ljava/lang/String;)V'
            -> callC;
       #);
     ---program:descriptor---  
     (# T1, T2: @Text
     do (T1[], T2[]) -> staticdisplay2;
     #) 
     
     Bind fragments in: 'jstring4'!Checking
     
     (T1[],T2[])->staticdisplay2  
 			       ^
     ***** In "(T1[],T2[])->staticdisplay2", 
    	"T1[]" in the exit-part of the left-side
    	cannot be assigned to: 
    	"S1[]" in the enter-part of the right-side
    	due to incompatiple qualifications

A15. Problems with TEST/betaenv*.bet

     A few constructs used in TEST/betaenv*.bet cause verification
     problems. These are all marked with

     FIXME: bytecode verification problems


B.   Java specific
==================

B1.  * [OLM]
     For hver .bet fil, der oversættes, bliver den *sidste* .class file,
     dette giver anledning til, genereret 2 gange.
     Ses med jbeta -v
 
B2.  Cannot use ExternalClass in betaenv_javabcbody.
     Using an externalclass in betaenv_javabcbody causes an empty
     class file of that name to be generated when
     betaenv+betaenv_javabcbody is compiled, since semantic bindings
     for externalclass are not set up properly when betaenv is
     compiled.
     Only cure is to remove betaenv_javabcbody.ast(L) and the javabc 
     directory (with the bad class files) after compilation of
     betaenv and recompile.
 
B3.  * [PA/OLM]
     Implementere getLine i tstenv_javabcbody (mangler til google demoen).
     Kræver support for loading af statis felt System.in, enten ved
     generel mekanisme eller ved hardcoding i compiler (ligesom
     System.out pt loades hvis man bruger PrintStream).
     Desuden er der brug for at kalde constructors med argumenter.
 
B4.  Make (some) graphical Java debugger able to handle BETA?
     -> ask SUN



C.   .NET specific
==================

C1.  FIXED!
     
C2.  Codegeneration for .NET compact framework
     - switch 186 currently used
     - possibly a new target platform (dotnet_cf)?
     - looking up version/publickeys in CF DLLs?
     	-> ask microsoft
     
C3.  Link assemblies together (a la JAR) using AL.EXE?
     -  has been tried, but only works for netmodules, not for existing
     	assemblies.
     -> ask microsoft
     
C4.  [PA/OLM]
     Vi skal kunne specificere kompleks location (f.eks. med
     versionsnummer) for en externalclass.
     Senere: Compiler skal kunne læse .Net assemblies direkte, så man ikke
     behøver at skulle erklære eksterne klasser og procedurer [PA]
     Delvis løsning er lavet: Hvis assemblyet er i Global Assembly
     cache slås dets versionsnummer op og bruges af compiler.
     
     Vi bør understøtte
     	 BUILD 'myassembly.dll' 'myassembly.cs' 'csc ...';
     samt
     	 INCLUDE 'aSystemAssembly.dll'
     som begge bør
     	 1. Føre til import af assembly
     	 2. (senere) føre til indlæsning af klasser i assembly og
     	    opbygning af ast
     
     
C5.  * [OLM] Lokal location skal ikke med
     Hvis man f.eks. oversætter
     	   ORIGIN 'tstlib';         
     	   -- program: Descriptor --
     	   (# 
     	   do 'a' -> put;
     	      'b' -> fill;
     	   #)  
     så vil der i program.il være en del referencer til klassen
     program, hvor der medtages location ['program'], hvilket ikke
     er nødvendigt, da det jo er i samme fil.
     I visse tilfæde forvirrer dette verifieren.
     
C6.  Kommenterede verification errors ved oversættelse af btst:
     (Sidst verificeret tilstede: 2002-08-08)
     
     a. [tstref.dll : tstRef$noNone::do] [offset 0x00000009] [opcode stloc.0] [found objref 'text'] [expected Int32] 
     	  -> Unexpected type on the stack.
     
     	    .method public virtual void 'do'() cil managed 
     	    {
     		  .maxstack 1000
     		  ldarg.0
     		  ldarg.0
     		  ldarg.0
     		  callvirt instance class ['tstenv']'text' class ['tstref']'tstRef$noNone'::'bar'()
     		  dup
     		  .locals init ([0] int32)
     		  stloc.0
     		  stfld	class ['tstenv']'text' class ['tstref']'tstRef$noNone'::'s' 
     		  ldloc.0
     		  callvirt instance void class ['tstref']'tstRef$noNone'::'foo'(class ['tstenv']'text')
     		  ret
     	    }     
     
     	  Ser ud til at allocAndStoreLocal kaldes med forkert type
     	  (int32 istedet for text).
     
     b. [tstref.dll : tstRef$noNone::do] [offset 0x00000010] [opcode callvirt] [found Int32] [expected objref 'text'] 
     	  -> Unexpected type on the stack.
     
     	  Samme som C6.a
     
     c. [tst\dotnet\tstvirt2.dll : tstvirt2$final2virtZ$Xqua::do] [offset 0x00000020] [opcode beq] 
     	  -> Int32 objref 'BetaObject' Non-compatible types on the stack.
     
     Detaljer (debug/fixme kode rykket ind for ikke at forvirre):
     
     	     .method public virtual void 'do'() cil managed 
     	      {
     		    .maxstack 1000
     		    ldarg.0
     		    ldfld   class ['tstenv']'BetaObject' class ['tstvirt2']'tstvirt2$final2virtZ$Xqua'::'R' 
     			    // pushReg %top
     			    ldstr "FIXME: Primitive NYI: ObjS(Unknown)"
     			    call void [mscorlib]System.Console::WriteLine(string)
     			    // pushReg %top
     		    newobj  instance void class ['tstenv']'BetaObject'::.ctor()
     			    // pushReg %top
     			    // pushReg %call
     			    ldstr "FIXME: Primitive NYI: leS(Unknown)"
     			    call void [mscorlib]System.Console::WriteLine(string)
     		    ldc.i4.0
     		    beq     L2
     
     d. [tst\dotnet\tstvirt2.dll : tstvirt2$final2virtZ$Xqua::do] [offset 0x00000056] [opcode ret] 
     	  -> Stack must be empty on return from a void function.
     
     e. [tstvirt2.dll : tstvirt2$future::do] [offset 0x00000023] [opcode ldfld] [token  0x0A0001AE] 
     	  -> Unable to resolve token.
     
     f. [tst\dotnet\tstblock.dll : TstBlock$singular_1::do_1] [offset 0x0000003B] [opcode ret] 
     	 -> Stack must be empty on return from a void function.
     
     g. [tst\dotnet\tstblock.dll : TstBlock$singular_1::do_1] [offset 0x0000003B] 
     	 -> Stack depth differs depending on path.
     
     	 Detaljer: Forsøg på stakhøjde annotering:
     
     	  .method public virtual void 'do_1'() cil managed 
     	  {
     		  .maxstack 1000
     		  ldarg.0 /* 1 */ 
     		  ldfld	class ['tstblock']'TstBlock' class ['tstblock']'TstBlock$singular_1'::origin /* 1 */ 
     		  ldfld	class ['tstenv']'tstenv' class ['tstblock']'TstBlock'::origin /* 1 */ 
     		  ldarg.0 /* 2 */ 
     		  ldfld	char class ['tstblock']'TstBlock$Q$scan'::'c' /* 2 */ 
     		  callvirt instance void class ['tstenv']'tstenv'::'put'(char) /* 0 */ 
     		  ldarg.0 /* 1 */ 
     		  ldfld	char class ['tstblock']'TstBlock$Q$scan'::'c'  /* 1 */ 
     		  dup /* 2 */ 
     		  ldc.i4.s 118  /* 3 */ 
     		  bne.un	L14 /* 3 */ 
     		  pop /* 2 */ 
     		  ldarg.0 /* 3 */ 
     		  br	L13 /* 3 */ 
     	  L14:    /* 3 (kommer fra bne.un ovenfor */ 
     		  dup /* 4 */
     		  ldc.i4.s 122  /* 5 */ 
     		  bne.un	L15 /* 5 */ 
     		  pop /* 4 */ 
     		  ldarg.0 /* 5 */ 
     		  br	L13 /* 5 */ 
     	  L15:    /* 5 (kommer fra bne.un ovenfor) */
     		  pop /* 4 */ 
     	  L13:
     		  ret /* 4 (hvis man kommer fra pop ovenfor) */ /* 5 (hvis man kommer fra br L13 ovenfor) */ 
     	  }     
     
     
     h. [tst\dotnet\tstlib.dll : chkR::do] [offset 0x00000057] [opcode ret] 
     	  -> Stack must be empty on return from a void function.
     
     	   .method public virtual void 'do'() cil managed 
     	   {
     		 .maxstack 1000
     		 ldarg.0
     		 ldarg.0
     		 ldarg.0
     		 ldarg.0
     		 ldfld   int32 class ['tstlib']'chkR'::'i' 
     		 ....
     
     	 Lang - men ligner også for mange load af this, ligesom nedenfor.
     
     i. [tst\dotnet\tstlib.dll : chkR::enter] [offset 0x00000009] [opcode ret] 
     	 -> Stack must be empty on return from a void function.
     
     	 .method public virtual void 'enter'(int32,int32,char) cil managed 
     	 {
     	       .maxstack 1000
     	       ldarg.0
     	       ldarg.0
     	       ldarg.0
     	       ldarg.1
     	       stfld   char class ['tstlib']'chkR'::'ch' 
     	       ret
     	 }
     
     	 For mange load af this.
     
     
     j. [tst\dotnet\tstlib.dll : eqR::do] [offset 0x0000002B] [opcode ret] 
     	 -> Stack must be empty on return from a void function.
     
     Lang - men ligner også for mange load af this.
     
     k. [tst\dotnet\tstlib.dll : eqR::enter] [offset 0x00000002] [opcode ret] 
     	 -> Stack must be empty on return from a void function.
     
     	    .method public virtual void 'enter'(int32,int32) cil managed 
     	    {
     		  .maxstack 1000
     		  ldarg.0
     		  ldarg.0
     		  ret
     	    }  
     
     Ligner C6.i problemet.
     
     l. [tst\dotnet\tstenv.dll : CStruct::.ctor] [offset 0x0000000F] [opcode newobj] 
     	 -> [found objref ('this' ptr) 'CStruct'] [expected objref 'tstenv'] Unexpected type on the stack.
     
     	    .method public rtspecialname specialname hidebysig instance void .ctor(class ['tstenv']'tstenv')
     	    {
     		  ldarg.0
     		  call    instance void ['tstenv']'BetaObject'::.ctor()
     
     		  ldarg.0
     		  ldarg.1
     		  stfld   class ['tstenv']'tstenv' class ['tstenv']'CStruct'::origin 
     		  ldarg.0
     		  ldarg.0    <-- Dette er et Cstruct object (this)
     
     		  newobj  instance void class ['tstenv']'IntegerObject'::.ctor(class ['tstenv']'tstenv')
     		
     	     IntegerObjects constructor forventer en tstenv origin.
     
     m. [tst\dotnet\tstenv.dll : CStruct$Byte::exit] [offset 0x00000000] [opcode dup] 
     	 -> Stack underflow.
     
     		.method public virtual int32 'exit'() cil managed 
     		{
     		      .maxstack 1000
     		      dup
     		      .locals init ([0] int32)
     		      stloc.0
     
     		      ret
     		}          
     
     	  Der mangler vist noget?
     
     n. [tst\dotnet\tstenv.dll : CStruct$Long::exit] [offset 0x00000000] [opcode dup] 
     	 -> Stack underflow.
     
     	  Samme som C6.m.
     
C7.  Import handling clean-up:
     All imports should be able to handle in
     signature.bet:descLocation, but some imports are also done in
     signature.bet:add_dotnet_location, and in
     genexternal:ExternalCallCall.
     
C8.  Use BETA as script language in ASP.NET pages.
     How to configure IIS to understand Language=BETA
     -> ask microsoft
     
C9.  Construct a Visual Studio .NET extension for BETA.
     - build rules
     - syntactic coloring
     -> ask microsoft
     
C10. Lille detalje ved multiple assignments
     
     Ved multiple assignments genereres på dotnet nogle temporære lokale
     celler til den value, der skal assignes.  Dette er jo typede lokale
     variable.
     
     Hvis man f.eks. har
     
     	  a,b: ^object
     do &object[]->a[]->b[]
     
     så genereres det rigtige, nemlig en lokal variabel kvalificeret ved
     BetaObject.
     
     MEN hvis man istedet siger
     
     do NONE -> a[] -> b[]
     
     så bliver den lokale variable kvalificeret ved int32.
     Til min store overraskelse virker det dog, så indtil videre er NULL åb
     enbart
     assignkompatibel med int32.
     
     Tilsvarende:
     
     	  a, b, c: @char;
     do 'a' -> a;
     	  a -> b -> c;
     
     Her bliver den temporære variabel type 'char', hvilket jo er korrekt.
     Men i
     
     a, b, c: @char;
     do 'a' -> a -> b -> c;
     
     bliver den temporære af type int32.
