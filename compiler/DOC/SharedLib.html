<HTML>

<HEAD>
<TITLE>Shared Libraries</TITLE>
<LINK REV="made" HREF="mailto:olm@daimi.aau.dk">
</HEAD>

<BODY>
<H1>Shared Libraries</H1>

<PRE>
Specification of Shared LIBRARY property in the fragment system
---------------------------------------------------------------

1. Current Implementation of Shared Libraries
---------------------------------------------

The compiler supports that one or more object files may be linked as a shared
library.

Note! Currently shared libraries are only supported on the SGI platform.

Note! The current version of shared libraries are only intended for Mjolner
developers. Testing and experience is necessary before this mechanism will be
announced as a public feature.

2. Definition of a shared library
----------------------------------

A shared library may be defined using the following properties:

*   LIB_DEF <libName> <libLocation>

    A fragment group containg this property defines a shared library 
    with the name <libName>.
    The shared library will be placed in the directory <libLocation>.

*   LIB_ITEM <libName>

    A fragment group containing this property will be included in the
    shared library <libName>

3. Example
----------

A shared library, 'foolib', containing the fragment groups (files):

       foo, foo1, foo2, ..., fooN

may be defined in the following way:

The shared library may be defined in the fragment group 'foo.bet'.

	foo.bet:
	-------
	ORIGIN '...';

	...

The shared library will be placed in the directory '../lib'. 
See discussion of this later.

The other fragment groups must include a LIB_ITEM property:

	fooI.bet	I= 1, 2, ... ,N
	--------
	ORIGIN '...';
	LIB_ITEM 'foolib';
	...

4. Conventions
--------------

As mentioned above, we need to collect experience with shared libraries
and this may give rise to changes. In the following some conventions
for defining shared libraries are mentioned.

4.1	Shared library locations
--------------------------------

For the Mjolner System, the idea is that all shared libraries are placed
in 
	$BETALIB/lib 

This means that all shared libraries must have different names.

Assume that the files

	foo, foo1, foo2, ..., fooN

are placed in $BETALIB/foo.

In the LIB_DEF used above:

     	LIB_DEF 'foolib'  '../lib';

the location was specified as '../lib'.

An alternative would be to specify the location as '~beta/lib'.
If the location is specified in this way, it is not possible to check out
a local version in your own directory. The compiler will then place
the shared librarys direcly in '~beta/lib'. You may not have permission
for this.  If you have permissions your changes will be immediately
visible for other users of $BETALIB/lib.

By using '../lib', the shared library is placed relative to the directory
'foo'. This will work when foo is compiled in $BETALIB and of compiled
as a local version. It is of course necessary that the local directory
is placed in a structure where '../lib' is meaningfill as in

	/users/ess/beta/...
		       /lib
		       /foo
		       ...
4.2 	Defining shared libraries
---------------------------------

The following are guidelines for defining shared libraries.

Consider some more structure on foo:

	foo/foo.bet
	   /bar.bet
	   /private/foobody.bet
	           /fooimpl.bet
		   /fooaux.bet
		   /barbody.bet

where

	foo.bet
	------
	ORIGIN '...';
	BODY 'private/foobody';
	BODY 'private/fooimpl';
	...

	foobody.bet
	-----------
	ORIGIN '../foo';
	INCLUDE 'fooaux';
	...

	bar.bet
	------
	ORIGIN 'foo';
	BODY 'private/barbody';
	...

Assume also that foo and bar can be used by other fragments.
I.e. one fragment may include foo and another may include bar.

Since foo and bar are not always used together, it is not a good idea
to put them in the same shared library.

*	All applications will always load both of them

*	They must always be compiled together, otherwise the current
	implementation of shared libraries may be fooled.

If you decide that the above problmes are not severe, you may put
foo and bar in the same shared library. In this case foo should be
move to private and the only visible interface should be bar. I.e.
all other fragmnets should always include bar.

Assume first that foo and bar are kept separately. We may then define
the following shared librarys structure

	foo.bet
	------
	ORIGIN '...';
	LIB_DEF 'foo' '../lib';
	BODY 'private/foobody';
	BODY 'private/fooimpl';
	...

	foobody.bet
	-----------
	ORIGIN '../foo';
	LIB_ITEM 'foo'
	INCLUDE 'fooaux'
	...

	fooimpl.bet
	-----------
	ORIGIN '../foo';
	LIB_ITEM 'foo'
	...

	fooaux.bet
	----------
	ORIGIN '../foo';
	LIB_ITEM 'foo'
	...

	bar.bet
	------
	ORIGIN 'foo';
	LIB_DEF 'bar '../lib';
	BODY 'private/barbody';
	...

	barbody.bet
	-----------
	ORIGIN '../bar';
	LIB_ITEM 'bar'
	...

4.3 LD_LIBRARY_PATH
-------------------

On SGI the environment variable LD_LIBRARY_PATH must include the directories
where shared libraries are placed. Using the conventions described above
this means that LD_LIBRARY_PATH for SGI must include

	$BETALIB/lib/sgi

The goal of the new implementation of shared libraries is that the automatic
split of objects files into shared libraries currently performed by the
compiler will no long be necessary. However, this will take place until a
proper organization of MBS has been made into shared libraries using LIB_DEF
and LIB_ITEM.

5.  Status
-----------------

Shared libraries will only be in effect if

*  the 'asmlink' slot hasSharedLibs returns true (as in SGIasmlink)

NOTE: On SGI (and PPC?) the compiler splits large programs into a
number of shared libraries. This is done by splitting the object files
into a number of shared libraries. This splitting is NOT based on the
LIB properties. 

------------------------------
 DO NOT READ BELOW THIS LINE
------------------------------

2.  Discussion
--------------

(this is an old discussion of alternatives to the original LIBRARY
property. Do not read it. Some of the points below will be kept
in a new version of this document.)

The current use of shared libraries where the job file is just split
into a number of shared libraries is inefficient since there is too
much linking. This may be be avoided by using the LIB properties. 

2.1  Problems
-------------

2.1.1  Placement of shared libraries

       Currently a shared library is placed in the code directory of
       the main member of the shared librarys. 

       * In general this means that shared libraries will be spread
         over a a number of directories. This means that LD_LIBRARY_PATH
	 (SGI) will have to include the (top) sgi directory of all 
	 MBS libraries.
	 THIS has been mentioned to be unacceptable! Is this the case?
	 Will it be possible to have on shared lib directory that
	 link to these directories or in some other way make this
	 easy to use?

       * On the Mac you may want to put all shared libraries in the
         'extension' folder. Is this still the case?

2.2 Solutions
-------------

2.2.1 Solution 1
----------------

The library property could be extended to specify placement of shared
libraries. The LIBFARY property for the main library could have the
form:

*      LIBRARY   'foo'  sun4s '~beta/lib'
	         	ppcmac '~beta/extension'
			...


and for the other elements just

*      LIBRARY  'foo'


Alternatively there could be a LIBLOCATION property which the MAIN
library might specify if other than the default placement is desired.

Problem: By specifying LIBRARY to be '~beta/lib' it will be difficult
to have a local workspace version.  Unless ~beta is interpreted as in
the proposal for supporting <A HREF="WorkSpace.html">Several Work Spaces</A>.

This problem can perhaps be handled by giving a relative
specification of the placement:

*       LIBRARY 'foo'  sun4s '../../lib'

I.e. relative to the fragment. But perhaps not so practical/nice?

2.2.1 Solution 2
----------------

An environment variable may be used to specify the placement of
shared libraries. This will to some extent solve the problem
of having a local workspace version of a library.

The problems are:

*      Alle MBS shared libraries must have different names.
       This may not be a big problem since we in other situations
       already may have this restriction.

*      Of not all shared libraries for a user is to be placed
       in the same directory it may be tricky or errorphrone
       to set it correctly when shifting between things.
       Perhaps MBS stuff and hypermedia stuff for user beta
       should be placed differently

*      When working on a local version of e.g. 'dependency' and then later
       checking it in, the shared lib version in ones local version
       must be removed since the loader otherwise will take this one
       and not the one in ~beta. It may not be enough to just set the
       ENV variable to the ~beta/sharedlib, since one often has to
       load from ~beta as well as from ones own shared lib dir.

3. Conclusion
-------------

As of now there is no obvious 'best' solution.

Comments please!

</PRE>

</BODY>
</HTML>