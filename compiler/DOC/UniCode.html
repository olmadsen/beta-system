<HTML>

<HEAD>
<TITLE>Design of Support for UniCode</TITLE>
<LINK REV="made" HREF="mailto:olm@daimi.aau.dk">
</HEAD>

<BODY BGCOLOR="#FFFF99">
<H1> Design of Support for UniCode</H1>

This note describes the current status of design and implementation of
UniCode support for BETA.
<P>
A new basic pattern
<PRE>
      wchar: (# #)
</PRE>

has been added to betaenv. Instances of wchar represents 16 bit
unsigned integers.

<P>
The fragment:
<PRE>
      /users/olm/beta/UNICODE/unicodetext.bet
</PRE>
defines patterns
<PRE>
      wStream: (# ... #);
      wText: wStream (# ... #)
</PRE>
that are identical to patterns "stream" and "text" except that 16 bits
characters are stored.

<H3>Conversion between text- and wtext objects</H3>
For some time, the old ASCII text concept has to exist together with
the UniCode text concept. There will thus have to be operations for
converting from ASCII to UniCode and vice versa.  The following
conversation operations have been defined:
<PRE>
     ascii2wText: (# T1: ^text; T2: ^wText enter T1[] ... exit T2[] #)
     text: (# ... aswText: (# ... exit anwText[] #); #)
     wText: (# ... asAscii: (# ... exit aText[] #); #)
</PRE>

<H3>Transfer of wtext to/from external COM functions</H3>
Consider a COM function

<PRE>
      myClass: COM
         (# f:< (# a: ^wtext; ...
	        enter(a[], ...) ...
		#)
		...
	#);
      R: ^myClass;
      S: ^wtext
</PRE>
When calling
<PRE>
      (S[], ...) -> R.f
</PRE>
The primitive:
<PRE>
      CopyWT      - primReg1: reference to BETA wtext object
</PRE>
is called to convert the BETA wtext S[] to an external wtext.
<P>
In the G-part of f, a received external wtext is converted into
a BETA wtext by the primitive:
<PRE>
      CopyCWT     - primReg: reference to external wtext
</PRE>
Note that when calling COM virtuals implemented in BETA, from BETA,
the wtext is conveterted to the external form and then back to BETA.
We should considered avoiding this. (the same happens with ascii
texts).

<P>
It is an opne issues how an external wtext should be representted.

<H2> Open Issues </H2>
Text constants like 'Hello world' cannot be assigned to a wText object:
<PRE>
      T: @wtext; ... 'Hello world'-> T
</PRE>
The primitive CopyT will have to take care of this, or the compiler
should call another routine (some work). See evval2:txtCstVal:asgToRepAdr.
The checker accepts this
imperative.
<P>
Similarly, a text constant cannot be assigned to a wtext reference:
<PRE>
      T: ^wtext; ... 'Hello world'-> T[]
</PRE>

The checker will have to accept this imperative. For ascii text, the
primitive MkTO takes care of this. MkTO makes use of knowledge of
various attributes of a text object. MkTO has NO way of knowing
whether a normal text of a wtext object should be created. The
compiler will thus have to do some more work here and preobably call
another primitive!  See evval2:txtCstVal:asgToRefAdr; note that
sematt.textDesc[] is returned as the type of the result. In
asgToRefAdr it should be possible to find out about the qualification
of the destination (text or wtext).

<P>
Text constants will have to be able to contain 16-bit characters; not
yet implemented.

<P>
The file pattern will also have to be reconsidered
<P>

1. a wFile pattern may be implemented with all char and text variables
   replaced by wchar and wText
<P>

2. It must be possible to open a wFile as a UniCode file or
   an ASCII file
<P>  

For the compiler and MPS there are additional issues
<P>  

3. We must decide exactly which letters acn be used for identifiers.
   Currently it is ony "a-z", and "A-Z". Should we allow non-english letters?

<P>  
4. MPS packs text/names in the AST. For string we may have to store
   full UniCode strings. For identifiers we will have to decide whether
   we allow 16-bit chars in identifiers.

<P>  
In the long run wchar, wStream, wText and wFile should replace char, 
stream, text and file.
 
<P>  
The names wchar, wStream, wText and wFile are preliminary.

<P>
An example of a program using wText may be found in

<PRE>
        /users/olm/beta/UNICODE/udemo.bet
</PRE>

</PRE>

<H2>References</H2>

<DL>

<DT><A NAME="unicode">[UNICODE]</A>
<DD><EM><A HREF="http://www.unicode.org" target=_top>
Unicode Consortium</A></EM>
<P>

<DT><A NAME="olestr">[OLESTR]</A>
<DD><EM><A
HREF="http://premium.microsoft.com/msdn/library/techart/html/article3.htm"
target=_top>Strings The OLE Way</A></EM> from the <A
HREF="http://premium.microsoft.com/msdn/library/" target=_top>Microsoft
Developer Network Online Library</A>.
<P>

<DT><A NAME="macunicode">[MACUNICODE]</A>
<DD><EM><A
HREF="http://devworld.apple.com/dev/techsupport/insidemac/TextEncodingCMgr/TECRefBook-145.html"
target=_top>Inside Macintosh: Unicode</A></EM> from <A
HREF="http://devworld.apple.com/dev/techsupport/insidemac/TextEncodingCMgr/TECRefBook-2.html"
target=_top>Inside Macintosh: Programming With the Text Encoding Conversion Manager</A>.
<P>

</DL>


</BODY>
</HTML>