(* This file is an initial attempt to create a BETA compiler generating
 * byte code for the betaVM in MiniSystem/VM
 * A number of new files with prefix bvm for BetaVM are created
 * At this stage notning is working
*)
ORIGIN  'compiler';
(*INCLUDE '~beta/basiclib/systemenv';*)
INCLUDE '~beta/guienv/guienvsystemenv';
INCLUDE '~beta/guienv/guienv';
INCLUDE '~beta/sysutils/envstring';
BODY 'SYNTHESIZER/synthesizer';
BODY 'CONTROL/translate_asmbody';
BODY 'GENERATOR/BYTECODE/bytecodebackend';
BODY 'GENERATOR/BYTECODE/bytecodetarget';
INCLUDE '~beta/MiniSystem/VM/betaVM'
BODY 'GENERATOR/BYTECODE/bytecodebackend_bvmbody';
INCLUDE 'GENERATOR/machine';

(* INCLUDE '~beta/profiler/profiler'; *)
-----program: descriptor---
systemEnv
(# VM: @betaVM
   (# putCH:: (# do ch -> put #);
      getCh:: (# do get -> ch #);
   #);
   theMch: ^ MachineFactory.ByteCodeMachine;

   setWindowEnv:: (# do myWindowEnv[] -> theWindowEnv[]#);
   myWIndowEnv: @ guienv;
   IC: @BvmInteractiveCompiler;
   (* prof: @Profiler;*)
   
   BvmInteractiveCompiler: InteractiveCompiler
     (# ActivateCompiler::
          (* Force regeneration of rootfragment, 
           * assuming it has program slot *)
          (# objdir: @directory
               (# delfile: @deletefile
                    (# nosuch::(# do true->continue #);
                       error::(# do true->continue #);
                    #)
               #);
             e: @diskentry;
          do 'bvm' -> objdir.name;
             rootfragment[] -> e.path;
             (if objdir.entry.exists then
                 '.clst' -> (e.path.name.prefix).append -> objdir.delfile;
                 'program.clst' -> objdir.delfile;
             if);
             (if not IC.comp.trans.common.switch[188] then
                 (* Issue warning if using ComponentDotCJ *)
                 (if IC.comp.trans.common.ComponentDotCJ then
                     '\n*** Using Component.java: \n'
                     '    Method xdo() will be called '
                     '(you may need recompile)\n'
                     '    Remember to enable BUILD in '
                     '{tst,beta}env_jvmbody\n'
                       -> putline;
                 if);
             if);
          #);
       setTheMch:: (# do mch[] -> theMch[] #);
     #);
    runMode: @integer;
    FN: ^ text
do (* prof.prepare;
    * true -> prof.switch;
    *)
   
   true -> IC.comp.trans.common.switch[120];
   true -> IC.comp.trans.common.switch[121];
   true -> IC.comp.trans.common.switch[122];
   true -> IC.comp.trans.common.switch[129];
   true -> IC.comp.trans.common.switch[182];
   true -> IC.comp.trans.common.switch[14];  (* NO refNone check *)
   true -> IC.comp.trans.common.switch[327]; (* Use Component.java *)
   true -> IC.comp.trans.common.switch[33]; (* do not execute job-file *)

   (* Supress noise in compiler distributed *)
   true -> IC.comp.trans.common.switch[188];

   'bvm' -> IC.comp.targetMachine;

   IC;
   (*theMch.mstate.bvm.descs[] -> VM.descs[];*)
   true -> theMch.mstate.bvm.descs.newAlloc;
   'trace.bet' -> FN[];
   run_Beta_INT -> runMode;
   (runMode,true) -> VM.init;
   (theMch.mstate.bvm.descs[],6,FN[],runMode) -> VM.execute.init;
   VM.execute[] -> fork;
   (* false -> prof.switch;
    * prof.conclude;
    *)
#)
