ORIGIN '~beta/basiclib/v1.4/basicsystemenv';
INCLUDE '~beta/guienv/v1.3/guienvsystemenv'
        '~beta/guienv/v1.3/utils/simplemenu'
        '~beta/sourcebrowser/v0.1/ymer';
-- program: Descriptor --
systemenv
  (#
     fragmentBrowser: @ymerApplication
       (#
          edenv: ^editorEnv;
          ymerBrowserWindow:: 
            (#
               eventhandler::  (#  #);
               open::  (#  #);
               theSifTextEditor: ^sifTextEditor;
               cfe: (* current form editor *) ^theSifTextEditor.codeViewerType;
               cbg: (* current browser group *)
                 ^browser.currentProject.groups.element;
               cge: (* current group editor *) ^edenv.groupEditor;
               cff: (* current fragment form *) ^mps.ast.fragmentform;
               formEditorExists:
                 (# exists: @boolean
                 do
                    browser.getFragmentFormEditor->theSifTextEditor[];
                    (if theSifTextEditor[] <> none then
                        (if theSifTextEditor.sifViewer[] <> none then
                            theSifTextEditor.sifViewer[]->cfe[];
                            true->exists;
                            INNER formEditorExists
                        if)
                    if)
                 exit exists
                 #);
               groupEditorExists:
                 (# exists: @boolean
                 do
                    (if browser[] <> none then
                        '1 '->putLine;
                        browser.currentgroup[]->cbg[];
                        '2 '->putLine;
                        browser.currentForm[]->cff[];
                        '3 '->putLine;
                        (if cbg[] <> none then
                            (if edenv[] <> none then
                                (if edenv.groupEditorList[] <> none then
                                    '4 '->putLine;
                                    cbg.fg[]
                                      ->edenv.groupEditorList.findGroupEditor
                                      ->cge[];
                                    '5 '->putLine;
                                    (if cge[] <> none then
                                        true->exists; INNER groupEditorExists
                                    if)
                                if)
                            if)
                        if)
                    if)
                 exit exists
                 #);
               updateBrowser:
                 (# 
                 do (browser.currentProject[],cbg[])->browser.setGroup
                 #);
               menubarType:: 
                 (#
                    GroupEdit: @simplemenu
                      (#
                         iInsertDescriptorFragmentForm: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   groupEditorExists
                                     (# 
                                     do cge.askInsertPermission->value
                                     #)
                                #);
                              onSelect:: 
                                (# ff: ^mps.ast.fragmentForm
                                do
                                   cge.fg.fullName->putLine;
                                   (if cff[] <> none then
                                       cff.name->putLine;
                                       (cff[],2)->cge.insertForm->ff[]
                                   if);
                                   cge.hello;
                                   (browser.currentProject[],none )
                                     ->browser.setGroup;
                                   (browser.currentProject[],cbg[])
                                     ->browser.setGroup;
                                   (browser.currentProject[],cbg[],ff[])
                                     ->browser.setFragmentForm
                                #)
                           #);
                         open:: 
                           (# 
                           do
                              'Insert Descriptor Fragment form'
                                ->iInsertDescriptorFragmentForm.new
                           #)
                      #);
                    Edit: @simplemenu
                      (#
                         eventHandler::< 
                           (#
                              onSelect::< 
                                (# 
                                do
                                (* (if formEditorExists then
                                 'menu enable does not work!!'->putLine; enable
                                 else
                                 'menu disable does not work!!'->putLine; disable
                                 if)*) 
                                #)
                           #);
                         iUndo: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   formEditorExists
                                     (#  do cfe.askUndoPermission->value #)
                                #);
                              onSelect::  (#  do cfe.doUndo #)
                           #);
                         iCut: @item
                           (#
                              onStatus::  (#  do formEditorExists->value #);
                              onSelect::  (#  do cfe.doCut;  #)
                           #);
                         iCopy: @item
                           (#
                              onStatus::  (#  do formEditorExists->value #);
                              onSelect::  (#  do cfe.doCopy;  #)
                           #);
                         iPaste: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   formEditorExists
                                     (#  do cfe.askPastePermission->value #)
                                #);
                              onSelect::  (#  do cfe.doPaste #)
                           #);
                         iTextedit: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   formEditorExists
                                     (# 
                                     do
                                        (if cfe.askTextEditMode then
                                            'Parse Text'->THIS(item).name
                                         else
                                            'Edit Text'->THIS(item).name
                                        if);
                                        true->value
                                     #)
                                #);
                              onSelect:: 
                                (# 
                                do
                                   (if cfe.askTextEditMode then
                                       cfe.doParseText
                                    else
                                       cfe.doTextEdit
                                   if);
                                   
                                #)
                           #);
                         iRevertTextEdit: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   formEditorExists
                                     (#  do cfe.askTexteditMode->value #)
                                #);
                              onSelect::  (#  do cfe.doRevertTextEdit;  #)
                           #);
                         iShowTexteditCommands: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   formEditorExists
                                     (#  do cfe.askTexteditMode->value #)
                                #);
                              onSelect:: 
                                (#  do cfe.doShowTexteditCommands;  #)
                           #);
                         iInsertBefore: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   formEditorExists
                                     (# 
                                     do cfe.askInsertPermission->value
                                     #)
                                #);
                              onSelect::  (#  do cfe.doInsertBefore #)
                           #);
                         iInsertAfter: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   formEditorExists
                                     (# 
                                     do cfe.askInsertPermission->value
                                     #)
                                #);
                              onSelect::  (#  do cfe.doInsertAfter #)
                           #);
                         iRemoveOptionals: @item
                           (#
                              onStatus::  (#  do formEditorExists->value #);
                              onSelect::  (#  do cfe.doRemoveOptionals #)
                           #);
                         iShowOptionals: @item
                           (#
                              onStatus::  (#  do formEditorExists->value #);
                              onSelect::  (#  do cfe.doShowOptionals #)
                           #);
                         open:: 
                           (# 
                           do
                              ('Undo','z')->iUndo.newkey;
                              newSeparator;
                              ('Cut','x')->iCut.newkey;
                              ('Copy','c')->iCopy.newKey;
                              ('Paste','v')->iPaste.newKey;
                              newSeparator;
                              ('Textedit','t')->iTextEdit.newKey;
                              'Revert Textedit'->iRevertTextEdit.new;
                              'Show Textedit commands'
                                ->iShowTextEditCommands.new;
                              newSeparator;
                              ('Insert Before','b')->iInsertBefore.newKey;
                              ('Insert After','a')->iInsertAfter.newKey;
                              newSeparator;
                              ('Remove Optionals','r')->iRemoveOptionals.newKey;
                              ('Show Optionals','s')->iShowOptionals.newKey
                           #);
                         
                      #);
                    View: @simplemenu
                      (#
                         eventHandler::< 
                           (#
                              onSelect::< 
                                (# 
                                do
                                (* (if formEditorExists then
                                 'menu enable does not work!!'->putLine; enable
                                 else
                                 'menu disable does not work!!'->putLine; disable
                                 if)*) 
                                #)
                           #);
                         iAbstract: @item
                           (#
                              onStatus::  (#  do formEditorExists->value #);
                              onSelect::  (#  do cfe.doAbstract #)
                           #);
                         iAbstractRecursively: @item
                           (#
                              onStatus::  (#  do formEditorExists->value #);
                              onSelect:: 
                                (#  do cfe.doAbstractRecursively;  #)
                           #);
                         iOverview: @item
                           (#
                              onStatus::  (#  do formEditorExists->value #);
                              onSelect::  (#  do cfe.doOverview;  #)
                           #);
                         iDetail: @item
                           (#
                              onStatus::  (#  do formEditorExists->value #);
                              onSelect::  (#  do cfe.doDetail #)
                           #);
                         iDetailRecursively: @item
                           (#
                              onStatus::  (#  do formEditorExists->value #);
                              onSelect:: 
                                (#  do cfe.doDetailRecursively;  #)
                           #);
                         iReprettyprint: @item
                           (#
                              onStatus::  (#  do formEditorExists->value #);
                              onSelect::  (#  do cfe.doReprettyprint;  #)
                           #);
                         open:: 
                           (# 
                           do
                              'Abstract'->iAbstract.new;
                              'Astract Recursively'->iAbstractRecursively.new;
                              ('Overview','o')->iOverview.newkey;
                              ('Detail','d')->iDetail.newkey;
                              'Detail Recursively'->iDetailRecursively.new;
                              newSeparator;
                              ('Reprettyprint','p')->iReprettyprint.newKey;
                              
                           #);
                         
                      #);
                    open::  (#  do GroupEdit.new; Edit.new; View.new #)
                 #)
            #);
          init:: 
            (# 
            do
               objectPool.get
                 (#
                    type:: editorEnv;
                    init:: 
                      (# 
                      do
                         'init editorEnv from Ymer'->putLine;
                         (mps.ast[],mps.betaCFL[],fragmentBrowser[])->obj.init
                      #)
                 #)->edenv[]
            #);
          
       #);
     setWindowEnv::  (#  do fragmentBrowser[]->theWindowEnv[] #)
  do
  (*(if noOfArguments<>2 then
   *    'ERROR: Illegal number of arguments'->screen.putline;
   *    (normal,'Usage: ymer machineType')->stop
   *  else
   *    2->arguments->*) fragmentBrowser.init (*if)*)
  #)  

