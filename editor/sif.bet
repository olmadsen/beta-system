ORIGIN '~beta/basiclib/v1.4/basicsystemenv';
INCLUDE '~beta/guienv/v1.3.1/guienvsystemenv'
        '~beta/guienv/v1.3.1/utils/simplemenu'
        '~beta/sourcebrowser/v0.1/ymer';
-- program: Descriptor --
systemenv
  (#
     fragmentBrowser: @ymerApplication
       (#
          edenv: ^ymerBrowser.editorEnv;
          ymerBrowserWindow:: 
            (#
               eventhandler::  (#  #);
               open::  (#  #);
               theSifTextEditor: ^sifTextEditor;
               cfe: (* current form editor *) ^theSifTextEditor.codeViewerType;
               cbg: (* current browser group *) ^browser.projects.group;
               cge: (* current group editor *) ^edenv.groupEditor;
               cff: (* current fragment form *) ^mps.ast.fragmentform;
               formEditorExists:
                 (# exists: @boolean
                 do
                    browser.getFragmentFormEditor->theSifTextEditor[];
                    (if theSifTextEditor[] <> none then
                        (if theSifTextEditor.sifViewer[] <> none then
                            theSifTextEditor.sifViewer[]->cfe[];
                            true->exists;
                            INNER formEditorExists
                        if)
                    if)
                 exit exists
                 #);
               groupEditorExists:
                 (# exists: @boolean
                 do
                    (if browser[] <> none then
                        browser.currentgroup[]->cbg[];
                        browser.currentForm[]->cff[];
                        (if cbg[] <> none then
                            (if edenv[] <> none then
                                (if edenv.groupEditorList[] <> none then
                                    cbg.fg[]
                                      ->
                                        edenv.groupEditorList.
                                          findOrCreateGroupEditor->cge[];
                                    (if cge[] <> none then
                                        true->exists; INNER groupEditorExists
                                    if)
                                if)
                            if)
                        if)
                    if)
                 exit exists
                 #);
               updateBrowser:
                 (# fg: ^mps.ast.fragmentGroup; ff: ^mps.ast.fragmentForm
                 enter (fg[],ff[])
                 do
                    (browser.currentProject[],none )->browser.setGroup;
                    (browser.currentProject[],cbg[])->browser.setGroup;
                    (if ff[] <> none then
                        (browser.currentProject[],cbg[],ff[])
                          ->browser.setFragmentForm
                    if)
                 #);
               menubarType:: 
                 (#
                    GroupFile: @simplemenu
                      (#
                         iNew: @item
                           (#
                              onStatus::  (#  do false->value #);
                              onSelect:: 
                                (#
                                   ff: ^mps.ast.fragmentForm;
                                   ge: ^edenv.groupEditor
                                do
                                   edenv.new->ge[];
                                   ge.fg.fragmentlist.scan
                                     (# 
                                     do
                                        (if current.type = mps.ast.formType then
                                            current.f[]->ff[]
                                        if)
                                     #);
                                   (ge.fg.fullName,ff.name)
                                     ->browser.selectFragmentForm
                                #)
                           #);
                         iNewBetaProgram: @item
                           (#
                              onStatus::  (#  do true->value #);
                              onSelect:: 
                                (#
                                   ff: ^mps.ast.fragmentForm;
                                   ge: ^edenv.groupEditor
                                do
                                   edenv.newBetaProgram->ge[];
                                   ge.fg.fragmentlist.scan
                                     (# 
                                     do
                                        (if current.type = mps.ast.formType then
                                            current.f[]->ff[]
                                        if)
                                     #);
                                   (if ff[] = none then
                                       'ff is none!'->putLine
                                    else
                                       ff.name->putLine;
                                       (ff.father).fullName->putLine
                                   if);
                                   (ge.fg.fullName,ff.name)
                                     ->browser.selectFragmentForm
                                #)
                           #);
                         iNewBetaLibrary: @item
                           (#
                              onStatus::  (#  do true->value #);
                              onSelect:: 
                                (#
                                   ff: ^mps.ast.fragmentForm;
                                   ge: ^edenv.groupEditor
                                do
                                   edenv.newBetaLibrary->ge[];
                                   ge.fg.fragmentlist.scan
                                     (# 
                                     do
                                        (if current.type = mps.ast.formType then
                                            current.f[]->ff[]
                                        if)
                                     #);
                                   (ge.fg.fullName,ff.name)
                                     ->browser.selectFragmentForm
                                #)
                           #);
                         iSave: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   groupEditorExists
                                     (#  do true->value #)
                                #);
                              onSelect::  (#  do cge.save #)
                           #);
                         iSaveAs: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   groupEditorExists
                                     (#  do true->value #);
                                   false->value
                                #);
                              onSelect::  (#  do cge.saveAs #)
                           #);
                         iSaveAbstract: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   groupEditorExists
                                     (#  do true->value #);
                                   false->value
                                #);
                              onSelect::  (#  do cge.saveabstract #)
                           #);
                         iRecover: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   groupEditorExists
                                     (#  do true->value #);
                                   false->value
                                #);
                              onSelect::  (#  do cge.recover #)
                           #);
                         iRevert: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   groupEditorExists
                                     (#  do true->value #);
                                   false->value
                                #);
                              onSelect::  (#  do cge.revert #)
                           #);
                         open:: 
                           (# 
                           do
                              'New...'->iNew.new;
                              'New BETA Program'->iNewBetaProgram.new;
                              'New BETA Library'->iNewBetaLibrary.new;
                              newSeparator;
                              'Save'->iSave.new;
                              'Save As...'->iSaveAs.new;
                              'Save Abstract...'->iSaveAbstract.new;
                              newSeparator;
                              'Recover'->iRecover.new;
                              'Revert'->iRevert.new
                           #)
                      #);
                    GroupEdit: @simplemenu
                      (#
                         iUndo: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   groupEditorExists
                                     (#  do cge.askUndoPermission->value #)
                                #);
                              onSelect:: 
                                (# 
                                do cge.undo; (cge.fg[],none )->updateBrowser
                                #)
                           #);
                         iCut: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   groupEditorExists
                                     (#  do (cff[] <> none )->value #)
                                #);
                              onSelect:: 
                                (# 
                                do
                                   cff[]->cge.cutForm;
                                   (cge.fg[],none )->updateBrowser
                                #)
                           #);
                         iCopy: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   groupEditorExists
                                     (#  do (cff[] <> none )->value #)
                                #);
                              onSelect::  (#  do cff[]->cge.copyForm #)
                           #);
                         iPaste: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   groupEditorExists
                                     (# 
                                     do
                                        (if cff[] <> none then
                                            cff[]->cge.askPastePermission->value
                                        if)
                                     #)
                                #);
                              onSelect:: 
                                (# ff: ^mps.ast.fragmentForm
                                do
                                   cff[]->cge.pasteForm->ff[];
                                   (cge.fg[],ff[])->updateBrowser
                                #)
                           #);
                         iAppend: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   groupEditorExists
                                     (# 
                                     do none ->cge.askPastePermission->value
                                     #)
                                #);
                              onSelect:: 
                                (# ff: ^mps.ast.fragmentForm
                                do
                                   none ->cge.pasteForm->ff[];
                                   (cge.fg[],ff[])->updateBrowser
                                #)
                           #);
                         iInsertDescriptorFragmentForm: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   groupEditorExists
                                     (# 
                                     do cge.askInsertPermission->value
                                     #)
                                #);
                              onSelect:: 
                                (# ff: ^mps.ast.fragmentForm
                                do
                                   (cff[],2)->cge.insertForm->ff[];
                                   (cge.fg[],ff[])->updateBrowser
                                #)
                           #);
                         iInsertAttributesFragmentForm: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   groupEditorExists
                                     (# 
                                     do cge.askInsertPermission->value
                                     #)
                                #);
                              onSelect:: 
                                (# ff: ^mps.ast.fragmentForm
                                do
                                   (cff[],3)->cge.insertForm->ff[];
                                   (cge.fg[],ff[])->updateBrowser
                                #)
                           #);
                         iInsertDoPartFragmentForm: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   groupEditorExists
                                     (# 
                                     do cge.askInsertPermission->value
                                     #)
                                #);
                              onSelect:: 
                                (# ff: ^mps.ast.fragmentForm
                                do
                                   (cff[],31)->cge.insertForm->ff[];
                                   (cge.fg[],ff[])->updateBrowser
                                #)
                           #);
                         iEditProperties: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   groupEditorExists
                                     (#  do true->value #)
                                #);
                              onSelect:: 
                                (# 
                                do
                                   cge.editProperties;
                                   (cge.fg[],none )->updateBrowser
                                #)
                           #);
                         iEditFormName: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   groupEditorExists
                                     (#  do (cff[] <> none )->value #)
                                #);
                              onSelect:: 
                                (# ff: ^mps.ast.fragmentForm
                                do
                                   cff[]->cge.editFormName;
                                   (cge.fg[],cff[])->updateBrowser
                                #)
                           #);
                         open:: 
                           (# 
                           do
                              'Undo'->iUndo.new;
                              newSeparator;
                              'Cut'->iCut.new;
                              'Copy'->iCopy.new;
                              'Paste Before'->iPaste.new;
                              'Paste Append'->iAppend.new;
                              newSeparator;
                              'Insert Descriptor Fragment form...'
                                ->iInsertDescriptorFragmentForm.new;
                              'Insert Attributes Fragment Form...'
                                ->iInsertAttributesFragmentForm.new;
                              'Insert DoPart Fragment Form...'
                                ->iInsertDoPartFragmentForm.new;
                              newSeparator;
                              'Edit Properties... '->iEditProperties.new;
                              'Edit Fragment name...'->iEditFormName.new
                           #)
                      #);
                    GroupPerform: @simplemenu
                      (#
                         iCheck: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   groupEditorExists
                                     (#  do true->value #)
                                #);
                              onSelect::  (#  do  #)
                           #);
                         iReCheck: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   groupEditorExists
                                     (#  do true->value #)
                                #);
                              onSelect::  (#  do  #)
                           #);
                         iCompile: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   groupEditorExists
                                     (#  do true->value #)
                                #);
                              onSelect::  (#  do  #)
                           #);
                         iRecompile: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   groupEditorExists
                                     (#  do true->value #)
                                #);
                              onSelect::  (#  do  #)
                           #);
                         iExecute: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   groupEditorExists
                                     (#  do true->value #)
                                #);
                              onSelect::  (#  do  #)
                           #);
                         iReExecute: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   groupEditorExists
                                     (#  do true->value #)
                                #);
                              onSelect::  (#  do  #)
                           #);
                         iDebug: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   groupEditorExists
                                     (#  do true->value #)
                                #);
                              onSelect::  (#  do  #)
                           #);
                         iSemanticErrors: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   groupEditorExists
                                     (#  do true->value #)
                                #);
                              onSelect::  (#  do  #)
                           #);
                         iSemanticLinks: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   groupEditorExists
                                     (#  do true->value #)
                                #);
                              onSelect::  (#  do  #)
                           #);
                         open:: 
                           (# 
                           do
                              'Check Active'->iCheck.new;
                              'Recheck'->iReCheck.new;
                              'Compile Active'->iCompile.new;
                              'Recompile'->iRecompile.new;
                              'Execute Active'->iExecute.new;
                              'Reexecute'->iReExecute.new;
                              'Debug'->iDebug.new;
                              newSeparator;
                              'Semantic Errors...'->iSemanticErrors.new;
                              'Semantic Links'->iSemanticLinks.new
                           #)
                      #);
                    Edit: @simplemenu
                      (#
                         eventHandler::< 
                           (#
                              onSelect::< 
                                (# 
                                do
                                (* (if formEditorExists then
                                 'menu enable does not work!!'->putLine; enable
                                 else
                                 'menu disable does not work!!'->putLine; disable
                                 if)*) 
                                #)
                           #);
                         iUndo: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   formEditorExists
                                     (#  do cfe.askUndoPermission->value #)
                                #);
                              onSelect::  (#  do cfe.doUndo #)
                           #);
                         iCut: @item
                           (#
                              onStatus::  (#  do formEditorExists->value #);
                              onSelect::  (#  do cfe.doCut;  #)
                           #);
                         iCopy: @item
                           (#
                              onStatus::  (#  do formEditorExists->value #);
                              onSelect::  (#  do cfe.doCopy;  #)
                           #);
                         iPaste: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   formEditorExists
                                     (#  do cfe.askPastePermission->value #)
                                #);
                              onSelect::  (#  do cfe.doPaste #)
                           #);
                         iTextedit: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   formEditorExists
                                     (# 
                                     do
                                        (if cfe.askTextEditMode then
                                            'Parse Text'->THIS(item).name
                                         else
                                            'Edit Text'->THIS(item).name
                                        if);
                                        true->value
                                     #)
                                #);
                              onSelect:: 
                                (# 
                                do
                                   (if cfe.askTextEditMode then
                                       cfe.doParseText
                                    else
                                       cfe.doTextEdit
                                   if);
                                   
                                #)
                           #);
                         iRevertTextEdit: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   formEditorExists
                                     (#  do cfe.askTexteditMode->value #)
                                #);
                              onSelect::  (#  do cfe.doRevertTextEdit;  #)
                           #);
                         iShowTexteditCommands: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   formEditorExists
                                     (#  do cfe.askTexteditMode->value #)
                                #);
                              onSelect:: 
                                (#  do cfe.doShowTexteditCommands;  #)
                           #);
                         iInsertBefore: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   formEditorExists
                                     (# 
                                     do cfe.askInsertPermission->value
                                     #)
                                #);
                              onSelect::  (#  do cfe.doInsertBefore #)
                           #);
                         iInsertAfter: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   formEditorExists
                                     (# 
                                     do cfe.askInsertPermission->value
                                     #)
                                #);
                              onSelect::  (#  do cfe.doInsertAfter #)
                           #);
                         iRemoveOptionals: @item
                           (#
                              onStatus::  (#  do formEditorExists->value #);
                              onSelect::  (#  do cfe.doRemoveOptionals #)
                           #);
                         iShowOptionals: @item
                           (#
                              onStatus::  (#  do formEditorExists->value #);
                              onSelect::  (#  do cfe.doShowOptionals #)
                           #);
                         open:: 
                           (# 
                           do
                              ('Undo','z')->iUndo.newkey;
                              newSeparator;
                              ('Cut','x')->iCut.newkey;
                              ('Copy','c')->iCopy.newKey;
                              ('Paste','v')->iPaste.newKey;
                              newSeparator;
                              ('Textedit','t')->iTextEdit.newKey;
                              'Revert Textedit'->iRevertTextEdit.new;
                              'Show Textedit commands'
                                ->iShowTextEditCommands.new;
                              newSeparator;
                              ('Insert Before','u')->iInsertBefore.newKey;
                              ('Insert After','a')->iInsertAfter.newKey;
                              newSeparator;
                              ('Remove Optionals','r')->iRemoveOptionals.newKey;
                              ('Show Optionals','s')->iShowOptionals.newKey
                           #);
                         
                      #);
                    View: @simplemenu
                      (#
                         eventHandler::< 
                           (#
                              onSelect::< 
                                (# 
                                do
                                (* (if formEditorExists then
                                 'menu enable does not work!!'->putLine; enable
                                 else
                                 'menu disable does not work!!'->putLine; disable
                                 if)*) 
                                #)
                           #);
                         iAbstract: @item
                           (#
                              onStatus::  (#  do formEditorExists->value #);
                              onSelect::  (#  do cfe.doAbstract #)
                           #);
                         iAbstractRecursively: @item
                           (#
                              onStatus::  (#  do formEditorExists->value #);
                              onSelect:: 
                                (#  do cfe.doAbstractRecursively;  #)
                           #);
                         iOverview: @item
                           (#
                              onStatus::  (#  do formEditorExists->value #);
                              onSelect::  (#  do cfe.doOverview;  #)
                           #);
                         iDetail: @item
                           (#
                              onStatus::  (#  do formEditorExists->value #);
                              onSelect::  (#  do cfe.doDetail #)
                           #);
                         iDetailRecursively: @item
                           (#
                              onStatus::  (#  do formEditorExists->value #);
                              onSelect:: 
                                (#  do cfe.doDetailRecursively;  #)
                           #);
                         iReprettyprint: @item
                           (#
                              onStatus::  (#  do formEditorExists->value #);
                              onSelect::  (#  do cfe.doReprettyprint;  #)
                           #);
                         findAndSelect:
                           (# node: ^mps.ast.ast
                           enter node[]
                           do
                              (if node[] <> none then
                                  (if node.frag[] <> cfe.frag[] then
                                      'not same frag'->putLine;
                                      ((node.frag.father).fullName,
                                       node.frag.name)
                                        ->browser.selectFragmentForm;
                                      (if formEditorExists then
                                          'no formeditor?'->putLine;
                                          (node[],1,0,0)->cfe.setFocus
                                       else
                                          'formeditor not found'->putLine
                                      if)
                                   else
                                      'same frag'->putLine;
                                      (node[],1,0,0)->cfe.setFocus
                                  if)
                               else
                                  'findAndSelect: node is none!'->putLine
                              if)
                           #);
                         iBack: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   formEditorExists
                                     (# 
                                     do
                                        cfe.cs.node[]
                                          ->edenv.history.BackPossible->value
                                     #)
                                #);
                              onSelect:: 
                                (# 
                                do
                                   cfe.cs.node[]->edenv.history.back
                                     ->findAndSelect
                                #)
                           #);
                         iForward: @item
                           (#
                              onStatus:: 
                                (# 
                                do
                                   false->value;
                                   formEditorExists
                                     (# 
                                     do
                                        cfe.cs.node[]
                                          ->edenv.history.ForwardPossible->value
                                     #)
                                #);
                              onSelect:: 
                                (# 
                                do
                                   cfe.cs.node[]->edenv.history.forward
                                     ->findAndSelect
                                #)
                           #);
                         open:: 
                           (# 
                           do
                              'Abstract'->iAbstract.new;
                              'Astract Recursively'->iAbstractRecursively.new;
                              ('Overview','o')->iOverview.newkey;
                              ('Detail','d')->iDetail.newkey;
                              'Detail Recursively'->iDetailRecursively.new;
                              newSeparator;
                              ('Reprettyprint','p')->iReprettyprint.newKey;
                              newSeparator;
                              ('Back','b')->iBack.newKey;
                              ('Forward','f')->iForward.newKey;
                              
                           #);
                         
                      #);
                    open:: 
                      (# 
                      do
                         GroupFile.new;
                         GroupEdit.new;
                         GroupPerform.new;
                         Edit.new;
                         View.new
                      #)
                 #)
            #);
          init:: 
            (# 
            do
               objectPool.get
                 (#
                    type:: ymerBrowser.editorEnv;
                    init:: 
                      (# 
                      do
                         'init editorEnv from Ymer'->putLine;
                         (mps.ast[],mps.betaCFL[],fragmentBrowser[])->obj.init
                      #)
                 #)->edenv[]
            #);
          
       #);
     setWindowEnv::  (#  do fragmentBrowser[]->theWindowEnv[] #)
  do
  (*(if noOfArguments<>2 then
   *    'ERROR: Illegal number of arguments'->screen.putline;
   *    (normal,'Usage: ymer machineType')->stop
   *  else
   *    2->arguments->*) fragmentBrowser.init (*if)*)
  #)  

