ORIGIN 'siftexteditorbody';
INCLUDE '~beta/guienv/private/winnt/fields_ntibody'
        '~beta/guienv/fields'
        '~beta/toollibs/preferences/toolpreferences';
(*
 * COPYRIGHT
 *   Copyright (C) Aarhus University
 *   All rights reserved.
 *)
-- siftexteditorSetBindings: Descriptor --
(# p: ^editorpreferences; font: @text; fontsize: @integer; 
do
(*   objectpool.get (# type::< editorpreferences #)->p[];
 p.gettext (#  do 'StdFontFace'->name[] #)->font;
 p.getInteger (#  do 'StdFontSize'->name[] #)->fontsize;
 (if font[] <> none then
 (0,contents.length,font[])->contents.setonefont
 else
 (0,contents.length,'courier')->contents.setonefont; 
 if);
 (if fontsize > 5 then
 (0,contents.length,fontsize)->contents.setoneSize; 
 if);
 *) 
#)  

-- siftexteditorCharWidthType: Descriptor --
(# sz: @Point; count,sum: @Integer; ch: @Char
do
   thisOp:
     (# 
     do
        (if ts[]
         // none then
            contents.defaultStyle->ts[];
            (if ts[]
             // none then
                (if sifViewer.switch[14] then 'ts is none'->putLine if);
                INNER charWidthType;
                (if ts[]
                 // none then
                    (if sifViewer.switch[14] then
                        'ts is none, value is set to 80'->putLine
                    if);
                    80->value;
                    leave thisOp (*not good: system.systemTextStyle[]->ts[]; *)
                if);
                
            if);
            
        if);
        'a'->ch;
        loop:
        (if ch <= 'z' then
            (ch->ts.widthOfChar)+sum->sum;
            (if sifViewer.switch[14] then
                '<'->put;
                ch->put;
                '> '->putText;
                ch->ts.widthOfChar->putInt;
                newLine
            if);
            (ch->ascii.upcase->ts.widthOfChar)+sum->sum;
            (if sifViewer.switch[14] then
                '<'->put;
                ch->ascii.upcase->put;
                '> '->putText;
                ch->ascii.upcase->ts.widthOfChar->putInt;
                newLine
            if);
            count+2->count;
            ch+1->ch;
            restart loop;
            
        if);
        '0'->ch;
        loop:
        (if ch <= '9' then
            (ch->ts.widthOfChar)+sum->sum;
            (if sifViewer.switch[14] then
                '<'->put;
                ch->put;
                '> '->putText;
                ch->ts.widthOfChar->putInt;
                newLine
            if);
            count+1->count;
            ch+1->ch;
            restart loop;
            
        if);
        viewsize.h div (sum div count)->value
     #)
#)  

-- siftexteditorUpdate: Descriptor --
(#  do contents.update #)  

-- siftexteditorSetTexteditStyle: DoPart --
do
     (# cf: @CHARFORMAT; windowID: @integer; 
     do
        sizeOfCharFormat->malloc->cf.ptr;
        (if cf.ptr <> 0 then
            THIS(textField).interfaceObjectID->windowID;
            (cf.ptr,0,sizeOfCharFormat)->memset;
            sizeOfCharFormat->cf.cbSize;
            CFM_COLOR+CFM_UNDERLINE->cf.dwMask;
            (if ((COLOR_WINDOWTEXT->GetSysColor) = 0x00800080) then
                0x00808000->cf.crTextColor; 
             else
                0x00800080->cf.crTextColor; 
            if);
            (windowID,EM_SETCHARFORMAT,0x0001,cf.ptr)->SendMessage;
            cf.ptr->free;
            
        if);
        
     #)  

-- siftexteditorSetTextStyle: DoPart --
do
     (#
        cf: @CHARFORMAT;
        windowID: @integer;
        red: (#  exit (65280,0,0) #);
        yellow: (#  exit (65280,65280,0) #);
        orange: (#  exit (65280,32640,0) #);
        green: (#  exit (0,65280,0) #);
        blue: (#  exit (0,0,65280) #);
        theColor: @color;
        theColorRef: @integer;
        makeColorRef:
          (# theColor: ^color; theColorRef: @integer; 
          enter theColor[]
          do
             (if theColor[] <> none then
                 (theColor.red div 256,0)->theColorRef.%putByte;
                 (theColor.green div 256,1)->theColorRef.%putByte;
                 (theColor.blue div 256,2)->theColorRef.%putByte;
                 (2,3)->theColorRef.%putByte;
                 
             if);
             
          exit theColorRef
          #)
     do
        (if style
         // 1 (* textedit *) then
            0x00800080->theColorRef
         // 2 (* semantic errors *) then
            red->theColor; theColor[]->makeColorRef->theColorRef
         // 3 (* search hits *) then
            blue->theColor; theColor[]->makeColorRef->theColorRef
         // 4 (* warnings *) then
            orange->theColor; theColor[]->makeColorRef->theColorRef
         else
            green->theColor; theColor[]->makeColorRef->theColorRef
        if);
        sizeOfCharFormat->malloc->cf.ptr;
        (if cf.ptr <> 0 then
            THIS(textField).interfaceObjectID->windowID;
            (cf.ptr,0,sizeOfCharFormat)->memset;
            sizeOfCharFormat->cf.cbSize;
            CFM_COLOR+CFM_UNDERLINE->cf.dwMask;
            (if ((COLOR_WINDOWTEXT->GetSysColor) = theColorRef) then
                0x00808000->cf.crTextColor; 
             else
                theColorRef->cf.crTextColor; 
            if);
            (windowID,EM_SETCHARFORMAT,0x0001,cf.ptr)->SendMessage;
            cf.ptr->free;
            
        if);
        
     #)  

-- siftexteditorResetTexteditStyle: DoPart --
do
     (# cf: @CHARFORMAT; windowID: @integer; 
     do
        sizeOfCharFormat->malloc->cf.ptr;
        (if cf.ptr <> 0 then
            THIS(textField).interfaceObjectID->windowID;
            (cf.ptr,0,sizeOfCharFormat)->memset;
            sizeOfCharFormat->cf.cbSize;
            CFM_COLOR->cf.dwMask;
            siftexteditorPrivate.textColor->cf.crTextColor;
            (windowID,EM_SETCHARFORMAT,0x0000,cf.ptr)->SendMessage;
            cf.ptr->free
        if);
        
     #)  

-- siftexteditorFormat: DoPart --
do
   0->THIS(textField).private.formatFlags;
   THIS(textField).private.selectCharFormat->siftexteditorPrivate.textColor  

-- siftexteditorAllowFormat: DoPart --
do true->value  

-- siftexteditorPrint: DoPart --
do THIS(textField).private.print  

