ORIGIN '../ymersiflib';
INCLUDE 'editorenvbody';
-- externalInterfaceOpenForm: DoPart --
do
     (# ff: ^edenv.mps.fragmentForm; anAST: ^edenv.mps.ast; help: ^text
     do
        
        (if edenv.trace[11] then
            'Sif ******** Global external interface: openForm'->screen.putline;
            'Sif ******** <<name: '->screen.putText;
            name[]->screen.putText;
            ' index: '->screen.putText;
            (if node[] <> none then
                node.index->screen.putInt
             else
                0->screen.putint
            if);
            '>>'->screen.putLine;
            
        if);
        (if node[] <> none then
            (name[],node.index)->edenv.openForm->(ff[],anAST[])
         else
            (name[],0)->edenv.openForm->(ff[],anAST[])
        if);
        (if ff[] <> none then
            ((ff.father).fullName,ff.name)->browser.selectFragmentForm;
            (ff[],anAST[])->edenv.findEditorForForm->fe[];
            (if fe[] = none then
                'Form editor could not be found or created for '->help[];
                name[]->help.puttext;
                help[]->NoEditorForForm
             else
                true->fe.notifyFreja->fe.isAFrejaEditor
                  ->fe.thisGroupEditor.isAfrejaEditor;
                
            if)
         else
            name[]->help[];
            ' could not be opened'->help.putLine;
            help[]->couldNotOpenFragmentform
        if);
        ;
        
     #)  

-- externalInterfaceGetEditorForForm: DoPart --
do
     (# anAST: ^edenv.mps.ast; help: ^text
     do
        (if edenv.trace[11] then
            'Sif ******** Global external interface: getEditorForForm'
              ->screen.putline;
            'Sif ******** <<ff: '->screen.putText;
            ff.fullname->screen.putText;
            ' index: '->screen.putText;
            (if node[] <> none then
                node.index->screen.putInt
             else
                0->screen.putint
            if);
            '>>'->screen.putLine;
            
        if);
        (if node[] <> none then
            (ff[],node[])->edenv.findEditorForForm->fe[]
         else
            (ff[],ff.root[])->edenv.findEditorForForm->fe[]
        if);
        (if fe[] = none then
            ((ff.father).fullName,ff.name)->browser.selectFragmentForm;
            (ff[],anAST[])->edenv.findEditorForForm->fe[];
            
        if);
        (if fe[] = none then
            'Form editor could not be found or created for '->help[];
            ff.fullname->help.puttext;
            help[]->NoEditorForForm
         else
            true->fe.isAFrejaEditor->fe.thisGroupEditor.isAfrejaEditor; 
        if);
        
     #)  

-- externalInterfaceNewBETAProgram: DoPart --
do
     (#
        fg: ^edenv.mps.fragmentGroup;
        ff: ^edenv.mps.fragmentForm;
        fe: ^codeeditor;
        ge: ^edenv.groupeditor;
        id: @integer;
        help: ^text
     do
        (if edenv.trace[11] then
            'Sif ******** Global external interface: newBETAProgram'
              ->screen.putline;
            'Sif ******** <<name: '->screen.putText;
            name[]->screen.putText;
            '>>'->screen.putLine;
            
        if);
        (ymerCallback.theBrowser[],name[],true)->edenv.newBETAProgram->fg[];
        (if fg[] <> none then
            fg.fullName->addproject;
            true->cge.isAfrejaEditor;
            cge.fg.fragmentlist.scan
              (# 
              do
                 (if current.type = mps.ast.formType then
                     current.f[]->ff[]
                 if)
              #);
            (if ff[] = none then
                'ff is none!'->putLine
             else
            (* (ge.fg.fullName,ff.name)->browser.selectFragmentForm; *)
                ff[]->cge.formEditorList.findEditor->fe[];
                (if fe[] <> none then
                    true->fe.notifyFreja->fe.isAfrejaEditor;
                    fe.newFragmentEvent;
                    fe.id->id
                 else
                    'Form editor not found for '->help[];
                    name[]->help.puttext;
                    help[]->NoEditorForForm
                if)
            if)
         else
            'Could not create formeditor for '->help[];
            name[]->help.putline;
            help[]->NoEditorForForm
        if);
        
     #)  

-- externalInterfaceNewBETALibrary: DoPart --
do
     (#
        fg: ^edenv.mps.fragmentGroup;
        ff: ^edenv.mps.fragmentForm;
        fe: ^codeeditor;
        ge: ^edenv.groupeditor;
        id: @integer;
        help: ^text
     do
        (if edenv.trace[11] then
            'Sif ******** Global external interface: newBETAProgram'
              ->screen.putline;
            'Sif ******** <<name: '->screen.putText;
            name[]->screen.putText;
            '>>'->screen.putLine;
            
        if);
        edenv.showEditors;
        (ymerCallback.theBrowser[],name[],true)->edenv.newBETALibrary->fg[];
        edenv.showEditors;
        (if fg[] <> none then
            fg.fullName->addproject;
            true->cge.isAfrejaEditor;
            edenv.showEditors;
            cge.fg.fragmentlist.scan
              (# 
              do
                 (if current.type = mps.ast.formType then
                     current.f[]->ff[]
                 if)
              #);
            (if ff[] = none then
                'ff is none!'->putLine
             else
            (* (ge.fg.fullName,ff.name)->browser.selectFragmentForm; *)
                ff[]->cge.formEditorList.findEditor->fe[];
                (if fe[] <> none then
                    true->fe.notifyFreja->fe.isAfrejaEditor;
                    fe.newFragmentEvent;
                    fe.id->id
                 else
                    'Form editor not found for '->help[];
                    name[]->help.puttext;
                    help[]->NoEditorForForm
                if)
            if)
         else
            'Could not create formeditor for '->help[];
            name[]->help.putline;
            help[]->NoEditorForForm
        if);
        
     #)  

-- externalInterfaceSaveAndQuit: DoPart --
do
   edenv.groupeditorList.scan
     (# textfile: ^text
     do
        (if (current[] <> none ) then
            (if current.isAfrejaEditor then (true,false)->current.save if)
        if)
     #)  

-- externalInterfaceSave: DoPart --
do
   edenv.groupeditorList.scan
     (# textfile: ^text
     do
        (if (current[] <> none ) then
            (if current.isAfrejaEditor then (true,false)->current.save if)
        if)
     #)  

-- externalInterfaceAutoSave: DoPart --
do
   edenv.groupeditorList.scan
     (# textfile: ^text
     do
        (if current.isAfrejaEditor then
            (if current.touched > 0 then
                ('#',current.fg[])->edenv.editorenvprivate.extendedSaveBackup; 
            if)
         else
            'Is not a freja editor'->screen.putLine; 
        if)
     #)  

-- externalInterfaceCheck: DoPart --
do fg[]->lastCompiledFg[]; fg[]->THIS(ymerBrowserWindow).check  

-- externalInterfaceToggleDebug: DoPart --
do not edenv.trace[1]->edenv.trace[1]  

-- externalInterfaceException: DoPart --
do (if m[] <> none then m->msg if); INNER externalInterfaceException  

-- externalInterfaceSelectEditor: DoPart --
do
   (if formEditorExists then
       (if fe.frag[] <> ymerBrowserPrivate.cfe.frag[] then
           ((fe.frag.father).fullName,fe.frag.name)->browser.selectFragmentForm
       if)
    else
       ((fe.frag.father).fullName,fe.frag.name)->browser.selectFragmentForm
   if)  

