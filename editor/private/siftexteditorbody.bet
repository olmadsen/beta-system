ORIGIN '../codeviewer';
INCLUDE '~beta/guienv/v1.3.1/private/X11/widget';
(* X11 dep. *)
-- siftexteditorSelectArea: DoPart --
do (* Michaels eksperiment start *)
   false->contents.automaticScrolling;
   (* 'false->contents.automaticScrolling;'->putLine;*)
   (if SifViewer.switch[2] then
       'TE.selectArea'->screen.putLine;
       line1->screen.putint;
       ' '->screen.put;
       pos1->screen.putint;
       ' '->screen.put;
       line2->screen.putint;
       ' '->screen.put;
       pos2->screen.putint;
       ' '->screen.put;
       screen.newLine;
       
   if);
   ((line1,pos1)->lineCharToPos,(line2,pos2)->lineCharToPos)
     ->contents.selection;
   (if SifViewer.switch[2] then
       'selection: '->screen.putText;
       contents.selection.start->screen.putint;
       ' '->screen.put;
       contents.selection.end->screen.putint;
       ' '->screen.put;
       screen.newLine;
       
   if);
   true->contents.automaticScrolling;
   (*   ' true->contents.automaticScrolling;'->putLine;*)
     

-- sdeWtexteditordeleteline: Descriptor --
(# pos1,pos2: @integer; 
do
   (if SifViewer.switch[1] then
       'TE.deleteline ***********************'->screen.putLine; showContents
   if);
   (lineno,1)->lineCharToPos->pos1;
   (lineno+1,1)->lineCharToPos->pos2;
   (if SifViewer.switch[2] then
       'lineno: '->putText;
       lineno->putint;
       ' pos1: '->putText;
       pos1->putint;
       ' pos2: '->putText;
       pos2->putint;
       newLine;
       
   if);
   (pos1,pos2)->contents.selection;
   contents.delete (*cut*) ;
   showContents;
   (pos1,pos1)->contents.selection;
   showContents
#)  

-- sdeWtexteditordeletelines: Descriptor --
(# pos1,pos2: @integer; 
do
   (if SifViewer.switch[1] then
       'TE.deletelines ***********************'->screen.putLine; showContents; 
   if);
   (lineno,1)->lineCharToPos->pos1;
   (lineno+number,1)->lineCharToPos->pos2;
   (pos1,pos2)->contents.selection;
   contents.delete (*cut*) ;
   showContents
#)  

-- sdeWtexteditorinsertline: Descriptor --
(# pos1,pos2: @integer; 
do
   (if SifViewer.switch[1] then
       'TE.insertline ***********************'->screen.putLine; 
   if);
   (lineno,1)->lineCharToPos->pos1;
   (if SifViewer.switch[2] then
       'lineno: '->putline;
       lineno->putint;
       ' pos1: '->putline;
       pos1->putint;
       newLine;
       
   if);
   (pos1,pos1)->contents.selection;
   ascii.newline->tt.put;
   tt[]->contents.insert;
   
#)  

-- sdeWtexteditorgetline: Descriptor --
(# pos1,pos2: @integer; 
do
   (if SifViewer.switch[1] then
       'TE.getline ***********************'->screen.putLine; showContents; 
   if);
   (* husk at checke, om lineno er sidste linie *)
   (lineno,1)->lineCharToPos->pos1;
   (lineno+1,1)->lineCharToPos->pos2;
   (if SifViewer.switch[2] then
       'lineno: '->putText;
       lineno->putint;
       ' pos1: '->putText;
       pos1->putint;
       ' pos2: '->putText;
       pos2->putint;
       newLine;
       
   if);
   (pos1,pos2-1)->contents.selection;
   contents.selection.contents->tt[];
   (if SifViewer.switch[2] then tt[]->putline; showContents;  if)
#)  

-- sdeWtexteditorinsertText: Descriptor --
(# pos1,pos2: @integer; 
do
   (if SifViewer.switch[1] then
       'TE.insertText ***********************'->screen.putLine; 
   if);
   (if SifViewer.switch[2] then
       showContents;
       'insert: ['->screen.putText;
       tt[]->screen.putText;
       ']'->screen.put;
       screen.newLine;
       showContents
   if);
   tt[]->contents.insert;
   showContents
#)  

-- sdeWtexteditorsetText: Descriptor --
(# pos1,pos2: @integer;  do 'TE.setText'->screen.putLine;  #)  

-- sdeWtexteditorgettext: Descriptor --
(# pos1,pos2: @integer;  do 'TE.gettext'->screen.putLine;  #)  

-- sdeWtexteditordelete: Descriptor --
(# pos1,pos2: @integer;  do 'TE.delete'->screen.putLine;  #)  

-- sdeWtexteditorbefore: Descriptor --
(# 
do
   contents.disableUpdate;
   true->prettyprinting;
   (if SifViewer.switch[1] then 'TE.before'->screen.putLine;  if);
   
#)  

-- sdeWtexteditorafter: Descriptor --
(# 
do
   contents.enableUpdate;
   false->prettyprinting;
   (if SifViewer.switch[1] then 'TE.after'->screen.putLine;  if)
#)  

-- sdeWtexteditorrefresh: Descriptor --
(# pos1,pos2: @integer;  do 'TE.refresh'->screen.putLine;  #)  

-- sdeWtexteditorLastposition: DoPart --
do contents.length->pos  

-- sdeWtexteditorPosToLineChar: DoPart --
do
   pos
     ->contents.posToRowCol
       (#
          indexError:: 
            (# 
            do
               'pos: '->msg.append; pos->msg.putInt; msg.newLine; true->continue
            #)
       #)->(line,char);
   (* guienv bug?  char-1->char  *)
     

-- sdeWtexteditorLineCharToPos: DoPart --
do
   (line,char)
     ->contents.rowColToPos
       (#
          indexError:: 
            (# 
            do
               'row: '->msg.append;
               row->msg.putInt;
               msg.newLine;
               'col: '->msg.append;
               col->msg.putInt;
               msg.newLine;
               true->continue
            #)
       #)->pos;
     

-- codeviewerOnOpen: DoPart --
do
   (if editorRoot[] = fragDotRoot then sifViewer.automaticHolocomments if);
   (if initialSelection[] <> none then
   (* Open contractions before prettyprinting to prevent prettyprinting
    * twice: *)
       initialSelection[]->SifViewer.openContractionsUntilRoot; 
    else
       (if (initialContractionLevel <> 0) and not isApropertyEditor and not
       isASubEditor then
           (editorRoot[],initialContractionLevel)
             ->SifViewer.openContractionLevel;
           
       if);
       
   if);
   80->sifViewer.astView.pp.width;
   (editorRoot[],- 1)->sifViewer.astView.pp.present;
   (if initialSelection[] <> none then
       (if sifViewer.switch[8] then
           'initial selection: '->putText;
           initialSelection.index->putInt;
           newLine
       if);
       (initialSelection[],1,0,0)->sifViewer.setFocus;
       (if sifViewer.switch[8] then
           'cs.node index after setfocus: '->putText;
           sifViewer.cs.node.index->putInt;
           newLine
       if);
       
    else
       (if sifViewer.switch[8] then 'initial selection is none!'->putLine if);
       (1,1)->SifViewer.selectionToAst;
       (if sifViewer.switch[8] then
           'initial selection was set to: '->putText;
           sifViewer.cs.node.index->putInt;
           newLine
       if);
       
   if);
   (if sifViewer.switch[8] then
       'history onOpen: adding end  point; '->putText;
       sifViewer.cs.node.index->putInt;
       newLine
   if);
   SifViewer.cs.node[]->SifViewer.updateHistory  

-- codeviewerOnDoubleClick: DoPart --
do
   (if not textediting then
       (start,end)->SifViewer.selectionToAST;
       shiftKey->SifViewer.handleDoubleClick
    else
       (start,end)->sifViewer.checkTexteditingFinished
   if);
     

-- codeviewerOnClick: DoPart --
do
   (if not textediting then
       (start,end)->SifViewer.selectionToAST
    else
       (start,end)->SifViewer.checkTexteditingFinished
   if);
     

-- codeviewerEnterTextEditing: DoPart --
do
     (# pos1,pos2: @integer
     do
        (if ch = ' ' then
            contents.selection->(pos1,pos2); (pos1,pos1)->contents.selection
        if);
        ch->sifViewer.doTextEdit;
        
     #);
     

-- codeviewerExitTextEditing: DoPart --
do SifViewer.doRevertTextedit  

-- codeViewerOnBeforeChange: DoPart --
do
   (if false then
       'readOnly: '->putText;
       (if readOnly then 'true'->putLine else 'false'->putLine if);
       
   if);
   (if false (* isReadOnly*) then
       prettyprinting->allow
    else
       prettyprinting or textediting->allow; 
   if);
   (if sifViewer.switch[5] then
       'onBeforeChange: '->putText; allow->putInt; ' '->put; 
   if);
   (if sifViewer.switch[5] then
       allow->putInt;
       newLine;
       'theText: '->putText;
       theText->putText;
       '.'->put;
       newLine;
       
   if);
   INNER onBeforeChange  

-- codeViewerOnKeyDown: DoPart --
do
   (if sifViewer[] <> none then
       (if SifViewer.switch[5] then
           'onKeyDown: '->putText;
           ch->putInt;
           '<'->put;
           ch->put;
           '>'->put;
           newLine;
           'textediting: '->putText;
           (if textediting then 1->putInt else 0->putInt if);
           newline;
           
       if);
       (if ch
        // ascii.fs (* left *) // ascii.gs (* right *) // ascii.rs (* up *)
        // ascii.us (* down *) then
           'Selection: '->screen.putText;
           selection.start->screen.putint;
           ' '->screen.put;
           selection.end->screen.putInt;
           screen.newLine;
           selection->onClick
       if);
       (if true (* not isReadOnly*) then
           (if not textEditing then
               (if (ch >= ' ') and (ch <= '~') then
                   ch->enterTextEditing
                else
                   INNER onKeyDown
               if)
            else
               (if ch = ascii.esc then exitTextEditing if); 
           if);
           
        else
           INNER onKeyDown
       if)
   if);
     

-- codeViewerOnMouseDown: DoPart --
do
   (if sifViewer[] <> none then
       (if false then
           'readOnly: '->putText;
           (if readOnly then 'true'->putLine else 'false'->putLine if);
           
       if);
       (if true (* not isReadOnly*) then
           (if buttonState
            // 3 then localposition->sifviewer.onPopUpButton
           if);
           
       if);
       INNER onMouseDown
   if)  

-- codeviewerOnMouseUp: DoPart --
do
   (if sifViewer[] <> none then
       (if SifViewer.switch[1] then
           '-------------------'->putLine; 'onMouseUp'->putLine; 
       if);
       (if SifViewer.switch[2] then
           'selection: '->putText;
           selection.start->putInt;
           ' '->put;
           selection.end->putInt;
           newLine;
           
       if);
       (if doubleClick then
           (if SifViewer.switch[1] then 'doubleClick'->putLine;  if);
           (oldSelection.h,oldSelection.v,shiftKey)->onDoubleClick
        else
           (if selection.start <> selection.end then
               (if SifViewer.switch[1] then
                   'draggingSelection'->putLine; 
               if);
               selection->oldSelection;
               true->draggingSelection;
               theTimer.activate
            else
               selection->oldSelection->onClick
           if)
       if);
       INNER onMouseUP;
       
   if);
     

-- siftexteditorNewfragment: DoPart --
do
     (# theSifViewer: ^codeviewer
     do
        THIS(guienv)[]->UI[];
        (if theEditorRoot[] = none then
            'NewFragment: theEditorRoot is none!!'->putLine
         else
            (if
            'beta'->(theEditorRoot.frag.grammar.grammarIdentification).equal
             then
                theGrammar[]->betaGrammar[]
             else
                (if
                'property'
                  ->(theEditorRoot.frag.grammar.grammarIdentification).equal
                 then
                    true->isApropertyEditor
                if)
            if);
            INNER newFragment;
            (if mps[] = none then
                
             else
                (if theEditorRoot.father <> none then true->isASubeditor if);
                (*              'isAproperty editor: '->putText; 
                 (if isApropertyEditor then 
                 'true'->putLine else 'false'->putLine
                 if);
                 'isAsubeditor: '->putText; 
                 (if isAsubEditor then 
                 'true'->putLine else 'false'->putLine
                 if);
                 *)
                (if SifViewer[] = none then
                    &codeviewerType[]->SifViewer[]->ed[];
                    theEditorRoot.frag[]->THIS(sifTextEditor).frag[];
                    theEditorRoot[]->THIS(sifTexteditor).editorRoot[];
                    initialSelection[]->THIS(sifTexteditor).initialSelection[];
                    (mps[],theGrammar[],UI[],THIS(SifTextEditor)[],
                     theEditorRoot[],initialSelection[])->SifViewer.init;
                    (if not isApropertyEditor and not isAsubEditor then
                        SifViewer[]->SifViewer.setupFormEditor
                    if);
                    
                 else
                    (if theEditorRoot.frag[] = frag[] then
                        SifViewer.doReprettyprint;
                        SifViewer.cs->SifViewer.setFocus
                     else
                        (theEditorRoot.frag[],not isAsubeditor)
                          ->SifViewer.checkFormEditorExistence->theSifViewer[];
                        (if theSifViewer[] = none then
                            &codeviewerType[]->SifViewer[]->ed[];
                            theEditorRoot.frag[]->THIS(sifTextEditor).frag[];
                            theEditorRoot[]->THIS(sifTexteditor).editorRoot[];
                            initialSelection[]
                              ->THIS(sifTextEditor).initialSelection[];
                            (mps[],theGrammar[],UI[],THIS(SifTextEditor)[],
                             theEditorRoot[],initialSelection[])
                              ->SifViewer.init;
                            (if not isApropertyEditor and not isAsubEditor then
                                SifViewer[]->SifViewer.setupFormEditor
                            if);
                            
                         else
                            theSifViewer[]->SifViewer[];
                            theEditorRoot.frag[]->THIS(sifTextEditor).frag[];
                            theEditorRoot[]->THIS(sifTexteditor).editorRoot[];
                            initialSelection[]
                              ->THIS(sifTextEditor).initialSelection[];
                            SifViewer.doReprettyprint;
                            SifViewer.cs->SifViewer.setFocus
                        if)
                    if)
                if);
                
            if);
            
        if)
     #);
     

-- siftexteditorCloseGroup: DoPart --
do
(* (if sifViewer[] <> none then
 sifViewer.closeGroup->value
 else
 true->value
 if)  *)   

-- siftexteditorSaveGroup: DoPart --
do   

-- siftexteditorSaveGroupAs: DoPart --
do   

-- siftexteditorNewGroup: DoPart --
do   

-- siftexteditorDeleteArea: DoPart --
do
   (if SifViewer.switch[1] then
       'TE.deleteArea'->screen.putLine; showContents; 
   if);
   ((line1,pos1)->lineCharToPos,((line2,pos2)->lineCharToPos)+1 (* why?? *) )
     ->contents.selection;
   (if SifViewer.switch[2] then
       'line1: '->screen.putText;
       line1->screen.putint;
       ' line2: '->screen.putText;
       line2->screen.putint;
       ' pos1: '->screen.putText;
       pos1->screen.putint;
       ' pos2: '->screen.putText;
       pos2->screen.putint;
       screen.newLine;
       'selection.start: '->screen.putline;
       contents.selection.start->screen.putint;
       ' selection.end: '->screen.putline;
       contents.selection.end->screen.putint;
       screen.newLine;
       
   if);
   contents.delete (*cut*) ;
   showContents  

-- siftexteditorOnFrameChanged: Descriptor --
(# oz,nz: @Point
do
   (if true (*adaptivePrettyprinting*) then (* adaptive prettyprinting *)
       (if SifViewer[] <> none then
           (if sifViewer.astView[] <> none then
               oldFrame.size->oz;
               newFrame.size->nz;
               (if nz.h <> oz.h then
                   newFrame.size->charWidth->SifViewer.astView.pp.width;
                   SifViewer.astView.pp.width+20->SifViewer.astView.pp.width;
                   (*'pp.width: '->putText;
                    SifViewer.astView.pp.width->putInt;
                    newLine;*)
                   (editorRoot[],- 1)->SifViewer.astView.pp.present;
                   (if SifViewer.cs.node[] <> none then
                   (*SifViewer.cs->SifViewer.astToSelection; *)
                       sifViewer.cs->sifViewer.setFocus
                   if);
                   
               if);
               
           if)
       if)
   if)
#)  

-- siftexteditorOpen: DoPart --
do
   INNER Open;
   defaultSize->size;
   contents.WidgetId->X11EmacsBindings (* X11 dep. *) ;
     

-- siftexteditorDefaultSize: DoPart --
do (200,100)->value; INNER  

-- siftexteditorClose: DoPart --
do (if SifViewer[] <> none then SifViewer.close if)  

-- siftexteditorInitialContractionLevel: DoPart --
do 5->value; INNER initialContractionLevel  

-- lib: Attributes --
X11EmacsBindings: (* X11 dep. *)
  (#
     override: @
       (# tt: @integer; widget: @integer; 
       do
          t->XtParseTranslationTable->tt;
          (widget,tt)->XtOverrideTranslations;
          t.clear;
          
       #);
     t: @text
       (#
          putl: @putline;
          bind: @
            (# b: ^text
            enter b[]
            do (if lgth+b.lgth >= 1000 then override if); b[]->putl; 
            #);
          
       #);
     
  enter override.widget
  do
     'Ctrl <Key>b:            backward-character()'->t.bind;
     'Alt <Key>b:             backward-word()'->t.bind;
     'Meta <Key>b:            backward-word()'->t.bind;
     'Shift Alt <Key>b:       backward-word(extend)'->t.bind;
     'Shift Meta <Key>b:      backward-word(extend)'->t.bind;
     'Alt <Key>[:             backward-paragraph()'->t.bind;
     'Meta <Key>[:            backward-paragraph()'->t.bind;
     'Shift Alt <Key>[:       backward-paragraph(extend)'->t.bind;
     'Shift Meta <Key>[:      backward-paragraph(extend)'->t.bind;
     'Alt <Key><:             beginning-of-file()'->t.bind;
     'Meta <Key><:            beginning-of-file()'->t.bind;
     'Ctrl <Key>a:            beginning-of-line()'->t.bind;
     'Shift Ctrl <Key>a:      beginning-of-line(extend)'->t.bind;
     'Ctrl <Key>osfInsert:    copy-clipboard()'->t.bind;
     'Shift <Key>osfDelete:   cut-clipboard()'->t.bind;
     'Shift <Key>osfInsert:   paste-clipboard()'->t.bind;
     'Alt <Key>>:             end-of-file()'->t.bind;
     'Meta <Key>>:            end-of-file()'->t.bind;
     'Ctrl <Key>e:            end-of-line()'->t.bind;
     'Shift Ctrl <Key>e:      end-of-line(extend)'->t.bind;
     'Ctrl <Key>f:            forward-character()'->t.bind;
     'Alt <Key>]:             forward-paragraph()'->t.bind;
     'Meta <Key>]:            forward-paragraph()'->t.bind;
     'Shift Alt <Key>]:       forward-paragraph(extend)'->t.bind;
     'Shift Meta <Key>]:      forward-paragraph(extend)'->t.bind;
     'Ctrl Alt <Key>f:        forward-word()'->t.bind;
     'Ctrl Meta <Key>f:       forward-word()'->t.bind;
     'Ctrl <Key>d:            kill-next-character()'->t.bind;
     'Alt <Key>BackSpace:     kill-previous-word()'->t.bind;
     'Meta <Key>BackSpace:    kill-previous-word()'->t.bind;
     'Ctrl <Key>w:            key-select() kill-selection()'->t.bind;
     'Ctrl <Key>y:            unkill()'->t.bind;
     'Ctrl <Key>k:            kill-to-end-of-line()'->t.bind;
     'Alt <Key>Delete:        kill-to-start-of-line()'->t.bind;
     'Meta <Key>Delete:       kill-to-start-of-line()'->t.bind;
     'Ctrl <Key>o:            newline-and-backup()'->t.bind;
     'Ctrl <Key>j:            newline-and-indent()'->t.bind;
     'Ctrl <Key>n:            next-line()'->t.bind;
     'Ctrl <Key>osfLeft:      page-left()'->t.bind;
     'Ctrl <Key>osfRight:     page-right()'->t.bind;
     'Ctrl <Key>p:            previous-line()'->t.bind;
     'Ctrl <Key>g:            process-cancel()'->t.bind;
     'Ctrl <Key>l:            redraw-display()'->t.bind;
     'Ctrl <Key>osfDown:      next-page()'->t.bind;
     'Ctrl <Key>osfUp:        previous-page()'->t.bind;
     'Ctrl <Key>space:        set-anchor()'->t.bind;
     override;
     
  #)  

