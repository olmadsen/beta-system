ORIGIN '../codeviewer';
-- codeviewerinit: Descriptor --
(# grammar: ^mg.Agrammar
do
   false->switch[1];
   false->switch[2];
   false->switch[3];
   metaGrammarInit;
   &mps.astViewer[]->astView[];
   &windowOutput[]->astView.out[];
   betaGrammar.grammarAst.root[]->grammar[];
   betaGrammar[]->ag[];
   grammar.getProductionList->prodList[];
   astView.out.init;
   frag.grammar.grammarAst.father->fg[];
   fg.father->fg[];
   fg.fullName->astView.pp.init;
   true->astView.pp.abstractPresentation;
   true->astView.pp.editorMode;
   theSifTextEditor.contents.size->theSifTextEditor.charWidth->astView.pp.width;
   getPropertiesFromGrammar;
   &editorEnv[]->edenv[]
     ->objectPool.put (# alreadyThere::<  (#  do true->continue #) #);
   (mps[],mps.betaGrammar[],UI[])->edenv.init;
   INNER init;
   theSifTexteditor.onOpen
#)  

-- seletionToAst: Descriptor --
(#
   line1,char1,line2,char2: @integer;
   newCS: @astFocus;
   startNode,endNode,nca,firstListElement,lastListElement: ^mps.ast;
   prod: ^mg.prod;
   expNode: ^mps.expanded;
   startSonNo,endSonNo: @integer;
   synCatNo: @mps.nonterminalSymbol;
   startInx,startSubinx,endInx,endSubInx: @integer
do
   (if start = end then
       start->theSifTexteditor.contents.posToRowCol->(line1,char1);
       (if switch[2] then
           'onClick after posToRowCol: '->putText;
           line1->screen.putint;
           ' '->screen.put;
           char1->screen.putint;
           ' '->screen.put;
           
       if);
       (line1,char1)->astView.pp.hit->(startNode[],startInx,startSubinx);
       startNode[]->nca[];
       0->startSonNo;
       (if switch[2] then
           'onClick: startSonNo, index: '->putText;
           startSonNo->putInt;
           ' '->put;
           startNode.index->putInt;
           newLine;
           'startSon: inx, subinx: '->putText;
           startInx->putInt;
           ' '->put;
           startSubInx->putInt;
           newLine;
           
       if)
    else
       start->theSifTexteditor.contents.posToRowCol->(line1,char1);
       end->theSifTexteditor.contents.posToRowCol->(line2,char2);
       (if switch[2] then
           'onClick after posToRowCol: '->putText;
           line1->screen.putint;
           ' '->screen.put;
           char1->screen.putint;
           ' '->screen.put;
           line2->screen.putint;
           ' '->screen.put;
           char2->screen.putint;
           ' '->screen.put;
           newLine;
           
       if);
       (line1,char1)->astView.pp.hit->(startNode[],startInx,startSubinx);
       (line2,char2)->astView.pp.hit->(endNode[],endInx,endSubInx);
       startNode[]->endNode.nearestCommonAncestor->(nca[],startSonNo,endSonNo);
       (if (startNode[]->endNode.equal) and (startInx = endInx) and
       (startSubinx = endSubinx) then
           
        else
           0->startInx->startSubInx
       if);
       (if switch[2] then
           'onClick: startSonNo, index: '->putText;
           startSonNo->putInt;
           ' '->put;
           startNode.index->putInt;
           newLine;
           'startSon: inx, subinx: '->putText;
           startInx->putInt;
           ' '->put;
           startSubInx->putInt;
           newLine;
           'onClick endSonNo, index: '->putText;
           endSonNo->putInt;
           ' '->put;
           endNode.index->putInt;
           newLine;
           'emdSon: inx, subinx: '->putText;
           endInx->putInt;
           ' '->put;
           endSubInx->putInt;
           newLine;
           'noClick: nca index: '->putText;
           nca.index->putInt;
           newLine;
           
       if);
       
   if);
   (if ((startSonNo = 0) or (endSonNo = 0)) then
       (nca[],1,startInx,startSubInx)->newCS
    else
       nca[]->getSynCatNo->synCatNo;
       (if synCatNo.isLexem then
           (nca[],1,startInx,startSubInx)->newCS; 
        else
           synCatNo->prodList.get->prod[];
           (if prod.symbol
            // mg.listZero // mg.listOne then
               nca[]->expNode[];
               startSonNo->expNode.get->firstListElement[];
               endSonNo->expNode.get->lastListElement[];
               (if switch[2] then
                   'onClick: first: '->putText;
                   firstListElement.index->putInt;
                   newLine;
                   'onClick: last: '->putText;
                   lastListElement.index->putInt;
                   newLine;
                   
               if);
               (firstListElement[],endSonNo-startSonNo+1,0,0)->newCS;
               
            else
               (nca[],1,startInx,startSubInx)->newCS; 
           if);
           
       if);
       
   if);
   newCS->setFocus
#)  

