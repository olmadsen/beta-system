ORIGIN '~beta/basiclib/betaenv';
INCLUDE '~beta/sourcebrowser/ymerInterface'
        '~beta/guienv/utils/simplemenu'
        '~beta/dependency/dependency'
        'search'
        'ymercall'
        'createdialog'
        'sifinterface'
        '~beta/freja/frejainterface'
        '~beta/basiclib/basicsystemenv'
        '~beta/mjolnertool/prefDialog/editoroptions';
LIB_DEF 'editorymersiflib' '../lib';
BODY 'private/globalexternalintbody'
     'private/ymersiflibslotbody'
     'private/ymersiflibsearchbody'
     'private/ymersiflibbody'
     'private/ymersiflibperformbody';
(*
 * COPYRIGHT
 *   Copyright Mjolner Informatics, 1995-2000
 *   All rights reserved.
 *)
-- lib: Attributes --
sifapplication: (*GRAM ymerApplication *)
  (#
     gui: ^guienv;
     mps: ^ymermps;
     theSystemEnv: ^systemenv;
     ymer: ^ymerEnvInterface;
     editorPrefs: ^editorPreferences;
     isEditor: @boolean;
     (*GRAM onQuit::<  (#  do THIS(Sifapplication).askKillPrograms; INNER #); *)
     (* ymerBrowser: ymerBrowserWindow; *)
     sifbrowserWindowExt:
     (* sif extension to ymerbrowserwindow. 1-1 with ymer.ymerbrowserwindow *)
       (#
          init:
            (# 
            enter ymerbrowserInt[]
            do
               ymerBrowserInt.ymerBrowser[]->ymerBrowser[];
               ymerBrowserInt.edEnv[]->edenv[];
               ymerBrowser[]->ymerCallBack.theBrowser[];
               ymerBrowserInt.id->ymerCallBack.theBrowserId;
               initCompiler
            #);
          ymerBrowserInt: ^ymerBrowserInterface;
          ymerBrowser: ^gui.window;
          edenv: ^ymerBrowser.editorEnv;
          browserTitle:<
            (# title: @text;  do ' and Editor'->title.append; INNER #);
          isEditor:< booleanValue
            (#  do THIS(sifapplication).isEditor->value; INNER #);
          stopDebugging:< object;
          theSifTextEditor: ^ymerbrowser.sifTextEditor;
          cbg: (* current browser group *) ^object;
          (*GRAM browser.projects.group; *)
          cff:
          (* current fragment form, not used anymore only in oldfromeditorExists *)
          ^astInterface.fragmentform;
          ymerCallback: @ymerCall
            (#
               refreshGroup:: 
                 (#  do ( (*cb[],*) fg[],none )->updateBrowser #);
               findAndSelect:: 
                 (#  do node[]->THIS(sifbrowserWindowExt).findAndSelect #);
               selectFragmentForm:: 
                 (# 
                 do
                    ((ff.father).fullName,ff.name)
                      ->ymerbrowserInt.selectFragmentForm
                 #);
               selectFragmentGroup:: 
                 (#  do fgName[]->ymerBrowserInt.selectFragmentGroup #);
               getFragmentGroup:: 
                 (# 
                 do name[]->mps.fragmentGroupTable.getFragmentGroup->fg[]
                 #);
               getCurrentProject:: 
                 (# fg: ^astInterface.fragmentGroup
                 do
                    &fragmentGroupList[]->fgList[];
                    (if (ymerbrowserInt.currentProject[] <> none ) then
                        ymerbrowserInt.currentProject.name.copy->name[];
                        ymerbrowserInt.currentProject.scanGroups;
                        ymerbrowserInt.currentProject.groups.scan
                          (# 
                          do
                             current.getfg->fg[];
                             (if fg[] <> none then fg.name->fgList.append if)
                          #)
                    if)
                 #);
               getCurrentGroupProject:: 
                 (#
                    fg: ^astInterface.fragmentGroup;
                    gList: ^projectInfo.groupList
                 do
                    &fragmentGroupList[]->fgList[];
                    (if (ymerbrowserInt.currentProject[] <> none ) then
                        (if searchArea
                         // 4 (* project *) then
                            ymerbrowserInt.currentProject.scanGroups;
                            ymerbrowserInt.currentProject.groups[]->gList[];
                            ymerbrowserInt.currentProject.name.copy->name[]
                         // 5 (* domain *) then
                            (if ymerbrowserInt.currentGroup[] <> none then
                                ymerbrowserInt.currentGroup.getDomain->gList[]
                            if)
                         // 6 (* extent *) then
                            (if ymerbrowserInt.currentGroup[] <> none then
                                ymerbrowserInt.currentGroup.getExtent->gList[]
                            if)
                        if);
                        (if (gList[] <> none ) then
                            gList.scan
                              (# 
                              do
                                 current.getfg->fg[];
                                 (if fg[] <> none then
                                     fg.name->fgList.append
                                 if)
                              #)
                        if)
                    if)
                 #);
               getCurrentProjectStatus:: 
                 (# 
                 do
                    (if (ymerbrowserInt.currentProject[] <> none ) then
                        ymerbrowserInt.currentProject.name.copy->name[]
                    if)
                 #);
               getCurrentFragmentGroup:: 
                 (# 
                 do
                    (if ymerbrowserInt.cge[] <> none then
                        ymerbrowserInt.cge.fg[]->fg[]
                    if)
                 #);
               getCurrentFragmentForm:: 
                 (# 
                 do
                    (if ymerbrowserInt.cfe[] <> none then
                        ymerbrowserInt.cfe.frag[]->ff[]
                    if)
                 #);
               getCurrentNode:: 
                 (# 
                 do
                    (if ymerbrowserInt.cfe[] <> none then
                        ymerbrowserInt.cfe.cs.node[]->node[]
                    if)
                 #);
               check:: 
                 (#  do fg[]->THIS(sifBrowserWindowExt).check->status #);
               saveAsAndCheck:: 
                 (# 
                 do fg[]->THIS(sifBrowserWindowExt).saveAsAndcheck->status
                 #);
               betaenvVersion:: 
                 (#  do THIS(sifapplication).betaenvVersion->t[] #);
               machineType::  (#  do machine_type->t[] #);
               infoView::  (#  do t[]->writeInfoView #);
               infoViewClear::  (#  do writeInfoViewClear #);
               infoViewDone::  (#  do writeInfoViewDone #);
               onAboutToCloseGroup:: 
                 (# 
                 do
                    fg[]->THIS(sifapplication).onAboutToCloseGroup
                      ->(OKtoClose,askSave)
                 #);
               onGroupSaved:: 
                 (# t: ^text
                 do
                    (if (ymerbrowserInt.cge[] <> none ) and
                    (ymerbrowserInt.cge.fg[] = fg[]) then
                        ymerbrowserInt.locationView.label->t[];
                        (' ',10)->t.inxPut;
                        t[]->ymerbrowserInt.locationView.label
                    if)
                 #);
               onGroupTouched:: 
                 (# t: ^text
                 do
                    (if (ymerBrowserInt.cge[] <> none ) and
                    (ymerBrowserInt.cge.fg[] = fg[]) then
                        false->ymerbrowserInt.locationView.checked;
                        true->ymerbrowserInt.locationView.changed
                    if)
                 #);
               onGroupDetouched:: 
                 (# t: ^text
                 do
                    (if (YmerbrowserInt.cge[] <> none ) and
                    (YmerbrowserInt.cge.fg[] = fg[]) then
                        (if ymerbrowserInt.cge.touched = 0 then
                            false->ymerBrowserInt.locationView.Changed
                        if)
                    if)
                 #);
               externalTextEdit:: 
                 (# 
                 do
                    textBefore[]->THIS(sifApplication).externalTextEdit
                      ->textAfter[]
                 #);
               frejaInclude:: 
                 (#  do THIS(sifapplication).frejaInclude->t[] #);
               setFrejaMark:: 
                 (#  do (frejaMark,fg[])->externalInterface.setFrejaMark #);
               getFrejaMark:: 
                 (#  do fg[]->externalInterface.getFrejaMark #);
               isEditor:: 
                 (# 
                 do true->value; THIS(sifBrowserWindowExt).iseditor->value
                 #);
               callSearch::  (#  do THIS(sifBrowserWindowExt).callSearch #);
               callReplace:: 
                 (#  do THIS(sifBrowserWindowExt).callReplace #);
               showSearchHits:: 
                 (# 
                 do
                    (fg[],ff[],node[],t[],caseSensitive,wholeWord,searchArea,
                     showAllHits,onlyApplications,theNameDcl[])
                      ->THIS(sifBrowserWindowExt).showSearchHits
                 #);
               replaceAll:: 
                 (# 
                 do
                    (fg[],ff[],node[],t[],newt[],caseSensitive,wholeWord,
                     replaceDeclaration,searchArea,onlyApplications,
                     theNameDcl[])->THIS(sifBrowserWindowExt).replaceAll
                 #);
               isActive::  (#  do value->ymer.isActive #);
               openSubeditor:: 
                 (# 
                 do
                    (editorRoot[],node[])
                      ->THIS(sifBrowserWindowExt).openSubEditor;
                    
                 #);
               askShowDiagram::  (#  do true->value #);
               showDiagram:: 
                 (# 
                 do (* node[]->externalInterface.showDiagram *)
                    edenv.frejaExternalInterface.showDiagram
                 #);
               askEditUserinterface:: 
                 (# 
                 do
                    node[]
                      ->
                        ymerBrowserInt.friggExternalInterface.
                          askEditUserInterface->value
                 #);
               editUserInterface:: 
                 (# 
                 do
                    (frag[],node[])
                      ->ymerBrowserInt.friggExternalInterface.editUserInterface
                 #);
               OKtoTextedit:: 
                 (# 
                 do
                    node[]->ymerBrowserInt.friggExternalInterface.OKtoTextedit
                      ->value
                 #);
               createImplementationFragment:: 
                 (# 
                 do
                    fg[]->THIS(sifbrowserWindowExt).createImplementationFragment
                 #);
               selectImplementationFragment:: 
                 (# 
                 do
                    fg[]->THIS(sifbrowserWindowExt).selectImplementationFragment
                 #);
               quit:: 
                 (# 
                 do
                    ymerBrowserInt.quitBrowser;
                    (* (theMenubar).fileMenu.iQuit.theEventhandler.onSelect *)
                    
                 #);
               allowDebug::  (#  do fg[]->debugPossible->value #);
               doDebug::  (#  do fg[]->debug #);
               stopDebugging:: 
                 (# 
                 do ymerBrowserInt.debuggerExternalInterface.stopdebugging; 
                 #);
               newCodeViewWindow:: 
                 (#
                    myaction: gui.codeViewMenuAction
                      (#
                         edm: theWindow.codeEditorEditMenu
                           (#
                              formEditorExists:: 
                                (#  do THIS(myaction).cfe->cfe[] #)
                           #);
                         edit: ^edm;
                         edv: thewindow.codeeditorViewMenu
                           (#
                              formEditorExists:: 
                                (#  do THIS(myaction).cfe->cfe[] #)
                           #);
                         view: ^edv;
                         
                      do
                         &edm[]->edit[];
                         useExternalTextEditor->edit.useExternalTextEditor;
                         edit.open;
                         edit[]->themenubar.append;
                         &edv[]->view[];
                         view.open;
                         view[]->themenubar.append;
                         
                      #);
                    
                 do &myaction[]->action1[]; 
                 #);
               showSemanticErrors:: 
                 (# 
                 do fg[]->THIS(sifbrowserWindowExt).showSemanticErrors
                 #)
            #);
          doCommand:
            (# 
            do
               (if (edenv[] <> none ) then
                   edenv.setWaitCursor;
                   INNER doCommand;
                   edenv.setStructureCursor
               if)
            #);
          checkOngoingTextEditing:
            (# value: @boolean
            <<SLOT ymersiflibCheckOngoingTextEditing:DoPart>>
            exit value
            #);
          formEditorExists:
            (#
               value: @boolean
            <<SLOT ymersiflibFormEditorExists:DoPart>>
            exit value
            #);
          groupEditorExists:
            (# value: @boolean
            do (ymerbrowserInt.cge[] <> none )->value; 
            exit value
            #);
          allowCommand:
            (# value: @boolean
            do
               (if groupEditorExists then
                   (if not checkOngoingTextediting and not
                   ymerbrowserInt.cge.isReadOnly
                   (* and not ymerBrowserInt.cge.isAfrejaEditor *) then
                       true->value
                   if)
               if)
            exit value
            #);
          allowPerform:
            (# value: @boolean
            do
               (if groupEditorExists then
                   (if not checkOngoingTextediting
                   (* and not
                    ymerBrowserInt.cge.isReadOnly*) then
                       true->value
                   if)
               if);
               
            exit value
            #);
          allowDebug:< trueObject;
          allowOnForm:
            (# value: @boolean
            do
               (if groupEditorExists and not ymerbrowserInt.propertySelected
                then
                   (if not checkOngoingTextediting and not
                   ymerbrowserInt.cge.isReadOnly then
                       true->value
                   if)
               if)
            exit value
            #);
          updateBrowser:
            (#
               fg: ^astInterface.fragmentGroup;
               ff: ^astInterface.fragmentForm;
               (*cb: ^object;
                browser: ^ymerbrowser.sourceBrowser;
                theYmerBrowserWindow: ^gui.ymerBrowserWindow;
                cbg: (* current browser group * ) ^browser.projects.group
                *)
               
            enter ( (*cb[],*) fg[],ff[])
            do
               (fg[],ff[])->ymerBrowserInt.updateBrowser;
               (*
                (if (cb[] <> none ) and (cb## <= gui.ymerBrowserWindow##) then
                cb[]->theYmerBrowserWindow[];
                theYmerBrowserWindow.browser[]->browser[];
                browser.currentgroup[]->cbg[];
                (if (cbg[] <> none ) and (cbg.fg[] = fg[]) then
                (browser.currentProject[],none )->browser.setGroup;
                (browser.currentProject[],cbg[])->browser.setGroup;
                (if ff[] <> none then
                (browser.currentProject[],cbg[],ff[])
                ->browser.setFragmentForm
                if)
                if)
                if)
                *)
               
            #);
          findAndSelect:
            (# node: ^astInterface.ast
            enter node[]
            do
               (if node[] <> none then
                   (if ymerbrowserInt.cfe[] <> none then
                       (if node.frag[] <> ymerbrowserInt.cfe.frag[] then
                           ((node.frag.father).fullName,node.frag.name)
                             ->ymerbrowserInt.selectFragmentForm;
                           (* Defensive programming:  Sometimes selectF...
                            * can set cfe to none, don't know why --EC
                            *)
                           (if ymerbrowserInt.cfe[] <> none then
                               node[]->ymerbrowserInt.cfe.setNode
                           if)
                        else
                           node[]->ymerbrowserInt.cfe.setNode
                       if)
                    else
                       ((node.frag.father).fullName,node.frag.name)
                         ->ymerbrowserInt.selectFragmentForm;
                       (* Defensive programming:  Sometimes selectF...
                        * can set cfe to none, don't know why --EC
                        *)
                       (if ymerbrowserInt.cfe[] <> none then
                           node[]->ymerbrowserInt.cfe.setNode
                       if)
                   if)
                else
                   'findAndSelect: node is none!'->putLine
               if)
            #);
          findForm:
            (# ff: ^astInterface.fragmentForm
            enter ff[]
            do
               (if ff[] <> none then
                   ((ff.father).fullName,ff.name)
                     ->ymerbrowserInt.selectFragmentForm
                else
                   'findForm: ff is none!'->putLine
               if)
            #);
          findGroup:
            (# fg: ^astInterface.fragmentGroup
            enter fg[]
            do
               (if fg[] <> none then
                   fg.fullName->ymerbrowserInt.selectFragmentGroup
                else
                   'findGroup: fg is none!'->putLine
               if)
            #);
          externalInterface: (* Global commands *) @sifInterface
            (#
               isEditor::  (#  do value->THIS(sifApplication).iseditor #);
               onBrowserSelectionChanged:: 
                 (#  <<SLOT onBrowserSelectionChanged:DoPart>> #);
               selectEditor:: 
                 (# 
                 <<SLOT externalInterfaceSelectEditor:DoPart>>
                 #);
               openForm::  (#  <<SLOT externalInterfaceOpenForm:DoPart>> #);
               showDiagram:: 
                 (# 
                 do
                    (if
                    ymerbrowserInt.
                      cge[] <> none
                     then (* dsa hack *)
                        (if node[] = none then
                            doCommand
                              (# 
                              do
                                 (if (ymerbrowserInt.cfe[] <> none ) then
                                     (if ymerbrowserInt.cfe.cs[] <> none then
                                         writeInfoViewClear;
                                         (ymerbrowserInt.cfe.frag[],
                                          ymerbrowserInt.cfe.cs.node[])
                                           ->
                                             edenv.frejaExternalInterface.
                                               openForm
                                      else
                                         'No current selection'->writeInfoView
                                     if)
                                  else
                                     'No fragment group selected'->writeInfoView
                                 if)
                              #)
                         else
                            doCommand
                              (# 
                              do
                                 writeInfoViewClear;
                                 (if edenv.frejaExternalInterface[] = none then
                                     'frejint is none'->putline; 
                                 if);
                                 (node.frag[],node[])
                                   ->edenv.frejaExternalInterface.openForm
                              #)
                        if)
                    if)
                 #);
               check:: 
                 (# OK: @boolean; newName: ^text
                 do
                    true->OK;
                    loop:
                    (if ymerBrowserInt.cge.isReadOnly then
                        'Is readonly, make copy before checking'->writeInfoView;
                        ymerBrowserInt.cge.saveAs->newName[];
                        (if newName[] <> none then
                            newName[]->ymerbrowserInt.selectFragmentGroup
                         else
                            false->OK
                        if)
                    if);
                    (if OK and (ymerBrowserInt.cge[] <> none ) then
                        (if ymerBrowserInt.cge.fg[]->isProgram then
                            ymerBrowserInt.cge.fg[]->lastProgramFG[];
                            ymerBrowserInt.cge.fgTitle->lastProgramName[]
                        if);
                        ymerBrowserInt.cge.fg[]->THIS(sifBrowserWindowExt).check
                    if)
                 #);
               hasProgramFG:: 
                 (# 
                 do
                    (if lastProgramFG[] <> none then
                        true->value
                     else
                        (if ymerBrowserInt.cge[] <> none then
                            (if ymerBrowserInt.cge.fg[]->isProgram then
                                true->value
                            if)
                         else
                            'HasProgram: cge is none!'->putLine
                        if)
                    if)
                 #);
               debugProgramFGPossible:: 
                 (#  do lastProgramFG[]->debugPossible->value #);
               compile:: 
                 (# OK: @boolean; newName: ^text
                 do
                    true->OK;
                    loop:
                    (if ymerBrowserInt.cge.isReadOnly then
                        'Is readonly, make copy before compiling'
                          ->writeInfoView;
                        ymerBrowserInt.cge.saveAs->newName[];
                        (if newName[] <> none then
                            newName[]->ymerbrowserInt.selectFragmentGroup
                         else
                            false->OK
                        if)
                    if);
                    (if OK and (ymerBrowserInt.cge[] <> none ) then
                        (if ymerBrowserInt.cge.fg[]->isProgram then
                            ymerBrowserInt.cge.fg[]->lastProgramFG[];
                            ymerBrowserInt.cge.fgTitle->lastProgramName[]
                        if);
                        (if ymerBrowserInt.cge.fg[]->isRunning then
                            ymerBrowserInt.cge.fg[]->kill
                        if);
                        (if
                        lastProgramFG[]->THIS(sifBrowserWindowExt).compile
                          ->value then
                            (if lastProgramFG[]->isProgram then
                                'Linking...'->writeInfoView;
                                1000->jobFileTimer.start;
                                'Linking finished'->writeInfoView
                             else
                                'Compilation finished'->writeInfoView
                            if)
                        if)
                    if)
                 #);
               isExecutable:: 
                 (# 
                 do fg[]->THIS(sifbrowserWindowExt).executableExists->value
                 #);
               execute:: 
                 (# 
                 do
                    (if ymerBrowserInt.cge.fg[]->isProgram then
                        ymerBrowserInt.cge.fg[]->lastProgramFG[];
                        ymerBrowserInt.cge.fgTitle->lastProgramName[]
                    if);
                    (if lastProgramFG[]->executableExists then
                        (if lastProgramFG[]->isRunning then
                            lastProgramFG[]->kill
                        if);
                        lastProgramFG[]->THIS(sifbrowserWindowExt).execute
                    if)
                 #);
               debug:: 
                 (# 
                 do
                    (if ymerBrowserInt.cge.fg[]->isProgram then
                        ymerBrowserInt.cge.fg[]->lastProgramFG[];
                        ymerBrowserInt.cge.fgTitle->lastProgramName[]
                    if);
                    lastProgramFG[]->THIS(sifbrowserWindowExt).debug->value
                 #);
               getEditorForForm:: 
                 (#  <<SLOT externalInterfaceGetEditorForForm:DoPart>> #);
               newBETAProgram::
                 (#  <<SLOT externalInterfaceNewBETAProgram:DoPart>> #);
               newBETALibrary:: 
                 (# 
                 <<SLOT externalInterfaceNewBETALibrary:DoPart>>
                 #);
               saveAndQuit:: 
                 (#  <<SLOT externalInterfaceSaveAndQuit:DoPart>> #);
               save:: 
                 (# 
                 <<SLOT externalInterfaceSave:DoPart>>
                 #);
               autoSave::  (#  <<SLOT externalInterfaceAutoSave:DoPart>> #);
               checkAutoSaveFile:: 
                 (# 
                 <<SLOT externalInterfaceCheckAutoSaveFile:DoPart>>
                 #);
               simplecheck:: 
                 (# fg: ^astinterface.fragmentGroup
                 <<SLOT externalInterfaceCheck:DoPart>>
                 #);
               toggleDebug:: 
                 (# 
                 <<SLOT externalInterfaceToggleDebug:DoPart>>
                 #);
               addProp::  (#  <<SLOT externalInterfaceAddProp:DoPart>> #);
               deleteProp:: 
                 (# notFound:< object
                 <<SLOT externalInterfaceDeleteProp:DoPart>>
                 #);
               setFrejaMark:: 
                 (# propvalue: @integer
                 do
                    (if frejamark then 1->propValue else 0->propValue if);
                    'frejamark'
                      ->FG.prop.addprop (#  do propValue->addConst #)
                 #);
               getFrejaMark:: 
                 (#
                    GetProp:
                      (#
                         FG: ^astInterface.fragmentGroup;
                         P: @Text;
                         res: @integer;
                         Txt: ^Text;
                         
                      enter (P,FG[])
                      do
                         &Text[]->Txt[];
                         L: FG.prop.scanProp
                           (#
                              doProp:: 
                                (# 
                                do
                                   (if (P[]->Prop.equal) then
                                       scanParameters
                                         (#
                                            doConst:: 
                                              (#  do C->res; leave L #);
                                            doString:: 
                                              (#  do S[]->Txt[]; leave L #)
                                         #);
                                       
                                   if);
                                   
                                #);
                              
                           #);
                         INNER (* ugly *)
                      exit res
                      #);
                    
                 exit (1 = (('frejamark',FG[])->getProp))
                 #)
            #);
          lastProgramFG: ^astInterface.fragmentGroup;
          lastProgramName: ^text;
          formsWithSemanticErrors: @list
            (# element:: mps.ast.fragmentForm #);
          savedGroups: @set (# element:: mps.ast.fragmentGroup;  #);
          callCompiler: doCommand
            (# exp: ^astInterface.expanded; node: ^astInterface.ast
            do
               (if theSemanticErrorViewer[] <> none then
                   (if theSemanticErrorViewer.opened then
                       theSemanticErrorViewer.clearBrowser
                   if)
               if);
               writeInfoViewClear;
               formsWithSemanticErrors.clear;
               'Calling BETA compiler'->putLine;
               '-------------------------------------------------------------------------------'
                 ->putLine;
               INNER ;
               '-------------------------------------------------------------------------------'
                 ->putLine;
               (if formsWithSemanticErrors.size > 0 then
                   l: formsWithSemanticErrors.scan
                     (# 
                     do
                        none ->node[];
                        'Semantic Error(s)'->writeInfoView;
                        (if current.root.kind = mps.ast.kinds.interior then
                            current.root[]->exp[];
                            loop: exp.suffixWalk
                              (# 
                              do
                                 (if current.hasSemanticError then
                                 (*current.semanticError->mps.ast.semanticErrorText->t[];*)
                                     current[]->node[]; leave loop
                                 if)
                              #);
                            (if node[] <> none then node[]->findAndSelect if)
                        if);
                        current.father->showSemanticErrors;
                        leave l
                     #)
               if);
               
            #);
          fileChangedOutside: booleanValue
            (#
               fg: ^astInterface.fragmentGroup;
               diskfile,textfile: @file;
               t: @text
            enter fg[]
            do
               fg.diskfilename->diskfile.name;
               fg.textfilename->textfile.name;
               (if textfile.entry.exists and
               (textfile.entry.modTime > fg.modTime) then
               (* 'Source file: '->t.puttext;
                * fg.textfilename->t.putline;
                * 'changed since last access - reload?'->t.puttext;
                * (none ,'Notification',t[])
                *  ->promptForBoolean
                *      (# ok::
                *      (# do true->allowReload #);
                *    notok::
                *      (# do false->allowReload #);
                *    cancel::
                *       (# do false->allowReload #)
                *  #)
                *)
                   t.clear;
                   'Source file: '->t.puttext;
                   fg.textfilename->t.putline;
                   'has been changed since last access!'->t.putline;
                   t.newLine;
                   'The file must have been changed by some other application.'
                     ->t.putline;
                   'Quit immediately (and restart) to avoid further problems'
                     ->t.puttext;
                   (none ,t[],'Warning')->gui.alertUser;
                   true->value
                else
                   (if diskfile.entry.exists then
                   (* 'Group file: '->t.puttext;
                    * fg.diskfilename->t.putline;
                    * 'changed since last access - reload?'->t.puttext;
                    * (none ,'Notification',t[])
                    *   ->promptForBoolean
                    * (# ok:: (# do true->allowReload #);
                    *    notok:: (# do false->allowReload #);
                    *    cancel:: (# do false->allowReload #)
                    * #)
                    *)
                       (if (diskfile.entry.modTime > fg.modTime) then
                           t.clear;
                           'Group file: '->t.puttext;
                           fg.diskfilename->t.putline;
                           'has been changed since last access!'->t.putline;
                           t.newLine;
                           'The file must have been changed by some other application.'
                             ->t.putline;
                           'Quit immediately (and restart) to avoid further problems'
                             ->t.puttext;
                           (none ,t[],'Warning')->gui.alertUser;
                           true->value
                       if)
                    else
                       (if false then
                       (* outcommented in order to be able to check readonly files *)
                           checkIfOpen: edenv.groupEditorlist.scan
                             (# 
                             do
                                (if current.fg[] = fg[] then
                                    current.groupTouched; 
                                if)
                             #);
                           t.clear;
                           'Group file: '->t.puttext;
                           fg.diskfilename->t.putline;
                           'has been deleted!'->t.putline;
                           t.newLine;
                           'Use the Save command to reestablish it.'->t.putline;
                           'Quit immediately (and restart) to avoid further problems'
                             ->t.puttext;
                           (none ,t[],'Warning')->gui.alertUser;
                           true->value
                       if)
                   if)
               if)
            #);
          nonterminalAllowed:< booleanValue
            (# nont: ^astinterface.unexpanded enter nont[] do INNER #);
          DGchangedOutside:
            (#
               changedOutside,otherError,nontExist: @boolean;
               fg,currentFG: ^astInterface.fragmentGroup;
               onFragmentGroupChanged:< Object;
               nont: ^astInterface.unexpanded;
               isOpen,keepDoRealOpen: @boolean;
               textFile: ^text;
               f: @file
            enter fg[]
            do
               scanningDG:
               fg.name->mps.AST.expandToFullPath
                 ->mps.DG.scanExtent
                   (#
                      warn: ^text;
                      Report:
                        (# msg: ^text
                        enter msg[]
                        do
                           (none ,msg[],'Dependency graph error')
                             ->gui.alertUser;
                           true->otherError;
                           leave scanningDG
                        #);
                      startingParsingNotification::  (#  do  #);
                      reloadingNotification::  (#  do false->doReload #);
                      DoubleFormException::  (#  do true->continue #);
                      transAccessException:: 
                        (# 
                        do
                           'No read access to: '->warn[];
                           FN[]->warn.putline;
                           true->continue;
                           warn[]->Report
                        #);
                      circularDependencyException:: 
                        (# 
                        do
                           'Circular dependency: '->warn[];
                           fg.name->warn.putline;
                           true->continue;
                           warn[]->Report
                        #);
                      unknownPropertyException::  (#  do true->continue #);
                      emptyFragmentException::  (#  do true->continue #);
                      parseException:: 
                        (# 
                        do
                           fullFN[]->openParseEditor;
                           true->continue;
                           true->otherError;
                           leave scanningDG
                        #);
                      transCreateDirException:: 
                        (# 
                        do
                           'Unable to create directory: '->warn[];
                           FN[]->warn.putline;
                           true->continue;
                           warn[]->Report
                        #);
                      MPSexception:: 
                        (# 
                        do
                           'MPS overflow - '->warn[];
                           T[]->warn.puttext;
                           ' too large)'->warn.putline;
                           true->continue;
                           warn[]->Report
                        #);
                      notExistingException:: 
                        (# 
                        do
                           'Not a fragment file: '->warn[];
                           fullFN[]->warn.putline;
                           true->continue;
                           warn[]->Report
                        #);
                      noSpaceException:: 
                        (# 
                        do
                           'No space on disk'->warn[];
                           true->continue;
                           warn[]->Report
                        #);
                      fragmentException::
                      (* Note that the group is closed here.
                       * Sif and other tools may NOT want to do this!
                       *) 
                        (# keepMsg: ^text
                        do (*CloseGroup;*)
                           msg.copy->keepMsg[];
                           msg.clear;
                           (if errNo
                            // 1 then
                               'Two or more slots have the name: '->msg.puttext;
                               slot.name->msg.puttext;
                               
                            // 2 then
                               'No free slot found for: '->msg.Puttext;
                               FF.name->msg.puttext;
                               
                            // 3 then
                               'Category of fragment: '->msg.puttext;
                               FF.name->msg.puttext;
                               ' does not correspond to category of slot'
                                 ->msg.puttext;
                               
                            // 4 then
                               'The slot: '->msg.Puttext;
                               FF.name->msg.puttext;
                               ' Is already bound'->msg.Puttext
                            // 5 then
                               'Category of: '->msg.Puttext;
                               FF.name->msg.Puttext;
                               ' must be either: '->msg.Putline;
                               'Descriptor (ObjectDescriptor, DescriptorForm) or '
                                 ->msg.puttext;
                               'Attributes (AttributeDecl, AttributesForm)'
                                 ->msg.putline;
                               
                            // 6 then
                               'Category of the following slot is not supported!\n\n\t'
                                 ->msg.putText;
                               slot.name->msg.putLine;
                               '\nCategory must be: descriptor, attributes or doPart'
                                 ->msg.putLine
                            // 7 then
                               'Warning: mainPart-slots are NOT fully supported!'
                                 ->msg.putLine
                           if);
                           (if slot[] <> none then
                               msg[]->Report
                            else
                               (if ff[] <> none then
                                   msg[]->Report
                                else
                                   (if fg[] <> none then
                                       msg[]->Report
                                    else
                                       'fragmentException: '->putText;
                                       errNo->putInt;
                                       ': '->putLine;
                                       keepMsg[]->putLine;
                                       keepMsg[]->report
                                   if)
                               if)
                           if)
                        #);
                      propertyException:: 
                        (# keepMsg: ^text
                        do
                           msg.copy->keepMsg[];
                           msg.clear;
                           true->continue;
                           (if n
                            // 1 then
                               'Two or more origins are specified:\n\t'
                                 ->msg.puttext;
                                 (# g: ^astInterface.fragment; 
                                 do FG.origin->g[]; g.name->msg.puttext; 
                                 #);
                               '\n\t'->msg.puttext;
                               t[]->msg.putline
                            // 2 then
                               'The reserved property name "'->msg.puttext;
                               t.makeUC;
                               t[]->msg.puttext;
                               '"\n\tappears in the property list for '
                                 ->msg.puttext;
                               p.makeUC;
                               p[]->msg.puttext;
                               
                            // 3 then
                               'Illegal "'->msg.puttext;
                               p.makeUC;
                               p[]->msg.puttext;
                               '" property: "'->msg.puttext;
                               t.makeUC;
                               t[]->msg.puttext;
                               '"\n'->msg.puttext
                            // 4 then
                               'Empty filename in property "'->msg.puttext;
                               p.makeUC;
                               p[]->msg.puttext;
                               '"'->msg.put;
                               msg.newline;
                               
                            // 5 then
                               'Unrecognised property: '->Msg.Puttext;
                               p[]->Msg.Putline;
                               true->warning;
                               true->continue
                            // 6 then
                               'Property "'->msg.puttext;
                               p[]->msg.puttext;
                               '" has no value for "'->msg.putText;
                               t[]->msg.putText;
                               '"\n'->msg.putLine;
                               true->warning
                           if);
                           (if not warning then
                               '\n\n\tA ";" may be missing before '
                                 ->msg.puttext;
                               t[]->msg.putline;
                               (if fg[] <> none then
                                   'in '->msg.append;
                                   fg.name->msg.append;
                                   msg[]->Report
                                else
                                   'propertyException: '->putText;
                                   n->putInt;
                                   ': '->putLine;
                                   keepMsg[]->putLine;
                                   keepMsg[]->report
                               if);
                               
                           if)
                        #);
                      
                   do
                      current[]->currentFG[];
                      checkIfOpen: edenv.groupEditorlist.scan
                        (# 
                        do
                           (if current.fg[] = currentFG[] then
                               (if current.touched > 0 then
                                   onFragmentgroupChanged
                               if);
                               current.nonterminalsExist->(nontExist,nont[]);
                               (if nontExist then
                                   (if nont[]->nonterminalAllowed then
                                   (* continue *)
                                       
                                    else
                                       nont[]->findAndSelect;
                                       (none ,
                                        'This fragment group cannot be checked\nbefore all nonterminals have been removed',
                                        'Compiler message')->gui.alertUser;
                                       true->otherError;
                                       leave scanningDG
                                   if);
                                   
                                else
                                   (true,false,true)->current.save
                               if);
                               
                           if)
                        #);
                      (if currentFG[]->fileChangedOutside then
                          true->changedOutSide;
                          leave scanningDG;
                          false->isOpen;
                          groupEditorListScan: edenv.groupEditorlist.scan
                            (# 
                            do
                               (if current.fg[] = currentFG[] then
                                   true->isOpen; leave groupEditorListScan
                               if)
                            #);
                          newLine;
                          currentFG.name->putText;
                          (if isOpen then
                              ' is open'->putLine; leave scanningDG
                           else
                              ' is not Open'->putLine;
                              mps.ast.doRealOpen->keepDoRealOpen;
                              true->mps.ast.doRealOpen;
                              fg.textFileName->textFile[]->f.name;
                              (if f.entry.exists then
                                  'xyzzyx'->textFile.append
                              if);
                              keepDoRealOpen->mps.ast.doRealOpen;
                              false->changedOutSide;
                              
                          if)
                      if);
                      
                   #)
            exit (changedOutside,otherError)
            #);
          compilerPrivate: @<<SLOT compilerPrivate:Descriptor>>;
          setCompilerOptions:<
            (# compiler: ^object; 
            do
               <<SLOT setCompilerOptions:Descriptor>>;
               compiler[]->THIS(sifapplication).setcompilerOptions;
               
            #);
          initCompiler:<
            (# version: ^text; compiler: ^object; 
            do INNER ; <<SLOT initCompilerBody:Descriptor>>
            exit version[]
            #);
          check:<
            (#
               fg:
                 ^astInterface.
                    fragmentGroup;
               status: @boolean;
               
            enter fg[]
            do
               <<SLOT compilerCheck:Descriptor>>;
               INNER
            exit status
            #);
          saveAsAndCheck:
            (# fg: ^astInterface.fragmentGroup; status: @boolean; 
            enter fg[]
            <<SLOT performMenuSaveAsAndCheck:DoPart>>
            exit status
            #);
          compile:<
            (#
               fg:
                 ^astInterface.
                    fragmentGroup;
               status: @boolean;
               
            enter fg[]
            do <<SLOT compilerCompile:Descriptor>>; INNER
            exit status
            #);
          jobFileRunning:< booleanValue
            (# 
            <<SLOT compilerJobFileRunning:DoPart>>
            #);
          waitOnJobfile:< (#  <<SLOT compilerWaitOnJobfile:DoPart>> #);
          writeInfoView:
            (#
               t: ^text;
               myMsgPop:
                 (# 
                 do
                    (if
                    ymerbrowserInt.infoView
                    .msgList.head <> none then
                        (ymerbrowserInt.infoView.msgList.head).elm[]
                          ->ymerbrowserInt.infoView.done;
                        ymerbrowserInt.infoView.msgList.head
                          ->ymerbrowserInt.infoView.msgList.delete
                    if)
                 #)
            enter t[]
            do
               (if t.length > 0 then
                   t[]->ymerbrowserInt.infoView.settext;
                   ymerbrowserInt.infoView.msgPush;
                   
                else
                   ymerbrowserInt.infoView.msgClear
               if)
            #);
          writeInfoViewClear: (#  do ymerbrowserInt.infoView.msgClear #);
          writeInfoViewDone:
            (#
               myMsgPop:
                 (# 
                 do
                    (if ymerbrowserInt.infoView.msgList.head <> none then
                        (ymerBrowserInt.infoView.msgList.head).elm[]
                          ->ymerBrowserInt.infoView.done;
                        ymerBrowserInt.infoView.msgList.head
                          ->ymerBrowserInt.infoView.msgList.delete
                    if)
                 #)
            do myMsgPop
            #);
          openParseEditor:
            (# fn: ^text
            enter fn[]
            do ((600,800),fn[])->ymer.openParseEditor
            #);
          theSemanticErrorViewer: ^semanticErrorViewer;
          semanticErrorViewer: gui.mySemanticViewer
            (#
               checkNode:: 
                 (# 
                 do
                    (if node.hasSemanticError then
                        true->value;
                        2 (* semantic error *) ->type;
                        (if (node.semanticError->mps.AST.isWarning) then
                            includeWarnings->value;
                            (if value then 4 (* warning *) ->type if)
                        if)
                     else
                        false->value
                    if)
                 #);
               setTitle:: 
                 (# 
                 do
                    (if noHits then
                        'No semantic errors'->t[]
                     else
                        'Semantic errors'->t[]
                    if);
                    (if includeWarnings then ' or warnings'->t.append if);
                    ' in: '->t.append;
                    fgName[]->t.append
                 #);
               setNodesListLabel:: 
                 (# 
                 do
                    (if true then
                        'Nodes'->t[]
                     else
                        (if includeWarnings then
                            'Semantic Errors and Warnings'->t[]
                         else
                            'Semantic Errors'->t[]
                        if)
                    if)
                 #);
               showSourceLine:: trueObject;
               open:: 
                 (# 
                 do
                    theGroupWithSemanticErrors[]->fg[];
                    theGroupWithSemanticErrors.name->fgName[];
                    
                 #)
            #);
          theGroupWithSemanticErrors: ^astInterface.fragmentGroup;
          showSemanticErrors:
            (# 
            enter theGroupWithSemanticErrors[]
            do
               (if theSemanticErrorViewer[] = none then
                   &semanticErrorViewer[]->theSemanticErrorViewer[];
                   ymerBrowserInt[]->theSemanticErrorViewer.init;
                   theSemanticErrorViewer.open
                else
                   (if not theSemanticErrorViewer.opened then
                       &semanticErrorViewer[]->theSemanticErrorViewer[];
                       ymerBrowserInt[]->theSemanticErrorViewer.init;
                       theSemanticErrorViewer.open
                    else
                       (theGroupWithSemanticErrors[],none ,none )
                         ->theSemanticErrorViewer.registerFragmentGroup;
                       theSemanticErrorViewer.show;
                       theSemanticErrorViewer.bringToFront
                   if)
               if)
            #);
          semanticEditorReady: booleanValue
            (# 
            do
               (if allowperform then
                   (if theSemanticErrorViewer[] <> none then
                       (if theSemanticErrorViewer.opened then
                           theSemanticErrorViewer.hasErrors->value
                       if)
                   if)
               if);
               
            #);
          nextSemanticError:
            (# 
            do
               (if semanticEditorReady then
                   theSemanticErrorViewer.selectNext
               if)
            #);
          searchFor: @
            (#
               t: ^text;
               caseSensitive,wholeWord,onlyApplications: @boolean;
               theNameDcl: ^astInterface.ast
            #);
          searchfg: ^astInterface.fragmentGroup;
          searchff: ^astInterface.fragmentForm;
          searchNode: ^astInterface.ast;
          theSearchViewer: ^searchviewer;
          searchViewer: gui.searchviewer
            (#
               checkNode::  (#  <<SLOT ymersiflibSearchCheckNode:DoPart>> #);
               setTitle:: 
                 (# 
                 do
                    (if noHits then
                        'No search hits in: '->t[]
                     else
                        'Search hits in: '->t[]
                    if);
                    fgName[]->t.append
                 #);
               setNodesListLabel::  (#  do 'Nodes'->t[] #);
               showSourceLine:: trueObject;
               checkGroupStatus:: 
                 (#  <<SLOT ymersiflibCheckGroupStatus:DoPart>> #);
               open:: 
                 (# 
                 do
                    searchfg[]->fg[];
                    (if fg[] <> none
                     then
                        fg.name->fgName[]
                    if);
                    
                 #)
            #);
          searchArea_cs: (#  exit 1 #);
          searchArea_ff: (#  exit 2 #);
          searchArea_fg: (#  exit 3 #);
          searchArea_project: (#  exit 4 #);
          searchArea_domain: (#  exit 5 #);
          searchArea_extent: (#  exit 6 #);
          showSearchHits:
            (#
               fg: ^astInterface.fragmentGroup;
               ff: ^astInterface.fragmentForm;
               node: ^astInterface.ast;
               t: ^text;
               caseSensitive,wholeWord,showAllHits,onlyApplications: @boolean;
               theNameDcl: ^astInterface.ast;
               searchArea: @integer
            enter
            (fg[],ff[],node[],t[],caseSensitive,wholeWord,searchArea,
             showAllHits,onlyApplications,theNameDcl[])
            <<SLOT ymersiflibSearchShowSearchHits:DoPart>>
            #);
          fgSearchExcludeSet: @set (# element:: mps.ast.fragmentgroup #);
          fgSearchSet: @set (# element:: mps.ast.fragmentgroup #);
          replaceAll:
            (#
               fg: ^astInterface.fragmentGroup;
               ff: ^astInterface.fragmentForm;
               node: ^astInterface.ast;
               t,newt: ^text;
               caseSensitive,wholeWord,replaceDeclaration,onlyApplications:
                 @boolean;
               theNameDcl: ^astInterface.ast;
               searchArea: @integer;
               currentNode:<
                 (# node: ^astInterface.ast enter node[] do INNER #)
            enter
            (fg[],ff[],node[],t[],newt[],caseSensitive,wholeWord,
             replaceDeclaration,searchArea,onlyApplications,theNameDcl[])
            <<SLOT ymersiflibSearchReplaceAll:DoPart>>
            #);
          recoverGroup: doCommand
            (#
               ge: ^edenv.groupEditor;
               g: ^astInterface.fragmentGroup;
               groupName: ^text;
               
            enter ge[]
            do
               (if ge[]
                // none then 'no groupEditor, should not happen'->putLine; 
                else
                   ge.fg[]->g[];
                   g.fullName->groupName[];
                   '#'->g.restoreBackup;
                   ge.groupTouched;
                   (false,true,true)->ge.save;
                   ge.resetGroupTouch;
                   (*ymerbrowserInt.currentGroup.close;*)
                   true->edenv.onGoingRecovery;
                   groupName[]->ymerbrowserInt.selectFragmentGroup;
                   (if ymerbrowserInt.cge[] = none then
                       'no groupEditor, should not happen'->putLine
                    else
                       ymerbrowserInt.cge.groupTouched;
                       false->ymerbrowserInt.cge.autoSaveFileExists
                   if);
                   false->edenv.onGoingRecovery;
                   
               if);
               
            #);
          revertGroup: doCommand
            (#
               g: ^astInterface.fragmentGroup;
               ge: ^edenv.groupEditor;
               f: @file;
               groupName: ^text;
               
            enter ge[]
            do
               (if ge[]
                // none then 'no groupEditor, should not happen'->putLine; 
                else
                   ge.fg[]->g[];
                   g.fullName->groupName[];
                   '#'->((g.diskFileName).copy).Append->f.name;
                   (if f.entry.exists then f.delete if);
                   ge.resetGroupTouch;
                   (* ymerbrowserInt.currentGroup.close;*)
                   groupName[]->ymerbrowserInt.selectFragmentGroup;
                   
               if);
               
            #);
          (*Edit: @ymerbrowser.codeEditorEditMenu
           (#
           formEditorExists::  (#  do ymerBrowserInt.cfe[]->cfe[] #);
           writeStatus::  (#  do t[]->writeInfoView #);
           open::  (#  do  #)
           #); *)
          (*          View: @codeEditorViewMenu
           (#
           formEditorExists::  (#  do browser.cfe[]->cfe[] #);
           open::  (#  do  #)
           #);
           *)
          sifPopupMenu: ymerbrowser.codeEditorPopUpMenu
            (#
               formEditorExists::  (#  do ymerbrowserInt.cfe[]->cfe[] #);
               open::  (#  do  #)
            #);
          popupMenu: ^sifPopupMenu;
          onCodeViewOpen:<
            (#
            (*
             acc: thecodeView.contents.action
             (#
             cme: ^window.codemoveableeditor;
             eventtype:: thecodeview.contents.theeventhandler.mouseDown;
             
             do cme[]->currentcodemoveableeditor[]; 
             #);
             a: ^acc
             do
             &acc[]->a[];
             theCodeView[]->a.cme[];
             a[]->theCodeView.contents.appendaction;
             INNER *)
            (* this operation is called before the sifviewer is created *) 
            #);
          subeditorWindow:< gui.window
            (#
               eventhandler::< 
                 (#
                    onActivate::<  (#  do true->ymer.isActive; INNER #);
                    onDeactivate::< 
                      (#  do false->ymer.isActive; INNER #);
                    
                 #);
               editor: @sifTextEditor (# codeViewerType::< codeeditor #);
               fe,sed: ^codeeditor;
               attach:
                 (# fe: ^codeEditor
                 enter fe[]
                 do
                    fe[]->Edit.attach;
                    fe[]->view.attach;
                    (*                  (fe[],edenv[])->slots.attach*)
                    
                 #);
               File: @mySimpleMenu
                 (#
                    iClose: @item
                      (# onSelect::  (#  do THIS(subEditorWindow).close #)
                      #);
                    open::  (#  do ('Close','w')->iClose.newKey #)
                 #);
               Edit: @codeEditorEditMenu;
               View: @codeEditorViewMenu;
               menubarType::< 
                 (#
                    open::< 
                      (# 
                      do
                         File.new;
                         File[]->append;
                         Edit.new;
                         Edit[]->append;
                         View.new;
                         View[]->append;
                         INNER ;
                         
                      #)
                 #);
               open::< 
                 (#
                    ff: ^astInterface.fragmentForm;
                    theEditorRoot,node: ^astInterface.ast;
                    help: ^text
                 enter (theEditorRoot[],node[])
                 do
                    (if theEditorRoot[] <> none then
                        ((theEditorRoot.frag.father).name).copy
                          ->edenv.fragmentDefaultName->help[];
                        help.length->help.pos;
                        '-'->help.put;
                        theEditorRoot.frag.name->help.putText;
                        help[]->title;
                        THIS(subeditorWindow).contents->editor.open;
                        (mps.ast[],fe.theGrammar[],theEditorRoot[],node[])
                          ->editor.newfragment->sed[];
                        (if sed[] <> none then
                            true->sed.isAsubEditor;
                            fe[]->sed.fatherEditor[];
                            fe.isReadOnly->sed.isReadOnly
                              ->sed.theSifTexteditor.isReadOnly;
                            sed[]->fe.subeditors.append;
                            sed[]->THIS(subeditorWindow).attach
                         else
                            'no subeditor created!'->putLine
                        if);
                        editor.size->size;
                        true->editor.bindBottom->editor.bindRight
                    if);
                    INNER
                 #)
            #);
          opensubeditorincanvas:
            (#
               cv: ^guienv.window.canvas;
               editor: @ymerbrowser.sifTextEditor
                 (# codeViewerType::< ymerbrowser.codeeditor #);
               fe,sed: ^ymerbrowser.codeeditor;
               theEditorRoot,node: ^astInterface.ast;
               
            enter (cv[],theEditorRoot[])
            do
               cv[]->editor.open;
               theEditorRoot[]->node[];
               (mps.ast[],fe.theGrammar[],theEditorRoot[],node[])
                 ->editor.newfragment->sed[];
               
            #);
          openSubeditor:
            (#
               theSubwindow: ^subeditorWindow;
               fe: ^ymerbrowser.codeeditor;
               editorRoot,node: ^astInterface.ast
            enter (editorRoot[],node[])
            do
               (editorRoot.frag[],node[])->edenv.findEditorForForm->fe[];
               (if fe[] <> none then
                   &subeditorWindow[]->theSubwindow[];
                   fe[]->theSubWindow.fe[];
                   (editorRoot[],node[])->theSubwindow.open
                else
                   'openSubeditor: node codeeditor found'->putLine;
                   (if ymerbrowserInt.cfe[] <> none then
                       (editorRoot[],editorRoot[],true)
                         ->ymerbrowserInt.cfe.selectNodeInFormEditor
                   if)
               if)
            #);
          callSearch:
            (# keepSearchCriteria: @boolean
            enter keepSearchCriteria
            <<SLOT ymersiflibSearchCallSearch:DoPart>>
            #);
          callReplace:
            (#
               keepSearchCriteria:
                 @boolean
            enter keepSearchCriteria
            <<SLOT ymersiflibSearchCallReplace:DoPart>>
            #);
          createImplementationFragment:
            (# fg: ^astInterface.fragmentGroup
            enter fg[]
            <<SLOT createImplementationFragment:DoPart>>
            #);
          selectImplementationFragment:
            (# fg: ^astInterface.fragmentGroup
            enter fg[]
            <<SLOT selectImplementationFragment:DoPart>>
            #);
          calculateBodyAndOriginName:
            (# (* calculates the body name for origin fg and vice versa *)
               originfg,bodyfg: ^astInterface.fragmentGroup;
               bodyName,originName: ^text
            enter (originfg[],bodyfg[])
            <<SLOT calculateBodyAndOriginName:DoPart>>
            exit (bodyName[],originName[])
            #);
          insertBodyAndOrigin:
            (# originfg,bodyfg: ^astInterface.fragmentGroup
            enter (originfg[],bodyfg[])
            <<SLOT insertBodyAndOrigin:DoPart>>
            #);
          debugPossible: booleanValue
            (#
               fg:
                 ^astInterface.fragmentGroup
            enter fg[]
            <<SLOT debugPossible:DoPart>>
            #);
          executableExists: booleanValue
            (# fg: ^astInterface.fragmentGroup; executable: ^text; f: @file
            enter fg[]
            <<SLOT performMenuExecutableExists:DoPart>>
            #);
          execute: executableExists
            (# msg: ^text
            <<SLOT performMenuExecute:DoPart>>
            #);
          isRunning: executableExists
            (#  <<SLOT performMenuIsRunning:DoPart>> #);
          kill: isRunning
            (# 
            <<SLOT performMenuKill:DoPart>>
            #);
          isProgram: booleanValue
            (# fg: ^astInterface.fragmentGroup
            enter fg[]
            <<SLOT performMenuIsProgram:DoPart>>
            #);
          jobFileTimer: @gui.timer
            (#
               action:: 
                 (# 
                 <<SLOT performMenuAction:DoPart>>
                 #)
            #);
          debug: booleanValue
            (#
               fg: ^astInterface.fragmentGroup;
               msg: ^text;
               compileNeeded,doCompile,OK: @boolean
            enter fg[]
            do
               l:
               fg[]
                 ->executableExists
                   (# doKill: @boolean; 
                   do
                      (if fg[]->isRunning then
                          'The program, '->msg[];
                          (fg.name).copy->msg.puttext;
                          ', is running, Kill?'->msg.puttext;
                          (none ,'Kill Program?',msg[])
                            ->GUI.promptForBoolean
                              (# ok::  (#  do true->doKill #) #);
                          (if doKill then fg[]->kill else leave l if)
                      if);
                      'Starting debugger on '->msg[];
                      executable[]->msg.append;
                      msg[]->writeInfoView;
                      (* (fg[],executable[])->debugProgram; *)
                      (if not
                      (executable[]
                         ->
                           ymerBrowserInt.debuggerExternalInterface.
                             debugProgram) then
                          (fg.name).copy->msg[];
                          '\nneeds recompilation\n\nCompile?'->msg.append;
                          (none ,'Compile?',msg[])
                            ->GUI.promptForBoolean
                              (# ok::  (#  do true->doCompile #) #);
                          (if doCompile then
                              (if fg[]->compile then
                                  false->compileNeeded->doCompile; restart l
                              if)
                          if)
                       else
                          true->value
                      if)
                   #)
            #);
          debugExe:
            (# 
            do ymerBrowserInt.debuggerExternalInterface.debugProgramAs
            #);
          setupFileMenu:
            (#
               sifFileMenuAction: gui.menuAppendItemAction
                 (#
                    newseparator:
                    (* Open and append a separator to THIS(simplemenu) *)
                      (# s: ^themenu.separator
                      do
                         &themenu.separator[]->s[];
                         s.open;
                         s[]->themenu.append;
                         
                      #);
                    iOpen: themenu.item
                      (#
                         onStatus::  (#  do true->value #);
                         onSelect:: 
                           (# 
                           do 'Open file'->ymerBrowserInt.projectMenuLoad; 
                           #)
                      #);
                    item: ^themenu.item;
                    iNew: themenu.item
                      (#
                         onStatus::  (#  do true->value #);
                         onSelect:: 
                           (#
                              fg: ^astInterface.fragmentGroup;
                              created: gui.createDialog
                                (#
                                   create:: 
                                     (# 
                                     do
                                        (ymerBrowser[],grammar[],groupName[],
                                         formName[])->edenv.new->fg[];
                                        (if fg[] <> none then
                                            fg.fullName
                                              ->ymerBrowserInt.addproject;
                                            ( (*browser[],*) fg[],none )
                                              ->updateBrowser
                                        if);
                                        
                                     #);
                                   cancel::  (#  do  #);
                                   
                                #);
                              dialog: ^created;
                              
                           do
                              &created[]->dialog[];
                              mps[]->dialog.mps[];
                              dialog.open;
                              (none ,'Create new file','untitled','untitled')
                                ->dialog.popup
                           #)
                      #);
                    iNewBetaProgram: themenu.item
                      (#
                         onStatus:: 
                           (#  do not checkOngoingTextediting->value #);
                         onSelect:: 
                           (#
                              ff: ^astInterface.fragmentForm;
                              fg: ^astInterface.fragmentGroup
                           do
                              (ymerBrowser[],none ,false)->edenv.newBetaProgram
                                ->fg[];
                              (if fg[] <> none then
                                  fg.fullName->ymerBrowserInt.addproject
                              if)
                           #)
                      #);
                    iNewBetaLibrary: themenu.item
                      (#
                         onStatus:: 
                           (#  do not checkOngoingTextEditing->value #);
                         onSelect:: 
                           (#
                              ff: ^astInterface.fragmentForm;
                              fg: ^astInterface.fragmentGroup
                           do
                              (ymerBrowser[],none ,false)->edenv.newBetaLibrary
                                ->fg[];
                              (if fg[] <> none then
                                  fg.fullName->ymerBrowserInt.addproject
                              if)
                           #)
                      #);
                    iSave: themenu.item
                      (#
                         onStatus::  (#  do allowCommand->value #);
                         onSelect:: 
                           (# 
                           do (true,false,true)->ymerBrowserInt.cge.save
                           #)
                      #);
                    iSaveAs: themenu.item
                      (#
                         onStatus:: 
                           (# 
                           do
                              groupEditorExists and not
                              ymerBrowserInt.cge.isAfrejaEditor->value
                           #);
                         onSelect:: 
                           (# newName: ^text
                           do
                              ymerBrowserInt.cge.saveAs->newName[];
                              (if newName[] <> none then
                                  newName[]->ymerBrowserInt.selectFragmentGroup;
                                  (if ymerBrowserInt.cge[] <> none then
                                      ymerBrowserInt.cge.groupTouched; 
                                   else
                                      'Save As: cge is none'->putline; 
                                  if);
                                  
                              if)
                           #)
                      #);
                    iSaveAll: themenu.item
                      (#
                         askSave:
                           (#
                              ge: ^edenv.groupEditor;
                              help: ^text;
                              cancelled,done: @boolean
                           enter ge[]
                           do
                              'Save changes to '->help[];
                              ge.fg.name->help.append;
                              '?'->help.append;
                              (ymerBrowser[],'Save group',help[])
                                ->gui.promptForBoolean
                                  (#
                                     done: @boolean;
                                     ok:: 
                                       (# 
                                       do
                                          (if not done then
                                              hide;
                                              true->done;
                                              (true,false,true)->ge.save
                                          if)
                                       #);
                                     notOK:: 
                                       (# 
                                       do
                                          (if not done then
                                              hide; true->done; 
                                          if)
                                       #);
                                     cancel:: 
                                       (# 
                                       do
                                          (if not done then
                                              hide; true->done; true->cancelled
                                          if)
                                       #);
                                     
                                  #)
                           exit cancelled
                           #);
                         onStatus::  (#  do true->value #);
                         onSelect:: 
                           (# 
                           do
                           (*edenv.saveAll; temporarily placed here to be able
                            to specify the fatherwindow for the dialog
                            in order to avoid "moving" dialogs *)
                              l: edenv.groupEditorList.scan
                                (# cancelled: @boolean
                                do
                                   (if (current.touched > 0) and not
                                   current.isAfrejaEditor then
                                       current[]->askSave->cancelled
                                    else
                                       doCommand
                                         (# 
                                         do
                                            (if current.needToUpdateTextFile and
                                            not current.isAFrejaEditor then
                                                current.fg[]
                                                  ->edenv.makeNewTextFile
                                            if)
                                         #)
                                   if);
                                   (if cancelled then leave l if)
                                #)
                           #)
                      #);
                    iSaveAbstract: themenu.item
                      (#
                         onStatus::  (#  do groupEditorExists->value #);
                         onSelect:: 
                           (#  do ymerBrowserInt.cge.saveabstract #)
                      #);
                    iRecover: themenu.item
                      (#
                         onStatus:: 
                           (# 
                           do
                              (if allowCommand then
                                  ymerBrowserInt.cge.autoSaveFileExists->value
                               else
                                  false->value
                              if)
                           #);
                         onSelect:: 
                           (# 
                           do
                              (ymerBrowser[],'Recover group',
                               'This command will also save the recovered fragment group\nDo you want to recover?')
                                ->gui.promptForBoolean
                                  (#
                                     ok:: 
                                       (# 
                                       do ymerBrowserInt.cge[]->recoverGroup
                                       #);
                                     
                                  #)
                           #)
                      #);
                    iRevert: themenu.item
                      (#
                         f: @file;
                         onStatus:: 
                           (# 
                           do
                              (if allowCommand then
                              (* '~'->((ymerBrowserInt.cge.fg.diskFileName).copy).Append->f.name;
                               f.entry.exists->value*)
                                  ymerBrowserInt.cge.touched > 0->value
                               else
                                  false->value
                              if);
                              (* temporarily disabled *)
                              false->value
                           #);
                         onSelect:: 
                           (#  do ymerBrowserInt.cge[]->revertGroup #)
                      #);
                    iPrint: themenu.item
                      (#
                         onStatus:: 
                           (# 
                           do
                              (if allowOnForm then
                                  formEditorExists->value
                               else
                                  false->value
                              if)
                           #);
                         onSelect:: 
                           (# 
                           do
                              ymerBrowserInt.cfe.theSifTexteditor.contents.print
                           #)
                      #);
                    iSetIsReadOnly: themenu.item
                      (#
                         onStatus:: 
                           (# 
                           do
                              groupeditorExists and not checkOngoingTextediting
                                ->value;
                              (if ymerBrowserInt.debuggerExternalInterface[] <>
                              none then
                                  (if
                                  ymerBrowserInt.debuggerExternalInterface.
                                    isDebugging then
                                      false->value
                                  if);
                                  
                              if);
                              (if groupeditorExists then
                                  ymerBrowserInt.cge.isReadOnly->checked; 
                              if)
                           #);
                         onSelect:: 
                           (# 
                           do
                              (if ymerBrowserInt.cge.isReadOnly then
                                  (if ymerBrowserInt.cge.groupFileWriteable then
                                      false->ymerBrowserInt.cge.setIsReadOnly;
                                      writeInfoViewClear
                                  if)
                               else
                                  true->ymerBrowserInt.cge.setIsReadOnly;
                                  'Write protected'->writeInfoView
                              if)
                           #)
                      #);
                    iSetGlobalWriteProtection: themenu.item
                      (#
                         onStatus:: 
                           (# 
                           do
                              edenv.globalWriteProtection->checked;
                              (if ymerBrowserInt.debuggerExternalInterface[] <>
                              none then
                                  not
                                  ymerBrowserInt.debuggerExternalInterface.
                                    isDebugging->value
                              if);
                              
                           #);
                         onSelect:: 
                           (# 
                           do
                              (if edenv.globalWriteProtection then
                                  false->edenv.setGlobalWriteProtection;
                                  writeInfoViewClear
                               else
                                  true->edenv.setGlobalWriteProtection;
                                  'Write protected'->writeInfoView
                              if)
                           #)
                      #);
                    
                 do
                    &iNew[]->item[];
                    'New...'->item.new;
                    &iNewBetaProgram[]->item[];
                    'New BETA Program...'->item.new;
                    &iNewBetaLibrary[]->item[];
                    'New BETA Library...'->item.new;
                    &iOpen[]->item[];
                    'Open...'->item.new;
                    newseparator;
                    &iSave[]->item[];
                    'Save'->item.new;
                    &iSaveAs[]->item[];
                    'Save as...'->item.new;
                    &iSaveAll[]->item[];
                    'Save All...'->item.new;
                    &iSaveAbstract[]->item[];
                    'Save Abstract...'->item.new;
                    newseparator;
                    &iRecover[]->item[];
                    'Recover...'->item.new;
                    &iRevert[]->item[];
                    'Revert...'->item.new;
                    newseparator;
                    &iPrint[]->item[];
                    'Print'->item.new;
                    newseparator;
                    &iSetIsReadOnly[]->item[];
                    'Group File Write Protection'->item.new;
                    &iSetGlobalWriteProtection[]->item[];
                    'Global Write Protection'->item.new;
                    newseparator;
                    
                 #);
               
            do &sifFileMenuAction[]->ymer.AddFileMenuAction; 
            #);
          (*menubarType::< 
           (#
           fileMenuType::< 
           (#
           
           
           #);
           newseparator:
           (* Open and append a separator to THIS(simplemenu) * )
           (# s: ^separator
           do &separator[]->s[]; s.open; s[]->append; 
           #);
           iOpen: @item
           (#
           onStatus::  (#  do true->value #);
           onSelect:: 
           (# 
           do
           'Open file'
           ->projectMenu.iLoad.theEventHandler.onSelect
           #)
           #);
           iNew: @item
           (#
           onStatus::  (#  do true->value #);
           onSelect:: 
           (#
           fg: ^astInterface.fragmentGroup;
           created: @createDialog
           (#
           create:: 
           (# 
           do
           (browser[],grammar[],groupName[],
           formName[])->edenv.new->fg[];
           (if fg[] <> none then
           fg.fullName->addproject;
           (*(browser[],fg[],none )->updateBrowser * )
           
           if);
           
           #);
           cancel::  (#  do  #);
           
           #)
           do
           created.open;
           (none ,'Create new file','untitled','untitled')
           ->created.popup
           #)
           #);
           iNewBetaProgram: @item
           (#
           onStatus:: 
           (#  do not checkOngoingTextediting->value #);
           onSelect:: 
           (#
           ff: ^astInterface.fragmentForm;
           fg: ^astInterface.fragmentGroup
           do
           (browser[],none ,false)->edenv.newBetaProgram
           ->fg[];
           (if fg[] <> none then
           fg.fullName->addproject
           if)
           #)
           #);
           iNewBetaLibrary: @item
           (#
           onStatus:: 
           (#  do not checkOngoingTextEditing->value #);
           onSelect:: 
           (#
           ff: ^astInterface.fragmentForm;
           fg: ^astInterface.fragmentGroup
           do
           (browser[],none ,false)->edenv.newBetaLibrary
           ->fg[];
           (if fg[] <> none then
           fg.fullName->addproject
           if)
           #)
           #);
           iSave: @item
           (#
           onStatus::  (#  do allowCommand->value #);
           onSelect:: 
           (#  do (true,false,true)->ymerBrowserInt.cge.save #)
           #);
           iSaveAs: @item
           (#
           onStatus:: 
           (# 
           do
           groupEditorExists and not
           ymerBrowserInt.cge.isAfrejaEditor->value
           #);
           onSelect:: 
           (# newName: ^text
           do
           ymerBrowserInt.cge.saveAs->newName[];
           (if newName[] <> none then
           browser.currentGroup.close;
           newName[]->browser.selectFragmentGroup;
           ymerBrowserInt.cge.groupTouched
           if)
           #)
           #);
           iSaveAll: @item
           (#
           askSave:
           (#
           ge: ^editorenv.groupEditor;
           help: ^text;
           cancelled,done: @boolean
           enter ge[]
           do
           'Save changes to '->help[];
           ge.fg.name->help.append;
           '?'->help.append;
           (THIS(ymerBrowserWindow)[],'Save group',help[])
           -> (*UI.* ) promptForBoolean
           (#
           done: @boolean;
           ok:: 
           (# 
           do
           (if not done then
           hide;
           true->done;
           (true,false,true)->ge.save
           if)
           #);
           notOK:: 
           (# 
           do
           (if not done then
           hide; true->done; 
           if)
           #);
           cancel:: 
           (# 
           do
           (if not done then
           hide; true->done; true->cancelled
           if)
           #);
           
           #)
           exit cancelled
           #);
           onStatus::  (#  do true->value #);
           onSelect:: 
           (# 
           do
           (*edenv.saveAll; temporarily placed here to be able
           to specify the fatherwindow for the dialog
           in order to avoid "moving" dialogs * )
           l: edenv.groupEditorList.scan
           (# cancelled: @boolean
           do
           (if (current.touched > 0) and not
           current.isAfrejaEditor then
           current[]->askSave->cancelled
           else
           doCommand
           (# 
           do
           (if current.needToUpdateTextFile and
           not current.isAFrejaEditor then
           current.fg[]
           ->edenv.makeNewTextFile
           if)
           #)
           if);
           (if cancelled then leave l if)
           #)
           #)
           #);
           iSaveAbstract: @item
           (#
           onStatus::  (#  do groupEditorExists->value #);
           onSelect::  (#  do ymerBrowserInt.cge.saveabstract #)
           #);
           iRecover: @item
           (#
           onStatus:: 
           (# 
           do
           (if allowCommand then
           ymerBrowserInt.cge.autoSaveFileExists->value
           else
           false->value
           if)
           #);
           onSelect:: 
           (# 
           do
           (THIS(ymerBrowserWindow)[],'Recover group',
           'This command will also save the recovered fragment group\nDo you want to recover?')
           ->promptForBoolean
           (#
           ok:: 
           (# 
           do ymerBrowserInt.cge[]->recoverGroup
           #);
           
           #)
           #)
           #);
           iRevert: @item
           (#
           f: @file;
           onStatus:: 
           (# 
           do
           (if allowCommand then
           (* '~'->((ymerBrowserInt.cge.fg.diskFileName).copy).Append->f.name;
           f.entry.exists->value* )
           ymerBrowserInt.cge.touched > 0->value
           else
           false->value
           if);
           (* temporarily disabled * )
           false->value
           #);
           onSelect::  (#  do ymerBrowserInt.cge[]->revertGroup #)
           #);
           iPrint: @item
           (#
           onStatus:: 
           (# 
           do
           (if allowOnForm then
           formEditorExists->value
           else
           false->value
           if)
           #);
           onSelect:: 
           (# 
           do browser.cfe.theSifTexteditor.contents.print
           #)
           #);
           iSetIsReadOnly: @item
           (#
           onStatus:: 
           (# 
           do
           groupeditorExists and not checkOngoingTextediting
           ->value;
           (if groupeditorExists then
           ymerBrowserInt.cge.isReadOnly->checked; 
           if)
           #);
           onSelect:: 
           (# 
           do
           (if ymerBrowserInt.cge.isReadOnly then
           (if ymerBrowserInt.cge.groupFileWriteable then
           false->ymerBrowserInt.cge.setIsReadOnly;
           writeInfoViewClear
           if)
           else
           true->ymerBrowserInt.cge.setIsReadOnly;
           'Write protected'->writeInfoView
           if)
           #)
           #);
           iSetGlobalWriteProtection: @item
           (#
           onStatus:: 
           (#  do edenv.globalWriteProtection->checked;  #);
           onSelect:: 
           (# 
           do
           (if edenv.globalWriteProtection then
           false->edenv.setGlobalWriteProtection;
           writeInfoViewClear
           else
           true->edenv.setGlobalWriteProtection;
           'Write protected'->writeInfoView
           if)
           #)
           #);
           open::< 
           (# 
           do
           'New...'->iNew.new;
           (if isBETAsif then
           'New BETA Program...'->iNewBetaProgram.new;
           'New BETA Library...'->iNewBetaLibrary.new
           if);
           'Open...'->iOpen.new;
           iClose.open;
           iClose[]->append;
           newSeparator;
           'Save'->iSave.new;
           'Save As...'->iSaveAs.new;
           'Save All...'->iSaveAll.new;
           'Save Abstract...'->iSaveAbstract.new;
           newSeparator;
           'Recover...'->iRecover.new;
           'Revert'->iRevert.new;
           newSeparator;
           'Print...'->iPrint.new;
           newSeparator;
           'Group File Write Protection'->iSetIsReadOnly.new;
           'Global Write Protection'
           ->iSetGlobalWriteProtection.new;
           newSeparator;
           INNER ;
           
           #)
           #);
           open::< 
           (# 
           do
           useExternalTexteditor->Edit.useExternalTextEditor;
           Edit.new;
           Edit[]->append;
           isBETAsif->View.BETAsif;
           View.new;
           View[]->append;
           (if isBETAsif then
           SLOTs.new; SLOTs[]->append; 'Fragments'->GroupEdit.new
           if);
           <<SLOT compilerMenuOpen:Descriptor>>;
           #)
           #);
           *)
          (*open::< 
           (# 
           do initCompiler; INNER
           #);*)
          GroupEditMenu: ymerbrowser.mysimplemenu
            (#
               iUndo: @item
                 (#
                    onStatus:: 
                      (# 
                      do
                         (if allowPerform then
                             ymerBrowserInt.cge.askUndoPermission->value
                          else
                             false->value
                         if)
                      #);
                    onSelect::  (#  do ymerBrowserInt.cge.undo;  #)
                 #);
               iCut: @item
                 (#
                    onStatus:: 
                      (# 
                      do
                         (if allowOnForm then
                             formEditorExists->value
                          else
                             false->value
                         if)
                      #);
                    onSelect:: 
                      (# brotherff: ^astInterface.fragmentForm
                      do
                         ymerBrowserInt.cfe.frag[]->ymerBrowserInt.cge.cutForm
                           ->brotherff[];
                         (if brotherff[] <> none then
                             ((brotherff.father).fullName,brotherff.name)
                               ->ymerBrowserInt.selectFragmentForm
                         if)
                      #)
                 #);
               iCopy: @item
                 (#
                    onStatus:: 
                      (# 
                      do
                         (if allowOnForm then
                             formEditorExists->value
                          else
                             false->value
                         if)
                      #);
                    onSelect:: 
                      (# 
                      do ymerBrowserInt.cfe.frag[]->ymerBrowserInt.cge.copyForm
                      #)
                 #);
               iPaste: @item
                 (#
                    onStatus:: 
                      (# 
                      do
                         (if allowOnForm then
                             (if formEditorExists then
                                 ymerBrowserInt.cfe.frag[]
                                   ->ymerBrowserInt.cge.askPastePermission
                                   ->value
                              else
                                 false->value
                             if)
                          else
                             false->value
                         if)
                      #);
                    onSelect:: 
                      (# 
                      do
                         ymerBrowserInt.cfe.frag[]->ymerBrowserInt.cge.pasteForm
                           ->findForm
                      #)
                 #);
               iAppend: @item
                 (#
                    onStatus:: 
                      (# 
                      do
                         (if allowPerform then
                             ymerBrowserInt.cge.askPastePermission->value
                          else
                             false->value
                         if)
                      #);
                    onSelect:: 
                      (# ff: ^astInterface.fragmentForm
                      do none ->ymerBrowserInt.cge.pasteForm->ff[]->findForm; 
                      #)
                 #);
               iInsertDoPartFragmentForm: @item
                 (#
                    onStatus:: 
                      (# 
                      do
                         (if allowOnForm then
                             ymerBrowserInt.cge.askInsertPermission->value
                          else
                             false->value
                         if)
                      #);
                    onSelect:: 
                      (# ff: ^astInterface.fragmentForm
                      do
                         (if ymerBrowserInt.cfe[] <> none then
                             ymerBrowserInt.cfe.frag[]->ff[]
                         if);
                         (ff[],31)->ymerBrowserInt.cge.insertForm->ff[];
                         (if ff[] <> none then ff[]->findForm if)
                      #)
                 #);
               iInsertDescriptorFragmentForm: @item
                 (#
                    onStatus:: 
                      (# 
                      do
                         (if allowOnForm then
                             ymerBrowserInt.cge.askInsertPermission->value
                          else
                             false->value
                         if)
                      #);
                    onSelect:: 
                      (# ff: ^astInterface.fragmentForm
                      do
                         (if ymerBrowserInt.cfe[] <> none then
                             ymerBrowserInt.cfe.frag[]->ff[]
                         if);
                         (ff[],2)->ymerBrowserInt.cge.insertForm->ff[];
                         (if ff[] <> none then ff[]->findForm if)
                      #)
                 #);
               iInsertAttributesFragmentForm: @item
                 (#
                    onStatus:: 
                      (# 
                      do
                         (if allowOnForm then
                             ymerBrowserInt.cge.askInsertPermission->value
                          else
                             false->value
                         if)
                      #);
                    onSelect:: 
                      (# ff: ^astInterface.fragmentForm
                      do
                         (if ymerBrowserInt.cfe[] <> none then
                             ymerBrowserInt.cfe.frag[]->ff[]
                         if);
                         (ff[],3)->ymerBrowserInt.cge.insertForm->ff[];
                         (if ff[] <> none then ff[]->findForm if)
                      #)
                 #);
               iEditProperties: @item
                 (#
                    onStatus::  (#  do allowCommand->value #);
                    onSelect:: 
                      (#  do ymerBrowserInt.cge.editProperties;  #)
                 #);
               iEditFormName: @item
                 (#
                    onStatus:: 
                      (# 
                      do
                         (if allowOnForm then
                             formEditorExists->value
                          else
                             false->value
                         if)
                      #);
                    onSelect:: 
                      (# 
                      do
                         ymerBrowserInt.cfe.frag[]
                           ->ymerBrowserInt.cge.editFormName;
                         ( (*ymerBrowser[],*)
                         ymerBrowserInt.cge.fg[],ymerBrowserInt.cfe.frag[])
                           ->updateBrowser
                      #)
                 #);
               iSearch: @item
                 (#
                    onStatus:: 
                      (# 
                      do
                         (ymerbrowserInt.currentProject[] <> none ) and
                         (edenv[] <> none ) and not edenv.textediting->value
                      #);
                    onSelect::  (#  do callSearch #)
                 #);
               iReplace: @item
                 (#
                    onStatus:: 
                      (# 
                      do
                         (ymerbrowserInt.currentProject[] <> none ) and
                         (edenv[] <> none ) and not edenv.textediting->value
                      #);
                    onSelect::  (#  do callReplace #)
                 #);
               open::< 
                 (# 
                 do
                    'Fragments'->name;
                    'Undo Fragment Form Editing'->iUndo.new;
                    newSeparator;
                    'Cut Fragment Form'->iCut.new;
                    'Copy Fragment Form'->iCopy.new;
                    'Paste Fragment Form Before'->iPaste.new;
                    'Paste Fragment Form At End'->iAppend.new;
                    newSeparator;
                    'Insert DoPart Fragment Form...'
                      ->iInsertDoPartFragmentForm.new;
                    'Insert Descriptor Fragment Form...'
                      ->iInsertDescriptorFragmentForm.new;
                    'Insert Attributes Fragment Form...'
                      ->iInsertAttributesFragmentForm.new;
                    newSeparator;
                    ('Edit ORIGIN, INCLUDE etc ...','m')
                      ->iEditProperties.newKey;
                    'Edit Fragment Form Name...'->iEditFormName.new;
                    newSeparator;
                    ('Search...','s')->iSearch.newKey;
                    ('Replace...','r')->iReplace.newKey
                 #)
            #);
          GroupPerform: ymerbrowser.mysimplemenu
            (#
               iCheck: @item
                 (#
                    newName: ^text;
                    onStatus:: 
                      (#  <<SLOT performMenuCheckOnStatus:DoPart>> #);
                    onSelect:: 
                      (# 
                      <<SLOT performMenuCheckOnSelect:DoPart>>
                      #)
                 #);
               iReCheck: @item
                 (#
                    newName: ^text;
                    onStatus:: 
                      (#  <<SLOT performMenuReCheckOnStatus:DoPart>> #);
                    onSelect:: 
                      (# 
                      <<SLOT performMenuReCheckOnSelect:DoPart>>
                      #)
                 #);
               iCompile: @item
                 (#
                    newName: ^text;
                    onStatus:: 
                      (#  <<SLOT performMenuCompileOnStatus:DoPart>> #);
                    onSelect:: 
                      (#
                         newName:
                           ^text
                      <<SLOT performMenuCompileOnSelect:DoPart>>
                      #)
                 #);
               iRecompile: @item
                 (#
                    newName: ^text;
                    onStatus:: 
                      (# 
                      <<SLOT performMenuRecompileOnStatus:DoPart>>
                      #);
                    onSelect:: 
                      (#  <<SLOT performMenuRecompileOnSelect:DoPart>> #)
                 #);
               iExecute: @item
                 (#
                    newName: ^text;
                    onStatus:: 
                      (# 
                      <<SLOT performMenuExecuteOnStatus:DoPart>>
                      #);
                    onSelect:: 
                      (#  <<SLOT performMenuExecuteOnSelect:DoPart>> #)
                 #);
               iReExecute: @item
                 (#
                    newName: ^text;
                    onStatus:: 
                      (# 
                      <<SLOT performMenuReExecuteOnStatus:DoPart>>
                      #);
                    onSelect:: 
                      (# msg: ^text
                      <<SLOT performMenuReExecuteOnSelect:DoPart>>
                      #)
                 #);
               iCompileAndExecute:
                 @item
                 (#
                    newName: ^text;
                    onStatus:: 
                      (# 
                      <<SLOT performMenuCompileAndExecuteOnStatus:DoPart>>
                      #);
                    onSelect:: 
                      (# newName: ^text
                      <<SLOT performMenuCompileAndExecuteOnSelect:DoPart>>
                      #)
                 #);
               iRecompileAndExecute: @item
                 (#
                    newName: ^text;
                    onStatus:: 
                      (# 
                      <<SLOT performMenuRecompileAndExecuteOnStatus:DoPart>>
                      #);
                    onSelect:: 
                      (# 
                      <<SLOT performMenuRecompileAndExecuteOnSelect:DoPart>>
                      #)
                 #);
               iKill:
                 @item
                 (#
                    newName: ^text;
                    onStatus:: 
                      (#  <<SLOT performMenuKillOnStatus:DoPart>> #);
                    onSelect:: 
                      (# 
                      <<SLOT performMenuKillOnSelect:DoPart>>
                      #)
                 #);
               iSemanticErrors: @item
                 (#
                    onStatus:: 
                      (# 
                      <<SLOT performMenuSemanticErrorsOnStatus:DoPart>>
                      #);
                    onSelect:: 
                      (# 
                      <<SLOT performMenuSemanticErrorsOnSelect:DoPart>>
                      #)
                 #);
               iNextSemanticError: @item
                 (#
                    onStatus::  (#  do semanticEditorReady->value #);
                    onSelect::  (#  do nextSemanticError #)
                 #);
               iDebug: @item
                 (#
                    newname: ^text;
                    onStatus:: 
                      (# 
                      do
                         (if groupEditorExists then
                             ymerBrowserInt.cge.fg[]->debugPossible->value
                          else
                             (lastProgramFG[] <> none )->value
                         if)
                      #);
                    onSelect::  (#  #)
                 #);
               iDebugAs: @item
                 (#
                    newname: ^text;
                    onStatus:: 
                      (# t: ^text
                      do
                         true->value;
                         machine_type->t[];
                         (if 'hpux9pa'->t.equalncs then false->value if)
                      #);
                    onSelect::  (#  do debugExe #)
                 #);
               iReDebug: @item
                 (#
                    newName: ^text;
                    onStatus:: 
                      (#  <<SLOT performMenuReDebugOnStatus:DoPart>> #);
                    onSelect:: 
                      (# 
                      do
                         lastProgramFG[]->debug
                      #)
                 #);
               open::< 
                 (# 
                 do
                    <<SLOT compilerPerformMenu:Descriptor>>;
                    'Compile/Run'->name;
                    INNER
                 #)
            #);
          setupMenus:
            (#
               thebar: ^gui.menubar;
               Fragments:
                 ^groupEditMenu;
               Compile: ^groupPerform;
               
            enter thebar[]
            do
               &groupEditMenu[]
                 ->fragments[];
               fragments.open;
               fragments[]
                 ->thebar.append;
               &groupPerform[]
                 ->compile[];
               compile.open;
               compile[]->thebar.append;
               
            #);
          
       #);
     inithere: @boolean;
     isBETAsif:< booleanValue;
     useExternalTextEditor:<
      booleanValue;
     externalTextEdit:<
       (# textBefore,textAfter: ^text
       enter textBefore[]
       do INNER
       exit textAfter[]
       #);
     executeProgram:< (# name: ^text enter name[] do INNER #);
     isProgramRunning:< booleanValue
       (# name: ^text enter name[] do INNER #);
     killProgram:< (# name: ^text enter name[] do INNER #);
     askKillPrograms:< object;
     editorVersion: (#  exit '5.2(0)' #);
     compilerVersion:<
       (# version: ^text
       do <<SLOT sifCompilerVersion:Descriptor>>; INNER
       exit version[]
       #);
     setCompilerOptions:<
       (# compiler: ^object; 
       enter compiler[]
       do INNER setCompilerOptions
       #);
     betaenvVersion:<
       (# t: ^text
       do
          '~beta/basiclib/betaenv'->t[];
          INNER
       exit t[]
       #);
     frejaInclude:<
       (# t: ^text
       do
          '~beta/freja/associations'->t[];
          INNER
       exit t[]
       #);
     onAboutToCloseGroup:<
       (#
          fg: ^astInterface.fragmentGroup;
          OKtoClose,askSave: @boolean
          (* if OKtoClose the groupEditor is closed.
           * if askSave the user is prompted whether to save the group
           * else it is just saved (if necessary)
           *)
       enter fg[]
       do true->OKtoClose->askSave; INNER
       exit (OKtoClose,askSave)
       #);
     askEditUserinterface:< booleanValue
       (# node: ^astInterface.ast enter node[] do true->value; INNER #);
     editUserinterface:<
       (# frag: ^astInterface.fragmentForm; node: ^astInterface.ast
       enter (frag[],node[])
       do INNER
       #);
     OKtoTextedit:< booleanValue (* ask interface builder *)
       (# node: ^astInterface.ast enter node[] do true->value; INNER #);
     (*          init::< 
      (# 
      do
      ymerBrowser.open;
      ymerBrowser[]->ymerBrowser.ymerCallBack.theBrowser[];
      ymerBrowser.ymerCallback[]->ymerBrowser.edenv.ymerCallback[];
      INNER
      exit (mps.ast[],mps.betaCFL[])
      #); *)
     doTest,useExtTextEd,hiddenSif: @boolean;
     analyzeArg:
       (#
          arg,fgname,ffname: ^text;
          dashPos,dashPos2,slashPos: @integer;
          isAlphaNumeric: booleanValue
            (# t,s: ^text
            enter t[]
            do
               true->value;
               t.copy->s[];
               s.makeLC;
               loop: s.scanAll
                 (# 
                 do
                    (if not
                    (((ch >= 'a') and (ch <= 'z')) or
                     ((ch >= '0') and (ch <= '9'))) then
                        false->value; leave loop
                    if)
                 #)
            #)
       enter arg[]
       do
          0->dashPos->slashPos;
          ''->fgName[]->ffName[];
          '-'->arg.findAll (#  do inx->dashPos #);
          (if dashPos > 0 then
              (1,dashPos-1)->arg.sub->fgname[];
              '-'->fgname.findAll (#  do inx->dashPos2 #);
              (if dashPos2 > 0 then
                  ''->fgname[]
               else
                  (dashPos+1,arg.length)->arg.sub->ffName[];
                  (if not (ffname[]->isAlphaNumeric) then ''->ffname[] if)
              if)
           else
              arg[]->fgname[]
          if)
       exit (fgname[],ffname[])
       #);
     setupMenus:
       (# 
       do
          &gui.MenubarAppendMenuAction
            (#
               View: theBrowser.ymerBrowser.codeEditorViewMenu
                 (#
                    browser: ^ymerBrowserInterface;
                    formEditorExists::  (#  do browser.cfe[]->cfe[] #);
                    
                 #);
               vm: ^View;
               Edit: theBrowser.ymerBrowser.codeEditorEditMenu
                 (#
                    browser: ^ymerBrowserInterface;
                    formEditorExists::  (#  do browser.cfe[]->cfe[];  #);
                    writeStatus::  (#  do (* t[]->writeInfoView *)  #);
                    
                 #);
               em: ^Edit;
               SLOTs: theBrowser.ymerBrowser.codeEditorSLOTsMenu
                 (#
                    browser: ^ymerBrowserInterface;
                    formEditorExists::  (#  do browser.cfe[]->cfe[] #);
                    groupEditorExists::  (#  do browser.cge[]->cge[] #);
                    
                 #);
               sl: ^SLOTs;
               
            do
               &edit[]->em[];
               theBrowser[]->em.browser[];
               useExternalTexteditor->em.useExternalTexteditor;
               em.open;
               em[]->themenubar.append;
               &View[]->vm[];
               theBrowser[]->vm.browser[];
               vm.open;
               vm[]->themenubar.append;
               &SLOTs[]->sl[];
               theBrowser[]->sl.browser[];
               sl.open;
               sl[]->themenubar.append;
               
            #)[]->ymer.AddMenuAction;
          
       #);
     init:
       (# 
       enter ymer[]
       do
          true->iseditor;
          ymer.mps[]->mps[];
          ymer.gui[]->gui[];
          getsystemenv->theSystemenv[];
          objectpool.get (# type::< editorPreferences;  #)->editorPrefs[]
       #)
  #)  

