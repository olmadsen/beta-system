ORIGIN '~beta/designenv/v2.3/designenv';
BODY 'private/diagramattributes'
     'private/menubody'
     'private/designinterfacebody'
     'private/oaddocumentbody'
     'private/objectdiagrambody'
     'private/objectmenubody'
     'private/userdatabody';
INCLUDE '~beta/betaast/v5.1.1/betasematt'
        '~beta/betaast/v5.1.1/gram'
        '~beta/containers/v1.5/list'
        'indexIDList'
        '~beta/pretty/v5.1.1/pplib'
        '~beta/unixlib/v1.5/errorscreen'
        '~beta/basiclib/v1.5/formatio';
-- lib: Attributes --
containerlist: list (#  #);
GppInterface:
  (#
     switch: [100] @boolean;
     stdErr: @errorScreen;
     doQuit: @boolean;
     doClose: @boolean;
     trace:
       (# s: @Integer; T: @Text; 
       enter s
       do
          (if switch[s]
           // true then
              '%'->screen.put;
              s->screen.putint;
              ': '->screen.puttext;
              INNER ;
              T[]->screen.putline;
              
          if)
       #);
     resizeMenubar:< (#  do INNER resizeMenubar #);
     frejaAssociationsInclude:<
       (# t: ^text do INNER frejaAssociationsInclude exit t[] #);
     enableEditName:< (#  do INNER enableEditName #);
     disableEditName:< (#  do INNER disableEditName #);
     callChecker:<
       (# fg: ^mps.fragmentGroup enter fg[] do INNER callChecker #);
     sifSaveAndQuit:< (#  do INNER sifSaveAndQuit #);
     sifSave:< (#  do INNER sifSave #);
     sifAutoSave:< (#  do INNER sifAutoSave #);
     sifAddProp:<
       (# fg: ^mps.fragmentGroup; propName,propString: ^text
       enter (fg[],propName[],propString[])
       do INNER sifAddProp
       #);
     fileDialog:< (# filename: @text do INNER exit filename #);
     alertUser:< (# message: ^text enter message[] do INNER #);
     promptForBoolean:<
       (# titleText,msgText: ^text; ok: @integer
       enter (titleText[],msgText[])
       do INNER promptForBoolean
       exit ok
       #);
     yes: (#  exit 2 #);
     no: (#  exit 1 #);
     cancel: (#  exit 0 #);
     theDesignInterface: @DesignInterface;
     DesignInterface:< designenv (* interface to OO DesignEnvironment *)
       (#
          OADDocument:< Document (* my special document *)
            (#
               ObjectPage:< Page
                 (#
                    ShowDynamicCreations,showProcedureCalls: @Boolean;
                    onInit::<  (#  do <<SLOT onInit:Descriptor>>;  #);
                    ObjectdiagramNode:
                    (* Abstract superclass *) genericnode
                      (#
                         Parentnode: ^DetailedObjectNode;
                         theDecl: ^betaGram.NameDcl;
                         theObjectDescriptor: ^betaGram.ObjectDescriptor;
                         titletext: @Text;
                         oldPosition: @Point;
                         display:<
                           (# drawOnly: @Boolean
                           enter (theDecl[],theObjectDescriptor[],drawOnly)
                           do <<SLOT ObjectDiagramNodeDisplay:Descriptor>>; 
                           #);
                         overview:
                           (# 
                           do
                              <<SLOT ObjectDiagramNodeOverview:Descriptor>>;
                              
                           #);
                         getPage: (#  exit THIS(ObjectPage)[] #);
                         onSelect::< 
                           (# 
                           do <<SLOT ObjectdiagramNodeOnSelect:Descriptor>>; 
                           #);
                         onDrag::<
                          
                           (# 
                           do <<SLOT ObjectdiagramNodeOnDrag:Descriptor>>; 
                           #)
                      #);
                    AbstractedObjectnode: ObjectdiagramNode
                      (#
                         pagelink: ^ObjectPage;
                         display::< 
                           (# 
                           do <<SLOT AbstractedObjectNodeDisplay:Descriptor>>
                           #);
                         onDoubleclick::< 
                           (# 
                           do
                              <<SLOT AbstractedObjectNodeOnDoubleclick:Descriptor>>;
                              
                           #);
                         detail:<
                           (# detailnode: ^DetailedObjectNode
                           do <<SLOT AbstractedObjectNodeDetail:Descriptor>>
                           exit
                           detailnode[]
                           #);
                         detailRecursive:<
                           (# detailnode: ^DetailedObjectNode
                           do
                              <<SLOT AbstractedObjectNodeDetailRecursive:Descriptor>>
                           #)
                      #);
                    DetailedObjectnode: ObjectdiagramNode
                      (#
                         ODNodes: (* List of component objectdiagramnodes *)
                           @containerlist
                           (# element::< ObjectdiagramNode #);
                         regionObject: ^genericnode;
                         startX,startY: @Integer;
                         nextX,nextY: @Integer;
                         column: @Integer;
                         row: @Integer;
                         oldRow: @Integer;
                         ShowSimpleObjects: @boolean;
                         calculateBox:
                           (# x,y,w,h: @Integer
                           do
                              <<SLOT DetailedObjectNodeCalculateBox:Descriptor>>
                           exit (x,y,w,h,THIS(OADDocument).shape.RndRect)
                           #);
                         display::< 
                           (# 
                           do <<SLOT DetailedObjectNodeDisplay:Descriptor>>; 
                           #);
                         redisplay:<
                           (# theDetailed: ^DetailedObjectNode
                           enter theDetailed[]
                           do <<SLOT DetailedObjectNodeRedisplay:Descriptor>>
                           #);
                         onDoubleClick::< 
                           (# 
                           do
                              <<SLOT DetailedObjectNodeOnDoubleClick:Descriptor>>
                           #);
                         abstract:<
                           (# node: ^AbstractedObjectNode
                           do <<SLOT DetailedObjectNodeAbstract:Descriptor>>
                           #);
                         abstractRecursive:<
                           (# node: ^AbstractedObjectNode
                           do
                              <<SLOT DetailedObjectNodeAbstractRecursive:Descriptor>>
                           #);
                         showSimple:<
                           (# 
                           do
                              <<SLOT DetailedObjectNodeShowSimple:Descriptor>>; 
                           #);
                         hideSimple:<
                           (# 
                           do
                              <<SLOT DetailedObjectNodeHideSimple:Descriptor>>; 
                           #);
                         compact:<
                           (# 
                           do <<SLOT DetailedObjectNodeCompact:Descriptor>>; 
                           #);
                         blowup:<
                           (# 
                           do
                              <<SLOT DetailedObjectNodeBlowup:Descriptor>>;
                              
                           #)
                      #);
                    AbstrOperationObjectnode: AbstractedObjectNode
                      (#
                         display::< 
                           (# 
                           do
                              <<SLOT AbstrOperationObjectNodeDisplay:Descriptor>>;
                              
                           #);
                         detail::< 
                           (# 
                           do
                              <<SLOT AbstrOperationObjectNodeDetail:Descriptor>>
                           #)
                      #);
                    AbstrPartObjectNode: AbstractedObjectNode
                      (#
                         display::< 
                           (# 
                           do <<SLOT AbstrPartObjectNodeDisplay:Descriptor>>; 
                           #);
                         detail::< 
                           (# 
                           do <<SLOT AbstrPartObjectNodeDetail:Descriptor>>; 
                           #)
                      #);
                    AbstrRepPartObjectNode: AbstrPartObjectNode
                      (#
                         display::< 
                           (# 
                           do
                              <<SLOT AbstrRepPartObjectNodeDisplay:Descriptor>>;
                              
                           #);
                         detail::< 
                           (# 
                           do
                              <<SLOT AbstrRepPartObjectNodeDetail:Descriptor>>; 
                           #)
                      #);
                    DetailPartObjectNode: DetailedObjectNode
                      (#
                         display::< 
                           (# 
                           do <<SLOT DetailPartObjectNodeDisplay:Descriptor>>; 
                           #);
                         Abstract::< 
                           (# 
                           do <<SLOT DetailPartObjectNodeAbstract:Descriptor>>
                           #)
                      #);
                    DetailRepPartObjectNode: DetailPartObjectNode
                      (#
                         display::< 
                           (# 
                           do
                              <<SLOT DetailRepPartObjectNodeDisplay:Descriptor>>;
                              
                           #);
                         Abstract::< 
                           (# 
                           do
                              <<SLOT DetailRepPartObjectNodeAbstract:Descriptor>>
                           #)
                      #);
                    AbstrDynamicObjectNode: AbstractedObjectNode
                      (#
                         display::< 
                           (# 
                           do
                              <<SLOT AbstrDynamicObjectNodeDisplay:Descriptor>>;
                              
                           #);
                         detail::< 
                           (# 
                           do
                              <<SLOT AbstrDynamicObjectNodeDetail:Descriptor>>; 
                           #)
                      #);
                    DetailDynamicObjectNode: DetailedObjectNode
                      (#
                         display::< 
                           (# 
                           do
                              <<SLOT DetailDynamicObjectNodeDisplay:Descriptor>>
                           #);
                         Abstract::< 
                           (# 
                           do
                              <<SLOT DetailDynamicObjectNodeAbstract:Descriptor>>
                           #)
                      #);
                    DetailOperationObjectNode: DetailedObjectNode
                      (#
                         display::< 
                           (# 
                           do
                              <<SLOT DetailOperationObjectNodeDisplay:Descriptor>>
                           #);
                         Abstract::< 
                           (# 
                           do
                              <<SLOT DetailOperationObjectNodeAbstract:Descriptor>>
                           #)
                      #);
                    AbstrPartComponentNode: AbstrPartObjectNode
                      (#
                         display::< 
                           (# 
                           do <<SLOT AbstrPartComponentNodeDisplay:Descriptor>>
                           #);
                         detail::< 
                           (# 
                           do <<SLOT AbstrPartComponentNodeDetail:Descriptor>>
                           #)
                      #);
                    AbstrDynamicComponentNode: AbstrDynamicObjectNode
                      (#
                         display::< 
                           (# 
                           do
                              <<SLOT AbstrDynamicComponentNodeDisplay:Descriptor>>
                           #);
                         detail::< 
                           (# 
                           do
                              <<SLOT AbstrDynamicComponentNodeDetail:Descriptor>>
                           #)
                      #);
                    DetailPartComponentNode: DetailPartObjectNode
                      (#
                         display::< 
                           (# 
                           do
                              <<SLOT DetailPartComponentNodeDisplay:Descriptor>>;
                              
                           #);
                         Abstract::< 
                           (# 
                           do
                              <<SLOT DetailPartComponentNodeAbstract:Descriptor>>
                           #)
                      #);
                    DetailDynamicComponentNode: DetailDynamicObjectNode
                      (#
                         display::< 
                           (# 
                           do
                              <<SLOT DetailDynamicComponentNodeDisplay:Descriptor>>;
                              
                           #);
                         Abstract::< 
                           (# 
                           do
                              <<SLOT DetailDynamicComponentNodeAbstract:Descriptor>>
                           #)
                      #);
                    newConnector:
                      (# node1,node2: ^ObjectdiagramNode
                      enter (node1[],node2[])
                      do <<SLOT newConnector:Descriptor>>; 
                      #);
                    newDynConnector:
                      (#
                         node1,node2:
                           ^ObjectdiagramNode
                      enter (node1[],node2[])
                      do <<SLOT newDynConnector:Descriptor>>; 
                      #);
                    changedFocus:<
                      (# anAST: ^MPS.AST
                      enter anAST[]
                      do INNER
                      #);
                    Activate::< 
                      (# 
                      do
                         <<SLOT Activate:Descriptor>>;
                         
                      #)
                 #);
               OADPage:< Page
                 (#
                    <<SLOT OADPageLib:Attributes>>;
                    <<SLOT PropertyDiagramLib:Attributes>>;
                    <<SLOT CompositionDiagramLib:Attributes>>;
                    PatternDiagrams: @<<SLOT PatternDiagrams:Descriptor>>;
                    nextX,nextY: @integer;
                    currentFocus:
                      ^PatternDiagramNode;
                    oldFocus: ^PatternDiagramNode;
                    theTextBefore,parseableText: @text;
                    onGoingTextediting: @boolean;
                    onGoingTitleEditing: @Boolean;
                    parseErrorOccurred: @Boolean;
                    UserDataNode: Node
                      (#
                         initialisingSaved: @Boolean
                         (*toby 7-11-94:
                          If initialisingSaved=true then we are reestablishing
                          saved diagram. onInit does not have to do all
                          the usual work!*) ;
                         ASTReferenceUserData: ReferenceUserData
                           (#
                              WriteUserData::< 
                                (# theAST: ^MPS.AST
                                do
                                   <<SLOT WriteASTReferenceUserData:Descriptor>>;
                                   
                                #);
                              ReadUserData::< 
                                (#
                                   ASTIndex: @integer;
                                   theFragmentForm: ^mps.fragmentform
                                do
                                   <<SLOT ReadASTReferenceUserData:Descriptor>>;
                                   
                                #);
                              Init::< 
                                (# 
                                do
                                   <<SLOT InitASTReferenceUserData:Descriptor>>;
                                   
                                #)
                           #);
                         PointUserData: UserData
                           (#
                              thePoint: @Point;
                              x,y: @IntegerUserData;
                              WriteUserData::< 
                                (# ok: @Boolean
                                enter thePoint
                                do <<SLOT WritePointUserData:Descriptor>>; 
                                #);
                              ReadUserData::< 
                                (# ok: @Boolean
                                do <<SLOT ReadPointUserData:Descriptor>>; 
                                exit
                                thePoint
                                #);
                              Init::< 
                                (# 
                                do <<SLOT InitPointUserData:Descriptor>>; 
                                #)
                           #);
                         DiagramReferenceUserData: ReferenceUserData
                           (#
                              WriteUserData::< 
                                (# theDiagram: ^Diagram; IDData: @integer
                                do
                                   <<SLOT WriteDiagramReferenceUserData:Descriptor>>;
                                   
                                #);
                              ReadUserData::< 
                                (#
                                   IDData: @Integer;
                                   theNode: ^PatternDiagramNode
                                do
                                   <<SLOT ReadDiagramReferenceUserData:Descriptor>>;
                                   
                                #);
                              Init::< 
                                (# 
                                do
                                   <<SLOT InitDiagramReferenceUserData:Descriptor>>;
                                   
                                #)
                           #);
                         FragReferenceUserData: ReferenceUserData
                           (#
                              theFragName: @ReferenceUserData
                                (# Type::< Text #);
                              theGroupName: @ReferenceUserData
                                (# Type::< Text #);
                              WriteUserData::< 
                                (# 
                                do
                                   <<SLOT WriteFragReferenceUserData:Descriptor>>;
                                   
                                #);
                              ReadUserData::< 
                                (# 
                                do
                                   <<SLOT ReadFragReferenceUserData:Descriptor>>;
                                   
                                #);
                              Init::< 
                                (# 
                                do
                                   <<SLOT InitFragReferenceUserData:Descriptor>>;
                                   
                                #)
                           #);
                         LocalNodesUDAttributes: @integerUserData
                           (#
                              init::< 
                                (# 
                                do
                                   LocalNodesUserDataEnd->attributeID;
                                   true->specialData
                                #)
                           #);
                         oldLocalNodesUDAttributes: @integerUserData
                           (#
                              init::< 
                                (# 
                                do
                                   LocalNodesUserDataEnd-1->attributeID;
                                   true->specialData
                                #)
                           #);
                         LocalNodesReferenceUserData: ReferenceUserData
                           (#
                              InitLocalNode:<
                                (#  do <<SLOT InitLocalNode:Descriptor>> #)
                           #);
                         decomposDiagramsUDAttributes: @integerUserData
                           (#
                              init::< 
                                (# 
                                do
                                   decomposDiagramsUserDataEnd->attributeID;
                                   true->specialData
                                #)
                           #);
                         oldDecomposDiagramsUDAttributes: @integerUserData
                           (#
                              init::< 
                                (# 
                                do
                                   decomposDiagramsUserDataEnd-1->attributeID;
                                   true->specialData
                                #)
                           #);
                         decomposDiagramsReferenceUserData: ReferenceUserData
                           (#
                              InitDecomposDiagram:<
                                (# 
                                do <<SLOT InitDecomposDiagram:Descriptor>>
                                #)
                           #);
                         onInit::< 
                           (# 
                           do
                              <<SLOT UserDataNodeOnInit:Descriptor>>;
                              
                           #)
                      #);
                    UserDataGenericNode: UserDataNode
                      (#
                         New::<  (#  enter shape do INNER #);
                         InteractiveNew::<  (#  enter shape do INNER #)
                      #);
                    UserDataRectNode: UserDataNode
                      (#
                         New::< 
                           (# 
                           do THIS(OADDocument).shape.Rectangle->shape; INNER
                           #)
                      #);
                    UserDataEllipseNode: UserDataNode
                      (#
                         New::< 
                           (# 
                           do THIS(OADDocument).shape.Ellipse->shape; INNER
                           #)
                      #);
                    UserDataLabelNode: LabelNode
                      (#
                         initialisingSaved: @Boolean
                         (*toby 7-11-94:
                          If initialisingSaved=true then we are reestablishing
                          saved diagram. onInit does not have to do all
                          the usual work!*) ;
                         invisibleText: @ReferenceUserData
                           (# Type:: Text #);
                         visible:
                           (#
                              set:
                                (# v: @boolean; help: ^text; t: @text
                                enter v
                                <<SLOT UserdataLabelNodeVisibleSet:DoPart>>
                                #);
                              get:
                                (# v: @boolean
                                <<SLOT UserDataLabelNodeVisibleGet:DoPart>>
                                exit
                                v
                                #)
                           enter set
                           exit get
                           #);
                         onInit::< 
                           (#  <<SLOT UserDataLabelNodeOnInit:DoPart>> #)
                      #);
                    PatternDiagramNode:
                     UserDataGenericNode
                      (#
                         defaultShape: @IntegerUserData;
                         theMarkNode: @ReferenceUserData
                           (# Type::< MarkNode #);
                         theDiagram: @DiagramReferenceUserData
                           (# Type::< Diagram #);
                         invisibleText: @ReferenceUserData
                           (# type::< text #);
                         onSelect::< 
                           (#  <<SLOT PatternDiagramNodeOnSelect:DoPart>> #);
                         abstract:< Object;
                         abstractRecursively:< Object;
                         detail:< Object;
                         detailRecursively:< Object;
                         overview:< Object;
                         abstractedFromDiagramBelow:< Object;
                         astIndex: @IntegerUserData;
                         getAstNode:<
                           (# anAST: ^MPS.AST; 
                           do INNER ; 
                           exit anAST[]
                           #);
                         Display:<
                           (# 
                           do
                              THIS(OADDocument).shape.Rectangle->defaultShape;
                              INNER ;
                              (if astIndex <> 0
                               // true then
                                  (astIndex,ID)->IndexIDList.insert; 
                               else
                                  'PatternDiagramNode: ASTINDEX is 0'->putline; 
                              if);
                              
                           #);
                         Redisplay:< (#  do INNER ;  #);
                         ConcludeDisplay:<
                           (#
                              dist: @Point; (* distance to adjust the node *) 
                           enter dist
                           do INNER
                           #);
                         GetGroup:<
                         (* return the FragmentGroup this node belongs to *)
                           (# fg: ^mps.fragmentgroup; 
                           do INNER
                           exit fg[]
                           #);
                         GetFragment:<
                         (* return the Fragment this node belongs to *)
                           (# f: ^mps.fragment;  do INNER exit f[] #);
                         theSifEditor:<
                         (* In case SIF is open: sets or returns the fragment editor
                          * the AST of this node is displayed on in SIF
                          *)
                           (# se: ^SifEditor; 
                           enter se[]
                           do INNER
                           exit se[]
                           #);
                         SifEditorInstance:<
                         (* In case SIF is open: sets or returns the fragment editor no
                          * the AST of this node is displayed on in SIF
                          *)
                           (# no: @Integer; 
                           enter no
                           do INNER
                           exit no
                           #);
                         thisDiagram:<
                           (# theDiagram: ^Diagram
                           do INNER
                           exit theDiagram[]
                           #);
                         dump:<
                           (# 
                           do
                              <<SLOT PatternDiagramNodeDump:Descriptor>>;
                              INNER
                           #);
                         DesignText::<
                           (# oldX,oldY,oldWidth,oldHeight: @integer #);
                         onInit::< 
                           (# 
                           do
                              <<SLOT PatternDiagramNodeOnInit:Descriptor>>;
                              INNER
                           #)
                      #);
                    Diagram:
                    (* superclass for all diagrams used by the prettyprinter *)
                      (#
                         theParentNode:
                           (# 
                           enter titleNode.UDtheParentNode
                           exit titleNode.UDtheParentNode
                           #);
                         theFragmentNode:
                           (# 
                           enter titleNode.UDtheFragmentNode
                           exit titleNode.UDtheFragmentNode
                           #);
                         titleText: @Text;
                         title:< PatternDiagramNode
                           (#
                              UDtheParentNode: @ReferenceUserData
                                (# Type::< PatternDiagramNode #);
                              UDtheFragmentNode: @ReferenceUserData
                                (# Type::< PatternDiagramNode #);
                              thePrefixConn: @ReferenceUserData
                                (# Type::< Connector #);
                              interactiveNew::< 
                                (#
                                   w,h: @Integer;
                                   cursorFormat::< 
                                     (#  do Cursor.box->curs #);
                                   
                                enter (w,h)
                                do
                                   <<SLOT TitleInteractiveNew:Descriptor>>;
                                   INNER
                                #);
                              onInit::< 
                                (# 
                                do
                                   <<SLOT TitleOnInit:Descriptor>>
                                #);
                              onSelect::< 
                                (#  do <<SLOT TitleOnSelect:Descriptor>> #);
                              thisDiagram::< 
                                (#  do THIS(Diagram)[]->theDiagram[] #);
                              DesignText::< 
                                (#
                                   changed: @boolean;
                                   theRegionList: ^ObjectList;
                                   ModeOn::< 
                                     (# 
                                     do <<SLOT TitleTextModeOn:Descriptor>>
                                     #);
                                   ModeOff::<
                                    
                                     (# 
                                     do <<SLOT TitleTextModeOff:Descriptor>>
                                     #);
                                   onTextModeOff::< 
                                     (# 
                                     <<SLOT TitleTextOnTextModeOff:DoPart>>
                                     #);
                                   onTextModeOn::< 
                                     (# length: @integer
                                     <<SLOT TitleTextOnTextModeOn:DoPart>>
                                     #);
                                   
                                #);
                              theSifEditor::< 
                                (# fn: ^PatternDiagramNode
                                <<SLOT TitleTheSifEditor:DoPart>>
                                #);
                              dump::< 
                                (# 
                                <<SLOT diagramTitleDump:DoPart>>
                                #);
                              
                           #);
                         titleNode: @Title;
                         InsertDiagramNode:<
                         (* insert a new node into a diagram.
                          * used when inserting new list elements
                          *)
                           (#
                              pos: @Integer;
                              anAST: ^mps.ast;
                              theNode: ^PatternDiagramNode;
                              
                           enter (pos,anAST[])
                           do INNER ; 
                           exit theNode[]
                           #);
                         UpdateDiagramNode:< (* update existing node *)
                           (# oldAST,newAST: ^mps.ast; 
                           enter (oldAST[],newAST[])
                           do INNER ; 
                           #);
                         DeleteDiagramNode:<
                         (* delete the node and update the list *)
                           (# d: ^PatternDiagramNode; deleteNode: @Boolean; 
                           enter (d[],deleteNode)
                           do INNER
                           #);
                         ReplaceDiagramNode:<
                         (* remove old and insert new at same pos *)
                           (#
                              d: ^PatternDiagramNode;
                              newAST: ^mps.ast;
                              newNode: ^PatternDiagramNode;
                              
                           enter (d[],newAST[])
                           do INNER
                           exit newNode[]
                           #);
                         new:< Object;
                         
                      #);
                    SurroundBox: GenericNode
                      (#
                         onInit::<  (#  <<SLOT SurroundBoxOnInit:DoPart>> #)
                      #);
                    ListDiagram: Diagram
                    (* to display OADDiagrams i.e. 
                     * Pattern, Fragment, and Object diagrams *)
                      (#
                         <<SLOT DiagramLib:Attributes>>;
                         theSurroundBox:
                           (# 
                           enter
                           titleNode.
                             UDtheSurroundBox
                           exit titleNode.UDtheSurroundBox
                           #);
                         detailPage:
                           (# 
                           enter titleNode.UDdetailPage
                           exit titleNode.UDdetailPage
                           #);
                         NoOfRefConnectors:
                           (# 
                           enter TitleNode.UDNoOfRefConnectors
                           exit TitleNode.UDNoOfRefConnectors
                           #);
                         MaxHeight:
                           (# 
                           enter TitleNode.UDMaxHeight
                           exit TitleNode.UDMaxHeight
                           #);
                         MaxWidth:
                           (# 
                           enter TitleNode.UDMaxWidth
                           exit TitleNode.UDMaxWidth
                           #);
                         updateMaxWH:
                           (# thePatternDiagramNode: ^PatternDiagramNode
                           enter thePatternDiagramNode[]
                           do <<SLOT updateMaxWH:Descriptor>>; 
                           #);
                         LocalNodesDesc:
                          containerlist
                           (#
                              element::< PatternDiagramNode;
                              emptyContainerError::< 
                                (#  do true->continue #);
                              abstractAll: scan
                              (* abstracts detailed attributes on other pages *)
                                (# 
                                do <<SLOT LocalNodesAbstractAll:Descriptor>>
                                #);
                              adjustSizes:
                                (# 
                                do <<SLOT LocalNodesAdjustSizes:Descriptor>>; 
                                #);
                              dump: (#  <<SLOT localNodesDump:DoPart>> #);
                              
                           #);
                         localNodes:
                           ^LocalNodesDesc;
                         new::< 
                           (# 
                           do &LocalNodesDesc[]->localNodes[]; INNER
                           #);
                         InsertDiagramNode::< 
                           (#  do <<SLOT InsertDiagramNode:Descriptor>> #);
                         DeleteDiagramNode::< 
                           (#  do <<SLOT DeleteDiagramNode:Descriptor>> #);
                         ReplaceDiagramNode::< 
                           (#  do <<SLOT ReplaceDiagramNode:Descriptor>> #);
                         UpdateDiagramNode::< 
                           (# 
                           do <<SLOT UpdateDiagramNode:Descriptor>>; 
                           #);
                         title::<
                         (* this is the parent of all local nodes *) 
                           (#
                              UDtheSurroundBox: @ReferenceUserdata
                                (# Type:: SurroundBox #);
                              UDdetailPage: @ReferenceUserData
                                (#
                                   Type::< Page
                                   (*Qualification should be OADPage, but not
                                    possible since OADPage is virtual itself.*)
                                #);
                              UDNoOfRefConnectors: @IntegerUserData;
                              UDMaxHeight: @IntegerUserData;
                              UDMaxWidth: @IntegerUserData;
                              PatternDiagNodeReference:
                               LocalNodesReferenceUserData
                                (# Type::< PatternDiagramNode #);
                              resetLocalNodesUD:
                                (# 
                                do <<SLOT resetLocalNodesUD:Descriptor>>; 
                                #);
                              onInit::< 
                                (#
                                   x,y,h,w:
                                     @Integer;
                                   (* the geometry of THIS(Title) *)
                                   
                                do
                                   <<SLOT ListDiagramOnInit:Descriptor>>;
                                   INNER ;
                                   (* make the containing patterns *)
                                   
                                #);
                              onRemove::< 
                                (# 
                                do
                                   <<SLOT ListDiagramOnRemove:Descriptor>>;
                                   INNER
                                #);
                              onDoubleClick::<
                              (* abstract detailed attributes on other pages *)
                               
                                (# 
                                do
                                   <<SLOT ListDiagramOnDoubleClick:Descriptor>>;
                                   INNER
                                #);
                              abstract::<
                              (* abstract the title => abstract all attributes *)
                              
                                (# 
                                do
                                   <<SLOT ListDiagramAbstract:Descriptor>>;
                                   INNER
                                #);
                              abstractRecursively::< 
                                (# 
                                <<SLOT ListDiagramAbstractRecursively:DoPart>>
                                #);
                              detail::<
                              (* detail the title => detail all attributes *) 
                                (# 
                                do
                                   <<SLOT ListDiagramDetail:Descriptor>>;
                                   INNER
                                #);
                              detailRecursively::< 
                                (# 
                                <<SLOT ListDiagramDetailRecursively:DoPart>>
                                #);
                              overview::< 
                                (#  <<SLOT ListDiagramOverview:DoPart>> #);
                              GetFragment::<
                               
                                (# 
                                do <<SLOT titleGetFragment:Descriptor>>; 
                                #);
                              dump::< 
                                (#  <<SLOT ListDiagramTitleDump:DoPart>> #);
                              
                           #);
                         remakingDiagram:
                           @Boolean;
                         
                      #);
                    OADDiagram: ListDiagram
                      (#
                         theDescriptor:
                           (# 
                           enter titleNode.UDtheDescriptor
                           exit titleNode.UDtheDescriptor
                           #);
                         New::< 
                           (# 
                           do INNER ; <<SLOT OADDiagramNew:Descriptor>>
                           #);
                         DisplayDeclarations:<
                           (#
                              startPos: @Point;
                              theAttributes: ^betaGram.attributes;
                              
                           enter startPos
                           do
                              INNER ;
                              (* setup theAttributes *)
                              <<SLOT OADDisplayDeclarations:Descriptor>>;
                              
                           #);
                         Display:<
                           (# theCenter: @Point; titleshape: @Integer; 
                           enter titleshape
                           do <<SLOT OADDisplay:Descriptor>>; 
                           #);
                         title::< 
                           (#
                              UDtheDescriptor: @ASTReferenceUserData
                                (# Type::< betaGram.ObjectDescriptor #);
                              onRemove::< (* callback from delete *) 
                                (# 
                                do
                                   <<SLOT OADDiagramOnRemove:Descriptor>>;
                                   INNER
                                     ;
                                   
                                #);
                              onInit::< 
                                (# 
                                do
                                   <<SLOT OADDiagramOnInit:Descriptor>>;
                                   INNER
                                #);
                              dump::< 
                                (# 
                                do <<SLOT OADDiagramDump:Descriptor>>; INNER
                                #);
                              
                           #);
                         
                      #);
                    FragmentDiagram: ListDiagram
                    (* Display all fragments of the Group *)
                      (#
                         fullname:
                           (# 
                           enter TitleNode.UDfullname
                           exit TitleNode.UDfullname
                           #);
                         theGroup:
                           (# 
                           enter TitleNode.UDtheGroup
                           exit TitleNode.UDtheGroup
                           #);
                         New::< 
                           (# x,y: @Integer; 
                           enter theGroup
                           do <<SLOT FragmentDiagramNew:Descriptor>>; 
                           #);
                         InsertFragmentNode:
                           (# pos: @integer; ff: ^mps.fragmentForm
                           enter (pos,ff[])
                           <<SLOT InsertFragmentNode:DoPart>>
                           #);
                         deleteFragmentNode:
                           (#
                              d:
                                ^PatternDiagramNode
                           enter d[]
                           <<SLOT deleteFragmentNode:DoPart>>
                           #);
                         title::< 
                           (#
                              UDfullname:
                                @ReferenceUserData (# Type::< Text #);
                              (*toby 28-11-94: persistent version of theGroup*)
                              UDtheGroup: @ReferenceUserData
                                (#
                                   Type::< mps.FragmentGroup;
                                   ReadUserData::< 
                                     (# 
                                     do
                                        <<SLOT ReadFragGroupReferenceUserData:Descriptor>>;
                                        
                                     #)
                                #);
                              onInit::< 
                                (# 
                                do
                                   <<SLOT FragmentDiagramTitleInit:Descriptor>>;
                                   
                                #)
                           #);
                         
                      #);
                    PatternDiagram: OADDiagram
                      (#
                         DisplayDeclarations::<
                         (* called from Display to actually display *) 
                           (#  do INNER #);
                         Display::< (* call to display THIS(PatternDiagram) *) 
                           (#  do INNER #);
                         title::< 
                           (#
                              concludeDisplay::<
                                (# 
                                <<SLOT PatternDiagramConcludeDisplay:DoPart>>
                                #);
                              onInit::< 
                                (# 
                                do
                                   <<SLOT PatternDiagramOnInit:Descriptor>>;
                                   INNER
                                     ;
                                   
                                #);
                              onRemove::< 
                                (# 
                                do
                                (* <<SLOT PatternDiagramOnRemove: descriptor>>; *)
                                INNER ; 
                                #);
                              getASTNode::<
                              (* return the ASTnode THIS(title) is generated from *)
                              
                                (# 
                                do theDescriptor->anAST[]; INNER getASTNode
                                #);
                              
                           #);
                         new::< (* call to create THIS(PatternDiagram) *) 
                           (# anAST: ^MPS.AST; titleshape: @Integer; 
                           enter (anAST[],titletext,titleshape)
                           do INNER ; 
                           #);
                         
                      #);
                    PatternAttDiagram: PatternDiagram
                      (#
                         theAST:
                           (# 
                           enter titleNode.UDtheAST
                           exit titleNode.UDtheAST
                           #);
                         DisplayDeclarations::< 
                           (# 
                           do
                              <<SLOT PatternAttDiagramDisplayDeclarations:Descriptor>>;
                              
                           #);
                         Display::< 
                           (# 
                           do <<SLOT PatternAttDiagramDisplay:Descriptor>>; 
                           #);
                         New::< 
                           (# 
                           do
                              <<SLOT PatternAttDiagramNew:Descriptor>>;
                              
                           #);
                         title::< 
                           (#
                              UDtheAST: @ASTReferenceUserData
                                (# Type::< mps.AST #);
                              onInit::< 
                                (# 
                                do <<SLOT PatternAttDiagramOnInit:Descriptor>>
                                #);
                              getASTNode::< 
                                (# 
                                do theAST->anAST[]; INNER getASTNode
                                #);
                              dump::< 
                                (# 
                                do
                                   <<SLOT PatternAttDiagramDump:Descriptor>>;
                                   INNER
                                #)
                           #);
                         
                      #);
                    PatternDeclDiagram: PatternDiagram
                      (#
                         thePrefix:
                           (# 
                           enter titleNode.UDthePrefix
                           exit titleNode.UDthePrefix
                           #);
                         DisplayDeclarations::< 
                           (# 
                           do
                              <<SLOT PatternDeclDiagramDisplayDeclarations:Descriptor>>
                           #);
                         Display::< 
                           (# 
                           do
                              <<SLOT PatternDeclDiagramDisplay:Descriptor>>;
                              INNER
                                ;
                              
                           #);
                         DisplayPrefix:
                           (# 
                           do <<SLOT PatternDiagramDisplayPrefix:Descriptor>>
                           #);
                         DisplayInheritance:
                           (# 
                           do
                              <<SLOT PatternDeclDiagramDisplayInheritance:Descriptor>>;
                              
                           #);
                         title::< 
                           (#
                              UDthePrefix: @ASTReferenceUserData
                                (# Type::< betaGram.ObjectDescriptor #);
                              ConcludeDisplay::< 
                                (# 
                                <<SLOT PatternDeclDiagramConcludeDisplay:DoPart>>
                                #);
                              onInit::< 
                                (# 
                                do <<SLOT PatternDeclDiagramOnInit:Descriptor>>
                                #);
                              dump::< 
                                (# 
                                do
                                   <<SLOT PatternDeclDiagramDump:Descriptor>>;
                                   INNER
                                #);
                              
                           #);
                         New::< 
                           (# 
                           do <<SLOT PatternDeclDiagramNew:Descriptor>>
                           #);
                         
                      #);
                    PatternClassificationDiagram: PatternDeclDiagram
                      (#
                         Display::< 
                           (# 
                           do
                              <<SLOT PatternClassificationDiagramDisplay:Descriptor>>;
                              
                           #);
                         title::< 
                           (#
                              onInit::< 
                                (# 
                                do
                                   <<SLOT PatternClassificationDiagramOnInit:Descriptor>>
                                #)
                           #);
                         
                      #);
                    PatternNonTerminalDiagram: PatternDiagram
                      (#
                         theDesc:
                           (# 
                           enter titleNode.UDtheDesc
                           exit titleNode.UdtheDesc
                           #);
                         DisplayDeclarations::< 
                           (# 
                           do
                              <<SLOT PatternNonTerminalDisplayDeclarations:Descriptor>>
                           #);
                         New::< 
                           (# 
                           do <<SLOT PatternNonTerminalDiagramNew:Descriptor>>
                           #);
                         title::< 
                           (#
                              UDtheDesc: @ASTReferenceUserData
                                (# Type::< mps.AST #);
                              onInit::< 
                                (# 
                                do
                                   <<SLOT PatternNonTerminalDiagramOnInit:Descriptor>>;
                                   
                                #)
                           #);
                         
                      #);
                    MarkNode: UserDataEllipseNode
                      (#
                         thePatternDiagramNode: @ReferenceUserData
                           (# Type::< PatternDiagramNode #);
                         theNode: ^PatternDiagramNode;
                         display:<
                           (# pos: @Point
                           enter theNode[]
                           do
                              INNER ;
                              (* calculate position *)
                              <<SLOT MarkNodeDisplay:Descriptor>>;
                              
                           #);
                         activate:< Object;
                         deactivate:< Object;
                         initialisingSaved: @Boolean;
                         onInit::< 
                           (# 
                           do <<SLOT MarkNodeOnInit:Descriptor>>; INNER ; 
                           #);
                         onDoubleClick::< 
                           (# 
                           do INNER
                           #);
                         
                      #);
                    CommentNode:
                     UserDataRectNode (* to display the comment *)
                      (#
                         initialisingSaved: @Boolean;
                         onInit::< 
                           (# 
                           do <<SLOT CommentNodeOnInit:Descriptor>>; INNER
                           #);
                         onRemove::< 
                           (# 
                           do INNER
                           #);
                         deactivate:<
                           (# 
                           do INNER
                           #);
                         
                      #);
                    DeletableConnector:
                     Connector
                      (#
                         initialisingSaved: @Boolean;
                         invisibleText: @ReferenceUserData
                           (# type::< Text #);
                         onInit::< 
                           (#  do invisibleText.init; INNER onInit #);
                         onDelete:< (#  do INNER #);
                         getOtherEnd:
                           (# Start,OtherEnd: ^IDObject
                           enter Start[]
                           do
                              <<SLOT DeletableConnectorGetOtherEnd:Descriptor>>;
                              
                           exit OtherEnd[]
                           #);
                         dump:< (#  do INNER dump #)
                      #);
                    PrefixConnector: DeletableConnector
                      (#
                         onInit::< 
                           (#  <<SLOT PrefixConnectorOnInit:DoPart>> #);
                         onDelete::< 
                           (# t: ^text
                           do
                              <<SLOT PrefixConnectorOnDelete:Descriptor>>;
                              INNER
                           #);
                         onReattach::< 
                           (# 
                           do <<SLOT PrefixConnectorOnReattach:Descriptor>>; 
                           #);
                         
                      #);
                    GeneralRelationshipConnector: DeletableConnector
                      (#
                         onInit::< 
                           (#  <<SLOT GeneralRelationshipOnInit:DoPart>> #)
                      #);
                    AssociationConnector: DeletableConnector
                      (#
                         name: @ReferenceUserData
                           (# Type:: UserDataLabelNode #);
                         associationNode: @ReferenceUserData
                           (# Type:: PatternDiagramNode #);
                         leftRole,rightRole: @ReferenceUserData
                           (# Type:: Role #);
                         Role:< UserDataNode
                           (#
                              name,multiplicity: @ReferenceUserData
                                (# Type:: UserDataLabelNode #);
                              thePatternDiagramNode: @ReferenceUserData
                                (# Type:: PatternDiagramNode #);
                              display:<
                                (#
                                   theName: ^text;
                                   multiplicityFrom,multiplicityTo: @integer;
                                   theNode: ^PatternDiagramNode;
                                   l: ^UserDataLabelNode;
                                   x,y,w,h,lx,ly,lw,lh: @integer;
                                   mul: ^text
                                enter
                                (theName[],multiplicityFrom,multiplicityTo,
                                 theNode[])
                                <<SLOT RoleDisplay:DoPart>>
                                #);
                              redisplay:<
                                (#
                                   theName: ^text;
                                   multiplicityFrom,
                                     multiplicityTo: @integer;
                                   l: ^UserDataLabelNode;
                                   x,y,w,h,lx,ly,lw,lh: @integer;
                                   mul: ^text
                                enter
                                (theName[],multiplicityFrom,multiplicityTo)
                                <<SLOT RoleRedisplay:DoPart>>
                                #);
                              onInit::<  (#  <<SLOT RoleOnInit:DoPart>> #);
                              dump:<
                                (# t: @text
                                <<SLOT RoleDump:DoPart>>
                                #)
                           #);
                         generateCode:<
                           (#
                              aPatternDiagramNode,anotherPatternDiagramNode:
                                ^PatternDiagramNode;
                              theName,leftRoleName,rightRoleName: ^Text;
                              implementation,leftMulFrom,leftMulTo,rightMulFrom,
                                rightMulTo: @integer;
                              ok,doneInInner: @boolean;
                              left,right: ^PatternDiagramNode
                           enter
                           (aPatternDiagramNode[],anotherPatternDiagramNode[],
                            theName[],implementation,leftRoleName[],
                            rightRoleName[],leftMulFrom,leftMulTo,rightMulFrom,
                            rightMulTo)
                           <<SLOT AssociationConnectorGenerateCode:DoPart>>
                           exit (ok,left[],right[])
                           #);
                         getValuesFromCode:<
                           (#
                              theName: ^text;
                              implementation: @integer;
                              doneInInner: @boolean
                           <<SLOT AssociationConnectorGetValuesFromCode:DoPart>>
                           exit (theName[],implementation)
                           #);
                         interactiveNew::< 
                           (#
                              name,description,leftRoleName,RightRoleName:
                                ^Text;
                              implementation,leftMulFrom,leftMulTo,rightMulFrom,
                                rightMulTo: @integer
                           enter
                           (name[],implementation,leftRoleName[],
                            rightRoleName[],leftMulFrom,leftMulTo,rightMulFrom,
                            rightMulTo,description[])
                           <<SLOT AssociationConnectorInteractiveNew:DoPart>>
                           #);
                         redisplay:<
                           (#
                              name,description,leftRoleName,RightRoleName:
                                ^Text;
                              implementation,leftMulFrom,leftMulTo,rightMulFrom,
                                rightMulTo: @integer;
                              doneInInner: @boolean
                           enter
                           (name[],implementation,leftRoleName[],
                            rightRoleName[],leftMulFrom,leftMulTo,rightMulFrom,
                            rightMulTo,description[])
                           <<SLOT AssociationConnectorRedisplay:DoPart>>
                           #);
                         onDelete::< 
                           (# 
                           <<SLOT AssociationConnectorOnDelete:DoPart>>
                           #);
                         onReattach::< 
                           (# 
                           <<SLOT AssociationConnectorOnReattach:DoPart>>
                           #);
                         onDoubleClick::< 
                           (# 
                           <<SLOT AssociationConnectorOnDoubleClick:DoPart>>
                           #);
                         onInit::< 
                           (#
                              doneInInner: @boolean;
                              left,right: ^PatternDiagramNode
                           <<SLOT AssociationConnectorOnInit:DoPart>>
                           #);
                         dump::< 
                           (#
                              t:
                                @text
                           <<SLOT AssocConnectorDump:DoPart>>
                           #);
                         private:
                           @<<SLOT AssociationConnectorPrivate:Descriptor>>
                      #);
                    AggregationConnector: AssociationConnector
                      (#
                         Role::< 
                           (#
                              display::< 
                                (# 
                                <<SLOT AggregationRoleDisplay:DoPart>>
                                #);
                              redisplay::<
                               
                                (# 
                                <<SLOT AggregationRoleRedisplay:DoPart>>
                                #);
                              new::< 
                                (#
                                   p:
                                     [8] @integer
                                <<SLOT AggregationRoleNew:DoPart>>
                                #);
                              onInit::< 
                                (# 
                                <<SLOT AggregationRoleOnInit:DoPart>>
                                #)
                           #);
                         generateCode::< 
                           (# kind: @integer
                           enter kind
                           <<SLOT AggregationConnectorGenerateCode:DoPart>>
                           #);
                         getValuesFromCode::< 
                           (# kind: @integer
                           <<SLOT AggregationConnectorGetValuesFromCode:DoPart>>
                           exit kind
                           #);
                         redisplay::< 
                           (# kind: @integer
                           enter kind
                           <<SLOT AggregationConnectorRedisplay:DoPart>>
                           #);
                         interactiveNew::< 
                           (# kind: @integer
                           enter kind
                           <<SLOT AggregationConnectorInterativeNew:DoPart>>
                           #);
                         onDelete::< 
                           (# anAST: ^mps.ast
                           <<SLOT AggregationConnectorOnDelete:DoPart>>
                           #);
                         onReattach::< 
                           (# 
                           <<SLOT AggregationConnectorOnReattach:DoPart>>
                           #);
                         onDoubleClick::< 
                           (# 
                           <<SLOT AggregationConnectorOnDoubleClick:DoPart>>
                           #);
                         onInit::< 
                           (#  <<SLOT AggregationConnectorOnInit:DoPart>> #);
                         dump::< 
                           (#  <<SLOT AggregationConnectorDump:DoPart>> #);
                         private:
                           @<<SLOT AggregationConnectorPrivate:Descriptor>>
                      #);
                    BoxToNode: (* if node is a SurroundBox, return title *)
                      (# theNode: ^node
                      enter theNode[]
                      <<SLOT BoxToNode:DoPart>>
                      exit theNode[]
                      #);
                    ASTtoNode:
                      (#
                         anAST: ^mps.ast;
                         theNode: ^PatternDiagramNode
                      enter anAST[]
                      do
                         <<SLOT ASTToNode:Descriptor>>;
                         
                      exit theNode[]
                      #);
                    ASTtoNodeListUpdate:
                      (#
                         oldAST,newAST: ^mps.ast; theNode: ^PatternDiagramNode
                      enter (oldAST[],newAST[])
                      do <<SLOT ASTToNodeListUpdate:Descriptor>>; 
                      exit theNode[]
                      #);
                    RemoveListElement:
                      (#
                         anAST: ^MPS.AST
                      enter anAST[]
                      do
                         <<SLOT RemoveListElement:Descriptor>>;
                         
                      #);
                    getQualificationWithPath:
                      (# qual: ^mps.Expanded; ref: ^MPS.AST; t: ^Text
                      enter (ref[],qual[])
                      do <<SLOT getQualificationWithPath:Descriptor>>; 
                      exit t[]
                      #);
                    CalculateNextCenter: (* for the next diagram on this page *)
                      (# theCenter: @Point; 
                      do <<SLOT CalculateNextCenter:Descriptor>>; 
                      exit theCenter
                      #);
                    UpdateNextFree:
                      (#
                         theCenter:
                           @Point;
                         x,y: @Integer;
                         
                      enter (theCenter,(x,y))
                      do <<SLOT UpdateNextFree:Descriptor>>; 
                      #);
                    prettyprintSubPatterns:
                      (#
                         thePatternDeclDiagram: ^PatternDeclDiagram
                      enter thePatternDeclDiagram[]
                      <<SLOT prettyprintSubPatterns:DoPart>>
                      #);
                    edgeSpecializations:
                      (# thePatternDeclDiagram: ^PatternDeclDiagram
                      enter thePatternDeclDiagram[]
                      <<SLOT edgeSpecializations:DoPart>>
                      #);
                    open:< Object;
                    save:< Object;
                    changedFocus:<
                      (#
                         oldObject,newObject: ^PatternDiagramNode;
                         OKtoChange: @boolean
                      enter (oldObject[],newObject[])
                      do <<SLOT gppChangedFocus:Descriptor>>; 
                      #);
                    declarationTextChanged:<
                      (#
                         theObject: ^PatternDiagramNode;
                         node: ^mps.ast;
                         theParseText: ^text;
                         
                      enter (theObject[],node[],theParseText[])
                      do INNER ; 
                      #);
                    openFormInSif:<
                      (# ff: ^mps.fragmentform; fn: ^PatternDiagramNode
                      enter (ff[],fn[])
                      do INNER
                      #);
                    lexemExpand:<
                      (#
                         theObject: ^PatternDiagramNode;
                         lexemIndex: @Integer;
                         theName: ^Text;
                         
                      enter (theObject[],lexemIndex,theName[])
                      do INNER
                      #);
                    undo:< Object;
                    cut:<
                      (# theObject: ^PatternDiagramNode; 
                      enter theObject[]
                      do INNER
                      #);
                    copy:<
                      (# theObject: ^PatternDiagramNode; 
                      enter theObject[]
                      do INNER
                      #);
                    paste:<
                      (# theObject: ^PatternDiagramNode; 
                      enter theObject[]
                      do INNER
                      #);
                    insertBefore:< Object;
                    insertAfter:< Object;
                    ASTtoNearestNode:
                      (# anAST: ^mps.ast; node: ^PatternDiagramNode
                      enter anAST[]
                      <<SLOT ASTtoNearestNode:DoPart>>
                      exit node[]
                      #);
                    newFragment:<
                      (#
                         ff: ^mps.fragmentform;
                         status: @Boolean;
                         
                      enter ff[]
                      <<SLOT sifNotificationNewFragment:DoPart>>
                      exit status
                      #);
                    propertiesChanged:
                      (# fg: ^mps.fragmentGroup
                      enter fg[]
                      <<SLOT propertiesChanged:DoPart>>
                      #);
                    fragmentChanged:
                      (#
                         ff: ^mps.fragmentForm
                      enter ff[]
                      <<SLOT fragmentChanged:DoPart>>
                      #);
                    fragmentInserted:
                      (# ff: ^mps.fragmentForm
                      enter ff[]
                      <<SLOT fragmentInserted:DoPart>>
                      #);
                    fragmentDeleted:
                      (# ff: ^mps.fragmentForm
                      enter ff[]
                      <<SLOT fragmentDeleted:DoPart>>
                      #);
                    astReplaced:
                      (# oldAst,newAst: ^mps.ast
                      enter (oldAst[],newAst[])
                      <<SLOT astReplaced:DoPart>>
                      #);
                    listElementInserted:<
                      (#
                         father: ^mps.expanded;
                         position: @Integer;
                         
                      enter (father[],position)
                      do
                         INNER ;
                         <<SLOT listElementInserted:Descriptor>>;
                         
                      #);
                    listElementsDeleted:<
                      (#
                         father: ^mps.ast;
                         position,length: @integer;
                         oldElements: [1] ^mps.ast
                      enter (father[],position,length,oldElements)
                      do INNER ; <<SLOT listElementsDeleted:Descriptor>>; 
                      #);
                    listElementsReplaced:<
                      (#
                         father: ^mps.expanded;
                         position,length,newLength: @integer;
                         oldElements: [1] ^mps.ast;
                         
                      enter (father[],position,length,oldElements,newLength)
                      do INNER ; <<SLOT listElementsReplaced:Descriptor>>; 
                      #);
                    ScanDiagrams:
                    (* scan diagrams on this page with at least type theDiagramType *)
                      (# theDiagramType: ##Diagram; current: ^Diagram; 
                      enter theDiagramType##
                      do <<SLOT ScanDiagrams:Descriptor>>
                      #);
                    doScrollIntoView: @Boolean;
                    PageCallBacks::< 
                      (#
                         MakeDesignObject::< 
                           (# 
                           do
                              <<SLOT OADPageMakeDesignObject:Descriptor>>;
                              
                           #);
                         MakeLocalNodes:
                           (# theListDiagram: ^ListDiagram
                           enter theListDiagram[]
                           do <<SLOT MakeLocalNodes:Descriptor>>; 
                           #);
                         MakeMarkNode:
                           (#
                              theListDiagram:
                                ^ListDiagram;
                              ID: @Integer
                           enter (theListDiagram[],ID)
                           do <<SLOT MakeMarkNode:Descriptor>>; 
                           #);
                         MakeCommentNode:
                           (#
                              theListDiagram:
                                ^ListDiagram;
                              ID: @Integer
                           enter (theListDiagram[],ID)
                           do <<SLOT MakeCommentNode:Descriptor>>; 
                           #);
                         MakeUserDataLabelNode:
                           (# ID: @integer
                           enter ID
                           <<SLOT MakeUserDataLabelNode:DoPart>>
                           #);
                         MakeConn:
                           (#
                              ID: @Integer
                           enter ID
                           do
                              <<SLOT MakeConn:Descriptor>>;
                              
                           #);
                         MakeRole:
                           (#
                              theAssociationConnector: ^AssociationConnector;
                              theRole: ^theAssociationConnector.Role;
                              ID,theNodeID: @integer;
                              NodeType: @integer;
                              theObject: ^DesignObject;
                              theConnID: @integer;
                              regions: [0] @Integer
                           enter (theAssociationConnector[],ID)
                           <<SLOT MakeRole:DoPart>>
                           #);
                         makeSurroundBox:
                           (# theDiag: ^Diagram; ID: @integer
                           enter (theDiag[],ID)
                           <<SLOT makeSurroundBox:DoPart>>
                           #)
                      #);
                    onReadDiagram::< 
                      (#  do <<SLOT onReadDiagram:Descriptor>>;  #);
                    GrabPointer:< object;
                    UngrabPointer:< object;
                    UDPrivate:
                      @<<SLOT UDPagePrivate:Descriptor>>;
                    private: @<<SLOT GppOADPagePrivate:Descriptor>>;
                    onInit::< 
                      (# 
                      do
                         <<SLOT OADPageOnInit:Descriptor>>;
                         INNER
                      #);
                    
                 #);
               theGroupPage: ^OADPage;
               theWorkPage: ^OADPage;
               theObjectPage: (*kja&toby 19-1-94*) ^ObjectPage;
               checkEditmenuTextEdit:< (#  do INNER #);
               openAggregationDialog:<
                 (#
                    theAggregationConnector: ^theWorkPage.AggregationConnector;
                    theName,description: ^text;
                    kind,implementation,leftMulFrom,leftMulTo,rightMulFrom,
                      rightMulTo: @integer
                 enter
                 (theAggregationConnector[],theName[],kind,implementation,
                  leftMulFrom,leftMulTo,rightMulFrom,rightMulTo,description[])
                 do INNER openAggregationDialog
                 #);
               setReadOnly:< (#  <<SLOT setReadOnly:DoPart>> #);
               unsetReadOnly:<
                 (# 
                 <<SLOT unsetReadOnly:DoPart>>
                 #);
               LocalNodesUserDataStart: (#  exit 5000 #);
               LocalNodesUserDataEnd: (#  exit 6000 #);
               decomposDiagramsUserDataStart: (#  exit 7000 #);
               decomposDiagramsUserDataEnd: (#  exit 8000 #);
               updateUserDataIDs::< 
                 (# 
                 do <<SLOT OADDocumentUpdateUserDataIDs:Descriptor>>; 
                 #);
               ObjectMenu:
               (*kja&toby 1.9.94*) @UserMenu
                 (#
                    sep1: @Item;
                    sep2: @Item;
                    sep3: @Item;
                    sep4: @Item;
                    sep5: @Item;
                    sep6: @Item;
                    ShowObjectdiagram: @Item
                      (#
                         hit::< 
                           (# 
                           do <<SLOT ObjectMenuShowObjectdiagram:Descriptor>>; 
                           #)
                      #);
                    LocalIncludeScan: @Item
                      (#
                         hit::< 
                           (# 
                           do <<SLOT ObjectMenuLocalIncludeScan:Descriptor>>; 
                           #)
                      #);
                    GlobalIncludeScan: @Item
                      (#
                         hit::< 
                           (# 
                           do <<SLOT ObjectMenuGlobalIncludeScan:Descriptor>>; 
                           #)
                      #);
                    GlobalConfirmedScan: @Item
                      (#
                         hit::< 
                           (# 
                           do
                              <<SLOT ObjectMenuGlobalConfirmedScan:Descriptor>>;
                              
                           #)
                      #);
                    ToggleDynamicCreations: @Item
                      (#
                         hit::< 
                           (# 
                           do
                              <<SLOT ObjectMenuToggleDynamicCreations:Descriptor>>;
                              
                           #)
                      #);
                    ToggleProcedureCalls: @Item
                      (#
                         hit::< 
                           (# 
                           do
                              <<SLOT ObjectMenuToggleProcedureCalls:Descriptor>>;
                              
                           #)
                      #);
                    ShowSimpleObjects: @Item
                      (#
                         hit::< 
                           (# 
                           do <<SLOT ObjectMenuShowSimpleObjects:Descriptor>>; 
                           #)
                      #);
                    HideSimpleObjects: @Item
                      (#
                         hit::< 
                           (# 
                           do <<SLOT ObjectMenuHideSimpleObjects:Descriptor>>; 
                           #)
                      #);
                    Compact: @Item
                      (#
                         hit::< 
                           (#  do <<SLOT ObjectMenuCompact:Descriptor>>;  #)
                      #);
                    Blowup: @Item
                      (#
                         hit::< 
                           (#  do <<SLOT ObjectMenuBlowup:Descriptor>>;  #)
                      #);
                    DumpProcedurecalls:
                      @Item
                      (#
                         hit::< 
                           (# 
                           do
                              <<SLOT ObjectMenuDumpProcedurecalls:Descriptor>>; 
                           #)
                      #);
                    DumpDynamicGenerations: @Item
                      (#
                         hit::< 
                           (# 
                           do
                              <<SLOT ObjectMenuDumpDynamicGenerations:Descriptor>>;
                              
                           #)
                      #);
                    PrintNodeID: @Item
                      (#
                         hit::< 
                           (# 
                           do <<SLOT ObjectMenuPrintNodeID:Descriptor>>; 
                           #)
                      #);
                    DumpAst: @Item
                      (#
                         hit::< 
                           (#  do <<SLOT ObjectMenuDumpAst:Descriptor>>;  #)
                      #);
                    init::<  (#  do <<SLOT ObjectMenuInit:Descriptor>>;  #)
                 #);
               ViewMenuDesc:< UserMenu
                 (#
                    AbstractItem: @Item
                      (# hit::<  (#  do <<SLOT AbstractHit:Descriptor>> #)
                      #);
                    AbstractRecursivelyItem: @item
                      (#
                         hit::< 
                           (# 
                           <<SLOT ViewMenuAbstractRecursivelyItem:DoPart>>
                           #)
                      #);
                    OverviewItem: @item
                      (#
                         hit::<  (#  <<SLOT ViewMenuOverviewItem:DoPart>> #)
                      #);
                    DetailItem: @Item
                      (# hit::<  (#  do <<SLOT DetailHit:Descriptor>> #)
                      #);
                    DetailRecursivelyItem: @item
                      (#
                         hit::< 
                           (# 
                           <<SLOT ViewMenuDetailRecursivelyItem:DoPart>>
                           #)
                      #);
                    DetailOnDifferentPageItem: @item
                      (#
                         hit::< 
                           (# 
                           <<SLOT ViewMenuDetailOnDifferentPageItem:DoPart>>
                           #)
                      #);
                    SearchItemDesc:< item (#  #);
                    SearchItem: @SearchItemDesc;
                    ReplaceItemDesc:< item (#  #);
                    ReplaceItem: @ReplaceItemDesc;
                    SimpleCheck: @<<SLOT SimpleCheckDisplay:Descriptor>>;
                    AutoSubPatternLayoutItem: @item
                      (#
                         hit::< 
                           (# 
                           <<SLOT ViewMenuAutoSubPatternLayout:DoPart>>
                           #)
                      #);
                    LayoutPreferencesDesc:< item (#  #);
                    LayoutPreferencesItem: @LayoutPreferencesDesc;
                    LayoutSubpatterns: @item
                      (#
                         hit::< 
                           (#  <<SLOT ViewMenuLayoutSubpatterns:DoPart>> #)
                      #);
                    EdgedSpecializationConnectors: @item
                      (#
                         hit::< 
                           (# 
                           <<SLOT ViewMenuEdgedSpecializationConnectors:DoPart>>
                           #)
                      #);
                    TextAttributesItem: @Item
                      (#
                         hit::< 
                           (# 
                           do <<SLOT TextAttributesItemHit:Descriptor>>; 
                           #)
                      #);
                    FitToTextItem: @Item
                      (# hit::<  (#  <<SLOT FitToTextItemHit:DoPart>> #)
                      #);
                    DumpNodeItem: @Item
                      (#
                         hit::< 
                           (# 
                           do
                              <<SLOT ViewMenuDumpNodeItem:Descriptor>>;
                              
                           #)
                      #);
                    TraceItemDesc:< Item
                      (#
                         hit::< 
                           (# 
                           do <<SLOT ViewMenuTraceItem:Descriptor>>; INNER
                           #)
                      #);
                    TraceItem:
                      @TraceItemDesc;
                    TraceUserDataItem: @Item
                      (#
                         hit::< 
                           (#  do (not userDataVerbose)->userDataVerbose #)
                      #);
                    TraceCallbacksItem: @Item
                      (#
                         hit::< 
                           (#  do (not callbackVerbose)->callbackVerbose #)
                      #);
                    TraceCommunicationItem: @Item
                      (# hit::<  (#  do (not switch[40])->switch[40] #)
                      #);
                    DumpInheritanceListItem: @Item
                      (#
                         hit::< 
                           (# 
                           do <<SLOT DumpInheritanceItem:Descriptor>>; 
                           #)
                      #);
                    DumpAssociationListItem: @Item
                      (#
                         hit::< 
                           (# 
                           do <<SLOT DumpAssociationItem:Descriptor>>; 
                           #)
                      #);
                    DumpAggregationListItem: @Item
                      (#
                         hit::< 
                           (#  <<SLOT DumpAggregationListItem:DoPart>> #)
                      #);
                    DumpIndexIDListItem:
                      @Item
                      (#
                         hit::< 
                           (# 
                           do <<SLOT DumpIndexIDListItem:Descriptor>>; 
                           #)
                      #);
                    DumpAlternativeIndexIDListItem: @Item
                      (#
                         hit::< 
                           (# 
                           <<SLOT DumpAlternativeIndexIDListItem:DoPart>>
                           #)
                      #);
                    dumpLocalNodesItem: @item
                      (# hit::<  (#  <<SLOT dumpLocalNodesItem:DoPart>> #)
                      #);
                    dumpDiagramListItem:
                      @item
                      (# hit::<  (#  <<SLOT dumpDiagramListItem:DoPart>> #)
                      #);
                    dumpNodeID: @item
                      (# hit::<  (#  <<SLOT dumpNodeIDHit:DoPart>> #)
                      #);
                    sep,sep1,sep2,sep3,sep4,sep5,
                      sep6: @item;
                    init::<  (#  do <<SLOT ViewMenuInit:Descriptor>> #);
                    
                 #);
               ViewMenu: @ViewMenuDesc;
               pageMenu: @UserMenu
                 (#
                    sep1,sep2: @Item;
                    RefreshItem: @Item
                      (#
                         hit::< 
                           (# 
                           do
                              <<SLOT RefreshItem:Descriptor>>
                           #)
                      #);
                    ReduceItem: @Item
                      (# hit::<  (#  do <<SLOT ReduceItem:Descriptor>> #)
                      #);
                    BlowupItem: @Item
                      (#
                         hit::< 
                           (# 
                           do
                              <<SLOT BlowupItem:Descriptor>>
                           #)
                      #);
                    AttributesItem: @Item
                      (#
                         hit::< 
                           (#  do <<SLOT AttributesItem:Descriptor>> #)
                      #);
                    ShowGroupWindowItem:
                      @Item
                      (#
                         hit::< 
                           (#  do <<SLOT ShowGroupWindowItem:Descriptor>> #)
                      #);
                    ShowWorkSheetItem: @Item
                      (# hit::<  (#  <<SLOT ShowWorkSheetItem:DoPart>> #)
                      #);
                    HidePageItem: @Item
                      (#
                         hit::< 
                           (# 
                           do
                              <<SLOT HidePageItem:Descriptor>>;
                              
                           #)
                      #);
                    ShowAllPagesItem: @item
                      (#
                         hit::< 
                           (# pages: ^ObjectList
                           <<SLOT ShowAllPagesItem:DoPart>>
                           #)
                      #);
                    HideAllPagesItem: @item
                      (#
                         hit::< 
                           (#
                              pages:
                                ^ObjectList
                           <<SLOT HideAllPagesItem:DoPart>>
                           #)
                      #);
                    PageOverview: @item
                      (#
                         hit::< 
                           (# 
                           <<SLOT PageMenuPageOverView:DoPart>>
                           #)
                      #);
                    init::<  (#  do <<SLOT PageMenuInit:Descriptor>> #);
                    
                 #);
               OGppProp: (*kja&toby 28-1-94*)
                 @<<SLOT objectGppProperties:Descriptor>>;
               gppProp: @<<SLOT gppProperties:Descriptor>>;
               ObjectPrivate:
                 @<<SLOT ObjectPrivate:Descriptor>>
               (*kja&toby 1.9.94kja&toby 1.9.94*) ;
               onInit::<  (#  do <<SLOT OADDocumentInit:Descriptor>> #);
               
            #);
          IndexIDList: @IndexIDListDesc
            (#
               insert::< 
                 (# 
                 do
                    <<SLOT IndexIDListInsert:Descriptor>>
                 #)
            #);
          theOADDocument: ^OADDocument;
          CurrentDiagramName: ^Text;
          openFile:
          (* opens .bet .ast or .diag file - whichever is appropriate *)
            (# name: ^text enter name[] <<SLOT openFile:DoPart>> #);
          openDiagram:
            (# name: @Text
            enter name
            do <<SLOT openDiagram:Descriptor>>; 
            #);
          closeDiagram:
            (# 
            do
               <<SLOT closeDiagram:Descriptor>>;
               
            #);
          SaveLists: (#  do <<SLOT SaveLists:Descriptor>>;  #);
          topDotOpen:
            (# fullname: ^text; f: ^mps.fragment
            enter fullname[]
            do <<SLOT topDotOpen:Descriptor>>; 
            exit f[]
            #);
          getExtension:
            (# name: @Text; extension: ^Text
            enter name
            do <<SLOT getExtension:Descriptor>>; 
            exit extension[]
            #);
          removeExtension:
            (# name: @Text; 
            enter name
            do
               <<SLOT removeExtension:Descriptor>>;
               
            exit name
            #);
          doStartup: (#  do <<SLOT doStartup:Descriptor>> #);
          isChecked:
            (#
               fg: ^mps.fragmentgroup;
               b: @Boolean;
               
            enter fg[]
            <<SLOT isChecked:DoPart>>
            exit b
            #);
          GetGroupName:
          (* ask user for a groupfilename *)
            (#  do <<SLOT GetGroupName:Descriptor>> #);
          openFragmentGroup:
          (* open the group and scan it for properties and fragments
           * and display it on a new page
           *)
            (# name: @Text; fg: ^mps.fragmentgroup; 
            enter name
            do <<SLOT OpenFragmentGroup:Descriptor>>; 
            exit fg[]
            #);
          openFragmentForm:
          (* open the group and form
           *)
            (# name: @Text; se: ^SifEditor; ff: ^mps.fragmentform; 
            enter (name,se[])
            do <<SLOT OpenFragmentForm:Descriptor>>; 
            exit ff[]
            #);
          autosave:
            (# 
            do
               <<SLOT autosave:Descriptor>>;
               
            #);
          checkAutosaveFile:
            (#
               name: @text;
               didRecover: @boolean;
               error:< (# msg: @text enter msg do INNER #);
               cancelled:< Object
            enter name
            do <<SLOT checkAutosaveFile:Descriptor>>; 
            exit didRecover
            #);
          revert:
            (#
               name: @text;
               badRecovery: @boolean
            enter (name,badRecovery)
            do
               <<SLOT revert:Descriptor>>; 
            #);
          recoverDiagFile:
            (#
               name: @text;
               error:< (# msg: @text enter msg do INNER #)
            enter name
            <<SLOT recoverDiagFile:DoPart>>
            #);
          checkDiagFile:
            (#
               name: @text;
               fromRecovery,canTryRevert,OK:
                 @boolean
            enter (name,fromRecovery,canTryRevert)
            do <<SLOT checkdiagFile:Descriptor>>; 
            exit OK
            #);
          makeFrejaFile:
            (# name: ^text
            enter name[]
            do
               <<SLOT makeFrejaFile:Descriptor>>;
               
            #);
          scanASTfiles:
            (#
               name: @Text; currentGroupName: ^text; currentModTime: @integer
            enter name
            do <<SLOT scanASTfiles:Descriptor>>; 
            #);
          theFileMenu: @FileMenuDesc;
          FileMenuDesc:< UserMenu
            (#
               NewBETAProgramDesc:< item
                 (#
                    hit::< 
                      (#  do INNER #)
                 #);
               NewBETALibraryDesc:< item
                 (#
                    hit::< 
                      (#  do INNER #)
                 #);
               NewBETAProgram:
                 @NewBETAProgramDesc;
               NewBETALibrary: @NewBETALibraryDesc;
               NewGraphicsPage: @item
                 (#
                    hit::< 
                      (# thePage: ^theDocument.Page
                      <<SLOT theFileMenuNewGraphicsPage:DoPart>>
                      #)
                 #);
               Open: @item
                 (#
                    hit::< 
                      (# 
                      do
                         <<SLOT theFileMenuOpen:Descriptor>>;
                         
                      #);
                    init::<  (#  do false->proceed #)
                 #);
               Close: @item
                 (#
                    hit::<  (#  do <<SLOT theFileMenuClose:Descriptor>>;  #)
                 #);
               Save: @item
                 (# hit::<  (#  do <<SLOT theFileMenuSave:Descriptor>> #)
                 #);
               SaveAs: @item
                 (#
                    hit::< 
                      (# 
                      do
                         <<SLOT theFileMenuSaveAs:Descriptor>>
                      #)
                 #);
               Revert: @item
                 (#
                    hit::< 
                      (#  do <<SLOT theFileMenuRevert:Descriptor>>;  #)
                 #);
               PageSetup: @item
                 (#
                    hit::< 
                      (# 
                      do
                         docFileMenu.
                           pageSetupItem.execute
                      #)
                 #);
               Print: @item
                 (# hit::<  (#  do docFileMenu.printPageItem.execute #)
                 #);
               Preferences: @item
                 (# hit::<  (#  do docFileMenu.preferencesItem.execute #)
                 #);
               LoadText: @item
                 (# hit::<  (#  do docFileMenu.loadTextItem.execute #)
                 #);
               SaveText: @item
                 (# hit::<  (#  do docFileMenu.saveTextItem.execute #)
                 #);
               LoadGraphicsPage: @item
                 (#
                    hit::< 
                      (#  <<SLOT theFileMenuLoadGraphicsPage:DoPart>> #)
                 #);
               SavePageAsGraphics:
                 @item
                 (#
                    hit::< 
                      (# thePage: ^theDocument.Page
                      <<SLOT theFileMenuSavePageAsGraphics:DoPart>>
                      #)
                 #);
               About: @item
                 (#
                    hit::< 
                      (# 
                      do 
                      #)
                 #);
               Help: @item
                 (#
                    hit::< 
                      (# 
                      do 
                      #)
                 #);
               hideShowSifItemDesc:< Item
                 (# hit::<  (#  <<SLOT hideShowSifItem:DoPart>> #) #);
               hideShowSifItem:
                 @hideShowSifItemDesc;
               QuitDesc:< item (# hit::<  (#  do INNER #) #);
               Quit: @QuitDesc;
               sep1,sep2,sep3,sep4,sep5: @item;
               init::<  (#  do <<SLOT theFileMenuInit:Descriptor>> #)
            #);
          onInit::< 
            (# 
            <<SLOT DesignInterfaceOnInit:DoPart>>
            #);
          
       do (* designenv *) INNER ; 
       #);
     getSynCatNo:
       (#
          node: ^mps.ast;
          synCatNo: @mps.nonterminalSymbol;
          nontNode: ^mps.unExpanded;
          
       enter node[]
       <<SLOT getSynCatNo:DoPart>>
       exit synCatNo
       #);
     SifEditor:<
       (#
          undo:< (#  do INNER undo #);
          cut:< (#  do INNER cut #);
          copy:< (#  do INNER copy #);
          paste:< (#  do INNER paste #);
          pasteBefore:<
            (#  do INNER pasteBefore #);
          pasteAfter:<
            (#  do INNER pasteAfter #);
          before:< (#  do INNER before #);
          after:< (#  do INNER after #);
          changeFocus:<
            (# node: ^mps.ast; length: @integer
            enter (node[],length)
            do INNER changeFocus
            #);
          getStatus:<
            (#  do INNER getStatus #);
          expandNormal:<
            (# synCatNo: @integer
            enter synCatNo
            do INNER expandNormal
            #);
          expandOptional:<
            (# synCatNo: @integer
            enter synCatNo
            do INNER expandOptional
            #);
          expandLexem:<
            (# theText: @text
            enter text
            do INNER expandLexem
            #);
          insertOptionals:<
            (#  do INNER insertOptionals #);
          removeOptionals:<
            (#  do INNER removeOptionals #);
          parse:<
            (#
               node: ^mps.ast;
               parseText: @text;
               ok: @boolean;
               errorPos: @integer;
               parseErrorText: ^Text
            enter (node[],parseText)
            do INNER parse
            exit (ok,errorPos,parseErrorText[])
            #);
          search:< (#  do INNER search #);
          isReadOnly:<
            (# value: @boolean
            do INNER isReadOnly
            exit value
            #);
          init:< (#  do INNER init #)
       #);
     mps: ^astInterface;
     betaGram: ^astInterface.beta;
     gram: @grammar;
     
  do
     <<SLOT InitGPP:Descriptor>>;
     INNER ;
     theDesignInterface;
     
  #)  

