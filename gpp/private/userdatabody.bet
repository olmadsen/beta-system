ORIGIN '../gppinterface';
INCLUDE 'diagramattributes';
-- WriteASTReferenceUserData: Descriptor --
(#
   theDiagram: ^ListDiagram;
   thisPatternDiagramNode: ^PatternDiagramNode;
   thisMarkNode: ^MarkNode;
   fn: ^theDiagram.FragmentNode
do
   (if dataType## <= mps.AST## then
       dataElement[]->theAST[];
       (if THIS(UserDataNode)## <= MarkNode## then
           THIS(UserDataNode)[]->thisMarkNode[];
           thisMarkNode.thePatternDiagramNode->thisPatternDiagramNode[];
           (if thisPatternDiagramNode[] = none then
               thisMarkNode.theNode[]->thisPatternDiagramNode[]
           if)
        else
           THIS(UserDataNode)[]->thisPatternDiagramNode[]
       if);
       thisPatternDiagramNode.theDiagram->theDiagram[];
       (if thisPatternDiagramNode## <= theDiagram.FragmentNode## then
           thisPatternDiagramNode[]->fn[]; 
        else
           theDiagram.theFragmentNode->fn[]; 
       if);
       (if (fn.theFragment).fullname->(theAST.frag.fullname).equal then
           (Id,attributeId,theAST.index)->writeIntegerUserData
        else
           
       if)
   if);
   INNER writeUserData
#)  

-- ReadASTReferenceUserData: Descriptor --
(#
   theDiagram: ^ListDiagram;
   thisPatternDiagramNode: ^PatternDiagramNode;
   thisMarkNode: ^MarkNode;
   fn: ^theDiagram.FragmentNode;
   anAST: ^MPS.AST;
   
do (*(# anAST: ^MPS.AST
    do*)
   (if dataType## <= mps.AST## then
       (Id,attributeId)->readIntegerUserData->ASTIndex;
       (if ASTIndex <> 0 then
           (if THIS(UserDataNode)## <= MarkNode## then
               THIS(UserDataNode)[]->thisMarkNode[];
               thisMarkNode.thePatternDiagramNode->thisPatternDiagramNode[];
               (if thisPatternDiagramNode[] = none then
                   thisMarkNode.theNode[]->thisPatternDiagramNode[]
               if)
            else
               THIS(UserDataNode)[]->thisPatternDiagramNode[]
           if);
           thisPatternDiagramNode.theDiagram->theDiagram[];
           (if thisPatternDiagramNode## <= theDiagram.FragmentNode## then
               thisPatternDiagramNode[]->fn[]
            else
               theDiagram.theFragmentNode->fn[]
           if);
           (fn.theFragment,fn[])->theGroupPage.openFormInSif;
           fn.theFragment->theFragmentForm[];
           (if theFragmentForm[] <> none then
               ASTIndex
                 ->theFragmentForm.indexToNode
                   (#
                      indexOutOfRange::< 
                        (# 
                        do 'indexOutOfRange'->putLine; true->continue; 
                        #);
                      noSuchSymbol::< 
                        (#  do 'noSuchSymbol'->putLine; true->continue;  #);
                      grammarGenRefArrayError::< 
                        (# 
                        do 'grammarGenRefArrayError'->putLine; true->continue; 
                        #)
                   #)->anAST[];
               (if anAST[] = none then
                   'Gpp ReadASTReferenceUserData: node not found'->putLine
                else
                   (if userDataVerbose then
                       'indexToNode ok (index): '->puttext;
                       anAST.index->putint;
                       newline
                   if);
                   anAST[]->dataElement[]
               if);
               
           if)
       if)
    else
       'ReadASTReferenceUserData: dataType## is not in AST##'->putline; 
   if);
   (*INNER
    #)*)
   
#)  

-- WritePointUserData: Descriptor --
(#  do thePoint->(x,y) #)  

-- ReadPointUserData: Descriptor --
(#  do (x,y)->thePoint #)  

-- InitPointUserData: Descriptor --
(#  do x.Init; y.Init #)  

-- ReadFragReferenceUserData: Descriptor --
(#
   theFrag: ^mps.fragmentform;
   fg: ^mps.fragmentgroup;
   error: ^Stream;
   theDiagram: ^ListDiagram;
   thisPatternDiagramNode: ^PatternDiagramNode
do
   (if dataType## <= mps.FragmentForm## then
       (if dataElement[] = none then
           (theGroupName,error[])->mps.top.open->fg[];
           (if fg[] <> none then
               (theFragName,error[])->fg.open->theFrag[]->dataElement[];
               (if theFrag[] <> none then
                   THIS(UserDataNode)[]->thisPatternDiagramNode[];
                   thisPatternDiagramNode.theDiagram->theDiagram[];
                   (if thisPatternDiagramNode## <= theDiagram.FragmentNode##
                    then
                       (theFrag[],thisPatternDiagramNode[])
                         ->theGroupPage.openFormInSif
                    else
                       (theFrag[],theDiagram.theFragmentNode)
                         ->theGroupPage.openFormInSif
                   if);
                   (if userDataVerbose then
                       'Read fragmentform user data succeed: '->puttext;
                       fg.fullname->puttext;
                       '-'->puttext;
                       theFrag.name->putline
                   if)
                else
                   (if userDataVerbose then
                       'Read fragmentform user data fail: '->puttext;
                       theGroupName->puttext;
                       '-'->puttext;
                       theFragName->putline
                   if)
               if)
            else
               (if userDataVerbose then
                   'Read fragmentform user data: open group fail!'->putline
               if)
           if)
        else
           dataElement[]->theFrag[];
           (if userDataVerbose then
               'Read fragmentform <> none: '->puttext; theFrag.name->putline
           if)
       if)
   if)
#)  

-- ReadDiagramReferenceUserData: Descriptor --
(# 
do
   (if dataType## <= Diagram## then
       (if dataElement[] = none then
           (Id,attributeId)->readIntegerUserData->IDData;
           (if IDData <> 0 then
               IDdata->theObjectList.find->theNode[];
               (if theNode[] <> none then
                   theNode.thisDiagram->dataElement[]
               if)
           if)
       if)
   if)
#)  

-- WriteDiagramReferenceUserData: Descriptor --
(# 
do
   (if dataType## <= Diagram## then
       dataElement[]->theDiagram[];
       theDiagram.titleNode.ID->IDData;
       (ID,attributeID,IDData)->writeIntegeruserData
   if)
#)  

-- InitDiagramReferenceUserData: Descriptor --
(# 
do
   (if dataType## <= Diagram## then
       IDUserDataAttributes+1->IDUserDataAttributes->attributeId;
       (if userDataVerbose then
           'Initialising Diagram reference user data for id: '->puttext;
           id->putint;
           ' ;attributeID: '->puttext;
           attributeID->putint;
           newline
       if);
       true->attrIDalreadyInit
   if)
#)  

-- WriteFragReferenceUserData: Descriptor --
(# theFrag: ^mps.fragmentform; theGroup: ^mps.fragmentgroup
do
   (if dataType## <= mps.FragmentForm## then
       dataElement[]->theFrag[];
       theFrag.name->theFragName;
       theFrag.Father->theGroup[];
       theGroup.fullname->theGroupName
   if)
#)  

-- ReadFragGroupReferenceUserData: Descriptor --
(# error: ^Text
do
   (if dataElement[] = none then
       (fullname,error[])->mps.top.open->dataElement[]
   if)
#)  

-- InitFragReferenceUserData: Descriptor --
(#  do theFragName.Init; theGroupName.Init #)  

-- InitASTReferenceUserData: Descriptor --
(#  do INNER init #)  

-- InitLocalNode: Descriptor --
(# 
do
   &Type[]->DataType[];
   LocalNodesUDAttributes+1->LocalNodesUDAttributes->attributeId;
   (if userDataVerbose then
       'Initialising element in localNodes list for id='->puttext;
       id->putint;
       ' ;attributeID: '->puttext;
       attributeID->putint;
       newline
   if);
   (if dataElement[] <> none then
       (if userDataVerbose then
           'dataElement was none. Writing user data!'->putline
       if);
       dataElement[]->WriteUserData
   if);
   INNER InitLocalNode
#)  

-- InitDecomposDiagram: Descriptor --
(# 
do
   &Type[]->DataType[];
   DecomposDiagramsUDAttributes+1->DecomposDiagramsUDAttributes->attributeId;
   (if userDataVerbose then
       'Initialising element in decomposDiagrams list for id='->puttext;
       id->putint;
       ' ;attributeID: '->puttext;
       attributeID->putint;
       newline
   if);
   (if dataElement[] <> none then
       (if userDataVerbose then
           'dataElement was none. Writing user data!'->putline
       if);
       dataElement[]->WriteUserData
   if);
   INNER InitDecomposDiagram
#)  

-- resetLocalNodesUD: Descriptor --
(# range: @integer; ok: @Boolean
do
   oldLocalNodesUDAttributes-LocalNodesUserDataStart->range;
   (for i: range repeat
     (ID,LocalNodesUserDataStart+i)->deleteUserDataType
   for);
   LocalNodesUserDataStart->LocalNodesUDAttributes
#)  

