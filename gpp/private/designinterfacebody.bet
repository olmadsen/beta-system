ORIGIN 'diagramattributes';
INCLUDE '~beta/sysutils/time';
LIB_ITEM 'gpp';
-- saveFiles: DoPart --
do
     (#
        dummy: ^text;
        name: @Text;
        filename,t: @Text;
        f: @file;
        diagFile,tildeDiagFile: @file;
        dirWriteable: (# f: @file enter f.name exit f.entry.writeable #);
        dirIsWriteable: @boolean;
        pages,savedPages: ^ObjectList;
        savedPageIDs: [0] @Integer;
        undoSave:
          (# t: @text; diagFileName: ^text
          do
             currentDiagramName->removeExtension->t;
             'Restoring because of save failure...'->putline;
             currentDiagramName->prependCurrentPath->diagFileName[];
             '~'->(diagFileName.copy).append->tildeDiagFile.name;
             (if tildeDiagFile.entry.exists then
                 'mv %s %s\n'
                   ->putformat
                     (#  do tildeDiagFile.name->s; diagFileName[]->s #);
                 (diagFileName[],tildeDiagFile[])
                   ->myrename
                     (#
                        error::< 
                          (# 
                          do
                             'Could not move '->msg;
                             tildeDiagFile.name->msg.puttext;
                             ' into '->msg.puttext;
                             diagFileName[]->msg.puttext
                          #)
                     #)
              else
                 '%s does not exist\n'
                   ->putformat (#  do tildeDiagFile.name->s #)
             if);
             'Restore Done'->putline
          #)
     do
        thisOp:
        (if CurrentDiagramName[] <> none then
            theDocument[]->theOADDocument[];
            (if theOADDocument.diagISreadOnly then
                'Diagram is read-only'->alertUser; theFileMenu.SaveAs.hit
             else
                currentDiagramName->prependCurrentPath->diagFile.name;
                '~'->((diagFile.name).copy).append->tildeDiagFile.name;
                (if switch[17] then
                    'Freja theFileMenuSave:'->putLine;
                    diagFile.name->putLine;
                    tildeDiagFile.name->putLine
                if);
                (if diagFile.entry.path.head->dirWriteable then
                    true->dirIsWriteable;
                    (if diagFile.entry.exists then
                        17
                          ->trace
                            (# 
                            do
                               'mv %s %s\n'
                                 ->t.putformat
                                   (# 
                                   do diagFile.name->s; tildeDiagFile.name->s
                                   #)
                            #);
                        (tildeDiagFile.name,diagFile[])
                          ->myrename
                            (#
                               error::< 
                                 (# 
                                 do
                                    'Could not move '->msg;
                                    diagFile.name->msg.puttext;
                                    ' into '->msg.puttext;
                                    diagFile.name->msg.puttext;
                                    '~'->msg.puttext
                                 #)
                            #)
                    if)
                if);
                (if dirIsWriteable then
                    SaveLists;
                    (*(count[],list[])->DSStrGetPageList;*)
                    theDocument.getPages->pages[];
                    (if pages[] <> none then
                        pages.scan
                          (# 
                          do
                             (if current## <= theOADDocument.ObjectPage## then
                                 
                              else
                                 (if savedPages[] = none then
                                     &ObjectList[]->savedPages[]
                                 if);
                                 current[]->savedPages.insert
                             if)
                          #)
                    if);
                    (if savedPages[] <> none then
                        savedPages.ListToNodeIDs->savedPageIDs;
                        false->theDocument.Modified;
                        (CurrentDiagramName[],savedPageIDs)
                          ->fileSavePagesAsDiagram
                            (#
                               allErrors:: 
                                 (# 
                                 do
                                    true->continue;
                                    msg[]->alertUser;
                                    undoSave;
                                    leave thisOp
                                 #)
                            #);
                        currentDiagramName->prependCurrentPath->diagFile.name;
                        '#'->((diagFile.name).copy).append->f.name;
                        (if f.entry.exists then
                            17
                              ->trace
                                (#  do 'rm '->puttext; f.name->putline #);
                            f.delete
                        if);
                        (if doQuit then (normal,' ')->stop if)
                     else
                        'No Pages to save'->alertUser
                    if)
                 else
                    'No write access to the directory'->t; t[]->alertUser
                if)
            if)
         else
            theFileMenu.SaveAs.hit
        if)
     #)  

-- openFile: DoPart --
do
     (#
        ext,help: ^Text;
        didRecover: @boolean;
        ok: @integer;
        diagFile,autoSaveDiagFile,astFile,betFile: @file
     do
        thisOp:
          (#
             doOpenDiagram:
               (# 
               do
                  '.diag'->name.append;
                  name
                    ->checkAutoSaveFile
                      (#
                         error::<  (#  do msg[]->alertUser; leave thisOp #);
                         cancelled::<  (#  do leave thisOp #)
                      #)->didRecover;
                  name->openDiagram
               #);
             doOpenFragmentGroup:
               (# 
               do
                  (if currentDiagramName[] = none then
                      name.copy->currentDiagramName[];
                      '.diag'->currentDiagramName.append;
                      
                  if);
                  (name,true)->openFragmentGroup
               #)
          do
             (if name.length > 0
              // true then
                 name->getExtension->ext[];
                 (if ('.bet'->ext.equal) or (mps.astFileExtension->ext.equal)
                  then
                     name->removeExtension->name;
                     name->prependCurrentPath->help[];
                     '.diag'->(help.copy).append->diagFile.name;
                     '.diag#'->(help.copy).append->autoSaveDiagFile.name;
                     mps.astFileExtension->(help.copy).append->astFile.name;
                     '.bet'->(help.copy).append->betFile.name;
                     (if switch[17] then
                         'openFile filenames:\ndiag: %s\nast: %s\nbet: %s\n'
                           ->putformat
                             (# 
                             do
                                diagFile.name->s;
                                astFile.name->s;
                                betFile.name->s
                             #)
                     if);
                     (if currentDiagramName[] = none then
                         (if diagFile.entry.exists or
                         autoSaveDiagFile.entry.exists then
                             (if not diagFile.entry.exists then
                                 '.diag'->name.append;
                                 name
                                   ->checkAutoSaveFile
                                     (#
                                        error::< 
                                          (# 
                                          do msg[]->alertUser; leave thisOp
                                          #);
                                        cancelled::<  (#  do leave thisOp #)
                                     #)->didRecover;
                                 (if not didRecover then
                                     name->removeExtension->name;
                                     doOpenFragmentGroup
                                  else
                                     name->openDiagram
                                 if)
                              else
                                 doOpenDiagram
                             if)
                          else
                             doOpenFragmentGroup
                         if)
                      else
                         doOpenFragmentGroup
                     if)
                  else
                     (if ('.diag'->ext.equal) or ('.diag#'->ext.equal) then
                         (if currentDiagramName[] = none then
                             name
                               ->checkAutoSaveFile
                                 (#
                                    error::< 
                                      (# 
                                      do msg[]->alertUser; leave thisOp
                                      #);
                                    cancelled::<  (#  do leave thisOp #)
                                 #)->didRecover;
                             name->openDiagram
                          else
                             'A Diagram is already open. Open '->help[];
                             mps.astFileExtension->help.puttext;
                             ' or .bet file instead?'->help.puttext;
                             ('Open',help[])->promptForBoolean->ok;
                             (if ok = yes then
                                 name->removeExtension->name;
                                 (name,true)->openFragmentGroup
                             if)
                         if)
                      else
                         (if (ext.empty) or ('.'->ext.equal) then
                             (if '.'->ext.equal then
                                 name->removeExtension->name
                             if);
                             name->prependCurrentPath->help[];
                             '.diag'->(help.copy).append->diagFile.name;
                             '.diag#'->(help.copy).append
                               ->autoSaveDiagFile.name;
                             mps.astFileExtension->(help.copy).append
                               ->astFile.name;
                             '.bet'->(help.copy).append->betFile.name;
                             (if switch[17] then
                                 'openFile filenames:\ndiag: %s\nast: %s\nbet: %s\n'
                                   ->putformat
                                     (# 
                                     do
                                        diagFile.name->s;
                                        astFile.name->s;
                                        betFile.name->s
                                     #)
                             if);
                             (if
                             (diagFile.entry.exists or
                              autoSaveDiagFile.entry.exists) and
                             (currentDiagramName[] = none ) then
                                 (if not diagFile.entry.exists then
                                     '.diag'->name.append;
                                     name
                                       ->checkAutoSaveFile
                                         (#
                                            error::< 
                                              (# 
                                              do msg[]->alertUser; leave thisOp
                                              #);
                                            cancelled::< 
                                              (#  do leave thisOp #)
                                         #)->didRecover;
                                     (if not didRecover then
                                         name->removeExtension->name;
                                         doOpenFragmentGroup
                                      else
                                         name->openDiagram
                                     if)
                                  else
                                     doOpenDiagram
                                 if)
                              else
                                 (if astFile.entry.exists or
                                 betFile.entry.exists then
                                     doOpenFragmentGroup
                                  else
                                     'Please select a .bet, '->help[];
                                     mps.astFileExtension->help.puttext;
                                     ' or .diag file!'->help.puttext;
                                     help[]->alertUser
                                 if)
                             if)
                          else
                             'Please select a .bet, '->help[];
                             mps.astFileExtension->help.puttext;
                             ' or .diag file!'->help.puttext;
                             help[]->alertUser
                         if)
                     if)
                 if);
                 
             if)
          #)
     #)  

-- openDiagram: Descriptor --
(#
   pages: [0] @Integer;
   thePage: ^theDocument.Page;
   theOADPage: ^theOADDocument.OADPage;
   theObject: ^thePage.DesignObject;
   theConnID,theNodeID: @integer;
   createdAssociationConns: @ObjectList;
   t: @text;
   theText: ^text;
   ok: @boolean;
   readOnlyCheck:
     (#
        diagFile,frejaFile: @file;
        help: ^text;
        isWriteable:
          (#
             ASDiagFile,ASastFile,tildeDiagFile,tildeAstFile,ASfrejaFile,
               tildeFrejaFile: @file;
             v: @boolean;
             dirWriteable:
               (# f: @file enter f.name exit f.entry.writeable #)
          do
             '#'->((diagFile.name).copy).append->ASdiagFile.name;
             '~'->((diagFile.name).copy).append->tildeDiagFile.name;
             '#'->((frejaFile.name).copy).append->ASfrejaFile.name;
             '~'->((frejaFile.name).copy).append->tildefrejaFile.name;
             (if switch[17] then
                 'isWriteable:/nASdiagFile: %s\n'
                   ->putformat (#  do ASdiagFile.name->s #);
                 'tildeDiagFile: %s\n'
                   ->putformat (#  do tildeDiagFile.name->s #);
                 'isWriteable:/nASfrejaFile: %s\n'
                   ->putformat (#  do ASfrejaFile.name->s #);
                 'tildeFrejaFile: %s\n'
                   ->putformat (#  do tildeFrejaFile.name->s #)
             if);
             true->v;
             (if diagFile.entry.path.head->dirWriteable then
                 (if switch[17] then
                     'dir: %s is writeable\n'
                       ->putformat (#  do diagFile.entry.path.head->s #)
                 if);
                 (if diagFile.entry.exists then
                     diagFile.entry.writeable->v;
                     (if switch[17] then
                         'diagFile v='->puttext; v->putboolean; newline
                     if)
                 if);
                 (if ASdiagFile.entry.exists then
                     v and ASdiagFile.entry.writeable->v;
                     (if switch[17] then
                         'ASdiagFile v='->puttext; v->putboolean; newline
                     if)
                 if);
                 (if tildediagFile.entry.exists then
                     v and tildediagFile.entry.writeable->v;
                     (if switch[17] then
                         'tildediagFile v='->puttext; v->putboolean; newline
                     if)
                 if);
                 (if frejaFile.entry.exists then
                     v and frejaFile.entry.writeable->v;
                     (if switch[17] then
                         'frejaFile v='->puttext; v->putboolean; newline
                     if)
                 if);
                 (if ASfrejaFile.entry.exists then
                     v and ASfrejaFile.entry.writeable->v;
                     (if switch[17] then
                         'ASfrejaFile v='->puttext; v->putboolean; newline
                     if)
                 if);
                 (if tildefrejaFile.entry.exists then
                     v and tildefrejaFile.entry.writeable->v;
                     (if switch[17] then
                         'tildeFrejaFile v='->puttext; v->putboolean; newline
                     if)
                 if)
              else
                 false->v;
                 (if switch[17] then
                     'dir: %s is not writeable\n'
                       ->putformat (#  do diagFile.entry.path.head->s #)
                 if)
             if)
          exit v
          #)
     do
        17->trace (#  do 'ReadOnlyCheck:'->t #);
        name->prependCurrentPath->diagFile.name;
        (if switch[17] then
            'diagFile: %s\n'->putformat (#  do diagFile.name->s #)
        if);
        &text[]->help[];
        name->removeExtension->help;
        help->prependCurrentPath->help[];
        '.freja'->(help.copy).append->frejaFile.name;
        (if switch[17] then
            'frejaFile: %s\n'->putformat (#  do frejaFile.name->s #)
        if);
        (if not isWriteable then
            17->trace (#  do 'ReadOnlyCheck: is not writeable'->t #);
            true->theOADDocument.diagIsReadOnly;
            theOADDocument.setReadOnly
         else
            17->trace (#  do 'ReadOnlyCheck: is writeable'->t #)
        if)
     #)
do
   thisOp:
     (# 
     do
        name[]->currentDiagramName[];
        name
          ->FileOpenDiagram
            (#
               error:: 
                 (# 
                 do
                    true->continue;
                    none ->currentDiagramName[];
                    'File exception: Could not open diagram'->alertUser;
                    leave thisOp
                 #)
            #);
        &OADDocument[]->theDocument[]->theOADDocument[];
        theDocument.onInit;
        theDocument.getPageList->pages;
        (if pages.range > 0 then
            (for i: pages.range repeat
              (pages[i],10)->theDocument.readTextUserData->theText[];
              (if theText[] <> none then
                  (if true
                   // 'Group Window'->theText.equal then
                      &theOADDocument.OADPage[]->theOADDocument.theGroupPage[]
                        ->thePage[]
                   // 'WorkSheet'->theText.equal then
                      &theOADDocument.OADPage[]->theOADDocument.theWorkPage[]
                        ->thePage[]
                   // 'Object Page'->theText.equal then
                      &theOADDocument.ObjectPage[]
                        ->theOADDocument.theObjectPage[]->thePage[]
                   else
                      &theOADDocument.Page
                        (#
                           onInit:: 
                             (#  do theWindow[]->sifInsertInWindowsMenu #)
                        #)[]->thePage[]
                  if)
               else
                  &theOADDocument.Page
                    (#
                       onInit:: 
                         (#  do theWindow[]->sifInsertInWindowsMenu #)
                    #)[]->thePage[]
              if);
              pages[i]->thePage.onInit;
              thePage.onReadDiagram;
              thePage[]-> (* to force menuBar update *) theDocument.currentPage;
              true->menuBar.update;
              
            for);
            (if (theOADDocument.theWorkPage[] <> none ) and
            (theOADDocument.theGroupPage[] <> none ) then
                theOADDocument.theWorkPage[]->theDocument.CurrentPage;
                false->theDocument.repair;
                theOADDocument.updateUserDataIDs;
                theOADDocument.theWorkPage.PatternDiagrams.theList.scan
                  (# theListDiagram: ^theOADDocument.theWorkPage.ListDiagram
                  do
                     current.e[]->theListDiagram[];
                     theListDiagram[]
                       ->theOADDocument.theWorkPage.PageCallBack.MakeLocalNodes;
                     theListDiagram.titleNode.thePrefixConn.getID->theConnID;
                     (if theConnID <> 0 then
                         theConnID
                           ->theOADDocument.theWorkPage.PageCallBack.MakeConn
                     if)
                  #);
                theOADDocument.theGroupPage.PatternDiagrams.theList.scan
                  (# theListDiagram: ^theOADDocument.theGroupPage.ListDiagram
                  do
                     current.e[]->theListDiagram[];
                     theListDiagram[]
                       ->theOADDocument.theGroupPage.PageCallBack.MakeLocalNodes
                  #);
                theOADDocument.theWorkPage.PatternDiagrams.theList.scan
                  (#
                     theListDiagram: ^theOADDocument.theWorkPage.ListDiagram;
                     thisOADDiagram: ^theOADDocument.theWorkPage.OADDiagram;
                     thisFragmentDiagram:
                       ^theOADDocument.theWorkPage.FragmentDiagram;
                     thisPatternAttDiagram:
                       ^theOADDocument.theWorkPage.PatternAttDiagram
                  do
                     current.e[]->theListDiagram[];
                     (if current.e## <= theOADDocument.theWorkPage.OADDiagram##
                      then
                         current.e[]->thisOADDiagram[];
                         thisOADDiagram.titleNode.UDtheSurroundBox.getID
                           ->theNodeID;
                         (if theNodeID <> 0 then
                             (thisOADDiagram[],theNodeID)
                               ->
                                 theOADDocument.theWorkPage.PageCallBack.
                                   makeSurroundBox
                         if);
                         thisOADDiagram.titleNode.UDattributesBox.getID
                           ->theNodeID;
                         (if theNodeID <> 0 then
                             (thisOADDiagram[],theNodeID)
                               ->
                                 theOADDocument.theWorkPage.PageCallBack.
                                   makeSurroundBox
                         if);
                         thisOADDiagram.titleNode.UDoperationsBox.getID
                           ->theNodeID;
                         (if theNodeID <> 0 then
                             (thisOADDiagram[],theNodeID)
                               ->
                                 theOADDocument.theWorkPage.PageCallBack.
                                   makeSurroundBox
                         if);
                         thisOADDiagram.titleNode.UDlocalClassesBox.getID
                           ->theNodeID;
                         (if theNodeID <> 0 then
                             (thisOADDiagram[],theNodeID)
                               ->
                                 theOADDocument.theWorkPage.PageCallBack.
                                   makeSurroundBox
                         if);
                         thisOADDiagram.titlenode.theText.get
                           ->thisOADDiagram.titleText;
                         thisOADDiagram.localNodes.scan
                           (#
                              theSimpleNode:
                                ^thisOADDiagram.SimpleAttributeDecl;
                              theConnID: @integer
                           do
                              (if current## <=
                              thisOADDiagram.SimpleAttributeDecl## then
                                  current[]->theSimpleNode[];
                                  theSimpleNode.theAggregationConnector.getID
                                    ->theConnID;
                                  (if theConnID <> 0 then
                                      theConnID
                                        ->
                                          theOADDocument.theWorkPage.
                                            PageCallBack.MakeConn
                                  if);
                                  theSimpleNode.theAssociationConnector.getID
                                    ->theConnID;
                                  (if theConnID <> 0 then
                                      (if
                                      (theConnID->createdAssociationConns.find)
                                      = none then
                                          theConnID
                                            ->
                                              theOADDocument.theWorkPage.
                                                PageCallBack.makeConn;
                                          theSimpleNode.theAssociationConnector
                                            ->createdAssociationConns.insert
                                      if)
                                  if)
                              if)
                           #);
                         
                     if);
                     (if current.e## <=
                     theOADDocument.theWorkPage.FragmentDiagram## then
                         current.e[]->thisFragmentDiagram[];
                         thisFragmentDiagram.titlenode.theText.get
                           ->thisFragmentDiagram.titleText
                     if)
                  #);
                theOADDocument.theGroupPage.PatternDiagrams.theList.scan
                  (#
                     theListDiagram: ^theOADDocument.theGroupPage.ListDiagram;
                     thisOADDiagram: ^theOADDocument.theGroupPage.OADDiagram;
                     thisFragmentDiagram:
                       ^theOADDocument.theGroupPage.FragmentDiagram;
                     thePropertyDiagram:
                       ^theOADDocument.theGroupPage.PropertyDiagram;
                     thisPatternAttDiagram:
                       ^theOADDocument.theGroupPage.PatternAttDiagram;
                     theNodeID: @integer
                  do
                     current.e[]->theListDiagram[];
                     (if current.e## <= theOADDocument.theGroupPage.OADDiagram##
                      // true then
                         current.e[]->thisOADDiagram[];
                         thisOADDiagram.titlenode.theText.get
                           ->thisOADDiagram.titleText;
                         (if thisOADDiagram## <=
                         theOADDocument.theGroupPage.propertyDiagram## then
                             thisOADDiagram[]->thePropertyDiagram[];
                             thePropertyDiagram.titleNode.UDSurroundBox.getID
                               ->theNodeID;
                             (if theNodeID <> 0 then
                                 (thePropertyDiagram[],theNodeID)
                                   ->
                                     theOADDocument.theGroupPage.pageCallback.
                                       makeSurroundBox
                             if)
                         if);
                         
                     if);
                     (if current.e## <=
                     theOADDocument.theGroupPage.FragmentDiagram## then
                         current.e[]->thisFragmentDiagram[];
                         thisFragmentDiagram.titlenode.theText.get
                           ->thisFragmentDiagram.titleText
                     if)
                  #);
                theOADDocument.theGroupPage.patterndiagrams.parseDiagram;
                readOnlyCheck;
                false->theOADDocument.theGroupPage.visible;
                true->theDocument.repair;
                theOADDocument.theGroupPage.selectTopLeftObject;
                theOADDocument.theWorkPage.selectTopLeftObject;
                
             else
                'Either Group Page or Work Sheet was not found - quit immediatly to avoid further problems'
                  ->alertUser
            if)
         else
            'The selected .diag file does not have the right file format!'
              ->AlertUser
        if)
     #)
#)  

-- closeDiagram: Descriptor --
(#
   CheckMenu:
     (# theID: @Integer; theMenu: ^BasicMenu; 
     enter theID
     do
        theID->MenuBar.findMenu->theMenu[];
        (if theMenu[] <> none then
            theMenu[]->MenuBar.remove; (* theID->UI.DSMenuDeleteMenu*) 
        if);
        
     #);
   pages: ^ObjectList
do
   UserMenu1->CheckMenu;
   UserMenu2->CheckMenu;
   (* UserMenu3 is the fileMenu - do not remove! *)
   UserMenu4->CheckMenu;
   UserMenu5->CheckMenu;
   UserMenu6->CheckMenu;
   UserMenu7->CheckMenu;
   UserMenu8->CheckMenu;
   UserMenu9->CheckMenu;
   UserMenu10->CheckMenu;
   (*  UI.DSMenuShowMenuBar; *)
   theDocument.GetPages->pages[];
   (if pages[]
    // none then 
    else
       pages.scan
         (# dummy: ^theDocument.Page
         do
            current[]->dummy[];
            (if dummy[]
             // none then 'CloseItem: Page is node'->putline; 
             else
                dummy.close
            if);
            
         #);
       
   if);
   theDocument.close
#)  

-- loadGraphicsPages: DoPart --
do
   (if filename[] <> none then
       thisOp:
         (# pages,existingPages: [0] @integer; thePage: ^theDocument.Page
         do
            (if theDocument[] = none then
                &OADDocument[]->theDocument[]->theOADDocument[];
                theDocument.new;
                theDocument.currentPage->theOADDocument.theGroupPage[];
                'Group Window'->theOADDocument.theGroupPage.pageTitle;
                &theOADDocument.OADPage[]->theOADDocument.theWorkPage[];
                theOADDocument.theWorkPage.InvisibleNew;
                'WorkSheet'->theOADDocument.theWorkPage.PageTitle
            if);
            true->theOADDocument.gppProp.loadingGraphicsPages;
            theDocument.getPageList->existingPages;
            filename[]
              ->FileLoadPage
                (#
                   error:: 
                     (# 
                     do
                        true->continue;
                        'File exception: Could not load pages'->alertUser;
                        leave thisOp
                     #)
                #)->pages;
            (for k: pages.range repeat
              pageInit:
                (# pageTitle: @text
                do
                   (for j: existingPages.range repeat
                     (if pages[k] = existingPages[j] then leave pageInit if)
                   for);
                   &theDocument.Page
                     (#
                        onInit:: 
                          (#  do theWindow[]->sifInsertInWindowsMenu #)
                     #)[]->thePage[];
                   pages[k]->thePage.onInit;
                   thePage.PageTitle->pageTitle;
                   ' (Graphics) '->pageTitle.append;
                   pageTitle->thePage.pageTitle;
                   thePage.onReadDiagram;
                   (pages[k],10)->theDocument.deleteUserDataType;
                   (* delete userdata to convert from possible OADPage to graphics page *)
                   thePage[]->theDocument.currentPage
                #)
            for);
            false->theOADDocument.gppProp.loadingGraphicsPages
         #)
   if)  

-- SaveLists: Descriptor --
(#
   theListDiagram: ^theOADDocument.theWorkPage.ListDiagram;
   fd: ^theOADDocument.theGroupPage.FragmentDiagram;
   theReference: ^theListDiagram.titleNode.PatternDiagNodeReference;
   ok: @Boolean;
   showAttributesInteger,referencesInteger,specializationsInteger,
     associationsInteger,SimpleDeclDisplayInteger,x,y,w,h,l: @integer;
   fileName: @text;
   t: ^text
do
   theDocument[]->theOADDocument[];
   (theOADDocument.theWorkPage.ID,10,'WorkSheet')
     ->theDocument.writeTextUserData;
   (theOADDocument.theGroupPage.ID,10,'Group Window')
     ->theDocument.writeTextUserData;
   theOADDocument.theWorkPage.PatternDiagrams.theList.scan
     (# 
     do
        current.e[]->theListDiagram[];
        theOADDocument.localNodesUserDataStart+theListDiagram.localNodes.size
          ->theListDiagram.titleNode.OldLocalNodesUDAttributes;
        theListDiagram.titleNode.resetLocalNodesUD
     #);
   theOADDocument.theGroupPage.PatternDiagrams.theList.scan
     (# 
     do
        current.e[]->theListDiagram[];
        theOADDocument.localNodesUserDataStart+theListDiagram.localNodes.size
          ->theListDiagram.titleNode.OldLocalNodesUDAttributes;
        theListDiagram.titleNode.resetLocalNodesUD
     #);
   theOADDocument.theWorkPage.PatternDiagrams.theList.scan
     (# 
     do
        current.e[]->theListDiagram[];
        theListDiagram.localNodes.scan
          (# 
          do
             &theListDiagram.titleNode.PatternDiagNodeReference[]
               ->theReference[];
             theReference.InitLocalNode;
             current[]->theReference;
             
          #)
     #);
   theOADDocument.theGroupPage.PatternDiagrams.theList.scan
     (# 
     do
        current.e[]->theListDiagram[];
        theListDiagram.localNodes.scan
          (# 
          do
             &theListDiagram.titleNode.PatternDiagNodeReference[]
               ->theReference[];
             theReference.InitLocalNode;
             current[]->theReference;
             
          #)
     #);
   theOADDocument.theWorkPage.patterndiagrams.AssociationList.save;
   theOADDocument.theWorkPage.patterndiagrams.InheritanceList.save;
   theOADDocument.theWorkPage.patterndiagrams.AggregationList.save;
   (theOADDocument.theWorkPage.ID,240,theOADDocument.theWorkPage.nextX)
     ->theOADDocument.writeIntegerUserData;
   (theOADDocument.theWorkPage.ID,241,theOADDocument.theWorkPage.nextY)
     ->theOADDocument.writeIntegerUserData;
   (theOADDocument.theWorkPage.ID,250,
    theOADDocument.theWorkPage.patterndiagrams.NextFreeLine)
     ->theOADDocument.writeIntegerUserData;
   (theOADDocument.theWorkPage.ID,251,
    theOADDocument.theWorkPage.patterndiagrams.NextFreeColumn)
     ->theOADDocument.writeIntegerUserData;
   (theOADDocument.theWorkPage.ID,252,
    theOADDocument.theWorkPage.patterndiagrams.SecondFreeLine)
     ->theOADDocument.writeIntegerUserData;
   (theOADDocument.theWorkPage.ID,253,
    theOADDocument.theWorkPage.patterndiagrams.SecondFreeColumn)
     ->theOADDocument.writeIntegerUserData;
   (theOADDocument.theGroupPage.ID,240,theOADDocument.theGroupPage.nextX)
     ->theOADDocument.writeIntegerUserData;
   (theOADDocument.theGroupPage.ID,241,theOADDocument.theGroupPage.nextY)
     ->theOADDocument.writeIntegerUserData;
   (theOADDocument.theGroupPage.ID,250,
    theOADDocument.theGroupPage.patterndiagrams.NextFreeLine)
     ->theOADDocument.writeIntegerUserData;
   (theOADDocument.theGroupPage.ID,251,
    theOADDocument.theGroupPage.patterndiagrams.NextFreeColumn)
     ->theOADDocument.writeIntegerUserData;
   (theOADDocument.theGroupPage.ID,252,
    theOADDocument.theGroupPage.patterndiagrams.SecondFreeLine)
     ->theOADDocument.writeIntegerUserData;
   (theOADDocument.theGroupPage.ID,253,
    theOADDocument.theGroupPage.patterndiagrams.SecondFreeColumn)
     ->theOADDocument.writeIntegerUserData;
   (if theOADDocument.gppProp.showAttributes then
       1->showAttributesInteger
    else
       0->showAttributesInteger
   if);
   (theOADDocument.theGroupPage.ID,260,showAttributesInteger)
     ->theOADDocument.writeIntegerUserData;
   (if theOADDocument.gppProp.references then
       1->referencesInteger
    else
       0->referencesInteger
   if);
   (theOADDocument.theGroupPage.ID,261,referencesInteger)
     ->theOADDocument.writeIntegerUserData;
   (if theOADDocument.gppProp.specializations then
       1->specializationsInteger
    else
       0->specializationsInteger
   if);
   (theOADDocument.theGroupPage.ID,262,specializationsInteger)
     ->theOADDocument.writeIntegerUserData;
   (if theOADDocument.gppProp.associations then
       1->associationsInteger
    else
       0->associationsInteger
   if);
   (theOADDocument.theGroupPage.ID,263,associationsInteger)
     ->theOADDocument.writeIntegerUserData;
   theOADDocument.gppProp.SimpleDeclDisplay->SimpleDeclDisplayInteger;
   (theOADDocument.theGroupPage.ID,264,SimpleDeclDisplayInteger)
     ->theOADDocument.writeIntegerUserData
#)  

-- topDotOpen: Descriptor --
(#
   index,index2: @integer;
   formname,groupname: ^text;
   t,mess: @text;
   fg: ^mps.fragmentgroup
do
   17
     ->trace
       (#  do 'topDotOpen: %s'->t.putformat (#  do fullname[]->s #) #);
   '-'->fullname.findAll (#  do inx->index;  #);
   (if index > 0 then (* check whether the dash was in af folder name *)
       (index+1,fullname.length)->fullname.sub->formname[];
       directoryChar->formname.findAll (#  do inx->index2;  #);
       (if index2 <> 0 (* the dash was in a folder name *) then
           none ->formname[]
       if)
   if);
   (if (formname[] = none ) or (formname.empty) then
       thisOperation:
       (fullname[],t[])
         ->mps.top.open
           (#
              astOverflow::< 
                (# 
                do
                   none ->f[];
                   none ->mps.theCatcher[];
                   'AST overflow for '->mess;
                   fullname[]->mess.puttext;
                   mess[]->AlertUser;
                   leave thisOperation
                #);
              fragmentNotExisting::< 
                (# t: ^text
                do
                   none ->f[];
                   none ->mps.theCatcher[];
                   'Fragment file does not exist '->mess;
                   fullname[]->mess.puttext;
                   mess[]->AlertUser;
                   leave thisOperation
                #);
              grammarNotFound::< 
                (# 
                do
                   none ->f[];
                   none ->mps.theCatcher[];
                   'Grammar was not found'->mess;
                   mess[]->AlertUser;
                   leave thisOperation
                #);
              badFormat::< 
                (# 
                do
                   none ->f[];
                   none ->mps.theCatcher[];
                   'Bad format: '->mess;
                   fullname[]->mess.puttext;
                   mess[]->AlertUser;
                   leave thisOperation
                #);
              fatalParseError::< 
                (# 
                do
                   none ->f[];
                   none ->mps.theCatcher[];
                   'Fatal parse error: '->mess;
                   errNo->mess.putInt;
                   ' for '->mess.puttext;
                   fullname[]->mess.puttext;
                   mess[]->AlertUser;
                   leave thisOperation
                #);
              doubleFormDeclaration::< 
                (# 
                do
                   none ->f[];
                   none ->mps.theCatcher[];
                   'Double form declaration in '->mess;
                   fullname[]->mess.puttext;
                   mess[]->AlertUser;
                   leave thisOperation
                #);
              readAccessError::< 
                (# 
                do
                   none ->f[];
                   none ->mps.theCatcher[];
                   'No read access to '->mess;
                   fullname[]->mess.puttext;
                   mess[]->AlertUser;
                   leave thisOperation
                #);
              EOSError::< 
                (# 
                do
                   none ->f[];
                   none ->mps.theCatcher[];
                   'End Of Stream error in '->mess;
                   fullname[]->mess.puttext;
                   mess[]->AlertUser;
                   leave thisOperation
                #);
              noSuchFileError::< 
                (# 
                do
                   none ->f[];
                   none ->mps.theCatcher[];
                   'No such file: '->mess;
                   fullname[]->mess.puttext;
                   mess[]->AlertUser;
                   leave thisOperation
                #);
              fileExistsError::< 
                (# 
                do
                   none ->f[];
                   none ->mps.theCatcher[];
                   'File exists error'->mess;
                   mess[]->AlertUser;
                   leave thisOperation
                #);
              noSpaceLeftError::< 
                (# 
                do
                   none ->f[];
                   none ->mps.theCatcher[];
                   'No space left on device'->mess;
                   mess[]->AlertUser;
                   leave thisOperation
                #);
              otherFileError::< 
                (# 
                do
                   none ->f[];
                   none ->mps.theCatcher[];
                   'File error for: '->mess;
                   fullname[]->mess.puttext;
                   mess[]->AlertUser;
                   leave thisOperation
                #);
              WriteAccessOnLstFileError::< 
                (# 
                do
                   none ->f[];
                   none ->mps.theCatcher[];
                   'Access error on .lst file for '->mess;
                   fullname[]->mess.puttext;
                   mess[]->AlertUser;
                   leave thisOperation
                   (*'Access error on .lst file'->myException*)
                #);
              writeAccessError::< 
                (# 
                do
                   none ->f[];
                   none ->mps.theCatcher[];
                   'No write access'->mess;
                   mess[]->AlertUser;
                   leave thisOperation
                   (*'Write access error'->myException
                    * *)
                #);
              startingParsing::< 
                (# 
                do
                   'Parsing '->mess;
                   fullname[]->mess.putText;
                   mess[]->alertUser;
                   
                #);
              ParseErrors::< 
                (# 
                do
                   none ->f[];
                   none ->mps.theCatcher[];
                   mess[]->AlertUser;
                   leave thisOperation
                #)
           #)->f[]->fg[];
       (if fg[] <> none then
           (if not fg.isRealOpen then fg.realOpen if)
       if)
    else
       (1,index-1)->fullname.sub->groupname[];
       (if not groupname.empty then
           thisOperation:
           (groupname[],t[])
             ->mps.top.open
               (#
                  astOverflow::< 
                    (# 
                    do
                       none ->f[];
                       none ->mps.theCatcher[];
                       'AST overflow for '->mess;
                       groupname[]->mess.puttext;
                       mess[]->AlertUser;
                       leave thisOperation
                    #);
                  fragmentNotExisting::< 
                    (# t: ^text
                    do
                       none ->f[];
                       none ->mps.theCatcher[];
                       'Fragment file does not exist '->mess;
                       groupname[]->mess.puttext;
                       mess[]->AlertUser;
                       leave thisOperation
                    #);
                  grammarNotFound::< 
                    (# 
                    do
                       none ->f[];
                       none ->mps.theCatcher[];
                       'Grammar was not found'->mess;
                       mess[]->AlertUser;
                       leave thisOperation
                    #);
                  badFormat::< 
                    (# 
                    do
                       none ->f[];
                       none ->mps.theCatcher[];
                       'Bad format: '->mess;
                       groupname[]->mess.puttext;
                       mess[]->AlertUser;
                       leave thisOperation
                    #);
                  fatalParseError::< 
                    (# 
                    do
                       none ->f[];
                       none ->mps.theCatcher[];
                       'Fatal parse error: '->mess;
                       errNo->mess.putInt;
                       ' for '->mess.puttext;
                       groupname[]->mess.puttext;
                       mess[]->AlertUser;
                       leave thisOperation
                    #);
                  doubleFormDeclaration::< 
                    (# 
                    do
                       none ->f[];
                       none ->mps.theCatcher[];
                       'Double form declaration in '->mess;
                       groupname[]->mess.puttext;
                       mess[]->AlertUser;
                       leave thisOperation
                    #);
                  readAccessError::< 
                    (# 
                    do
                       none ->f[];
                       none ->mps.theCatcher[];
                       'No read access to '->mess;
                       groupname[]->mess.puttext;
                       mess[]->AlertUser;
                       leave thisOperation
                    #);
                  EOSError::< 
                    (# 
                    do
                       none ->f[];
                       none ->mps.theCatcher[];
                       'End Of Stream error in '->mess;
                       groupname[]->mess.puttext;
                       mess[]->AlertUser;
                       leave thisOperation
                    #);
                  noSuchFileError::< 
                    (# 
                    do
                       none ->f[];
                       none ->mps.theCatcher[];
                       'No such file: '->mess;
                       groupname[]->mess.puttext;
                       mess[]->AlertUser;
                       leave thisOperation
                    #);
                  fileExistsError::< 
                    (# 
                    do
                       none ->f[];
                       none ->mps.theCatcher[];
                       'File exists error'->mess;
                       mess[]->AlertUser;
                       leave thisOperation
                    #);
                  noSpaceLeftError::< 
                    (# 
                    do
                       none ->f[];
                       none ->mps.theCatcher[];
                       'No space left on device'->mess;
                       mess[]->AlertUser;
                       leave thisOperation
                    #);
                  otherFileError::< 
                    (# 
                    do
                       none ->f[];
                       none ->mps.theCatcher[];
                       'File error for: '->mess;
                       groupname[]->mess.puttext;
                       mess[]->AlertUser;
                       leave thisOperation
                    #);
                  WriteAccessOnLstFileError::< 
                    (# 
                    do
                       none ->f[];
                       none ->mps.theCatcher[];
                       'Access error on .lst file for '->mess;
                       groupname[]->mess.puttext;
                       mess[]->AlertUser;
                       leave thisOperation
                       (*'Access error on .lst file'->myException*)
                    #);
                  writeAccessError::< 
                    (# 
                    do
                       none ->f[];
                       none ->mps.theCatcher[];
                       'No write access'->mess;
                       mess[]->AlertUser;
                       leave thisOperation
                       (*'Write access error'->myException
                        * *)
                    #);
                  startingParsing::< 
                    (# 
                    do
                       'Parsing '->mess;
                       groupname[]->mess.putText;
                       mess[]->alertUser;
                       
                    #);
                  ParseErrors::< 
                    (# 
                    do
                       none ->f[];
                       none ->mps.theCatcher[];
                       mess[]->AlertUser;
                       leave thisOperation
                    #)
               #)->fg[];
           (if fg[] <> none then
               (if not fg.isRealOpen then fg.realOpen if);
               thisOperation:
               (formname[],t[])
                 ->fg.open
                   (#
                      astOverflow::< 
                        (# 
                        do
                           none ->f[];
                           none ->mps.theCatcher[];
                           'AST overflow for '->mess;
                           formname[]->mess.puttext;
                           mess[]->AlertUser;
                           leave thisOperation
                        #);
                      fragmentNotExisting::< 
                        (# t: ^text
                        do
                           none ->f[];
                           none ->mps.theCatcher[];
                           'Fragment file does not exist '->mess;
                           formname[]->mess.puttext;
                           mess[]->AlertUser;
                           leave thisOperation
                        #);
                      grammarNotFound::< 
                        (# 
                        do
                           none ->f[];
                           none ->mps.theCatcher[];
                           'Grammar was not found'->mess;
                           mess[]->AlertUser;
                           leave thisOperation
                        #);
                      badFormat::< 
                        (# 
                        do
                           none ->f[];
                           none ->mps.theCatcher[];
                           'Bad format: '->mess;
                           formname[]->mess.puttext;
                           mess[]->AlertUser;
                           leave thisOperation
                        #);
                      fatalParseError::< 
                        (# 
                        do
                           none ->f[];
                           none ->mps.theCatcher[];
                           'Fatal parse error: '->mess;
                           errNo->mess.putInt;
                           ' for '->mess.puttext;
                           formname[]->mess.puttext;
                           mess[]->AlertUser;
                           leave thisOperation
                        #);
                      doubleFormDeclaration::< 
                        (# 
                        do
                           none ->f[];
                           none ->mps.theCatcher[];
                           'Double form declaration in '->mess;
                           formname[]->mess.puttext;
                           mess[]->AlertUser;
                           leave thisOperation
                        #);
                      readAccessError::< 
                        (# 
                        do
                           none ->f[];
                           none ->mps.theCatcher[];
                           'No read access to '->mess;
                           formname[]->mess.puttext;
                           mess[]->AlertUser;
                           leave thisOperation
                        #);
                      EOSError::< 
                        (# 
                        do
                           none ->f[];
                           none ->mps.theCatcher[];
                           'End Of Stream error in '->mess;
                           formname[]->mess.puttext;
                           mess[]->AlertUser;
                           leave thisOperation
                        #);
                      noSuchFileError::< 
                        (# 
                        do
                           none ->f[];
                           none ->mps.theCatcher[];
                           'No such file: '->mess;
                           formname[]->mess.puttext;
                           mess[]->AlertUser;
                           leave thisOperation
                        #);
                      fileExistsError::< 
                        (# 
                        do
                           none ->f[];
                           none ->mps.theCatcher[];
                           'File exists error'->mess;
                           mess[]->AlertUser;
                           leave thisOperation
                        #);
                      noSpaceLeftError::< 
                        (# 
                        do
                           none ->f[];
                           none ->mps.theCatcher[];
                           'No space left on device'->mess;
                           mess[]->AlertUser;
                           leave thisOperation
                        #);
                      otherFileError::< 
                        (# 
                        do
                           none ->f[];
                           none ->mps.theCatcher[];
                           'File error for: '->mess;
                           formname[]->mess.puttext;
                           mess[]->AlertUser;
                           leave thisOperation
                        #);
                      WriteAccessOnLstFileError::< 
                        (# 
                        do
                           none ->f[];
                           none ->mps.theCatcher[];
                           'Access error on .lst file for '->mess;
                           formname[]->mess.puttext;
                           mess[]->AlertUser;
                           leave thisOperation
                           (*'Access error on .lst file'->myException*)
                        #);
                      writeAccessError::< 
                        (# 
                        do
                           none ->f[];
                           none ->mps.theCatcher[];
                           'No write access'->mess;
                           mess[]->AlertUser;
                           leave thisOperation
                           (*'Write access error'->myException
                            * *)
                        #);
                      startingParsing::< 
                        (# 
                        do
                           'Parsing '->mess;
                           formname[]->mess.putText;
                           mess[]->alertUser;
                           
                        #);
                      ParseErrors::< 
                        (# 
                        do
                           none ->f[];
                           none ->mps.theCatcher[];
                           mess[]->AlertUser;
                           leave thisOperation
                        #)
                   #)->f[]
            else
               'topDotOpen: Could not open group: '->puttext;
               groupname[]->putline
           if)
        else
           'topDotOpen: Groupname is empty!?'->putline
       if)
   if)
#)  

-- getExtension: Descriptor --
(# index: @Integer; isPath: @boolean; 
do
   '.'->name.findAll (#  do inx->index;  #);
   (if index <= 1 then
       ''->extension[]
    else
       (index,name.length)->name.sub->extension[];
       DirectoryChar->extension.findAll (#  do true->isPath #);
       (if isPath then ''->extension[] if)
   if);
   
#)  

-- removeExtension: Descriptor --
(# rest: ^Text; index: @Integer; 
do
   '.'->name.findAll (#  do inx->index;  #);
   (if index > 0 then
       (index,name.length)->name.sub->rest[]; (index,name.length)->name.delete
   if);
   
#)  

-- doStartup: Descriptor --
(#
   arg: ^Text;
   swt: @Text;
   SwitchMode: @Boolean;
   N: @Integer;
   ext: ^Text;
   help: @text;
   didRecover,ok: @boolean;
   
do
   (if isStandAloneFreja then
       (if NoOfArguments > 1
        // true then
           (for i: NoOfArguments-1 repeat
             i+1->Arguments->arg[];
             0->arg.setpos;
             getSwitch:
             (if SwitchMode
              // true then
                 arg.getint->N;
                 (if True
                  // (0 < N) and (N <= switch.range) then
                     True->Switch[N]; 
                  // N = 0 then
                     false->SwitchMode; 
                 if)
              else
                 (if arg.peek
                  // '-' then
                     arg.get;
                     (if arg.peek
                      // 'd' // 'D' then
                         arg.get; (for i: 100 repeat true->switch[i] for); 
                      // 's' // 'S' then
                         arg.get;
                         true->SwitchMode;
                         swt.clear;
                         restart getSwitch;
                         
                      // 'u' // 'U' then
                         arg.get; true->userdataVerbose
                      // 'v' // 'V' then
                         true->verbose
                     if);
                     
                  else
                     arg[]->openFile
                 if)
             if)
           for)
       if)
   if)
#)  

-- isChecked: DoPart --
do
   'doneCheck'
     ->fg.prop.getProp
       (#
          doprop::<  (#  do (if getConst // 0 then  else true->b if) #)
       #);
     

-- OpenFragmentGroup: Descriptor --
(#
   myDocument: ^OADDocument;
   opened: @boolean;
   propd: ^myDocument.theGroupPage.PropertyDiagram;
   fragd: ^myDocument.theGroupPage.FragmentDiagram;
   mess: @Text;
   FragmentDoesNotExistText,diagFileName,autoSaveFileExtension,
     tildeFileExtension,help: ^text;
   NoOfForms: @Integer;
   groupFile,autosaveGroupFile,tildeGroupFile: @file;
   doNotOpenAstFile: @boolean;
   ok: @integer;
   
do
   (if switch[17]
    // true then
       'Opening: '->mess.puttext;
       name[]->mess.puttext;
       mess[]->putLine (*
                        * mess->statusbar.set;
                        *)
   if);
   mps.astFileExtension->(name.copy).append->help[];
   help->prependCurrentPath->groupFile.name;
   (mps.astFileExtension).copy->autoSaveFileExtension[];
   '#'->autoSaveFileExtension.puttext;
   autoSaveFileExtension[]->((groupFile.name).copy).append
     ->autosaveGroupFile.name;
   (mps.astFileExtension).copy->tildeFileExtension[];
   '~'->tildeFileExtension.puttext;
   tildeFileExtension[]->((groupFile.name).copy).append->tildeGroupFile.name;
   (if switch[17] then
       'Freja OpenFragmentGroup: '->putLine;
       groupFile.name->putLine;
       autosaveGroupFile.name->putLine;
       tildeGroupFile.name->putLine
   if);
   thisOp:
     (# 
     do
        (if checkAutoSave then
            (if autosaveGroupFile.entry.exists and groupFile.entry.exists then
                (if autosaveGroupFile.entry.modtime > groupFile.entry.modtime
                 then
                    'Autosave '->help[];
                    mps.astFileExtension->help.puttext;
                    ' file is newer, recover?'->help.puttext;
                    ('Open',help[])->promptForBoolean->ok;
                    (if ok
                     // yes then
                        (groupFile.name,autoSaveGroupFile[])
                          ->myrename
                            (#
                               error::< 
                                 (# 
                                 do
                                    'Could not move '->msg;
                                    groupFile.name->msg.puttext;
                                    '# into '->msg.puttext;
                                    groupFile.name->msg.puttext;
                                    leave thisOp
                                 #)
                            #)
                     // no then
                        
                     // cancel then
                        leave thisOp
                    if)
                if)
            if)
        if);
        (if not doNotOpenAstFile then
            name[]->mps.ExpandToFullPath->topDotOpen->fg[];
            (if fg[]
             // none then
                'Cannot open fragmentgroup: '->mess;
                name[]->mess.puttext;
                (if FragmentDoesNotExistText[] <> none then
                    mess.newline; FragmentDoesNotExistText[]->mess.puttext
                if);
                mess[]->screen.putline;
                
             else
                fg.fragmentlist.scan
                  (# 
                  do
                     (if current.type
                      // mps.formtype then noofforms+1->noofforms
                     if)
                  #);
                (if theDocument[]
                 // none then
                    systemtime->UniqueDiagramID;
                    fg[]->sifSetFrejaMark;
                    &OADDocument[]->myDocument[];
                    myDocument.new;
                    (if NoOfForms
                     // 1 then
                        myDocument.CurrentPage->myDocument.theWorkPage[];
                        'WorkSheet'->myDocument.theWorkPage.PageTitle;
                        &myDocument.OADPage[]->myDocument.theGroupPage[];
                        myDocument.theGroupPage.InvisibleNew;
                        myDocument.theWorkPage[]->myDocument.CurrentPage;
                        
                     else
                        myDocument.CurrentPage->myDocument.theGroupPage[];
                        myDocument[]->theDocument[]->theOADDocument[];
                        &myDocument.OADPage[]->myDocument.theWorkPage[];
                        myDocument.theWorkPage.InvisibleNew;
                        'WorkSheet'->myDocument.theWorkPage.PageTitle;
                        
                    if);
                    'Group Window'->myDocument.theGroupPage.PageTitle;
                    
                 else
                    theDocument[]->myDocument[];
                    (if NoOfForms
                     // 1 then 
                     else
                        myDocument.theGroupPage.visible; 
                    if);
                    
                if);
                false->myDocument.repair;
                scanner:
                myDocument.theGroupPage.PatternDiagrams.theList.
                  scanPropertyDiagrams
                  (# 
                  do
                     (if switch[17] then
                         'openFragmentGroup - check if already open:\nfg.name: %s\nthisDiagram.fullname: %s\n'
                           ->putformat
                             (# 
                             do fg.name->s; (thisDiagram.theGroup).fullname->s
                             #)
                     if);
                     (if fg.name->((thisDiagram.theGroup).fullname).equal
                      // true then true->opened; leave scanner; 
                     if);
                     
                  #);
                (if opened
                 // true then (* fragment already shown: just show the page *)
                    myDocument.theGroupPage[]->myDocument.CurrentPage; 
                 else
                    (if switch[17]
                     // true then
                        'Scanning Properties'->putLine (*statusbar.set; *) ;
                        'propertyDiagram.fullname: %s\n'
                          ->putformat
                            (#  do name[]->mps.expandToFullPath->s #)
                    if);
                    &myDocument.theGroupPage.PropertyDiagram[]->propd[];
                    (fg[],true)->propd.new;
                    &myDocument.theGroupPage.FragmentDiagram[]->fragd[];
                    (if switch[17]
                     // true then
                        'Scanning Fragments'->putLine (*statusbar.set; *)
                    if);
                    fg[]->fragd.new;
                    
                if);
                (if NoOfForms
                 // 1 then
                    myDocument.theGroupPage.FragmentDiagram##
                      ->myDocument.theGroupPage.ScanDiagrams
                        (# 
                        do
                           current[]->fragd[];
                           (if fg[]
                            // fragd.theGroup then
                            (* find formname in the diagram *)
                               fragd.localnodes.scan
                                 (#  do current.detail #)
                           if)
                        #)
                if);
                true->myDocument.repair
            if)
        if)
     #)
#)  

-- OpenFragmentForm: Descriptor --
(#
   index: @Integer;
   groupname,formname: ^Text;
   fg: ^mps.fragmentgroup;
   theDoc: ^OADDocument;
   theDiagram: ^theDoc.theGroupPage.FragmentDiagram;
   noOfForms: @integer;
   
do (* first open the group, and then open the form *)
   '-'->name.findAll (#  do inx->index;  #);
   (1,index-1)->name.sub->groupname[];
   (if groupname[] <> none then
       (groupname,checkAutoSave)->openFragmentGroup->fg[];
       (if (theDocument[] <> none ) and (fg[] <> none ) then
           false->theDocument.repair;
           (index+1,name.length)->name.sub->formname[];
           (if formname[] <> none then
               fg.fragmentlist.scan
                 (# 
                 do
                    (if current.type = mps.formtype then
                        noofforms+1->noofforms;
                        (if (current.f.name->formName.equal) then
                            current.f[]->ff[]
                        if)
                    if)
                 #);
               theDocument[]->theDoc[];
               theDoc.theGroupPage.FragmentDiagram##
                 ->theDoc.TheGroupPage.ScanDiagrams
                   (# 
                   do
                      current[]->theDiagram[];
                      (if fg[] = theDiagram.theGroup then
                      (* find formname in the diagram
                       and by following theGroup reference
                       open sif editor if not already open *)
                          theDiagram.localnodes.scan
                            (# t: ^text; 
                            do
                               &Text[]->t[];
                               current.theText.get->t;
                               ':'->t.findAll (#  do inx->index #);
                               (1,index-1)->t.sub->t[];
                               (if t[] <> none then
                                   (if (formname[]->t.equal) and (noOfForms > 1)
                                    then
                                   (* if noOfForms = 1 the form has already been opened
                                    * by openFragmentGroup
                                    *)
                                       current.detail
                                   if)
                               if)
                            #)
                      if)
                   #)
           if);
           true->theDocument.repair
       if)
   if)
#)  

-- gppMyRename: DoPart --
do
   thisOp:
     (# 
     do
        name.copy->orig.name;
        (if orig.entry.exists then orig.delete if);
        name.copy
          ->f.entry.rename
            (# error::<  (#  do THIS(myrename).error; leave thisOp #)
            #)
     #)  

-- autosave: Descriptor --
(# filename,filename2: @Text; pages: [0] @Integer
do
   thisOp:
   (if not switch[100] then
       theDocument[]->theOADDocument[];
       (if theOADDocument.gppProp.globalInteractiveMode =
       theOADDocument.gppProp.noGlobalInteractiveMode then
           theDocument.getPageList->pages;
           (if pages.range > 0 then
               (if not doNotSifAutoSave
               (* this boolean is a tribute to Mr. Sandvad :-) *) then
                   sifAutoSave
               if);
               SaveLists;
               (if currentDiagramName[] <> none then
                   filename2.clear;
                   currentDiagramName[]->filename2.puttext;
                   '#'->filename2.append;
                   (if switch[17] then
                       'Freja autosave:'->putLine; filename2[]->putLine; 
                   if);
                   (filename2[],pages)
                     ->fileSavePagesAsDiagram
                       (#
                          allErrors:: 
                            (# 
                            do
                               true->continue;
                               'Autosave:\n'->msg.prepend;
                               msg[]->alertUser;
                               leave thisOp
                            #)
                       #)
                else
                   'Autosave: No current diagram??'->putline
               if)
            else
               'Warning: Could not get pages in document - no autosave was done!'
                 ->alertuser;
               'Warning: Could not get pages in document - no autosave was done!'
                 ->stdErr.putline
           if)
       if)
   if)
#)  

-- checkAutoSaveFile: Descriptor --
(#
   diagFile,autosaveDiagFile: @file;
   groupFile,autosaveGroupFile: @file;
   doRecover,doNotRecover: @boolean;
   ok: @integer;
   groupName,frejaFileName,autosaveFrejaFileName,diagFileName: ^text;
   help: @text
do
   name->prependCurrentPath->diagFileName[]->diagFile.name;
   '#'->(diagFileName.copy).append->autosaveDiagFile.name;
   name.copy->groupName[];
   groupName->removeExtension->groupName;
   groupName->prependCurrentPath->groupName[];
   (if switch[17] then
       'Freja checkAutoSaveFile:'->putLine;
       diagFile.name->putLine;
       autosaveDiagFile.name->putLine
   if);
   thisOp:
     (# 
     do
        (if autosaveDiagFile.entry.exists then
            (if DiagFile.entry.exists then
                (if autosaveDiagFile.entry.modtime > DiagFile.entry.modtime then
                    'Autosave file %s is newer than %s, recover?'
                      ->help.putformat
                        (# 
                        do autoSaveDiagFile.name->s; DiagFile.name->s
                        #);
                    ('Open',Help[])->promptForBoolean->ok;
                    (if ok
                     // yes then
                        true->doRecover
                     // no then
                        true->doNotRecover
                     // cancel then
                        cancelled; leave thisOp
                    if)
                if)
             else
                'Autosave file %s exists, recover?'
                  ->help.putformat (#  do autoSaveDiagFile.name->s #);
                ('Open',help[])->promptForBoolean->ok;
                (if ok
                 // yes then
                    true->doRecover
                 // no then
                    
                 // cancel then
                    cancelled; leave thisOp
                if)
            if);
            
        if);
        (if doRecover then
            name
              ->recoverDiagFile
                (#
                   error::< 
                     (# 
                     do msg->THIS(checkAutoSaveFile).error; leave thisOp
                     #)
                #);
            true->didRecover
        if)
     #)
#)  

-- revert: Descriptor --
(#
   ok: @integer;
   diagFile,autosaveDiagFile,tildeDiagFile: @file;
   groupFile,tildeGroupFile: @file;
   groupName,help: ^text
do
   thisOperation:
     (# 
     do
        name->prependCurrentPath->diagFile.name;
        '#'->((diagFile.name).copy).append->autosaveDiagFile.name;
        '~'->((diagFile.name).copy).append->tildeDiagFile.name;
        (if switch[17] then
            'Freja revert:'->putLine;
            diagFile.name->putLine;
            autosaveDiagFile.name->putLine;
            tildeDiagFile.name->putLine
        if);
        (if badRecovery then
            ('Revert','Revert to latest saved diagram?')->promptForBoolean->ok
         else
            yes->ok
        if);
        (if ok = yes then
            name.copy->groupName[];
            groupName->removeExtension->groupName;
            groupName->prependCurrentPath->groupName[];
            (if badRecovery then
                (if tildeDiagFile.entry.exists then
                    'mv .diag~ .diag'->putLine;
                    (diagFile.name,tildeDiagFile[])
                      ->myrename
                        (#
                           error::< 
                             (# 
                             do
                                'Could not move '->msg;
                                diagFile.name->msg.puttext;
                                '~ into '->msg.puttext;
                                diagFile.name->msg.puttext;
                                leave thisOperation
                             #)
                        #)
                 else
                    'No .diag~ file!!'->putLine; leave thisOperation
                if);
                name->openDiagram
            if)
        if)
     #)
#)
(*
 -- FrejaOptionsMenuInit: Descriptor --
 (#  do (UserMenu3+13,'With Dexter')->WithDexterItem.init;  #)
 
 -- FrejaOptionsMenuCheckMarks: Descriptor --
 (#  do withDexter->WithDexterItem.check #)
 *)  

-- recoverDiagFile: DoPart --
do
     (#
        diagFile,autosaveDiagFile,groupFile,autosaveGroupFile: @file;
        groupName,diagFileName: ^text
     do
        name->prependCurrentPath->diagFileName[]->diagFile.name;
        '#'->(diagFileName.copy).append->autosaveDiagFile.name;
        name.copy->groupName[];
        groupName->removeExtension->groupName;
        groupName->prependCurrentPath->groupName[];
        thisOp:
        (if autosaveDiagFile.entry.exists and diagFile.entry.exists then
            (if autosaveDiagFile.entry.modtime > diagFile.entry.modtime then
            (* no not any more
             'mv .diag .diag~'->putLine;
             tildeDiagFileName[]->diagFile.entry.rename;
             *)
                'mv .diag# .diag'->putLine;
                (diagFileName[],autoSaveDiagFile[])
                  ->myrename
                    (#
                       error::< 
                         (# 
                         do
                            'Could not move '->msg;
                            diagFile.name->msg.puttext;
                            '# into '->msg.puttext;
                            diagFile.name->msg.puttext;
                            msg->THIS(recoverDiagFile).error;
                            leave thisOp
                         #)
                    #)
             else
                'autosaveDiagFile.entry.modtime IS NOT > diagFile.entry.modtime'
                  ->putLine;
                
            if)
         else
            (if autosaveDiagFile.entry.exists then
                'mv .diag# .diag'->putLine;
                (diagFileName[],autoSaveDiagFile[])
                  ->myrename
                    (#
                       error::< 
                         (# 
                         do
                            'Could not move '->msg;
                            diagFile.name->msg.puttext;
                            '# into '->msg.puttext;
                            diagFile.name->msg.puttext;
                            msg->THIS(recoverDiagFile).error;
                            leave thisOp
                         #)
                    #)
            if)
        if)
     #)  

-- DesignInterfaceOnInit: DoPart --
do INNER ; theGui->theUI[]; doStartUp;   

