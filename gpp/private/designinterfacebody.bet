ORIGIN 'diagramattributes';
INCLUDE '~beta/sysutils/v1.6/time';
-- IndexIDListInsert: Descriptor --
(# 
do
   (if switch[21]
    // true then
       '%21GPP: Insert element indexed: '->screen.puttext;
       a->screen.putint;
       screen.newline;
       
   if)
#)  

-- openFile: DoPart --
do
     (#
        ext,help: ^Text;
        didRecover: @boolean;
        ok: @integer;
        diagFile,astFile,betFile: @file
     do
        thisOp:
        (if name.length > 0
         // true then
            name->getExtension->ext[];
            (if ('.bet'->ext.equal) or (mps.astFileExtension->ext.equal) then
                name->removeExtension->name;
                name.copy->diagFile.name;
                name.copy->astFile.name;
                name.copy->betFile.name;
                '.diag'->(name.copy).append->diagFile.name;
                mps.astFileExtension->(name.copy).append->astFile.name;
                '.bet'->(name.copy).append->betFile.name;
                (if diagFile.entry.exists then
                    (if astFile.entry.exists then
                        (if currentDiagramName[] = none then
                            (if diagFile.entry.modtime > astFile.entry.modtime
                             then
                                (if betFile.entry.exists then
                                    (if betFile.entry.modtime >
                                    diagFile.entry.modtime then
                                        (if currentDiagramName[] = none then
                                            name.copy->currentDiagramName[];
                                            '.diag'->currentDiagramName.append;
                                            
                                        if);
                                        (name,true)->openFragmentGroup
                                     else
                                        ('Open',
                                         '.diag file is newer, open instead?')
                                          ->promptForBoolean->ok;
                                        (if ok
                                         // yes then
                                            '.diag'->name.append;
                                            name
                                              ->checkAutoSaveFile
                                                (#
                                                   error::< 
                                                     (# 
                                                     do
                                                        msg[]->alertUser;
                                                        leave thisOp
                                                     #);
                                                   cancelled::< 
                                                     (#  do leave thisOp #)
                                                #)->didRecover;
                                            (if
                                            (name,didRecover,true)
                                              ->checkDiagFile then
                                                name->openDiagram
                                            if)
                                         // no then
                                            (if currentDiagramName[] = none
                                             then
                                                name.copy->currentDiagramName[];
                                                '.diag'
                                                  ->currentDiagramName.append;
                                                
                                            if);
                                            (name,true)->openFragmentGroup
                                        if)
                                    if)
                                 else
                                    ('Open',
                                     '.diag file is newer, open instead?')
                                      ->promptForBoolean->ok;
                                    (if ok
                                     // yes then
                                        '.diag'->name.append;
                                        name
                                          ->checkAutoSaveFile
                                            (#
                                               error::< 
                                                 (# 
                                                 do
                                                    msg[]->alertUser;
                                                    leave thisOp
                                                 #);
                                               cancelled::< 
                                                 (#  do leave thisOp #)
                                            #)->didRecover;
                                        (if
                                        (name,didRecover,true)->checkDiagFile
                                         then
                                            name->openDiagram
                                        if)
                                     // no then
                                        (if currentDiagramName[] = none then
                                            name.copy->currentDiagramName[];
                                            '.diag'->currentDiagramName.append;
                                            
                                        if);
                                        (name,true)->openFragmentGroup
                                    if)
                                if)
                             else
                                (if currentDiagramName[] = none then
                                    name.copy->currentDiagramName[];
                                    '.diag'->currentDiagramName.append;
                                    
                                if);
                                (name,true)->openFragmentGroup
                            if)
                         else
                            (name,true)->openFragmentGroup
                        if)
                     else
                        (if currentDiagramName[] = none then
                            name.copy->currentDiagramName[];
                            '.diag'->currentDiagramName.append;
                            
                        if);
                        (name,true)->openFragmentGroup
                    if)
                 else
                    (if currentDiagramName[] = none then
                        name.copy->currentDiagramName[];
                        '.diag'->currentDiagramName.append;
                        
                    if);
                    (name,true)->openFragmentGroup
                if)
             else
                (if '.diag'->ext.equal then
                    (if currentDiagramName[] = none then
                        name
                          ->checkAutoSaveFile
                            (#
                               error::< 
                                 (#  do msg[]->alertUser; leave thisOp #);
                               cancelled::<  (#  do leave thisOp #)
                            #)->didRecover;
                        (if (name,didRecover,true)->checkDiagFile then
                            name->openDiagram
                        if)
                     else
                        'A Diagram is already open. Open '->help[];
                        mps.astFileExtension->help.puttext;
                        ' or .bet file instead?'->help.puttext;
                        ('Open',help[])->promptForBoolean->ok;
                        (if ok = yes then
                            name[]->currentDiagramName[];
                            name->removeExtension->name;
                            (name,true)->openFragmentGroup
                        if)
                    if)
                 else
                    (if (ext.empty) or ('.'->ext.equal) then
                        (if '.'->ext.equal then
                            name->removeExtension->name
                        if);
                        name.copy->diagFile.name;
                        name.copy->astFile.name;
                        name.copy->betFile.name;
                        '.diag'->(name.copy).append->diagFile.name;
                        mps.astFileExtension->(name.copy).append->astFile.name;
                        '.bet'->(name.copy).append->betFile.name;
                        (if diagFile.entry.exists and
                        (currentDiagramName[] = none ) then
                            (if astFile.entry.exists then
                                (if betFile.entry.exists then
                                    (if
                                    (betFile.entry.modtime >
                                     diagFile.entry.modtime) and
                                    (betFile.entry.modtime >
                                     astFile.entry.modtime) then
                                        ('Open',
                                         '.bet file is newer. Open .bet file?')
                                          ->promptForBoolean->ok;
                                        (if ok = yes then
                                            (if currentDiagramName[] = none
                                             then
                                                name.copy->currentDiagramName[];
                                                '.diag'
                                                  ->currentDiagramName.append;
                                                
                                            if);
                                            (name,true)->openFragmentGroup
                                        if)
                                     else
                                        '.diag'->name.append;
                                        name
                                          ->checkAutoSaveFile
                                            (#
                                               error::< 
                                                 (# 
                                                 do
                                                    msg[]->alertUser;
                                                    leave thisOp
                                                 #);
                                               cancelled::< 
                                                 (#  do leave thisOp #)
                                            #)->didRecover;
                                        (if
                                        (name,didRecover,true)->checkDiagFile
                                         then
                                            name->openDiagram
                                        if)
                                    if)
                                 else
                                    '.diag'->name.append;
                                    name
                                      ->checkAutoSaveFile
                                        (#
                                           error::< 
                                             (# 
                                             do msg[]->alertUser; leave thisOp
                                             #);
                                           cancelled::< 
                                             (#  do leave thisOp #)
                                        #)->didRecover;
                                    (if (name,didRecover,true)->checkDiagFile
                                     then
                                        name->openDiagram
                                    if)
                                if);
                                (*  (if diagFile.entry.modtime > astFile.entry.modtime then
                                 (if betFile.entry.exists then
                                 (if betFile.entry.modtime > diagFile.entry.modtime
                                 then
                                 '.bet file is newer than .diag file.\nOpen .bet file?'
                                 ->DSUIGetUserYesOrNo->ok;
                                 (if ok then
                                 (if currentDiagramName[] = none then
                                 arg.copy->currentDiagramName[];
                                 '.diag'->currentDiagramName.append;
                                 
                                 if);
                                 arg->openFragmentGroup
                                 if)
                                 else
                                 '.diag'->arg.append;
                                 arg->checkAutoSaveFile->didRecover;
                                 (if (arg,didRecover,true)->checkDiagFile then
                                 arg->openDiagram
                                 if)
                                 if)
                                 else
                                 '.diag'->arg.append;
                                 arg->checkAutoSaveFile->didRecover;
                                 (if (arg,didRecover,true)->checkDiagFile then
                                 arg->openDiagram
                                 if)
                                 if)
                                 else
                                 '.ast file is newer than .diag file.\nOpen .ast file?'
                                 ->DSUIGetUserYesOrNo->ok;
                                 (if ok then
                                 (if currentDiagramName[] = none then
                                 arg.copy->currentDiagramName[];
                                 '.diag'->currentDiagramName.append;
                                 
                                 if);
                                 arg->openFragmentGroup
                                 if)
                                 if)*)
                                
                             else
                                (if betFile.entry.exists then
                                    'No '->help[];
                                    mps.astFileExtension->help.puttext;
                                    ' file exists for .diag file.\nOpen .bet file?'
                                      ->help.puttext;
                                    ('Open',help[])->promptForBoolean->ok;
                                    (if ok = yes then
                                        (if currentDiagramName[] = none then
                                            name.copy->currentDiagramName[];
                                            '.diag'->currentDiagramName.append;
                                            
                                        if);
                                        (name,true)->openFragmentGroup
                                    if)
                                 else
                                    '.diag'->name.append;
                                    name
                                      ->checkAutoSaveFile
                                        (#
                                           error::< 
                                             (# 
                                             do msg[]->alertUser; leave thisOp
                                             #);
                                           cancelled::< 
                                             (#  do leave thisOp #)
                                        #)->didRecover;
                                    (if (name,didRecover,true)->checkDiagFile
                                     then
                                        name->openDiagram
                                    if)
                                if)
                            if)
                         else
                            (if astFile.entry.exists or betFile.entry.exists
                             then
                                (if currentDiagramName[] = none then
                                    name.copy->currentDiagramName[];
                                    '.diag'->currentDiagramName.append;
                                    
                                if);
                                (name,true)->openFragmentGroup
                             else
                                'Please select a .bet, '->help[];
                                mps.astFileExtension->help.puttext;
                                ' or .diag file!'->help.puttext;
                                help[]->alertUser
                            if)
                        if)
                     else
                        'Please select a .bet, '->help[];
                        mps.astFileExtension->help.puttext;
                        ' or .diag file!'->help.puttext;
                        help[]->alertUser
                    if)
                if)
            if);
            
        if)
     #)  

-- openDiagram: Descriptor --
(#
   pages: [0] @Integer;
   thePage: ^theDocument.Page;
   theOADPage: ^theOADDocument.OADPage;
   theObject: ^thePage.DesignObject;
   theConnID,theNodeID: @integer;
   createdAssociationConns: @ObjectList;
   t: @text;
   theText: ^text;
   ok: @boolean;
   
do
   name[]->currentDiagramName[];
   'Loading '->puttext;
   name[]->putline;
   name->FileOpenDiagram;
   &OADDocument[]->theDocument[]->theOADDocument[];
   theDocument.onInit;
   theDocument.getPageList->pages;
   (if pages.range > 0 then
       (for i: pages.range repeat
         (pages[i],10)->theDocument.readTextUserData->theText[];
         (if theText[] <> none then
             (if true
              // 'Group Window'->theText.equal then
                 &theOADDocument.OADPage[]->theOADDocument.theGroupPage[]
                   ->thePage[]
              // 'WorkSheet'->theText.equal then
                 &theOADDocument.OADPage[]->theOADDocument.theWorkPage[]
                   ->thePage[]
              // 'Object Page'->theText.equal then
                 &theOADDocument.ObjectPage[]->theOADDocument.theObjectPage[]
                   ->thePage[]
              else
                 &theOADDocument.Page[]->thePage[]
             if)
          else
             &theOADDocument.Page[]->thePage[]
         if);
         pages[i]->thePage.onInit;
         thePage.onReadDiagram;
         
       for);
       (if (theOADDocument.theWorkPage[] <> none ) and
       (theOADDocument.theGroupPage[] <> none ) then
           theOADDocument.theWorkPage[]->theDocument.CurrentPage;
           theOADDocument.updateUserDataIDs;
           loop
             (#
                i: @integer;
                while::<  (#  do (i+2 <= IndexIDList.impl.range)->value #)
             do
                i+2->i;
                (if IndexIDList.impl[i] <> 0 then
                    (if userDataVerbose then
                        'IndexIDList: updating '->puttext;
                        indexidlist.impl[i]->putint
                    if);
                    IndexIDList.impl[i]->theOADDocument.UserDataIDMap.getID
                      ->IndexIDList.impl[i];
                    (if userDataVerbose then
                        ' to '->puttext; indexidlist.impl[i]->putint; newline
                    if)
                if)
             #);
           theOADDocument.theWorkPage.PatternDiagrams.theList.scan
             (# theListDiagram: ^theOADDocument.theWorkPage.ListDiagram
             do
                current.e[]->theListDiagram[];
                theListDiagram[]
                  ->theOADDocument.theWorkPage.PageCallBack.MakeLocalNodes;
                theListDiagram.titleNode.thePrefixConn.getID->theConnID;
                (if theConnID <> 0 then
                    theConnID->theOADDocument.theWorkPage.PageCallBack.MakeConn
                if)
             #);
           theOADDocument.theGroupPage.PatternDiagrams.theList.scan
             (# theListDiagram: ^theOADDocument.theGroupPage.ListDiagram
             do
                current.e[]->theListDiagram[];
                theListDiagram[]
                  ->theOADDocument.theGroupPage.PageCallBack.MakeLocalNodes
             #);
           theOADDocument.theWorkPage.PatternDiagrams.theList.scan
             (#
                theListDiagram: ^theOADDocument.theWorkPage.ListDiagram;
                thisOADDiagram: ^theOADDocument.theWorkPage.OADDiagram;
                thisFragmentDiagram:
                  ^theOADDocument.theWorkPage.FragmentDiagram;
                theDummyDesc: ^betaGram.ObjectDescriptor;
                thisPatternAttDiagram:
                  ^theOADDocument.theWorkPage.PatternAttDiagram;
                theDummyAST: ^MPS.AST
             do
                current.e[]->theListDiagram[];
                (if current.e## <= theOADDocument.theWorkPage.OADDiagram## then
                    current.e[]->thisOADDiagram[];
                    thisOADDiagram.titleNode.UDtheSurroundBox.getID->theNodeID;
                    (if theNodeID <> 0 then
                        (thisOADDiagram[],theNodeID)
                          ->
                            theOADDocument.theWorkPage.PageCallBack.
                              makeSurroundBox
                    if);
                    thisOADDiagram.titlenode.theText.get
                      ->thisOADDiagram.titleText;
                    (if thisOADDiagram.theDescriptor <> none then
                        thisOADDiagram.theDescriptor->theDummyDesc[];
                        theDummyDesc.index->current.index;
                        theDummyDesc.frag.fullname->current.frag[]
                    if);
                    (if thisOADDiagram## <=
                    theOADDocument.theWorkPage.PatternAttDiagram## then
                        thisOADDiagram[]->thisPatternAttDiagram[];
                        thisPatternAttDiagram.theAST->theDummyAST[];
                        theDummyAST.index->current.index;
                        theDummyAST.frag.fullname->current.frag[]
                    if);
                    thisOADDiagram.localNodes.scan
                      (#
                         theSimpleNode: ^thisOADDiagram.SimpleAttributeDecl;
                         theConnID: @integer
                      do
                         (if current## <= thisOADDiagram.SimpleAttributeDecl##
                          then
                             current[]->theSimpleNode[];
                             theSimpleNode.theAggregationConnector.getID
                               ->theConnID;
                             (if theConnID <> 0 then
                                 theConnID
                                   ->
                                     theOADDocument.theWorkPage.PageCallBack.
                                       MakeConn
                             if);
                             theSimpleNode.theAssociationConnector.getID
                               ->theConnID;
                             (if theConnID <> 0 then
                                 (if (theConnID->createdAssociationConns.find) =
                                 none then
                                     theConnID
                                       ->
                                         theOADDocument.theWorkPage.PageCallBack
                                         .makeConn;
                                     theSimpleNode.theAssociationConnector
                                       ->createdAssociationConns.insert
                                 if)
                             if)
                         if)
                      #);
                    
                if);
                (if current.e## <= theOADDocument.theWorkPage.FragmentDiagram##
                 then
                    current.e[]->thisFragmentDiagram[];
                    thisFragmentDiagram.titlenode.theText.get
                      ->thisFragmentDiagram.titleText
                if)
             #);
           theOADDocument.theGroupPage.PatternDiagrams.theList.scan
             (#
                theListDiagram: ^theOADDocument.theGroupPage.ListDiagram;
                thisOADDiagram: ^theOADDocument.theGroupPage.OADDiagram;
                thisFragmentDiagram:
                  ^theOADDocument.theGroupPage.FragmentDiagram;
                thePropertyDiagram:
                  ^theOADDocument.theGroupPage.PropertyDiagram;
                theDummyDesc: ^betaGram.ObjectDescriptor;
                thisPatternAttDiagram:
                  ^theOADDocument.theGroupPage.PatternAttDiagram;
                theDummyAST: ^MPS.AST;
                theNodeID: @integer
             do
                current.e[]->theListDiagram[];
                (if current.e## <= theOADDocument.theGroupPage.OADDiagram##
                 // true then
                    current.e[]->thisOADDiagram[];
                    thisOADDiagram.titlenode.theText.get
                      ->thisOADDiagram.titleText;
                    (if thisOADDiagram.theDescriptor <> none then
                        thisOADDiagram.theDescriptor->theDummyDesc[];
                        theDummyDesc.index->current.index;
                        theDummyDesc.frag.fullname->current.frag[]
                    if);
                    (if thisOADDiagram## <=
                    theOADDocument.theGroupPage.PatternAttDiagram## then
                        thisOADDiagram[]->thisPatternAttDiagram[];
                        thisPatternAttDiagram.theAST->theDummyAST[];
                        theDummyAST.index->current.index;
                        theDummyAST.frag.fullname->current.frag[]
                    if);
                    (if thisOADDiagram## <=
                    theOADDocument.theGroupPage.propertyDiagram## then
                        thisOADDiagram[]->thePropertyDiagram[];
                        thePropertyDiagram.titleNode.UDSurroundBox.getID
                          ->theNodeID;
                        (if theNodeID <> 0 then
                            (thePropertyDiagram[],theNodeID)
                              ->
                                theOADDocument.theGroupPage.pageCallback.
                                  makeSurroundBox
                        if)
                    if);
                    
                if);
                (if current.e## <= theOADDocument.theGroupPage.FragmentDiagram##
                 then
                    current.e[]->thisFragmentDiagram[];
                    thisFragmentDiagram.titlenode.theText.get
                      ->thisFragmentDiagram.titleText
                if)
             #)
        else
           'Either Group Page or Work Sheet was not found - quit immediatly to avoid further problems'
             ->alertUser
       if)
    else
       'The selected .diag file does not have the right file format!'->AlertUser
   if)
#)  

-- closeDiagram: Descriptor --
(#
   CheckMenu:
     (# theID: @Integer; theMenu: ^BasicMenu; 
     enter theID
     do
        theID->MenuBar.findMenu->theMenu[];
        (if theMenu[] <> none then
            theMenu[]->MenuBar.remove; (* theID->UI.DSMenuDeleteMenu*) 
        if);
        
     #);
   pages: ^ObjectList
do
   UserMenu1->CheckMenu;
   UserMenu2->CheckMenu;
   (* UserMenu3 is the fileMenu - do not remove! *)
   UserMenu4->CheckMenu;
   UserMenu5->CheckMenu;
   UserMenu6->CheckMenu;
   UserMenu7->CheckMenu;
   UserMenu8->CheckMenu;
   UserMenu9->CheckMenu;
   UserMenu10->CheckMenu;
   (*  UI.DSMenuShowMenuBar; *)
   theDocument.GetPages->pages[];
   (if pages[]
    // none then 
    else
       pages.scan
         (# dummy: ^theDocument.Page
         do
            current[]->dummy[];
            (if dummy[]
             // none then 'CloseItem: Page is node'->putline; 
             else
                dummy.close
            if);
            
         #);
       
   if);
   theDocument.close
#)  

-- SaveLists: Descriptor --
(#
   theListDiagram: ^theOADDocument.theWorkPage.ListDiagram;
   fd: ^theOADDocument.theGroupPage.FragmentDiagram;
   theReference: ^theListDiagram.titleNode.PatternDiagNodeReference;
   ok: @Boolean;
   listsize,last,showAttributesInteger,referencesInteger,specializationsInteger,
     associationsInteger,SimpleDeclDisplayInteger,x,y,w,h,l: @integer;
   fileName: @text;
   t: ^text
do
   theDocument[]->theOADDocument[];
   (theOADDocument.theWorkPage.ID,10,'WorkSheet')
     ->theDocument.writeTextUserData;
   (theOADDocument.theGroupPage.ID,10,'Group Window')
     ->theDocument.writeTextUserData;
   theOADDocument.theWorkPage.PatternDiagrams.theList.scan
     (# 
     do
        current.e[]->theListDiagram[];
        theOADDocument.localNodesUserDataStart+theListDiagram.localNodes.size
          ->theListDiagram.titleNode.OldLocalNodesUDAttributes;
        theListDiagram.titleNode.resetLocalNodesUD
     #);
   theOADDocument.theGroupPage.PatternDiagrams.theList.scan
     (# 
     do
        current.e[]->theListDiagram[];
        theOADDocument.localNodesUserDataStart+theListDiagram.localNodes.size
          ->theListDiagram.titleNode.OldLocalNodesUDAttributes;
        theListDiagram.titleNode.resetLocalNodesUD
     #);
   theOADDocument.theWorkPage.PatternDiagrams.theList.scan
     (# 
     do
        current.e[]->theListDiagram[];
        theListDiagram.localNodes.scan
          (# 
          do
             &theListDiagram.titleNode.PatternDiagNodeReference[]
               ->theReference[];
             theReference.InitLocalNode;
             current[]->theReference;
             
          #)
     #);
   theOADDocument.theGroupPage.PatternDiagrams.theList.scan
     (# 
     do
        current.e[]->theListDiagram[];
        theListDiagram.localNodes.scan
          (# 
          do
             &theListDiagram.titleNode.PatternDiagNodeReference[]
               ->theReference[];
             theReference.InitLocalNode;
             current[]->theReference;
             
          #)
     #);
   (theOADDocument.theGroupPage.ID,499)->theDocument.readIntegerUserData
     ->listSize;
   (if listSize > 0 then
       (for i: listsize repeat
         (theOADDocument.theGroupPage.ID,500+i)
           ->theOADDocument.deleteUserDataType
       for)
   if);
   IndexIDList.impl.range->listsize;
   (theOADDocument.theGroupPage.ID,499,listsize)
     ->theOADDocument.writeIntegerUserData;
   indexIDList.last->last;
   (theOADDocument.theGroupPage.ID,500,last)
     ->theOADDocument.writeIntegerUserData;
   (for i: listsize repeat
     (theOADDocument.theGroupPage.ID,500+i,IndexIDList.impl[i])
       ->theOADDocument.writeIntegerUserData
   for);
   theOADDocument.theWorkPage.patternDiagrams.AssociationList.save;
   theOADDocument.theWorkPage.patternDiagrams.InheritanceList.save;
   theOADDocument.theWorkPage.patternDiagrams.AggregationList.save;
   (theOADDocument.theWorkPage.ID,240,theOADDocument.theWorkPage.nextX)
     ->theOADDocument.writeIntegerUserData;
   (theOADDocument.theWorkPage.ID,241,theOADDocument.theWorkPage.nextY)
     ->theOADDocument.writeIntegerUserData;
   (theOADDocument.theWorkPage.ID,250,
    theOADDocument.theWorkPage.patternDiagrams.NextFreeLine)
     ->theOADDocument.writeIntegerUserData;
   (theOADDocument.theWorkPage.ID,251,
    theOADDocument.theWorkPage.patternDiagrams.NextFreeColumn)
     ->theOADDocument.writeIntegerUserData;
   (theOADDocument.theWorkPage.ID,252,
    theOADDocument.theWorkPage.patternDiagrams.SecondFreeLine)
     ->theOADDocument.writeIntegerUserData;
   (theOADDocument.theWorkPage.ID,253,
    theOADDocument.theWorkPage.patternDiagrams.SecondFreeColumn)
     ->theOADDocument.writeIntegerUserData;
   (theOADDocument.theGroupPage.ID,240,theOADDocument.theGroupPage.nextX)
     ->theOADDocument.writeIntegerUserData;
   (theOADDocument.theGroupPage.ID,241,theOADDocument.theGroupPage.nextY)
     ->theOADDocument.writeIntegerUserData;
   (theOADDocument.theGroupPage.ID,250,
    theOADDocument.theGroupPage.patternDiagrams.NextFreeLine)
     ->theOADDocument.writeIntegerUserData;
   (theOADDocument.theGroupPage.ID,251,
    theOADDocument.theGroupPage.patternDiagrams.NextFreeColumn)
     ->theOADDocument.writeIntegerUserData;
   (theOADDocument.theGroupPage.ID,252,
    theOADDocument.theGroupPage.patternDiagrams.SecondFreeLine)
     ->theOADDocument.writeIntegerUserData;
   (theOADDocument.theGroupPage.ID,253,
    theOADDocument.theGroupPage.patternDiagrams.SecondFreeColumn)
     ->theOADDocument.writeIntegerUserData;
   (if theOADDocument.gppProp.showAttributes then
       1->showAttributesInteger
    else
       0->showAttributesInteger
   if);
   (theOADDocument.theGroupPage.ID,260,showAttributesInteger)
     ->theOADDocument.writeIntegerUserData;
   (if theOADDocument.gppProp.references then
       1->referencesInteger
    else
       0->referencesInteger
   if);
   (theOADDocument.theGroupPage.ID,261,referencesInteger)
     ->theOADDocument.writeIntegerUserData;
   (if theOADDocument.gppProp.specializations then
       1->specializationsInteger
    else
       0->specializationsInteger
   if);
   (theOADDocument.theGroupPage.ID,262,specializationsInteger)
     ->theOADDocument.writeIntegerUserData;
   (if theOADDocument.gppProp.associations then
       1->associationsInteger
    else
       0->associationsInteger
   if);
   (theOADDocument.theGroupPage.ID,263,associationsInteger)
     ->theOADDocument.writeIntegerUserData;
   theOADDocument.gppProp.SimpleDeclDisplay->SimpleDeclDisplayInteger;
   (theOADDocument.theGroupPage.ID,264,SimpleDeclDisplayInteger)
     ->theOADDocument.writeIntegerUserData
#)  

-- topDotOpen: Descriptor --
(#
   index: @integer;
   formname,groupname: ^text;
   t,mess: @text;
   fg: ^mps.fragmentgroup
do
   '-'->fullname.findAll (#  do inx->index;  #);
   (if index > 0 then (index+1,fullname.length)->fullname.sub->formname[] if);
   (if (formname[] = none ) or (formname.empty) then
       thisOperation:
       (fullname[],t[])
         ->mps.top.open
           (#
              astOverflow::< 
                (# 
                do
                   none ->f[];
                   none ->mps.theCatcher[];
                   'AST overflow for '->mess;
                   fullname[]->mess.puttext;
                   mess[]->AlertUser;
                   leave thisOperation
                #);
              fragmentNotExisting::< 
                (# t: ^text
                do
                   none ->f[];
                   none ->mps.theCatcher[];
                   'Fragment file does not exist '->mess;
                   fullname[]->mess.puttext;
                   mess[]->AlertUser;
                   leave thisOperation
                #);
              grammarNotFound::< 
                (# 
                do
                   none ->f[];
                   none ->mps.theCatcher[];
                   'Grammar was not found'->mess;
                   mess[]->AlertUser;
                   leave thisOperation
                #);
              badFormat::< 
                (# 
                do
                   none ->f[];
                   none ->mps.theCatcher[];
                   'Bad format: '->mess;
                   fullname[]->mess.puttext;
                   mess[]->AlertUser;
                   leave thisOperation
                #);
              fatalParseError::< 
                (# 
                do
                   none ->f[];
                   none ->mps.theCatcher[];
                   'Fatal parse error: '->mess;
                   errNo->mess.putInt;
                   ' for '->mess.puttext;
                   fullname[]->mess.puttext;
                   mess[]->AlertUser;
                   leave thisOperation
                #);
              doubleFormDeclaration::< 
                (# 
                do
                   none ->f[];
                   none ->mps.theCatcher[];
                   'Double form declaration in '->mess;
                   fullname[]->mess.puttext;
                   mess[]->AlertUser;
                   leave thisOperation
                #);
              readAccessError::< 
                (# 
                do
                   none ->f[];
                   none ->mps.theCatcher[];
                   'No read access to '->mess;
                   fullname[]->mess.puttext;
                   mess[]->AlertUser;
                   leave thisOperation
                #);
              EOSError::< 
                (# 
                do
                   none ->f[];
                   none ->mps.theCatcher[];
                   'End Of Stream error in '->mess;
                   fullname[]->mess.puttext;
                   mess[]->AlertUser;
                   leave thisOperation
                #);
              noSuchFileError::< 
                (# 
                do
                   none ->f[];
                   none ->mps.theCatcher[];
                   'No such file: '->mess;
                   fullname[]->mess.puttext;
                   mess[]->AlertUser;
                   leave thisOperation
                #);
              fileExistsError::< 
                (# 
                do
                   none ->f[];
                   none ->mps.theCatcher[];
                   'File exists error'->mess;
                   mess[]->AlertUser;
                   leave thisOperation
                #);
              noSpaceLeftError::< 
                (# 
                do
                   none ->f[];
                   none ->mps.theCatcher[];
                   'No space left on device'->mess;
                   mess[]->AlertUser;
                   leave thisOperation
                #);
              otherFileError::< 
                (# 
                do
                   none ->f[];
                   none ->mps.theCatcher[];
                   'File error for: '->mess;
                   fullname[]->mess.puttext;
                   mess[]->AlertUser;
                   leave thisOperation
                #);
              WriteAccessOnLstFileError::< 
                (# 
                do
                   none ->f[];
                   none ->mps.theCatcher[];
                   'Access error on .lst file for '->mess;
                   fullname[]->mess.puttext;
                   mess[]->AlertUser;
                   leave thisOperation
                   (*'Access error on .lst file'->myException*)
                #);
              writeAccessError::< 
                (# 
                do
                   none ->f[];
                   none ->mps.theCatcher[];
                   'No write access'->mess;
                   mess[]->AlertUser;
                   leave thisOperation
                   (*'Write access error'->myException
                    * *)
                #);
              startingParsing::< 
                (# 
                do
                   'Parsing '->mess;
                   fullname[]->mess.putText;
                   mess[]->alertUser;
                   
                #);
              ParseErrors::< 
                (# 
                do
                   none ->f[];
                   none ->mps.theCatcher[];
                   mess[]->AlertUser;
                   leave thisOperation
                #)
           #)->f[]
    else
       (1,index-1)->fullname.sub->groupname[];
       (if not groupname.empty then
           thisOperation:
           (groupname[],t[])
             ->mps.top.open
               (#
                  astOverflow::< 
                    (# 
                    do
                       none ->f[];
                       none ->mps.theCatcher[];
                       'AST overflow for '->mess;
                       groupname[]->mess.puttext;
                       mess[]->AlertUser;
                       leave thisOperation
                    #);
                  fragmentNotExisting::< 
                    (# t: ^text
                    do
                       none ->f[];
                       none ->mps.theCatcher[];
                       'Fragment file does not exist '->mess;
                       groupname[]->mess.puttext;
                       mess[]->AlertUser;
                       leave thisOperation
                    #);
                  grammarNotFound::< 
                    (# 
                    do
                       none ->f[];
                       none ->mps.theCatcher[];
                       'Grammar was not found'->mess;
                       mess[]->AlertUser;
                       leave thisOperation
                    #);
                  badFormat::< 
                    (# 
                    do
                       none ->f[];
                       none ->mps.theCatcher[];
                       'Bad format: '->mess;
                       groupname[]->mess.puttext;
                       mess[]->AlertUser;
                       leave thisOperation
                    #);
                  fatalParseError::< 
                    (# 
                    do
                       none ->f[];
                       none ->mps.theCatcher[];
                       'Fatal parse error: '->mess;
                       errNo->mess.putInt;
                       ' for '->mess.puttext;
                       groupname[]->mess.puttext;
                       mess[]->AlertUser;
                       leave thisOperation
                    #);
                  doubleFormDeclaration::< 
                    (# 
                    do
                       none ->f[];
                       none ->mps.theCatcher[];
                       'Double form declaration in '->mess;
                       groupname[]->mess.puttext;
                       mess[]->AlertUser;
                       leave thisOperation
                    #);
                  readAccessError::< 
                    (# 
                    do
                       none ->f[];
                       none ->mps.theCatcher[];
                       'No read access to '->mess;
                       groupname[]->mess.puttext;
                       mess[]->AlertUser;
                       leave thisOperation
                    #);
                  EOSError::< 
                    (# 
                    do
                       none ->f[];
                       none ->mps.theCatcher[];
                       'End Of Stream error in '->mess;
                       groupname[]->mess.puttext;
                       mess[]->AlertUser;
                       leave thisOperation
                    #);
                  noSuchFileError::< 
                    (# 
                    do
                       none ->f[];
                       none ->mps.theCatcher[];
                       'No such file: '->mess;
                       groupname[]->mess.puttext;
                       mess[]->AlertUser;
                       leave thisOperation
                    #);
                  fileExistsError::< 
                    (# 
                    do
                       none ->f[];
                       none ->mps.theCatcher[];
                       'File exists error'->mess;
                       mess[]->AlertUser;
                       leave thisOperation
                    #);
                  noSpaceLeftError::< 
                    (# 
                    do
                       none ->f[];
                       none ->mps.theCatcher[];
                       'No space left on device'->mess;
                       mess[]->AlertUser;
                       leave thisOperation
                    #);
                  otherFileError::< 
                    (# 
                    do
                       none ->f[];
                       none ->mps.theCatcher[];
                       'File error for: '->mess;
                       groupname[]->mess.puttext;
                       mess[]->AlertUser;
                       leave thisOperation
                    #);
                  WriteAccessOnLstFileError::< 
                    (# 
                    do
                       none ->f[];
                       none ->mps.theCatcher[];
                       'Access error on .lst file for '->mess;
                       groupname[]->mess.puttext;
                       mess[]->AlertUser;
                       leave thisOperation
                       (*'Access error on .lst file'->myException*)
                    #);
                  writeAccessError::< 
                    (# 
                    do
                       none ->f[];
                       none ->mps.theCatcher[];
                       'No write access'->mess;
                       mess[]->AlertUser;
                       leave thisOperation
                       (*'Write access error'->myException
                        * *)
                    #);
                  startingParsing::< 
                    (# 
                    do
                       'Parsing '->mess;
                       groupname[]->mess.putText;
                       mess[]->alertUser;
                       
                    #);
                  ParseErrors::< 
                    (# 
                    do
                       none ->f[];
                       none ->mps.theCatcher[];
                       mess[]->AlertUser;
                       leave thisOperation
                    #)
               #)->fg[];
           (if fg[] <> none then
               thisOperation:
               (formname[],t[])
                 ->fg.open
                   (#
                      astOverflow::< 
                        (# 
                        do
                           none ->f[];
                           none ->mps.theCatcher[];
                           'AST overflow for '->mess;
                           formname[]->mess.puttext;
                           mess[]->AlertUser;
                           leave thisOperation
                        #);
                      fragmentNotExisting::< 
                        (# t: ^text
                        do
                           none ->f[];
                           none ->mps.theCatcher[];
                           'Fragment file does not exist '->mess;
                           formname[]->mess.puttext;
                           mess[]->AlertUser;
                           leave thisOperation
                        #);
                      grammarNotFound::< 
                        (# 
                        do
                           none ->f[];
                           none ->mps.theCatcher[];
                           'Grammar was not found'->mess;
                           mess[]->AlertUser;
                           leave thisOperation
                        #);
                      badFormat::< 
                        (# 
                        do
                           none ->f[];
                           none ->mps.theCatcher[];
                           'Bad format: '->mess;
                           formname[]->mess.puttext;
                           mess[]->AlertUser;
                           leave thisOperation
                        #);
                      fatalParseError::< 
                        (# 
                        do
                           none ->f[];
                           none ->mps.theCatcher[];
                           'Fatal parse error: '->mess;
                           errNo->mess.putInt;
                           ' for '->mess.puttext;
                           formname[]->mess.puttext;
                           mess[]->AlertUser;
                           leave thisOperation
                        #);
                      doubleFormDeclaration::< 
                        (# 
                        do
                           none ->f[];
                           none ->mps.theCatcher[];
                           'Double form declaration in '->mess;
                           formname[]->mess.puttext;
                           mess[]->AlertUser;
                           leave thisOperation
                        #);
                      readAccessError::< 
                        (# 
                        do
                           none ->f[];
                           none ->mps.theCatcher[];
                           'No read access to '->mess;
                           formname[]->mess.puttext;
                           mess[]->AlertUser;
                           leave thisOperation
                        #);
                      EOSError::< 
                        (# 
                        do
                           none ->f[];
                           none ->mps.theCatcher[];
                           'End Of Stream error in '->mess;
                           formname[]->mess.puttext;
                           mess[]->AlertUser;
                           leave thisOperation
                        #);
                      noSuchFileError::< 
                        (# 
                        do
                           none ->f[];
                           none ->mps.theCatcher[];
                           'No such file: '->mess;
                           formname[]->mess.puttext;
                           mess[]->AlertUser;
                           leave thisOperation
                        #);
                      fileExistsError::< 
                        (# 
                        do
                           none ->f[];
                           none ->mps.theCatcher[];
                           'File exists error'->mess;
                           mess[]->AlertUser;
                           leave thisOperation
                        #);
                      noSpaceLeftError::< 
                        (# 
                        do
                           none ->f[];
                           none ->mps.theCatcher[];
                           'No space left on device'->mess;
                           mess[]->AlertUser;
                           leave thisOperation
                        #);
                      otherFileError::< 
                        (# 
                        do
                           none ->f[];
                           none ->mps.theCatcher[];
                           'File error for: '->mess;
                           formname[]->mess.puttext;
                           mess[]->AlertUser;
                           leave thisOperation
                        #);
                      WriteAccessOnLstFileError::< 
                        (# 
                        do
                           none ->f[];
                           none ->mps.theCatcher[];
                           'Access error on .lst file for '->mess;
                           formname[]->mess.puttext;
                           mess[]->AlertUser;
                           leave thisOperation
                           (*'Access error on .lst file'->myException*)
                        #);
                      writeAccessError::< 
                        (# 
                        do
                           none ->f[];
                           none ->mps.theCatcher[];
                           'No write access'->mess;
                           mess[]->AlertUser;
                           leave thisOperation
                           (*'Write access error'->myException
                            * *)
                        #);
                      startingParsing::< 
                        (# 
                        do
                           'Parsing '->mess;
                           formname[]->mess.putText;
                           mess[]->alertUser;
                           
                        #);
                      ParseErrors::< 
                        (# 
                        do
                           none ->f[];
                           none ->mps.theCatcher[];
                           mess[]->AlertUser;
                           leave thisOperation
                        #)
                   #)->f[]
            else
               'topDotOpen: Could not open group: '->puttext;
               groupname[]->putline
           if)
        else
           'topDotOpen: Groupname is empty!?'->putline
       if)
   if)
#)  

-- getExtension: Descriptor --
(# index: @Integer; isPath: @boolean; 
do
   '.'->name.findAll (#  do inx->index;  #);
   (if index <= 1 then
       ''->extension[]
    else
       (index,name.length)->name.sub->extension[];
       '/'->extension.findAll (#  do true->isPath #);
       (if isPath then ''->extension[] if)
   if);
   
#)  

-- removeExtension: Descriptor --
(# rest: ^Text; index: @Integer; 
do
   '.'->name.findAll (#  do inx->index;  #);
   (if index > 0 then
       (index,name.length)->name.sub->rest[]; (index,name.length)->name.delete
   if);
   
#)  

-- doStartup: Descriptor --
(#
   arg: ^Text;
   swt: @Text;
   SwitchMode: @Boolean;
   N: @Integer;
   ext: ^Text;
   help: @text;
   didRecover,ok: @boolean;
   diagFile,astFile,betFile: @file;
   
do
   (if NoOfArguments > 1
    // true then
       (for i: NoOfArguments-1 repeat
         i+1->Arguments->arg[];
         0->arg.setpos;
         getSwitch:
         (if SwitchMode
          // true then
             arg.getint->N;
             (if True
              // (0 < N) and (N <= switch.range) then
                 True->Switch[N]; 
              // N = 0 then
                 false->SwitchMode; 
             if)
          else
             (if arg.peek
              // '-' then
                 arg.get;
                 (if arg.peek
                  // 'd' // 'D' then
                     arg.get; (for i: 100 repeat true->switch[i] for); 
                  // 's' // 'S' then
                     arg.get; true->SwitchMode; swt.clear; restart getSwitch; 
                  // 'u' // 'U' then
                     arg.get; true->userdataVerbose
                  // 'v' // 'V' then
                     true->verbose
                 if);
                 
              else
                 arg[]->openFile
             if)
         if)
       for)
   if)
#)  

-- isChecked: DoPart --
do
   'doneCheck'
     ->fg.prop.getProp
       (#
          doprop::<  (#  do (if getConst // 0 then  else true->b if) #)
       #);
     

-- GetGroupName: Descriptor --
(* ask user for a group name *)
  (# name: @Text; ext,help: ^text; 
  do
     fileDialog->name;
     (if name.length > 0
      // true then
         name->getExtension->ext[];
         (if ('.bet'->ext.equal) or (mps.astFileExtension->ext.equal) then
             name->removeExtension->name;
             (if switch[17] then 'Opening: '->puttext; name[]->putline;  if);
             (name,true)->openFragmentGroup
          else
             'You must select a .bet or '->help[];
             mps.astFileExtension->help.puttext;
             ' file!'->help.puttext;
             help[]->AlertUser
         if);
         
     if);
     
  #)  

-- OpenFragmentGroup: Descriptor --
(#
   myDocument: ^OADDocument;
   opened: @boolean;
   propd: ^myDocument.theGroupPage.PropertyDiagram;
   fragd: ^myDocument.theGroupPage.FragmentDiagram;
   mess: @Text;
   FragmentDoesNotExistText,diagFileName,frejaFileName,autoSaveFileExtension,
     tildeFileExtension,help: ^text;
   NoOfForms: @Integer;
   groupFile,autosaveGroupFile,tildeGroupFile,autoSaveFrejaFile: @file;
   doNotOpenAstFile: @boolean;
   ok: @integer;
   
do
   (if switch[17]
    // true then
       'Opening: '->mess.puttext;
       name[]->mess.puttext;
       mess[]
         ->putLine
         (*
          * mess->statusbar.set; 
          *)
   if);
   mps.astFileExtension->(name.copy).append->groupFile.name;
   (mps.astFileExtension).copy->autoSaveFileExtension[];
   '#'->autoSaveFileExtension.puttext;
   autoSaveFileExtension[]->(name.copy).append->autosaveGroupFile.name;
   (mps.astFileExtension).copy->tildeFileExtension[];
   '~'->tildeFileExtension.puttext;
   tildeFileExtension[]->(name.copy).append->tildeGroupFile.name;
   '.freja'->(name.copy).append->frejaFileName[];
   '.freja#'->(name.copy).append->autoSaveFrejaFile.name;
   (if switch[17] then
       'Freja OpenFragmentGroup: '->putLine;
       groupFile.name->putLine;
       autosaveGroupFile.name->putLine;
       tildeGroupFile.name->putLine
   if);
   thisOp:
     (# 
     do
        (if checkAutoSave then
            (if autosaveGroupFile.entry.exists and groupFile.entry.exists then
                (if autosaveGroupFile.entry.modtime > groupFile.entry.modtime
                 then
                    (if currentDiagramName[] = none then
                        (if autoSaveFrejaFile.entry.exists then
                            (if autosaveFrejaFile.entry.modtime >
                            groupFile.entry.modtime then
                                ('Open','Autosave file is newer, recover?')
                                  ->promptForBoolean->ok;
                                (if ok
                                 // yes then
                                    'mv .freja# .freja'->putLine;
                                    FrejaFileName[]
                                      ->autoSaveFrejaFile.entry.rename
                                        (#
                                           error::< 
                                             (# 
                                             do
                                                'Could not move '->msg;
                                                FrejaFileName[]->msg.puttext;
                                                '# into '->msg.puttext;
                                                FrejaFileName[]->msg.puttext;
                                                leave thisOp
                                             #)
                                        #);
                                    '.diag'->(name.copy).append->diagFileName[];
                                    diagFileName
                                      ->recoverDiagFile
                                        (#
                                           error::< 
                                             (# 
                                             do msg[]->alertUser; leave thisOp
                                             #)
                                        #);
                                    (if
                                    (diagFileName,true,false)->checkDiagFile
                                     then
                                        diagFileName->openDiagram;
                                        true->doNotOpenAstFile
                                     else
                                        groupFile.name
                                          ->autoSaveGroupFile.entry.rename
                                            (#
                                               error::< 
                                                 (# 
                                                 do
                                                    'Could not move '->msg;
                                                    groupFile.name->msg.puttext;
                                                    '# into '->msg.puttext;
                                                    groupFile.name->msg.puttext;
                                                    leave thisOp
                                                 #)
                                            #)
                                    if)
                                 // no then
                                    
                                 // cancel then
                                    leave thisOp
                                if)
                             else
                                'Autosave '->help[];
                                mps.astFileExtension->help.puttext;
                                ' file is newer, recover?'->help.puttext;
                                ('Open',help[])->promptForBoolean->ok;
                                (if ok
                                 // yes then
                                    groupFile.name
                                      ->autoSaveGroupFile.entry.rename
                                        (#
                                           error::< 
                                             (# 
                                             do
                                                'Could not move '->msg;
                                                groupFile.name->msg.puttext;
                                                '# into '->msg.puttext;
                                                groupFile.name->msg.puttext;
                                                leave thisOp
                                             #)
                                        #)
                                 // no then
                                    
                                 // cancel then
                                    leave thisOp
                                if)
                            if)
                         else
                            'Autosave '->help[];
                            mps.astFileExtension->help.puttext;
                            ' file is newer, recover?'->help.puttext;
                            ('Open',help[])->promptForBoolean->ok;
                            (if ok
                             // yes then
                                groupFile.name
                                  ->autoSaveGroupFile.entry.rename
                                    (#
                                       error::< 
                                         (# 
                                         do
                                            'Could not move '->msg;
                                            groupFile.name->msg.puttext;
                                            '# into '->msg.puttext;
                                            groupFile.name->msg.puttext;
                                            leave thisOp
                                         #)
                                    #)
                             // no then
                                
                             // cancel then
                                leave thisOp
                            if)
                        if)
                     else
                        'Autosave '->help[];
                        mps.astFileExtension->help.puttext;
                        ' file is newer, recover?'->help.puttext;
                        ('Open',help[])->promptForBoolean->ok;
                        (if ok
                         // yes then
                            groupFile.name
                              ->autoSaveGroupFile.entry.rename
                                (#
                                   error::< 
                                     (# 
                                     do
                                        'Could not move '->msg;
                                        groupFile.name->msg.puttext;
                                        '# into '->msg.puttext;
                                        groupFile.name->msg.puttext;
                                        leave thisOp
                                     #)
                                #)
                         // no then
                            
                         // cancel then
                            leave thisOp
                        if)
                    if)
                if)
            if)
        if);
        (if not doNotOpenAstFile then
            name[]->mps.ExpandToFullPath->topDotOpen->fg[];
            (if fg[]
             // none then
                'Cannot open fragmentgroup: '->mess;
                name[]->mess.puttext;
                (if FragmentDoesNotExistText[] <> none then
                    mess.newline; FragmentDoesNotExistText[]->mess.puttext
                if);
                mess[]->screen.putline;
                
             else
                fg.fragmentlist.scan
                  (# 
                  do
                     (if current.type
                      // mps.formtype then noofforms+1->noofforms
                     if)
                  #);
                (if (* fg[] -> isChecked//false *) true
                 // false then
                    'FragmentGroup '''->puttext;
                    name[]->puttext;
                    ''' not checked.'->putline;
                    'Must be checked by compiler before it can be shown...'
                      ->putline;
                    
                 else
                    (if theDocument[]
                     // none then
                        systemtime->UniqueDiagramID;
                        fg[]->sifSetFrejaMark;
                        &OADDocument[]->myDocument[];
                        myDocument.new;
                        (if NoOfForms
                         // 1 then
                            myDocument.CurrentPage->myDocument.theWorkPage[];
                            'WorkSheet'->myDocument.theWorkPage.PageTitle;
                            &myDocument.OADPage[]->myDocument.theGroupPage[];
                            myDocument.theGroupPage.InvisibleNew;
                            myDocument.theWorkPage[]->myDocument.CurrentPage;
                            
                         else
                            myDocument.CurrentPage->myDocument.theGroupPage[];
                            myDocument[]->theDocument[]->theOADDocument[];
                            &myDocument.OADPage[]->myDocument.theWorkPage[];
                            myDocument.theWorkPage.InvisibleNew;
                            'WorkSheet'->myDocument.theWorkPage.PageTitle;
                            
                        if);
                        'Group Window'->myDocument.theGroupPage.PageTitle;
                        
                     else
                        theDocument[]->myDocument[];
                        (if NoOfForms
                         // 1 then 
                         else
                            myDocument.theGroupPage.visible; 
                        if);
                        
                    if);
                    scanner:
                    myDocument.theGroupPage.PatternDiagrams.theList.
                      scanPropertyDiagrams
                      (# 
                      do
                         (if fg.name->(thisDiagram.fullname).equal
                          // true then true->opened; leave scanner; 
                         if);
                         
                      #);
                    (if opened
                     // true then
                     (* fragment already shown: just show the page *)
                        myDocument.theGroupPage[]->myDocument.CurrentPage; 
                     else
                        (if switch[17]
                         // true then
                            'Scanning Properties'->putLine (*statusbar.set; *)
                        if);
                        &myDocument.theGroupPage.PropertyDiagram[]->propd[];
                        (fg[],true,name[]->mps.ExpandToFullPath)->propd.new;
                        &myDocument.theGroupPage.FragmentDiagram[]->fragd[];
                        (if switch[17]
                         // true then
                            'Scanning Fragments'->putLine (*statusbar.set; *)
                        if);
                        fg[]->fragd.new;
                        
                    if);
                    (if NoOfForms
                     // 1 then
                        myDocument.theGroupPage.FragmentDiagram##
                          ->myDocument.theGroupPage.ScanDiagrams
                            (# 
                            do
                               current[]->fragd[];
                               (if fg[]
                                // fragd.theGroup then
                                (* find formname in the diagram *)
                                   fragd.localnodes.scan
                                     (#  do current.detail #)
                               if)
                            #)
                    if);
                    
                if)
            if)
        if)
     #)
#)  

-- OpenFragmentForm: Descriptor --
(#
   index: @Integer;
   groupname,formname: ^Text;
   fg: ^mps.fragmentgroup;
   theDoc: ^OADDocument;
   theDiagram: ^theDoc.theGroupPage.FragmentDiagram;
   noOfForms: @integer;
   
do (* first open the group, and then open the form *)
   '-'->name.findAll (#  do inx->index;  #);
   (1,index-1)->name.sub->groupname[];
   (groupname,checkAutoSave)->openFragmentGroup->fg[];
   (index+1,name.length)->name.sub->formname[];
   fg.fragmentlist.scan
     (# 
     do
        (if current.type
         // mps.formtype then
            noofforms+1->noofforms;
            (if (current.f.name->formName.equal)
             // true then current.f[]->ff[]
            if)
        if)
     #);
   theDocument[]->theDoc[];
   theDoc.theGroupPage.FragmentDiagram##
     ->theDoc.TheGroupPage.ScanDiagrams
       (# 
       do
          current[]->theDiagram[];
          theDiagram.fullname->screen.putline;
          (if fg[]
           // theDiagram.theGroup then (* find formname in the diagram *)
              theDiagram.localnodes.scan
                (# t: ^text; 
                do
                   &Text[]->t[];
                   current.theText.get->t;
                   ':'->t.findAll (#  do inx->index #);
                   (1,index-1)->t.sub->t[];
                   se[]->current.theSifEditor;
                   (if (formname[]->t.equal) and (noOfForms > 1)
                    // true then
                    (* if noOfForms = 1 the form has already been opened 
                     * by openFragmentGroup
                     *)
                       current.detail; 
                   if)
                #)
          if)
       #)
#)  

-- autosave: Descriptor --
(# filename,filename2: @Text; pages: [0] @Integer
do
   theDocument[]->theOADDocument[];
   (if theOADDocument.gppProp.globalInteractiveMode =
   theOADDocument.gppProp.noGlobalInteractiveMode then
       theDocument.getPageList->pages;
       (if pages.range > 0 then
           sifAutoSave;
           (if currentDiagramName[] <> none then
               currentDiagramName->removeExtension->fileName;
               '.freja#'->fileName.Append;
               (if switch[17] then
                   'Freja autosave:'->putLine; filename[]->putLine; 
               if);
               
            else
               'No currentDiagramName?'->putline
           if);
           SaveLists;
           (if currentDiagramName[] <> none then
               filename2.clear;
               currentDiagramName[]->filename2.puttext;
               '#'->filename2.append;
               (if switch[17] then
                   'Freja autosave:'->putLine; filename2[]->putLine; 
               if);
               (filename2[],pages)->fileSavePagesAsDiagram
            else
               'Autosave: No current diagram??'->putline
           if)
        else
           'Warning: Could not get pages in document - no autosave was done!'
             ->alertuser;
           'Warning: Could not get pages in document - no autosave was done!'
             ->stdErr.putline
       if)
   if)
#)  

-- checkAutoSaveFile: Descriptor --
(#
   frejaFile,autosaveFrejaFile,diagFile,autosaveDiagFile: @file;
   groupFile,autosaveGroupFile: @file;
   doRecover,doNotRecover: @boolean;
   ok: @integer;
   groupName,frejaFileName,autosaveFrejaFileName,diagFileName,help: ^text
do
   name[]->diagFileName[]->diagFile.name;
   '#'->(name.copy).append->autosaveDiagFile.name;
   name.copy->groupName[];
   groupName->removeExtension->groupName;
   '.freja'->(groupName.copy).append->frejaFileName[]->frejafile.name;
   '.freja#'->(groupName.copy).append->autoSaveFrejaFileName[]
     ->autosavefrejafile.name;
   (if switch[17] then
       'Freja checkAutoSaveFile:'->putLine;
       diagFile.name->putLine;
       autosaveDiagFile.name->putLine;
       frejaFile.name->putLine;
       autosaveFrejaFile.name->putLine;
       
   if);
   thisOp:
     (# 
     do
        (if autosaveFrejaFile.entry.exists then
            (if FrejaFile.entry.exists then
                (if autosaveFrejaFile.entry.modtime > FrejaFile.entry.modtime
                 then
                    ('Open','Autosave file is newer, recover?')
                      ->promptForBoolean->ok;
                    (if ok
                     // yes then
                        'mv .freja# .freja'->putLine;
                        FrejaFile.name
                          ->autoSaveFrejaFile.entry.rename
                            (#
                               error::< 
                                 (# 
                                 do
                                    'Could not move '->msg;
                                    FrejaFile.name->msg.puttext;
                                    '# into '->msg.puttext;
                                    FrejaFile.name->msg.puttext;
                                    msg->THIS(checkAutoSaveFile).error;
                                    leave thisOp
                                 #)
                            #);
                        true->doRecover
                     // no then
                        'rm .freja#'->putLine;
                        autosaveFrejaFile.delete;
                        true
                          ->doNotRecover
                          (* else
                           '.freja~ does not exist!!'->putLine
                           if);*)
                     // cancel then
                        cancelled; leave thisOp
                    if)
                if)
             else
                'no .freja file?!'->putLine;
                ('Open','No .diag file, recover from Autosave file?')
                  ->promptForBoolean->ok;
                (if ok
                 // yes then
                    'mv .freja# .freja'->putLine;
                    FrejaFile.name
                      ->autoSaveFrejaFile.entry.rename
                        (#
                           error::< 
                             (# 
                             do
                                'Could not move '->msg;
                                FrejaFile.name->msg.puttext;
                                '# into '->msg.puttext;
                                FrejaFile.name->msg.puttext;
                                msg->THIS(checkAutoSaveFile).error;
                                leave thisOp
                             #)
                        #);
                    true->doRecover
                 // no then
                    
                 // cancel then
                    cancelled; leave thisOp
                if)
            if);
            
         else
            (if switch[17] then 'no .freja# file'->putLine if)
        if);
        (if doRecover then
            name
              ->recoverDiagFile
                (#
                   error::< 
                     (# 
                     do msg->THIS(checkAutoSaveFile).error; leave thisOp
                     #)
                #);
            true->didRecover;
            
         else
            (if doNotRecover then
                (if autosaveDiagFile.entry.exists and diagFile.entry.exists then
                    (if autosaveDiagFile.entry.modtime > diagFile.entry.modtime
                     then
                        'rm .diag#'->putLine; autosaveDiagFile.delete
                     else
                        'autosaveDiagFile.entry.modtime IS NOT > diagFile.entry.modtime'
                          ->putLine;
                        
                    if);
                    frejaFileName
                      ->scanAstFiles
                        (# 
                        do
                           currentGroupName->groupName;
                           mps.astFileExtension->groupName.append;
                           groupName[]->groupFile.name;
                           '#'->(groupName.copy).append->autosaveGroupFile.name;
                           (if switch[17] then
                               groupFile.name->putLine;
                               autosaveGroupFile.name->putLine;
                               (* tildeGroupFile.name->putLine*)
                               
                           if);
                           (if groupFile.entry.exists then
                           (* no not anymore 
                            (if tildeGroupFile.entry.exists then
                            (if switch[17] then
                            tildeGroupFile.name->putText;
                            ': '->putText;
                            tildeGroupFile.entry.modtime->putInt;
                            newLine
                            if);
                            'mv .ast~ .ast'->putLine;
                            groupFile.name
                            ->tildeGroupFile.entry.rename
                            
                            if);
                            *)
                               (if autoSaveGroupFile.entry.exists then
                                   'rm .ast#'->putLine; autosaveGroupFile.delete
                               if)
                           if)
                        #)
                if)
            if)
        if)
     #)
#)  

-- revert: Descriptor --
(#
   ok: @integer;
   frejaFile,autosaveFrejaFile,tildeFrejaFile,diagFile,autosaveDiagFile,
     tildeDiagFile: @file;
   groupFile,autosaveGroupFile,tildeGroupFile: @file;
   groupName,frejaFileName,autoSaveFrejaFileName,tildeFrejaFileName,help: ^text
do
   thisOperation:
     (# 
     do
        name[]->diagFile.name;
        '#'->(name.copy).append->autosaveDiagFile.name;
        '~'->(name.copy).append->tildeDiagFile.name;
        (if switch[17] then
            'Freja revert:'->putLine;
            diagFile.name->putLine;
            autosaveDiagFile.name->putLine;
            tildeDiagFile.name->putLine
        if);
        (if badRecovery then
            ('Revert','Revert to latest saved diagram?')->promptForBoolean->ok
         else
            yes->ok
        if);
        (if ok = yes then
            name.copy->groupName[];
            groupName->removeExtension->groupName;
            '.freja'->(groupName.copy).append->frejaFileName[]->frejaFile.name;
            '.freja#'->(groupName.copy).append->autosaveFrejaFileName[]
              ->autosaveFrejaFile.name;
            '.freja~'->(groupName.copy).append->tildeFrejaFileName[]
              ->tildeFrejaFile.name;
            (if badRecovery then
                (if tildeFrejaFile.entry.exists then
                    (if tildeDiagFile.entry.exists then
                        'mv .diag~ .diag'->putLine;
                        diagFile.name
                          ->tildeDiagFile.entry.rename
                            (#
                               error::< 
                                 (# 
                                 do
                                    'Could not move '->msg;
                                    diagFile.name->msg.puttext;
                                    '~ into '->msg.puttext;
                                    diagFile.name->msg.puttext;
                                    leave thisOperation
                                 #)
                            #)
                     else
                        'No .diag~ file!!'->putLine; leave thisOperation
                    if);
                    tildeFrejaFileName
                      ->scanAstFiles
                        (# 
                        do
                           currentGroupName->groupName;
                           mps.astFileExtension->groupName.append;
                           groupName[]->groupFile.name;
                           '~'->(groupName.copy).append->tildeGroupFile.name;
                           (if switch[17] then
                               groupName[]->putLine;
                               tildeGroupFile.name->putLine
                           if);
                           (if tildeGroupFile.entry.exists and
                           groupFile.entry.exists then
                               groupFile.name
                                 ->tildeGroupFile.entry.rename
                                   (#
                                      error::< 
                                        (# 
                                        do
                                           'Could not move '->msg;
                                           groupFile.name->msg.puttext;
                                           '~ into '->msg.puttext;
                                           groupFile.name->msg.puttext;
                                           leave thisOperation
                                        #)
                                   #)
                           if)
                        #);
                    'mv .freja~ .freja'->putLine;
                    frejaFile.name
                      ->tildeFrejaFile.entry.rename
                        (#
                           error::< 
                             (# 
                             do
                                'Could not move '->msg;
                                frejaFile.name->msg.puttext;
                                '~ into '->msg.puttext;
                                frejaFile.name->msg.puttext;
                                leave thisOperation
                             #)
                        #);
                    name->openDiagram
                 else
                    'No .freja~ file!!'->putLine
                if)
             else
                (if autosaveFrejaFile.entry.exists then
                    autosaveFrejaFileName
                      ->scanAstFiles
                        (# 
                        do
                           currentGroupName->groupName;
                           mps.astFileExtension->groupName.append;
                           groupName[]->groupFile.name;
                           '#'->(groupName.copy).append->autosaveGroupFile.name;
                           '~'->(groupName.copy).append->tildeGroupFile.name;
                           (if switch[17] then
                               groupName[]->putLine;
                               autosaveGroupFile.name->putLine;
                               tildeGroupFile.name->putLine
                           if);
                           (if autosaveGroupFile.entry.exists then
                               autosaveGroupFile.delete
                           if);
                           (if tildeGroupFile.entry.exists and
                           groupFile.entry.exists then
                               groupFile.name
                                 ->tildeGroupFile.entry.rename
                                   (#
                                      error::< 
                                        (# 
                                        do
                                           'Could not move '->msg;
                                           groupFile.name->msg.puttext;
                                           '~ into '->msg.puttext;
                                           groupFile.name->msg.puttext;
                                           leave thisOperation
                                        #)
                                   #)
                           if)
                        #);
                    (if tildeFrejaFile.entry.exists then
                        'mv .freja~ .freja'->putLine;
                        frejaFile.name
                          ->tildeFrejaFile.entry.rename
                            (#
                               error::< 
                                 (# 
                                 do
                                    'Could not move '->msg;
                                    frejaFile.name->msg.puttext;
                                    '~ into '->msg.puttext;
                                    frejaFile.name->msg.puttext;
                                    leave thisOperation
                                 #)
                            #)
                     else
                        'No .freja~ file!!'->putLine
                    if);
                    (if autosaveDiagFile.entry.exists then
                        'rm .diag#'->putLine; autoSaveDiagFile.delete
                    if);
                    'rm .freja#'->putLine;
                    autosaveFrejaFile.delete;
                    closeDiagram;
                    name->openDiagram
                if)
            if)
        if)
     #)
#)
(*
 -- FrejaOptionsMenuInit: Descriptor --
 (#  do (UserMenu3+13,'With Dexter')->WithDexterItem.init;  #)  
 
 -- FrejaOptionsMenuCheckMarks: Descriptor --
 (#  do withDexter->WithDexterItem.check #)  
 *)  

-- recoverDiagFile: DoPart --
do
     (#
        diagFile,autosaveDiagFile,groupFile,autosaveGroupFile: @file;
        groupName,frejaFileName,diagFileName: ^text
     do
        name[]->diagFileName[]->diagFile.name;
        '#'->(name.copy).append->autosaveDiagFile.name;
        name.copy->groupName[];
        groupName->removeExtension->groupName;
        '.freja'->(groupName.copy).append->frejaFileName[];
        thisOp:
        (if autosaveDiagFile.entry.exists and diagFile.entry.exists then
            (if autosaveDiagFile.entry.modtime > diagFile.entry.modtime then
            (* no not any more
             'mv .diag .diag~'->putLine;
             tildeDiagFileName[]->diagFile.entry.rename;
             *)
                'mv .diag# .diag'->putLine;
                diagFileName[]
                  ->autoSaveDiagFile.entry.rename
                    (#
                       error::< 
                         (# 
                         do
                            'Could not move '->msg;
                            diagFile.name->msg.puttext;
                            '# into '->msg.puttext;
                            diagFile.name->msg.puttext;
                            msg->THIS(recoverDiagFile).error;
                            leave thisOp
                         #)
                    #)
             else
                'autosaveDiagFile.entry.modtime IS NOT > diagFile.entry.modtime'
                  ->putLine;
                
            if);
            frejaFileName
              ->scanAstFiles
                (# 
                do
                   currentGroupName->groupName;
                   mps.astFileExtension->groupName.append;
                   groupName[]->groupFile.name;
                   '#'->(groupName.copy).append->autosaveGroupFile.name;
                   (if switch[17] then
                       groupFile.name->putLine; autosaveGroupFile.name->putLine
                   if);
                   (if groupFile.entry.exists then
                       (if autosaveGroupFile.entry.exists then
                           (if switch[17] then
                               groupFile.name->putText;
                               ': '->putText;
                               groupFile.entry.modtime->putInt;
                               newLine;
                               autosaveGroupFile.name->putText;
                               ': '->putText;
                               autosaveGroupFile.entry.modtime->putInt;
                               newLine
                           if);
                           (if autosaveGroupFile.entry.modtime >
                           groupFile.entry.modtime then
                               groupFile.name
                                 ->autoSaveGroupFile.entry.rename
                                   (#
                                      error::< 
                                        (# 
                                        do
                                           'Could not move '->msg;
                                           groupFile.name->msg.puttext;
                                           '# into '->msg.puttext;
                                           groupFile.name->msg.puttext;
                                           msg->THIS(recoverDiagFile).error;
                                           leave thisOp
                                        #)
                                   #)
                            else
                               'autosaveGroupFile.entry.modtime IS NOT > groupFile.entry.modtime'
                                 ->putLine;
                               
                           if)
                       if)
                    else
                       
                   if)
                #)
         else
            (if autosaveDiagFile.entry.exists then
                'mv .diag# .diag'->putLine;
                diagFileName[]
                  ->autoSaveDiagFile.entry.rename
                    (#
                       error::< 
                         (# 
                         do
                            'Could not move '->msg;
                            diagFile.name->msg.puttext;
                            '# into '->msg.puttext;
                            diagFile.name->msg.puttext;
                            msg->THIS(recoverDiagFile).error;
                            leave thisOp
                         #)
                    #);
                frejaFileName
                  ->scanAstFiles
                    (# 
                    do
                       currentGroupName->groupName;
                       mps.astFileExtension->groupName.append;
                       groupName[]->groupFile.name;
                       '#'->(groupName.copy).append->autosaveGroupFile.name;
                       (if switch[17] then
                           groupFile.name->putLine;
                           autosaveGroupFile.name->putLine
                       if);
                       (if groupFile.entry.exists then
                           (if autosaveGroupFile.entry.exists then
                               (if switch[17] then
                                   groupFile.name->putText;
                                   ': '->putText;
                                   groupFile.entry.modtime->putInt;
                                   newLine;
                                   autosaveGroupFile.name->putText;
                                   ': '->putText;
                                   autosaveGroupFile.entry.modtime->putInt;
                                   newLine
                               if);
                               (if autosaveGroupFile.entry.modtime >
                               groupFile.entry.modtime then
                                   groupFile.name
                                     ->autoSaveGroupFile.entry.rename
                                       (#
                                          error::< 
                                            (# 
                                            do
                                               'Could not move '->msg;
                                               groupFile.name->msg.puttext;
                                               '# into '->msg.puttext;
                                               groupFile.name->msg.puttext;
                                               msg->THIS(recoverDiagFile).error;
                                               leave thisOp
                                            #)
                                       #)
                                else
                                   'autosaveGroupFile.entry.modtime IS NOT > groupFile.entry.modtime'
                                     ->putLine;
                                   
                               if)
                           if)
                        else
                           
                       if)
                    #)
            if)
        if)
     #)  

-- checkDiagFile: Descriptor --
(#
   diagFile,frejaFile,groupFile,betFile: @file;
   groupName,frejaFileName,help: ^text;
   tryRevert: @boolean;
   doOpen: @integer
do
   thisOperation:
     (# 
     do
        true->OK;
        'Consistency check failed!'->help[];
        help.newLine;
        name[]->diagFile.name;
        (if switch[17] then
            'Freja checkDiagFile:'->putLine;
            diagFile.name->putLine;
            'fromRecovery: '->putText;
            fromRecovery->putInt;
            newlIne;
            
        if);
        (if diagFile.entry.exists then
            name.copy->groupName[];
            groupName->removeExtension->groupName;
            '.freja'->(groupName.copy).append->frejaFileName[]->frejafile.name;
            (if frejafile.entry.exists then
                (if frejafile.entry.readable then
                    scanning:
                    frejaFileName
                      ->scanAstFiles
                        (#
                           fg: ^mps.fragmentGroup;
                           frejamark: @integer;
                           t: @text
                        do
                           currentGroupName->groupName;
                           '.bet'->(groupName.copy).append->betFile.name;
                           mps.astFileExtension->groupName.append;
                           groupName[]->groupFile.name;
                           (if groupFile.entry.exists then
                           (* no we cannot be sure of that 
                            (if groupFile.entry.modtime > diagFile.entry.modtime then
                            groupFile.name->help.putLine; help.newLine;
                            'is newer than'->help.putLine; help.newLine;
                            diagFile.name->help.putText;
                            help[]->alertUser;
                            false->OK
                            if)*)
                               currentGroupname[]->topDotOpen->fg[];
                               (if fg[] <> none then
                                   fg[]->sifGetFrejaMark->frejamark
                               if);
                               (if not (frejamark = UniqueDiagramID) then
                                   (if groupFile.entry.modtime <> currentModTime
                                    then
                                       groupFile.name->help.putLine;
                                       'is inconsistent with'->help.putLine;
                                       diagFile.name->help.putLine;
                                       help[]->putline;
                                       false->OK;
                                       'modtime of '->puttext;
                                       mps.astFileExtension->puttext;
                                       ' file: '->putText;
                                       groupFile.entry.modtime->putInt;
                                       newLine;
                                       'expected modtime: '->putText;
                                       currentModtime->putInt;
                                       newLine;
                                       (if fromRecovery then
                                           (if canTryRevert then
                                               true->tryRevert
                                           if)
                                        else
                                           'Open '->help.puttext;
                                           mps.astFileExtension->help.puttext;
                                           ' or .bet file instead?'
                                             ->help.putText;
                                           ('Open',help[])->promptForBoolean
                                             ->doOpen;
                                           (if doOpen = yes then
                                               groupname->removeExtension
                                                 ->groupname;
                                               (if currentDiagramName[] = none
                                                then
                                                   groupName.copy
                                                     ->currentDiagramName[];
                                                   '.diag'
                                                     ->currentDiagramName.append
                                               if);
                                               (groupName,true)
                                                 ->openFragmentGroup
                                           if)
                                       if);
                                       leave scanning
                                   if)
                               if)
                            else
                               groupFile.name->help.putLine;
                               'does not exist'->help.putLine;
                               (if betFile.entry.exists then
                                   'Open .bet file instead?'->help.putLine;
                                   ('Open',help[])->promptForBoolean->doOpen;
                                   (if doOpen = yes then
                                       groupname->removeExtension->groupname;
                                       (if currentDiagramName[] = none then
                                           groupName.copy->currentDiagramName[];
                                           '.diag'->currentDiagramName.append
                                       if);
                                       (groupName,true)->openFragmentGroup
                                   if)
                                else
                                   help[]->alertUser
                               if);
                               help[]->putLine;
                               false->OK
                           if);
                           (if OK and betFile.entry.exists then
                               (if betFile.entry.modtime >
                               diagFile.entry.modtime then
                                   (if (groupFile.entry.exists) and
                                   (betFile.entry.modtime >
                                    groupFile.entry.modtime) then
                                       betFile.name->help.puttext;
                                       ' is newer.'->help.putLine;
                                       'Open .bet file instead?'->help.putText;
                                       (if not fromRecovery then
                                           ('Open',help[])->promptForBoolean
                                             ->doOpen;
                                           (if doOpen = yes then
                                               groupname->removeExtension
                                                 ->groupname;
                                               (if currentDiagramName[] = none
                                                then
                                                   groupName.copy
                                                     ->currentDiagramName[];
                                                   '.diag'
                                                     ->currentDiagramName.append
                                               if);
                                               (groupName,true)
                                                 ->openFragmentGroup
                                           if)
                                       if);
                                       help[]->putLine;
                                       false->OK
                                   if)
                               if)
                           if);
                           (if OK and groupFile.entry.exists and
                           betFile.entry.exists then
                               (if betFile.entry.modtime >
                               groupFile.entry.modtime then
                                   betFile.name->help.putLine;
                                   'is newer than'->help.putLine;
                                   groupFile.name->help.putLine;
                                   'Open .bet file instead?'->help.putText;
                                   (if not fromRecovery then
                                       ('Open',help[])->promptForBoolean
                                         ->doOpen;
                                       (if doOpen = yes then
                                           groupname->removeExtension
                                             ->groupname;
                                           (if currentDiagramName[] = none then
                                               groupName.copy
                                                 ->currentDiagramName[];
                                               '.diag'
                                                 ->currentDiagramName.append
                                           if);
                                           (groupName,true)->openFragmentGroup
                                       if)
                                   if);
                                   help[]->putLine;
                                   false->OK
                               if)
                           if)
                        #)
                 else
                    frejaFile.name->help.putLine;
                    ' is not readable '->help.putLine;
                    false->OK;
                    (if fromRecovery then
                        (if canTryRevert then true->tryRevert if)
                     else
                        'Open '->help.puttext;
                        mps.astFileExtension->help.puttext;
                        ' or .bet file instead?'->help.putText;
                        ('Open',help[])->promptForBoolean->doOpen;
                        (if doOpen = yes then
                            (if currentDiagramName[] = none then
                                groupName.copy->currentDiagramName[];
                                '.diag'->currentDiagramName.append
                            if);
                            (groupName,true)->openFragmentGroup
                        if)
                    if)
                if)
             else
                frejaFile.name->help.putLine;
                ' does not exist'->help.putLine;
                false->OK;
                'Open '->help.puttext;
                mps.astFileExtension->help.puttext;
                ' or .bet file instead?'->help.putText;
                ('Open',help[])->promptForBoolean->doOpen;
                (if doOpen = yes then
                    (if currentDiagramName[] = none then
                        groupName.copy->currentDiagramName[];
                        '.diag'->currentDiagramName.append
                    if);
                    (groupName,true)->openFragmentGroup
                if);
                help[]->putLine;
                false->OK
            if)
         else
            diagFile.name->putText; ' does not exist!!'->putLine
        if)
     #);
   (if tryRevert then 'tryRevert'->putLIne; (name,true)->revert if)
#)  

-- makeFrejaFile: Descriptor --
(#
   f: @file;
   fileName: @Text;
   groupFile,recoveryGroupFile: @file;
   lastChar: @char;
   help: @text;
   fd: ^theOADDocument.theGroupPage.FragmentDiagram;
   theListDiagram: ^theOADDocument.theGroupPage.ListDiagram;
   dirWriteable: (# f: @file enter f.name exit f.entry.writeable #)
do
   l:
   (if name[] <> none then
       name[]->f.name;
       (if switch[17] then
           'Freja makeFrejaFile:'->putLine; f.name->putLine; 
       if);
       (if (f.entry.path.head->dirWriteable)
        // true then
           (if f.entry.writeable
            // true then f.openWrite
            else
                 (# t: @text
                 do
                    'No write access to the file: "'->t;
                    f.name->t.append;
                    '"'->t.putline;
                    t[]->alertUser;
                    leave l
                 #)
           if)
        else
             (# t: @text
             do
                'No write access to the directory: "'->t;
                f.entry.path.head->t.append;
                '"'->t.putline;
                t[]->alertUser;
                leave l
             #)
       if);
       UniqueDiagramID->f.putint;
       ' '->f.putline;
       theDocument[]->theOADDocument[];
       (if theOADDocument[] = none then
           'theOADDocument[] is none'->putLine
        else
           (if theOADDocument.theGroupPage[] = none then
               'theOADDocument.theGroupPage[] is none'->putLine
            else
               (if theOADDocument.theGroupPage.patternDiagrams[] = none then
                   'theOADDocument.theGroupPage.patternDiagrams[] is none'
                     ->putLine
                else
                   (if theOADDocument.theGroupPage.patternDiagrams.theList[] =
                   none then
                       'theOADDocument.theGroupPage.patternDiagrams.theList[] is none'
                         ->putLine
                    else
                       theOADDocument.theGroupPage.PatternDiagrams.theList.scan
                         (# 
                         do
                            current.e[]->theListDiagram[];
                            (if theListDiagram## <=
                            theOADDocument.theGroupPage.fragmentDiagram## then
                                theListDiagram[]->fd[];
                                fd.fullname->f.putline;
                                name.length->name.inxGet->lastChar;
                                (if (lastChar = '#') or (lastChar = '~') then
                                    (if switch[17] then
                                        'it is a recovery file'->putLine
                                    if);
                                    help.clear;
                                    lastChar->help.put;
                                    help[]
                                      ->
                                        (((fd.theGroup).diskFileName).copy).
                                        append->recoveryGroupFile.name;
                                    (if recoveryGroupFile.entry.exists then
                                        recoveryGroupFile.entry.modtime
                                          ->f.putInt;
                                        (if switch[17] then
                                            fd.fullname->putline;
                                            recoveryGroupFile.entry.modtime
                                              ->putint;
                                            ' '->putline;
                                            
                                        if);
                                        
                                     else
                                        (if lastChar = '#' then
                                            (fd.theGroup).diskFileName
                                              ->groupFile.name;
                                            (if switch[17] then
                                                fd.fullname->putline;
                                                '(fd.theGroup).modtime: '
                                                  ->putText;
                                                (fd.theGroup).modtime->putint;
                                                ' '->putline;
                                                
                                            if);
                                            (if groupFile.entry.exists then
                                                (if switch[17] then
                                                    'groupFile.entry.modtime: '
                                                      ->putText;
                                                    groupFile.entry.modtime
                                                      ->putInt;
                                                    newLine
                                                if);
                                                groupFile.entry.modtime
                                                  ->f.putInt;
                                                
                                             else
                                                'No group file!!'->putLine
                                            if)
                                         else
                                            'No recoveryGroupFile: '->putText;
                                            recoveryGroupFile.name->putLine;
                                            'Should not happen!!'->putLine
                                        if)
                                    if)
                                 else
                                    (fd.theGroup).diskFileName->groupFile.name;
                                    (if switch[17] then
                                        fd.fullname->putline;
                                        '(fd.theGroup).modtime: '->putText;
                                        (fd.theGroup).modtime->putint;
                                        ' '->putline;
                                        
                                    if);
                                    (* (fd.theGroup).modtime->f.putint;*)
                                    (if groupFile.entry.exists then
                                        (if switch[17] then
                                            'groupFile.entry.modtime: '
                                              ->putText;
                                            groupFile.entry.modtime->putInt;
                                            newLine
                                        if);
                                        groupFile.entry.modtime->f.putInt;
                                        
                                     else
                                        'No group file!!'->putLine
                                    if)
                                if);
                                ' '->f.putline
                            if)
                         #)
                   if)
               if)
           if)
       if);
       f.close
    else
       'makeFrejaFile: name is none!!'->putline
   if)
#)  

-- scanASTfiles: Descriptor --
(# f: @file; t: ^Text
do
   name[]->f.name;
   thisOp:
   (if f.entry.exists then
       (if f.entry.readable then
           f.openRead;
           (if not f.eos then
               (if f.peek->ascii.isDigit then
                   f.getline->t[];
                   (if t[] = none then leave thisOp if);
                   t.reset;
                   t.getInt->UniqueDiagramID
               if)
           if);
           loop:
             (# 
             do
                (if not f.eos then
                    f.getLine->t[];
                    (if t[] = none then leave loop if);
                    t.reset;
                    t.getAtom->currentGroupName[];
                    f.getline->t[];
                    (if t[] = none then leave loop if);
                    t.reset;
                    t.getInt->currentModTime;
                    INNER scanASTfiles;
                    restart loop
                if)
             #);
           f.close
        else
           name.copy->t[]; ' is not readable'->t.append; t[]->putline
       if)
    else
       name.copy->t[]; ' does not exist'->t.append; t[]->AlertUser
   if)
#)  

-- DesignInterfaceOnInit: DoPart --
do INNER ; doStartUp;   

