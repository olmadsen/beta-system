ORIGIN 'diagramattributes';
(* switches 
 * 30: trace prefix connectors 
 *)
(****************** PatternDiagram *******************)
-- PatternDiagramOnInit: Descriptor --
(# pos: @Point; w1,h1: @Integer; x2,y2,w2,h2: @integer; 
do
   UDPrivate.UDPatternDiagram->UserDataInit;
   (if not initialisingSaved then
       titleText->theText.set;
       (if switch[18] then
           '******** patterndiagrambody-PatternDiagramOnInit before fitToText ********'
             ->putline;
           geometry->(x2,y2,w2,h2);
           'x: '->putText;
           x2->putint;
           newLine;
           'y: '->putText;
           y2->putint;
           newLine;
           'w: '->putText;
           w2->putint;
           newLine;
           'h: '->putText;
           h2->putint;
           newLine;
           titleText[]->putLine;
           
       if);
       FitToText;
       (if switch[18] then
           '******** patterndiagrambody-PatternDiagramOnInit after fitToText and before size ********'
             ->putline;
           geometry->(x2,y2,w2,h2);
           'x: '->putText;
           x2->putint;
           newLine;
           'y: '->putText;
           y2->putint;
           newLine;
           'w: '->putText;
           w2->putint;
           newLine;
           'h: '->putText;
           h2->putint;
           newLine;
           
       if);
       Size->(w1,h1);
       (if w1 mod 2 // 1 then (w1+1,h1)->Size if);
       (if switch[18] then
           '******** patterndiagrambody-PatternDiagramOnInit after size ********'
             ->putline;
           geometry->(x2,y2,w2,h2);
           'x: '->putText;
           x2->putint;
           newLine;
           'y: '->putText;
           y2->putint;
           newLine;
           'w: '->putText;
           w2->putint;
           newLine;
           'h: '->putText;
           h2->putint;
           newLine;
           
       if);
       (if gppProp.ShowLocals
        // true then
           geometry->(x,y,w,h);
           THIS(patternDiagram).titleNode[]->THIS(OADPage).scrollIntoView;
           (x-(w+1) div 2,y+(h+1) div 2)->pos;
           pos->DisplayDeclarations;
           
       if)
   if);
   
#)
(****************** PatternAttDiagram *******************)  

-- PatternDiagramNodeDump: Descriptor --
(# x,y,w,h: @integer; connectors: ^ObjectList
do
   '********connectors********'->putline;
   getConnectors->connectors[];
   (if connectors[] <> none then
       connectors.scan (#  do current.ID->putint; ' '->puttext #); newline
    else
       'none'->putline
   if);
   '********theDiagram********'->putline;
   (if theDiagram <> none then
       (theDiagram).titleText[]->putline
    else
       'is NONE!'->putline
   if);
   '********astIndex********'->putline;
   astIndex->putint;
   newline;
   '********pos and size********'->putline;
   geometry->(x,y,w,h);
   'x: '->putText;
   x->putint;
   newLine;
   'y: '->putText;
   y->putint;
   newLine;
   'w: '->putText;
   w->putint;
   newLine;
   'h: '->putText;
   h->putint;
   newLine
#)  

-- OADDiagramOnInit: Descriptor --
(#  do UDPrivate.UDOADDiagram->UserDataInit; UDtheDescriptor.Init #)  

-- OADDiagramDump: Descriptor --
(# 
do
   '********theDescriptor********'->putline;
   (if theDescriptor <> none then
       (theDescriptor).dump; newline
    else
       'is NONE!'->putline
   if)
#)  

-- PatternAttDiagramDump: Descriptor --
(# 
do
   '********theAST********'->putline;
   (if theAST <> none then
       (theAST).dump; newline
    else
       'is NONE!'->putline
   if)
#)  

-- PatternDiagramNodeOnInit: Descriptor --
(# 
do
   false->theText.wrap;
   UDPrivate.UDPatternDiagramNode->UserDataInit;
   theDiagram.Init;
   invisibleText.init;
   theMarkNode.Init;
   defaultShape.Init;
   astIndex.Init
#)  

-- PatternDiagramNodeOnInitAfter: Descriptor --
(#  do LeftJustification->theText.Just #)  

-- PatternAttDiagramDisplayDeclarations: Descriptor --
(# anAST: ^MPS.AST do theAST->anAST[]; anAST[]->theAttributes[];  #)  

-- PatternAttDiagramNew: Descriptor --
(# 
do
   (if anAST.symbol
    // betaGram.Attributes then
       anAST[]->theAST;
       titleshape->Display;
       (anAST.index,THIS(PatternAttDiagram)[])
         ->PatternDiagrams.theList.insertPD;
       
    else
       'PatternAttDiagram New: unknown AST symbol'->putline; 
   if);
   
#)
(****************** PatternDeclDiagram *******************)  

-- PatternAttDiagramOnInit: Descriptor --
(#  do UDPrivate.UDPatternAttDiagram->UserDataInit; UdtheAST.Init #)  

-- PatternDeclDiagramDump: Descriptor --
(# 
do
   '********thePrefix********'->putline;
   (if thePrefix <> none then
       (thePrefix).dump; newline
    else
       'is NONE!'->putline
   if)
#)  

-- PatternDeclDiagramDisplayDeclarations: Descriptor --
(# main: ^betaGram.MainPart; theDummyDesc: ^betaGram.ObjectDescriptor
do
   (if theDescriptor
    // none then none ->theAttributes[]; 
    else
       theDescriptor->theDummyDesc[];
       theDummyDesc.getMainPart->main[];
       main.getAttributes->theAttributes[];
       
   if);
   
#)  

-- PatternDeclDiagramDisplay: Descriptor --
(#
   x,y: @Integer;
   subList: ^DiagramList;
   prefixDiagram: ^PatternDiagram;
   e: ^localNodes.element;
   theDummyDesc: ^betaGram.ObjectDescriptor;
   theDiagramNode: ^DiagramNode;
   anAST,theFather: ^MPS.AST
do
   (if theDescriptor
    // none then (* I must be generated from a non-terminal *)
       none ->thePrefix; 
    else
       theDescriptor->theDummyDesc[];
       (if theDummyDesc.frag.father->isChecked
        // true then
           theDescriptor->getPrefix->thePrefix;
           (if thePrefix <> none then
               theDummyDesc.father->theFather[];
               (if theFather## <= betaGram.AttributeDecl## then
                   (theFather[],(thePrefix).father)
                     ->patternDiagrams.InheritanceList.insert
                else
               (*could be a singular*)
                   theFather.father->theFather[];
                   (if theFather[] <> none then
                       (if theFather## <= betaGram.AttributeDecl## then
                           ((theDummyDesc.father).father,(thePrefix).father)
                             ->patternDiagrams.InheritanceList.insert
                       if)
                   if)
               if)
           if)
        else
           theParentNode->theDiagramNode[];
           (if theDiagramNode[] <> none then
               (if theDiagramNode.thePrefix <> none then
                   theDiagramNode.thePrefix->thePrefix
               if)
           if)
       if);
       
   if);
   (if thePrefix <> none
    // true then (* find diagram *)
       (thePrefix).index->PatternDiagrams.theList.findPD->prefixDiagram[];
       (if prefixDiagram[]
        // none then
           (PatternDiagrams.NextFreeColumn,PatternDiagrams.NextFreeLine)
             ->theCenter;
           
        else
       (* we have a prefixDiagram: 
        * draw the subpattern diagram in relation
        * (below) the prefixDiagram
        *)
           prefixDiagram[]->PatternDiagrams.theList.GetSubPatternDiagrams
             ->subList[];
           (if subList.size
            // 0 then (* I am the first subpat of perfixDiagram[] *)
               (if prefixDiagram.localNodes.size > 0
                // true then
                   prefixDiagram.localNodes.Last
                     (#  do position.elm[]->e[]; e.Center->(x,y) #);
                   
                else
                   prefixDiagram.titleNode.Center->(x,y); 
               if);
               prefixDiagram.titleNode.Center->theCenter;
               (if x-gppProp.width > theCenter.x
                // true then
                (* the last box is not in the same column as the
                 * title:  use center of the last box *)
                   x->theCenter.x; 
               if);
               y+gppProp.DownFromPrefix->theCenter.y;
               
            else
               (- 10000,- 10000)->theCenter;
               subList.scanPatternDiagrams
                 (# p1: @Point; 
                 do
                    (if thisDiagram[]
                     // THIS(PatternDeclDiagram)[] then 
                     else
                        thisDiagram.titleNode.Center->p1;
                        (if p1.x > theCenter.x
                         // true then p1->theCenter
                        if);
                        
                    if);
                    
                 #);
               theCenter.x+gppProp.width+gppProp.RightFromPrevious->theCenter.x;
               
           if);
           
       if)
   if);
   
#)  

-- PatternDiagramDisplayPrefix: Descriptor --
(# prefixDiagram: ^PatternDiagram; con: ^PrefixConnector; 
do
   (if switch[30]
    // true then 'PatternDiagramDisplayPrefix'->screen.putline; 
   if);
   (if theDescriptor <> none
    // true then
       (if thePrefix <> none
        // true then (* is the prefix displayed on this page *)
           (thePrefix).index->PatternDiagrams.theList.findPD->prefixDiagram[];
           (if prefixDiagram[] <> none
            // true then (* Yes, go make a connector between the diagrams *)
               &PrefixConnector[]->con[];
               (if prefixDiagram.localNodes.size > 0
                // true then
                   prefixDiagram.localNodes.Last
                     (# 
                     do
                        (titleNode[],position.elm[])
                          ->con.prefixNew (* was con.new *)
                     #);
                   
                else
                   (titleNode[],prefixDiagram.titleNode[])
                     ->con.prefixNew (* was con.new *)
               if);
               prefixDiagram.titleNode[]->titleNode.CreateRegion;
               (* and make THIS to a region of prefix *)
               con[]->titleNode.thePrefixConn;
               
            else
           (* could be on another page!! *)
                 (# thePages: ^ObjectList; 
                 do
                    GetPages->thePages[];
                    scanner: thePages.scan
                      (#
                      (* ESS kja&toby 3-2-94 :
                       aPage: ^OADPage
                       This qualification is wrong, 
                       if there are other types of pages in
                       the document when scanning 
                       (e.q. ObjectPages, DesignPages)*)
                         aPage: ^page;
                         anEllipse: @DesignEllipse;
                         x,y,w,h: @Integer;
                         
                      do
                         current[]->aPage[];
                         (thePrefix).index->PatternDiagrams.theList.findPD
                           ->prefixDiagram[];
                         (if prefixDiagram[] <> none
                          // true then
                             titleNode.geometry->(x,y,w,h);
                             prefixDiagram.titleNode[]
                               ->THIS(OADPage).scrollIntoView;
                             (x-gppProp.LeftFromPrefix,y,gppProp.width,
                              gppProp.height)->anEllipse.new;
                             (titleNode[],anEllipse[])->con.prefixNew;
                             (* was con.new *)
                             anEllipse[]->titleNode.CreateRegion;
                             leave scanner;
                             
                         if)
                      #)
                 #)
           if)
        else
       (* No prefix *)
           
       if);
       (* now check for any shown subpatterns of this descriptor *)
       PatternDiagrams.theList.scanPatternDiagrams
         (# con: ^PrefixConnector; theDummyDesc: ^betaGram.ObjectDescriptor
         do
            (if thisDiagram.thePrefix <> none
             // true then
                theDescriptor->theDummyDesc[];
                (if thisDiagram.thePrefix->theDummyDesc.equal
                 // true then (* yes this diagram *)
                    &PrefixConnector[]->con[];
                    (if localNodes.size > 0
                     // true then
                        localNodes.Last
                          (# 
                          do (* was con.new *)
                             (thisDiagram.titleNode[],position.elm[])
                               ->con.prefixNew
                          #);
                        
                     else
                        (thisDiagram.titleNode[],titleNode[])->con.prefixNew;
                        (* was con.new *)
                        
                    if);
                    titleNode[]->thisDiagram.titleNode.CreateRegion;
                    (* and make THIS to a region of prefix *)
                    con[]->thisDiagram.titleNode.thePrefixConn;
                    
                if)
            if)
         #);
       
    else
       (if switch[1]
        // true then 'DisplayPrefix: No Descriptor!!!'->putline
       if);
       
   if);
   
#)  

-- PatternDeclDiagramDisplayInheritance: Descriptor --
(#
   prefixDiagram,subDiagram: ^PatternDiagram;
   con: ^PrefixConnector;
   simpleCon: ^SimplePrefixConnector;
   theParent,theNode: ^PatternDiagramNode;
   superNode,subNode: ^theListDiagram.AbstractNode;
   theListDiagram: ^ListDiagram;
   theDiagramNode: ^theListDiagram.DiagramNode;
   theDecl: ^betaGram.AttributeDecl
do
   (if switch[30] then 'DisplayInheritance: '->putline if);
   (if not patternDiagrams.InheritanceList.empty then
       (if theParentNode <> none then
           theParentNode->theParent[];
           theParent.theDiagram->theListDiagram[];
           (if theParent## <= theListDiagram.DiagramNode## then
               theParent[]->theDiagramNode[];
               theDiagramNode.theDeclaration->theDecl[];
               patternDiagrams.InheritanceList.scan
                 (# ff: ^mps.fragmentform; t: @Text
                 do
                    (if (theDecl.index = current.sub) and
                    (theDecl.frag.fullname->current.subFrag.equal) then
                        current.superFrag[]->topDotOpen->ff[];
                        current.super->ff.indexToNode->AstToNode->theNode[];
                        (if theNode[] <> none then
                            theNode.theDiagram->theListDiagram[];
                            theNode[]->superNode[];
                            (if superNode.CurrentDecomposDiagram <> none then
                                superNode.CurrentDecomposDiagram
                                  ->prefixDiagram[];
                                &PrefixConnector[]->con[];
                                (if prefixDiagram.localNodes.size > 0 then
                                    (if titleNode.thePrefixConn = none then
                                        prefixDiagram.localNodes.Last
                                          (# 
                                          do (* was con.new *)
                                             (titleNode[],position.elm[])
                                               ->con.prefixNew
                                          #)
                                    if)
                                 else
                                    (if titleNode.thePrefixConn = none then
                                    (* was con.new *)
                                        (titleNode[],prefixDiagram.titleNode[])
                                          ->con.prefixNew
                                    if)
                                if);
                                &SimplePrefixConnector[]->simpleCon[];
                                (if titleNode.theSimplePrefixConn = none then
                                    (titleNode[],prefixDiagram.titleNode[])
                                      ->simpleCon.prefixNew
                                if);
                                (if (titleNode.thePrefixConn = none ) and
                                (titleNode.theSimplePrefixConn = none ) then
                                    prefixDiagram.titleNode[]
                                      ->titleNode.CreateRegion;
                                    con[]->titleNode.thePrefixConn;
                                    simpleCon[]->titleNode.theSimplePrefixConn
                                if)
                            if)
                        if)
                    if);
                    (if (theDecl.index = current.super) and
                    (theDecl.frag.fullname->current.superFrag.equal) then
                        current.subFrag[]->topDotOpen->ff[];
                        current.sub->ff.indexToNode->AstToNode->theNode[];
                        (if theNode[] <> none then
                            theNode.theDiagram->theListDiagram[];
                            theNode[]->subNode[];
                            (if subNode.CurrentDecomposDiagram <> none then
                                subNode.CurrentDecomposDiagram->subDiagram[];
                                &subDiagram.PrefixConnector[]->con[];
                                (if localNodes.size > 0
                                 // true then
                                    (if subDiagram.titleNode.thePrefixConn =
                                    none then
                                        localNodes.Last
                                          (# 
                                          do (* was con.new *)
                                             (subDiagram.titleNode[],
                                              position.elm[])->con.prefixNew
                                          #)
                                    if);
                                    
                                 else
                                    (if subDiagram.titleNode.thePrefixConn =
                                    none then
                                        (subDiagram.titleNode[],titleNode[])
                                          ->con.prefixNew
                                    if);
                                    (* was con.new *)
                                    
                                if);
                                &subDiagram.SimplePrefixConnector[]
                                  ->simpleCon[];
                                (if subDiagram.titleNode.theSimplePrefixConn =
                                none then
                                    (subDiagram.titleNode[],titleNode[])
                                      ->simpleCon.prefixNew
                                if);
                                (if
                                (subDiagram.titleNode.thePrefixConn = none ) and
                                (subDiagram.titleNode.theSimplePrefixConn = none
                                 ) then
                                    titleNode[]
                                      ->subDiagram.titleNode.CreateRegion;
                                    con[]->subDiagram.titleNode.thePrefixConn;
                                    simpleCon[]
                                      ->subDiagram.titleNode.theSimplePrefixConn
                                if)
                            if)
                        if)
                    if)
                 #)
           if);
           (* now check for any shown subpatterns of this descriptor *)
           
       if)
   if);
   
#)  

-- PatternDeclDiagramOnInit: Descriptor --
(#
   fd: ^FragmentDiagram;
   index: @integer;
   t,tt: ^text;
   theDummyFragNode: ^PatternDiagramNode;
   theDummyGroup: ^mps.fragmentgroup
do
   UDPrivate.UDPatternDeclDiagram->UserDataInit;
   UDthePrefix.Init;
   (if not initialisingSaved then
       theFragmentNode->theDummyFragNode[];
       theDummyFragNode.theDiagram->fd[];
       DisplayInheritance;
       
   if);
   
#)  

-- PatternDeclDiagramNew: Descriptor --
(# 
do
   (if anAST.symbol
    // betaGram.ObjectDescriptor then
       anAST[]->theDescriptor; titleShape->Display; 
    else
       'PatternDeclDiagram New: unknown AST symbol'->putline; 
   if);
   
#)
(****************** Pattern Classification Diagram *******************)  

-- PatternClassificationDiagramDisplay: Descriptor --
(#
   root: ^mps.expanded;
   LookForInheritance:
     (# root: ^mps.expanded; 
     enter root[]
     do
        betaGram.ObjectDescriptor
          ->root.suffixWalkforProd
            (#
               scanCat::< betaGram.ObjectDescriptor;
               tempAst: ^mps.ast;
               pref: ^betaGram.prefix;
               ad: ^betaGram.attributeDenotation;
               thisInheritor: ^betaGram.ObjectDescriptor;
               inheritorDiagram: ^PatternDeclDiagram;
               con: ^PrefixConnector;
               
            do
               (if switch[30]
                // true then
                   'PatternClassificationDiagramDisplay'->screen.putline; 
               if);
               current.getPrefixOpt->tempAst[];
               (if tempAst.kind
                // mps.kinds.interior then
                   (if switch[30] // true then '.'->screen.put;  if);
                   tempAst[]->pref[];
                   pref.getAttributeDenotation->tempAst[];
                   (if tempAst.kind
                    // mps.kinds.interior then
                       tempAst[]->ad[];
                       ad.findDescriptor->thisInheritor[];
                       (if thisInheritor[]
                        // theDescriptor then
                           (if switch[30]
                            // true then 'Found inheritor.'->screen.putline; 
                           if);
                           thisInheritor.index->PatternDiagrams.theList.findPD
                             ->inheritorDiagram[];
                           (if inheritorDiagram[]
                            // none then
                               (if switch[30]
                                // true then 'Not displayed'->screen.putline; 
                               if);
                               
                            else
                               (if switch[30]
                                // true then
                                   'Already displayed, create perfix connector'
                                     ->screen.putline;
                                   
                               if);
                               &PrefixConnector[]->con[];
                               (if localNodes.size > 0
                                // true then
                                   localNodes.Last
                                     (# 
                                     do (* was con.new *)
                                        (inheritorDiagram.titleNode[],
                                         position.elm[])->con.prefixNew
                                     #);
                                   
                                else
                               (* was con.new *)
                                   (inheritorDiagram.titleNode[],titleNode[])
                                     ->con.prefixNew
                               if);
                               titleNode[]
                                 ->inheritorDiagram.titleNode.CreateRegion;
                               con[]->inheritorDiagram.titleNode.thePrefixConn;
                               
                           if)
                       if)
                   if)
               if)
            #)
     #);
   theDiagram: ^theGroupPage.FragmentDiagram;
   theDummyGroup: ^mps.fragmentgroup
do
   theGroupPage.FragmentDiagram##
     ->theGroupPage.ScanDiagrams
       (# 
       do
          current[]->theDiagram[];
          (if switch[30]
           // true then theDiagram.fullname->screen.putline; 
          if);
          (if (theDiagram.theGroup->isChecked)
           // true then
              theDiagram.theGroup->theDummyGroup[];
              theDummyGroup.fragmentlist.scan
                (# ff: ^mps.fragmentform; 
                do
                   (if current.type
                    // mps.FormType then
                       current.f[]->ff[];
                       (if ff.root[]
                        // none then 
                        else
                           ff.root[]->LookForInheritance; 
                       if)
                   if)
                #)
          if)
       #)
#)
(****************** Pattern NonTerminal Diagram *******************)  

-- PatternClassificationDiagramOnInit: Descriptor --
(#  do UDPrivate.UDPatternClassificationDiagram->UserDataInit #)  

-- PatternNonTerminalDiagramNew: Descriptor --
(# 
do
   'PatternNonTerminalDiagramNew: '->screen.puttext;
   titletext[]->screen.putline;
   (if anAst[]
    // none then 'PatternNonTerminalDiagramNew anAST is NONE'->putline; 
    else
       (if anAST.symbol
        // betaGram.ObjectDescriptor then
           anAST[]->theDescriptor; titleshape->Display; 
        else
           'PatternNonTerminalDiagram New: unknown AST symbol'->putline; 
       if)
   if);
   
#)  

-- PatternNonTerminalDisplayDeclarations: Descriptor --
(#
   nt: ^NonTerminalNode;
   unExp: ^mps.unexpanded;
   x,y: @Integer;
   main: ^betaGram.MainPart;
   theDummyDesc: ^betaGram.ObjectDescriptor
do
   (if theDescriptor
    // none then
       none ->theAttributes[];
       'NonTerminal: theDescriptor is NONE'->putline;
       (*&NonTerminalNode[] -> nt[];
        (gram.attributedecl,theDescriptor.frag[]) -> betagram.newUnexpanded -> unExp[];
        (startpos,unExp[]) -> nt.display;
        THIS(PatternNonTerminalDiagram)[] -> nt.theDiagram[];*)
       
    else
       theDescriptor->theDummyDesc[];
       theDummyDesc.getMainPart->main[];
       main.getAttributes->theAttributes[];
       
   if);
   
#)  

-- PatternNonTerminalDiagramOnInit: Descriptor --
(# 
do UDPrivate.UDPatternNonTerminalDiagram->UserDataInit; UDtheDesc.Init
#)  

-- CommentNodeOnInit: Descriptor --
(#  do UDPrivate.UDCommentNode->UserDataInit #)  

-- prefixNew: Descriptor --
(# x,y,w,h: @Integer; wed: ^WedgeNode; 
do
   (if switch[1] then
       'Prefixnew: '->puttext;
       node1.id->putint;
       ' '->puttext;
       node2.id->putint;
       newline
   if);
   node1.geometry->(x,y,w,h);
   node1[]->THIS(OADPage).scrollIntoView;
   &WedgeNode[]->wed[];
   (x,y-(h div 2)-1,10,10)->wed.new;
   (270,90)->wed.angles;
   false->wed.selectable;
   false->wed.sizeable;
   (wed[],node2[])->new;
   node1[]->pnode1;
   node2[]->pnode2;
   pnode1->wed.createRegion;
   (if not gppProp.specializations then
       false->BorderVisible; false->wed.BorderVisible; false->selectable
    else
       (if not gppProp.showAttributes then
           false->BorderVisible; false->wed.BorderVisible; false->selectable
       if)
   if);
   (*  (if gppProp.SimpleHierarchyPresentation
    // true then (pnode1,pnode2)->new
    else
    (pnode1).geometry->(x,y,w,h);
    pnode1->THIS(OADPage).scrollIntoView;
    &WedgeNode[]->wed[];
    (x,y-(h div 2)-1,10,10)->wed.new;
    (270,90)->wed.angles;
    false->wed.selectable;
    false->wed.sizeable;
    (wed[],pnode2)->new;
    pnode1->wed.createRegion;
    
    if)*)
   
#)  

-- treeNew: Descriptor --
(# x,y,w,h: @Integer; r: ^RectNode; 
do
   (if gppProp.SimpleHierarchyPresentation
    // true then (node1[],node2[])->new
    else
       node2.geometry->(x,y,w,h);
       node2[]->THIS(OADPage).scrollIntoView;
       &RectNode[]->r[];
       (x,y-(h div 2)-2,6,6)->r.new;
       false->r.sizeable;
       false->r.selectable;
       (node1[],r[])->new;
       node2[]->r.createRegion;
       
   if)
#)  

-- UserDataNodeOninit: Descriptor --
(# 
do
   LocalNodesUDAttributes.init;
   oldLocalNodesUDAttributes.init;
   LocalNodesUDAttributes->oldLocalNodesUDAttributes;
   LocalNodesUserDataStart->LocalNodesUDAttributes;
   decomposDiagramsUDAttributes.init;
   oldDecomposDiagramsUDAttributes.init;
   decomposDiagramsUDAttributes->oldDecomposDiagramsUDAttributes;
   decomposDiagramsUserDataStart->decomposDiagramsUDAttributes;
   INNER onInit
#)  

-- PrefixConnectorDelete: Descriptor --
(#  do (if wedge[] <> none then wedge.delete if) #)  

-- PrefixConnectorOnDelete: Descriptor --
(#
   node1,node2,dummy: ^PatternDiagramNode;
   theTitleNode: ^theOADDiagram.title;
   theDiagramNode: ^theOADDiagram.DiagramNode;
   titleText: @Text;
   theOADDiagram,theOtherOADDiagram: ^OADDiagram;
   thePatternDeclDiagram: ^PatternDeclDiagram;
   anAST: ^MPS.AST;
   theDesc: ^betaGram.ObjectDescriptor;
   theMainPart: ^betaGram.MainPart;
   nd1,nd2: @integerRef;
   object1,object2: ^designObject;
   theParentNode: ^PatternDiagramNode;
   theParentDiagram: ^ListDiagram;
   theParentDiagramNode: ^theParentDiagram.DiagramNode;
   wed: ^WedgeNode
do
   (if switch[1] then 'InheritanceConnector onRemove!'->putline if);
   (if (ID,true,nd1[],nd2[])->DSRdAttrGetConnEnds then
       nd1->theObjectList.Find->object1[];
       (if object1[] <> none then
           (if object1## <= wedgeNode## then
               object1[]->wedge[]
            else
               nd2->theObjectList.Find->object2[];
               (if object2[] <> none then
                   (if object2## <= wedgeNode## then object2[]->wedge[] if)
               if)
           if)
       if)
    else
       'GetEnds failed connector ID: '->puttext; ID->putint; newline
   if);
   true->getEnds->(node1[],node2[]);
   node1.theDiagram->theOADDiagram[];
   node2.theDiagram->theOtherOADDiagram[];
   (if node1## <= theOADDiagram.title## then
       
    else
       (if node2## <= theOtherOADDiagram.title## then
           node1[]->dummy[];
           node2[]->node1[];
           dummy[]->node2[];
           theOtherOADDiagram[]->theOADDiagram[]
       if)
   if);
   node1[]->theTitleNode[];
   none ->theTitleNode.thePrefixConn;
   theOADDiagram[]->thePatternDeclDiagram[];
   none ->thePatternDeclDiagram.thePrefix;
   theOADDiagram.theParentNode->theDiagramNode[];
   none ->theDiagramNode.thePrefix;
   theOADDiagram.theParentNode->theParentNode[];
   theParentNode.theDiagram->theParentDiagram[];
   theParentNode[]->theParentDiagramNode[];
   node1.unmakeRegion;
   theOADDiagram.theDescriptor->theDesc[];
   theDesc.getPrefixOpt->anAST[];
   ''->t[];
   (anAST[],t)->(node2.theSifEditor).parse;
   (if theTitleNode.theSimplePrefixConn <> none then
       (if
       ((titleNode.theSimplePrefixConn).ID,true,nd1[],nd2[])
         ->DSRdAttrGetConnEnds then
           nd1->theObjectList.Find->object1[];
           (if object1[] <> none then
               (if object1## <= wedgeNode## then
                   object1[]->wed[]
                else
                   nd2->theObjectList.Find->object2[];
                   (if object2[] <> none then
                       (if object2## <= wedgeNode## then object2[]->wed[] if)
                   if)
               if)
           if)
        else
           'GetEnds failed connector ID: '->puttext;
           (theTitleNode.theSimplePrefixConn).ID->putint;
           newline
       if);
       (theTitleNode.theSimplePrefixConn).delete;
       none ->theTitleNode.theSimplePrefixConn;
       (if wed[] <> none then wed.delete if)
   if)
#)  

-- PrefixConnectorOnReattach: Descriptor --
(#
   node1,node2: ^DesignObject;
   aPatternDiagramNode,anotherPatternDiagramNode,oldPatternDiagramNode:
     ^PatternDiagramNode;
   theListDiagram,theOtherListDiagram: ^ListDiagram;
   theOADDiagram,theOtherOADDiagram,oldOADDiagram: ^OADDiagram;
   theOtherPatternDeclDiagram,oldPatternDeclDiagram: ^PatternDeclDiagram;
   aDiagramNode: ^theOtherListDiagram.DiagramNode;
   t: ^Text;
   titleText: @text;
   theDesc,theOtherDesc,oldDesc: ^betaGram.ObjectDescriptor;
   anAST,anotherAST,testAST,testAST2,aDeclAST: ^MPS.AST;
   anExp: ^mps.expanded;
   theNames: ^betaGram.Names;
   theNameDcl: ^betaGram.NameDcl;
   theMainPart: ^betaGram.MainPart;
   existingConnectors: ^ObjectList;
   aCon: ^Connector;
   theCon: ^theOtherListDiagram.PrefixConnector;
   theSimpleCon: ^theOtherListDiagram.SimplePrefixConnector;
   nd1,nd2: @integerRef;
   object1,object2: ^designObject
do
   true->getEnds->(node2[],node1[]);
   (if switch[1] then
       'InheritanceConnectorOnReattach!'->putline;
       'node1: '->puttext;
       node1.id->putint;
       newline;
       'node2: '->puttext;
       node2.id->putint;
       newline;
       'theNew: '->puttext;
       theNew.id->putint;
       newline
   if);
   (if whichEnd then
       (if theNew## <= PatternDiagramNode## then
           theNew[]->aPatternDiagramNode[];
           aPatternDiagramNode.theDiagram->theListDiagram[];
           node2[]->anotherPatternDiagramNode[];
           anotherPatternDiagramNode.theDiagram->theOtherListDiagram[];
           (if theListDiagram## <= FragmentDiagram## then
               'The relation has been attached to a fragment diagram'
                 ->AlertUser;
               false->ok
            else
               (if theListDiagram## <= PatternAttDiagram## then
                   'The relation has been attached to an attributes form diagram'
                     ->AlertUser;
                   false->ok
                else
                   theListDiagram[]->theOADDiagram[];
                   theOtherListDiagram[]->theOtherOADDiagram[];
                   theOADDiagram.theDescriptor->theDesc[];
                   theOtherOADDiagram.theDescriptor->theOtherDesc[];
                   theDesc.father->anAST[];
                   (if anAST## <= betaGram.referenceSpecification## then
                       'The destination is a singular object'->AlertUser;
                       false->ok
                    else
                       theOtherDesc.father->anotherAST[];
                       anAST.father->testAST[];
                       anotherAST.father->testAST2[];
                       (if (testAST[] <> none ) and (testAST2[] <> none ) then
                           (if theListDiagram[] <> theOtherListDiagram[] then
                               (node2[],theNew[])->(pnode1,pnode2);
                               theOtherDesc.getPrefixOpt->anotherAST[];
                               anAST[]->anExp[];
                               anExp.getSon1->theNames[];
                               theNames.getSon1->theNameDcl[];
                               theNameDcl.getNameDecl->aDeclAST[];
                               (if aDeclAST.kind = mps.kinds.unExpanded then
                                   '<<NameAppl>>'->t[]
                                else
                                   theNameDcl.getText->t[]
                               if);
                               (anotherAST[],t)
                                 ->
                                   (anotherPatternDiagramNode.theSifEditor).
                                   parse;
                               theListDiagram.titleNode[]
                                 ->theOtherListDiagram.titleNode.CreateRegion;
                               theOtherListDiagram[]
                                 ->theOtherPatternDeclDiagram[];
                               theDesc[]->theOtherPatternDeclDiagram.thePrefix;
                               theOtherPatternDeclDiagram.theParentNode
                                 ->aDiagramNode[];
                               theDesc[]->aDiagramNode.thePrefix;
                               aDiagramNode.theDeclaration
                                 ->patternDiagrams.InheritanceList.remove;
                               (theOtherDesc.father,theDesc.father)
                                 ->patternDiagrams.InheritanceList.insert;
                               (if theListDiagram.LocalNodes.Last <> none then
                                   (theListDiagram.LocalNodes.Last).elm[]
                                     ->node1[]
                                else
                                   theListDiagram.titleNode[]->node1[]
                               if);
                               (if (ID,true,nd1[],nd2[])->DSRdAttrGetConnEnds
                                then
                                   nd1->theObjectList.Find->object1[];
                                   (if object1[] <> none then
                                       (if object1## <= wedgeNode## then
                                           (object1.getTopParent,object1[],
                                            node1.getTopParent,node1[])
                                             ->setEnds;
                                           false->ok
                                        else
                                           nd2->theObjectList.Find->object2[];
                                           (if object2[] <> none then
                                               (if object2## <= wedgeNode## then
                                                   (object2.getTopParent,
                                                    object2[],
                                                    node1.getTopParent,node1[])
                                                     ->setEnds;
                                                   false->ok
                                               if)
                                           if)
                                       if)
                                   if)
                                else
                                   'GetEnds failed connector ID: '->puttext;
                                   ID->putint;
                                   newline
                               if);
                               (if
                               ((
                                theOtherListDiagram.titleNode.
                                  theSimplePrefixConn).ID,true,nd1[],nd2[])
                                 ->DSRdAttrGetConnEnds then
                                   nd1->theObjectList.Find->object1[];
                                   (if object1[] <> none then
                                       (if object1## <= wedgeNode## then
                                           (object1.getTopParent,object1[],
                                            theListDiagram.titleNode.
                                              getTopParent,
                                            theListDiagram.titleNode[])
                                             ->
                                               (
                                               theOtherListDiagram.titleNode.
                                                 theSimplePrefixConn).setEnds;
                                           theOtherListDiagram.titleNode.
                                             theSimplePrefixConn
                                             ->theSimpleCon[];
                                           (theOtherListDiagram.titleNode[],
                                            node1[])
                                             ->
                                               (theSimpleCon.pnode1,
                                                theSimpleCon.pnode2)
                                        else
                                           nd2->theObjectList.Find->object2[];
                                           (if object2[] <> none then
                                               (if object2## <= wedgeNode## then
                                                   (object2.getTopParent,
                                                    object2[],
                                                    theListDiagram.titleNode.
                                                      getTopParent,
                                                    theListDiagram.titleNode[])
                                                     ->
                                                       (
                                                       theOtherListDiagram.
                                                         titleNode.
                                                         theSimplePrefixConn).
                                                       setEnds;
                                                   theOtherListDiagram.titleNode
                                                   .theSimplePrefixConn
                                                     ->theSimpleCon[];
                                                   (theOtherListDiagram.
                                                      titleNode[],node1[])
                                                     ->
                                                       (theSimpleCon.pnode1,
                                                        theSimpleCon.pnode2)
                                               if)
                                           if)
                                       if)
                                   if)
                                else
                                   'GetEnds failed connector ID: '->puttext;
                                   (
                                   theOtherListDiagram.titleNode.
                                     theSimplePrefixConn).ID->putint;
                                   newline
                               if)
                            else
                               'Source and destination is the same diagram'
                                 ->AlertUser;
                               false->ok
                           if)
                        else
                           'Source and/or destination is a descriptor form diagram'
                             ->AlertUser;
                           false->ok
                       if)
                   if)
               if)
           if)
        else
           'The relation has been attached to a node that is not part of a pattern diagram'
             ->AlertUser;
           false->ok
       if)
    else
       (if theNew## <= PatternDiagramNode## then
           node2[]->oldPatternDiagramNode[];
           node1[]->aPatternDiagramNode[];
           aPatternDiagramNode.theDiagram->theListDiagram[];
           theNew[]->anotherPatternDiagramNode[];
           anotherPatternDiagramNode.theDiagram->theOtherListDiagram[];
           (if theOtherListDiagram## <= FragmentDiagram## then
               'The relation has been attached to a fragment diagram'
                 ->AlertUser;
               false->ok
            else
               (if theOtherListDiagram## <= PatternAttDiagram## then
                   'The relation has been attached to an attributes form diagram'
                     ->AlertUser;
                   false->ok
                else
                   oldPatternDiagramNode.theDiagram->oldOADDiagram[];
                   oldOADDiagram.theDescriptor->oldDesc[];
                   theListDiagram[]->theOADDiagram[];
                   theOtherListDiagram[]->theOtherOADDiagram[];
                   theOADDiagram.theDescriptor->theDesc[];
                   theOtherOADDiagram.theDescriptor->theOtherDesc[];
                   theDesc.father->anAST[];
                   (if anAST## <= betaGram.referenceSpecification## then
                       'The destination is a singular object'->AlertUser;
                       false->ok
                    else
                       theOtherDesc.father->anotherAST[];
                       anAST.father->testAST[];
                       anotherAST.father->testAST2[];
                       (if (testAST[] <> none ) and (testAST2[] <> none ) then
                           (if theListDiagram[] <> theOtherListDiagram[] then
                               (theNew[],node1[])->(pnode1,pnode2);
                               theOtherDesc.getPrefixOpt->anotherAST[];
                               anAST[]->anExp[];
                               anExp.getSon1->theNames[];
                               theNames.getSon1->theNameDcl[];
                               theNameDcl.getNameDecl->aDeclAST[];
                               (if aDeclAST.kind = mps.kinds.unExpanded then
                                   '<<NameAppl>>'->t[]
                                else
                                   theNameDcl.getText->t[]
                               if);
                               (anotherAST[],t)
                                 ->
                                   (anotherpatternDiagramNode.theSifEditor).
                                   parse;
                               (if (ID,true,nd1[],nd2[])->DSRdAttrGetConnEnds
                                then
                                   nd1->theObjectList.Find->object1[];
                                   (if object1[] <> none then
                                       (if object1## <= wedgeNode## then
                                           object1[]->wedge[]
                                        else
                                           nd2->theObjectList.Find->object2[];
                                           (if object2[] <> none then
                                               (if object2## <= wedgeNode## then
                                                   object2[]->wedge[]
                                               if)
                                           if)
                                       if)
                                   if)
                                else
                                   'GetEnds failed connector ID: '->puttext;
                                   ID->putint;
                                   newline
                               if);
                               delete;
                               (if wedge[] <> none then wedge.delete if);
                               false->ok;
                               (if theListDiagram.LocalNodes.Last <> none then
                                   (theListDiagram.LocalNodes.Last).elm[]
                                     ->node1[]
                                else
                                   theListDiagram.titleNode[]->node1[]
                               if);
                               &theOtherListDiagram.PrefixConnector[]->theCon[];
                               (theOtherListDiagram.titleNode[],node1[])
                                 ->theCon.PrefixNew;
                               theListDiagram.titleNode[]
                                 ->theOtherListDiagram.titleNode.CreateRegion;
                               (if theOtherListDiagram.titleNode.thePrefixConn
                               <> none then
                                   (if
                                   ((theOtherListDiagram.titleNode.thePrefixConn
                                    ).ID,true,nd1[],nd2[])->DSRdAttrGetConnEnds
                                    then
                                       nd1->theObjectList.Find->object1[];
                                       (if object1[] <> none then
                                           (if object1## <= wedgeNode## then
                                               object1[]->wedge[]
                                            else
                                               nd2->theObjectList.Find
                                                 ->object2[];
                                               (if object2[] <> none then
                                                   (if object2## <= wedgeNode##
                                                    then
                                                       object2[]->wedge[]
                                                   if)
                                               if)
                                           if)
                                       if)
                                    else
                                       'GetEnds failed connector ID: '->puttext;
                                       (
                                       theOtherListDiagram.titleNode.
                                         thePrefixConn).ID->putint;
                                       newline
                                   if);
                                   (theOtherListDiagram.titleNode.thePrefixConn)
                                     .delete;
                                   (if wedge[] <> none then wedge.delete if)
                               if);
                               oldPatternDiagramNode.unMakeRegion;
                               none ->oldOADDiagram.titleNode.thePrefixConn;
                               oldOADDiagram[]->oldPatternDeclDiagram[];
                               none ->oldPatternDeclDiagram.thePrefix;
                               oldPatternDeclDiagram.theParentNode
                                 ->aDiagramNode[];
                               none ->aDiagramNode.thePrefix;
                               oldOADDiagram.theParentNode->aDiagramNode[];
                               aDiagramNode.theDeclaration
                                 ->patternDiagrams.InheritanceList.remove;
                               theCon[]
                                 ->theOtherListDiagram.titleNode.thePrefixConn;
                               theOtherListDiagram[]
                                 ->theOtherPatternDeclDiagram[];
                               theDesc[]->theOtherPatternDeclDiagram.thePrefix;
                               theOtherPatternDeclDiagram.theParentNode
                                 ->aDiagramNode[];
                               theDesc[]->aDiagramNode.thePrefix;
                               (theOtherDesc.father,theDesc.father)
                                 ->patternDiagrams.InheritanceList.insert;
                               oldDesc.getPrefixOpt->anotherAST[];
                               ''->t[];
                               (anotherAST[],t)
                                 ->(oldPatternDiagramNode.theSifEditor).parse;
                               (if
                               ((oldOADDiagram.titleNode.theSimplePrefixConn).
                                ID,true,nd1[],nd2[])->DSRdAttrGetConnEnds then
                                   nd1->theObjectList.Find->object1[];
                                   (if object1[] <> none then
                                       (if object1## <= wedgeNode## then
                                           object1[]->wedge[]
                                        else
                                           nd2->theObjectList.Find->object2[];
                                           (if object2[] <> none then
                                               (if object2## <= wedgeNode## then
                                                   object2[]->wedge[]
                                               if)
                                           if)
                                       if)
                                   if)
                                else
                                   'GetEnds failed connector ID: '->puttext;
                                   (oldOADDiagram.titleNode.theSimplePrefixConn)
                                     .ID->putint;
                                   newline
                               if);
                               (oldOADDiagram.titleNode.theSimplePrefixConn).
                               delete;
                               (if wedge[] <> none then wedge.delete if);
                               &theOtherListDiagram.SimplePrefixConnector[]
                                 ->theSimpleCon[];
                               (theOtherListDiagram.titleNode[],
                                theListDiagram.titleNode[])
                                 ->theSimpleCon.prefixNew;
                               (if
                               theOtherListDiagram.titleNode.theSimplePrefixConn
                               <> none then
                                   (if
                                   ((
                                    theOtherListDiagram.titleNode.
                                      theSimplePrefixConn).ID,true,nd1[],nd2[])
                                     ->DSRdAttrGetConnEnds then
                                       nd1->theObjectList.Find->object1[];
                                       (if object1[] <> none then
                                           (if object1## <= wedgeNode## then
                                               object1[]->wedge[]
                                            else
                                               nd2->theObjectList.Find
                                                 ->object2[];
                                               (if object2[] <> none then
                                                   (if object2## <= wedgeNode##
                                                    then
                                                       object2[]->wedge[]
                                                   if)
                                               if)
                                           if)
                                       if)
                                    else
                                       'GetEnds failed connector ID: '->puttext;
                                       (
                                       theOtherListDiagram.titleNode.
                                         theSimplePrefixConn).ID->putint;
                                       newline
                                   if);
                                   (
                                   theOtherListDiagram.titleNode.
                                     theSimplePrefixConn).delete;
                                   (if wedge[] <> none then wedge.delete if)
                               if);
                               none
                                 ->oldOADDiagram.titleNode.theSimplePrefixConn;
                               theSimpleCon[]
                                 ->
                                   theOtherListDiagram.titleNode.
                                     theSimplePrefixConn
                            else
                               'Source and destination is the same diagram'
                                 ->AlertUser;
                               false->ok
                           if)
                        else
                           'Source and/or destination is a descriptor form diagram'
                             ->AlertUser;
                           false->ok
                       if)
                   if)
               if)
           if)
        else
           'The relation has been attached to a node that is not part of a pattern diagram'
             ->AlertUser;
           false->ok
       if)
   if)
#)  

-- SimplePrefixConnectorPrefixNew: DoPart --
do
     (#
        x,y,w,h: @Integer;
        wed: ^WedgeNode;
        thePatternDiagramNode: ^PatternDiagramNode;
        
     do
        node1.geometry->(x,y,w,h);
        node1[]->THIS(OADPage).scrollIntoView;
        &WedgeNode[]->wed[];
        (x,y-(h div 2)-1,10,10)->wed.new;
        (270,90)->wed.angles;
        false->wed.selectable;
        false->wed.sizeable;
        node2[]->thePatternDiagramNode[];
        (wed[],(thePatternDiagramNode.theDiagram).titleNode[])->new;
        node1[]->pnode1;
        node2[]->pnode2;
        pnode1->wed.createRegion;
        (thePatternDiagramNode.theDiagram).titleNode[]->pnode2;
        (if not gppProp.specializations then
            false->BorderVisible; false->wed.BorderVisible; false->selectable
         else
            (if gppProp.showAttributes then
                false->BorderVisible;
                false->wed.BorderVisible;
                false->selectable
            if)
        if);
        
     #)  

-- SimplePrefixConnectorDelete: DoPart --
do (if wedge[] <> none then wedge.delete if)  

-- SimplePrefixConnectorOnDelete: DoPart --
do
     (#
        node1,node2,dummy: ^PatternDiagramNode;
        theTitleNode: ^theOADDiagram.title;
        theDiagramNode: ^theOADDiagram.DiagramNode;
        titleText: @Text;
        theOADDiagram,theOtherOADDiagram: ^OADDiagram;
        thePatternDeclDiagram: ^PatternDeclDiagram;
        anAST: ^MPS.AST;
        theDesc: ^betaGram.ObjectDescriptor;
        theMainPart: ^betaGram.MainPart;
        nd1,nd2: @integerRef;
        object1,object2: ^designObject;
        theParentNode: ^PatternDiagramNode;
        theParentDiagram: ^ListDiagram;
        theParentDiagramNode: ^theParentDiagram.DiagramNode;
        t: ^text;
        wed: ^WedgeNode
     do
        (if switch[1] then 'SimplePrefixConnector onDelete!'->putline if);
        (if (ID,true,nd1[],nd2[])->DSRdAttrGetConnEnds then
            nd1->theObjectList.Find->object1[];
            (if object1[] <> none then
                (if object1## <= wedgeNode## then
                    object1[]->wedge[]
                 else
                    nd2->theObjectList.Find->object2[];
                    (if object2[] <> none then
                        (if object2## <= wedgeNode## then
                            object2[]->wedge[]
                        if)
                    if)
                if)
            if)
         else
            'GetEnds failed connector ID: '->puttext; ID->putint; newline
        if);
        true->getEnds->(node1[],node2[]);
        node1.theDiagram->theOADDiagram[];
        node2.theDiagram->theOtherOADDiagram[];
        node1[]->theTitleNode[];
        none ->theTitleNode.theSimplePrefixConn;
        theOADDiagram[]->thePatternDeclDiagram[];
        none ->thePatternDeclDiagram.thePrefix;
        theOADDiagram.theParentNode->theDiagramNode[];
        none ->theDiagramNode.thePrefix;
        theOADDiagram.theParentNode->theParentNode[];
        theParentNode.theDiagram->theParentDiagram[];
        theParentNode[]->theParentDiagramNode[];
        node1.unmakeRegion;
        theOADDiagram.theDescriptor->theDesc[];
        theDesc.getPrefixOpt->anAST[];
        ''->t[];
        (anAST[],t)->(node2.theSifEditor).parse;
        (if theTitleNode.thePrefixConn <> none then
            (if
            ((titleNode.thePrefixConn).ID,true,nd1[],nd2[])->DSRdAttrGetConnEnds
             then
                nd1->theObjectList.Find->object1[];
                (if object1[] <> none then
                    (if object1## <= wedgeNode## then
                        object1[]->wed[]
                     else
                        nd2->theObjectList.Find->object2[];
                        (if object2[] <> none then
                            (if object2## <= wedgeNode## then
                                object2[]->wed[]
                            if)
                        if)
                    if)
                if)
             else
                'GetEnds failed connector ID: '->puttext;
                (theTitleNode.thePrefixConn).ID->putint;
                newline
            if);
            (theTitleNode.thePrefixConn).delete;
            none ->theTitleNode.thePrefixConn;
            (if wed[] <> none then wed.delete if)
        if)
     #)  

-- SimplePrefixConnectorOnReattach: DoPart --
do
     (#
        node1,node2: ^DesignObject;
        aPatternDiagramNode,anotherPatternDiagramNode,oldPatternDiagramNode:
          ^PatternDiagramNode;
        theListDiagram,theOtherListDiagram: ^ListDiagram;
        theOADDiagram,theOtherOADDiagram,oldOADDiagram: ^OADDiagram;
        theOtherPatternDeclDiagram,oldPatternDeclDiagram: ^PatternDeclDiagram;
        aDiagramNode: ^theOtherListDiagram.DiagramNode;
        t: ^Text;
        titleText: @text;
        theDesc,theOtherDesc,oldDesc: ^betaGram.ObjectDescriptor;
        anAST,anotherAST,testAST,testAST2,aDeclAST: ^MPS.AST;
        anExp: ^mps.expanded;
        theNames: ^betaGram.Names;
        theNameDcl: ^betaGram.NameDcl;
        theMainPart: ^betaGram.MainPart;
        existingConnectors: ^ObjectList;
        aCon: ^Connector;
        theCon: ^theOtherListDiagram.PrefixConnector;
        theSimpleCon: ^theOtherListDiagram.SimplePrefixConnector;
        nd1,nd2: @integerRef;
        object1,object2: ^designObject
     do
        true->getEnds->(node2[],node1[]);
        (if switch[1] then
            'InheritanceConnectorOnReattach!'->putline;
            'node1: '->puttext;
            node1.id->putint;
            newline;
            'node2: '->puttext;
            node2.id->putint;
            newline;
            'theNew: '->puttext;
            theNew.id->putint;
            newline
        if);
        (if whichEnd then
            (if theNew## <= PatternDiagramNode## then
                theNew[]->aPatternDiagramNode[];
                aPatternDiagramNode.theDiagram->theListDiagram[];
                node2[]->anotherPatternDiagramNode[];
                anotherPatternDiagramNode.theDiagram->theOtherListDiagram[];
                (if theListDiagram## <= FragmentDiagram## then
                    'The relation has been attached to a fragment diagram'
                      ->AlertUser;
                    false->ok
                 else
                    (if theListDiagram## <= PatternAttDiagram## then
                        'The relation has been attached to an attributes form diagram'
                          ->AlertUser;
                        false->ok
                     else
                        theListDiagram[]->theOADDiagram[];
                        theOtherListDiagram[]->theOtherOADDiagram[];
                        theOADDiagram.theDescriptor->theDesc[];
                        theOtherOADDiagram.theDescriptor->theOtherDesc[];
                        theDesc.father->anAST[];
                        (if anAST## <= betaGram.referenceSpecification## then
                            'The destination is a singular object'->AlertUser;
                            false->ok
                         else
                            theOtherDesc.father->anotherAST[];
                            anAST.father->testAST[];
                            anotherAST.father->testAST2[];
                            (if (testAST[] <> none ) and (testAST2[] <> none )
                             then
                                (if theListDiagram[] <> theOtherListDiagram[]
                                 then
                                    (node2[],theNew[])->(pnode1,pnode2);
                                    theOtherDesc.getPrefixOpt->anotherAST[];
                                    anAST[]->anExp[];
                                    anExp.getSon1->theNames[];
                                    theNames.getSon1->theNameDcl[];
                                    theNameDcl.getNameDecl->aDeclAST[];
                                    (if aDeclAST.kind = mps.kinds.unExpanded
                                     then
                                        '<<NameAppl>>'->t[]
                                     else
                                        theNameDcl.getText->t[]
                                    if);
                                    (anotherAST[],t)
                                      ->
                                        (anotherPatternDiagramNode.theSifEditor)
                                          .parse;
                                    theListDiagram.titleNode[]
                                      ->
                                        theOtherListDiagram.titleNode.
                                          CreateRegion;
                                    theOtherListDiagram[]
                                      ->theOtherPatternDeclDiagram[];
                                    theDesc[]
                                      ->theOtherPatternDeclDiagram.thePrefix;
                                    theOtherPatternDeclDiagram.theParentNode
                                      ->aDiagramNode[];
                                    theDesc[]->aDiagramNode.thePrefix;
                                    aDiagramNode.theDeclaration
                                      ->patternDiagrams.InheritanceList.remove;
                                    (theOtherDesc.father,theDesc.father)
                                      ->patternDiagrams.InheritanceList.insert;
                                    (if
                                    ((
                                     theOtherListDiagram.titleNode.thePrefixConn
                                     ).ID,true,nd1[],nd2[])->DSRdAttrGetConnEnds
                                     then
                                        (if theListDiagram.LocalNodes.Last <>
                                        none then
                                            (theListDiagram.LocalNodes.Last).
                                            elm[]->node1[]
                                         else
                                            theListDiagram.titleNode[]->node1[]
                                        if);
                                        nd1->theObjectList.Find->object1[];
                                        (if object1[] <> none then
                                            (if object1## <= wedgeNode## then
                                                (object1.getTopParent,object1[],
                                                 node1.getTopParent,node1[])
                                                  ->
                                                    (
                                                    theOtherListDiagram.
                                                      titleNode.thePrefixConn).
                                                    setEnds;
                                                theOtherListDiagram.titleNode.
                                                  thePrefixConn->theCon[];
                                                (theOtherListDiagram.
                                                   titleNode[],node1[])
                                                  ->
                                                    (theCon.pnode1,
                                                     theCon.pnode2)
                                             else
                                                nd2->theObjectList.Find
                                                  ->object2[];
                                                (if object2[] <> none then
                                                    (if object2## <= wedgeNode##
                                                     then
                                                        (object2.getTopParent,
                                                         object2[],
                                                         node1.getTopParent,
                                                         node1[])
                                                          ->
                                                            (
                                                            theOtherListDiagram.
                                                              titleNode.
                                                              thePrefixConn).
                                                            setEnds;
                                                        theOtherListDiagram.
                                                          titleNode.
                                                          thePrefixConn
                                                          ->theCon[];
                                                        (theOtherListDiagram.
                                                           titleNode[],node1[])
                                                          ->
                                                            (theCon.pnode1,
                                                             theCon.pnode2)
                                                    if)
                                                if)
                                            if)
                                        if)
                                     else
                                        'GetEnds failed connector ID: '
                                          ->puttext;
                                        (
                                        theOtherListDiagram.titleNode.
                                          thePrefixConn).ID->putint;
                                        newline
                                    if)
                                 else
                                    'Source and destination is the same diagram'
                                      ->AlertUser;
                                    false->ok
                                if)
                             else
                                'Source and/or destination is a descriptor form diagram'
                                  ->AlertUser;
                                false->ok
                            if)
                        if)
                    if)
                if)
             else
                'The relation has been attached to a node that is not part of a pattern diagram'
                  ->AlertUser;
                false->ok
            if)
         else
            (if theNew## <= PatternDiagramNode## then
                node2[]->oldPatternDiagramNode[];
                node1[]->aPatternDiagramNode[];
                aPatternDiagramNode.theDiagram->theListDiagram[];
                theNew[]->anotherPatternDiagramNode[];
                anotherPatternDiagramNode.theDiagram->theOtherListDiagram[];
                (if theOtherListDiagram## <= FragmentDiagram## then
                    'The relation has been attached to a fragment diagram'
                      ->AlertUser;
                    false->ok
                 else
                    (if theOtherListDiagram## <= PatternAttDiagram## then
                        'The relation has been attached to an attributes form diagram'
                          ->AlertUser;
                        false->ok
                     else
                        oldPatternDiagramNode.theDiagram->oldOADDiagram[];
                        oldOADDiagram.theDescriptor->oldDesc[];
                        theListDiagram[]->theOADDiagram[];
                        theOtherListDiagram[]->theOtherOADDiagram[];
                        theOADDiagram.theDescriptor->theDesc[];
                        theOtherOADDiagram.theDescriptor->theOtherDesc[];
                        theDesc.father->anAST[];
                        (if anAST## <= betaGram.referenceSpecification## then
                            'The destination is a singular object'->AlertUser;
                            false->ok
                         else
                            theOtherDesc.father->anotherAST[];
                            anAST.father->testAST[];
                            anotherAST.father->testAST2[];
                            (if (testAST[] <> none ) and (testAST2[] <> none )
                             then
                                (if theListDiagram[] <> theOtherListDiagram[]
                                 then
                                    (theNew[],node1[])->(pnode1,pnode2);
                                    theOtherDesc.getPrefixOpt->anotherAST[];
                                    anAST[]->anExp[];
                                    anExp.getSon1->theNames[];
                                    theNames.getSon1->theNameDcl[];
                                    theNameDcl.getNameDecl->aDeclAST[];
                                    (if aDeclAST.kind = mps.kinds.unExpanded
                                     then
                                        '<<NameAppl>>'->t[]
                                     else
                                        theNameDcl.getText->t[]
                                    if);
                                    (anotherAST[],t)
                                      ->
                                        (anotherpatternDiagramNode.theSifEditor)
                                          .parse;
                                    (if
                                    (ID,true,nd1[],nd2[])->DSRdAttrGetConnEnds
                                     then
                                        nd1->theObjectList.Find->object1[];
                                        (if object1[] <> none then
                                            (if object1## <= wedgeNode## then
                                                object1[]->wedge[]
                                             else
                                                nd2->theObjectList.Find
                                                  ->object2[];
                                                (if object2[] <> none then
                                                    (if object2## <= wedgeNode##
                                                     then
                                                        object2[]->wedge[]
                                                    if)
                                                if)
                                            if)
                                        if)
                                     else
                                        'GetEnds failed connector ID: '
                                          ->puttext;
                                        ID->putint;
                                        newline
                                    if);
                                    delete;
                                    (if wedge[] <> none then
                                        wedge.delete
                                    if);
                                    false->ok;
                                    (if theListDiagram.LocalNodes.Last <> none
                                     then
                                        (theListDiagram.LocalNodes.Last).elm[]
                                          ->node1[]
                                     else
                                        theListDiagram.titleNode[]->node1[]
                                    if);
                                    &theOtherListDiagram.PrefixConnector[]
                                      ->theCon[];
                                    (theOtherListDiagram.titleNode[],node1[])
                                      ->theCon.PrefixNew;
                                    theListDiagram.titleNode[]
                                      ->
                                        theOtherListDiagram.titleNode.
                                          CreateRegion;
                                    (if
                                    theOtherListDiagram.titleNode.thePrefixConn
                                    <> none then
                                        (if
                                        ((
                                         theOtherListDiagram.titleNode.
                                           thePrefixConn).ID,true,nd1[],nd2[])
                                          ->DSRdAttrGetConnEnds then
                                            nd1->theObjectList.Find->object1[];
                                            (if object1[] <> none then
                                                (if object1## <= wedgeNode##
                                                 then
                                                    object1[]->wedge[]
                                                 else
                                                    nd2->theObjectList.Find
                                                      ->object2[];
                                                    (if object2[] <> none then
                                                        (if object2## <=
                                                        wedgeNode## then
                                                            object2[]->wedge[]
                                                        if)
                                                    if)
                                                if)
                                            if)
                                         else
                                            'GetEnds failed connector ID: '
                                              ->puttext;
                                            (
                                            theOtherListDiagram.titleNode.
                                              thePrefixConn).ID->putint;
                                            newline
                                        if);
                                        (
                                        theOtherListDiagram.titleNode.
                                          thePrefixConn).delete;
                                        (if wedge[] <> none then
                                            wedge.delete
                                        if)
                                    if);
                                    oldPatternDiagramNode.unMakeRegion;
                                    none
                                      ->oldOADDiagram.titleNode.thePrefixConn;
                                    oldOADDiagram[]->oldPatternDeclDiagram[];
                                    none ->oldPatternDeclDiagram.thePrefix;
                                    oldPatternDeclDiagram.theParentNode
                                      ->aDiagramNode[];
                                    none ->aDiagramNode.thePrefix;
                                    oldOADDiagram.theParentNode->aDiagramNode[];
                                    aDiagramNode.theDeclaration
                                      ->patternDiagrams.InheritanceList.remove;
                                    theCon[]
                                      ->
                                        theOtherListDiagram.titleNode.
                                          thePrefixConn;
                                    theOtherListDiagram[]
                                      ->theOtherPatternDeclDiagram[];
                                    theDesc[]
                                      ->theOtherPatternDeclDiagram.thePrefix;
                                    theOtherPatternDeclDiagram.theParentNode
                                      ->aDiagramNode[];
                                    theDesc[]->aDiagramNode.thePrefix;
                                    (theOtherDesc.father,theDesc.father)
                                      ->patternDiagrams.InheritanceList.insert;
                                    oldDesc.getPrefixOpt->anotherAST[];
                                    ''->t[];
                                    (anotherAST[],t)
                                      ->
                                        (oldPatternDiagramNode.theSifEditor).
                                        parse;
                                    (if
                                    ((
                                     oldOADDiagram.titleNode.theSimplePrefixConn
                                     ).ID,true,nd1[],nd2[])->DSRdAttrGetConnEnds
                                     then
                                        nd1->theObjectList.Find->object1[];
                                        (if object1[] <> none then
                                            (if object1## <= wedgeNode## then
                                                object1[]->wedge[]
                                             else
                                                nd2->theObjectList.Find
                                                  ->object2[];
                                                (if object2[] <> none then
                                                    (if object2## <= wedgeNode##
                                                     then
                                                        object2[]->wedge[]
                                                    if)
                                                if)
                                            if)
                                        if)
                                     else
                                        'GetEnds failed connector ID: '
                                          ->puttext;
                                        (
                                        oldOADDiagram.titleNode.
                                          theSimplePrefixConn).ID->putint;
                                        newline
                                    if);
                                    (oldOADDiagram.titleNode.theSimplePrefixConn
                                    ).delete;
                                    (if wedge[] <> none then
                                        wedge.delete
                                    if);
                                    &theOtherListDiagram.SimplePrefixConnector[]
                                      ->theSimpleCon[];
                                    (theOtherListDiagram.titleNode[],
                                     theListDiagram.titleNode[])
                                      ->theSimpleCon.prefixNew;
                                    (if
                                    theOtherListDiagram.titleNode.
                                      theSimplePrefixConn <> none then
                                        (if
                                        ((
                                         theOtherListDiagram.titleNode.
                                           theSimplePrefixConn).ID,true,nd1[],
                                         nd2[])->DSRdAttrGetConnEnds then
                                            nd1->theObjectList.Find->object1[];
                                            (if object1[] <> none then
                                                (if object1## <= wedgeNode##
                                                 then
                                                    object1[]->wedge[]
                                                 else
                                                    nd2->theObjectList.Find
                                                      ->object2[];
                                                    (if object2[] <> none then
                                                        (if object2## <=
                                                        wedgeNode## then
                                                            object2[]->wedge[]
                                                        if)
                                                    if)
                                                if)
                                            if)
                                         else
                                            'GetEnds failed connector ID: '
                                              ->puttext;
                                            (
                                            theOtherListDiagram.titleNode.
                                              theSimplePrefixConn).ID->putint;
                                            newline
                                        if);
                                        (
                                        theOtherListDiagram.titleNode.
                                          theSimplePrefixConn).delete;
                                        (if wedge[] <> none then
                                            wedge.delete
                                        if)
                                    if);
                                    none
                                      ->
                                        oldOADDiagram.titleNode.
                                          theSimplePrefixConn;
                                    theSimpleCon[]
                                      ->
                                        theOtherListDiagram.titleNode.
                                          theSimplePrefixConn
                                 else
                                    'Source and destination is the same diagram'
                                      ->AlertUser;
                                    false->ok
                                if)
                             else
                                'Source and/or destination is a descriptor form diagram'
                                  ->AlertUser;
                                false->ok
                            if)
                        if)
                    if)
                if)
             else
                'The relation has been attached to a node that is not part of a pattern diagram'
                  ->AlertUser;
                false->ok
            if)
        if)
     #)  

