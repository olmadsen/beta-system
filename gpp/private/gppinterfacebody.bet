ORIGIN 'diagramattributes';
LIB_ITEM 'gpp';
-- gppDirChar: DoPart --
do DirectoryChar->t.put  

-- prependCurrentPath: DoPart --
do
   name.lgth->len;
   DirectoryChar->name.findAll (#  do (if inx < len then inx->i if) #);
   (if i = 0 then mps.thePathHandler.currentDirectory->name.prepend if)  

-- InitGPP: Descriptor --
(#  do  #)  

-- MarkNodeDisplay: Descriptor --
(# 
do
   (pos.x,pos.y,gppProp.marksize,gppProp.marksize)->new;
   theNode[]->thePatternDiagramNode;
   THIS(MarkNode)[]->(thePatternDiagramNode).theMarkNode;
   false->sizeable;
   
#)  

-- MarkNodeOnInit: Descriptor --
(# 
do
   UDPrivate.UDMarkNode->UserDataInit;
   thePatternDiagramNode.Init;
   6->theText.size;
   false->moveable;
   false->sizeable;
   (if not initialisingSaved then theNode[]->CreateRegion if);
   
#)  

-- ListDiagramTitleNodeInsertDiagramNode: DoPart --
do
     (# addAfterNode: ^PatternDiagramNode; ld: ^ListDiagram; x,y: @integer
     do
        (if switch[60] then
              (# aText: @text
              do
                 'InsertDiagramNode - prepending in localNodes: '->puttext;
                 patterndiagrams.newNode.theText.get->aText;
                 aText[]->putline
              #)
        if);
        (if localNodeOrder = gppProp.inCompartments then
            (if
            (patterndiagrams.newNode.attributeType = gppProp.SimpleAttribute) or
            (attributes.empty and
             (patterndiagrams.newNode.attributeType = gppProp.operation)) or
            (attributes.empty and operations.empty and
             (patterndiagrams.newNode.attributeType = gppProp.localClass)) then
                titleNode[]->addAfterNode[]
             else
                (if patternDiagrams.newNode.attributeType
                 // gppProp.operation then
                    (if not operations.empty then
                        (operations.last).elm[]->addAfterNode[]
                     else
                        (if not attributes.empty then
                            (attributes.last).elm[]->addAfterNode[]
                         else
                            titleNode[]->addAfterNode[]
                        if)
                    if)
                 // gppProp.localClass then
                    (if not localClasses.empty then
                        (localClasses.last).elm[]->addAfterNode[]
                     else
                        (if not operations.empty then
                            (operations.last).elm[]->addAfterNode[]
                         else
                            (attributes.last).elm[]->addAfterNode[]
                        if)
                    if)
                if)
            if);
            (if not (addAfterNode[] = titleNode[]) then
                (patterndiagrams.newNode[],addAfterNode[]->localNodes.at)
                  ->localNodes.insertAfter
             else
                patterndiagrams.newNode[]->localNodes.prepend;
                titleNode.center->(x,y);
                (x,y+gppProp.height)->patterndiagrams.newNode.center
            if);
            theDiagram->ld[];
            ld.localnodes.scan
              (# moveDown: @boolean; x,y: @integer; 
              do
                 (if moveDown or
                 ((addAfterNode[] = ld.titleNode[]) and
                  (not (current[] = patterndiagrams.newNode[]))) then
                     current.center->(x,y); (x,y+gppProp.height)->current.center
                  else
                     (if current[] = addAfterNode[] then true->moveDown if)
                 if)
              #)
         else
            patterndiagrams.newNode[]->localNodes.prepend
        if)
     #)  

-- titleGetFragment: Descriptor --
(# fn: ^FragmentNode; 
do
   (if theFragmentNode <> none
    // true then theFragmentNode->fn[]; fn.theFragment->f[]; 
    else
       'DiagramNode: GetFragment: no FragmentNode'->screen.putline
   if)
#)  

-- ListDiagramTitleDump: DoPart --
do
   'ListDiagram.titleNode'->nodetype[];
   '********theSurroundBox********'->putline;
   (if theSurroundBox <> none then
       (theSurroundBox).ID->putint; newline
    else
       'is NONE!'->putline
   if);
   '********MaxHeight********'->putline;
   MaxHeight->putint;
   newline;
   '********MaxWidth********'->putline;
   MaxWidth->putint;
   newline;
   INNER dump  

-- SurroundBoxOnInit: DoPart --
do UDPrivate.UDSurroundBox->UserDataInit; false->selectable; false->sizeable  

-- UserdataLabelNodeVisibleSet: DoPart --
do
   (if v then
       (if invisibleText <> none then
           invisibleText->help[]; help->theText.set; none ->invisibleText
       if);
       true->selectable
    else
       (if theText.length > 0 then
           theText.get->t; t[]->invisibleText; theText.clear
       if);
       false->selectable
   if)  

-- UserDataLabelNodeVisibleGet: DoPart --
do (if invisibleText = none then true->v else  if)  

-- UserDataLabelNodeOnInit: DoPart --
do
   UDPrivate.UDLabelNode->UserDataInit;
   invisibleText.init;
   gppProp.fontSize->theText.size  

-- DeletableConnectorVisibleGet: DoPart --
do BorderVisible->v; INNER get  

-- DeletableConnectorVisibleSet: DoPart --
do
   v->borderVisible;
   v->selectable;
   (if v then
       (if invisibleText <> none then
           invisibleText->help[]; help->theText.set; none ->invisibleText
       if)
    else
       (if theText.length > 0 then
           theText.get->t; t[]->invisibleText; theText.clear
       if)
   if);
   INNER set  

-- deletableConnectorOnDelete: DoPart --
do
   gppProp.busy->gppProp.globalinteractivemode;
   INNER ;
   gppProp.noGlobalinteractivemode->gppProp.globalinteractivemode;
   autosave  

-- DeletableConnectorGetOtherEnd: Descriptor --
(# node1,node2: ^IDObject
do
   true->getEnds->(node1[],node2[]);
   (if (Start[] = node1[]) or (Start[] = node2[]) then
       (if Start[] = node1[] then
           node2[]->OtherEnd[]
        else
           node1[]->OtherEnd[]
       if)
    else
       (if switch[1] then
           'GetOtherEnd: Start is not in either end'->putline
       if)
   if)
#)  

-- PrefixConnectorOnInit: DoPart --
do
     (#
        aPatternDiagramNode,anotherPatternDiagramNode: ^PatternDiagramNode;
        theListDiagram,theOtherListDiagram: ^ListDiagram;
        theOADDiagram,theOtherOADDiagram,superDiagram: ^OADDiagram;
        theOtherPatternDeclDiagram: ^PatternDeclDiagram;
        aDiagramNode: ^theOtherListDiagram.DiagramNode;
        t: ^Text;
        titleText: @text;
        theDesc,theOtherDesc: ^betaGram.ObjectDescriptor;
        anAST,anotherAST,testAST,testAST2,aDeclAST: ^MPS.AST;
        anExp: ^mps.expanded;
        theNames: ^betaGram.Names;
        theNameDcl: ^betaGram.NameDcl;
        theMainPart: ^betaGram.MainPart;
        node1,node2: ^designObject;
        didCreate: @boolean;
        countIsNotInCircle: @integer;
        isNotInCircle:
          (#
             aPDNode: ^PatternDiagramNode;
             start,end: ^ListDiagram;
             s1,e1: ^node;
             val: @boolean;
             
          enter (start[],end[])
          do
             true->val;
             (if end.titlenode.thePrefixConn <> none then
                 true->(end.titlenode.thePrefixConn).getEnds->(s1[],e1[]);
                 (if (s1[] <> none ) and (e1[] <> none ) then
                     (if ((s1[]->BoxToNode->s1[]) <> none ) and
                     ((e1[]->BoxToNode->e1[]) <> none ) then
                         (if (s1## <= PatternDiagramNode##) and
                         (e1## <= PatternDiagramNode##) then
                             e1[]->aPDNode[];
                             aPDNode.theDiagram->end[];
                             (if (end[] = start[]) then
                                 false->val
                              else
                                 ((start[],end[])->isNotInCircle)->val; 
                             if)
                         if);
                         
                     if)
                 if)
             if)
          exit val
          #)
     do
        (if switch[50] or switch[30] then
            'PrefixConnector onInit!'->putline
        if);
        UDPrivate.UDPrefixConnector->UserDataInit;
        (if not initialisingSaved then
            false->repair;
            gppProp.busy->gppProp.globalInteractivemode;
            (if not gppProp.specializations then
                false->BorderVisible; false->selectable
            if);
            true->getEnds->(node2[],node1[]);
            (if (node1[] <> none ) and (node2[] <> none ) then
                (if ((node1[]->BoxToNode->node1[]) <> none ) and
                ((node2[]->BoxToNode->node2[]) <> none ) then
                    (if (node1## <= PatternDiagramNode##) and
                    (node2## <= PatternDiagramNode##) then
                        node1[]->aPatternDiagramNode[];
                        aPatternDiagramNode.theDiagram->theListDiagram[];
                        (if switch[50] or switch[30] then
                            '1: PrefixConnectorOnInit: destination surroundBox.getParent%s\n'
                              ->putformat
                                (# parent: ^designobject
                                do
                                   (theListDiagram.thesurroundBox).getParent
                                     ->parent[];
                                   (if parent[] <> none then
                                       '<>none'->s
                                    else
                                       '=none'->s
                                   if)
                                #)
                        if);
                        node2[]->anotherPatternDiagramNode[];
                        anotherPatternDiagramNode.theDiagram
                          ->theOtherListDiagram[];
                        (if (anotherPatternDiagramNode.theSifEditor).isReadOnly
                         then
                            (anotherPatternDiagramNode.theDiagram).titleText[]
                              ->t[];
                            ' is read-only - can not generate code for specialization'
                              ->t.puttext;
                            t[]->alertUser
                         else
                            (if (theListDiagram## <= FragmentDiagram##) or
                            (theOtherListDiagram## <= FragmentDiagram##) then
                                'Source and/or destination is a fragment diagram'
                                  ->AlertUser
                             else
                                (if (theListDiagram## <= PatternAttDiagram##) or
                                (theOtherListDiagram## <= PatternAttDiagram##)
                                 then
                                    'Source and/or destination is an attributes form diagram'
                                      ->AlertUser
                                 else
                                    theListDiagram[]->theOADDiagram[];
                                    theOtherListDiagram[]->theOtherOADDiagram[];
                                    theOADDiagram.theDescriptor[]->theDesc[];
                                    theOtherOADDiagram.theDescriptor[]
                                      ->theOtherDesc[];
                                    theDesc.father->anAST[];
                                    (if anAST## <=
                                    betaGram.referenceSpecification## then
                                        'The destination is a singular object'
                                          ->AlertUser
                                     else
                                        theOtherDesc.father->anotherAST[];
                                        anAST.father->testAST[];
                                        anotherAST.father->testAST2[];
                                        (if (testAST[] <> none ) and
                                        (testAST2[] <> none ) then
                                            (if theListDiagram[] <>
                                            theOtherListDiagram[] then
                                                (if
                                                (theOtherListDiagram[],
                                                 theListDiagram[])
                                                  ->isNotInCircle then
                                                    theOtherDesc.getPrefixOpt
                                                      ->anotherAST[];
                                                    anAST[]->anExp[];
                                                    anExp.getSon1->theNames[];
                                                    theNames.getSon1
                                                      ->theNameDcl[];
                                                    theNameDcl.getNameDecl
                                                      ->aDeclAST[];
                                                    (if aDeclAST.kind =
                                                    mps.kinds.unExpanded then
                                                        '<<NameAppl>>'->t[]
                                                     else
                                                        theNameDcl.getText->t[]
                                                    if);
                                                    (anotherAST[],t)
                                                      ->
                                                        (
                                                        anotherPatternDiagramNode
                                                        .theSifEditor).parse;
                                                    theListDiagram.titleNode[]
                                                      ->
                                                        theOtherListDiagram.
                                                          titleNode.
                                                          CreateRegion;
                                                    (if switch[50] or switch[30]
                                                     then
                                                        '2: PrefixConnectorOnInit: destination surroundBox.getParent%s\n'
                                                          ->putformat
                                                            (#
                                                               parent:
                                                                 ^designobject
                                                            do
                                                               (
                                                               theListDiagram.
                                                                 thesurroundBox)
                                                                 .getParent
                                                                 ->parent[];
                                                               (if parent[] <>
                                                               none then
                                                                   '<>none'->s
                                                                else
                                                                   '=none'->s
                                                               if)
                                                            #)
                                                    if);
                                                    (if
                                                    theOtherListDiagram.
                                                      titleNode.thePrefixConn <>
                                                    none then
                                                        (
                                                        theOtherListDiagram.
                                                          titleNode.
                                                          thePrefixConn).delete
                                                    if);
                                                    THIS(PrefixConnector)[]
                                                      ->
                                                        theOtherListDiagram.
                                                          titleNode.
                                                          thePrefixConn;
                                                    theOtherListDiagram[]
                                                      ->
                                                        theOtherPatternDeclDiagram[];
                                                    theDesc[]
                                                      ->
                                                        theOtherPatternDeclDiagram
                                                        .thePrefix[];
                                                    theOtherPatternDeclDiagram.
                                                      theParentNode
                                                      ->aDiagramNode[];
                                                    theDesc[]
                                                      ->
                                                        aDiagramNode.
                                                          thePrefix[];
                                                    (if
                                                    (theOtherDesc.father).symbol
                                                    = betaGram.staticItem then
                                                        ((theOtherDesc.father).
                                                         father,theDesc.father)
                                                          ->
                                                            patterndiagrams.
                                                              InheritanceList.
                                                              insert
                                                     else
                                                        (theOtherDesc.father,
                                                         theDesc.father)
                                                          ->
                                                            patterndiagrams.
                                                              InheritanceList.
                                                              insert
                                                    if);
                                                    (if switch[50] or switch[30]
                                                     then
                                                        '3: PrefixConnectorOnInit: destination surroundBox.getParent%s\n'
                                                          ->putformat
                                                            (#
                                                               parent:
                                                                 ^designobject
                                                            do
                                                               (
                                                               theListDiagram.
                                                                 thesurroundBox)
                                                                 .getParent
                                                                 ->parent[];
                                                               (if parent[] <>
                                                               none then
                                                                   '<>none'->s
                                                                else
                                                                   '=none'->s
                                                               if)
                                                            #)
                                                    if);
                                                    (theOtherListDiagram.
                                                       titleNode.getTopParent,
                                                     theOtherListDiagram.
                                                       titleNode[],
                                                     (
                                                     theListDiagram.
                                                       theSurroundBox).
                                                     getTopParent,
                                                     theListDiagram.
                                                       theSurroundBox)->setEnds;
                                                    (if switch[50] or switch[30]
                                                     then
                                                        '3: PrefixConnectorOnInit: destination surroundBox.getParent%s\n'
                                                          ->putformat
                                                            (#
                                                               parent:
                                                                 ^designobject
                                                            do
                                                               (
                                                               theListDiagram.
                                                                 thesurroundBox)
                                                                 .getParent
                                                                 ->parent[];
                                                               (if parent[] <>
                                                               none then
                                                                   '<>none'->s
                                                                else
                                                                   '=none'->s
                                                               if)
                                                            #)
                                                    if);
                                                    true->didCreate;
                                                    (if
                                                    gppProp.DiagramPositioning =
                                                    gppProp.AllAuto then
                                                        theOADDiagram[]
                                                          ->
                                                            prettyprintSubPatterns
                                                    if)
                                                 else
                                                    'Cannot do cyclic specializations'
                                                      ->AlertUser
                                                if)
                                             else
                                                'Source and destination is the same diagram'
                                                  ->AlertUser
                                            if)
                                         else
                                            'Source and/or destination is a descriptor form diagram'
                                              ->AlertUser
                                        if)
                                    if)
                                if)
                            if)
                        if)
                     else
                        'Source or destination is not part of a pattern diagram'
                          ->AlertUser
                    if)
                 else
                    'Source or destination is not part of a pattern diagram'
                      ->AlertUser
                if)
             else
                (if switch[50] then
                    'SpecializationConnectorOnInit: node1 and/or node2 was none'
                      ->putline
                if)
            if);
            (if not didCreate then delete if);
            gppProp.noGlobalinteractivemode->gppProp.globalInteractivemode;
            autosave;
            true->repair;
            statusbar.reset
        if);
        INNER onInit
     #)  

-- PrefixConnectorOnDelete: Descriptor --
(#
   node1,node2: ^PatternDiagramNode;
   theTitleNode: ^theOADDiagram.title;
   theDiagramNode: ^theOADDiagram.DiagramNode;
   titleText: @Text;
   theOADDiagram: ^OADDiagram;
   thePatternDeclDiagram: ^PatternDeclDiagram;
   anAST: ^MPS.AST;
   theDesc: ^betaGram.ObjectDescriptor;
   theMainPart: ^betaGram.MainPart;
   object1,object2: ^designObject;
   theParentNode: ^PatternDiagramNode;
   theParentDiagram: ^ListDiagram;
   theParentDiagramNode: ^theParentDiagram.DiagramNode
do
   (if switch[30] or switch[50] then
       'PrefixConnectorConnector onDelete!'->putline
   if);
   false->repair;
   true->getEnds->(node1[],BoxToNode->node2[]);
   node1.unmakeregion;
   node1.theDiagram->theOADDiagram[];
   node1[]->theTitleNode[];
   none ->theTitleNode.thePrefixConn;
   theOADDiagram[]->thePatternDeclDiagram[];
   none ->thePatternDeclDiagram.thePrefix[];
   theOADDiagram.theParentNode->theDiagramNode[];
   none ->theDiagramNode.thePrefix[];
   theOADDiagram.theParentNode->theParentNode[];
   theParentNode.theDiagram->theParentDiagram[];
   theParentNode[]->theParentDiagramNode[];
   theOADDiagram.theDescriptor[]->theDesc[];
   theDesc.getPrefixOpt->anAST[];
   ''->t[];
   (anAST[],t)->(node2.theSifEditor).parse;
   true->repair
#)  

-- PrefixConnectorOnReattach: Descriptor --
(#
   node1,node2: ^DesignObject;
   aPatternDiagramNode,anotherPatternDiagramNode,oldPatternDiagramNode:
     ^PatternDiagramNode;
   theListDiagram,theOtherListDiagram: ^ListDiagram;
   theOADDiagram,theOtherOADDiagram,oldOADDiagram,superDiagram: ^OADDiagram;
   theOtherPatternDeclDiagram,oldPatternDeclDiagram: ^PatternDeclDiagram;
   aDiagramNode: ^theOtherListDiagram.DiagramNode;
   t: ^Text;
   titleText: @text;
   theDesc,theOtherDesc,oldDesc: ^betaGram.ObjectDescriptor;
   anAST,anotherAST,testAST,testAST2,aDeclAST: ^MPS.AST;
   anExp: ^mps.expanded;
   theNames: ^betaGram.Names;
   theNameDcl: ^betaGram.NameDcl;
   theMainPart: ^betaGram.MainPart
do
   (if switch[50] or switch[30] then
       'PrefixConnector OnReattach!'->putline
   if);
   false->repair;
   true->getEnds->(BoxToNode->node2[],BoxToNode->node1[]);
   theNew[]->BoxToNode->theNew[];
   (if whichEnd then
       (if theNew[] <> node1[] then
           (if theNew## <= PatternDiagramNode## then
               theNew[]->aPatternDiagramNode[];
               aPatternDiagramNode.theDiagram->theListDiagram[];
               node2[]->anotherPatternDiagramNode[];
               anotherPatternDiagramNode.theDiagram->theOtherListDiagram[];
               (if (anotherPatternDiagramNode.theSifEditor).isReadOnly then
                   (anotherPatternDiagramNode.theDiagram).titleText[]->t[];
                   ' is read-only - can not generate code for specialization'
                     ->t.puttext;
                   t[]->alertUser
                else
                   (if theListDiagram## <= FragmentDiagram## then
                       'The relation has been attached to a fragment diagram'
                         ->AlertUser;
                       false->ok
                    else
                       (if theListDiagram## <= PatternAttDiagram## then
                           'The relation has been attached to an attributes form diagram'
                             ->AlertUser;
                           false->ok
                        else
                           theListDiagram[]->theOADDiagram[];
                           theOtherListDiagram[]->theOtherOADDiagram[];
                           theOADDiagram.theDescriptor[]->theDesc[];
                           theOtherOADDiagram.theDescriptor[]->theOtherDesc[];
                           theDesc.father->anAST[];
                           (if anAST## <= betaGram.referenceSpecification## then
                               'The destination is a singular object'
                                 ->AlertUser;
                               false->ok
                            else
                               theOtherDesc.father->anotherAST[];
                               anAST.father->testAST[];
                               anotherAST.father->testAST2[];
                               (if (testAST[] <> none ) and
                               (testAST2[] <> none ) then
                                   (if theListDiagram[] <> theOtherListDiagram[]
                                    then
                                       theOtherDesc.getPrefixOpt->anotherAST[];
                                       anAST[]->anExp[];
                                       anExp.getSon1->theNames[];
                                       theNames.getSon1->theNameDcl[];
                                       theNameDcl.getNameDecl->aDeclAST[];
                                       (if aDeclAST.kind = mps.kinds.unExpanded
                                        then
                                           '<<NameAppl>>'->t[]
                                        else
                                           theNameDcl.getText->t[]
                                       if);
                                       (anotherAST[],t)
                                         ->
                                           (
                                           anotherPatternDiagramNode.
                                             theSifEditor).parse;
                                       theListDiagram.titleNode[]
                                         ->
                                           theOtherListDiagram.titleNode.
                                             CreateRegion;
                                       theOtherListDiagram[]
                                         ->theOtherPatternDeclDiagram[];
                                       theDesc[]
                                         ->
                                           theOtherPatternDeclDiagram.
                                             thePrefix[];
                                       theOtherPatternDeclDiagram.theParentNode
                                         ->aDiagramNode[];
                                       theDesc[]->aDiagramNode.thePrefix[];
                                       aDiagramNode.theDeclaration[]
                                         ->
                                           patterndiagrams.InheritanceList.
                                             remove;
                                       (theOtherDesc.father,theDesc.father)
                                         ->
                                           patterndiagrams.InheritanceList.
                                             insert;
                                       (node2.getTopParent,node2[],
                                        (theListDiagram.theSurroundBox).
                                        getTopParent,
                                        theListDiagram.theSurroundBox)->setEnds;
                                       false->ok;
                                       (if gppProp.diagramPositioning =
                                       gppProp.AllAuto then
                                           theOADDiagram[]
                                             ->prettyprintSubPatterns
                                       if)
                                    else
                                       'Source and destination is the same diagram'
                                         ->AlertUser;
                                       false->ok
                                   if)
                                else
                                   'Source and/or destination is a descriptor form diagram'
                                     ->AlertUser;
                                   false->ok
                               if)
                           if)
                       if)
                   if)
               if)
            else
               'The relation has been attached to a node that is not part of a pattern diagram'
                 ->AlertUser;
               false->ok
           if)
        else
           false->ok
       if)
    else
       (if theNew[] <> node2[] then
           (if theNew## <= PatternDiagramNode## then
               node2[]->oldPatternDiagramNode[];
               node1[]->aPatternDiagramNode[];
               aPatternDiagramNode.theDiagram->theListDiagram[];
               theNew[]->anotherPatternDiagramNode[];
               anotherPatternDiagramNode.theDiagram->theOtherListDiagram[];
               (if (anotherPatternDiagramNode.theSifEditor).isReadOnly then
                   (anotherPatternDiagramNode.theDiagram).titleText[]->t[];
                   ' is read-only - can not generate code for specialization'
                     ->t.puttext;
                   t[]->alertUser;
                   false->ok
                else
                   (if theOtherListDiagram## <= FragmentDiagram## then
                       'The relation has been attached to a fragment diagram'
                         ->AlertUser;
                       false->ok
                    else
                       (if theOtherListDiagram## <= PatternAttDiagram## then
                           'The relation has been attached to an attributes form diagram'
                             ->AlertUser;
                           false->ok
                        else
                           oldPatternDiagramNode.theDiagram->oldOADDiagram[];
                           oldOADDiagram.theDescriptor[]->oldDesc[];
                           theListDiagram[]->theOADDiagram[];
                           theOtherListDiagram[]->theOtherOADDiagram[];
                           theOADDiagram.theDescriptor[]->theDesc[];
                           theOtherOADDiagram.theDescriptor[]->theOtherDesc[];
                           theDesc.father->anAST[];
                           (if anAST## <= betaGram.referenceSpecification## then
                               'The destination is a singular object'
                                 ->AlertUser;
                               false->ok
                            else
                               theOtherDesc.father->anotherAST[];
                               anAST.father->testAST[];
                               anotherAST.father->testAST2[];
                               (if (testAST[] <> none ) and
                               (testAST2[] <> none ) then
                                   (if theListDiagram[] <> theOtherListDiagram[]
                                    then
                                       theOtherDesc.getPrefixOpt->anotherAST[];
                                       anAST[]->anExp[];
                                       anExp.getSon1->theNames[];
                                       theNames.getSon1->theNameDcl[];
                                       theNameDcl.getNameDecl->aDeclAST[];
                                       (if aDeclAST.kind = mps.kinds.unExpanded
                                        then
                                           '<<NameAppl>>'->t[]
                                        else
                                           theNameDcl.getText->t[]
                                       if);
                                       (anotherAST[],t)
                                         ->
                                           (
                                           anotherpatternDiagramNode.
                                             theSifEditor).parse;
                                       theListDiagram.titleNode[]
                                         ->
                                           theOtherListDiagram.titleNode.
                                             CreateRegion;
                                       oldPatternDiagramNode.unMakeRegion;
                                       none
                                         ->
                                           oldOADDiagram.titleNode.
                                             thePrefixConn;
                                       oldOADDiagram[]->oldPatternDeclDiagram[];
                                       none ->oldPatternDeclDiagram.thePrefix[];
                                       oldPatternDeclDiagram.theParentNode
                                         ->aDiagramNode[];
                                       none ->aDiagramNode.thePrefix[];
                                       oldOADDiagram.theParentNode
                                         ->aDiagramNode[];
                                       aDiagramNode.theDeclaration[]
                                         ->
                                           patterndiagrams.InheritanceList.
                                             remove;
                                       theOtherListDiagram.theParentNode
                                         ->aDiagramNode[];
                                       (if
                                       theOtherListDiagram.titleNode.
                                         thePrefixConn <> none then
                                           aDiagramNode.theDeclaration[]
                                             ->
                                               patterndiagrams.InheritanceList.
                                                 remove;
                                           (
                                           theOtherListDiagram.titleNode.
                                             thePrefixConn).delete
                                       if);
                                       THIS(prefixConnector)[]
                                         ->
                                           theOtherListDiagram.titleNode.
                                             thePrefixConn;
                                       theOtherListDiagram[]
                                         ->theOtherPatternDeclDiagram[];
                                       theDesc[]
                                         ->
                                           theOtherPatternDeclDiagram.
                                             thePrefix[];
                                       theDesc[]->aDiagramNode.thePrefix[];
                                       (theOtherDesc.father,theDesc.father)
                                         ->
                                           patterndiagrams.InheritanceList.
                                             insert;
                                       oldDesc.getPrefixOpt->anotherAST[];
                                       ''->t[];
                                       (anotherAST[],t)
                                         ->
                                           (oldPatternDiagramNode.theSifEditor).
                                           parse;
                                       (theOtherListDiagram.titleNode.
                                          getTopParent,
                                        theOtherListDiagram.titleNode[],
                                        (theListDiagram.theSurroundBox).
                                        getTopParent,
                                        theListDiagram.theSurroundBox)->setEnds;
                                       false->ok;
                                       (if gppProp.DiagramPositioning =
                                       gppProp.AllAuto then
                                           theOADDiagram[]
                                             ->prettyprintSubPatterns
                                       if)
                                    else
                                       'Source and destination is the same diagram'
                                         ->AlertUser;
                                       false->ok
                                   if)
                                else
                                   'Source and/or destination is a descriptor form diagram'
                                     ->AlertUser;
                                   false->ok
                               if)
                           if)
                       if)
                   if)
               if)
            else
               'The relation has been attached to a node that is not part of a pattern diagram'
                 ->AlertUser;
               false->ok
           if)
        else
           false->ok
       if)
   if);
   true->repair
#)  

-- GeneralRelationshipOnInit: DoPart --
do 0->Orient  

-- getSynCatNo: DoPart --
do
   (if
   ((node.kind = mps.kinds.unexpanded) or (node.kind = mps.kinds.optional)) then
       node[]->nontNode[]; nontNode.nonterminalSymbol->synCatNo
    else
       node.symbol->synCatNo
   if)  

-- sifisEditingModeSet: DoPart --
do EditModeOn->theDesignInterface.SifIsInEditMode  

-- busyCursorSetDoPart: DoPart --
do
   (if val then
       theUI.cursors.watch[]->theUI.mouse.busyCursor; 
    else
       none ->theUI.mouse.busyCursor; 
   if);
     

