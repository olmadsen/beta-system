ORIGIN '../gppinterface';
INCLUDE '../prettyprintersetup'
        'diagramattributes';
INCLUDE '~beta/designenv/v1.5/private/userdatabody'
-- FileOpen: DescriptorForm --
(#
   count: @ShortRef;
   list: @IntegerRef;
   pages,nodes,conns,regions: [0] @Integer;
   thePage: ^theDocument.Page;
   theOADPage: ^theOADDocument.OADPage;
   theObject: ^thePage.DesignObject;
   theConnID: @integer;
   name: @Text;
   ext: ^Text
do
   (if callbackVerbose // true then 'CallBackOpenItem'->putline if);
   &OADDocument[]->theDocument[]->theOADDocument[];
   theDocument.onInit;
   (count[],list[])->DSStrGetPageList;
   (count,list)->GetIntList->pages;
   (if pages.range > 0 then
       (for i: pages.range repeat
         (if i = 1 then
             &theOADDocument.OADPage[]->thePage[]
               ->theOADDocument.theGroupPage[];
          else
             &theOADDocument.OADPage[]->thePage[]->theOADDocument.theWorkPage[];
         if)
         (* toby 24-11-94: VERY temporary hack (i hope)!!*)
         ;
         pages[i]->thePage.onInit;
         true->thePage.PageCallBack.specialNode;
         thePage.onReadDiagram;
       for);
       theOADDocument.updateUserDataIDs;
       loop
         (#
            i: @integer;
            while::<  (# do (i+2 <= IndexIDList.impl.range)->value #)
         do
            i+2->i;
            (if IndexIDList.impl[i] <> 0 then
                'IndexIDList: updating '->puttext;
                indexidlist.impl[i]->putint;
                IndexIDList.impl[i]->theOADDocument.UserDataIDMap.getID
                  ->IndexIDList.impl[i];
                ' to '->puttext;
                indexidlist.impl[i]->putint;
                newline
            if)
         #);
       theOADDocument.theWorkPage.PatternDiagrams.theList.scan
         (# theListDiagram: ^theOADDocument.theWorkPage.ListDiagram
         do
            current.e[]->theListDiagram[];
            theListDiagram[]
              ->theOADDocument.theWorkPage.PageCallBack.MakeLocalNodes;
            theListDiagram.titleNode.thePrefixConn.getID->theConnID;
            (if theConnID <> 0 then
                (theListDiagram[],theConnID)
                  ->theOADDocument.theGroupPage.PageCallBack.MakeConn
            if)
         #);
       theOADDocument.theGroupPage.PatternDiagrams.theList.scan
         (# theListDiagram: ^theOADDocument.theGroupPage.ListDiagram
         do
            current.e[]->theListDiagram[];
            theListDiagram[]
              ->theOADDocument.theGroupPage.PageCallBack.MakeLocalNodes;
            theListDiagram.titleNode.thePrefixConn.getID->theConnID;
            (if theConnID <> 0 then
                (theListDiagram[],theConnID)
                  ->theOADDocument.theGroupPage.PageCallBack.MakeConn
            if)
         #)
    else
       'Selected file is not a .diag file. If you wish to open a .bet or .ast file use open BETA fragment'
         ->DSUIUserAckMessage
   if);
   false
     ->proceed
     (*There should be a test if it is a diagram or
      an an ast file that is being opened!*)
#)  

-- FileNew: DescriptorForm --
(#
do
   (if PreCall
    // true then
       (if (*switch[1]**) true
        // true then 'Create a new fragment'->putline
       if);
       ;
       false->proceed;
       INNER hit;
   if);
#)  

-- FileSaveAs: DescriptorForm --
(#
   theListDiagram: ^theOADDocument.theWorkPage.ListDiagram;
   theReference: ^theListDiagram.titleNode.PatternDiagNodeReference;
   ok: @Boolean;
   listsize,last: @integer
do
   theDocument[]->theOADDocument[];
   theOADDocument.theWorkPage.PatternDiagrams.theList.scan
     (#
     do
        current.e[]->theListDiagram[];
        theListDiagram.localNodes.scan
          (#
          do
             &theListDiagram.titleNode.PatternDiagNodeReference[]
               ->theReference[];
             theReference.InitLocalNode;
             current[]->theReference;
             (* code for saving decomposDiagrams list
              
              (if current.struc <= theListDiagram.abstractNode then
              current[]->theAbstractNode[];
              theAbstractNode.decomposDiagrams.scan
              (#
              do
              &theAbstractNode.PatternDiagReference[]->theDiagReference[];
              theDiagReference.InitDecomposDiagram;
              current[]->theDiagReference
              #)
              if) *)
          #)
     #);
   theOADDocument.theGroupPage.PatternDiagrams.theList.scan
     (#
     do
        current.e[]->theListDiagram[];
        theListDiagram.localNodes.scan
          (#
          do
             &theListDiagram.titleNode.PatternDiagNodeReference[]
               ->theReference[];
             theReference.InitLocalNode;
             current[]->theReference;
             (* code for saving decomposDiagrams list
              
              (if current.struc <= theListDiagram.abstractNode then
              current[]->theAbstractNode[];
              theAbstractNode.decomposDiagrams.scan
              (#
              do
              &theAbstractNode.PatternDiagReference[]->theDiagReference[];
              theDiagReference.InitDecomposDiagram;
              current[]->theDiagReference
              #)
              if) *)
          #)
     #);
   IndexIDList.impl.range->listsize;
   (theOADDocument.theGroupPage.ID,499,@@ listsize,4)->UDWriteType->ok;
   (if ok then
       (if userDataVerbose then
           'Write IndexIDList.impl.range succeed: '->puttext;
           listsize->putint;
           newline
       if);
       IndexIDList.last->last;
       (theOADDocument.theGroupPage.ID,500,@@ last,4)->UDWriteType->ok;
       (if ok then
           (if userDataVerbose then
               'Write IndexIDList.last succeed: '->puttext;
               last->putint;
               newline
           if);
           (for i: listsize repeat
             (theOADDocument.theGroupPage.ID,500+i,@@ IndexIDList.impl[i],4)
               ->UDWriteType->ok;
             (if ok then
                 (if userDataVerbose then
                     'Write IndexIDList succeed: '->puttext;
                     'element no '->puttext;
                     i->putint;
                     'element '->puttext;
                     IndexIDList.impl[i]->putint;
                     newline
                 if)
              else
                 'Write IndexIDList fail: '->puttext
             if)
           for)
        else
           (if userDataVerbose then
               'Write IndexIDList.last fail: '->puttext
           if)
       if)
    else
       (if userDataVerbose then
           'Write IndexIDList.impl.range fail: '->puttext
       if)
   if)
#)  

-- FileMenuBetaOpen: DescriptorForm --
(# do GetGroupName #)  

-- GppFileMenuInit: DescriptorForm --
(#
do
   (menuID.FileMenu.quit+1,'-')->sep1.init;
   (menuID.FileMenu.quit+2,'Open BETA fragment')->iBetaOpen.init
#)  

-- DetailHit: DescriptorForm --
(#
   thePage: ^OADPage;
   theObject: ^thePage.DesignObject;
   theNode: ^thePage.PatternDiagramNode;
do
   CurrentPage->thePage[];
   (if thePage[] <> none
    // true then
       thePage.CurrentObject->theObject[];
       (if theObject[] <> none
        // true then
           (if theObject.struc <= thePage.PatternDiagramNode##
            // true then theObject[]->theNode[]; theNode.detail
            else
               'Selection is not a DiagramNode'->GppAlert;
           if);
        else
           'No Selection'->GppAlert;
       if)
   if);
#)  

-- AbstractHit: DescriptorForm --
(#
   thePage: ^OADPage;
   theObject: ^thePage.DesignObject;
   theNode: ^thePage.PatternDiagramNode;
do
   CurrentPage->thePage[];
   (if thePage[] <> none
    // true then
       thePage.CurrentObject->theObject[];
       (if theObject[] <> none
        // true then
           (if theObject.struc <= thePage.PatternDiagramNode##
            // true then theObject[]->theNode[]; theNode.abstract;
            else
               'Selection is not a DiagramNode'->GppAlert;
           if);
        else
           'No Selection'->GppAlert;
       if)
   if);
#)  

-- classificationHit: DescriptorForm --
(#
   thePage: ^OADPage;
   theObject: ^thePage.DesignObject;
   theNode: ^thePage.PatternDiagramNode;
do
   CurrentPage->thePage[];
   (if thePage[] <> none
    // true then
       thePage.CurrentObject->theObject[];
       (if theObject[] <> none
        // true then
           (if theObject.struc <= thePage.PatternDiagramNode##
            // true then
               theObject[]->theNode[];
               false->gppProp.ShowLocals;
               theNode.detail;
               true->gppProp.ShowLocals;
            else
               'Selection is not a DiagramNode'->GppAlert;
           if);
        else
           'No Selection'->GppAlert;
       if)
   if);
#)  

-- nestedCompositionHit: DescriptorForm --
(* The traditional way; name and all attributes *)
  (#
     thePage: ^OADPage;
     theObject: ^thePage.DesignObject;
     theNode: ^thePage.PatternDiagramNode;
  do
     CurrentPage->thePage[];
     (if thePage[] <> none
      // true then
         thePage.CurrentObject->theObject[];
         (if theObject[] <> none
          // true then
             (if theObject.struc <= thePage.PatternDiagramNode##
              // true then
                 theObject[]->theNode[];
                 gppProp.CompositionNested->gppProp.CompositionDType;
                 gppProp.CompositionAll->gppProp.CompositionWith;
                 theNode.detail
              else
                 'Selection is not a DiagramNode'->GppAlert;
             if);
          else
             'No Selection'->GppAlert;
         if)
     if);
  #)  

-- nestedwholePartHit: DescriptorForm --
(#
   thePage: ^OADPage;
   theObject: ^thePage.DesignObject;
   theNode: ^thePage.PatternDiagramNode;
do
   CurrentPage->thePage[];
   (if thePage[] <> none
    // true then
       thePage.CurrentObject->theObject[];
       (if theObject[] <> none
        // true then
           (if theObject.struc <= thePage.PatternDiagramNode##
            // true then
               theObject[]->theNode[];
               gppProp.CompositionNested->gppProp.CompositionDType;
               gppProp.CompositionPartWhole->gppProp.CompositionWith;
               theNode.detail;
            else
               'Selection is not a DiagramNode'->GppAlert;
           if);
        else
           'No Selection'->GppAlert;
       if)
   if);
#)  

-- nestedReferenceHit: DescriptorForm --
(#
   thePage: ^OADPage;
   theObject: ^thePage.DesignObject;
   theNode: ^thePage.PatternDiagramNode;
do
   CurrentPage->thePage[];
   (if thePage[] <> none
    // true then
       thePage.CurrentObject->theObject[];
       (if theObject[] <> none
        // true then
           (if theObject.struc <= thePage.PatternDiagramNode##
            // true then
               theObject[]->theNode[];
               gppProp.CompositionNested->gppProp.CompositionDType;
               gppProp.CompositionReference->gppProp.CompositionWith;
               theNode.detail;
            else
               'Selection is not a DiagramNode'->GppAlert;
           if);
        else
           'No Selection'->GppAlert;
       if)
   if);
#)  

-- nestedblockStructureHit: DescriptorForm --
(#
   thePage: ^OADPage;
   theObject: ^thePage.DesignObject;
   theNode: ^thePage.PatternDiagramNode;
do
   CurrentPage->thePage[];
   (if thePage[] <> none
    // true then
       thePage.CurrentObject->theObject[];
       (if theObject[] <> none
        // true then
           (if theObject.struc <= thePage.PatternDiagramNode##
            // true then
               theObject[]->theNode[];
               gppProp.CompositionNested->gppProp.CompositionDType;
               gppProp.CompositionBlock->gppProp.CompositionWith;
               theNode.detail;
            else
               'Selection is not a DiagramNode'->GppAlert;
           if);
        else
           'No Selection'->GppAlert;
       if)
   if);
#)  

-- treeCompositionHit: DescriptorForm --
(#
   thePage: ^OADPage;
   theObject: ^thePage.DesignObject;
   theNode: ^thePage.PatternDiagramNode;
do
   CurrentPage->thePage[];
   (if thePage[] <> none
    // true then
       thePage.CurrentObject->theObject[];
       (if theObject[] <> none
        // true then
           (if theObject.struc <= thePage.PatternDiagramNode##
            // true then
               theObject[]->theNode[];
               gppProp.CompositionTree->gppProp.CompositionDType;
               gppProp.CompositionAll->gppProp.CompositionWith;
               theNode.detail;
            else
               'Selection is not a DiagramNode'->GppAlert;
           if);
        else
           'No Selection'->GppAlert;
       if)
   if);
#)  

-- treewholePartHit: DescriptorForm --
(#
   thePage: ^OADPage;
   theObject: ^thePage.DesignObject;
   theNode: ^thePage.PatternDiagramNode;
do
   CurrentPage->thePage[];
   (if thePage[] <> none
    // true then
       thePage.CurrentObject->theObject[];
       (if theObject[] <> none
        // true then
           (if theObject.struc <= thePage.PatternDiagramNode##
            // true then
               theObject[]->theNode[];
               gppProp.CompositionTree->gppProp.CompositionDType;
               gppProp.CompositionPartWhole->gppProp.CompositionWith;
               theNode.detail;
            else
               'Selection is not a DiagramNode'->GppAlert;
           if);
        else
           'No Selection'->GppAlert;
       if)
   if);
#)  

-- treeReferenceHit: DescriptorForm --
(#
   thePage: ^OADPage;
   theObject: ^thePage.DesignObject;
   theNode: ^thePage.PatternDiagramNode;
do
   CurrentPage->thePage[];
   (if thePage[] <> none
    // true then
       thePage.CurrentObject->theObject[];
       (if theObject[] <> none
        // true then
           (if theObject.struc <= thePage.PatternDiagramNode##
            // true then
               theObject[]->theNode[];
               gppProp.CompositionTree->gppProp.CompositionDType;
               gppProp.CompositionReference->gppProp.CompositionWith;
               theNode.detail;
            else
               'Selection is not a DiagramNode'->GppAlert;
           if);
        else
           'No Selection'->GppAlert;
       if)
   if);
#)  

-- treeblockStructureHit: DescriptorForm --
(#
   thePage: ^OADPage;
   theObject: ^thePage.DesignObject;
   theNode: ^thePage.PatternDiagramNode;
do
   CurrentPage->thePage[];
   (if thePage[] <> none
    // true then
       thePage.CurrentObject->theObject[];
       (if theObject[] <> none
        // true then
           (if theObject.struc <= thePage.PatternDiagramNode##
            // true then
               theObject[]->theNode[];
               gppProp.CompositionTree->gppProp.CompositionDType;
               gppProp.CompositionBlock->gppProp.CompositionWith;
               theNode.detail;
            else
               'Selection is not a DiagramNode'->GppAlert;
           if);
        else
           'No Selection'->GppAlert;
       if)
   if);
#)  

-- CombinedHit: DescriptorForm --
(# (* display inheritance diagram with composition boxes around *)
do 'Combined Not yet implemented'->gppAlert;
#)  

-- HierPresHit: DescriptorForm --
(#
do
   not gppProp.SimpleHierarchyPresentation->gppProp.SimpleHierarchyPresentation
     ->check
#)  

-- DisplayMenuInit: DescriptorForm --
(#
do
   (UserMenu4+1,'Detail')->DetailItem.init;
   (UserMenu4+2,'Abstract')->AbstractItem.init;
   (*  (UserMenu4+3,'-')->sep.init;
    (UserMenu4+4,'Classification')->classificationItem.init;
    (UserMenu4+5,'-')->sep1.init;
    (UserMenu4+6,'Nested Composition')->nestedCompositionItem.init;
    (UserMenu4+7,'Whole/Part')->nestedwholePartItem.init;
    (UserMenu4+8,'Reference')->nestedreferenceItem.init;
    (UserMenu4+9,'BlockStructure')->nestedblockStructureItem.init;
    (UserMenu4+10,'-')->sep2.init;
    (UserMenu4+11,'Tree Composition')->treeCompositionItem.init;
    (UserMenu4+12,'Whole/Part')->treewholePartItem.init;
    (UserMenu4+13,'Reference')->treereferenceItem.init;
    (UserMenu4+14,'BlockStructure')->treeblockStructureItem.init;
    (UserMenu4+15,'-')->sep3.init;
    (UserMenu4+16,'Classification & Composition')->combinedItem.init;
    combinedItem.disable; *)
#)  

-- CompositionWithMarkHit: DescriptorForm --
(#
do
   not gppProp.CompositionWithMarks->gppProp.CompositionWithMarks->Check;
   (* and set checkmark *)
#)  

-- OnSamePageHit: DescriptorForm --
(#
do
   not gppProp.DetailedOnSamePage->gppProp.DetailedOnSamePage->Check;
   (* and set checkmark *)
#)  

-- SimpleCheckDisplay: DescriptorForm --
(#
do
   false->SimpleAsNameAndTypeItem.Check;
   false->SimpleAsNameItem.Check;
   false->SimpleAsTypeItem.Check;
   false->SimpleAsTypeAndKindItem.Check;
#)  

-- SimpleAsNameAndTypeHit: DescriptorForm --
(#
do SimpleCheck; gppProp.AsNameAndType->gppProp.SimpleDeclDisplay; true->Check;
#)  

-- SimpleAsNameHit: DescriptorForm --
(#
do SimpleCheck; gppProp.AsName->gppProp.SimpleDeclDisplay; true->Check
#)  

-- SimpleAsTypeHit: DescriptorForm --
(#
do SimpleCheck; gppProp.AsType->gppProp.SimpleDeclDisplay; true->Check
#)  

-- SimpleAsTypeAndKindHit: DescriptorForm --
(#
do SimpleCheck; gppProp.AsTypeAndKind->gppProp.SimpleDeclDisplay; true->Check
#)  

-- RefreshItem: DescriptorForm --
(# do (menuID.pageMenu,menuID.pageMenu.Cleanup)->CallOAMenu #)  

-- ReduceItem: DescriptorForm --
(# do (menuID.pageMenu,menuID.pageMenu.reduce)->CallOAMenu #)  

-- BlowupItem: DescriptorForm --
(# do (menuID.pageMenu,menuID.pageMenu.blowup)->CallOAMenu #)  

-- AttributesItem: DescriptorForm --
(# do (menuID.pageMenu,menuID.pageMenu.changeFatts)->CallOAMenu #)  

-- NewCommentHit: DescriptorForm --
(# #)  

-- ShowCommentHit: DescriptorForm --
(#
   thePage: ^OADPage;
   theObject: ^thePage.DesignObject;
   theNode: ^thePage.MarkNode;
do
   CurrentPage->thePage[];
   thePage.CurrentObject->theObject[];
   (if theObject[] <> none
    // true then
       (if theObject.struc <= thePage.MarkNode##
        // true then theObject[]->theNode[]; theNode.activate;
       if);
   if);
#)  

-- HideCommentHit: DescriptorForm --
(#
   thePage: ^OADPage;
   theObject: ^thePage.DesignObject;
   theNode: ^thePage.MarkNode;
do
   CurrentPage->thePage[];
   thePage.CurrentObject->theObject[];
   (if theObject[] <> none
    // true then
       (if theObject.struc <= thePage.MarkNode##
        // true then theObject[]->theNode[]; theNode.deactivate;
       if);
   if);
#)  

-- ShowGroupWindowItem: DescriptorForm --
(#
do
   true->theGroupPage.visible;
   theGroupPage.currentObject
     ->theGroupPage.currentObject (# do true->autoPan #);
#)  

-- PageMenuInit: DescriptorForm --
(#
do
   (UserMenu7+1,'Refresh')->RefreshItem.init;
   (UserMenu7+2,'Reduce')->ReduceItem.init;
   (UserMenu7+3,'BlowUp')->BlowupItem.init;
   (UserMenu7+4,'Attributes...')->AttributesItem.init;
   (UserMenu7+5,'-')->sep1.init;
   sep1.disable;
   (UserMenu7+6,'Show GroupWindow')->ShowGroupWindowItem.init;
#)  

-- OptionsMenuInit: DescriptorForm --
(#
do (*(UserMenu3+1,'Composition Marks') -> CompositionWithMarkItem.init;*)
   (UserMenu3+1,'Detailing On Same Page')->OnSamePageItem.init;
   (UserMenu3+2,'Simple Hierarchy Presentation')->hierPresItem.init;
   (UserMenu3+3,'-')->sep1.init;
   (UserMenu3+4,'Name And Type')->SimpleAsNameAndTypeItem.init;
   (UserMenu3+5,'Name')->SimpleAsNameItem.init;
   (UserMenu3+6,'Type')->SimpleAsTypeItem.init;
   (UserMenu3+7,'Type And Kind')->SimpleAsTypeAndKindItem.init;
   (UserMenu3+8,'-')->sep2.init;
   (*(UserMenu3+12,'Debug') -> DebugItem.init;
    (UserMenu3+12,'-') -> sep3.init;*)
   INNER Init;
   CompositionWithMarkItem.disable;
   sep1.disable;
   sep2.disable;
   (*sep3.disable;*)
#)  

-- OptionsMenuCheckMarks: DescriptorForm --
(#
do
   gppProp.DetailedOnSamePage->OnSamePageItem.Check;
   (if gppProp.CompositionDType > gppProp.CompositionNested
    // true then true->CompositionWithMarkItem.Check;
    else
       false->CompositionWithMarkItem.Check;
   if);
   true->SimpleAsNameAndTypeItem.Check;
   false->gppProp.SimpleHierarchyPresentation->hierPresItem.check;
#)  

-- DebugItem: DescriptorForm --
(#
do
   not switch[1]->switch[1]->Check;
   (* and set checkmark *)
   (if switch[1]
    // true then
       'debugging ON!'->screen.putline;
       true->verbose->callbackverbose->objectverbose;
    else
       'debugging OFF!'->screen.putline;
       false->verbose->callbackverbose->objectverbose;
   if);
#)  

-- MarkMenuInit: DescriptorForm --
(#
do
   (UserMenu6+1,'New Comment')->NewCommentItem.init;
   NewCommentItem.disable;
   (UserMenu6+2,'Show Comment')->ShowCommentItem.init;
   (UserMenu6+3,'Hide Comment')->HideCommentItem.init;
   INNER Init;
#)  

-- MarkMenuCheckMarks: DescriptorForm --
(# #)  

