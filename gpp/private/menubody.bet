ORIGIN '../gppinterface';
INCLUDE '../prettyprintersetup'
        'diagramattributes'
        '~beta/designenv/v2.2/private/userdatabody'
        '~beta/designenv/v2.2/private/designlist'
        '~beta/designenv/v2.2/private/designobjectbody';
-- theFileMenuNewGraphicsPage: DoPart --
do
   (if theDocument[] <> none then
       &theDocument.Page[]->thePage[];
       thePage.new;
       'Graphics Page'->thePage.pageTitle
    else
       &OADDocument[]->theDocument[]->theOADDocument[];
       theDocument.new;
       theDocument.currentPage->theOADDocument.theGroupPage[];
       'Group Window'->theOADDocument.theGroupPage.PageTitle;
       &theOADDocument.OADPage[]->theOADDocument.theWorkPage[];
       theOADDocument.theWorkPage.InvisibleNew;
       'WorkSheet'->theOADDocument.theWorkPage.PageTitle;
       &theDocument.Page[]->thePage[];
       thePage.new;
       'Graphics Page'->thePage.pageTitle;
       thePage[]->theDocument.currentPage
   if)  

-- theFileMenuOpen: Descriptor --
(# name,fname: @Text; help,ext: ^Text; didRecover: @boolean
do
   (if callbackVerbose // true then 'CallBackOpenItem'->putline if);
   'Select a .bet, '->help[];
   mps.astFileExtension->help.putText;
   ' or .diag file'->help.putText;
   help->DSFileNameDialog->name;
   name[]->openFile;
   (* thisOp:
    (if name.length > 0
    // true then
    name->getExtension->ext[];
    (if ('.bet'->ext.equal) or (mps.astFileExtension->ext.equal) then
    name->removeExtension->name;
    (if currentDiagramName[] = none then
    name.copy->currentDiagramName[];
    '.diag'->currentDiagramName.append;
    
    if);
    (if [*switch[1]*] true then
    'Opening: '->puttext; name[]->putline; 
    if);
    name->openFragmentGroup
    else
    (if '.diag'->ext.equal then
    (if currentDiagramName[] = none then
    name
    ->checkAutoSaveFile
    (#
    error::< 
    (#  do msg[]->AlertUser; leave thisOp #)
    #)->didRecover;
    name->removeExtension->fname;
    '.freja'->fname.append;
    fname
    ->scanASTfiles
    (# 
    do
    currentGroupName[]->putline;
    currentModTime->putint;
    newline
    #);
    (if (name,didRecover,true)->checkDiagFile then
    name->openDiagram
    if)
    else
    'You cannot open more than one diagram'->alertUser
    if)
    else
    'Please select a .bet, .ast or .diag file'->GppAlert
    if)
    if);
    
    if)*)
   
#)  

-- theFileMenuClose: Descriptor --
(#
   ok: @Boolean;
   frejaFile,autosaveFrejaFile,tildeFrejaFile,diagFile,autosaveDiagFile,
     tildeDiagFile: @file;
   groupFile,autosaveGroupFile,tildeGroupFile: @file;
   groupName,frejaFileName,autoSaveFrejaFileName,tildeFrejaFileName,help:
     ^text;
   doNotSave,askSave: @boolean
do
   (if CurrentDiagramName[] <> none then
       'Close Current Diagram?'->DSUIGetUserYesOrNo->ok;
       (if ok then
           currentDiagramName[]->diagFile.name;
           '#'->(currentDiagramName.copy).append->autosaveDiagFile.name;
           '~'->(currentDiagramName.copy).append->tildeDiagFile.name;
           (if switch[17] then
               'Freja FrejaFileMenuClose:'->putLine;
               diagFile.name->putLine;
               autosaveDiagFile.name->putLine;
               tildeDiagFile.name->putLine
           if);
           (if autosaveDiagFile.entry.exists then
               (if diagFile.entry.exists then
                   (if autosaveDiagFile.entry.modtime > diagFile.entry.modtime
                    then
                       true->askSave
                    else
                       true->doNotSave
                   if)
                else
                   true->askSave
               if);
               (if askSave then
                   'Save Current Diagram?'->DSUIGetUserYesOrNo->ok->doClose;
                   (if ok then Save.hit else true->doNotSave if)
                else
                   true->doNotSave
               if)
            else
               true->doNotSave
           if);
           (if doNotSave then
               currentDiagramName.copy->groupName[];
               groupName->removeExtension->groupName;
               '.freja'->(groupName.copy).append->frejaFileName[]
                 ->frejaFile.name;
               '.freja#'->(groupName.copy).append->autosaveFrejaFileName[]
                 ->autosaveFrejaFile.name;
               '.freja~'->(groupName.copy).append->tildeFrejaFileName[]
                 ->tildeFrejaFile.name;
               (if autosaveFrejaFile.entry.exists then
                   autosaveFrejaFileName
                     ->scanAstFiles
                       (# 
                       do
                          currentGroupName->groupName;
                          '.ast'->groupName.append;
                          groupName[]->groupFile.name;
                          '#'->(groupName.copy).append->autosaveGroupFile.name;
                          '~'->(groupName.copy).append->tildeGroupFile.name;
                          (if switch[17] then
                              groupName[]->putLine;
                              autosaveGroupFile.name->putLine;
                              tildeGroupFile.name->putLine
                          if);
                          (if autosaveGroupFile.entry.exists then
                              'rm .ast#'->putLine; autosaveGroupFile.delete
                          if);
                          (if tildeGroupFile.entry.exists and
                          groupFile.entry.exists then
                              'mv .ast~ .ast'->putLine;
                              groupFile.name->tildeGroupFile.entry.rename
                          if)
                       #);
                   (if tildeFrejaFile.entry.exists then
                       'mv .freja~ .freja'->putLine;
                       frejaFile.name->tildeFrejaFile.entry.rename
                    else
                       'No .freja~ file!!'->putLine
                   if);
                   (if autosaveDiagFile.entry.exists then
                       'rm .diag#'->putLine; autoSaveDiagFile.delete
                   if);
                   'rm .freja#'->putLine;
                   autosaveFrejaFile.delete
               if);
               closeDiagram
           if)
       if)
    else
       'No current diagram?!'->putline
   if)
#)  

-- theFileMenuSave: Descriptor --
(#
   name: @Text;
   dummyFilter: ##external;
   pageList: ^ObjectList;
   filename,t: @Text;
   cancelled: ^integerRef;
   prompt: @text;
   count: @ShortRef;
   list: @IntegerRef;
   f: @file;
   diagFile,tildeDiagFile: @file;
   dirWriteable: (# f: @file enter f.name exit f.entry.writeable #);
   dirIsWriteable: @boolean;
   pages,savedPages: ^ObjectList;
   savedPageIDs: [0] @Integer
do
   (if CurrentDiagramName[] <> none then
       currentDiagramName[]->diagFile.name;
       '~'->(currentDiagramName.copy).append->tildeDiagFile.name;
       (if switch[17] then
           'Freja theFileMenuSave:'->putLine;
           diagFile.name->putLine;
           tildeDiagFile.name->putLine
       if);
       (if diagFile.entry.path.head->dirWriteable then
           true->dirIsWriteable;
           (if diagFile.entry.exists then
               'mv .diag .diag~'->putLine;
               tildeDiagFile.name
                 ->diagFile.entry.rename
                   (#
                      error::< 
                        (# 
                        do
                           'Could not move '->msg;
                           diagFile.name->msg.puttext;
                           '# into '->msg.puttext;
                           diagFile.name->msg.puttext
                        #)
                   #)
           if)
       if);
       (if dirIsWriteable then
           (if currentDiagramName[] <> none then
               currentDiagramName->removeExtension->fileName;
               '.freja'->fileName.Append;
               '#'->(fileName.copy).append->f.name;
               (if f.entry.exists then 'rm .freja#'->putLine; f.delete if)
            else
               'No currentDiagramName?'->putline
           if);
           (if doQuit then sifSaveAndQuit else sifSave if);
           SaveLists;
           (*(count[],list[])->DSStrGetPageList;*)
           theDocument.getPages->pages[];
           (if pages[] <> none then
               pages.scan
                 (# 
                 do
                    (if current## <= theOADDocument.ObjectPage## then
                        
                     else
                        (if savedPages[] = none then
                            &ObjectList[]->savedPages[]
                        if);
                        current[]->savedPages.insert
                    if)
                 #)
           if);
           (if savedPages[] <> none then
               savedPages.ListToNodeIDs->savedPageIDs;
               @@ savedPageIDs[1]->list;
               savedPageIDs.range->count;
               &integerRef[]->cancelled[];
               ' '->prompt.puttext;
               (@@ CurrentDiagramName.T[1],false,cancelled[],true,count,list,
                dummyFilter##,prompt)->DSFileSavePagesAsDiagram;
               '#'->(currentDiagramName.copy).append->f.name;
               (if f.entry.exists then 'rm .diag#'->putLine; f.delete if);
               (if doQuit then (normal,' ')->stop if)
            else
               'No Pages to save'->alertUser
           if)
        else
           'No write access to the directory'->t; t[]->alertUser
       if)
    else
       SaveAs.hit
   if)
#)  

-- theFileMenuSaveAs: Descriptor --
(#
   name: @Text;
   ext: ^Text;
   dummyFilter: ##external;
   pageList: ^ObjectList;
   filename: @Text;
   cancelled: ^integerRef;
   prompt: @text;
   count: @ShortRef;
   list: @IntegerRef;
   f: @file
do
   ('Save Current Diagram As:','Save')->GppFileNameDialog->name;
   (if name.length > 0
    // true then
       name->getExtension->ext[];
       (if '.diag'->ext.equal then
           name[]->CurrentDiagramName[];
           (if currentDiagramName[] <> none then
               currentDiagramName->removeExtension->fileName;
               '.freja'->fileName.Append;
               '#'->(fileName.copy).append->f.name;
               (if f.entry.exists then f.delete if)
            else
               'No currentDiagramName?'->putline
           if);
           SaveLists;
           (count[],list[])->DSStrGetPageList;
           &integerRef[]->cancelled[];
           ' '->prompt.puttext;
           (@@ name.T[1],false,cancelled[],true,count,list,dummyFilter##,prompt)
             ->DSFileSavePagesAsDiagram;
           (if doQuit then sifSaveAndQuit else sifSave if);
           '#'->(currentDiagramName.copy).append->f.name;
           'rm .diag#'->putLine;
           (if f.entry.exists then f.delete if)
        else
           'Extension must be .diag for saved diagrams!'->AlertUser
       if);
       
   if)
#)  

-- theFileMenuRevert: Descriptor --
(# 
do
   (if currentDiagramName[] <> none then
       (currentDiagramName,false)->theDesignInterface.revert
    else
       'No current diagram?!'->putline
   if)
#)  

-- theFileMenuLoadGraphicsPage: DoPart --
do
     (#
        filename: ^text;
        pageCount: ^shortRef;
        pageList,cancelled: ^integerRef;
        pages: [0] @integer;
        thePage: ^theDocument.Page
     do
        (if theDocument[] = none then
            &OADDocument[]->theDocument[]->theOADDocument[];
            theDocument.new;
            theDocument.currentPage->theOADDocument.theGroupPage[];
            'Group Window'->theOADDocument.theGroupPage.pageTitle;
            &theOADDocument.OADPage[]->theOADDocument.theWorkPage[];
            theOADDocument.theWorkPage.InvisibleNew;
            'WorkSheet'->theOADDocument.theWorkPage.PageTitle
        if);
        &shortRef[]->pageCount[];
        &integerRef[]->pageList[];
        &integerRef[]->cancelled[];
        &Text[]->filename[];
        'untitled'->filename.puttext;
        (@@ filename.T[1],true,pageCount[],pageList[],cancelled[])
          ->DSFileLoadPage;
        (if cancelled = 0 then
            (pageCount,pageList)->GetIntList->pages;
            (for i: pages.range repeat
              &theDocument.Page[]->thePage[];
              pages[i]->thePage.onInit;
              thePage.onReadDiagram;
              (* delete userdata to convert from possible OADPage to graphics page *)
              (pages[i],10)->UDDeleteType
            for)
        if)
     #)  

-- theFileMenuSavePageAsGraphics: DoPart --
do
     (#
        thePage: ^theDocument.Page;
        title,filename: @text;
        cancelled: ^integerRef
     do
        theDocument.currentPage->thePage[];
        (if thePage[] <> none then
            thePage.pageTitle->title;
            (if not title.empty then
                title.scanAll
                  (#  do (if ch <> ' ' then ch->filename.put if) #)
             else
                'untitled'->filename
            if);
            &integerRef[]->cancelled[];
            (@@ filename.T[1],true,cancelled[])->DSFileSavePage
        if)
     #)  

-- hideShowSifItem: DoPart --
do INNER hit  

-- theFileMenuInit: Descriptor --
(# 
do
   (UserMenu3+1,'New BETA Program')->NewBetaProgram.init;
   (UserMenu3+2,'New BETA Library')->NewBetaLibrary.init;
   (UserMenu3+3,'New Graphics Page')->NewGraphicsPage.init;
   (UserMenu3+4,'Open...')->Open.init;
   (UserMenu3+5,'-')->sep1.init;
   (UserMenu3+6,'Close')->Close.init;
   (UserMenu3+7,'Save')->Save.init;
   (UserMenu3+8,'Save As...')->SaveAs.init;
   (UserMenu3+9,'Revert')->Revert.init;
   (UserMenu3+10,'-')->sep2.init;
   (UserMenu3+11,'Page Setup...')->PageSetup.init;
   (UserMenu3+12,'Print...')->Print.init;
   (UserMenu3+13,'-')->sep3.init;
   (UserMenu3+14,'Preferences...')->Preferences.init;
   (UserMenu3+15,'Load Text...')->LoadText.init;
   (UserMenu3+16,'Save Text...')->SaveText.init;
   (UserMenu3+17,'Load Graphics...')->LoadGraphicsPage.init;
   (UserMenu3+18,'Save Page As Graphics...')->SavePageAsGraphics.init;
   (UserMenu3+19,'About')->About.init;
   (UserMenu3+20,'Help')->Help.init;
   (UserMenu3+21,'-')->sep4.init;
   (UserMenu3+22,'Show Sif')->hideShowSifItem.init;
   (UserMenu3+23,'-')->sep5.init;
   (UserMenu3+24,'Quit')->Quit.init;
   sep1.disable;
   sep2.disable;
   Close.disable;
   sep3.disable;
   sep4.disable;
   About.disable;
   Help.disable;
   Revert.disable
#)  

-- AbstractHit: Descriptor --
(#
   thePage: ^Page;
   theOADPage: ^OADPage;
   theObjectPage: ^ObjectPage;
   theObject: ^thePage.DesignObject;
   theNode: ^theOADPage.PatternDiagramNode;
   detailnode: ^theObjectPage.DetailedObjectNode;
   
do
   CurrentPage->thePage[];
   (if thePage[] <> none then
       (if thePage## <= OADPage## then
           thePage[]->theOADPage[];
           theOADPage.CurrentObject->theObject[];
           (if theObject[] <> none then
               (if theObject## <= theOADPage.PatternDiagramNode## then
                   theObject[]->theNode[]; theNode.abstract; 
                else
                   'Selection is not a DiagramNode'->alertUser; 
               if);
               
            else
               'No Selection'->alertUser; 
           if)
        else
           (if thePage## <= ObjectPage## then
               thePage[]->theObjectPage[];
               theObjectPage.CurrentObject->theObject[];
               (if theObject## <= theObjectPage.DetailedObjectNode## then
                   theObject[]->detailnode[]; detailnode.abstract
                else
                   'Can not be invoked on this type of node'->alertUser
               if)
            else
               'Can not be invoked on this type of page'->alertUser
           if)
       if)
    else
       'No current page'->alertUser
   if);
   
#)  

-- ViewMenuAbstractRecursivelyItem: DoPart --
do
     (#
        thePage: ^Page;
        theOADPage: ^OADPage;
        theObjectPage: ^ObjectPage;
        theObject: ^thePage.DesignObject;
        theNode: ^theOADPage.PatternDiagramNode;
        detailnode: ^theObjectPage.DetailedObjectNode;
        
     do
        CurrentPage->thePage[];
        (if thePage[] <> none then
            (if thePage## <= OADPage## then
                thePage[]->theOADPage[];
                theOADPage.CurrentObject->theObject[];
                (if theObject[] <> none then
                    (if theObject## <= theOADPage.PatternDiagramNode## then
                        theObject[]->theNode[]; theNode.abstractRecursively; 
                     else
                        'Selection is not a DiagramNode'->alertUser; 
                    if);
                    
                 else
                    'No Selection'->alertUser; 
                if)
             else
                (if thePage## <= ObjectPage## then
                    thePage[]->theObjectPage[];
                    theObjectPage.CurrentObject->theObject[];
                    (if theObject## <= theObjectPage.DetailedObjectNode## then
                        theObject[]->detailnode[]; detailnode.abstractRecursive
                     else
                        'Can not be invoked on this type of node'->alertUser
                    if)
                 else
                    'Can not be invoked on this type of page'->alertUser
                if)
            if)
         else
            'No current page'->alertUser
        if);
        
     #)  

-- ViewMenuOverviewItem: DoPart --
do
     (#
        thePage: ^Page;
        theOADPage: ^OADPage;
        theObjectPage: ^ObjectPage;
        theObject: ^thePage.DesignObject;
        theNode: ^theOADPage.PatternDiagramNode;
        theObjectDiagramNode: ^theObjectPage.ObjectDiagramNode;
        
     do
        CurrentPage->thePage[];
        (if thePage[] <> none then
            (if thePage## <= OADPage## then
                thePage[]->theOADPage[];
                theOADPage.CurrentObject->theObject[];
                (if theObject[] <> none then
                    (if theObject## <= theOADPage.PatternDiagramNode## then
                        theObject[]->theNode[]; theNode.overview; 
                     else
                        'Selection is not a DiagramNode'->alertUser; 
                    if);
                    
                 else
                    'No Selection'->alertUser; 
                if)
             else
                (if thePage## <= ObjectPage## then
                    thePage[]->theObjectPage[];
                    theObjectPage.CurrentObject->theObject[];
                    (if theObject[] <> none then
                        (if theObject## <= theObjectPage.ObjectDiagramNode##
                         then
                            theObject[]->theObjectDiagramNode[];
                            theObjectDiagramNode.overview
                         else
                            'Can not be invoked on this type of object'
                              ->alertUser
                        if)
                     else
                        'No current object'->alertUser
                    if)
                 else
                    'Can not be invoked on this type of page'->alertUser
                if)
            if)
         else
            'No current page'->alertUser
        if);
        
     #)  

-- DetailHit: Descriptor --
(#
   thePage: ^Page;
   theOADPage: ^OADPage;
   theObjectPage: ^ObjectPage;
   theObject: ^thePage.DesignObject;
   theNode: ^theOADPage.PatternDiagramNode;
   abstrnode: ^theObjectPage.AbstractedObjectNode;
   
do
   CurrentPage->thePage[];
   (if thePage[] <> none then
       (if thePage## <= OADPage## then
           thePage[]->theOADPage[];
           theOADPage.CurrentObject->theObject[];
           (if theObject[] <> none then
               (if theObject## <= theOADPage.PatternDiagramNode## then
                   theObject[]->theNode[]; theNode.detail
                else
                   'Selection is not a DiagramNode'->alertUser; 
               if);
               
            else
               'No Selection'->alertUser; 
           if)
        else
           (if thePage## <= ObjectPage## then
               thePage[]->theObjectPage[];
               theObjectPage.CurrentObject->theObject[];
               (if theObject[] <> none then
                   (if theObject## <= theObjectPage.AbstractedObjectNode## then
                       theObject[]->abstrNode[];
                       (if abstrnode.pagelink[] = none then
                           abstrnode.detail
                        else
                           abstrnode.pagelink[]->CurrentPage
                       if)
                    else
                       'Can not be invoked on this type of node'->alertUser
                   if)
                else
                   'No current object'->alertUser
               if)
            else
               'Can not be invoked on this type of page'->alertUser
           if)
       if)
    else
       'No current page'->alertUser
   if);
   
#)  

-- ViewMenuDetailRecursivelyItem: DoPart --
do
     (#
        thePage: ^Page;
        theOADPage: ^OADPage;
        theObjectPage: ^ObjectPage;
        theObject: ^thePage.DesignObject;
        theNode: ^theOADPage.PatternDiagramNode;
        abstrNode: ^theObjectPage.AbstractedObjectNode;
        
     do
        CurrentPage->thePage[];
        (if thePage[] <> none then
            (if thePage## <= OADPage## then
                thePage[]->theOADPage[];
                theOADPage.CurrentObject->theObject[];
                (if theObject[] <> none then
                    (if theObject## <= theOADPage.PatternDiagramNode## then
                        theObject[]->theNode[]; theNode.detailRecursively
                     else
                        'Selection is not a DiagramNode'->alertUser; 
                    if);
                    
                 else
                    'No Selection'->alertUser; 
                if)
             else
                (if thePage## <= ObjectPage## then
                    thePage[]->theObjectPage[];
                    theObjectPage.CurrentObject->theObject[];
                    (if theObject[] <> none then
                        (if theObject## <= theObjectPage.AbstractedObjectNode##
                         then
                            theObject[]->abstrNode[];
                            (if abstrnode.pagelink[] = none then
                                abstrnode.detailRecursive
                             else
                                abstrnode.pagelink[]->CurrentPage
                            if)
                         else
                            'Detail Recursively can not be invoked on this type of object'
                              ->alertUser
                        if)
                     else
                        'No current object'->alertUser
                    if)
                 else
                    'Can not be invoked on this type of page'->alertUser
                if)
            if)
         else
            'No current page'->alertUser
        if);
        
     #)  

-- ViewMenuDetailOnDifferentPageItem: DoPart --
do
     (#
        p: ^Page;
        oPage: ^ObjectPage;
        theObject: ^p.DesignObject;
        objectnode: ^oPage.ObjectDiagramNode;
        abstrNode,node: ^oPage.AbstractedObjectNode
     do
        CurrentPage->p[];
        (if p[] <> none then
            (if p## <= OADPage## then
                'Not yet implemented for pattern diagrams'->alertUser
             else
                (if p## <= ObjectPage## then
                    p[]->oPage[];
                    oPage.CurrentObject->theObject[];
                    (if theObject[] <> none then
                        theObject[]->objectnode[];
                        (if objectnode## <= oPage.AbstractedObjectNode##
                         // true then
                            objectnode[]->abstrNode[];
                            3->AbstrNode.linethickness;
                            (if objectNode##
                             // theObjectPage.AbstrPartObjectNode## then
                                &ObjectPage[]->theObjectPage[]
                                  ->AbstrNode.pagelink[];
                                theObjectPage.new;
                                theObjectPage[]->CurrentPage;
                                &theObjectPage.AbstrPartObjectNode[]->node[]
                             // theObjectPage.AbstrPartComponentNode## then
                                &ObjectPage[]->theObjectPage[]
                                  ->AbstrNode.pagelink[];
                                theObjectPage.new;
                                theObjectPage[]->CurrentPage;
                                &theObjectPage.AbstrPartComponentNode[]->node[]
                             // theObjectPage.AbstrDynamicObjectNode## then
                                &ObjectPage[]->theObjectPage[]
                                  ->AbstrNode.pagelink[];
                                theObjectPage.new;
                                theObjectPage[]->CurrentPage;
                                &theObjectPage.AbstrDynamicObjectNode[]->node[]
                             // theObjectPage.AbstrDynamicComponentNode## then
                                &ObjectPage[]->theObjectPage[]
                                  ->AbstrNode.pagelink[];
                                theObjectPage.new;
                                theObjectPage[]->CurrentPage;
                                &theObjectPage.AbstrDynamicComponentNode[]
                                  ->node[]
                             // theObjectPage.AbstrOperationObjectNode## then
                                &ObjectPage[]->theObjectPage[]
                                  ->AbstrNode.pagelink[];
                                theObjectPage.new;
                                theObjectPage[]->CurrentPage;
                                &theObjectPage.AbstrOperationObjectNode[]
                                  ->node[]
                            if);
                            'Object Page'->theObjectPage.PageTitle;
                            (objectnode.theDecl[],
                             objectnode.theObjectDescriptor[],false)
                              ->node.display;
                            node[]->theObjectPage.CurrentObject;
                            node.detail
                        if)
                     else
                        'No current object'->alertUser
                    if)
                 else
                    'Can not be invoked on this type of page'->alertUser
                if)
            if)
         else
            'No current page'->alertUser
        if)
     #)  

-- ShowAttributesItemHit: DoPart --
do
     (#
        p: ^Page;
        oadP: ^OADPage;
        t: @text;
        connectors: ^ObjectList;
        theConn: ^oadP.deletableConnector;
        n1,n2: ^oadP.DesignObject;
        theWedgeNode: ^oadP.WedgeNode;
        thePatternDiagramNode,theOtherPatternDiagramNode:
          ^oadP.PatternDiagramNode;
        theListDiagram,theOtherListDiagram: ^oadP.Listdiagram;
        nd1,nd2: @IntegerRef
     do
        currentPage->p[];
        (if p## <= OADPage## then
            p[]->oadP[];
            (not gppProp.showAttributes)->gppProp.showAttributes->check;
            oadP.GetConnectors->connectors[];
            (if connectors[] <> none then
                connectors.scan
                  (# 
                  do
                     (if current## <= oadP.deletableConnector## then
                         current[]->theConn[];
                         (if (current## <= oadP.dynamicItemConnector##) or
                         (current## <= oadP.dynamicComponentConnector##) then
                             (if gppProp.references then
                                 (if gppProp.showAttributes then
                                     true->theConn.BorderVisible;
                                     true->theConn.selectable
                                  else
                                     false->theConn.BorderVisible;
                                     false->theConn.selectable
                                 if)
                             if)
                          else
                             true->theConn.getEnds->(n1[],n2[]);
                             (if (n1[] <> none ) and (n2[] <> none ) then
                                 (if (n1## <= oadP.PatternDiagramNode##) and
                                 (n2## <= oadP.PatternDiagramNode##) then
                                     n1[]->thePatternDiagramNode[];
                                     n2[]->theOtherPatternDiagramNode[];
                                     thePatternDiagramNode.theDiagram
                                       ->theListDiagram[];
                                     theOtherPatternDiagramNode.theDiagram
                                       ->theOtherListDiagram[];
                                     (if
                                     (theConn## <=
                                      theListDiagram.PrefixConnector##) or
                                     (theConn## <=
                                      theOtherListDiagram.PrefixConnector##)
                                      then
                                         (theConn.ID,true,nd1[],nd2[])
                                           ->DSRdAttrGetConnEnds;
                                         nd1->theObjectList.Find->n1[];
                                         (if n1## <= oadP.WedgeNode## then
                                             n1[]->theWedgeNode[]
                                          else
                                             nd2->theObjectList.Find->n2[];
                                             (if n2## <= oadP.WedgeNode## then
                                                 n2[]->theWedgeNode[]
                                             if)
                                         if);
                                         (if gppProp.specializations then
                                             (if gppProp.showAttributes then
                                                 true->theConn.BorderVisible;
                                                 true
                                                   ->theWedgeNode.BorderVisible;
                                                 true->theConn.selectable
                                              else
                                                 false->theConn.BorderVisible;
                                                 false
                                                   ->theWedgeNode.BorderVisible;
                                                 false->theConn.selectable
                                             if)
                                         if)
                                      else
                                         (if
                                         (theConn## <=
                                          theListDiagram.
                                            SimplePrefixConnector##) or
                                         (theConn## <=
                                          theOtherListDiagram.
                                            SimplePrefixConnector##) then
                                             (theConn.ID,true,nd1[],nd2[])
                                               ->DSRdAttrGetConnEnds;
                                             nd1->theObjectList.Find->n1[];
                                             (if n1## <= oadP.WedgeNode## then
                                                 n1[]->theWedgeNode[]
                                              else
                                                 nd2->theObjectList.Find->n2[];
                                                 (if n2## <= oadP.WedgeNode##
                                                  then
                                                     n2[]->theWedgeNode[]
                                                 if)
                                             if);
                                             (if gppProp.specializations then
                                                 (if not gppProp.showAttributes
                                                  then
                                                     true
                                                       ->theConn.BorderVisible;
                                                     true
                                                       ->
                                                         theWedgeNode.
                                                           BorderVisible;
                                                     true->theConn.selectable
                                                  else
                                                     false
                                                       ->theConn.BorderVisible;
                                                     false
                                                       ->
                                                         theWedgeNode.
                                                           BorderVisible;
                                                     false->theConn.selectable
                                                 if)
                                             if)
                                         if)
                                     if)
                                 if)
                              else
                                 'Source or destination of prefix connector is none - should not happen!!!'
                                   ->putline
                             if)
                         if)
                     if)
                  #)
            if);
            oadP.patternDiagrams.theList.scan
              (# help: ^text
              do
                 (if current.e## <= oadP.FragmentDiagram## then
                     
                  else
                     current.e[]->theListDiagram[];
                     theListDiagram.localNodes.scan
                       (# 
                       do
                          (if gppProp.showAttributes then
                              current.invisibleText->help[];
                              help->current.theText.set;
                              true->current.BorderVisible;
                              true->current.selectable
                           else
                              (if not (current.theText.length = 0) then
                                  current.theText.get->t;
                                  t[]->current.invisibleText
                              if);
                              current.theText.clear;
                              false->current.BorderVisible;
                              false->current.selectable
                          if)
                       #)
                 if)
              #);
            (menuID.pageMenu,menuID.pageMenu.Cleanup)->CallOAMenu
         else
            'Current page is not an OAD Page'->putline
        if)
     #)  

-- ViewMenuDumpNodeItem: Descriptor --
(#
   thePage: ^OADPage;
   theObject: ^thePage.DesignObject;
   thePatternDiagramNode: ^thePage.PatternDiagramNode;
   theAssocNode: ^thePage.AssociationNode
do
   CurrentPage->thePage[];
   (if thePage[] <> none
    // true then
       thePage.CurrentObject->theObject[];
       (if theObject[] <> none then
           (if theObject## <= thePage.PatternDiagramNode## then
               theObject[]->thePatternDiagramNode[]; thePatternDiagramNode.dump
            else
               (if theObject## <= thePage.AssociationNode## then
                   theObject[]->theAssocNode[]; theAssocNode.dump
                else
                   theObject.ID->putint; newline
               if)
           if);
           
       if)
   if)
#)  

-- DumpInheritanceItem: Descriptor --
(#  do theWorkPage.patternDiagrams.InheritanceList.dump #)  

-- DumpAssociationItem: Descriptor --
(#  do theWorkPage.patternDiagrams.AssociationList.dump #)  

-- DumpDynReferenceItem: Descriptor --
(#  do theWorkPage.patternDiagrams.DynReferenceList.dump #)  

-- DumpIndexIDListItem: Descriptor --
(#  do newline; 'IndexIDList: '->putline; IndexIDList.dump; newline #)  

-- DumpAlternativeIndexIDListItem: DoPart --
do
   'Alternative IndexIDList:'->putline;
   theGroupPage.patternDiagrams.theList.scan
     (# theListDiagram: ^theGroupPage.ListDiagram
     do
        (if current.e## <= theGroupPage.ListDiagram## then
            current.e[]->theListDiagram[];
            theListDiagram.localNodes.scan
              (# theFragmentNode: ^theListDiagram.FragmentNode
              do
                 (if current## <= theListDiagram.FragmentNode## then
                     current[]->theFragmentNode[];
                     '('->puttext;
                     (theFragmentNode.theRoot).index->putint;
                     ','->puttext;
                     current.ID->putint;
                     ') '->puttext
                 if)
              #)
        if)
     #);
   (if theWorkPage[] <> none then
       theWorkPage.patternDiagrams.theList.scan
         (# theListDiagram: ^theWorkPage.ListDiagram
         do
            (if current.e## <= theWorkPage.ListDiagram## then
                current.e[]->theListDiagram[];
                theListDiagram.localNodes.scan
                  (#
                     theDiagramNode: ^theListDiagram.DiagramNode;
                     theNonTerminalNode: ^theListDiagram.NonTerminalNode
                  do
                     (if current## <= theListDiagram.DiagramNode## then
                         current[]->theDiagramNode[];
                         '('->puttext;
                         (theDiagramNode.theDeclaration).index->putint;
                         ','->puttext;
                         current.ID->putint;
                         ') '->puttext
                     if);
                     (if current## <= theListDiagram.NonTerminalNode## then
                         current[]->theNonTerminalNode[];
                         '('->puttext;
                         (theNonTerminalnode.unExp).index->putint;
                         ','->puttext;
                         current.ID->putint;
                         ') '->puttext
                     if)
                  #)
            if)
         #)
   if);
   newline  

-- dumpLocalNodesItem: DoPart --
do
     (#
        thePage: ^OADPage;
        theObject: ^thePage.DesignObject;
        thePatternDiagramNode: ^thePage.PatternDiagramNode;
        theDiagram: ^thePage.ListDiagram
     do
        CurrentPage->thePage[];
        (if thePage[] <> none
         // true then
            thePage.CurrentObject->theObject[];
            (if theObject[] <> none then
                (if theObject## <= thePage.PatternDiagramNode## then
                    theObject[]->thePatternDiagramNode[];
                    thePatternDiagramNode.theDiagram->theDiagram[];
                    theDiagram.localNodes.dump
                if);
                
            if)
        if)
     #)  

-- dumpDiagramListItem: DoPart --
do
     (# thePage: ^OADPage
     do
        CurrentPage->thePage[];
        (if thePage[] <> none then thePage.patternDiagrams.theList.dump if)
     #)  

-- dumpNodeIDHit: DoPart --
do
     (# thePage: ^Page; theObject: ^thePage.DesignObject
     do
        CurrentPage->thePage[];
        (if thePage[] <> none
         // true then
            thePage.CurrentObject->theObject[];
            (if theObject[] <> none
             // true then 'ID: '->puttext; theObject.ID->putint; newline; 
            if)
        if)
     #)  

-- ViewMenuTraceItem: Descriptor --
(# 
do
   not switch[10]->switch[10]->switch[11]->switch[12]->switch[1]->switch[2]
     ->switch[20]->switch[21]->switch[22]->switch[23]->switch[30]->switch[17]
     ->switch[18]->switch[40]->switch[50]
#)
(*
 -- classificationHit: Descriptor --
 (#
 thePage: ^OADPage;
 theObject: ^thePage.DesignObject;
 theNode: ^thePage.PatternDiagramNode;
 
 do
 CurrentPage->thePage[];
 (if thePage[] <> none
 // true then
 thePage.CurrentObject->theObject[];
 (if theObject[] <> none
 // true then
 (if theObject## <= thePage.PatternDiagramNode##
 // true then
 theObject[]->theNode[];
 false->gppProp.ShowLocals;
 theNode.detail;
 true->gppProp.ShowLocals;
 
 else
 'Selection is not a DiagramNode'->AlertUser; 
 if);
 
 else
 'No Selection'->AlertUser; 
 if)
 if);
 
 #)  
 
 -- nestedCompositionHit: Descriptor --
 [* The traditional way; name and all attributes *]
 (#
 thePage: ^OADPage;
 theObject: ^thePage.DesignObject;
 theNode: ^thePage.PatternDiagramNode;
 
 do
 CurrentPage->thePage[];
 (if thePage[] <> none
 // true then
 thePage.CurrentObject->theObject[];
 (if theObject[] <> none
 // true then
 (if theObject## <= thePage.PatternDiagramNode##
 // true then
 theObject[]->theNode[];
 gppProp.CompositionNested->gppProp.CompositionDType;
 gppProp.CompositionAll->gppProp.CompositionWith;
 theNode.detail
 else
 'Selection is not a DiagramNode'->GppAlert; 
 if);
 
 else
 'No Selection'->GppAlert; 
 if)
 if);
 
 #)  
 
 -- nestedwholePartHit: Descriptor --
 (#
 thePage: ^OADPage;
 theObject: ^thePage.DesignObject;
 theNode: ^thePage.PatternDiagramNode;
 
 do
 CurrentPage->thePage[];
 (if thePage[] <> none
 // true then
 thePage.CurrentObject->theObject[];
 (if theObject[] <> none
 // true then
 (if theObject## <= thePage.PatternDiagramNode##
 // true then
 theObject[]->theNode[];
 gppProp.CompositionNested->gppProp.CompositionDType;
 gppProp.CompositionPartWhole->gppProp.CompositionWith;
 theNode.detail;
 
 else
 'Selection is not a DiagramNode'->GppAlert; 
 if);
 
 else
 'No Selection'->GppAlert; 
 if)
 if);
 
 #)  
 
 -- nestedReferenceHit: Descriptor --
 (#
 thePage: ^OADPage;
 theObject: ^thePage.DesignObject;
 theNode: ^thePage.PatternDiagramNode;
 
 do
 CurrentPage->thePage[];
 (if thePage[] <> none
 // true then
 thePage.CurrentObject->theObject[];
 (if theObject[] <> none
 // true then
 (if theObject## <= thePage.PatternDiagramNode##
 // true then
 theObject[]->theNode[];
 gppProp.CompositionNested->gppProp.CompositionDType;
 gppProp.CompositionReference->gppProp.CompositionWith;
 theNode.detail;
 
 else
 'Selection is not a DiagramNode'->GppAlert; 
 if);
 
 else
 'No Selection'->GppAlert; 
 if)
 if);
 
 #)  
 
 -- nestedblockStructureHit: Descriptor --
 (#
 thePage: ^OADPage;
 theObject: ^thePage.DesignObject;
 theNode: ^thePage.PatternDiagramNode;
 
 do
 CurrentPage->thePage[];
 (if thePage[] <> none
 // true then
 thePage.CurrentObject->theObject[];
 (if theObject[] <> none
 // true then
 (if theObject## <= thePage.PatternDiagramNode##
 // true then
 theObject[]->theNode[];
 gppProp.CompositionNested->gppProp.CompositionDType;
 gppProp.CompositionBlock->gppProp.CompositionWith;
 theNode.detail;
 
 else
 'Selection is not a DiagramNode'->GppAlert; 
 if);
 
 else
 'No Selection'->GppAlert; 
 if)
 if);
 
 #)  
 
 -- treeCompositionHit: Descriptor --
 (#
 thePage: ^OADPage;
 theObject: ^thePage.DesignObject;
 theNode: ^thePage.PatternDiagramNode;
 
 do
 CurrentPage->thePage[];
 (if thePage[] <> none
 // true then
 thePage.CurrentObject->theObject[];
 (if theObject[] <> none
 // true then
 (if theObject## <= thePage.PatternDiagramNode##
 // true then
 theObject[]->theNode[];
 gppProp.CompositionTree->gppProp.CompositionDType;
 gppProp.CompositionAll->gppProp.CompositionWith;
 theNode.detail;
 
 else
 'Selection is not a DiagramNode'->GppAlert; 
 if);
 
 else
 'No Selection'->GppAlert; 
 if)
 if);
 
 #)  
 
 -- treewholePartHit: Descriptor --
 (#
 thePage: ^OADPage;
 theObject: ^thePage.DesignObject;
 theNode: ^thePage.PatternDiagramNode;
 
 do
 CurrentPage->thePage[];
 (if thePage[] <> none
 // true then
 thePage.CurrentObject->theObject[];
 (if theObject[] <> none
 // true then
 (if theObject## <= thePage.PatternDiagramNode##
 // true then
 theObject[]->theNode[];
 gppProp.CompositionTree->gppProp.CompositionDType;
 gppProp.CompositionPartWhole->gppProp.CompositionWith;
 theNode.detail;
 
 else
 'Selection is not a DiagramNode'->GppAlert; 
 if);
 
 else
 'No Selection'->GppAlert; 
 if)
 if);
 
 #)  
 
 -- treeReferenceHit: Descriptor --
 (#
 thePage: ^OADPage;
 theObject: ^thePage.DesignObject;
 theNode: ^thePage.PatternDiagramNode;
 
 do
 CurrentPage->thePage[];
 (if thePage[] <> none
 // true then
 thePage.CurrentObject->theObject[];
 (if theObject[] <> none
 // true then
 (if theObject## <= thePage.PatternDiagramNode##
 // true then
 theObject[]->theNode[];
 gppProp.CompositionTree->gppProp.CompositionDType;
 gppProp.CompositionReference->gppProp.CompositionWith;
 theNode.detail;
 
 else
 'Selection is not a DiagramNode'->GppAlert; 
 if);
 
 else
 'No Selection'->GppAlert; 
 if)
 if);
 
 #)  
 
 -- treeblockStructureHit: Descriptor --
 (#
 thePage: ^OADPage;
 theObject: ^thePage.DesignObject;
 theNode: ^thePage.PatternDiagramNode;
 
 do
 CurrentPage->thePage[];
 (if thePage[] <> none
 // true then
 thePage.CurrentObject->theObject[];
 (if theObject[] <> none
 // true then
 (if theObject## <= thePage.PatternDiagramNode##
 // true then
 theObject[]->theNode[];
 gppProp.CompositionTree->gppProp.CompositionDType;
 gppProp.CompositionBlock->gppProp.CompositionWith;
 theNode.detail;
 
 else
 'Selection is not a DiagramNode'->GppAlert; 
 if);
 
 else
 'No Selection'->GppAlert; 
 if)
 if);
 
 #)  
 
 -- CombinedHit: Descriptor --
 (# [* display inheritance diagram with composition boxes around *] 
 do 'Combined Not yet implemented'->gppAlert; 
 #)  
 
 -- HierPresHit: Descriptor --
 (# 
 do
 not gppProp.SimpleHierarchyPresentation->gppProp.SimpleHierarchyPresentation
 ->check
 #)  
 *)  

-- ViewMenuInit: Descriptor --
(# i: @integer
do
   (UserMenu4+(i+1->i),'Abstract                    Alt-k')->AbstractItem.init;
   (UserMenu4+(i+1->i),'Abstract Recursively             ')
     ->AbstractRecursivelyItem.init;
   (UserMenu4+(i+1->i),'Overview')->OverviewItem.init;
   (UserMenu4+(i+1->i),'Detail                      Alt-d')->DetailItem.init;
   (UserMenu4+(i+1->i),'Detail Recursively')->DetailRecursivelyItem.init;
   (UserMenu4+(i+1->i),'-')->sep1.init;
   (UserMenu4+(i+1->i),'Search...                   Alt-s')->SearchItem.init;
   (UserMenu4+(i+1->i),'Replace...                       ')->ReplaceItem.init;
   ReplaceItem.disable;
   (UserMenu4+(i+1->i),'-')->sep5.init;
   (UserMenu4+(i+1->i),'Layout Subpatterns')->LayoutSubpatterns.init;
   (UserMenu4+(i+1->i),'Edged Specialization connectors')
     ->EdgedSpecializationConnectors.init;
   (*   (UserMenu4+(i+1->i),'-')->sep6.init;
    (UserMenu4+(i+1->i),'Show Attributes')->ShowAttributesItem.init;
    (UserMenu4+(i+1->i),'Automatic Sub-pattern Layout')
    ->AutoSubPatternLayoutItem.init;
    (UserMenu4+(i+1->i),'-')->sep4.init;
    (UserMenu4+(i+1->i),'Name And Type               (X:@P)')
    ->SimpleAsNameAndTypeItem.init;
    (UserMenu4+(i+1->i),'Name                        (X)')
    ->SimpleAsNameItem.init;
    (UserMenu4+(i+1->i),'Type                        (:P)')
    ->SimpleAsTypeItem.init;
    (UserMenu4+(i+1->i),'Name And Kind               (X:@)')
    ->SimpleAsNameAndKindItem.init;
    (UserMenu4+(i+1->i),'References')->ReferencesItem.init;
    (UserMenu4+(i+1->i),'Specializations')->SpecializationsItem.init;
    (UserMenu4+(i+1->i),'Associations')->AssociationsItem.init; *)
   (UserMenu4+(i+1->i),'-')->sep2.init;
   (UserMenu4+(i+1->i),'Text Attributes')->TextAttributesItem.init;
   (UserMenu4+(i+1->i),'Fit To Text')->FitToTextItem.init;
   (UserMenu4+(i+1->i),'-')->sep.init;
   (UserMenu4+(i+1->i),'Layout Preferences...')->LayoutPreferencesItem.init;
   (if switch[1] then
       (UserMenu4+(i+1->i),'-')->sep4.init;
       (UserMenu4+(i+1->i),'Dump node')->DumpNodeItem.init;
       (UserMenu4+(i+1->i),'Debug on/off')->TraceItem.init;
       (UserMenu4+(i+1->i),'User data trace on/off')->TraceUserDataItem.init;
       (UserMenu4+(i+1->i),'Callback trace on/off')->TraceCallbacksItem.init;
       (UserMenu4+(i+1->i),'Dump inheritance list')
         ->DumpInheritanceListItem.init;
       (UserMenu4+(i+1->i),'Dump association list')
         ->DumpAssociationListItem.init;
       (UserMenu4+(i+1->i),'Dump dynamic reference list')
         ->DumpDynReferenceListItem.init;
       (UserMenu4+(i+1->i),'Communication trace on/off')
         ->TraceCommunicationItem.init;
       (UserMenu4+(i+1->i),'Dump indexIDList')->DumpIndexIDListItem.init;
       (UserMenu4+(i+1->i),'Dump alternative indexIDList')
         ->DumpAlternativeIndexIDListItem.init;
       (UserMenu4+(i+1->i),'Dump LocalNodes')->DumpLocalNodesItem.init;
       (UserMenu4+(i+1->i),'Dump DiagramList')->dumpDiagramListItem.init;
       (UserMenu4+(i+1->i),'Node ID')->DumpNodeID.init
   if);
   INNER init;
   (*  (UserMenu4+3,'-')->sep.init;
    (UserMenu4+4,'Classification')->classificationItem.init;
    (UserMenu4+5,'-')->sep1.init;
    (UserMenu4+6,'Nested Composition')->nestedCompositionItem.init;
    (UserMenu4+7,'Whole/Part')->nestedwholePartItem.init;
    (UserMenu4+8,'Reference')->nestedreferenceItem.init;
    (UserMenu4+9,'BlockStructure')->nestedblockStructureItem.init;
    (UserMenu4+10,'-')->sep2.init;
    (UserMenu4+11,'Tree Composition')->treeCompositionItem.init;
    (UserMenu4+12,'Whole/Part')->treewholePartItem.init;
    (UserMenu4+13,'Reference')->treereferenceItem.init;
    (UserMenu4+14,'BlockStructure')->treeblockStructureItem.init;
    (UserMenu4+15,'-')->sep3.init;
    (UserMenu4+16,'Classification & Composition')->combinedItem.init;
    combinedItem.disable; *)
   
#)  

-- SimpleCheckDisplay: Descriptor --
(# 
do
   false->SimpleAsNameAndTypeItem.Check;
   false->SimpleAsNameItem.Check;
   false->SimpleAsTypeItem.Check;
   false->SimpleAsNameAndKindItem.Check;
   theWorkPage.patternDiagrams.theList.Scan
     (#
        thisListDiagram: ^theWorkPage.ListDiagram;
        theDiagramNode: ^thisListDiagram.DiagramNode;
        theNames: ^betaGram.Names;
        iterate: @boolean;
        sonNo: @integer
     do
        current.e[]->thisListDiagram[];
        thisListDiagram.localNodes.scan
          (# 
          do
             (if not (current## = thisListDiagram.PatternNode##) then
                 (if current## <= thisListDiagram.DiagramNode## then
                     current[]->theDiagramNode[];
                     (if iterate then
                         (theDiagramNode.theDeclaration,sonNo->theNames.get)
                           ->theDiagramNode.Redisplay;
                         sonNo+1->sonNo;
                         (if sonNo > theNames.noOfSons then false->iterate if)
                      else
                         (theDiagramNode.theDeclaration).getSon1->theNames[];
                         (if theNames.noOfsons = 1 then
                             (theDiagramNode.theDeclaration,theNames.getSon1)
                               ->theDiagramNode.Redisplay
                          else
                             true->iterate;
                             1->sonNo;
                             (theDiagramNode.theDeclaration,sonNo->theNames.get)
                               ->theDiagramNode.Redisplay;
                             2->sonNo
                         if)
                     if)
                 if)
             if)
          #);
        thisListDiagram.localNodes.adjustSizes
     #);
   
#)  

-- ViewMenuAutoSubPatternLayout: DoPart --
do (* (not gppProp.autoSubPatternLayout)->gppProp.autoSubPatternLayout->check*)
  

-- ViewMenuLayoutSubPatterns: DoPart --
do
     (#
        thePage: ^Page;
        theOADPage: ^OADPage;
        theObject: ^thePage.DesignObject;
        theNode: ^theOADPage.PatternDiagramNode;
        theDiagram: ^theOADPage.Diagram;
        thePatternDeclDiagram: ^theOADPage.PatternDeclDiagram;
        prefixDiagram: ^theOADPage.PatternDiagram;
        theCenter: @Point;
        
     do
        CurrentPage->thePage[];
        (if thePage[] <> none then
            (if thePage## <= OADPage## then
                thePage[]->theOADPage[];
                theOADPage.CurrentObject->theObject[];
                (if theObject[] <> none then
                    (if theObject## <= theOADPage.PatternDiagramNode## then
                        theObject[]->theNode[];
                        theNode.theDiagram->theDiagram[];
                        (if theNode## <= theDiagram.title## then
                            (if theDiagram## <= theOADPage.PatternDeclDiagram##
                             then
                                theDiagram[]->theOADPage.prettyprintSubPatterns
                             else
                                'Current diagram cannot have subpatterns'
                                  ->alertUser
                            if)
                         else
                            'Selection is other than title: not implemented yet'
                              ->alertUser
                        if)
                     else
                        'Current selection must be a pattern diagram'
                          ->alertUser;
                        
                    if);
                    
                 else
                    'No Selection'->alertUser; 
                if)
             else
                'Current selection must be a pattern diagram'->alertUser
            if)
         else
            'No current page'->alertUser
        if);
        
     #)  

-- ViewMenuEdgedSpecializationConnectors: DoPart --
do
     (#
        thePage: ^Page;
        theOADPage: ^OADPage;
        theObject: ^thePage.DesignObject;
        theNode: ^theOADPage.PatternDiagramNode;
        theDiagram: ^theOADPage.Diagram;
        thePatternDeclDiagram: ^theOADPage.PatternDeclDiagram;
        
     do
        CurrentPage->thePage[];
        (if thePage[] <> none then
            (if thePage## <= OADPage## then
                thePage[]->theOADPage[];
                theOADPage.CurrentObject->theObject[];
                (if theObject[] <> none then
                    (if theObject## <= theOADPage.PatternDiagramNode## then
                        theObject[]->theNode[];
                        theNode.theDiagram->theDiagram[];
                        (if theNode## <= theDiagram.title## then
                            (if theDiagram## <= theOADPage.PatternDeclDiagram##
                             then
                                theDiagram[]->theOADPage.edgeSpecializations
                             else
                                'Current diagram cannot have subpatterns'
                                  ->alertUser
                            if)
                         else
                            'Selection must be title of pattern'->alertUser
                        if)
                     else
                        'Current selection must be a pattern diagram'
                          ->alertUser;
                        
                    if);
                    
                 else
                    'No Selection'->alertUser; 
                if)
             else
                'Current selection must be a pattern diagram'->alertUser
            if)
         else
            'No current page'->alertUser
        if);
        
     #)  

-- SimpleAsNameAndTypeHit: Descriptor --
(# 
do gppProp.AsNameAndType->gppProp.SimpleDeclDisplay; SimpleCheck; true->Check; 
#)  

-- SimpleAsNameHit: Descriptor --
(# 
do gppProp.AsName->gppProp.SimpleDeclDisplay; SimpleCheck; true->Check
#)  

-- SimpleAsTypeHit: Descriptor --
(# 
do gppProp.AsType->gppProp.SimpleDeclDisplay; SimpleCheck; true->Check
#)  

-- SimpleAsNameAndKindHit: Descriptor --
(# 
do gppProp.AsNameAndKind->gppProp.SimpleDeclDisplay; SimpleCheck; true->Check
#)  

-- ReferencesItemHit: Descriptor --
(#
   p: ^Page;
   oadP: ^OADPage;
   connectors: ^ObjectList;
   theConn: ^oadP.deletableConnector
do
   currentPage->p[];
   (if p## <= OADPage## then
       p[]->oadP[];
       (not gppProp.references)->gppProp.references->check;
       (if gppProp.showAttributes then
           oadP.GetConnectors->connectors[];
           (if connectors[] <> none then
               connectors.scan
                 (# 
                 do
                    (if (current## <= oadP.dynamicItemConnector##) or
                    (current## <= oadP.dynamicComponentConnector##) then
                        current[]->theConn[];
                        (if gppProp.references then
                            true->theConn.BorderVisible;
                            true->theConn.selectable
                         else
                            false->theConn.BorderVisible;
                            false->theConn.selectable
                        if);
                        theConn.redraw
                    if)
                 #)
           if)
       if)
    else
       'Current page is not an OAD Page'->putline
   if)
#)  

-- SpecializationItemHit: Descriptor --
(#
   p: ^Page;
   oadP: ^OADPage;
   connectors: ^ObjectList;
   theConn: ^oadP.deletableConnector;
   n1,n2: ^oadP.DesignObject;
   theWedgeNode: ^oadP.WedgeNode;
   thePatternDiagramNode,theOtherPatternDiagramNode: ^oadP.PatternDiagramNode;
   theListDiagram,theOtherListDiagram: ^oadP.Listdiagram;
   nd1,nd2: @IntegerRef
do
   currentPage->p[];
   (if p## <= OADPage## then
       p[]->oadP[];
       (not gppProp.specializations)->gppProp.specializations->check;
       oadP.GetConnectors->connectors[];
       (if connectors[] <> none then
           connectors.scan
             (# 
             do
                (if current## <= oadP.deletableConnector## then
                    current[]->theConn[];
                    true->theConn.getEnds->(n1[],n2[]);
                    (if (n1## <= oadP.PatternDiagramNode##) and
                    (n2## <= oadP.PatternDiagramNode##) then
                        n1[]->thePatternDiagramNode[];
                        n2[]->theOtherPatternDiagramNode[];
                        thePatternDiagramNode.theDiagram->theListDiagram[];
                        theOtherPatternDiagramNode.theDiagram
                          ->theOtherListDiagram[];
                        (if (theConn## <= theListDiagram.PrefixConnector##) or
                        (theConn## <= theOtherListDiagram.PrefixConnector##)
                         then
                            (theConn.ID,true,nd1[],nd2[])->DSRdAttrGetConnEnds;
                            nd1->theObjectList.Find->n1[];
                            (if n1## <= oadP.WedgeNode## then
                                n1[]->theWedgeNode[]
                             else
                                nd2->theObjectList.Find->n2[];
                                (if n2## <= oadP.WedgeNode## then
                                    n2[]->theWedgeNode[]
                                if)
                            if);
                            (if gppProp.showAttributes then
                                (if gppProp.specializations then
                                    true->theConn.BorderVisible;
                                    true->theWedgeNode.BorderVisible;
                                    true->theConn.selectable
                                 else
                                    false->theConn.BorderVisible;
                                    false->theWedgeNode.BorderVisible;
                                    false->theConn.selectable
                                if)
                            if)
                        if);
                        (if
                        (theConn## <= theListDiagram.SimplePrefixConnector##) or
                        (theConn## <=
                         theOtherListDiagram.SimplePrefixConnector##) then
                            (theConn.ID,true,nd1[],nd2[])->DSRdAttrGetConnEnds;
                            nd1->theObjectList.Find->n1[];
                            (if n1## <= oadP.WedgeNode## then
                                n1[]->theWedgeNode[]
                             else
                                nd2->theObjectList.Find->n2[];
                                (if n2## <= oadP.WedgeNode## then
                                    n2[]->theWedgeNode[]
                                if)
                            if);
                            (if not gppProp.showAttributes then
                                (if gppProp.specializations then
                                    true->theConn.BorderVisible;
                                    true->theWedgeNode.BorderVisible;
                                    true->theConn.selectable
                                 else
                                    false->theConn.BorderVisible;
                                    false->theWedgeNode.BorderVisible;
                                    false->theConn.selectable
                                if)
                            if)
                        if)
                    if)
                if)
             #)
       if)
    else
       'Current page is not an OAD Page'->putline
   if)
#)  

-- AssociationsItemHit: Descriptor --
(#
   p: ^Page;
   oadP: ^OADPage;
   connectors: ^ObjectList;
   theConn,theOtherConn: ^oadP.deletableConnector;
   n1,n2: ^oadP.DesignObject;
   t: @text;
   help: ^text
do
   currentPage->p[];
   (if p## <= OADPage## then
       p[]->oadP[];
       (not gppProp.associations)->gppProp.associations->check;
       oadP.GetConnectors->connectors[];
       (if connectors[] <> none then
           connectors.scan
             (#
                theAssociationNode: ^oadP.AssociationNode;
                theAssociationConn,theOtherAssociationConn:
                  ^theAssociationNode.AssociationConnector
             do
                (if current## <= oadP.deletableConnector## then
                    current[]->theConn[];
                    true->theConn.getEnds->(n1[],n2[]);
                    (if n1## <= oadP.AssociationNode## then
                        n1[]->theAssociationNode[]
                     else
                        (if n2## <= oadP.AssociationNode## then
                            n2[]->theAssociationNode[]
                         else
                            none ->theAssociationNode[]
                        if)
                    if);
                    (if theAssociationNode[] <> none then
                        (if theConn[] = theAssociationNode.c1 then
                            theAssociationNode.c2->theOtherAssociationConn[]
                         else
                            theAssociationNode.c1->theOtherAssociationConn[]
                        if);
                        theConn[]->theAssociationConn[];
                        (if gppProp.associations then
                            theAssociationConn.invisibleText->help[];
                            help->theAssociationConn.theText.set;
                            true->theAssociationConn.BorderVisible;
                            true->theAssociationNode.BorderVisible;
                            theOtherAssociationConn.invisibleText->help[];
                            help->theOtherAssociationConn.theText.set;
                            true->theOtherAssociationConn.BorderVisible
                         else
                            theAssociationConn.theText.get->t;
                            (if not (''->t.equal) then
                                t[]->theAssociationConn.invisibleText
                            if);
                            theAssociationConn.theText.clear;
                            false->theAssociationConn.BorderVisible;
                            false->theAssociationNode.BorderVisible;
                            theOtherAssociationConn.theText.get->t;
                            (if not (''->t.equal) then
                                t[]->theOtherAssociationConn.invisibleText
                            if);
                            theOtherAssociationConn.theText.clear;
                            false->theOtherAssociationConn.BorderVisible
                        if)
                    if)
                if)
             #)
       if)
    else
       'Current page is not an OAD Page'->putline
   if)
#)  

-- TextAttributesItemHit: Descriptor --
(#  do menuID.textMenu.textAttr->DSUIMenuExecute #)  

-- FitToTextItemHit: DoPart --
do
     (#
        thePage: ^Page;
        theOADPage: ^OADPage;
        theObjectPage: ^ObjectPage;
        theObject: ^thePage.DesignObject
     do
        currentPage->thePage[];
        (if thePage[] <> none then
            thePage.CurrentObject->theObject[];
            (if theObject[] <> none then
                (if thePage## <= OADPage## then
                    thePage[]->theOADPage[];
                    (if theObject## <= theOADPage.UserDataNode## then
                        'Can not use Fit to Text on nodes in pattern diagrams'
                          ->alertUser
                     else
                        theObject.FitToText
                    if)
                 else
                    (if thePage## <= ObjectPage## then
                        thePage[]->theObjectPage[];
                        (if theObject## <= theObjectPage.ObjectDiagramNode##
                         then
                            'Can not use Fit to Text on nodes in object diagrams'
                              ->alertUser
                         else
                            theObject.FitToText
                        if)
                     else
                        'Unknown type of page'->alertUser
                    if)
                if)
             else
                'No current object'->alertUser
            if)
         else
            'No current page'->alertUser
        if)
     #)  

-- RefreshItem: Descriptor --
(#  do (menuID.pageMenu,menuID.pageMenu.Cleanup)->CallOAMenu #)  

-- ReduceItem: Descriptor --
(# thePage: ^Page
do
   (menuID.pageMenu,menuID.pageMenu.reduce)->CallOAMenu;
   currentPage->thePage[];
   (if thePage[] <> none then
       (if thePage.currentObject <> none then
           thePage.currentObject
             ->thePage.currentObject (#  do true->autoPan #)
       if)
   if)
#)  

-- BlowupItem: Descriptor --
(# thePage: ^Page
do
   (menuID.pageMenu,menuID.pageMenu.blowup)->CallOAMenu;
   currentPage->thePage[];
   (if thePage[] <> none then
       (if thePage.currentObject <> none then
           thePage.currentObject
             ->thePage.currentObject (#  do true->autoPan #)
       if)
   if)
#)  

-- AttributesItem: Descriptor --
(# 
do (menuID.pageMenu,menuID.pageMenu.changeFatts)->CallOAMenu
#)
(* -- NewCommentHit: Descriptor --
 * (#  #)  
 * 
 * -- ShowCommentHit: Descriptor --
 * (#
 *    thePage: ^OADPage;
 *    theObject: ^thePage.DesignObject;
 *    theNode: ^thePage.MarkNode;
 *    
 * do
 *    CurrentPage->thePage[];
 *    thePage.CurrentObject->theObject[];
 *    (if theObject[] <> none
 *     // true then
 *        (if theObject## <= thePage.MarkNode##
 *         // true then theObject[]->theNode[]; theNode.activate; 
 *        if);
 *        
 *    if);
 *    
 * #)  
 * 
 * -- HideCommentHit: Descriptor --
 * (#
 *    thePage: ^OADPage;
 *    theObject: ^thePage.DesignObject;
 *    theNode: ^thePage.MarkNode;
 *    
 * do
 *    CurrentPage->thePage[];
 *    thePage.CurrentObject->theObject[];
 *    (if theObject[] <> none
 *     // true then
 *        (if theObject## <= thePage.MarkNode##
 *         // true then theObject[]->theNode[]; theNode.deactivate; 
 *        if);
 *        
 *    if);
 *    
 * #)  
 * 
 * 
 *)  

-- ShowGroupWindowItem: Descriptor --
(#
   thePage: ^Page;
   theOADPage: ^OADPage;
   theObject: ^thePage.DesignObject;
   thePatternDiagramNode: ^theOADPage.PatternDiagramNode
do
   currentPage->thePage[];
   show:
     (# 
     do
        (if thePage[] <> none then
            (if thePage## <= OADPage## then
                (if thePage[] = theGroupPage[] then
                    leave show
                 else
                    thePage[]->theOADPage[];
                    theOADPage.currentObject->theObject[];
                    (if theObject[] <> none then
                        (if theObject## <= theOADPage.PatternDiagramNode## then
                            theObject[]->thePatternDiagramNode[];
                            (thePatternDiagramNode.theDiagram).theFragmentNode
                              ->theGroupPage.currentObject
                        if)
                    if)
                if)
            if)
        if);
        true->theGroupPage.visible;
        (if theGroupPage.currentObject <> none then
            theGroupPage.currentObject->theGroupPage.currentObject;
            ((theGroupPage.currentObject).ID,true)->DSUIAutoPan
        if)
     #)
#)  

-- HidePageItem: Descriptor --
(# 
do
   menuID.PageMenu.closepage
     ->DSUIMenuExecute
     (* false->theGroupPage.visible;
      theWorkPage.currentObject
      ->theWorkPage.currentObject (#  do true->autoPan #)*)
#)  

-- ShowWorkSheetItem: DoPart --
do
   (if currentPage <> theWorkPage[] then
       (if theWorkPage[] <> none then
           true->theWorkPage.visible;
           (if theWorkPage.currentObject <> none then
               theWorkPage.currentObject->theWorkPage.currentObject
           if)
        else
           'No current Work Sheet'->alertUser
       if)
   if)  

-- ShowAllPagesItem: DoPart --
do
   getPages->pages[];
   (if pages[] <> none then
       pages.scan
         (# thePage: ^page
         do current[]->thePage[]; true->thePage.visible
         #)
   if)  

-- HideAllPagesItem: DoPart --
do
   getPages->pages[];
   (if pages[] <> none then
       pages.scan
         (# thePage: ^page
         do current[]->currentPage; menuID.PageMenu.closepage->DSUIMenuExecute
         #)
   if)  

-- PageMenuPageOverView: DoPart --
do menuID.PageMenu.strTree->DSUIMenuExecute  

-- PageMenuInit: Descriptor --
(# 
do
   (UserMenu7+1,'Refresh')->RefreshItem.init;
   (UserMenu7+2,'Reduce')->ReduceItem.init;
   (UserMenu7+3,'BlowUp')->BlowupItem.init;
   (UserMenu7+4,'Attributes...')->AttributesItem.init;
   (UserMenu7+5,'-')->sep1.init;
   sep1.disable;
   (UserMenu7+6,'Group Window')->ShowGroupWindowItem.init;
   (UserMenu7+7,'Work Sheet')->ShowWorkSheetItem.init;
   (UserMenu7+8,'-')->sep2.init;
   sep2.disable;
   (UserMenu7+9,'Hide Page')->HidePageItem.init;
   (UserMenu7+10,'Show All Pages')->ShowAllPagesItem.init;
   (* (UserMenu7+8,'Page Overview')->PageOverview.init;*)
   (* (UserMenu7+11,'Hide All Pages')->HideAllPagesItem.init *)
   
#)
(*
 -- OptionsMenuInit: Descriptor --
 (# 
 do [*(UserMenu3+1,'Composition Marks') -> CompositionWithMarkItem.init;*]
 (UserMenu3+1,'Detailing On Same Page')->OnSamePageItem.init;
 (UserMenu3+2,'Simple Hierarchy Presentation')->hierPresItem.init;
 (UserMenu3+3,'-')->sep1.init;
 (UserMenu3+4,'Name And Type')->SimpleAsNameAndTypeItem.init;
 (UserMenu3+5,'Name')->SimpleAsNameItem.init;
 (UserMenu3+6,'Type')->SimpleAsTypeItem.init;
 (UserMenu3+7,'Type And Kind')->SimpleAsNameAndKindItem.init;
 (UserMenu3+8,'-')->sep2.init;
 [*(UserMenu3+12,'Debug') -> DebugItem.init;
 (UserMenu3+12,'-') -> sep3.init;*]
 INNER Init;
 CompositionWithMarkItem.disable;
 sep1.disable;
 sep2.disable;
 [*sep3.disable;*]
 
 #)  
 
 -- OptionsMenuCheckMarks: Descriptor --
 (# 
 do
 gppProp.DetailedOnSamePage->OnSamePageItem.Check;
 (if gppProp.CompositionDType > gppProp.CompositionNested
 // true then true->CompositionWithMarkItem.Check; 
 else
 false->CompositionWithMarkItem.Check; 
 if);
 true->SimpleAsNameAndTypeItem.Check;
 false->gppProp.SimpleHierarchyPresentation->hierPresItem.check;
 
 #)  
 
 -- DebugItem: Descriptor --
 (# 
 do
 not switch[1]->switch[1]->Check;
 [* and set checkmark *]
 (if switch[1]
 // true then
 'debugging ON!'->screen.putline;
 true->verbose->callbackverbose->objectverbose;
 
 else
 'debugging OFF!'->screen.putline;
 false->verbose->callbackverbose->objectverbose;
 
 if);
 
 #)  
 
 -- MarkMenuInit: Descriptor --
 (# 
 do
 (UserMenu6+1,'New Comment')->NewCommentItem.init;
 NewCommentItem.disable;
 (UserMenu6+2,'Show Comment')->ShowCommentItem.init;
 (UserMenu6+3,'Hide Comment')->HideCommentItem.init;
 INNER Init;
 
 #)  
 
 -- MarkMenuCheckMarks: Descriptor --
 (#  #)  
 *)  

