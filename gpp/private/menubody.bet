ORIGIN '../gppinterface';
LIB_ITEM 'gpp';
INCLUDE '../prettyprintersetup'
        'diagramattributes'
        '~beta/sysutils/time'
        '~beta/guienv/keys';
-- theFileMenuNewGraphicsPage: DoPart --
do
   (if theDocument[] <> none then
       &theDocument.Page
         (# onInit::  (#  do theWindow[]->sifInsertInWindowsMenu #) #)[]
         ->thePage[];
       thePage.new;
       'Graphics Page (Graphics)'
         ->
           thePage.pageTitle
           (* else
            &OADDocument[]->theDocument[]->theOADDocument[];
            theDocument.new;
            theDocument.currentPage->theOADDocument.theGroupPage[];
            'Group Window'->theOADDocument.theGroupPage.PageTitle;
            &theOADDocument.OADPage[]->theOADDocument.theWorkPage[];
            theOADDocument.theWorkPage.InvisibleNew;
            'WorkSheet'->theOADDocument.theWorkPage.PageTitle;
            &theDocument.Page
            (# onInit::  (#  do theWindow[]->sifInsertInWindowsMenu #) #)[]
            ->thePage[];
            thePage.new;
            'Graphics Page'->thePage.pageTitle;
            thePage[]->theDocument.currentPage *)
   if)  

-- theFileMenuOpen: Descriptor --
(# name,fname: @Text; help,ext: ^Text; didRecover: @boolean
do
   fileSelectDialog->name;
   name[]->openFile;
   (* thisOp:
    (if name.length > 0
    // true then
    name->getExtension->ext[];
    (if ('.bet'->ext.equal) or (mps.astFileExtension->ext.equal) then
    name->removeExtension->name;
    (if currentDiagramName[] = none then
    name.copy->currentDiagramName[];
    '.diag'->currentDiagramName.append;
    
    if);
    (if [*switch[1]*] true then
    'Opening: '->puttext; name[]->putline; 
    if);
    name->openFragmentGroup
    else
    (if '.diag'->ext.equal then
    (if currentDiagramName[] = none then
    name
    ->checkAutoSaveFile
    (#
    error::< 
    (#  do msg[]->AlertUser; leave thisOp #)
    #)->didRecover;
    name->removeExtension->fname;
    '.freja'->fname.append;
    fname
    ->scanASTfiles
    (# 
    do
    currentGroupName[]->putline;
    currentModTime->putint;
    newline
    #);
    (if (name,didRecover,true)->checkDiagFile then
    name->openDiagram
    if)
    else
    'You cannot open more than one diagram'->alertUser
    if)
    else
    'Please select a .bet, .ast or .diag file'->GppAlert
    if)
    if);
    
    if)*)
   
#)  

-- theFileMenuClose: Descriptor --
(# pages: ^ObjectList
do
   (if theDocument[] <> none then
       theDocument.getPages->pages[];
       (if pages[] <> none then
           pages.scan
             (# thePage: ^theDocument.page
             do current[]->thePage[]; false->thePage.visible
             #)
       if)
   if)
#)  

-- theFileMenuSave: Descriptor --
(#  do saveFiles; doIgnoreGroupSaved (#  do sifSave #) #)  

-- theFileMenuSaveAs: Descriptor --
(#
   name: @Text;
   ext,help: ^Text;
   pages: [0] @integer;
   filename: @Text;
   aFile: @file
do
   fileCreateDialog->name;
   thisOp:
   (if name.length > 0
    // true then
       name->getExtension->ext[];
       (if ('.diag'->ext.equal) or (ext.length = 0) then
           (if CurrentDiagramName[] <> none then
               '#'->((currentDiagramName->prependCurrentPath).copy).append
                 ->aFile.name;
               (if aFile.entry.exists then
                   aFile.delete;
                   'rm %s\n'->putformat (#  do aFile.name->s #)
               if)
           if);
           (if ext.length = 0 then '.diag'->name.append if);
           name[]->CurrentDiagramName[];
           (* set new frejaMark on all fragmentgroups *)
           saveFiles;
           doIgnoreGroupSaved
             (#  do sifSave #)
        else
           'Extension must be .diag for saved diagrams!'->AlertUser
       if);
       
   if)
#)  

-- theFileMenuRevert: Descriptor --
(# 
do
   (if currentDiagramName[] <> none then
       (currentDiagramName,false)->theDesignInterface.revert
    else
       'No current diagram?!'->putline
   if)
#)  

-- theFileMenuPreferences: DoPart --
do   

-- theFileMenuLoadGraphicsPage: DoPart --
do
   fileSelectDialog->filename;
   (if filename.length > 0 then filename[]->loadGraphicsPages if)  

-- theFileMenuSavePageAsGraphics: DoPart --
do
   (if theDocument[] <> none then
       theDocument.currentPage->thePage[];
       (if thePage[] <> none then fileSavePage if)
    else
       'No current document'->alertUser
   if)  

-- theFileMenuInit: Descriptor --
(# 
do
   (UserMenu3+1,'New Diagram...')->NewBetaLibrary.init;
   ('n',true,false,false)->NewBetaLibrary.shortcut.set;
   (* (UserMenu3+2,'New BETA Program')->NewBetaProgram.init; *)
   (UserMenu3+2,'New Graphics Page...')->NewGraphicsPage.init;
   (UserMenu3+3,'Open...')->Open.init;
   ('o',true,false,false)->open.shortcut.set;
   (UserMenu3+4,'-')->sep1.init;
   (UserMenu3+5,'Save')->Save.init;
   ('s',true,false,false)->Save.shortcut.set;
   (UserMenu3+6,'Save As...')->SaveAs.init;
   (UserMenu3+7,'Revert')->Revert.init;
   (UserMenu3+8,'Save Page As Graphics...')->SavePageAsGraphics.init;
   (* (UserMenu3+9,'Load As Graphics...')->LoadGraphicsPage.init; *)
   (UserMenu3+10,'-')->sep2.init;
   (UserMenu3+11,'Page Setup...')->PageSetup.init;
   (UserMenu3+12,'Print...')->Print.init;
   ('p',true,false,false)->Print.shortcut.set;
   (UserMenu3+13,'-')->sep3.init;
   (UserMenu3+14,'Close')->Close.init;
   ('w',true,false,false)->Close.shortcut.set;
   (* (UserMenu3+19,'About')->About.init; *)
   (* (UserMenu3+20,'Help')->Help.init; *)
   (* (UserMenu3+18,'-')->sep4.init; *)
   (* (UserMenu3+22,'Hide Sif')->hideShowSifItem.init;*)
   (* (UserMenu3+23,'-')->sep5.init; *)
   (* (UserMenu3+19,'\\qQuit')->Quit.init; *)
   (* sep1.disable; *)
   sep2.disable;
   Close.disable;
   sep3.disable;
   Revert.disable;
   (* sep4.disable; *)
   (* About.disable; *)
   (* Help.disable; *)
   PageSetup.disable
#)  

-- AbstractHit: Descriptor --
(#
   thePage: ^Page;
   theOADPage: ^OADPage;
   theObjectPage: ^ObjectPage;
   theObject: ^thePage.DesignObject;
   theNode: ^theOADPage.PatternDiagramNode;
   detailnode: ^theObjectPage.DetailedObjectNode;
   
do
   true->busyCursor;
   CurrentPage->thePage[];
   (if thePage[] <> none then
       false->repair;
       (if thePage## <= OADPage## then
           thePage[]->theOADPage[];
           theOADPage.CurrentObject->theObject[];
           (if theObject[] <> none then
               (if theObject## <= theOADPage.PatternDiagramNode## then
                   theObject[]->theNode[]; theNode.abstract; 
                else
                   'Selection is not a DiagramNode'->alertUser; 
               if);
               
            else
               'No Selection'->alertUser; 
           if)
        else
           (if thePage## <= ObjectPage## then
               thePage[]->theObjectPage[];
               theObjectPage.CurrentObject->theObject[];
               (if theObject## <= theObjectPage.DetailedObjectNode## then
                   theObject[]->detailnode[]; detailnode.abstract
                else
                   'Can not be invoked on this type of node'->alertUser
               if)
            else
               'Can not be invoked on this type of page'->alertUser
           if)
       if);
       true->repair
    else
       'No current page'->alertUser
   if);
   false->busyCursor;
   
#)  

-- ViewMenuAbstractRecursivelyItem: DoPart --
do
     (#
        thePage: ^Page;
        theOADPage: ^OADPage;
        theObjectPage: ^ObjectPage;
        theObject: ^thePage.DesignObject;
        theNode: ^theOADPage.PatternDiagramNode;
        detailnode: ^theObjectPage.DetailedObjectNode;
        
     do
        true->busyCursor;
        CurrentPage->thePage[];
        (if thePage[] <> none then
            false->repair;
            (if thePage## <= OADPage## then
                thePage[]->theOADPage[];
                theOADPage.CurrentObject->theObject[];
                (if theObject[] <> none then
                    (if theObject## <= theOADPage.PatternDiagramNode## then
                        theObject[]->theNode[]; theNode.abstractRecursively; 
                     else
                        'Selection is not a DiagramNode'->alertUser; 
                    if);
                    
                 else
                    'No Selection'->alertUser; 
                if)
             else
                (if thePage## <= ObjectPage## then
                    thePage[]->theObjectPage[];
                    theObjectPage.CurrentObject->theObject[];
                    (if theObject## <= theObjectPage.DetailedObjectNode## then
                        theObject[]->detailnode[]; detailnode.abstractRecursive
                     else
                        'Can not be invoked on this type of node'->alertUser
                    if)
                 else
                    'Can not be invoked on this type of page'->alertUser
                if)
            if);
            true->repair
         else
            'No current page'->alertUser
        if);
        false->busyCursor;
        
     #)  

-- ViewMenuOverviewItem: DoPart --
do
     (#
        thePage: ^Page;
        theOADPage: ^OADPage;
        theObjectPage: ^ObjectPage;
        theObject: ^thePage.DesignObject;
        theNode: ^theOADPage.PatternDiagramNode;
        theObjectDiagramNode: ^theObjectPage.ObjectDiagramNode;
        
     do
        CurrentPage->thePage[];
        (if thePage[] <> none then
            false->repair;
            (if thePage## <= OADPage## then
                thePage[]->theOADPage[];
                theOADPage.CurrentObject->theObject[];
                (if theObject[] <> none then
                    (if theObject## <= theOADPage.PatternDiagramNode## then
                        theObject[]->theNode[]; theNode.overview; 
                     else
                        'Selection is not a DiagramNode'->alertUser; 
                    if);
                    
                 else
                    'No Selection'->alertUser; 
                if)
             else
                (if thePage## <= ObjectPage## then
                    thePage[]->theObjectPage[];
                    theObjectPage.CurrentObject->theObject[];
                    (if theObject[] <> none then
                        (if theObject## <= theObjectPage.ObjectDiagramNode##
                         then
                            theObject[]->theObjectDiagramNode[];
                            theObjectDiagramNode.overview
                         else
                            'Can not be invoked on this type of object'
                              ->alertUser
                        if)
                     else
                        'No current object'->alertUser
                    if)
                 else
                    'Can not be invoked on this type of page'->alertUser
                if)
            if);
            true->repair
         else
            'No current page'->alertUser
        if);
        
     #)  

-- DetailHit: Descriptor --
(#
   thePage: ^Page;
   theOADPage: ^OADPage;
   theObjectPage: ^ObjectPage;
   theObject: ^thePage.DesignObject;
   theNode: ^theOADPage.PatternDiagramNode;
   abstrnode: ^theObjectPage.AbstractedObjectNode;
   
do
   CurrentPage->thePage[];
   (if thePage[] <> none then
       false->repair;
       (if thePage## <= OADPage## then
           thePage[]->theOADPage[];
           theOADPage.CurrentObject->theObject[];
           (if theObject[] <> none then
               (if theObject## <= theOADPage.PatternDiagramNode## then
                   theObject[]->theNode[]; theNode.detail
                else
                   'Selection is not a DiagramNode'->alertUser; 
               if);
               
            else
               'No Selection'->alertUser; 
           if)
        else
           (if thePage## <= ObjectPage## then
               thePage[]->theObjectPage[];
               theObjectPage.CurrentObject->theObject[];
               (if theObject[] <> none then
                   (if theObject## <= theObjectPage.AbstractedObjectNode## then
                       theObject[]->abstrNode[];
                       (if abstrnode.pagelink[] = none then
                           abstrnode.detail
                        else
                           abstrnode.pagelink[]->CurrentPage
                       if)
                    else
                       'Can not be invoked on this type of node'->alertUser
                   if)
                else
                   'No current object'->alertUser
               if)
            else
               'Can not be invoked on this type of page'->alertUser
           if)
       if);
       true->repair
    else
       'No current page'->alertUser
   if);
   
#)  

-- ViewMenuDetailRecursivelyItem: DoPart --
do
     (#
        thePage: ^Page;
        theOADPage: ^OADPage;
        theObjectPage: ^ObjectPage;
        theObject: ^thePage.DesignObject;
        theNode: ^theOADPage.PatternDiagramNode;
        abstrNode: ^theObjectPage.AbstractedObjectNode;
        
     do
        CurrentPage->thePage[];
        (if thePage[] <> none then
            false->repair;
            (if thePage## <= OADPage## then
                thePage[]->theOADPage[];
                theOADPage.CurrentObject->theObject[];
                (if theObject[] <> none then
                    (if theObject## <= theOADPage.PatternDiagramNode## then
                        theObject[]->theNode[]; theNode.detailRecursively
                     else
                        'Selection is not a DiagramNode'->alertUser; 
                    if);
                    
                 else
                    'No Selection'->alertUser; 
                if)
             else
                (if thePage## <= ObjectPage## then
                    thePage[]->theObjectPage[];
                    theObjectPage.CurrentObject->theObject[];
                    (if theObject[] <> none then
                        (if theObject## <= theObjectPage.AbstractedObjectNode##
                         then
                            theObject[]->abstrNode[];
                            (if abstrnode.pagelink[] = none then
                                abstrnode.detailRecursive
                             else
                                abstrnode.pagelink[]->CurrentPage
                            if)
                         else
                            'Detail Recursively can not be invoked on this type of object'
                              ->alertUser
                        if)
                     else
                        'No current object'->alertUser
                    if)
                 else
                    'Can not be invoked on this type of page'->alertUser
                if)
            if);
            true->repair
         else
            'No current page'->alertUser
        if);
        
     #)  

-- ViewMenuDetailOnDifferentPageItem: DoPart --
do
     (#
        p: ^Page;
        oPage: ^ObjectPage;
        theObject: ^p.DesignObject;
        objectnode: ^oPage.ObjectDiagramNode;
        abstrNode,node: ^oPage.AbstractedObjectNode
     do
        CurrentPage->p[];
        (if p[] <> none then
            (if p## <= OADPage## then
                'Not yet implemented for pattern diagrams'->alertUser
             else
                (if p## <= ObjectPage## then
                    p[]->oPage[];
                    oPage.CurrentObject->theObject[];
                    (if theObject[] <> none then
                        theObject[]->objectnode[];
                        (if objectnode## <= oPage.AbstractedObjectNode##
                         // true then
                            objectnode[]->abstrNode[];
                            3->AbstrNode.linethickness;
                            (if objectNode##
                             // theObjectPage.AbstrPartObjectNode## then
                                &ObjectPage[]->theObjectPage[]
                                  ->AbstrNode.pagelink[];
                                theObjectPage.new;
                                theObjectPage[]->CurrentPage;
                                &theObjectPage.AbstrPartObjectNode[]->node[]
                             // theObjectPage.AbstrPartComponentNode## then
                                &ObjectPage[]->theObjectPage[]
                                  ->AbstrNode.pagelink[];
                                theObjectPage.new;
                                theObjectPage[]->CurrentPage;
                                &theObjectPage.AbstrPartComponentNode[]->node[]
                             // theObjectPage.AbstrDynamicObjectNode## then
                                &ObjectPage[]->theObjectPage[]
                                  ->AbstrNode.pagelink[];
                                theObjectPage.new;
                                theObjectPage[]->CurrentPage;
                                &theObjectPage.AbstrDynamicObjectNode[]->node[]
                             // theObjectPage.AbstrDynamicComponentNode## then
                                &ObjectPage[]->theObjectPage[]
                                  ->AbstrNode.pagelink[];
                                theObjectPage.new;
                                theObjectPage[]->CurrentPage;
                                &theObjectPage.AbstrDynamicComponentNode[]
                                  ->node[]
                             // theObjectPage.AbstrOperationObjectNode## then
                                &ObjectPage[]->theObjectPage[]
                                  ->AbstrNode.pagelink[];
                                theObjectPage.new;
                                theObjectPage[]->CurrentPage;
                                &theObjectPage.AbstrOperationObjectNode[]
                                  ->node[]
                            if);
                            'Object Page'->theObjectPage.PageTitle;
                            (objectnode.theDecl[],
                             objectnode.theObjectDescriptor[],false)
                              ->node.display;
                            node[]->theObjectPage.CurrentObject;
                            node.detail
                        if)
                     else
                        'No current object'->alertUser
                    if)
                 else
                    'Can not be invoked on this type of page'->alertUser
                if)
            if)
         else
            'No current page'->alertUser
        if)
     #)  

-- viewMenuBringToFrontItem: DoPart --
do
     (# thePage: ^Page; theObject: ^thePage.DesignObject
     do
        CurrentPage->thePage[];
        (if thePage[] <> none then
            thePage.CurrentObject->theObject[];
            (if theObject[] <> none then
                theObject.bringToFront
             else
                'No Selection'->alertUser; 
            if)
         else
            'No current page'->alertUser
        if)
     #)  

-- viewMenuSendToBackItem: DoPart --
do
     (# thePage: ^Page; theObject: ^thePage.DesignObject
     do
        CurrentPage->thePage[];
        (if thePage[] <> none then
            thePage.CurrentObject->theObject[];
            (if theObject[] <> none then
                theObject.sendToBack
             else
                'No Selection'->alertUser; 
            if)
         else
            'No current page'->alertUser
        if)
     #)  

-- ViewMenuTestItem: DoPart --
do
     (#
        thePage: ^OADPage;
        theConn: ^myConn;
        myConn: thePage.Connector
          (#
             oninit:: 
               (#
                  object1,object2: ^thePage.DesignObject;
                  thenode: ^thepage.node;
                  x,y,w,h: @integer;
                  p: [8] @integer
               do
                  0->orient;
                  true->getEnds->(object1[],object2[]);
                  &thepage.node[]->thenode[];
                  object1.geometry->(x,y,w,h);
                  x+w div 2+gppProp.halfDiamondNodeWidth->x;
                  (x,y,0,0)->thenode.new;
                  0->p[1];
                  - gppProp.halfDiamondNodeHeight->p[2];
                  gppProp.halfDiamondNodeWidth->p[3];
                  0->p[4];
                  0->p[5];
                  gppProp.halfDiamondNodeHeight->p[6];
                  - gppProp.halfDiamondNodeWidth->p[7];
                  0->p[8];
                  (for i: p.range repeat p[i]->wcoord->p[i] for);
                  (theWorkPage.ID,4,p)->designUtils.createPolygon
                    ->thenode.onInit;
                  (x,y)->thenode.center;
                  (thenode.getTopParent,thenode[],object2.getTopParent,
                   object2[])->setends;
                  
               #)
          #)
     do
        CurrentPage->thePage[];
        (if thePage[] <> none then
            &myConn[]->theConn[]; theConn.interactiveNew
        if)
     #)  

-- ViewMenuAllSelectableAndMoveableItem: DoPart --
do
   theObjectList.scan
     (#
        thePage: ^OADPage;
        dobj: ^thePage.designObject;
        theNode: ^thePage.Node
     do
        CurrentPage->thePage[];
        (if thePage[] <> none then
            (if current## <= thePage.designObject## then
                current[]->dobj[];
                true->dobj.selectable;
                (if dobj## <= thePage.node## then
                    dobj[]->theNode[]; true->theNode.moveable
                if)
            if)
        if)
     #)  

-- ViewMenuDumpNodeItem: Descriptor --
(#
   thePage: ^OADPage;
   theObject: ^thePage.DesignObject;
   thePatternDiagramNode: ^thePage.PatternDiagramNode;
   theDelCon: ^thePage.DeletableConnector;
   regions: ^ObjectList
do
   CurrentPage->thePage[];
   (if thePage[] <> none
    // true then
       thePage.CurrentObject->theObject[];
       (if theObject[] <> none then
           (if theObject## <= thePage.PatternDiagramNode## then
               theObject[]->thePatternDiagramNode[];
               thePatternDiagramNode.dump;
               thePatternDiagramNode.getRegionList->regions[];
               '***** regions *****'->putline;
               (if regions[] <> none then
                   regions.scan
                     (#  do current.id->putint; ' '->puttext #);
                   newline
                else
                   'is NONE'->putline
               if)
            else
               (if theObject## <= thePage.DeletableConnector## then
                   theObject[]->theDelCon[]; theDelCon.dump
                else
                   'ID: %i geometry: %i %i %i %i\n'
                     ->putFormat
                       (# x,y,w,h: @integer
                       do
                          theObject.ID->i;
                          theObject.geometry->(x,y,w,h);
                          x->i;
                          y->i;
                          w->i;
                          h->i
                       #)
               if)
           if);
           
       if)
   if)
#)  

-- DumpInheritanceItem: Descriptor --
(#  do theWorkPage.patterndiagrams.InheritanceList.dump #)  

-- DumpAssociationItem: Descriptor --
(#  do theWorkPage.patterndiagrams.AssociationList.dump #)  

-- DumpAggregationListItem: DoPart --
do theWorkPage.patterndiagrams.AggregationList.dump  

-- DumpIndexIDListItem: Descriptor --
(#  do 'IndexIDList is no longer in use!'->putline #)  

-- DumpAlternativeIndexIDListItem: DoPart --
do
   'Alternative IndexIDList:'->putline;
   theGroupPage.patternDiagrams.theList.scan
     (# theListDiagram: ^theGroupPage.ListDiagram
     do
        (if current.e## <= theGroupPage.ListDiagram## then
            current.e[]->theListDiagram[];
            theListDiagram.localNodes.scan
              (# theFragmentNode: ^theListDiagram.FragmentNode
              do
                 (if current## <= theListDiagram.FragmentNode## then
                     current[]->theFragmentNode[];
                     '('->puttext;
                     theFragmentNode.theRoot.index->putint;
                     ','->puttext;
                     current.ID->putint;
                     ') '->puttext
                 if)
              #)
        if)
     #);
   (if theWorkPage[] <> none then
       theWorkPage.patternDiagrams.theList.scan
         (# theListDiagram: ^theWorkPage.ListDiagram
         do
            (if current.e## <= theWorkPage.ListDiagram## then
                current.e[]->theListDiagram[];
                theListDiagram.localNodes.scan
                  (#
                     theDiagramNode: ^theListDiagram.DiagramNode;
                     theNonTerminalNode: ^theListDiagram.NonTerminalNode
                  do
                     (if current## <= theListDiagram.DiagramNode## then
                         current[]->theDiagramNode[];
                         '('->puttext;
                         theDiagramNode.theDeclaration.index->putint;
                         ','->puttext;
                         current.ID->putint;
                         ') '->puttext
                     if);
                     (if current## <= theListDiagram.NonTerminalNode## then
                         current[]->theNonTerminalNode[];
                         '('->puttext;
                         theNonTerminalnode.unExp.index->putint;
                         ','->puttext;
                         current.ID->putint;
                         ') '->puttext
                     if)
                  #)
            if)
         #)
   if);
   newline  

-- dumpLocalNodesItem: DoPart --
do
     (#
        thePage: ^OADPage;
        theObject: ^thePage.DesignObject;
        thePatternDiagramNode: ^thePage.PatternDiagramNode;
        theDiagram: ^thePage.ListDiagram;
        oadd: ^thePage.OADDiagram
     do
        CurrentPage->thePage[];
        (if thePage[] <> none
         // true then
            thePage.CurrentObject->theObject[];
            (if theObject[] <> none then
                (if theObject## <= thePage.PatternDiagramNode## then
                    theObject[]->thePatternDiagramNode[];
                    thePatternDiagramNode.theDiagram->theDiagram[];
                    'LocalNodes:'->putline;
                    theDiagram.localNodes.dump;
                    'LocalNodes End'->putline;
                    (if theDiagram## <= thePage.OADDiagram## then
                        theDiagram[]->oadd[];
                        newline;
                        'attributes'->putline;
                        oadd.attributes.dump;
                        'attributes End'->putline;
                        newline;
                        'operations'->putline;
                        oadd.operations.dump;
                        'operations End'->putline;
                        newline;
                        'local classes'->putline;
                        oadd.localClasses.dump;
                        'local classes End'->putline;
                        newline
                    if)
                if);
                
            if)
        if)
     #)  

-- dumpDiagramListItem: DoPart --
do
     (# thePage: ^OADPage
     do
        CurrentPage->thePage[];
        (if thePage[] <> none then thePage.patternDiagrams.theList.dump if)
     #)  

-- dumpFrejaMarkHit: DoPart --
do
   CurrentPage->thePage[];
   (if thePage[] <> none
    // true then
       thePage.CurrentObject->theObject[];
       (if theObject[] <> none then
           (if theObject## <= thePage.PatternDiagramNode## then
               theObject[]->thePatternDiagramNode[];
               thePatternDiagramNode.getAstNode->anAST[];
               (if anAST[] <> none then
                   '%s frejamark=%i\n'
                     ->putformat
                       (# 
                       do
                          (anAST.frag.father).name->s;
                          anAST.frag.father->sifGetFrejaMark->i
                       #)
               if)
           if);
           
       if)
   if)  

-- dumpNodeIDHit: DoPart --
do
     (# thePage: ^Page; theObject: ^thePage.DesignObject
     do
        CurrentPage->thePage[];
        (if thePage[] <> none
         // true then
            thePage.CurrentObject->theObject[];
            (if theObject[] <> none
             // true then
                'ID: '->puttext;
                theObject.ID->putint;
                newline;
                tomato4->theObject.fillType;
                
            if)
        if)
     #)  

-- ViewMenuTraceItem: Descriptor --
(# 
do
   not switch[99]->switch[12]->switch[17]->switch[30]->switch[40]->switch[50]
     ->switch[51]->switch[52]->switch[53]->switch[54]->switch[60]->switch[70]
     ->switch[80]->switch[90]->switch[99]->switch[1]
#)
(*
 -- classificationHit: Descriptor --
 (#
 thePage: ^OADPage;
 theObject: ^thePage.DesignObject;
 theNode: ^thePage.PatternDiagramNode;
 
 do
 CurrentPage->thePage[];
 (if thePage[] <> none
 // true then
 thePage.CurrentObject->theObject[];
 (if theObject[] <> none
 // true then
 (if theObject## <= thePage.PatternDiagramNode##
 // true then
 theObject[]->theNode[];
 false->gppProp.ShowLocals;
 theNode.detail;
 true->gppProp.ShowLocals;
 
 else
 'Selection is not a DiagramNode'->AlertUser; 
 if);
 
 else
 'No Selection'->AlertUser; 
 if)
 if);
 
 #)  
 
 -- nestedCompositionHit: Descriptor --
 [* The traditional way; name and all attributes *]
 (#
 thePage: ^OADPage;
 theObject: ^thePage.DesignObject;
 theNode: ^thePage.PatternDiagramNode;
 
 do
 CurrentPage->thePage[];
 (if thePage[] <> none
 // true then
 thePage.CurrentObject->theObject[];
 (if theObject[] <> none
 // true then
 (if theObject## <= thePage.PatternDiagramNode##
 // true then
 theObject[]->theNode[];
 gppProp.CompositionNested->gppProp.CompositionDType;
 gppProp.CompositionAll->gppProp.CompositionWith;
 theNode.detail
 else
 'Selection is not a DiagramNode'->GppAlert; 
 if);
 
 else
 'No Selection'->GppAlert; 
 if)
 if);
 
 #)  
 
 -- nestedwholePartHit: Descriptor --
 (#
 thePage: ^OADPage;
 theObject: ^thePage.DesignObject;
 theNode: ^thePage.PatternDiagramNode;
 
 do
 CurrentPage->thePage[];
 (if thePage[] <> none
 // true then
 thePage.CurrentObject->theObject[];
 (if theObject[] <> none
 // true then
 (if theObject## <= thePage.PatternDiagramNode##
 // true then
 theObject[]->theNode[];
 gppProp.CompositionNested->gppProp.CompositionDType;
 gppProp.CompositionPartWhole->gppProp.CompositionWith;
 theNode.detail;
 
 else
 'Selection is not a DiagramNode'->GppAlert; 
 if);
 
 else
 'No Selection'->GppAlert; 
 if)
 if);
 
 #)  
 
 -- nestedReferenceHit: Descriptor --
 (#
 thePage: ^OADPage;
 theObject: ^thePage.DesignObject;
 theNode: ^thePage.PatternDiagramNode;
 
 do
 CurrentPage->thePage[];
 (if thePage[] <> none
 // true then
 thePage.CurrentObject->theObject[];
 (if theObject[] <> none
 // true then
 (if theObject## <= thePage.PatternDiagramNode##
 // true then
 theObject[]->theNode[];
 gppProp.CompositionNested->gppProp.CompositionDType;
 gppProp.CompositionReference->gppProp.CompositionWith;
 theNode.detail;
 
 else
 'Selection is not a DiagramNode'->GppAlert; 
 if);
 
 else
 'No Selection'->GppAlert; 
 if)
 if);
 
 #)  
 
 -- nestedblockStructureHit: Descriptor --
 (#
 thePage: ^OADPage;
 theObject: ^thePage.DesignObject;
 theNode: ^thePage.PatternDiagramNode;
 
 do
 CurrentPage->thePage[];
 (if thePage[] <> none
 // true then
 thePage.CurrentObject->theObject[];
 (if theObject[] <> none
 // true then
 (if theObject## <= thePage.PatternDiagramNode##
 // true then
 theObject[]->theNode[];
 gppProp.CompositionNested->gppProp.CompositionDType;
 gppProp.CompositionBlock->gppProp.CompositionWith;
 theNode.detail;
 
 else
 'Selection is not a DiagramNode'->GppAlert; 
 if);
 
 else
 'No Selection'->GppAlert; 
 if)
 if);
 
 #)  
 
 -- treeCompositionHit: Descriptor --
 (#
 thePage: ^OADPage;
 theObject: ^thePage.DesignObject;
 theNode: ^thePage.PatternDiagramNode;
 
 do
 CurrentPage->thePage[];
 (if thePage[] <> none
 // true then
 thePage.CurrentObject->theObject[];
 (if theObject[] <> none
 // true then
 (if theObject## <= thePage.PatternDiagramNode##
 // true then
 theObject[]->theNode[];
 gppProp.CompositionTree->gppProp.CompositionDType;
 gppProp.CompositionAll->gppProp.CompositionWith;
 theNode.detail;
 
 else
 'Selection is not a DiagramNode'->GppAlert; 
 if);
 
 else
 'No Selection'->GppAlert; 
 if)
 if);
 
 #)  
 
 -- treewholePartHit: Descriptor --
 (#
 thePage: ^OADPage;
 theObject: ^thePage.DesignObject;
 theNode: ^thePage.PatternDiagramNode;
 
 do
 CurrentPage->thePage[];
 (if thePage[] <> none
 // true then
 thePage.CurrentObject->theObject[];
 (if theObject[] <> none
 // true then
 (if theObject## <= thePage.PatternDiagramNode##
 // true then
 theObject[]->theNode[];
 gppProp.CompositionTree->gppProp.CompositionDType;
 gppProp.CompositionPartWhole->gppProp.CompositionWith;
 theNode.detail;
 
 else
 'Selection is not a DiagramNode'->GppAlert; 
 if);
 
 else
 'No Selection'->GppAlert; 
 if)
 if);
 
 #)  
 
 -- treeReferenceHit: Descriptor --
 (#
 thePage: ^OADPage;
 theObject: ^thePage.DesignObject;
 theNode: ^thePage.PatternDiagramNode;
 
 do
 CurrentPage->thePage[];
 (if thePage[] <> none
 // true then
 thePage.CurrentObject->theObject[];
 (if theObject[] <> none
 // true then
 (if theObject## <= thePage.PatternDiagramNode##
 // true then
 theObject[]->theNode[];
 gppProp.CompositionTree->gppProp.CompositionDType;
 gppProp.CompositionReference->gppProp.CompositionWith;
 theNode.detail;
 
 else
 'Selection is not a DiagramNode'->GppAlert; 
 if);
 
 else
 'No Selection'->GppAlert; 
 if)
 if);
 
 #)  
 
 -- treeblockStructureHit: Descriptor --
 (#
 thePage: ^OADPage;
 theObject: ^thePage.DesignObject;
 theNode: ^thePage.PatternDiagramNode;
 
 do
 CurrentPage->thePage[];
 (if thePage[] <> none
 // true then
 thePage.CurrentObject->theObject[];
 (if theObject[] <> none
 // true then
 (if theObject## <= thePage.PatternDiagramNode##
 // true then
 theObject[]->theNode[];
 gppProp.CompositionTree->gppProp.CompositionDType;
 gppProp.CompositionBlock->gppProp.CompositionWith;
 theNode.detail;
 
 else
 'Selection is not a DiagramNode'->GppAlert; 
 if);
 
 else
 'No Selection'->GppAlert; 
 if)
 if);
 
 #)  
 
 -- CombinedHit: Descriptor --
 (# [* display inheritance diagram with composition boxes around *] 
 do 'Combined Not yet implemented'->gppAlert; 
 #)  
 
 -- HierPresHit: Descriptor --
 (# 
 do
 not gppProp.SimpleHierarchyPresentation->gppProp.SimpleHierarchyPresentation
 ->check
 #)  
 *)  

-- ViewMenuInit: Descriptor --
(# i: @integer;
   spk: @specialkeys;
do
   (UserMenu4+(i+1->i),'Abstract')->AbstractItem.init;
   (UserMenu4+(i+1->i),'Abstract Recursively')
     ->AbstractRecursivelyItem.init;
   (spk.LEFT,false,true,false)->AbstractRecursivelyItem.shortcut.set;
   (UserMenu4+(i+1->i),'Overview')->OverviewItem.init;
   (spk.UP,false,true,false)->OverviewItem.shortcut.set;
   (UserMenu4+(i+1->i),'Detail')->DetailItem.init;
   (spk.RIGHT,false,true,false)->DetailItem.shortcut.set;
   (UserMenu4+(i+1->i),'Detail Recursively')->DetailRecursivelyItem.init;
   (spk.DOWN,false,true,false)->DetailRecursivelyItem.shortcut.set;
   (UserMenu4+(i+1->i),'-')->sep5.init;
   (UserMenu4+(i+1->i),'Layout Subclasses')->LayoutSubpatterns.init;
   (UserMenu4+(i+1->i),'Edged Specialization connectors')
     ->EdgedSpecializationConnectors.init;
   (*   (UserMenu4+(i+1->i),'-')->sep6.init;
    (UserMenu4+(i+1->i),'Show Attributes')->ShowAttributesItem.init;
    (UserMenu4+(i+1->i),'Automatic Sub-pattern Layout')
    ->AutoSubPatternLayoutItem.init;
    (UserMenu4+(i+1->i),'-')->sep4.init;
    (UserMenu4+(i+1->i),'Name And Type               (X:@P)')
    ->SimpleAsNameAndTypeItem.init;
    (UserMenu4+(i+1->i),'Name                        (X)')
    ->SimpleAsNameItem.init;
    (UserMenu4+(i+1->i),'Type                        (:P)')
    ->SimpleAsTypeItem.init;
    (UserMenu4+(i+1->i),'Name And Kind               (X:@)')
    ->SimpleAsNameAndKindItem.init;
    (UserMenu4+(i+1->i),'References')->ReferencesItem.init;
    (UserMenu4+(i+1->i),'Specializations')->SpecializationsItem.init;
    (UserMenu4+(i+1->i),'Associations')->AssociationsItem.init; *)
   (* (UserMenu4+(i+1->i),'-')->sep2.init;
    (UserMenu4+(i+1->i),'Text Attributes')->TextAttributesItem.init;
    (UserMenu4+(i+1->i),'Fit To Text')->FitToTextItem.init; *)
   (UserMenu4+(i+1->i),'-')->sep.init;
   (UserMenu4+(i+1->i),'Bring To Front')->BringToFrontItem.init;
   (UserMenu4+(i+1->i),'Send To Back')->SendToBackItem.init;
   (UserMenu4+(i+1->i),'-')->sep3.init;
   (* (UserMenu4+(i+1->i),'View Preferences...')->LayoutPreferencesItem.init; *)
   (UserMenu4+(i+1->i),'Show All...')->ShowItem.init;
   (UserMenu4+(i+1->i),'Hide All...')->HideItem.init;
   (UserMenu4+(i+1->i),'Show Attributes With...')->ShowAttributesWithItem.init;
   (UserMenu4+(i+1->i),'-')->sep6.init;
   (UserMenu4+(i+1->i),'Refresh Page')->RefreshItem.init;
   (UserMenu4+(i+1->i),'Scroll Selection Into View')->ScrollIntoViewItem.init;
   (UserMenu4+(i+1->i),'Show All Elements')->showAllDesignPicturesItem.init;
   (if switch[1] then
       (UserMenu4+(i+1->i),'-')->sep4.init;
       (UserMenu4+(i+1->i),'Test')->TestItem.init;
       (UserMenu4+(i+1->i),'Make all objects selectable & moveable')
         ->allSelectableAndMoveableItem.init;
       (UserMenu4+(i+1->i),'Dump node')->DumpNodeItem.init;
       (UserMenu4+(i+1->i),'Debug on/off')->TraceItem.init;
       (UserMenu4+(i+1->i),'User data trace on/off')->TraceUserDataItem.init;
       (UserMenu4+(i+1->i),'Callback trace on/off')->TraceCallbacksItem.init;
       (UserMenu4+(i+1->i),'Dump inheritance list')
         ->DumpInheritanceListItem.init;
       (UserMenu4+(i+1->i),'Dump association list')
         ->DumpAssociationListItem.init;
       (UserMenu4+(i+1->i),'Dump aggregation list')
         ->DumpAggregationListItem.init;
       (UserMenu4+(i+1->i),'Communication trace on/off')
         ->TraceCommunicationItem.init;
       (UserMenu4+(i+1->i),'Dump indexIDList')->DumpIndexIDListItem.init;
       (UserMenu4+(i+1->i),'Dump alternative indexIDList')
         ->DumpAlternativeIndexIDListItem.init;
       (UserMenu4+(i+1->i),'Dump LocalNodes')->DumpLocalNodesItem.init;
       (UserMenu4+(i+1->i),'Dump DiagramList')->dumpDiagramListItem.init;
       (UserMenu4+(i+1->i),'Dump FrejaMark')->dumpFrejaMarkItem.init;
       (UserMenu4+(i+1->i),'Node ID')->DumpNodeID.init
   if);
   BringToFrontItem.disable;
   SendToBackItem.disable;
   INNER init;
   (*  (UserMenu4+3,'-')->sep.init;
    (UserMenu4+4,'Classification')->classificationItem.init;
    (UserMenu4+5,'-')->sep1.init;
    (UserMenu4+6,'Nested Composition')->nestedCompositionItem.init;
    (UserMenu4+7,'Whole/Part')->nestedwholePartItem.init;
    (UserMenu4+8,'Reference')->nestedreferenceItem.init;
    (UserMenu4+9,'BlockStructure')->nestedblockStructureItem.init;
    (UserMenu4+10,'-')->sep2.init;
    (UserMenu4+11,'Tree Composition')->treeCompositionItem.init;
    (UserMenu4+12,'Whole/Part')->treewholePartItem.init;
    (UserMenu4+13,'Reference')->treereferenceItem.init;
    (UserMenu4+14,'BlockStructure')->treeblockStructureItem.init;
    (UserMenu4+15,'-')->sep3.init;
    (UserMenu4+16,'Classification & Composition')->combinedItem.init;
    combinedItem.disable; *)
   
#)  

-- SimpleCheckDisplay: Descriptor --
(# 
do
   theWorkPage.patternDiagrams.theList.Scan
     (#
        thisListDiagram: ^theWorkPage.ListDiagram;
        theDiagramNode: ^thisListDiagram.DiagramNode;
        theNames: ^betaGram.Names;
        iterate: @boolean;
        sonNo: @integer
     do
        current.e[]->thisListDiagram[];
        thisListDiagram.localNodes.scan
          (# 
          do
             (if not (current## = thisListDiagram.PatternNode##) then
                 (if current## <= thisListDiagram.DiagramNode## then
                     current[]->theDiagramNode[];
                     (if iterate then
                         (theDiagramNode.theDeclaration[],sonNo->theNames.get)
                           ->theDiagramNode.Redisplay;
                         sonNo+1->sonNo;
                         (if sonNo > theNames.noOfSons then false->iterate if)
                      else
                         theDiagramNode.theDeclaration.getSon1->theNames[];
                         (if theNames.noOfsons = 1 then
                             (theDiagramNode.theDeclaration[],theNames.getSon1)
                               ->theDiagramNode.Redisplay
                          else
                             true->iterate;
                             1->sonNo;
                             (theDiagramNode.theDeclaration[],
                              sonNo->theNames.get)->theDiagramNode.Redisplay;
                             2->sonNo
                         if)
                     if)
                 if)
             if)
          #);
        thisListDiagram.localNodes.adjustSizes
     #);
   
#)  

-- ViewMenuAutoSubPatternLayout: DoPart --
do (* (not gppProp.autoSubPatternLayout)->gppProp.autoSubPatternLayout->check*)
  

-- ViewMenuLayoutSubPatterns: DoPart --
do
     (#
        thePage: ^Page;
        theOADPage: ^OADPage;
        theObject: ^thePage.DesignObject;
        theNode: ^theOADPage.PatternDiagramNode;
        theDiagram: ^theOADPage.Diagram;
        thePatternDeclDiagram: ^theOADPage.PatternDeclDiagram;
        prefixDiagram: ^theOADPage.PatternDiagram;
        theCenter: @Point;
        
     do
        CurrentPage->thePage[];
        (if thePage[] <> none then
            (if thePage## <= OADPage## then
                thePage[]->theOADPage[];
                theOADPage.CurrentObject->theObject[];
                (if theObject[] <> none then
                    (if theObject## <= theOADPage.PatternDiagramNode## then
                        theObject[]->theNode[];
                        theNode.theDiagram->theDiagram[];
                        (if theNode## <= theDiagram.title## then
                            (if theDiagram## <= theOADPage.PatternDeclDiagram##
                             then
                                theDiagram[]->theOADPage.prettyprintSubPatterns
                             else
                                'Current diagram cannot have subpatterns'
                                  ->alertUser
                            if)
                         else
                            'Selection is other than title: not implemented yet'
                              ->alertUser
                        if)
                     else
                        'Current selection must be a pattern diagram'
                          ->alertUser;
                        
                    if);
                    
                 else
                    'No Selection'->alertUser; 
                if)
             else
                'Current selection must be a pattern diagram'->alertUser
            if)
         else
            'No current page'->alertUser
        if);
        
     #)  

-- ViewMenuEdgedSpecializationConnectors: DoPart --
do
     (#
        thePage: ^Page;
        theOADPage: ^OADPage;
        theObject: ^thePage.DesignObject;
        theNode: ^theOADPage.PatternDiagramNode;
        theDiagram: ^theOADPage.Diagram;
        thePatternDeclDiagram: ^theOADPage.PatternDeclDiagram;
        
     do
        CurrentPage->thePage[];
        (if thePage[] <> none then
            (if thePage## <= OADPage## then
                thePage[]->theOADPage[];
                theOADPage.CurrentObject->theObject[];
                (if theObject[] <> none then
                    (if theObject## <= theOADPage.PatternDiagramNode## then
                        theObject[]->theNode[];
                        theNode.theDiagram->theDiagram[];
                        (if theNode## <= theDiagram.title## then
                            (if theDiagram## <= theOADPage.PatternDeclDiagram##
                             then
                                theDiagram[]->theOADPage.edgeSpecializations
                             else
                                'Current diagram cannot have subpatterns'
                                  ->alertUser
                            if)
                         else
                            'Selection must be title of pattern'->alertUser
                        if)
                     else
                        'Current selection must be a pattern diagram'
                          ->alertUser;
                        
                    if);
                    
                 else
                    'No Selection'->alertUser; 
                if)
             else
                'Current selection must be a pattern diagram'->alertUser
            if)
         else
            'No current page'->alertUser
        if);
        
     #)  

-- TextAttributesItemHit: Descriptor --
(#  do docTextMenu.textAttrItem.execute #)  

-- FitToTextItemHit: DoPart --
do
     (#
        thePage: ^Page;
        theOADPage: ^OADPage;
        theObjectPage: ^ObjectPage;
        theObject: ^thePage.DesignObject
     do
        currentPage->thePage[];
        (if thePage[] <> none then
            thePage.CurrentObject->theObject[];
            (if theObject[] <> none then
                (if thePage## <= OADPage## then
                    thePage[]->theOADPage[];
                    (if theObject## <= theOADPage.UserDataNode## then
                        'Can not use Fit to Text on nodes in pattern diagrams'
                          ->alertUser
                     else
                        theObject.FitToText
                    if)
                 else
                    (if thePage## <= ObjectPage## then
                        thePage[]->theObjectPage[];
                        (if theObject## <= theObjectPage.ObjectDiagramNode##
                         then
                            'Can not use Fit to Text on nodes in object diagrams'
                              ->alertUser
                         else
                            theObject.FitToText
                        if)
                     else
                        theObject.FitToText
                    if)
                if)
             else
                'No current object'->alertUser
            if)
         else
            'No current page'->alertUser
        if)
     #)  

-- showAllDesignPicturesItem: DoPart --
do (currentpage).showAllDesignPictures  

-- ScrollIntoViewItem: DoPart --
do
     (#
        thePage: ^Page;
        theOADPage: ^OADPage;
        theObjectPage: ^ObjectPage;
        theObject: ^thePage.DesignObject
     do
        currentPage->thePage[];
        (if thePage[] <> none then
            (if thePage.currentObject <> none then
                (if thePage## <= OADPage## then
                    thePage[]->theOADPage[];
                    theOADPage.currentObject->theOADPage.scrollIntoView
                if)
             else
                'No current object'->alertUser
            if)
         else
            'No current page'->alertUser
        if)
     #)  

-- RefreshItem: Descriptor --
(#  do docPageMenu.cleanUpItem.execute #)  

-- PageMenuInit: Descriptor --
(# 
do (* (UserMenu7+8,'Page Overview')->PageOverview.init;*)
(* (UserMenu7+11,'Hide All Pages')->HideAllPagesItem.init *) 
#)
(*
 -- OptionsMenuInit: Descriptor --
 (# 
 do [*(UserMenu3+1,'Composition Marks') -> CompositionWithMarkItem.init;*]
 (UserMenu3+1,'Detailing On Same Page')->OnSamePageItem.init;
 (UserMenu3+2,'Simple Hierarchy Presentation')->hierPresItem.init;
 (UserMenu3+3,'-')->sep1.init;
 (UserMenu3+4,'Name And Type')->SimpleAsNameAndTypeItem.init;
 (UserMenu3+5,'Name')->SimpleAsNameItem.init;
 (UserMenu3+6,'Type')->SimpleAsTypeItem.init;
 (UserMenu3+7,'Type And Kind')->SimpleAsNameAndKindItem.init;
 (UserMenu3+8,'-')->sep2.init;
 [*(UserMenu3+12,'Debug') -> DebugItem.init;
 (UserMenu3+12,'-') -> sep3.init;*]
 INNER Init;
 CompositionWithMarkItem.disable;
 sep1.disable;
 sep2.disable;
 [*sep3.disable;*]
 
 #)  
 
 -- OptionsMenuCheckMarks: Descriptor --
 (# 
 do
 gppProp.DetailedOnSamePage->OnSamePageItem.Check;
 (if gppProp.CompositionDType > gppProp.CompositionNested
 // true then true->CompositionWithMarkItem.Check; 
 else
 false->CompositionWithMarkItem.Check; 
 if);
 true->SimpleAsNameAndTypeItem.Check;
 false->gppProp.SimpleHierarchyPresentation->hierPresItem.check;
 
 #)  
 
 -- DebugItem: Descriptor --
 (# 
 do
 not switch[1]->switch[1]->Check;
 [* and set checkmark *]
 (if switch[1]
 // true then
 'debugging ON!'->screen.putline;
 true->verbose->callbackverbose->objectverbose;
 
 else
 'debugging OFF!'->screen.putline;
 false->verbose->callbackverbose->objectverbose;
 
 if);
 
 #)  
 
 -- MarkMenuInit: Descriptor --
 (# 
 do
 (UserMenu6+1,'New Comment')->NewCommentItem.init;
 NewCommentItem.disable;
 (UserMenu6+2,'Show Comment')->ShowCommentItem.init;
 (UserMenu6+3,'Hide Comment')->HideCommentItem.init;
 INNER Init;
 
 #)  
 
 -- MarkMenuCheckMarks: Descriptor --
 (#  #)  
 *)  

