ORIGIN 'diagramattributes';
-- OADPageMakeDesignObject: Descriptor --
(#
   theDiag: ^Diagram;
   NodeType: @Integer;
   theOADDiagram: ^OADDiagram;
   theSimplePropertyDiagram: ^SimplePropertyDiagram;
   theNodeID: @integer
do
   ID->getNodeType->NodeType;
   (if NodeType
    // UDPrivate.UDFragmentDiagram then
       &FragmentDiagram[]->theDiag[];
       (0,none ,theDiag[])->THIS(OADPage).PatternDiagrams.theList.insertPD;
       theDiag.titleNode[]->theObject[];
       true->theDiag.titleNode.initialisingSaved;
       (if userDataVerbose then
           'MakeDesignObject: Created FragmentDiagram!'->putline
       if)
    // UDPrivate.UDPatternAttDiagram then
       &PatternAttDiagram[]->theDiag[];
       (0,none ,theDiag[])->THIS(OADPage).PatternDiagrams.theList.insertPD;
       theDiag.titleNode[]->theObject[];
       true->theDiag.titleNode.initialisingSaved;
       (if userDataVerbose then
           'MakeDesignObject: Created PatternAttDiagram!'->putline
       if);
       theDiag[]->theOADDiagram[];
       theOADDiagram.titleNode.UDtheSurroundBox.getID->theNodeID;
       (if theNodeID <> 0 then
           (theOADDiagram[],theNodeID)->makeSurroundBox
       if);
       theOADDiagram.titleNode.UDattributesBox.getID->theNodeID;
       (if theNodeID <> 0 then
           (theOADDiagram[],theNodeID)->makeSurroundBox
       if);
       theOADDiagram.titleNode.UDoperationsBox.getID->theNodeID;
       (if theNodeID <> 0 then
           (theOADDiagram[],theNodeID)->makeSurroundBox
       if);
       theOADDiagram.titleNode.UDlocalClassesBox.getID->theNodeID;
       (if theNodeID <> 0 then
           (theOADDiagram[],theNodeID)->makeSurroundBox
       if)
    // UDPrivate.UDPatternDeclDiagram then
       &PatternDeclDiagram[]->theDiag[];
       (0,none ,theDiag[])->THIS(OADPage).PatternDiagrams.theList.insertPD;
       theDiag.titleNode[]->theObject[];
       true->theDiag.titleNode.initialisingSaved;
       (if userDataVerbose then
           'MakeDesignObject: Created PatternDeclDiagram!'->putline
       if)
    // UDPrivate.UDPatternClassificationDiagram then
       &PatternClassificationDiagram[]->theDiag[];
       (0,none ,theDiag[])->THIS(OADPage).PatternDiagrams.theList.insertPD;
       theDiag.titleNode[]->theObject[];
       true->theDiag.titleNode.initialisingSaved;
       (if userDataVerbose then
           'MakeDesignObject: Created PatternClassificationDiagram!'->putline
       if)
    // UDPrivate.UDSimplePropertyDiagram then
       &SimplePropertyDiagram[]->theDiag[];
       (0,none ,theDiag[])->THIS(OADPage).PatternDiagrams.theList.insertPD;
       theDiag.titleNode[]->theObject[];
       true->theDiag.titleNode.initialisingSaved;
       (if userDataVerbose then
           'MakeDesignObject: Created SimplePropertyDiagram!'->putline
       if);
       theDiag[]->theSimplePropertyDiagram[];
       theSimplePropertyDiagram.titleNode.UDSurroundBox.getID->theNodeID;
       (if theNodeID <> 0 then
           (theSimplePropertyDiagram[],theNodeID)->makeSurroundBox
       if)
    // UDPrivate.UDPropertyDiagram then
       &PropertyDiagram[]->theDiag[];
       (0,none ,theDiag[])->THIS(OADPage).PatternDiagrams.theList.insertPD;
       theDiag.titleNode[]->theObject[];
       true->theDiag.titleNode.initialisingSaved;
       (if userDataVerbose then
           'MakeDesignObject: Created PropertyDiagram!'->putline
       if)
   if)
#)  

-- MakeLocalNodes: Descriptor --
(#
   restoreAttributesAndOperationsLists: theListDiagram.localNodes.scan
     (# 
     do
        (if current.attributeType
         // gppProp.SimpleAttribute then
            current[]->theListDiagram.attributes.append
         // gppProp.operation then
            current[]->theListDiagram.operations.append
         // gppProp.localClass then
            current[]->theListDiagram.localClasses.append
        if)
     #);
   rangeStart: @integer;
   rangeEnd: @integer;
   count: @integer;
   localNodeID: @integer;
   NodeType: @integer;
   thePatternDiagNode: ^PatternDiagramNode;
   theSimpleNode: ^theListDiagram.SimpleAttributeDecl;
   thePatternNode: ^theListDiagram.PatternNode;
   theObject: ^DesignObject;
   theNode: ^Node;
   thePropertyDiagram: ^SimplePropertyDiagram;
   regions: [0] @Integer;
   titleID,theNodeID,theConnID: @integer
do
   LocalNodesUserDataStart->rangeStart;
   LocalNodesUserDataEnd->rangeEnd;
   theListDiagram.titleNode.ID->titleID;
   (* &integerRef[]->rangeH[];
    &shortRef[]->count[];
    (titleID,rangeStart,rangeEnd,count[],rangeH[])->UDFindRange->ok;*)
   theListDiagram.titleNode.oldLocalNodesUDAttributes-LocalNodesUserDataStart
     ->count;
   &theListDiagram.LocalNodesDesc[]->theListDiagram.localNodes[];
   (for i: count repeat
     (if userDataVerbose then
         'For titleID: '->puttext;
         titleID->putint;
         ' and attributesID: '->puttext;
         LocalNodesUserDataStart+i->putint;
         ' localNodeID was: '->puttext;
         
     if);
     (titleID,LocalNodesUserDataStart+i)->readIntegerUserData->localNodeID;
     (if localNodeID <> 0 then
         (if userDataVerbose then localNodeID->putint; newline;  if);
         localNodeID->getNodeType->NodeType;
         (if NodeType = UDPrivate.UDPatternDiagramNode then
             &PatternDiagramNode[]->thePatternDiagNode[]->theObject[];
             true->thePatternDiagNode.initialisingSaved;
             (if userDataVerbose then
                 'MakeLocalNodes: Created PatternDiagramNode!'->putline
             if)
         if);
         (if NodeType = UDPrivate.UDAbstractNode then
             &theListDiagram.AbstractNode[]->thePatternDiagNode[]->theObject[];
             true->thePatternDiagNode.initialisingSaved;
             (if userDataVerbose then
                 'MakeLocalNodes: Created AbstractNode!'->putline
             if)
         if);
         (if NodeType = UDPrivate.UDSlotNode then
             &theListDiagram.SlotNode[]->thePatternDiagNode[]->theObject[];
             true->thePatternDiagNode.initialisingSaved;
             (if userDataVerbose then
                 'MakeLocalNodes: Created SlotNode!'->putline
             if)
         if);
         (if NodeType = UDPrivate.UDPropertyNode then
             theListDiagram[]->thePropertyDiagram[];
             &thePropertyDiagram.PropertyNode[]->thePatternDiagNode[]
               ->theObject[];
             true->thePatternDiagNode.initialisingSaved;
             (if userDataVerbose then
                 'MakeDesignObject: Created PropertyNode!'->putline
             if)
         if);
         (if NodeType = UDPrivate.UDFragmentNode then
             &theListDiagram.FragmentNode[]->thePatternDiagNode[]->theObject[];
             true->thePatternDiagNode.initialisingSaved;
             (if userDataVerbose then
                 'MakeLocalNodes: Created FragmentNode!'->putline
             if)
         if);
         (if NodeType = UDPrivate.UDDiagramNode then
             &theListDiagram.DiagramNode[]->thePatternDiagNode[]->theObject[];
             true->thePatternDiagNode.initialisingSaved;
             (if userDataVerbose then
                 'MakeLocalNodes: Created DiagramNode!'->putline
             if)
         if);
         (if NodeType = UDPrivate.UDNonTerminalNode then
             &theListDiagram.NonTerminalNode[]->thePatternDiagNode[]
               ->theObject[];
             true->thePatternDiagNode.initialisingSaved;
             (if userDataVerbose then
                 'MakeLocalNodes: Created NonTerminalNode!'->putline
             if)
         if);
         (if NodeType = UDPrivate.UDDoPartNode then
             &theListDiagram.DoPartNode[]->thePatternDiagNode[]->theObject[];
             true->thePatternDiagNode.initialisingSaved;
             (if userDataVerbose then
                 'MakeLocalNodes: Created DoPartNode!'->putline
             if)
         if);
         (if NodeType = UDPrivate.UDAttributesNode then
             &theListDiagram.AttributesNode[]->thePatternDiagNode[]
               ->theObject[];
             true->thePatternDiagNode.initialisingSaved;
             (if userDataVerbose then
                 'MakeLocalNodes: Created AttributesNode!'->putline
             if)
         if);
         (if NodeType = UDPrivate.UDDescriptorNode then
             &theListDiagram.DescriptorNode[]->thePatternDiagNode[]
               ->theObject[];
             true->thePatternDiagNode.initialisingSaved;
             (if userDataVerbose then
                 'MakeLocalNodes: Created DescriptorNode!'->putline
             if)
         if);
         (if NodeType = UDPrivate.UDSimpleAttributeDecl then
             &theListDiagram.SimpleAttributeDecl[]->thePatternDiagNode[]
               ->theObject[];
             true->thePatternDiagNode.initialisingSaved;
             (if userDataVerbose then
                 'MakeLocalNodes: Created SimpleAttributeDecl!'->putline
             if)
         if);
         (if NodeType = UDPrivate.UDPatternNode then
             &theListDiagram.PatternNode[]->thePatternDiagNode[]
               ->thePatternNode[]->theObject[];
             true->thePatternDiagNode.initialisingSaved;
             (if userDataVerbose then
                 'MakeLocalNodes: Created PatternNode!'->putline
             if)
         if);
         (if NodeType = UDPrivate.UDSimpleNode then
             &theListDiagram.SimpleNode[]->thePatternDiagNode[]->theSimpleNode[]
               ->theObject[];
             true->thePatternDiagNode.initialisingSaved;
             (if userDataVerbose then
                 'MakeLocalNodes: Created SimpleNode!'->putline
             if)
         if);
         (if NodeType = UDPrivate.UDRepetitionNode then
             &theListDiagram.RepetitionNode[]->thePatternDiagNode[]
               ->theSimpleNode[]->theObject[];
             true->thePatternDiagNode.initialisingSaved;
             (if userDataVerbose then
                 'MakeLocalNodes: Created RepetitionNode!'->putline
             if)
         if);
         (if NodeType = UDPrivate.UDVirtualNode then
             &theListDiagram.VirtualNode[]->thePatternDiagNode[]->theObject[];
             true->thePatternDiagNode.initialisingSaved;
             (if userDataVerbose then
                 'MakeLocalNodes: Created VirtualNode!'->putline
             if)
         if);
         (if NodeType = UDPrivate.UDBindingNode then
             &theListDiagram.BindingNode[]->thePatternDiagNode[]->theObject[];
             true->thePatternDiagNode.initialisingSaved;
             (if userDataVerbose then
                 'MakeLocalNodes: BindingNode!'->putline
             if)
         if);
         (if NodeType = UDPrivate.UDFinalNode then
             &theListDiagram.FinalNode[]->thePatternDiagNode[]->theObject[];
             true->thePatternDiagNode.initialisingSaved;
             (if userDataVerbose then
                 'MakeLocalNodes: FinalNode!'->putline
             if)
         if);
         (if NodeType = UDPrivate.UDActivePropertyNode then
             (if theListDiagram## <= SimplePropertyDiagram## then
                 theListDiagram[]->thePropertyDiagram[];
                 &thePropertyDiagram.ActivePropertyNode[]->thePatternDiagNode[]
                   ->theObject[];
                 true->thePatternDiagNode.initialisingSaved;
                 (if userDataVerbose then
                     'MakeDesignObject: Created ActivePropertyNode!'->putline
                 if)
             if)
         if);
         (if NodeType = UDPrivate.UDPassivePropertyNode then
             (if theListDiagram## <= SimplePropertyDiagram## then
                 theListDiagram[]->thePropertyDiagram[];
                 &thePropertyDiagram.PassivePropertyNode[]->thePatternDiagNode[]
                   ->theObject[];
                 true->thePatternDiagNode.initialisingSaved;
                 (if userDataVerbose then
                     'MakeDesignObject: Created PassivePropertyNode!'->putline
                 if)
             if)
         if);
         (if NodeType = UDPrivate.UDOriginPropertyNode then
             (if theListDiagram## <= SimplePropertyDiagram## then
                 theListDiagram[]->thePropertyDiagram[];
                 &thePropertyDiagram.OriginPropertyNode[]->thePatternDiagNode[]
                   ->theObject[];
                 true->thePatternDiagNode.initialisingSaved;
                 (if userDataVerbose then
                     'MakeDesignObject: Created OriginPropertyNode!'->putline
                 if)
             if)
         if);
         (if NodeType = UDPrivate.UDIncludePropertyNode then
             (if theListDiagram## <= SimplePropertyDiagram## then
                 theListDiagram[]->thePropertyDiagram[];
                 &thePropertyDiagram.IncludePropertyNode[]->thePatternDiagNode[]
                   ->theObject[];
                 true->thePatternDiagNode.initialisingSaved;
                 (if userDataVerbose then
                     'MakeDesignObject: Created IncludePropertyNode!'->putline
                 if)
             if)
         if);
         (if NodeType = UDPrivate.UDBodyPropertyNode then
             (if theListDiagram## <= SimplePropertyDiagram## then
                 theListDiagram[]->thePropertyDiagram[];
                 &thePropertyDiagram.BodyPropertyNode[]->thePatternDiagNode[]
                   ->theObject[];
                 true->thePatternDiagNode.initialisingSaved;
                 (if userDataVerbose then
                     'MakeDesignObject: Created BodyPropertyNode!'->putline
                 if)
             if)
         if);
         (if theObject[] <> none then
             theObject[]->theListDiagram.LocalNodes.append;
             localNodeID->theObject.onInit;
             theObject.getRegionIDs->regions;
             (if regions.range > 0 then
                 theObject.onInitRegion; regions->MakeObjectsFromList
             if);
             (if theObject## <= node## then
                 theObject[]->theNode[];
                 false->theNode.moveable;
                 false->theNode.sizeable
             if);
             (if thePatternDiagNode[] <> none then
                 thePatternDiagNode.theMarkNode.getID
                   ->theNodeID
                   (*theMarkNode currently refers to EllipseNode.
                    getID works around qua error.*) ;
                 (if theNodeID <> 0 then
                     (theListDiagram[],theNodeID)->MakeMarkNode
                 if)
             if)
         if)
     if)
   for);
   restoreAttributesAndOperationsLists;
   
#)  

-- MakeMarkNode: Descriptor --
(#
   NodeType,theNodeId,theConnID: @integer;
   theObject: ^DesignObject;
   theCommentMark: ^theListDiagram.CommentMark;
   regions: [0] @Integer
do
   ID->getNodeType->NodeType;
   (if NodeType
    // UDPrivate.UDCommentMark then
       &theListDiagram.CommentMark[]->theCommentMark[]->theObject[];
       true->theCommentMark.initialisingSaved;
       (if userDataVerbose then
           'MakeMarkNode: Created CommentMark!'->putline
       if)
   if);
   (if theObject[] <> none then
       ID->theObject.onInit;
       theObject.getRegionIDs->regions;
       (if regions.range > 0 then
           theObject.onInitRegion; regions->MakeObjectsFromList
       if);
       theCommentMark.theCommentNode.getID
         ->theNodeID
         (*theCommentNode currently refers to RectNode.
          getId works around qua error*) ;
       (if theNodeID <> 0 then
           (theListDiagram[],theNodeID)->MakeCommentNode
       if);
       theCommentMark.theConn.getID->theConnID;
       (if theConnID <> 0 then theConnID->MakeConn if)
   if)
#)  

-- MakeCommentNode: Descriptor --
(#
   NodeType: @integer;
   theObject: ^DesignObject;
   theCommentNode: ^theListDiagram.MyCommentNode;
   regions: [0] @Integer
do
   ID->getNodeType->NodeType;
   (if NodeType
    // UDPrivate.UDMyCommentNode then
       &theListDiagram.MyCommentNode[]->theCommentNode[]->theObject[];
       true->theCommentNode.initialisingSaved;
       (if userDataVerbose then
           'MakeCommentNode: Created MyCommentNode!'->putline
       if)
   if);
   (if theObject[] <> none then
       ID->theObject.onInit;
       theObject.getRegionIDs->regions;
       (if regions.range > 0 then
           theObject.onInitRegion; regions->MakeObjectsFromList
       if)
   if)
#)  

-- MakeUserDataLabelNode: DoPart --
do
     (# NodeType: @integer; theObject: ^DesignObject; regions: [0] @Integer
     do
        ID->getNodeType->NodeType;
        (if NodeType = UDPrivate.UDLabelNode then
            &UserDataLabelNode[]->theObject[];
            (if theObject[] <> none then
                ID->theObject.onInit;
                (if userdataVerbose then
                    'MakeUserDataLabelNode: Created UserDataLabelNode!'->putline
                if);
                theObject.getRegionIDs->regions;
                (if regions.range > 0 then
                    theObject.onInitRegion; regions->MakeObjectsFromList
                if)
            if)
        if)
     #)  

-- MakeConn: Descriptor --
(#
   NodeType,theNodeID: @integer;
   theObject: ^DesignObject;
   regions: [0] @Integer;
   theDeletableConn: ^DeletableConnector;
   theAssociationConnector: ^AssociationConnector
do
   ID->getNodeType->NodeType;
   (if NodeType
    // UDPrivate.UDPrefixConnector then
       &PrefixConnector[]->theDeletableConn[]->theObject[];
       true->theDeletableConn.initialisingSaved;
       (if userDataVerbose then
           'MakeConn: Created PrefixConnector!'->putline
       if)
    // UDPrivate.UDAssociationConnector then
       &AssociationConnector[]->theDeletableConn[]->theAssociationConnector[]
         ->theObject[];
       true->theDeletableConn.initialisingSaved;
       (if userDataVerbose or switch[53] then
           'MakeConn: Created AssociationConnector!'->putline
       if)
    // UDPrivate.UDAggregationConnector then
       &AggregationConnector[]->theDeletableConn[]->theAssociationConnector[]
         ->theObject[];
       true->theDeletableConn.initialisingSaved;
       (if userDataVerbose or switch[54] then
           'MakeConn: Created AggregationConnector!'->putline
       if)
   if);
   (if theObject[] <> none then
       ID->theObject.onInit;
       theObject.getRegionIDs->regions;
       (if regions.range > 0 then
           theObject.onInitRegion; regions->MakeObjectsFromList
       if);
       (if theAssociationConnector[] <> none then
           theAssociationConnector.leftRole.getID->theNodeID;
           (if theNodeID <> 0 then
               (theAssociationConnector[],theNodeID)->MakeRole
           if);
           theAssociationConnector.rightRole.getID->theNodeID;
           (if theNodeID <> 0 then
               (theAssociationConnector[],theNodeID)->MakeRole
           if);
           theAssociationConnector.name.getID->theNodeID;
           (if theNodeID <> 0 then theNodeID->MakeUserDataLabelNode if)
       if)
   if)
#)  

-- MakeRole: DoPart --
do
   ID->getNodeType->NodeType;
   (if NodeType
    // UDPrivate.UDRole then
       &theAssociationConnector.Role[]->theRole[]->theObject[];
       (if userDataVerbose or switch[53] or switch[54] then
           'MakeRole: Created Role!'->putline
       if)
   if);
   (if theObject[] <> none then
       ID->theObject.onInit;
       theObject.getRegionIDs->regions;
       (if regions.range > 0 then
           theObject.onInitRegion; regions->MakeObjectsFromList
       if);
       theRole.name.getID->theNodeID;
       (if theNodeID <> 0 then theNodeID->MakeUserDataLabelNode if);
       theRole.multiplicity.getID->theNodeID;
       (if theNodeID <> 0 then theNodeID->MakeUserDataLabelNode if)
   if)  

-- makeSurroundBox: DoPart --
do
     (#
        NodeType: @integer;
        theListDiagram: ^ListDiagram;
        thePropertyDiagram: ^PropertyDiagram;
        theObject: ^DesignObject;
        regions: [0] @Integer
     do
        ID->getNodeType->NodeType;
        (if NodeType = UDPrivate.UDSurroundBox then
            (if theDiag## <= PropertyDiagram## then
                theDiag[]->thePropertyDiagram[];
                &thePropertyDiagram.surroundBox[]->theObject[]
             else
                &SurroundBox[]->theObject[]
            if);
            (if theObject[] <> none then
                ID->theObject.onInit;
                (if userdataVerbose then
                    'MakeSurroundBox: Created SurroundBox ID=%i\n'
                      ->putformat (#  do theObject.ID->i #)
                if);
                theObject.getRegionIDs->regions;
                (if regions.range > 0 then
                    theObject.onInitRegion; regions->MakeObjectsFromList
                if)
            if)
        if)
     #)  

