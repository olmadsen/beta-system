ORIGIN '~beta/basiclib/v1.6/betaenv';
LINKOPT linux   '-export-dynamic -ldl'
        default '-ldl';

--LIB: attributes--

(* Procedural interface to dlopen, dlsym etc - used for dynamic linking *)

(*
 * Information structure returned by dladdr().
 *)
Dl_info: holder
  (# 
     dli_fname: @integer (* const char * *)(* file containing address range *);
     dli_fbase: @integer (* void * *)      (* base address of file image *);
     dli_sname: @integer (* const char * *)(* symbol name *);
     dli_saddr: @integer (* void * *)      (* symbol address *);
  #);

(*
 * Declarations used for dynamic linking support routines.
 *)
dlopen: external
  (# handle: @integer;
     pathname: [0]@char;
     mode: @integer;
  enter (pathname, mode)
  exit handle
  #);
dlopen_integer: external
  (* Hack to allow numeric first argument *)
  (# handle: @integer;
     pathname: @integer;
     mode: @integer;
  enter (pathname, mode)
  do 'dlopen' -> CallC
  exit handle
  #);
dlsym: external
  (# address: @integer;
     handle: @integer;
     name: [0]@char;
  enter (handle,name)
  exit address
  #);
dlclose: external
  (# status: @integer;
     handle: @integer;
  enter handle
  exit status
  #);
dlerror: 
  (# diagnostics: ^text;
     dlerror: external
       (# diagnostics: [0]@char;
       exit diagnostics
       #);
  do &text[] -> diagnostics[];
     dlerror -> diagnostics;
  exit diagnostics[]
  #);
dladdr: external
  (# status: @integer;
     address: @integer;
     info: ^Dl_info;
  enter (address, info[])
  exit status
  #);

(*
 * Valid values for handle argument to dlsym(3x).
 *)
RTLD_NEXT:      (# exit -1 #)   (* look in `next' shared object *);

(*
 * Valid values for mode argument to dlopen.
 *)
RTLD_LAZY:      (# exit 1 #)            (* lazy function call binding *);
RTLD_NOW:       (# exit 2 #)            (* immediate function call binding *);
RTLD_GLOBAL:    (# exit 0x100 #)        (* allow symbols to be global *);
