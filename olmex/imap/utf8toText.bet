ORIGIN '~beta/basiclib/betaenv';
INCLUDE  '~beta/basiclib/numberio';
---textLib:attributes---
utf8toText:
  (# first: @integer; S: @text
  enter first
  do (# i,V: @integer; ch,c: @char
     do T[first->i] -> ch;
        loop:
          (if i <= lgth then
              (if ch
                  // '?' then 
                     i+1 -> i;
                     leave loop
                  // '=' then
                     i+1 -> i;
                     restart loop
                  else
                     0 -> V;
                     (for j: 4 repeat
                          (* ch -> put; ' '->put;*)
                          (if true
                           // ('A'<= ch) and (ch <= 'Z') then
                              V*64 + ch - 'A' -> V
                           // ('a'<= ch) and (ch <= 'z') then
                              V*64 + ch - 'a' + 26 -> V
                           // ('0'<= ch) and (ch <= '9') then
                              V*64 + ch - '0' + 52 -> V
                           // ch = '=' then
                              V*64 -> V
                           else
                              '\n***Illegal UTF-8 char: "'->puttext;
                              ch -> put; '"'->put; ch -> puthex;
                              newline
                          if);
                          i+1 -> i;
                          T[i] -> ch;
                     for);
                     2->V.%getByte -> c -> S.put;
                     1->V.%getByte -> c;
                     (if c <> 0 then c -> S.put; if);
                     0->V.%getByte -> c;
                     (if c <> 0 then c -> S.put; if);
                     restart loop
                 if)                                        
          if);

        (# i: @integer; c: @char; L,R: @integer;
           W: @text
        do 
           Loop:
             (#
             do S.T[i+1->i] -> c;
                (if true 
                 // (c %band 2x11100000)= 2x11000000 then
                    c %band 2x00011111 -> L;
                    S.T[i+1->i] -> c; 
                    c %band 2x00111111 -> R;
                    L*64 + R -> c; 
                 // (c %band 2x11110000)= 2x11100000 then
                    'B'->put;
                    
                 // (c %band 2x11110000)= 2x11110000 then
                    'C'->put;
                    
                 // (c %band 2x11111000)= 2x11111000 then
                    'D'->put;
                if);
                c -> W.put;
                (if i < S.length then restart loop if)
             #);
           W -> S; 
        #)                       
     #)
  exit S[]
  #)


