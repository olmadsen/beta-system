origin '~beta/basiclib/betaenv'
---lib:attributes---
parseIMAP:
  (# next:
       (# nextCh:
            (#
            do (if not T.eos then
                   T.get -> ch
               if);
            #);
          getName:
            (#
            do L: (#
                  do nextCh;
                     (if (('A' <= ch) and (ch <= 'Z')) or
                         (('a' <= ch) and (ch <= 'z')) then
                         ch -> tok.put;
                         restart L
                  if)#)
            #);

       do skipBlanks:
            (if ch <= ' ' then 
                nextCh;
                restart skipBlanks 
            if);
          &text[] -> tok[];
          (if ch
           // '*' 
           // ' ' 
           // '(' 
           // ')'
              then ch -> tok; nextCh;
           // '\\' then
              ch -> Tok;;
              getName
           // '"' then
              L: (#
                 do ch -> tok.put;
                    nextCh;
                    (if ch <> '"' then
                        restart L
                    if);
                    ch -> tok.put;
                    nextCh
                 #)
           else
              L:
                (if (('A' <= ch) and (ch <= 'Z')) or
                    (('a' <= ch) and (ch <= 'z')) or
                    (ch = '/') then
                    ch -> tok.put;
                    nextCh; 
                    restart L
                if)
          if);  
          '<'->put; tok[] -> puttext; '>'->put;
       #);
     ch: @char;
     T: ^text; tok: ^text;
     R: ^response
  enter T[]
  do T.reset; next;
     (if true
      // '*' -> tok.equal then
         next; 
         (if true 
          // 'list' -> tok.equalNCS then
             (# LR: @listResponse
             do next;
                (if '(' -> tok.equal then
                    L: (#
                       do next;
                          (if not (')' -> tok.equal) then
                              (if true 
                               // '\\NoSelect' -> tok.equal then
                                  true -> LR.NoSelect
                              if);
                              restart L
                       if)#);
                    next
                if);
                (if '"/"' -> tok.equal then 
                    next;
                    tok[] -> LR.mbox[];
                if);
                LR[] -> R[]
             #)
         if)
     if)
  exit R[]
  #);
response:
  (#
  #);

ListResponse: response
  (# NoSelect: @boolean;
     mbox: ^text
  #)

