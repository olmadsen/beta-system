ORIGIN 'designobjectbody';
INCLUDE '~beta/bifrost/EPSfile'
        '~beta/basiclib/regexp'
        'epsprintdialog'
        '~beta/sysutils/time';
-- documentbodyCVSINFO: Descriptor --
(#
do
   '$Id: documentbody.bet,v 1.23 1999-09-16 08:45:40 toby Exp $'
     -> msg.putLine
#)

-- NewDocument: Descriptor --
(# newPage: ^Page; bifid: ^UI.IDBifrost
do
   false -> menuBar.update;
   (if UI.verbose then 'NewDocument:descriptor called!'->putLine if);
   (if (theDocument[] = none ) or true (* (not theDocument.modified) or *)
   (* ((NONE,
    * 'Current document needs to be saved, do you wish to proceed?',
    * 'yes','no') -> UI.theGUI.yesnoDialog)
    *) then
       &UI.IDBifrost[]->bifid[];
       (none ,none ,1)->bifid.init;
       (if theDocument[] <> none then theDocument.close (* revisit *) if);
       (* create a new document just by simulating New in File menu *)
       THIS(Document)[]->theDocument[];
       onInit->newPage[];
       (if newPage[]
        // none then (* new document makes a new page automatically *)
           &DesignPage[]->newPage[];
       if);
       newPage.new;
       newPage[]->CurrentPage
   if)
#)

-- onKeyDown: DoPart --
do INNER onKeyDown  

-- fileOpenDiagram: DoPart --
do
   (if UI.verbose then 'fileOpenDiagram:dopart called!'->putLine;  if);
   readDiag:
     (#
	pageLoadingNow: ^UI.bifrostPage;
        doError:
          (# msg: ^text;
          enter msg[]
          do
             (if UI.verbose then
		 'fileOpenDiagram:doError'->putLine;
		 'error: ' -> putText;
		 msg[] -> putLine
	     if);
	     UI.pageList.scan
	       (# apage: ^theDocument.page
	       do
		  (if current <> 0 then
		      current -> UI.lookupDesignPicture
			(#
			do
			   (if thePage[] <> pageLoadingNow[] then
			       (if UI.verbose then
				   'Closing page no. ' -> putText;
				   current -> putInt;
				   newline
                               if);
			       true -> thePage.unconditionalClose;
			       thePage.close
                           if)
			#)
                  if)
	       #);
	     UI.pageList.clear;
	     (if pageLoadingNow[] <> NONE then
		 (if UI.verbose then 'Closing pageLoadingNow' -> putLine if);
		 true -> pageLoadingNow.unconditionalClose;
		 pageLoadingNow.close
	     if);
	     100 -> UI.bifrostObjectList.rep.new;
	     0 -> UI.bifrostObjectList.newID.value;
	     NONE -> theDocument[];
             (false,msg[])->THIS(fileOpenDiagram).error;
             leave readDiag
          #);
        fl: @file
          (#
             AccessError::<  (#  do msg[]->doError #);
             WriteError::<  (#  do msg[]->doError #);
             ReadError::<  (#  do msg[]->doError #);
             EOSerror::<  (#  do msg[]->doError #);
             NoSuchFileError::<  (#  do msg[]->doError #);
             FileExistsError::<  (#  do msg[]->doError #);
             NoSpaceError::<  (#  do msg[]->doError #);
             OtherError::<  (#  do msg[]->doError #)
          #);
        oldrepair: @Boolean;
        findPageStart:
          (# res: @boolean; buf: ^text; 
          do
             false->res;
             (if fl.eos then leave findPageStart if);
             fl.getLine->buf[];
             buf.reset;
             (if '^%%Page: '->buf.regexp_match then
                 (if UI.verbose then buf[]->putLine if); true->res
              else
                 restart findPageStart
             if)
          exit res
          #)
     do
	false -> menuBar.update;
        UI.dontRepair->oldrepair;
        &designDocument[]->theDocument[];
        (none, none, 1) -> (&UI.IDBifrost[]).init;
        name[]->fl.name;
        fl.openRead;
        loop:
	  (if findPageStart then
	      &UI.bifrostPage[] -> pageLoadingNow[];
	      true -> UI.dontRepair;
	      pageLoadingNow.open;
	      fl[] -> pageLoadingNow.load
		(# parseError::< (# do msg[]->doError #) #);
	      oldrepair -> UI.dontRepair;
	      pageLoadingNow.repair;
	      restart loop
	  if)
     #)

-- fileSavePagesAsDiagramError: DoPart --
do
   (if UI.verbose then
       'allErrors: %s\n'->putFormat (#  do origMsg[]->s #)
   if);
   msg.clear;
   origMsg[]->msg.putText;
   (continue or origContinue)->continue;
   INNER  

-- fileSavePagesAsDiagramSpecificError: DoPart --
do
   (if UI.verbose then
       'specificError: %s\n'->putFormat (#  do origMsg[]->s #)
   if);
   msg.clear;
   origMsg[]->msg.putText;
   INNER ;
   (continue,msg[])->allErrors;
   (* allErrors will terminate the application if necessary *)
   true->continue  

-- fileSavePagesAsDiagramAccessError: DoPart --
do (if UI.verbose then 'AccessError'->putLine if); INNER  

-- fileSavePagesAsDiagramWriteError: DoPart --
do (if UI.verbose then 'WriteError'->putLine if); INNER  

-- fileSavePagesAsDiagramReadError: DoPart --
do (if UI.verbose then 'ReadError'->putLine if); INNER  

-- fileSavePagesAsDiagramEOSerror: DoPart --
do (if UI.verbose then 'EOSerror'->putLine if); INNER  

-- fileSavePagesAsDiagramNoSuchFileError: DoPart --
do (if UI.verbose then 'NoSuchFileError'->putLine if); INNER  

-- fileSavePagesAsDiagramFileExistsError: DoPart --
do (if UI.verbose then 'FileExistsError'->putLine if); INNER  

-- fileSavePagesAsDiagramNoSpaceError: DoPart --
do (if UI.verbose then 'NoSpaceError'->putLine if); INNER  

-- fileSavePagesAsDiagramOtherError: DoPart --
do (if UI.verbose then 'OtherError'->putLine if); INNER  

-- fileSavePagesAsDiagram: DoPart --
do
     (#
        out: @file
          (#
             AccessError::< 
               (# 
               do
                  true->continue;
                  (false,msg[])->THIS(fileSavePagesAsDiagram).AccessError;
                  
               #);
             WriteError::< 
               (# 
               do
                  true->continue;
                  (false,msg[])->THIS(fileSavePagesAsDiagram).WriteError;
                  
               #);
             ReadError::< 
               (# 
               do
                  true->continue;
                  (false,msg[])->THIS(fileSavePagesAsDiagram).ReadError;
                  
               #);
             EOSerror::< 
               (# 
               do
                  true->continue;
                  (false,msg[])->THIS(fileSavePagesAsDiagram).EOSerror;
                  
               #);
             NoSuchFileError::< 
               (# 
               do
                  true->continue;
                  (false,msg[])->THIS(fileSavePagesAsDiagram).NoSuchFileError;
                  
               #);
             FileExistsError::< 
               (# 
               do
                  true->continue;
                  (false,msg[])->THIS(fileSavePagesAsDiagram).FileExistsError;
                  
               #);
             NoSpaceError::< 
               (# 
               do
                  true->continue;
                  (false,msg[])->THIS(fileSavePagesAsDiagram).NoSpaceError;
                  
               #);
             OtherError::< 
               (# 
               do
                  true->continue;
                  (false,msg[])->THIS(fileSavePagesAsDiagram).OtherError;
                  
               #)
          #);
        pg: ^UI.bifrostPage;
        dp: ^theDocument.page;
        txt: @text
     do
        (if UI.verbose then
            'fileSavePagesAsDiagram:dopart called! ( '->putText;
            (for i: pages.range repeat pages[i]->putInt; ' '->put for);
            ')'->putLine;
            
        if);
        fileName[]->out.name;
        out.openWrite;
        '%!PS-Adobe-3.0'->out.putline;
        '%%Creator: Mjolner Freja CASE tool 4.0'->out.putLine;
        '%%CreationDate: '->out.puttext;
        systemtime->formattime->out.putLine;
        '%%For: '->out.putText;
        '$(USER)'
          ->expandEnvVar
            (# defaultValue::  (#  do 'unkown'->envvarvalue[] #) #)
          ->out.putLine;
        '%%Title: Freja diagram'->out.putLine;
        '%%Pages: '->out.putText;
        pages.range->out.putInt;
        out.newline;
        '%%EndComments'->out.putLine;
        '%%BeginProlog'->out.putLine;
        UI.getCVSinfoPS->out.putLine;
        '%%BeginResource: procset Mjolner-Bifrost-StandardMacros 1.0 0'
          ->out.putLine;
        out.writeMacros;
        '%%EndResource'->out.putLine;
        '%%EndProlog'->out.putLine;
        (for i: pages.range repeat
          pages[i]->UI.getApage->pg[];
          pages[i]->theDocument.theObjectList.find->dp[];
          '%%Page: ('->out.putText;
          dp.pageTitle->txt;
          txt[]->out.putText;
          ') '->out.putText;
          i->out.putInt;
          out.newline;
          '%%BeginPageSetup'->out.putLine;
          '/pgsave save def'->out.putLine;
          '%%EndPageSetup'->out.putLine;
          out[]->pg.print;
          'pgsave restore'->out.putLine;
          'showpage'->out.putline
        for);
        '%%Trailer'->out.putLine;
        '%%EOF'->out.putLine;
        (* '% ' -> out.putText; *)
        (* out[] -> UI.bifrostObjectList.rep[1].UD.save; *)
        out.close
     #)  

-- fileSavePage: DoPart --
do
   (if UI.verbose then 'fileSavePage:dopart called!'->putLine if);
     (#
        mypd: UI.theGUI.ppageDialog
          (#
             open::  (#  do 'EPS file options'->THIS(mypd).title #);
             onOK:: 
               (# 
               do
                  (if UI.verbose then
                      'file "%s"%s%s'
                        ->putFormat
                          (# 
                          do
                             filename[]->s;
                             (if scaled then ' scaled'->s else ''->s if);
                             (if scaleToFit then
                                 ' scale to fit '->s; scale->putInt; 
                              else
                                 ''->s
                             if);
                             
                          #);
                      newLine
                  if);
                  close;
                  (fileName[],scaled,scaleToFit,scale)
                    ->UI.currentBifrostPage.save
               #)
          #);
        pd: @mypd
     do ('unamed.eps',false,false,100)->pd.open; pd.showModal
     #);
     

-- fileLoadPage: DoPart --
do
   (if UI.verbose then 'fileLoadPage:dopart called!'->putLine;  if);
   readDiag:
     (#
	pageLoadingNow: ^UI.bifrostPage;
        doError:
          (# msg: ^text;
          enter msg[]
          do
             (if UI.verbose then 'fileOpenDiagram:doError'->putLine if);
	     (if pageLoadingNow[] <> NONE then
		 NONE ->
		   UI.bifrostObjectList.rep
		   [pageLoadingNow.theMainPicture.ID][];
		 true -> pageLoadingNow.unconditionalClose;
		 pageLoadingNow.close
	     if);
             (false,msg[])->THIS(fileLoadPage).error;
             leave readDiag
          #);
        fl: @file
          (#
             AccessError::<  (#  do msg[]->doError #);
             WriteError::<  (#  do msg[]->doError #);
             ReadError::<  (#  do msg[]->doError #);
             EOSerror::<  (#  do msg[]->doError #);
             NoSuchFileError::<  (#  do msg[]->doError #);
             FileExistsError::<  (#  do msg[]->doError #);
             NoSpaceError::<  (#  do msg[]->doError #);
             OtherError::<  (#  do msg[]->doError #)
          #);
        findPageStart:
          (# res: @boolean; buf: ^text;
          do
             false->res;
             (if fl.eos then leave findPageStart if);
             fl.getLine->buf[];
             buf.reset;
             (if '^%%Page: '->buf.regexp_match then
                 (if UI.verbose then buf[]->putLine if); true->res
              else
                 restart findPageStart
             if)
          exit res
          #);
        oldrepair: @Boolean
     do
        (if theDocument[] <> none then
            UI.dontRepair->oldrepair;
            filename[]->fl.name;
            fl.openRead;
            loop:
	      (if findPageStart then
		  &UI.bifrostPage[] -> pageLoadingNow[];
		  true -> UI.dontRepair;
		  pageLoadingNow.open;
		  fl[] -> pageLoadingNow.load
		    (# parseError::< (# do msg[]->doError #) #);
		  oldrepair -> UI.dontRepair;
		  pageLoadingNow.repair;
		  1 -> pages.extend;
		  pageLoadingNow.theMainPicture.ID -> pages[pages.range];
		  restart loop
	      if)
         else
            'No Document'->doError
        if)
     #)

-- abortCommand: DoPart --
do (if UI.verbose then 'abortCommand:dopart called, but not implemented yet!'->putLine if) ; INNER ;   

-- DocumentID: Descriptor --
(#  do 1->i #)  

-- setDocModified: DoPart --
do
   (if UI.verbose then
       (if UI.verbose then 'setDocModified:dopart called, but not implemented yet!'->putLine if) 
   if);
   INNER  

-- getDocModified: DoPart --
do
   (if UI.verbose then
       (if UI.verbose then 'getDocModified:dopart called, but not implemented yet!'->putLine if) 
   if);
   INNER ;
   true->b  

-- currentPagePrivate: Descriptor --
(# thePage: ^page #)  

-- SetPage: Descriptor --
(#
do
   (if UI.Verbose then 'SetPage:descriptor called!'->putLine if);
   (if p[]
    // none then 'Warning: CurrentPage set to NONE!!!'->putLine
    else
       p.ID->UI.getApage->UI.currentBifrostPage[];
       (UI.currentBifrostPage.theMenuBar).checkMenuBar
   if);
   p[]->private.thePage[]
#)

-- GetPage: Descriptor --
(# 
do
   (if UI.extremelyVerbose then 'GetPage:descriptor called!'->putLine if);
   private.thePage[]->p[];
   (if p[] // none then 'Warning! No current page'->putLine if)
#)  

-- getPageList: DoPart --
do
   (if UI.Verbose then 'getPageList:dopart called!'->putLine if);
   UI.getPageList->pages  

-- GetPages: Descriptor --
(# 
do
   (if UI.Verbose then 'GetPages:descriptor called!'->putLine if);
   &ObjectList[]->pageList[];
   theObjectList.scan
     (# 
     do
        (if current## <= page## then
            current[]->pagelist.insert;
            (* (if UI.verbose then 'Hit a page' -> putLine if) *)
            (* else *)
            (* (if UI.verbose then 'Didn\'t hit a page' -> putLine if) *)
            
        if)
     #)
#)  

-- MaxGroupSize: Descriptor --
(# 
do (if UI.verbose then 'MaxGroupSize:descriptor called, but not implemented yet!'->putLine; if); 
#)  

-- PolyGetSide: Descriptor --
(# 
do (if UI.verbose then 'PolyGetSide:descriptor called, but not implemented yet!'->putLine; if); 
#)  

-- PolySetSide: Descriptor --
(# 
do (if UI.verbose then 'PolySetSide:descriptor called, but not implemented yet!'->putLine; if); 
#)  

-- PolyGetOrient: Descriptor --
(# 
do (if UI.verbose then 'PolyGetOrient:descriptor called, but not implemented yet!'->putLine; if); 
#)  

-- PolySetOrient: Descriptor --
(# 
do (if UI.verbose then 'PolySetOrient:descriptor called, but not implemented yet!'->putLine; if); 
#)  

-- SetCursor: Descriptor --
(#  do (if UI.verbose then 'SetCursor:descriptor called, but not implemented yet!'->putLine; if);  #)  

-- RestoreCursor: Descriptor --
(# 
do (if UI.verbose then 'RestoreCursor:descriptor called, but not implemented yet!'->putLine; if); 
#)  

-- ResetCursor: Descriptor --
(# 
do (if UI.verbose then 'ResetCursor:descriptor called, but not implemented yet!'->putLine; if); 
#)  

-- SetStatusBar: Descriptor --
(# 
do
   (if UI.verbose then
       'SetStatusBar:descriptor called! \'%s\'\n'
         ->putFormat (#  do msg[]->s #)
   if);
   (if UI.currentBifrostPage[] <> none then
       msg[]->UI.currentBifrostPage.infoBar.label
   if)
#)  

-- ResetStatusBar: Descriptor --
(# 
do
   (if UI.verbose then 'ResetStatusBar:descriptor called!'->putLine if);
   (if UI.currentBifrostPage[] <> none then
       UI.currentBifrostPage.updateInfoBar
   if)
#)  

-- shapeRectangle: DoPart --
do 1->v  

-- shapeEllipse: DoPart --
do 2->v  

-- shapePolygon: DoPart --
do 3->v  

-- shapeRndRect: DoPart --
do 4->v  

-- shapeWedge: DoPart --
do 5->v  

-- shapePicture: DoPart --
do 6->v  

-- shapeLine: DoPart --
do 7->v  

-- shapeStraightConn: DoPart --
do 8->v  

-- shapeCurveTopConn: DoPart --
do 9->v  

-- shapeCurveSideConn: DoPart --
do 10->v  

-- fontSystemFont: DoPart --
do (if UI.verbose then 'fontSystemFont:dopart called, but not implemented yet!'->putLine if) ; INNER ;   

-- fontSystem: DoPart --
do (if UI.verbose then 'fontSystem:dopart called, but not implemented yet!'->putLine if) ; INNER ;   

-- fontApplFont: DoPart --
do (if UI.verbose then 'fontApplFont:dopart called, but not implemented yet!'->putLine if) ; INNER ;   

-- fontNewYork: DoPart --
do (if UI.verbose then 'fontNewYork:dopart called, but not implemented yet!'->putLine if) ; INNER ;   

-- fontGeneva: DoPart --
do
   (if UI.Verbose then 'fontGeneva:dopart called!'->putLine if);
   UI.currentBifrostPage.helvetica->v  

-- fontMonaco: DoPart --
do (if UI.verbose then 'fontMonaco:dopart called, but not implemented yet!'->putLine if) ; INNER ;   

-- fontVenice: DoPart --
do (if UI.verbose then 'fontVenice:dopart called, but not implemented yet!'->putLine if) ; INNER ;   

-- fontLondon: DoPart --
do (if UI.verbose then 'fontLondon:dopart called, but not implemented yet!'->putLine if) ; INNER ;   

-- fontAthens: DoPart --
do (if UI.verbose then 'fontAthens:dopart called, but not implemented yet!'->putLine if) ; INNER ;   

-- fontRoman: DoPart --
do (if UI.verbose then 'fontRoman:dopart called, but not implemented yet!'->putLine if) ; INNER ;   

-- fontSanFran: DoPart --
do (if UI.verbose then 'fontSanFran:dopart called, but not implemented yet!'->putLine if) ; INNER ;   

-- fontScript: DoPart --
do (if UI.verbose then 'fontScript:dopart called, but not implemented yet!'->putLine if) ; INNER ;   

-- fontToronto: DoPart --
do (if UI.verbose then 'fontToronto:dopart called, but not implemented yet!'->putLine if) ; INNER ;   

-- fontCairo: DoPart --
do (if UI.verbose then 'fontCairo:dopart called, but not implemented yet!'->putLine if) ; INNER ;   

-- fontLosAngeles: DoPart --
do (if UI.verbose then 'fontLosAngeles:dopart called, but not implemented yet!'->putLine if) ; INNER ;   

-- fontModern: DoPart --
do (if UI.verbose then 'fontModern:dopart called, but not implemented yet!'->putLine if) ; INNER ;   

-- fontTimes: DoPart --
do (if UI.verbose then 'fontTimes:dopart called, but not implemented yet!'->putLine if) ; INNER ;   

-- fontTmsRoman: DoPart --
do (if UI.verbose then 'fontTmsRoman:dopart called, but not implemented yet!'->putLine if) ; INNER ;   

-- fontHelvetica: DoPart --
do
   (if UI.Verbose then 'fontHelvetica:dopart called!'->putLine if);
   UI.currentBifrostPage.helvetica->v  

-- fontCourier: DoPart --
do (if UI.verbose then 'fontCourier:dopart called, but not implemented yet!'->putLine if) ; INNER ;   

-- fontSymbol: DoPart --
do (if UI.verbose then 'fontSymbol:dopart called, but not implemented yet!'->putLine if) ; INNER ;   

-- fontTaliesin: DoPart --
do (if UI.verbose then 'fontTaliesin:dopart called, but not implemented yet!'->putLine if) ; INNER ;   

-- fontTerminal: DoPart --
do (if UI.verbose then 'fontTerminal:dopart called, but not implemented yet!'->putLine if) ; INNER ;   

-- textJustLeftJustification: DoPart --
do
   (if UI.Verbose then 'textJustLeftJustification:dopart called!'->putLine if);
   UI.currentBifrostPage.justification.left -> v

-- textJustCentered: DoPart --
do 
   (if UI.Verbose then 'textJustCentered:dopart called!'->putLine if);
   UI.currentBifrostPage.justification.center -> v

-- textJustRightJustification: DoPart --
do
   (if UI.Verbose then
       'textJustRightJustification:dopart called!'->putLine
   if);
   UI.currentBifrostPage.justification.right -> v

-- textStylePlaintext: DoPart --
do
   (if UI.Verbose then 'textStylePlaintext:dopart called!'->putLine if);
   UI.currentBifrostPage.plain->v;
   INNER;

-- textStyleBold: DoPart --
do
   (if UI.Verbose then 'textStyleBold:dopart called!'->putLine if);
   UI.currentBifrostPage.bold->v  

-- textStyleItalic: DoPart --
do
   (if UI.verbose then 'textStyleItalic:dopart called!'->putLine if);
   UI.currentBifrostPage.italic->v  

-- textStyleUnderLine: DoPart --
do
   (if UI.verbose then 'textStyleUnderLine:dopart called, but not implemented yet!'->putLine if) ;
   INNER ;
     

-- textStyleOutLine: DoPart --
do
   (if UI.verbose then 'textStyleOutLine:dopart called, but not implemented yet!'->putLine if) ;
   INNER ;
     

-- textStyleShadow: DoPart --
do
   (if UI.verbose then 'textStyleShadow:dopart called, but not implemented yet!'->putLine if) ; INNER ;   

-- textStyleCondense: DoPart --
do
   (if UI.verbose then 'textStyleCondense:dopart called, but not implemented yet!'->putLine if) ;
   INNER ;
     

-- textStyleExtented: DoPart --
do
   (if UI.verbose then 'textStyleExtented:dopart called, but not implemented yet!'->putLine if) ;
   INNER ;
     

-- fileGetCurrentDiagName: DoPart --
do (if UI.verbose then 'fileGetCurrentDiagName:dopart called, but not implemented yet!'->putLine if) ;   

-- DocumentPrivatePart: Descriptor --
(#  #)  

