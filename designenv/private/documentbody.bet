ORIGIN 'designobjectbody';
INCLUDE '~beta/bifrost/v2.3/EPSfile'
	'~beta/basiclib/v1.6/regexp'
	'epsprintdialog'
	'~beta/sysutils/v1.6/time';
-- documentbodyCVSINFO:descriptor --
(#
do
   '$Id: documentbody.bet,v 1.15 1998-03-11 13:12:48 beta Exp $'
     -> msg.putLine
#)

-- NewDocument: Descriptor --
(# 
   newPage: ^Page;
   bifid: ^UI.IDBifrost
do
   (if UI.verbose then
       'NewDocument:descriptor called!'->putLine
   if);
   (if (theDocument[] = NONE) or true
	 (* (not theDocument.modified) or *)
	 (* ((NONE,
	  * 'Current document needs to be saved, do you wish to proceed?',
	  * 'yes','no') -> UI.theGUI.yesnoDialog)
	  *)
	 then
       &UI.IDBifrost[]->bifid[];
       (NONE,NONE,1) -> bifid.init;
       (if theDocument[] <> NONE then theDocument.close (* revisit *) if);
       (* create a new document just by simulating New in File menu *)
       THIS(Document)[]->theDocument[];
       onInit->newPage[];
       (if newPage[]
	// none then
	   (* new document makes a new page automatically *)
	   &DesignPage[]->newPage[];
       if);
       newPage.new;
       newPage[]->CurrentPage;
   if)
#)

-- onKeyDown: DoPart --
do INNER onKeyDown

-- fileOpenDiagram: DoPart --
do
   (if UI.verbose then
       'fileOpenDiagram:dopart called!'->putLine;
   if);
   readDiag:
     (#
	i: @integer; bi: ^UI.IDBifrost; td: ^object;
	doError:
	  (# 
	     msg: ^text;
	  enter msg[]
	  do
	     (if UI.verbose then 'fileOpenDiagram:doError' -> putLine if);
	     (false,msg[]) -> THIS(fileOpenDiagram).error;
	     leave readDiag
	  #);
	fl: @file
	  (#
	     AccessError::< (# do msg[] -> doError #);
	     WriteError::< (# do msg[] -> doError #);
	     ReadError::< (# do msg[] -> doError #);
	     EOSerror::< (# do msg[] -> doError #);
	     NoSuchFileError::< (# do msg[] -> doError #);
	     FileExistsError::< (# do msg[] -> doError #);
	     NoSpaceError::< (# do msg[] -> doError #);
	     OtherError::< (# do msg[] -> doError #)
	  #);
	oldrepair: @Boolean;
	findPageStart:
	  (# 
	     res: @boolean;
	     buf: ^text;
	  do
	     false -> res;
	     (if fl.eos then leave findPageStart if);
	     fl.getLine -> buf[];
	     buf.reset;
	     (if '^%%Page: ' -> buf.regexp_match then
		 (if UI.verbose then buf[] -> putLine if);
		 true -> res
	      else
		 restart findPageStart
	     if);
	  exit res
	  #)
     do
	UI.dontRepair ->  oldrepair;
	&designDocument[] -> theDocument[] -> td[];
	&UI.IDBifrost[]->bi[];
	(NONE,NONE,1) -> bi.init;
	name[] -> fl.name; fl.openRead;

	loop:
	  (#
	     pg: ^UI.bifrostPage
	  do
	     (if findPageStart then
		 &UI.bifrostPage[] -> pg[];
		 true -> UI.dontRepair;
		 pg.open;
		 fl[] -> pg.load;
		 oldrepair -> UI.dontRepair;
		 pg.repair;
		 restart loop
	     if)
	  #)
     #)

-- fileSavePagesAsDiagramError: doPart --
do
   (if UI.verbose then
       'allErrors: %s\n' -> putFormat(# do origMsg[] -> s #)
   if);
   msg.clear;
   origMsg[] -> msg.putText;
   (continue or origContinue) -> continue;
   INNER

-- fileSavePagesAsDiagramSpecificError: doPart --
do
   (if UI.verbose then
       'specificError: %s\n' -> putFormat(# do origMsg[] -> s #)
   if);
   msg.clear;
   origMsg[] -> msg.putText;
   INNER;
   (continue,msg[]) -> allErrors;
   (* allErrors will terminate the application if necessary *)
   true -> continue

-- fileSavePagesAsDiagramAccessError: dopart --
do
   (if UI.verbose then
       'AccessError' -> putLine
   if);
   INNER

-- fileSavePagesAsDiagramWriteError: dopart --
do
   (if UI.verbose then
       'WriteError' -> putLine
   if);
   INNER

-- fileSavePagesAsDiagramReadError: dopart --
do
   (if UI.verbose then
       'ReadError' -> putLine
   if);
   INNER

-- fileSavePagesAsDiagramEOSerror: dopart --
do
   (if UI.verbose then
       'EOSerror' -> putLine
   if);
   INNER

-- fileSavePagesAsDiagramNoSuchFileError: dopart --
do
   (if UI.verbose then
       'NoSuchFileError' -> putLine
   if);
   INNER

-- fileSavePagesAsDiagramFileExistsError: dopart --
do
   (if UI.verbose then
       'FileExistsError' -> putLine
   if);
   INNER

-- fileSavePagesAsDiagramNoSpaceError: dopart --
do
   (if UI.verbose then
       'NoSpaceError' -> putLine
   if);
   INNER

-- fileSavePagesAsDiagramOtherError: dopart --
do
   (if UI.verbose then
       'OtherError' -> putLine
   if);
   INNER

-- fileSavePagesAsDiagram: DoPart --
do
   (#
      out: @file
	(# 
	   AccessError::<
	     (#
	     do
		true -> continue;
		(false,msg[]) -> THIS(fileSavePagesAsDiagram).AccessError;
	     #);
	   WriteError::<
	     (#
	     do
		true -> continue;
		(false,msg[]) -> THIS(fileSavePagesAsDiagram).WriteError;
	     #);
	   ReadError::<
	     (#
	     do
		true -> continue;
		(false,msg[]) -> THIS(fileSavePagesAsDiagram).ReadError;
	     #);
	   EOSerror::<
	     (#
	     do
		true -> continue;
		(false,msg[]) -> THIS(fileSavePagesAsDiagram).EOSerror;
	     #);
	   NoSuchFileError::<
	     (#
	     do
		true -> continue;
		(false,msg[]) -> THIS(fileSavePagesAsDiagram).NoSuchFileError;
	     #);
	   FileExistsError::<
	     (#
	     do
		true -> continue;
		(false,msg[]) -> THIS(fileSavePagesAsDiagram).FileExistsError;
	     #);
	   NoSpaceError::<
	     (#
	     do
		true -> continue;
		(false,msg[]) -> THIS(fileSavePagesAsDiagram).NoSpaceError;
	     #);
	   OtherError::<
	     (#
	     do
		true -> continue;
		(false,msg[]) -> THIS(fileSavePagesAsDiagram).OtherError;
	     #)
        #);
      pg: ^UI.bifrostPage;
      dp: ^theDocument.page;
      txt: @text
   do
      (if UI.verbose then
	  'fileSavePagesAsDiagram:dopart called! ( '->putText;
	  (for i: pages.range repeat pages[i] -> putInt; ' ' -> put for);
	  ')' -> putLine;
      if);
      fileName[] -> out.name;
      'Saving the diagram...' -> putLine;
      out.openWrite;
      '%!PS-Adobe-3.0' -> out.putline;
      '%%Creator: Mjolner Freja CASE tool 4.0' -> out.putLine;
      '%%CreationDate: ' -> out.puttext;
      systemtime -> formattime -> out.putLine;
      '%%For: ' -> out.putText;
      '$(USER)' -> expandEnvVar
	(#
	   defaultValue:: (# do 'unkown'->envvarvalue[] #)
	#) -> out.putLine;
      '%%Title: Freja diagram' -> out.putLine;
      '%%Pages: ' -> out.putText; pages.range -> out.putInt; out.newline;
      '%%EndComments' -> out.putLine;
      '%%BeginProlog' -> out.putLine;
      UI.getCVSinfoPS -> out.putLine;
      '%%BeginResource: procset Mjolner-Bifrost-StandardMacros 1.0 0'
	-> out.putLine;
      out.writeMacros;
      '%%EndResource' -> out.putLine;
      '%%EndProlog' -> out.putLine;
      (for i: pages.range repeat
	   pages[i] -> UI.getApage -> pg[];
	   pages[i] -> theDocument.theObjectList.find -> dp[];
	   '%%Page: (' -> out.putText;
	   dp.pageTitle -> txt;
	   txt[] -> out.putText;
	   ') ' -> out.putText;
	   i -> out.putInt;
	   out.newline;
	   '%%BeginPageSetup' -> out.putLine;
	   '/pgsave save def' -> out.putLine;
	   '%%EndPageSetup' -> out.putLine;
	   out[] -> pg.print;
	   'pgsave restore' -> out.putLine;
	   'showpage'->out.putline
      for);
      '%%Trailer' -> out.putLine;
      '%%EOF' -> out.putLine;
      (* '% ' -> out.putText; *)
      (* out[] -> UI.bifrostObjectList.rep[1].UD.save; *)
      out.close;
      'Successfully saved the diagram' -> putLine
   #)

-- fileSavePage: DoPart --
do 
   (if UI.verbose then 'fileSavePage:dopart called!'->putLine if);
   (#
      mypd: UI.theGUI.ppageDialog
	(# 
	   open::
	     (# do 'EPS file options' -> THIS(mypd).title #);
	   onOK::
	     (# 
	     do
		(if UI.verbose then
		    'file "%s"%s%s' -> putFormat
		      (#
		      do
			 filename[] -> s;
			 (if scaled then
			     ' scaled' -> s
			  else
			     '' -> s
			 if);
			 (if scaleToFit then
			     ' scale to fit ' -> s;
			     scale -> putInt;
			  else
			     '' -> s
			 if);
		      #);
		    newLine
                if);
		close;
		(fileName[],scaled,scaleToFit,scale)
		  -> UI.currentBifrostPage.save
	     #)
	#);
      pd: @mypd
   do
      ('unamed.eps',false,false,100)
	-> pd.open;
      pd.showModal
   #);

-- fileLoadPage: DoPart --
do 'fileLoadPage:dopart called, but not implemented yet!'->putLine; INNER;

-- abortCommand: DoPart --
do 'abortCommand:dopart called, but not implemented yet!'->putLine; INNER;

-- DocumentID: Descriptor --
(# do 1 -> i #)

-- setDocModified: DoPart --
do
   (if UI.verbose then
       'setDocModified:dopart called, but not implemented yet!'->putLine
   if);
   INNER

-- getDocModified: DoPart --
do 
   (if UI.verbose then
       'getDocModified:dopart called, but not implemented yet!'->putLine
   if);
   INNER;
   true -> b

-- currentPagePrivate: descriptor --
(# thePage: ^page #)

-- SetPage: Descriptor --
(#
do (if UI.Verbose then
       'SetPage:descriptor called!' -> putLine
   if);
   (if p[] // NONE then
       'Warning: CurrentPage set to NONE!!!' -> putLine
    else
       p.ID -> UI.getApage -> UI.currentBifrostPage[];
       (UI.currentBifrostPage.theMenuBar).checkMenuBar
   if);
   p[] -> private.thePage[];
#)


-- GetPage: Descriptor --
(#
do
   (if UI.extremelyVerbose then
       'GetPage:descriptor called!' -> putLine
   if);
   private.thePage[] -> p[];
   (if p[] // NONE then 'Warning! No current page' -> putLine if)
#)

-- getPageList: DoPart --
do
   (if UI.Verbose then
       'getPageList:dopart called!'->putLine
   if);
   UI.getPageList -> pages

-- GetPages: Descriptor --
(#
do (if UI.Verbose then
       'GetPages:descriptor called!'->putLine
   if);
   &ObjectList[] -> pageList[];
   theObjectList.scan
     (#
     do (if current## <= page## then
	    current[] -> pagelist.insert;
	    (* (if UI.verbose then 'Hit a page' -> putLine if) *)
	    (* else *)
	    (* (if UI.verbose then 'Didn\'t hit a page' -> putLine if) *)
	if)
     #)
#)

-- MaxGroupSize: Descriptor --
(#
do 'MaxGroupSize:descriptor called, but not implemented yet!'->putLine;
#)

-- PolyGetSide: Descriptor --
(#
do 'PolyGetSide:descriptor called, but not implemented yet!'->putLine;
#)

-- PolySetSide: Descriptor --
(#
do 'PolySetSide:descriptor called, but not implemented yet!'->putLine;
#)

-- PolyGetOrient: Descriptor --
(#
do 'PolyGetOrient:descriptor called, but not implemented yet!'->putLine;
#)

-- PolySetOrient: Descriptor --
(#
do 'PolySetOrient:descriptor called, but not implemented yet!'->putLine;
#)

-- SetCursor: Descriptor --
(#  do 'SetCursor:descriptor called, but not implemented yet!'->putLine;  #)

-- RestoreCursor: Descriptor --
(#
do 'RestoreCursor:descriptor called, but not implemented yet!'->putLine;
#)

-- ResetCursor: Descriptor --
(#
do 'ResetCursor:descriptor called, but not implemented yet!'->putLine;
#)

-- SetStatusBar: Descriptor --
(#
do 
   (if UI.verbose then
       'SetStatusBar:descriptor called! \'%s\'\n'
	 -> putFormat(# do msg[] -> s #)
   if);
   (if UI.currentBifrostPage[] <> NONE then
       msg[] -> UI.currentBifrostPage.infoBar.label
   if)
#)

-- ResetStatusBar: Descriptor --
(#
do
   (if UI.verbose then 'ResetStatusBar:descriptor called!' -> putLine if);
   (if UI.currentBifrostPage[] <> NONE then
       UI.currentBifrostPage.updateInfoBar
   if)
#)

-- shapeRectangle: DoPart --
do
   1 -> v

-- shapeEllipse: DoPart --
do
   2 -> v

-- shapePolygon: DoPart --
do
   3 -> v

-- shapeRndRect: DoPart --
do
   4 -> v

-- shapeWedge: DoPart --
do
   5 -> v

-- shapePicture: DoPart --
do
   6 -> v

-- shapeLine: DoPart --
do
   7 -> v

-- shapeStraightConn: DoPart --
do
   8 -> v

-- shapeCurveTopConn: DoPart --
do
   9 -> v

-- shapeCurveSideConn: DoPart --
do
   10 -> v

-- fontSystemFont: DoPart --
do 'fontSystemFont:dopart called, but not implemented yet!'->putLine; INNER;

-- fontSystem: DoPart --
do 'fontSystem:dopart called, but not implemented yet!'->putLine; INNER;

-- fontApplFont: DoPart --
do 'fontApplFont:dopart called, but not implemented yet!'->putLine; INNER;

-- fontNewYork: DoPart --
do 'fontNewYork:dopart called, but not implemented yet!'->putLine; INNER;

-- fontGeneva: DoPart --
do (if UI.Verbose then 'fontGeneva:dopart called!'->putLine if);
   UI.currentBifrostPage.helvetica -> v

-- fontMonaco: DoPart --
do 'fontMonaco:dopart called, but not implemented yet!'->putLine; INNER;

-- fontVenice: DoPart --
do 'fontVenice:dopart called, but not implemented yet!'->putLine; INNER;

-- fontLondon: DoPart --
do 'fontLondon:dopart called, but not implemented yet!'->putLine; INNER;

-- fontAthens: DoPart --
do 'fontAthens:dopart called, but not implemented yet!'->putLine; INNER;

-- fontRoman: DoPart --
do 'fontRoman:dopart called, but not implemented yet!'->putLine; INNER;

-- fontSanFran: DoPart --
do 'fontSanFran:dopart called, but not implemented yet!'->putLine; INNER;

-- fontScript: DoPart --
do 'fontScript:dopart called, but not implemented yet!'->putLine; INNER;

-- fontToronto: DoPart --
do 'fontToronto:dopart called, but not implemented yet!'->putLine; INNER;

-- fontCairo: DoPart --
do 'fontCairo:dopart called, but not implemented yet!'->putLine; INNER;

-- fontLosAngeles: DoPart --
do 'fontLosAngeles:dopart called, but not implemented yet!'->putLine; INNER;

-- fontModern: DoPart --
do 'fontModern:dopart called, but not implemented yet!'->putLine; INNER;

-- fontTimes: DoPart --
do 'fontTimes:dopart called, but not implemented yet!'->putLine; INNER;

-- fontTmsRoman: DoPart --
do 'fontTmsRoman:dopart called, but not implemented yet!'->putLine; INNER;

-- fontHelvetica: DoPart --
do (if UI.Verbose then 'fontHelvetica:dopart called!'->putLine if);
   UI.currentBifrostPage.helvetica -> v

-- fontCourier: DoPart --
do 'fontCourier:dopart called, but not implemented yet!'->putLine; INNER;

-- fontSymbol: DoPart --
do 'fontSymbol:dopart called, but not implemented yet!'->putLine; INNER;

-- fontTaliesin: DoPart --
do 'fontTaliesin:dopart called, but not implemented yet!'->putLine; INNER;

-- fontTerminal: DoPart --
do 'fontTerminal:dopart called, but not implemented yet!'->putLine; INNER;

-- textJustLeftJustification: DoPart --
do (if UI.Verbose then
       'textJustLeftJustification:dopart called!' -> putLine
   if);
   1 -> v;

-- textJustCentered: DoPart --
do (if UI.Verbose then 'textJustCentered:dopart called!'->putLine if);
   2 -> v;

-- textJustRightJustification: DoPart --
do (if UI.Verbose then
       'textJustRightJustification:dopart called!' -> putLine
   if);
   3 -> v;

-- textStylePlaintext: DoPart --
do
   'textStylePlaintext:dopart called, but not implemented yet!'->putLine;
   INNER;


-- textStyleBold: DoPart --
do (if UI.Verbose then 'textStyleBold:dopart called!'->putLine if);
   UI.currentBifrostPage.bold -> v

-- textStyleItalic: DoPart --
do
   (if UI.verbose then 'textStyleItalic:dopart called!'->putLine if);
   UI.currentBifrostPage.italic -> v

-- textStyleUnderLine: DoPart --
do
   'textStyleUnderLine:dopart called, but not implemented yet!'->putLine;
   INNER;


-- textStyleOutLine: DoPart --
do
   'textStyleOutLine:dopart called, but not implemented yet!'->putLine;
   INNER;

-- textStyleShadow: DoPart --
do
   'textStyleShadow:dopart called, but not implemented yet!'->putLine; INNER;

-- textStyleCondense: DoPart --
do
   'textStyleCondense:dopart called, but not implemented yet!'->putLine;
   INNER;

-- textStyleExtented: DoPart --
do
   'textStyleExtented:dopart called, but not implemented yet!'->putLine;
   INNER;

-- fileGetCurrentDiagName: DoPart --
do
   'fileGetCurrentDiagName:dopart called, but not implemented yet!'->putLine;

-- DocumentPrivatePart: Descriptor --
(# #)
