ORIGIN '~beta/guienv/guienvsystemenv';
INCLUDE '~beta/basiclib/iget';
---lib:attributes---
_kbhit: external(# b: @boolean do callC exit b #);
process: 
  (#
  do inner
  #);
IO_buffer: process
  (# B: [100] @char; next,top: @integer;
     scan:
       (# 
       do (if _kbhit then
              iget -> B[top + 1 -> top]; suspend
           else
              suspend
          if); 
          restart scan
       #);
     get:
       (# ch: @char
       do L:
            (if next < top then
                B[next + 1 -> next] -> ch
             else
                (* block *)
                suspend;
                restart L
            if)
       exit ch
       #);
  do scan
  #)
---program:descriptor---
(# KB: @ | IO_buffer(##);
   P1: @ | process
     (#
     do L:
          cycle
          (#
          do '!' -> put; KB.get -> put;
          #)
     #);
   P2: @ | process
     (#
     do L:
          cycle
          (# i: @integer
          do  (if ((i + 1 -> i) mod 1000 ) = 0 then 'P2 here'->putline if);
             suspend
          #)
     #);
   
   i,j: @integer; ch: @char
do cycle
   (#
   do 
      KB;
      P1;
      P2;
   #);
      
#)
