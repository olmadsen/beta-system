ORIGIN '~beta/guienv/guienv';
INCLUDE '~beta/guienv/controls';
INCLUDE '~beta/guienv/utils/framer';
INCLUDE '~beta/guienv/utils/colorTable';

INCLUDE '~beta/guienv/private/winnt/guienv_ntiprivate';
INCLUDE '~beta/win32lib/wingdiconsts';
INCLUDE '~beta/win32lib/winuserconsts';
INCLUDE '~beta/win32lib/systemmetrics'

---windowlib:attributes---
SubWindow: Canvas
  (# theKind: @integer;
     theBorderWidth: @integer;
     kind:
       (#
       enter theKind
       exit theKind
       #);
     
     open::<
       (# lab: ^text; T: @text;
          create::
            (#
            do WS_THICKFRAME -> windowItemStyle;
               SM_CXFRAME -> GetSystemMetrics -> theBorderWidth;
            #);
       enter lab[]
       do (12,12) -> position;
          '153 180 209 beta' -> T.putline; 
          '220 220 220 betaExeGrey' -> T.putline; 
          0 -> T.setpos; 
          T[] -> CT.load(# merge::trueObject #);          
          ocBack.open;
          openClose.open;
          head.open;
          lab[] -> head.label;
          INNER;
          setsize;
          true -> head.bindRight;
       #);
     init:<
       (# T: ^text
       enter T[]
       do (theFather[],T[]) -> open;
          inner;
          setSize; (* clean-up: open, init, setsize, etc *)
       #);
     setSize:
       (#
       do openClose.setSize;
          head.setSize;
       #);
     ocBack: @StaticText 
       (* to ensure at BETA colored background behind the open/close button *)
       (# open::
            (# 
            do (16,18) -> size; (* too big for seq-objWs - or? - so fix it *)
               '' -> label;
               'beta' -> CT.lookup -> backgroundColor;
            #)
       #);
     openClose: @openCloseButton;
     openCloseButton:< pushButton
       (# open::<
            (#
            do '*' -> label;;
               setSize
            #);
          setSize: 
            (# 
            do (16,16) -> size; 
            #);
          eventHandler::<
            (# onMouseUp::<
                 (#
                 do inner
                 #)
       #)#);
     Head: @Heading;
     Heading:< StaticText
       (# eventHandler::<
            (# onMouseDown::<
                 (#
                 do (if buttonState = 1 then
                        trackMouse
                        (# mouseMove:: 
                             (#
                             do (h,v) -> this(SubWindow).move; 
                                true -> this(SubWindow).update
                             #);
                        #);
                     else
                        INNER
                    if);
                 #);
            #);
          open::<
            (# h,w: @integer ; C: @color; 
            do this(subWindow).size -> size -> (w,h); (* why do we do this?
                                                       * See setSize below
                                                       *)
               (16, 0) -> position;
               setSize;
               true -> border.visible;
               borderstyles.etchedOut -> border.style;
               false -> border.visible;
               (*39168,46080,53504) -> backgroundColor; -- does not work *)
               'beta' -> CT.lookup -> C -> backgroundcolor;
               (*  c.red -> putint; ' ' -> put; 
                *                c.green -> putint; ' ' -> put; 
                *                c.blue -> putint; newline;
                *)
               INNER
            #);
          setSize: 
            (# w,h: @integer 
            do this(subWindow).size -> (w,h);
               (w - 16,18) -> size 
            #);
          textWidth:
            (# T: ^text; width: @integer; 
            enter T[]
            do (if T[] = none then
                   'subWindow:TextWidth:T=none'->putline
                else
                   T[] -> (style).widthOfText -> width
               if)
            exit width
            #);
       #);
     width:
       (# w,h: @integer
       do size -> (w,h)
       exit w
       #);
     height:
       (# w,h: @integer
       do size -> (w,h) 
       exit h
       #);
     left: 
       (# P: @point
       do position -> P;
       exit P.H (* I am confused: P.H is the horisontal line and thus top? *)
       #);
     top: (* and vice versa?? *)
       (# P: @point
       do position -> P;
       exit P.V (* And P.V should be left and not top? *)
       #);
     right: (# exit left + width #);
     bottom: (# exit top + height #);
     center: (# exit left + width div 2 #);
     middle: (# exit top + height div 2 #);
     
     theFather: ^canvas;
     CT: @colorTable;
  #)



