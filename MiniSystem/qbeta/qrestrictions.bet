ORIGIN '~beta/basiclib/betaenv';
INCLUDE 'qsemchecker';
---lib:attributes---
restrictions: semchecker
  (# AccessError: notificaion
       (# printHeading:: (# do Possible access error' -> puttext #);
          report:: (# trie -> value #)
       do inner
       #)
     items::<
       (# scanGlobals:
            (# current: ^Property;
               hasGlobals:< Object
            do (*'scanGlobals: '->putline; dopt->putline;*)
               (*props.doPT -> putline;
               props.doPP -> putline;*)

               (if superDesc[] <> none then
                   &superDesc.scanGlobals
                   (# hasGlobals:: (# do this(scanGlobals).hasGlobals #)
                   do current[] -> this(scanGlobals).current[];
                      inner scanGlobals;
               #)if);
               (if props.globals[] <> none then 
                   hasGlobals;
                   props.globals.scanSons
                   (# 
                   do current[] -> this(scanGlobals).current[];
                      inner scanGlobals;
                   #)
               if)
            #);
          checkGlobalsIncluded:
            (* adIS: the AD.IS of application
             * ad.IS.globlas in this.globals
            *)
            (# adIS: ^Items; ok: @boolean;
               aQual,vQual: ^ObjectGenerator; (* vQual := vQual *)
               dx: ^Property
            enter adIS[]
            do 
               adIS.scanGlobals
               (# hasGlobals :: (# do true -> ok #); 
               do '\n*** checkGlobalsIncluded: This: ' -> puttext; 
                  current.doPT -> putLine;
                  current[] -> dx[];
                  current.P.ATd.getQual -> vQual[];
                  'IS:globals: ' -> puttext; 
                  L:
                    (if true then
                        scanGlobals
                        (#
                        do current.doPT -> puttext; ' ' -> put; 
                           current.P.ATd.getQual -> aQual[];
                           (if (vQual[] -> aQual.inSuper) then 
                               ' -> OK' -> putline;
                               leave L
                           if)
                        #);
                        (* not found *)
                        newline;
                        inner checkGlobalsIncluded;
                    if)
               #)            
            #);
          checkGlobals:
            (# ok,first: @boolean;
               AD: ^Apl; (* The Apl being accessed *)
               OG: ^ObjectGenerator;
               adQual,rQual: ^ObjectGenerator (* adQual <= rQual *)
            enter AD[]
            do (if AD[] = none then
                   'AD none'->putline;
                   true -> ok;
                   leave checkGlobals
               if);
               true -> ok;
               true -> first;
               (*'\n****** CheckG:'->puttext; (*doPT -> putline;*)
               loop:
                 scanGlobals
                 (# hasGlobals:: 
                      (# 
                      do false -> ok;
                         (if first then 
                             '\n*** checkGlobals: ' ->puttext;
                             AD.doPT -> puttext; 
                             false -> first;
                         if);
                      #);
                    DI: ^DataItem
                 do ' < ' -> puttext; current.doPT -> puttext;
                    (*false -> ok; (*global restrictions exists *)
                    (* Current: Property has no desc att - 
                     * Property shuld probably be an Apl and checked as an Apl
                     * We then need to handle primitives 
                     * Property.P is a lexem which is an Apl, so perhaps we are ok!?
                     *)
                    (*'>>> adQual=AD.qual=' -> puttext; AD.doPT -> puttext; ':\n' -> puttext;*)
                    AD.getQual -> adQual[];
                    (* '\n>>> adQual:'->putline; *)
                    (if current.P[] = none then ' P is none'->putline if);
                    (if current.P.ATd[] = none then 'ATd is none'->putline if);
                    current.P.ATd.getQual -> rQual[]; (* Must check current*)
                    (*'>>> adQual:'->putline; adQual.doPT -> putline;*)
                    (if (adQual[] -> rQual.inSuper) then 
                        ' -> OK'->putline;
                        true -> ok;
                        leave loop
                    if);
                 #);
               (if not ok then 
                   (if AD.ATd.isPatternDecl then ' -> Pattern:'->putline;
                       (*    foo: [Q1,Q2,Q3]
                        *    [Q1,Q2,Q3] must be contained in globals[this(PTN)]
                        *)
                       AD.ATd.desc -> checkGlobalsIncluded
                       (#
                       do '!!!!! Global pattern: ' -> puttext;
                          AD.doPT -> puttext;
                          (if dx[] = none then
                              ' has no global restricitons'->putline
                           else
                              ' is not restricted by: ' -> puttext;
                              dx.doPT -> putline;
                          if)
                       #)
                    else
                       AD[] -> AccessError
                       (#
                       do 'Cannot access global data-item: ' -> msg;;
                          AD.doPT -> msg;
                          ' in: ' -> msg;
                          AD.father.father.father.doPT-> msg
                   if)
               if)
            #)
       #)
  do inner
  #)
