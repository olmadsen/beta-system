ORIGIN '~beta/basiclib/betaenv'
---lib:attributes---
chdir: external
  (# dir: [0] @char; res: @integer
  enter dir
  do callC
  exit res
  #);
system: external
  (# cmd: [0] @char; res: @integer
  enter cmd
  do callC
  exit res
  #);
popen: external
  (# cmd,mode: [0]@char; res: @integer
  enter(cmd,mode)
  do callC
  exit res
  #);
fgetc: external
  (# F: @integer; ch: @char
  enter F
  do callC
  exit ch
  #);
--- program:descriptor ---
(# exe:
     (# cmd,subPath,input: ^text; 
        withB,withC,background: @boolean;
        TB,TC,TT: ^Text;
        V: @integer
     enter(cmd[],subPath[], withB,withC,background,input[])
     do subPath[] -> (WS.copy).append -> TB[]; 
        cmd[] -> (TB.copy).append -> TB[]; 
        (if (TB -> chdir -> V) <> 0 then
            '\n!!!! chdir failed: ' -> puttext; V -> putint; ' ' -> put;
            TB[] -> putline;
            stop;
        if);
        'xbeta ' -> TB[];
        'xbeta ' -> TC[];
        ' -c ' -> TC.append;
        cmd[] -> TB.append;
        cmd[] -> TC.append;
        
        (if first then
            ' > ' -> TB.append; ' >> ' -> TC.append;
            false -> first
         else
            ' >> ' -> TB.append; ' >> ' -> TC.append
        if);
        log[] -> TB.append;
        log[] -> TC.append;
        (if background then '&' -> TB.append; '&' -> TC.append if);
        (if withB then TB[] -> putline; TB -> system if);
        (if withC then TC[] -> putline; TC -> system if);
        WS -> chdir;
     #); 
   checkLIBstuff:
     (#
     do 'C:/beta/r5.5/MiniSystem/qbeta/BETAworld/LIB/' -> WS[];
        ('Compiler','',false,true,false,'') -> exe;
        (* We should pass 'small.x' as argument to compiler
         * Cannot use input, since this will be input to xbeta and not Compiler
         * We need a way of supplying input to module compiled by xbeta
         *)
     #);
   first: @boolean;
   T: [10000] @char; 
   FFF: @integer;
   arg: ^Text; resetLog: @boolean;
   WS,testDir,S: ^text;   
   log: ^text
do 'qBeta test run: ' -> puttext;
   (if noOfArguments > 1 then
       2 -> arguments -> arg[];
       (if '-r' -> arg.equalNCS then
           true -> resetLog;
           'Log file is reset' -> puttext
       if)
    else
       'test against A_mastertrace.txt: ' -> puttext           
   if);
   newline;
   'pwd' -> system;
   (* The  path '/home/olm/...' has been working fine for many years,
    * but starting nov 2022, it failed for chdir - dont know why?
    * 
    * '/home/olm/beta/r5.5/MiniSystem/qbeta/BETAworld/workspace/' -> WS[];
    * By changing to 'C:/beta/...' it works again!?
    *)
   'C:/beta/r5.5/MiniSystem/qbeta/BETAworld/workspace/' -> WS[];

   'C:/beta/r5.5/MiniSystem/qbeta/test/' -> testDir[];
   'Compiler_test'-> (testDir.copy).append -> S[];
   '> C_list &' -> S.append;
   (* the idea ws to run S in the background but it does not work
    * so we does this manually 
    * S[]->putline;
    * S -> system;
    *)
   (if resetLog then
       'A_mastertrace.txt' -> (testDir.copy).append -> log[]
    else
       'A_trace.txt' -> (testDir.copy).append -> log[]
   if);
   true -> first;
   WS -> chdir;
   ('TST','',true,true,false,none)-> exe;
   ('ValueEx','',true,true,false,none)-> exe;
   ('MiniVal','',true,true,false,none) -> exe;
   ('RemoteSuperVC','',true,true,false,none) -> exe;
   ('Bank','demo/',true,true,false,none) -> exe;
   ('ComplexEx','demo/',true,true,false,none) -> exe;
   ('BinTree','demo/',true,true,false,none) -> exe;
   ('CoArg','demo/',true,true,false,none) -> exe;
   ('CollectionEx','demo/',true,true,false,none) -> exe;
   ('Static','demo/',true,true,false,none) -> exe;
   ('ArrayExperiment','demo/ArrayDemos/',true,true,false,none) -> exe;
   ('EMC2arrayEx','demo/ArrayDemos/',true,true,false,none) -> exe;
   ('Break','demo/',true,true,false,none) -> exe;
   ('UnitEx','demo/',true,true,false,none) -> exe;
   ('ToyCar','demo/',true,true,false,none) -> exe;
   ('LibraEx','demo/',true,true,false,none) -> exe;
   ('ChemicalPlantSystem','demo/',true,true,false,none) -> exe;
   ('UnitTest','',true,true,false,none) -> exe;
   ('DumpObjEx','',true,false,false,none) -> exe;
   ('test','',true,true,false,none) -> exe;
   ('SimpleThreadEx','demo/',false,true,false,none) -> exe;
   ('SCPex','demo/',false,true,false,none) -> exe;
   ('ForkJoinEx','demo/',false,true,false,none) -> exe;
   ('MonitorDemo','demo/',false,true,false,none) -> exe;
   (*checkLIBstuff;*)
   'done'->putline;
   (if not resetLog then
       'diff -a A_mastertrace.txt A_trace.txt' -> putline;
       'diff -a A_mastertrace.txt A_trace.txt' -> System
   if);
#)

   
