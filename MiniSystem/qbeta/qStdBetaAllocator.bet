ORIGIN '~beta/basiclib/betaenv';
INCLUDE 'qStdBetaChecker';
---LIB:attributes---
qStdBetaAllocator: qStdBetaChecker
  (#
     StdBetaModule::<
       (# alloc:: 
            (# 
            do (*'StdBetaModule:alloc:'-> dumpT; moduleName.doPT->dumpTN;*)
            #)
       #);
     BetaFragments::<
       (# alloc:: 
            (# 
            do 'BetaFragments:alloc:'-> dumpT; 
               scanSons
               (# F:  ^BetaFragment;
               do (current[]->F[]).theName.dopt -> dumpTN #)
            #)
       #);
     AttSlot::<
       (# alloc::
            (#
            do scanBindings(#do current.alloc #)
            #);
          dumpAlloc:: (#do scanBindings(#do current.dumpAlloc #)#);
       #);
     ObjDescSlot::<
       (# alloc::
            (#
            do scanBindings(#do current.alloc #)
            #);
          dumpAlloc:: (#do (*scanBindings(#do current.dumpAlloc #)*) #);
       #);
     DoPartSlot::<
       (# alloc::
            (#
            do scanBindings(#do current.alloc #)
            #);
       #);
     ObjectDesc::<
       (# alloc:: 
            (# 
            do (if false then
                   '*** ObjectDesc:alloc:'-> dumpTN;  dopt -> putHead;
               if);
               (if slt[] = none then
                   (if (sup.theDesc = none) or (sup.theDesc = objDesc[])  then
                       1 -> originOff -> diSize
                    else
                       (sup.theDesc).alloc;
                       (if false then
                           ' super: ' -> dumpT; (sup.theDesc).originOff->putint;
                           ' ' -> put;(sup.theDesc).descNo->putint;
                       if);
                       (sup.theDesc).diSize -> diSize;
                       (sup.theDesc).vSize -> vSize;
                       (if sup.isSameBlockLevel then
                           (sup.theDesc).originOff -> originOff
                        else
                           diSize + 1 -> diSize -> originOff
                       if)
                   if);
                   newDescNo -> descNo; 
                   (if false then
                       ' ' -> put; descNo->putint; 
                       ' ' -> put; originOff -> putint; newline;
                   if)
                else
                   slt.scanBindings
                   (# ODF: ^ObjDescFrag
                   do (*'**** ObjDesc:alloc:slot:'->dumpT;current.dopt->dumpTN*)
                      (current[]->ODF[]).OD.alloc;
            #)if)#);
          getDescNo:: (# do descNo -> DN #);
          objSize::
            (#
            do (if false then
                   '**** ObjectDesc:objSize:'->dumpT; dopt -> putheadN;
               if);
               (if isPrimitive then
                   1 -> diSize (* should be set once and for all *)
                else
                   (if diSize = 0 then
                       (*'**** objDesc:doAlloc:'->dumptn;*)
                       alloc; (* and done*)
                   if);
               if);
               (if false then
                   '**** objDesc:'->dumpT;  
                   'size:'->dumpT; diSize -> putint; newline;
                   dopt -> putHeadN;
               if);
               diSize -> size
            #);
          dumpAlloc::
            (#
            do (*'ObjectDescriptor:'*)
               ' descNo: ' -> puttext; descNo -> putint;
               ' originOff: ' -> puttext; originOff -> putint;
               ' diSize: ' -> puttext; diSize -> putint;
               ' vSize: ' -> puttext; vSize -> putint; newline;
               newOD;
            #);
          descNo,originOff,diSize,vSize,innerInx: @integer
       #);
     BetaDecl::<
       (# alloc:: 
            (# 
            do (*'BetaDecl:alloc:'-> dumpT; dopt -> putheadN;*)
            #);
       #);
     StaticItem::<
       (#  alloc:: 
            (# 
            do (*'StaticItem:alloc:'-> dumpTN;*)
            #);
          isValItem::
            (#
            do (if false then
                   '**   isValItem:'->dumpT; dopt->dumpTN;
               if);
               OS.objSize -> size
            #); 
       #);
     DynamicItem::<
       (#  alloc:: 
            (# 
            do (*'DynamicItem:alloc:'-> dumpTN;*)
            #);
          isValItem::
            (#
            do (*'DynamicItem:isValItem:'->dumpt;*) 1 -> size
            #)
       #);
     BetaPattern::< (# #);
     BetaVirtualPattern::<
       (# isVirtualDecl:: TrueValue
       #);
     FurtherBinding::<
       (# isVirtualDecl:: TrueValue
       #);
     FinalBinding::<
       (# isVirtualDecl:: TrueValue
       #);
     PatternDen::<
       (# getDescNo:: (# do AD.getDescNo -> DN #);
          objSize:: (#do AD.objSize -> size #)
       #);
     BetaNameDecl::<
       (# alloc:: 
            (# size: @integer; OD: ^ObjectDesc
            do (if false then
                   'BetaNameDecl:alloc:'-> dumpT; dopt -> dumpTN;
               if);
               (if origin## = ObjectDesc## then
                   origin[] -> OD[];
                   (if (theDcl[] <> none) (* label in LabelledImp*) then
                       (if (theDcl.IT.isValItem -> size) > 0 then 
                           (if false then
                               'BetaNameDecl:alloc:size:'->dumpt;
                               size -> putint; ' '-> put; dopt -> dumpTN;
                           if);
                           OD.diSize + 1 -> off;
                           OD.diSize + size -> OD.diSize
                        else (if false then 'size=0:'->dumpt;  dopt->dumpT if);
                           (if theDcl.IT.isVirtualDecl then
                               (*'virtual:'->dumpT; *)
                               OD.vSize + 1 -> OD.vSize;
                               OD.vSize -> off;
                               (*'vDecl'-> dumpt*)
                   if)if)if);
                   (*newline*)
                else
                   '!!!! BetaNameDecl:alloc not handled: ' -> dumpt;
                   origin.label -> dumpTN
               if)
            #);
          dumpAlloc::
            (#
            do indent; 
               dopt -> dumpT; 'off: ' -> puttext; off -> putint; 
               (if theDcl.IT.isVirtualDecl then ' virtual:'->dumpT; if);
               (if not theDcl.IT.isSingular then newline if)
            #);
          off: @integer
       #);
     InnerImp::<
       (# alloc::
            (#
            do
            #)
       #)
     ObjectEvaluation::<
       (# alloc::
            (#
            do (if false then 
                   'ObjectEvaluation:alloc:'->dumpT; dopt->dumpT;
                   father.label -> dumpTN
               if)
            #)
       #);
     NameApl::<
       (# objSize::
            (#
            do (if false then
                   '**** NameApl:theSize:'->dumpT; dopt -> dumptn;
               if);
               (theDesc).objSize -> size
            #);
       #);
     
     newDescNo: @
       (# dn: @integer
       do dn + 1 -> dn
       exit dn
       #);
     allocStdBeta:
       (#
       do '\n**** Alloc ****'->putline;
          topModule.alloc;
          topModule.dumpAlloc;
       #)
  do
     inner
  #);
          
