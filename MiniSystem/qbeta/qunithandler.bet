ORIGIN '~beta/basiclib/betaenv';
INCLUDE 'qchecker';
INCLUDE 'qvirtual'
---lib:attributes---
UnitHandler: checker
  (# Pattern::<
       (# getUnitX:: 
            (# 
            do (if false then
                   '**** pattern:getUnitX: ' -> puttext; sig.dopt -> putline;
               if);
               OG.getUnitX -> U[]
            #);
       #);
     ObjectCall::<
       (# getUnitX:: (# ptn: ^Pattern do (super.last).getUnitX -> U[] #);
          getUnitPropShort::
            (# ptn: ^Pattern; 
            do (if false then
                   '**** objectCall:getUnitPropShort: ' -> puttext; dopt -> putline;
               if);
               (super.last).ATd[] -> ptn[];
               ptn.OG.getUnitPropShort -> U[];
            #);          
          computeUnit::
            (# rec,msg: ^Exp; i: @integer; recU,U: ^text;
            do (if true then
                   '**** ObjectCall:computeUnit: ' -> puttext; dopt -> putline;
                   '**   super.last.label: ' -> puttext; (super.last).label -> putline;
               if);
              (* (super.last).computeUnit -> U[];*)
               super.scanSons
               (#  
               do i + 1 -> i;
                  (if i 
                   // 1 then current[] -> rec[] 
                   // 2 then current[] -> msg[] 
                  if);
               #);
               (if i = 2 then
                   (* perhaps a binary method *)
                   (if true then
                       rec.computeUnit -> recU[]
                    else
                       rec.getUnitX -> recU[];
                   if);
                   msg.computeUnit -> U[];
                   
                   '**    binary:rec: ' -> puttext; rec.dopt -> puttext;
                   ' unit: ' -> puttext; recU[] -> puttext;
                   ' msgU: ' -> puttext; U[] -> puttext; 
                   ' msg: ' -> puttext; msg.label -> puttext;
                   ' args: ' -> puttext; msg.args.dopt -> putline
               if)
            #);
       #);
     ObjectGenerator::<
       (# getUnitX::
            (#
            do (if false then '**** objectGenerator:getUnitX: ' -> puttext; newline if);
               (if (getUnitPropShort -> U[]) = none then
                   (if (super.ATd[] <> none) then
                       super.ATd.OG.getUnitX -> U[]
               if)if)
            #);  
         getUnitPropShort::
            (# UN: ^NewProperty;
            do (if (IS.newBasicProp.unit[]-> UN[]) <> none then
                    (* unit is defined for this OG*)
                   UN.args.scanSons
                   (#
                   do current.scanSons
                      (# S: ^StringObj
                      do (if current.isStringLiteral then
                             (current[] -> S[]).T[] -> U[]
                         if)
               #)#)if)
            #);          
       #);
     invocation::<
       (# computeUnit::
            (# rec,msg: ^Exp; i: @integer; recU,U: ^text;
            do (if true then
                   '**** Invocation:ComputedUnit: ' -> puttext; dopt -> putline
               if);
               scanSons
               (#  
               do i + 1 -> i; current.label -> putline; current.dopt -> putline;
                  (if i 
                   // 1 then current[] -> rec[] ; rec.doPP -> putline
                   // 2 then current[] -> msg[] 
                  if);
               #);
               (if i = 2 then
                   (* perhaps a binary method *)
                   (if true then
                       rec.computeUnit -> recU[]
                    else
                       rec.getUnitX -> recU[];
                   if);
                   msg.computeUnit -> U[];
                   
                   '**    Invocation:binary:rec: ' -> puttext; rec.dopt -> puttext;
                   ' unit: ' -> puttext; recU[] -> puttext;
                   ' msgU: ' -> puttext; U[] -> puttext; 
                   ' msg: ' -> puttext; msg.label -> puttext;
                   ' args: ' -> puttext; msg.args.dopt -> putline
               if)
            #)
       #);
     ObjectInvocation::<
       (# getUnitX::
            (#
            do (if false then 
                   '**** objectInvocation:getUnitX: ' -> puttext; dopt -> putline;
               if);
               ATd.getUnitX -> U[]               
            #);
          computeUnit::
            (#
            do (if true then
                   '**** ObjectInvocation:ComputeUnit: ' -> puttext; 
                   label -> puttext; ' ' -> put; dopt -> putline
               if);
               '**   op: "' -> puttext; type.isOp -> puttext; '"' -> put; newline;
               type.isOp -> U[]
            #)
       #);
     BracketedExp::<
       (# computeUnit::
            (#
            do (if true then
                   '**** BracketedExp:ComputeUnit: ' -> puttext; dopt -> putline
               if);
               IV.computeUnit -> U[]
            #)
       #);
  do inner
  #)
