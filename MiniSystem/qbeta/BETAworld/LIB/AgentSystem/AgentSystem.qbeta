AgentSystem: obj
   %visible Containers.Set,QBETA,StringLib

   Point(X: var integer):and(y: var integer): value
      print:
         " PT({I2S(x)}):at({I2S(y)}) ".print
   random(V: var integer):
      out R: var integer
      R := 111 /% V      
   World:
      -- The world is two dimensional and divided into a grid of patches 
      BasicAgent:
         -- The world is made up of agents
         -- Agents are beings that can follow instructions
         print:<
            "BasicAgent:".print
            inner(print)
         inner(BasicAgent)
      Agent: BasicAgent
         pos: var Point(0):and(0)
         inner(Agent)
         print:<
            inner(print)
      Turtle(who: var integer): Agent
         -- A Turtle is an agent that move around in the world. 
         pen: obj 
            down:
               put('D')
            up:
               put('U')	    
            color: var char
            draw:
               put(color)
               pos.print
         fd(s: var integer):
            pen.draw
            pos.x := pos.x + s
            pos.y := pos.y + s  
         rt(d: var integer):
            pos.x := pos.x + d	 
         lt(d: var integer):
            pos.y := pos.y + d	 
         neighbors4:
             out N: ref PatchSet
             print:<
                "Turtle:{I2S(who)}:".print 
      Patch: Agent
         --  A patch is a square piece of ground over which turtles can move
         pDum: var integer
      Link: BasicAgent
         -- A Link is an agent that connect two turtles.
         T1: ref Turtle
         T2: ref Turtle
      TurtleSet: Set(#Turtle)
         ask:
            current: ref Elm
            cond:<
               out V: var Boolean
            scan
               this(ask).current := current
               inner(ask)
      PatchSet: Set(#Patch)
         dum: var integer
      turtles: obj TurtleSet
      tick:
         put('t')
      clear_all:
         turtles.clear
      create_turtles(n: var integer):          
         for (1):to(n):repeat
             turtles.insert(Turtle(inx))
      inner(World)
      Observer: obj Agent
         dum: var integer
         go:
            create_turtles(10)
            for(1):to(10):repeat
               Turtles.ask
                  current.print
                  current.pen.color := 'a' + current.who      
                  current.fd(1)
                  current.lt(random(current.who + 10))
                  current.rt(random(current.who + 13))
               "\n----------\n".print
   World
      Observer.go
   newline
