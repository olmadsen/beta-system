xMonitorDemo: @MonitorSystem.System
  (# P1: @ Process
       (# fac:
            (# V,res: @integer
            enter V
            do (if V = 1 then 1 -> res else (V - 1 -> fac) * V -> res if)
            exit res
            #)
       do (for i: 10 repeat 
               ('P1',1000 + (i -> fac))  -> M.putItem
          for)
       #);
     M: @ Monitor
       (# putItem: entry
            (# P: ^text; itm: @integer
            enter(P[],itm)
            do '<'->put; P.print; ':' -> put; itm -> putint; '>'->put; '\n'.print;
            #)
          getItem: entry
            (#
            do
            #);
          item: @integer
       #);
     P2: @ Process
       (# sum:
            (# V,res: @integer
            enter V
            do (for i: 100 repeat res + V -> res for);
            exit res
            #);
       do (for i: 10 repeat 
               ('P2',2000 + (i -> sum)) -> M.putItem
          for)
       #);
     P3: @ Process 
       (# mult:  
            (# V,res: @integer
            enter V
            do (for i: 100 repeat 
                    V * V + res -> res;
                    (if res > 1000 then res div res -> res if)
               for)
            exit res
            #)                    
       do (for i:10 repeat 
               ('P3',3000 + (i -> mult)) -> M.putitem;
          for)
       #);
     
  do 'xMonitorSystem demo:\n'.print; 
     M.init; 
     M[] -> theM[];
     101 -> P1.start; 102 -> P2.start; 103 ->  P3.start
  #)
