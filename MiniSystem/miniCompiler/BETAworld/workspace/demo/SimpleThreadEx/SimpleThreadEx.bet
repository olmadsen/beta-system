SimpleThreadEx: @
  (# P1: @
       (# R: @
            (#
               foo: (# do 'F'-> put; newline #);
            #)
       do (for i: 100 repeat
               R.foo;
               mutex.lock;
               'Hello from P1\n'.print;
               mutex.unlock
          for)
       #);     
     P2: @
       (# S: @
            (# bar: (# do 'B' -> put; newline #)
            #);
       do (for i:100 repeat
               S.bar;
               mutex.lock;
               'Hello from P2\n'.print;
               mutex.unlock
          for)
       #);
     Mutex: @
       (# M: @integer;
          compareAndSwap:
            (# V: @integer; res: @boolean
            enter V
            do V -> M.cmpAndSwap -> res  (* intel instruction lock cmpxchg *)
            exit res
            #);
          lock:
            (# res: @integer
            do Loop:
                 (# 
                 do 1 -> M.cmpAndSwap -> res;                    
                    (if res = 1 then 
                        500 -> sleep; (* Primitive operation *)
                        restart Loop 
                    if)
                 #);
            #);
          unlock: (# do 0 -> M #)
       #);

  do '!' -> put;
     P1[] -> fork; (* Primitive operation *)
     P2[] -> fork; (* Spawning object attached to OS thread *)
     
     mutex.lock;
     'Hello from main\n'.print;
     mutex.unlock
  #)
