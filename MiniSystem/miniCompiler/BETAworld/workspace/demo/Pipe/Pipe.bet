Pipe: @
  (# keyboard: @ DefaultKeyboard;
     Prod: @
       (# ch: @Char;
       do Pipe.init;
          readLine:
           (if 1 then          
               get -> ch;
               (if ch = 10 then 
                   Pipe.eol; Pipe.init 
                else
                   ch -> Pipe.putx
               if);
               (if ch = '.' then leave readLine if);
               restart readLine
           if);
       #);
     
     Pipe: @
       (# init: (# do &text(100)[] -> line[] #);
          putx: (# ch: @char enter ch do ch -> line.putx   #); 
          eol: (# do line[] -> DisAsm #);
          line: ^text;
          
          DisAsm: @ 
            (# inLine: ^text
            enter inLine[]
            do inLine.scan(# do currentCh -> Squash.putx #);
               Squash.doIt
	    #);
          Squash: @ 
            (# putx: 
                 (# ch: @Char
                 enter ch
                 do ch -> line.putx; 
                 #);               
               doIt:
                 (# 
                 do line.scan
                    (#
                    do (if currentCh = '*' then
                           '^' -> Asm.putx
                        else 
                           currentCh -> Asm.putx
                       if)
                    #);
                    10 -> Asm.putx;
                    line.clear
                 #);
               line: @text
            #);
          Asm: @
            (# putx: 
                 (# ch: @Char
                 enter ch
                 do ch -> OutLine.putx;
                    (if ch = 10 then 
                        OutLine[] -> Cons.putx
                    if)
                 #);
	    #);
          OutLine: @text
       #);
     Cons: @
       (# putx: (# T: ^text enter T[] do T.print #)
       #);
     
  do Prod;
     10 -> put
  #)

