ActorSystem: @ BasicSystem
  (# with Containers;
     System: BasicSystem
       (# Message:
            (# id: @integer;
               display: (# do '\nMessage here:\n'.print#)
            enter id
            exit this(Message)[]
            #);
          MessageQueue: Queue
            (#
            #);
          Actor: BasicProcess
            (# start:: (# do this(actor)[] -> SQS.insert #);
               send: 
                 (# M: ^Message 
                 enter M[] 
                 do L.get; 
                    M[] -> Q.insert; 
                    (if status = P_status.WAITING then '!'->put;
                        this(Actor)[] -> SQS.insert;
                        SQS.dcrWaiting
                    if)
                    L.free 
                 #);
               select:
                 (# receive:
                      (# id: @integer; msg: ## Message; match: @boolean
                      enter msg##
                      do L.get; 
                         L:
                           Q.scan
                           (# 
                           do current[] -> M[]; 
                              (if msg## = M## then 
                                  M[] -> Q.remove;
                                  true -> match -> found;
                                  leave L
                              if)
                           #);
                         L.free
                      exit match
                      #);
                    found: @boolean;
                    M: ^Message
                 do false -> found;
                    waitMessage:
                      (if 1 then
                          L.get;
                          (if Q.isEmpty then 
                              '?'->put;
                              SQS.addWaiting;
                              P_status.WAITING -> status;
                              L.free;
                              this(Actor).suspend;
                              restart waitMessage
                           else 
                              '\nScan: '.print;
                              Q.scan
                              (#do current[] -> M[]; M.id->putint; ' ' -> put#);
                              L.free;
                              inner;
                              (if not found then 
                                  this(Actor).suspend;
                                  restart waitMessage
                              if);
                          if)
                      if)
                 #);               
               Q: @MessageQueue;
               L: @Lock
            do 'Lock'->L.init;
               P_status.ACTIVE -> status;
               inner;
               P_status.TERMINATED -> status  
            #)
       do console.display(#do '\nActor System:\n'.print; #);
          inner
       #)
  #)

