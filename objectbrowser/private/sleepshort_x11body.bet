ORIGIN '../sleepshort';
INCLUDE '~beta/basiclib/v1.4/private/basicsystemenvbody';
INCLUDE '~beta/guienv/v1.3.hml/private/X11/guienvxsystemenvbody';

--- systemlib:attributes ---

XtAppAddTimeOut: external
  (# appContext: @integer;
     interval: @integer;
     proc: @Integer; (* We only install callbacks once. *)
     closure: @integer;
     intervalId: @integer;
  enter (appContext,interval,proc,closure)
  do callC
  exit intervalId
  #);

makeCBF: External
  (# pat: ##external;
     cb: @integer;
  enter pat##
  exit cb
  #);

--- sleepshortsleep:descriptor ---
(# new: ^sleepers.element; 
do 
   &sleepers.element[]->new[];
   ssprivate.nextid->new.id;
   (private.mdpriv.pioPrivate.appContext,(ticks*1000) div 60,
   ssprivate.shortSleepTimeoutPtr,new.id)->XtAppAddTimeOut;
   new[]->sleepers.append;
   new.sem.P;
#)

--- sleepshortinit:descriptor ---
(# 
do ssprivate.shortSleepTimeout##->makeCBF->ssprivate.shortSleepTimeoutPtr;
   sleepers.init;
#)

--- sleepshortprivate:descriptor ---
(# shortSleepTimeoutPtr: @Integer;
   shortSleepTimeout: external
     (# data,id: @Integer;
     enter (data,id)
     do cExternalEntry;
        iter: sleepers.iterate
          (# 
          do (if current.elm.id//data then
                 current.elm.sem.V;
                 current[]->sleepers.delete;
                 leave iter;
                 private.mdpriv.pioPrivate.ensure;
             if);
          #);
     #);
   nextid: @IntegerValue (# do value+1->value #);
#)
