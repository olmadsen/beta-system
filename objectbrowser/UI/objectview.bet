ORIGIN 'moveable';
BODY 'private/objectviewbody';

INCLUDE '../objectdumper';
INCLUDE '../attribute';
INCLUDE 'icons';
INCLUDE '~beta/guienv/v1.6/scrolllists';
INCLUDE 'listmoveable';

--- guienvlib:attributes ---

objectViewList: List 
  (# (*element:: window.objectView;*)
     onInsert:<
       (# theObjectView: ^window.objectView;
       enter theObjectView[]
       do INNER
       #);
     onDelete:<
       (# theObjectView: ^window.objectView;
       enter theObjectView[]
       do INNER
       #); 
     newscan: scan
       (# cur: ^window.objectView;
       do current[]->cur[]; INNER;
       #);
  #);

getobjectViewList: objectPool.get
  (# type::< objectViewList; init:: (# do obj.init #)#);

--- windowLib: attributes ---
OpenObjectView: 
  (# bo: ^betaObject; 
     force: @Boolean; (* If TRUE, a new view is opened in any case. *)
  enter (bo[],force)
  do INNER   
  #);

objectView: listMoveableList
  (# <<SLOT objectViewLib:attributes>>;
     
     (* Open this objectView, but do not set any bindings. *)
     open::< (# do <<SLOT objectViewOpen:descriptor>> #);
     close::< (# <<SLOT ObjectViewClose:dopart>> #);
     onIconify:: (# <<SLOT objectViewOnIconify:dopart>> #);
     onDeIconify:: (# <<SLOT objectViewOnDeIconify:dopart>> #);
     doUpdate::< (# <<SLOT objectViewDoUpdate:dopart>> #);
     
     (* writeObj writes the representation of the object returned from
      * getObject to the scrolllist. Is called by open, and may later be
      * called to update the view. *)
     writeObj: <<SLOT objectViewWriteObject:descriptor>>;
     
     eventHandler:: 
       (# onmouseDown:: (# do <<SLOT objectViewOnMouseDown:descriptor>> #);
          onSelect:: (# <<SLOT objectViewOnSelect:dopart>> #);
       #);
     
     bo: ^betaObject; (* Fetched initially from encl.getObject. *)
     
     rootType: rootAttribute
       (# onComplexCreate:: (# <<SLOT objectViewOnComplexCreate:dopart>> #);
       #);
     root: ^rootType;
     
     itemMenu: @menu
       (# <<SLOT itemMenuAttributes: attributes>>;
          targetatt: ^attribute; 
          (* When itemMenu is popped up, targetatt is the attribute
           * that was selected on popup. *)
          open::< (# do <<SLOT itemMenuOpen:descriptor>> #);  
          close::< (# <<SLOT itemMenuClose:dopart>> #);
          imprivate: @<<SLOT itemMenuPrivate:descriptor>>;
          (* Lists of actions to be performed when this menu is opened
           * or popped up: *)
          onOpen: @ActionList;
          onPopup: @ActionList;
       #);
     
     getencloser:<
       (# theEncloser: ^objectViewEncloser;
       do INNER; theEncloser[]->encl[];
       exit theEncloser[]
       #);
     encl: ^objectViewEncloser;
     
     ovprivate: @<<SLOT ovprivate:descriptor>>;
  #);

objectViewEncloser:
  (# onHighLight:< Object; (* Called when the objectView should attract attention. *)
     
     getObject:< (# bo: ^betaObject do INNER exit bo[] #);
     (* Further bind to open a new object view. Called by objectView when user 
      * clicks on dynamic reference. *)
     newObjectView:< OpenObjectView;     
     onObjectChange:< 
       (* Called when the object displayed changes. If isGarbage is TRUE,
        * the object displayed has become garbage. *)
       (# root: ^rootAttribute; isGarbage: @Boolean;
       enter (root[],isGarbage)
       do INNER
       #);
     onLowLevelObjectChange:<
       (* Called when the object displayed changes to an object whose
        * type is unknown, or simply if we want to view low-level
        * information on the object entered. If isGarbage is TRUE,
        * the object displayed has become garbage. *)
       (# bo: ^betaObject; isGarbage: @Boolean;
       enter (bo[],isGarbage)
       do INNER
       #);
     
     getMoveable:<
       (* If the objectView is enclosed by a moveable, getMoveable should
        * return it. *)
       (# mov: ^moveable;
       do INNER
       exit mov[]
       #);
     
     tryclose:< Object;
  #);

OpenMoveableObjectView: openObjectView 
  (# getFather:< (# father: ^Canvas do INNER exit father[] #);
  do <<SLOT openMoveableObjectView:descriptor>>
  #);

MoveableObjectView: listmoveable
  (# <<SLOT moveableObjectViewLib:attributes>>;
     
     theBo: ^betaObject;
     open::< (# enter theBo[] do INNER #);
     
     contentsType::<
       (# listType::< ObjectView
            (# getencloser::< (# do listencloser[]->theEncloser[] #)#);
       #);
     
     listEncloserType:< objectViewEncloser
       (# newObjectView::< OpenMoveableObjectView
            (# getFather::< (# <<SLOT movGetFather: dopart>> #)#);
          onHighlight:: (# do wriggle #);
          getObject:: (# do theBo[]->bo[] #);
          onObjectChange:: 
            (# 
            do <<SLOT moveableObjectViewonObjectChange:descriptor>>
            #);
          onLowLevelObjectChange::
            (# 
            do <<SLOT moveableObjectViewonLowlewelObjectChange:descriptor>>
            #);
          getMoveable::
            (# 
            do THIS(moveableObjectView)[]->mov[]
            #);
          tryclose:: (# do THIS(moveableObjectView).close #);
       #);
     listencloser: @listEncloserType;
     
     icon::
       (#
       do 'MoveableObjectView_Icon' -> (getIconDB).getIcon -> theIcon[];
       #);
     
     moveableMenu::<
       (# <<SLOT moveableObjectViewMenuLib: attributes>>;
          open::< (# do <<SLOT moveableObjectViewMenuOpen: descriptor>> #);
          close::< (# <<SLOT moveableObjectViewMenuClose: dopart>> #);
          movmPrivate: @<<SLOT moveableObjectViewMenuPrivate: descriptor>>
       #);
  #);

