ORIGIN '~beta/toollibs/utils/mpsinterface';
INCLUDE 'objectdumper';
INCLUDE 'objectdb';
INCLUDE '~beta/sysutils/objinterface';

--- mpsinterfacelib:attributes ---

localdumper: objectdumper
  (# betaObjectType:: localBetaObject;
     betaPatternType:: localBetaPattern;
     betaObjectObjectDescriptor::
       (# pt: @prototype;
       do bo.o[] -> getProtoType -> pt;
          (pt.groupId->fragmentGroupTable.getFragmentGroup,
          pt.formIndex,pt.astIndex*2)->astRefToAst->value[];
       #);
     betaPatternObjectDescriptor:: 
       (# pt: @prototype;
       do bp.p## -> getProtoTypeForStruc -> pt;
          (pt.groupId->fragmentGroupTable.getFragmentGroup,
          pt.formIndex,pt.astIndex*2)->astRefToAst->value[];
       #);
     
     localPatternOwner: @patternOwner (# #);
     localObjectOwner: @objectOwner (# #);
     
     NONEobject: @localBetaObject;
     NONEpattern: @localBetaPattern;
     
     objects: ^localObjectDB;
     
     init::
       (# 
       do getLocalObjectDB->objects[];
          (NONE,NONE)->NONEobject.init;
          (NONE,NONE)->NONEpattern.init;
       #);
  #);

localObjectDB: objectDB
  (# betaObjectType:: localBetaObject;
     betaPatternType:: localBetaPattern;
  #);

getLocalObjectDB: getObjectDB (# type:: localObjectDB #);

newLocalObject:
  (# obj: ^Object; ld: ^localdumper;
     bo: ^localBetaObject; 
  enter (ld[],obj[])
  do lookup:
       (if obj[]<>NONE then
           (* Try to find the object in the objectDB: *)
           ld.objects.scanObjects
           (# 
           do (if current.bo.o[]=obj[] then
                  current.bo[]->bo[]; leave lookup;
              if);
           #);
        else
           ld.NONEobject[]->bo[];
       if);
     (if bo[]=NONE then
         &localBetaObject[]->bo[];
         (ld[],obj[])->bo.init;
         (bo[],ld.localObjectOwner[])->ld.Objects.addObjectOwner;
     if);
     bo.touch;
  exit bo[]
  #);

newLocalPattern:
  (# bp: ^localBetaPattern;
     p: ##Object;
     ld: ^localdumper;
  enter (ld[],p##)
  do 
     lookup:
       (if p##<>NONE then
           (* We should be able to find the object in the objectDB: *)
           ld.objects.scanPatterns
           (# 
           do (if current.bp.p##=p## then
                  current.bp[]->bp[]; leave lookup;
              if);
           #);
        else
           ld.NONEpattern[]->bp[];
       if);
     (if bp[]=NONE then
         &localBetaPattern[]->bp[];
         (ld[],p##)->bp.init;
         (bp[],ld.localPatternOwner[])->ld.objects.addPatternOwner;
     if);
     bp.touch;
  exit bp[]
  #);

localBetaObject: betaObject
  (# betaPatternType:: localBetaPattern;
     betaObjectType:: localBetaObject;
     o: ^Object;
     iscomp: @Boolean;
     isComponentObject:: (# do iscomp->value #);
     init::
       (# ato: @addressToObject;
       enter (o[])
       do (if o[] -> isComponent -> iscomp then
              ((%getLongAt(@@o))) + 24 -> ato -> o[]
              (* Above line tos_converted from: (@@o -> TOS'%adrGetLong') + 24 -> ato -> o[] *)
          if);
       #);
     Equal::
       (# 
       do (other.o[]=o[]) -> value;
       #);
     IsNone:: 
       (# 
       do (o[]=NONE) -> value;
       #);
     CharAttr::
       (# 
       do %getByteAt(((%getLongAt(@@o))) + offset + 0) -> value;
          (* Above line tos_converted from: do (@@o -> TOS'%adrGetLong') + offset -> TOS'%adrGetByte[0]' -> value; *)
          
       #);
     SetCharAttr::
       (# 
       do (value) %putByteAt (((%getLongAt(@@o)))+offset)
          (* Above line tos_converted from: do (value) %putByteAt ((@@o->TOS'%adrGetLong')+offset) *)
       #);
     BooleanAttr::
       (# 
       do %getByteAt(((%getLongAt(@@o))) + offset + 0) -> value;
          (* Above line tos_converted from: do (@@o -> TOS'%adrGetLong') + offset -> TOS'%adrGetByte[0]' -> value; *)
          
       #);
     SetBooleanAttr::
       (# 
       do (value) %putByteAt (((%getLongAt(@@o)))+offset)
          (* Above line tos_converted from: do (value) %putByteAt ((@@o->TOS'%adrGetLong')+offset) *)
       #);
     ShortIntAttr:: 
       (#  
       do %getShortAt(((%getLongAt(@@o))) + offset + 2*0) -> value;
          (* Above line tos_converted from: do (@@o -> TOS'%adrGetLong') + offset -> TOS'%adrGetShort[0]' -> value; *)
          
       #);
     SetShortIntAttr:: 
       (#  
       do (value) %putShortAt (((%getLongAt(@@o)))+offset)
          (* Above line tos_converted from: do (value) %putShortAt ((@@o->TOS'%adrGetLong')+offset) *)
       #);
     IntegerAttr::
       (# 
       do %getLongAt(((%getLongAt(@@o))) + offset) -> value;
          (* Above line tos_converted from: do (@@o -> TOS'%adrGetLong') + offset -> TOS'%adrGetLong' -> value; *)
          
       #);
     SetIntegerAttr:: 
       (#  
       do (value) %putLongAt (((%getLongAt(@@o)))+offset)
          (* Above line tos_converted from: do (value) %putLongAt ((@@o->TOS'%adrGetLong')+offset) *)
       #);
     RealAttr::
       (# a,b: @Integer;
       do %getLongAt(((%getLongAt(@@o))) + offset) -> a;
          (* Above line tos_converted from: do (@@o -> TOS'%adrGetLong') + offset -> TOS'%adrGetLong' -> a;*)
          %getLongAt(((%getLongAt(@@o))) + offset + 4) -> b;
          (* Above line tos_converted from: (@@o -> TOS'%adrGetLong') + offset + 4 -> TOS'%adrGetLong' -> b; *)
          (a) %putLongAt(@@value);
          (* Above line tos_converted from: (@@value,a) -> TOS'%putLong'; *)
          (b) %putLongAt(@@value+4);
          (* Above line tos_converted from: (@@value+4,b) -> TOS'%putLong'; *)
       #);
     SetRealAttr:: 
       (#  
       do ((%getLongAt(@@value))) %putLongAt (((%getLongAt(@@o)))+offset);
          (* Above line tos_converted from: do ((%getLongAt(@@value))) %putLongAt ((@@o->TOS'%adrGetLong')+offset); *)
          (* Above line tos_converted from: do (@@value->TOS'%adrGetLong') %putLongAt ((@@o->TOS'%adrGetLong')+offset); *)
          ((%getLongAt(@@value+4))) %putLongAt (((%getLongAt(@@o)))+offset+4);
          (* Above line tos_converted from: (@@value+4->TOS'%adrGetLong') %putLongAt ((@@o->TOS'%adrGetLong')+offset+4); *)
          
       #);
     ReferenceAttr::
       (# ato: @addressToObject;
       do (dumper[], %getLongAt(((%getLongAt(@@o)))+ offset)->ato)
          (* Above line tos_converted from: do (dumper[], (@@o->TOS'%adrGetLong')+ offset->TOS'%adrGetLong'->ato) *)
            ->newLocalObject->value[];
       #);
     SetReferenceAttr::
       (# 
       do (((%getLongAt(@@o)))+offset,(%getLongAt(@@value.o)))
          (* Above line tos_converted from: do (((%getLongAt(@@o)))+offset,@@value.o->TOS'%adrGetLong') *)
          (* Above line tos_converted from: do ((@@o->TOS'%adrGetLong')+offset,@@value.o->TOS'%adrGetLong') *)
            ->assignRef;
       #);
     OriginAttr::
       (# ato: @addressToObject;
       do (dumper[], %getLongAt(((%getLongAt(@@o)))+ offset)->ato)
          (* Above line tos_converted from: do (dumper[], (@@o->TOS'%adrGetLong')+ offset->TOS'%adrGetLong'->ato) *)
            ->newLocalObject->value[];
       #);
     SetOriginAttr::
       (# 
       do (((%getLongAt(@@o)))+offset,(%getLongAt(@@value.o)))
          (* Above line tos_converted from: do (((%getLongAt(@@o)))+offset,@@value.o->TOS'%adrGetLong') *)
          (* Above line tos_converted from: do ((@@o->TOS'%adrGetLong')+offset,@@value.o->TOS'%adrGetLong') *)
            ->assignRef;
       #);
     PartObject::
       (* A negative offset means that the part object requested 
        * is offline allocated. In that case partObject should 
        * effectively do the same as referenceValue. *)
       (# ato: @addressToObject;
       do (if offset < 0 then
              (dumper[],%getLongAt(((%getLongAt(@@o)))-offset)->ato)
              (* Above line tos_converted from: (dumper[],(@@o->TOS'%adrGetLong')-offset->TOS'%adrGetLong'->ato) *)
                ->newLocalObject->value[]
           else
              (dumper[],((%getLongAt(@@o)))+offset->ato)->newLocalObject->value[];
              (* Above line tos_converted from: (dumper[],(@@o->TOS'%adrGetLong')+offset->ato)->newLocalObject->value[]; *)
          if);
       #);
     SetPartObject::
       (* A negative offset means that the part object requested 
        * is offline allocated. In that case partObject should 
        * effectively do the same as referenceValue. *)
       (# ato: @addressToObject;
       do (if offset < 0 then
              (((%getLongAt(@@o)))-offset,(%getLongAt(@@value.o)))
              (* Above line tos_converted from: (((%getLongAt(@@o)))-offset,@@value.o->TOS'%adrGetLong') *)
              (* Above line tos_converted from: ((@@o->TOS'%adrGetLong')-offset,@@value.o->TOS'%adrGetLong') *)
                ->assignRef;
           else
              (failure,'localBetaObject.SetPartObject: Only offline allocated partobjects can be set')->stop;
          if);
       #);
     Range::
       (#
       do %getLongAt((%getLongAt(((%getLongAt(@@o)))+offset))+8)->low;
          (* Above line tos_converted from: do ((@@o->TOS'%adrGetLong')+offset->TOS'%adrGetLong')+8->TOS'%adrGetLong'->low; *)
          %getLongAt(%getLongAt(((%getLongAt(@@o)))+offset)+12)->high;
          (* Above line tos_converted from: ((@@o->TOS'%adrGetLong')+offset->TOS'%adrGetLong')+12 *)
       #);
     SetRange::
       (# 
       do 'localBetaObject.SetRange: SetRange not implemented'->putline;
       #);
     CharRepAttr::
       (# source: @Integer;
       do to-from+1 -> value.new;
          (%getLongAt(((%getLongAt(@@o)))+offset))+16+from-1
          (* Above line tos_converted from: ((@@o->TOS'%adrGetLong')+offset->TOS'%adrGetLong')+16+from-1 *)
            -> source;
          (@@value[1],source,to-from+1) -> memcpy;
       #);
     SetCharRepAttr::
       (# target: @Integer;
          low,high: @Integer;
       do offset->range->(low,high);
          (if (low<=from) and (to<=high) then
              (%getLongAt(((%getLongAt(@@o)))+offset))+16+from-1
              (* Above line tos_converted from: ((@@o->TOS'%adrGetLong')+offset->TOS'%adrGetLong')+16+from-1 *)
                -> target;
              (target,@@value[1],to-from+1) -> memcpy;
           else
              (failure,'localBetaObject.SetCharRepAttr: INDEX ERROR')
                ->stop;
          if);
       #);
     BooleanRepAttr::
       (# source: @Integer;
       do to-from+1 -> value.new;
          (%getLongAt(((%getLongAt(@@o)))+offset))+16+from-1
          (* Above line tos_converted from: ((@@o->TOS'%adrGetLong')+offset->TOS'%adrGetLong')+16+from-1 *)
            -> source;
          (@@value[1],source,to-from+1) -> memcpy;
       #);
     SetBooleanRepAttr::
       (# target: @Integer;
          low,high: @Integer;
       do offset->range->(low,high);
          (if (low<=from) and (to<=high) then
              (%getLongAt(((%getLongAt(@@o)))+offset))+16+from-1
              (* Above line tos_converted from: ((@@o->TOS'%adrGetLong')+offset->TOS'%adrGetLong')+16+from-1 *)
                -> target;
              (target,@@value[1],to-from+1) -> memcpy;
           else
              (failure,'localBetaObject.SetBooleanRepAttr: INDEX ERROR')
                ->stop;
          if);
       #);
     ShortIntRepAttr::
       (# source: @Integer;
       do to-from+1 -> value.new;
          (%getLongAt(((%getLongAt(@@o)))+offset))+16+2*(from-1)
          (* Above line tos_converted from: ((@@o->TOS'%adrGetLong')+offset->TOS'%adrGetLong')+16+2*(from-1) *)
            -> source;
          (@@value[1],source,(to-from+1)*2) -> memcpy;
       #);
     SetShortIntRepAttr::
       (# target: @Integer;
          low,high: @Integer;
       do offset->range->(low,high);
          (if (low<=from) and (to<=high) then
              (%getLongAt(((%getLongAt(@@o)))+offset))+16+2*(from-1)
              (* Above line tos_converted from: ((@@o->TOS'%adrGetLong')+offset->TOS'%adrGetLong')+16+2*(from-1) *)
                ->target;
              (target,@@value[1],(to-from+1)*2) -> memcpy;
           else
              (failure,'localBetaObject.SetShortIntRepAttr: INDEX ERROR')
                ->stop;
          if);
       #);
     IntegerRepAttr::
       (# source: @Integer;
       do to-from+1 -> value.new;
          (%getLongAt(((%getLongAt(@@o)))+offset))+16+4*(from-1)
          (* Above line tos_converted from: ((@@o->TOS'%adrGetLong')+offset->TOS'%adrGetLong')+16+4*(from-1) *)
            -> source;
          (@@value[1],source,(to-from+1)*4) -> memcpy;
       #);
     SetIntegerRepAttr::
       (# target: @Integer;
          low,high: @Integer;
       do offset->range->(low,high);
          (if (low<=from) and (to<=high) then
              (%getLongAt(((%getLongAt(@@o)))+offset))+16+4*(from-1)
              (* Above line tos_converted from: ((@@o->TOS'%adrGetLong')+offset->TOS'%adrGetLong')+16+4*(from-1) *)
                -> target;
              (target,@@value[1],(to-from+1)*4) -> memcpy;
           else
              (failure,'localBetaObject.SetIntegerRepAttr: INDEX ERROR')
                ->stop;
          if);
       #);
     RealRepAttr::
       (# source: @Integer;
       do to-from+1 -> value.new;
          (%getLongAt(((%getLongAt(@@o)))+offset))+16+8*(from-1)
          (* Above line tos_converted from: ((@@o->TOS'%adrGetLong')+offset->TOS'%adrGetLong')+16+8*(from-1) *)
            -> source;
          (@@value[1],source,(to-from+1)*8) -> memcpy;
       #);
     SetRealRepAttr::
       (# target: @Integer;
          low,high: @Integer;
       do offset->range->(low,high);
          (if (low<=from) and (to<=high) then
              (%getLongAt(((%getLongAt(@@o)))+offset))+16+8*(from-1)
              (* Above line tos_converted from: ((@@o->TOS'%adrGetLong')+offset->TOS'%adrGetLong')+16+8*(from-1) *)
                -> target;
              (target,@@value[1],(to-from+1)*8) -> memcpy;
           else
              (failure,'localBetaObject.SetRealRepAttr: INDEX ERROR')
                ->stop;
          if);
       #);
     ReferenceRepAttr::
       (# source: @Integer;
          ato: @addressToObject;
       do to-from+1 -> value.new;
          (for i:to-from+1 repeat
               (dumper[], %getLongAt((%getLongAt(((%getLongAt(@@o)))+offset))+16+4*(i+from-2))->ato)
               (* Above line tos_converted from: (dumper[], (((@@o->TOS'%adrGetLong')+offset)->TOS'%adrGetLong')+16+4*(i+from-2)->TOS'%adrGetLong'->ato) *)
                 -> newLocalObject->value[i][];
          for);
       #);
     SetReferenceRepAttr::
       (# target: @Integer;
          low,high: @Integer;
       do offset->range->(low,high);
          (if (low<=from) and (to<=high) then
              (for i:to-from+1 repeat
                   ((%getLongAt(((%getLongAt(@@o)))+offset))+16+4*(i+from-2),
                   (* Above line tos_converted from: ((((@@o->TOS'%adrGetLong')+offset)->TOS'%adrGetLong')+16+4*(i+from-2), *)
                   (%getLongAt(@@value[i].o)))
                   (* Above line tos_converted from: @@value[i].o->TOS'%adrGetLong') *)
                     ->assignRef;
              for);              
           else
              (failure,'localBetaObject.SetReferenceRepAttr: INDEX ERROR')
                ->stop;
          if);
       #);
     StatObjectRepAttr::
       (# source: @Integer;
          ato: @addressToObject;
       do      
          to-from+1 -> value.new;
          (for i:to-from+1 repeat
               (dumper[], %getLongAt((%getLongAt(((%getLongAt(@@o)))+offset))+24+4*(i+from-2))->ato)
               (* Above line tos_converted from: (dumper[], (((@@o->TOS'%adrGetLong')+offset)->TOS'%adrGetLong')+24+4*(i+from-2)->TOS'%adrGetLong'->ato) *)
                 -> newLocalObject->value[i][];
          for);
       #);    
     SetStatObjectRepAttr::
       (# target: @Integer;
          low,high: @Integer;
       do offset->range->(low,high);
          (if (low<=from) and (to<=high) then
              (for i:to-from+1 repeat
                   ((%getLongAt(((%getLongAt(@@o)))+offset))+24+4*(i+from-2),
                   (* Above line tos_converted from: ((((@@o->TOS'%adrGetLong')+offset)->TOS'%adrGetLong')+24+4*(i+from-2), *)
                   (%getLongAt(@@value[i].o)))
                   (* Above line tos_converted from: @@value[i].o->TOS'%adrGetLong') *)
                     ->assignRef;
              for);              
           else
              (failure,'localBetaObject.SetReferenceRepAttr: INDEX ERROR')
                ->stop;
          if);
       #);
     PatRefRepAttr::
       (# source: @Integer;
          atp: @addressToPattern;
       do to-from+1 -> value.new;
          (for i:to-from+1 repeat
               (dumper[],%getLongAt((%getLongAt(((%getLongAt(@@o)))+offset))+16+4*(i+from-2))->atp) 
               (* Above line tos_converted from: (dumper[],(((@@o->TOS'%adrGetLong')+offset)->TOS'%adrGetLong')+16+4*(i+from-2)->TOS'%adrGetLong'->atp)  *)
                 ->newLocalPattern->value[i][];
          for);
       #);
     SetPatRefRepAttr::
       (# target: @Integer;
          low,high: @Integer;
       do offset->range->(low,high);
          (if (low<=from) and (to<=high) then
              (for i:to-from+1 repeat
                   (%getLongAt(((%getLongAt(@@o))+offset)+16+4*(i+from-2)),
                   (* Above line tos_converted from: ((((@@o->TOS'%adrGetLong')+offset)->TOS'%adrGetLong')+16+4*(i+from-2), *)
                   (%getLongAt(@@value[i].p))
                   (* Above line tos_converted from: @@value[i].p->TOS'%adrGetLong' *)
                   )->assignRef;
              for);              
           else
              (failure,'localBetaObject.SetPatRefRepAttr: INDEX ERROR')
                ->stop;
          if);
       #);
     PatternAttr::
       (# atp: @addressToPattern;
       do (dumper[], %getLongAt(((%getLongAt(@@o)))+offset)->atp) 
          (* Above line tos_converted from: do (dumper[], (@@o->TOS'%adrGetLong')+offset->TOS'%adrGetLong'->atp) *)
            ->newLocalPattern->value[];
       #);
     SetPatternAttr::
       (# 
       do (((%getLongAt(@@o)))+offset,(%getLongAt(@@value.p)))
          (* Above line tos_converted from: do ((@@o->TOS'%adrGetLong')+offset,@@value.p->TOS'%adrGetLong') *)
            ->assignRef;
       #);
     (* new type, gram *)
     Int8Attr::
       (# 
       do %getByteAt(%getLongAt(@@o) + offset)-> value;
       #);
     SetInt8Attr:: 
       (#  
       do (value) %putByteAt (((%getLongAt(@@o)))+offset)
          (* Above line tos_converted from: do (value) %putByteAt ((@@o->TOS'%adrGetLong')+offset) *)
       #);
     Int8uAttr::
       (# 
       do %getByteAt(%getLongAt(@@o) + offset)-> value;
       #);
     SetInt8uAttr:: 
       (#  
       do (value) %putByteAt (((%getLongAt(@@o)))+offset)
          (* Above line tos_converted from: do (value) %putByteAt ((@@o->TOS'%adrGetLong')+offset) *)
       #);
     Int16Attr:: 
       (#  
       do
          %getSignedShortAt(%getLongAt(@@o) + offset)->value;
       #);
     SetInt16Attr:: 
       (#  
       do (value) %putShortAt (((%getLongAt(@@o)))+offset)
          (* Above line tos_converted from: do (value) %putShortAt ((@@o->TOS'%adrGetLong')+offset) *)
       #);
     Int16uAttr:: 
       (#  
       do %getShortAt(%getLongAt(@@o) + offset)->value;
       #);
     SetInt16uAttr:: 
       (#  
       do (value) %putShortAt (((%getLongAt(@@o)))+offset)
          (* Above line tos_converted from: do (value) %putShortAt ((@@o->TOS'%adrGetLong')+offset) *)
       #);
     
     Int32Attr::
       (# 
       do %getLongAt(%getLongAt(@@o) + offset) -> value;
       #);
     SetInt32Attr:: 
       (#  
       do (value) %putLongAt (((%getLongAt(@@o)))+offset)
          (* Above line tos_converted from: do (value) %putLongAt ((@@o->TOS'%adrGetLong')+offset) *)
       #);
     Int32uAttr::
       (# 
       do %getLongAt(%getLongAt(@@o) + offset) -> value;
       #);
     SetInt32uAttr:: 
       (#  
       do (value) %putLongAt (((%getLongAt(@@o)))+offset)
          (* Above line tos_converted from: do (value) %putLongAt ((@@o->TOS'%adrGetLong')+offset) *)
       #);
  #);

localBetaPattern: BetaPattern
  (# betaPatternType:: localBetaPattern;
     betaObjectType:: localBetaObject;
     
     p: ##Object;
     
     isNone:: (# do (p## = NONE) -> value #);
     
     init:: (# enter (p##) #);
     
     equal:: (# do (other.p## = p##) -> value #);
     
     origin::
       (# ato: @addressToObject;
       do (dumper[],%getLongAt(((%getLongAt(@@p)))+8)->ato)
          (* Above line tos_converted from: do (dumper[],(@@p->TOS'%adrGetLong')+8->TOS'%adrGetLong'->ato) *)
            ->newLocalObject->value[];
       #); 
     
     setOrigin::
       (# 
       do (((%getLongAt(@@p)))+8,((%getLongAt(@@value.o))))
          (* Above line tos_converted from: do ((@@p->TOS'%adrGetLong')+8,(@@value.o->TOS'%adrGetLong')) *)
            ->assignRef;
       #);
  #);

memcpy: external
  (# adrTarget: @Integer;
     adrSource: @Integer;
     byteCount: @Integer;
     out: @Integer;
  enter (adrTarget, adrSource, byteCount)
  exit out
  #);

addressToPattern:
  (* Given a memory address, exit the BETA pattern ref at that address. 
   * You must have a static instance of addressToPattern when using it.
   *)
  (# addr: @integer; 
     p: ##Object;
  enter addr
  do (@@p, addr) -> assignRef
  exit p##
  #);
