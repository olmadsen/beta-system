ORIGIN '../mpsinterface';
BODY 'private/psobjdumperbody';

INCLUDE '~beta/objectserver/v2.5/betaOID';
INCLUDE '~beta/sysutils/v1.6/RepetitionObject';

INCLUDE '~beta/objectserver/v2.5/objectserver';
INCLUDE '~beta/objectserver/v2.5/location';

INCLUDE '../objectdumper';
INCLUDE '../objectdb';
INCLUDE '../groupsinfo';

INCLUDE 'odOffsetTable';

--- mpsinterfacelib: attributes ---

getObjectServer: objectpool.get
  (# type::< objectserver; 
     init:: (# do (failure,'FATAL: No objectserver in objectpool')->stop #);
  #);
getPSObjectDB: getObjectDB (# type:: PSObjectDB #);

PSObjectDB: objectDB
  (# betaObjectType:: PSbetaObject;
     betaPatternType:: PSbetaPattern;
  #);

PSdumper: objectdumper
  (# betaObjectType:: PSbetaObject;
     betaPatternType:: PSbetaPattern;
     
     (* BetaObject instances used to represent NONE refs and betaenv refs: *)
     NONEobject: @PSbetaObject;
     NONEpattern: @PSbetaPattern;
     betaenvObject: @PSbetaObject;
     
     groupsInfo: ^groupsInfoTable;
     odOffsets: @odOffsetTable;
     objects: ^PSobjectDB;
     
     betaObjectObjectDescriptor:: (# do bo.getOD->value[] #);
     betaPatternObjectDescriptor:: (# do bp.odote.od[]->value[] #);
     
     PSObjectOwner: @objectOwner (# #);
     PSPatternOwner: @patternOwner (# #);
     
     init:: (# <<SLOT psdumperinitDopart: dopart>> #);
  #);

PSbetaPattern: BetaPattern
  (# betaPatternType:: PSbetaPattern;
     betaObjectType:: PSbetaObject;
     objectDumperType:: PSdumper;
     
     init:: (# enter (oriOID,oriOffset,odote[],loc[],group,proto) #);
     
     oriOID: @OIDtype; oriOffset: @Integer; 
     (* Object ID of origin part of pattern variable. *) 
     
     loc: ^location; 
     (* The location containing the object pointing to this pattern. *)
     
     odote: ^odOffsetTableElement;
     (* Description of the prototype corresponding to this pattern. *)
     
     group,proto: @Integer;
     
     isNone:: (# <<SLOT psbetapatternisnoneDopart: dopart>> #);
     equal:: (# <<SLOT psbetapatternequalDopart: dopart>> #);
     origin:: (# <<SLOT pdbetapatternoriginDopart: dopart>> #);
     setOrigin:: (# <<SLOT psbetapatternsetoriginDopart: dopart>> #);
     equalPred:
       (* Like equal, but comparing this PSbetaPattern with an
        * ObjectDescriptor and origin object directly. *)
       (# oodote: ^odOffsetTableElement;
          ooriOffset: @Integer;
          ooriOID: @OIDtype;
          value: @Boolean;
       enter (oodote[],ooriOffset,ooriOID)
       <<SLOT psbetapatternequalpredDopart: dopart>>
       exit value
       #);
  #);



PSbetaObject: betaObject
  (# betaPatternType:: PSbetaPattern;
     betaObjectType:: PSbetaObject;
     objectDumperType:: PSdumper;
     
     init:: (# enter (OID,offset,state[],odote[],loc[]) #);     
     descriptionType:: (#<<SLOT psbetaobjectdescriptiontypeDopart: dopart>>#);
     isComponentObject:: (# do false->value #);
     Equal:: (# <<SLOT psbetaobjectequalDopart: dopart>> #);
     IsNone:: (# <<SLOT psbetaobjectisnoneDopart: dopart>> #);
     CharAttr::
       (# tmp: @Integer <<SLOT psbetaobjectcharattrDopart: dopart>> #);
     SetCharAttr::
       (# tmp: @Integer <<SLOT psbetaobjectsetcharattrDopart: dopart>> #);
     BooleanAttr::
       (# tmp: @Integer <<SLOT psbetaobjectbooleanattrDopart: dopart>> #);
     setBooleanAttr::
       (# tmp: @Integer <<SLOT psbetaobjectsetbooleanattrDopart: dopart>> #);
     ShortIntAttr:: 
       (# tmp: @Integer <<SLOT psbetaobjectshortintattrDopart: dopart>> #);
     setShortIntAttr:: 
       (# tmp: @Integer <<SLOT psbetaobjectsetshortintattrDopart: dopart>> #);
     IntegerAttr:: (# <<SLOT psbetaobjectintegerattrDopart: dopart>> #);
     setIntegerAttr:: (# <<SLOT psbetaobjectsetintegerattrDopart: dopart>> #);
     RealAttr:: (# <<SLOT psbetaobjectrealattrDopart: dopart>> #);
     setRealAttr::
       (# tmp: @Integer <<SLOT psbetaobjectsetrealattrDopart: dopart>> #);
     ReferenceAttr::
       (# OID: @OIDtype; poffset: @Integer;
       <<SLOT psbetaobjectreferenceattrDopart: dopart>>
       #);
     setReferenceAttr:: 
       (# <<SLOT psbetaobjectsetreferenceattrDopart: dopart>> #);
     OriginAttr::
       (# OID: @OIDtype; poffset: @Integer;
       <<SLOT psbetaobjectoriginattrDopart: dopart>>
       #);
     setOriginAttr:: (# <<SLOT psbetaobjectsetoriginattrDopart: dopart>> #);
     PartObject::
       (# OID: @OIDtype; poffset: @Integer;
       <<SLOT psbetaobjectpartobjectDopart: dopart>>
       #);
     SetPartObject:: (# <<SLOT psbetaobjectsetpartobjectDopart: dopart>> #);
     Range:: (# <<SLOT psbetaobjectrangeDopart: dopart>> #);
     SetRange::
       (# reptype,oldlow,oldhigh: @Integer;
          nlongs,nextpos,tmp: @Integer;
       <<SLOT psbetaobjectsetrangeDopart: dopart>>
       #);
     CharRepAttr::
       (# tmp: @Integer <<SLOT psbetaobjectcharrepattrDopart: dopart>>
       #);
     SetCharRepAttr::
       (# tmp: @Integer;
          low,high: @Integer;
          oldnlongs,newnlongs: @Integer;
       <<SLOT psbetaobjectsetcharrepattrDopart: dopart>>
       #);
     BooleanRepAttr::
       (# tmp: @Integer <<SLOT psbetaobjectbooleanrepattrDopart: dopart>>
       #);
     SetBooleanRepAttr::
       (# tmp: @Integer;
          low,high: @Integer;
          oldnlongs,newnlongs: @Integer;
       <<SLOT psbetaobjectsetbooleanrepattrDopart: dopart>>
       #);
     ShortIntRepAttr::
       (# tmp: @Integer <<SLOT psbetaobjectshortintrepattrDopart: dopart>>
       #);
     SetShortIntRepAttr::
       (# tmp: @Integer;
          low,high: @Integer;
          oldnlongs,newnlongs: @Integer;
       <<SLOT psbetaobjectsetshortintrepattrDopart: dopart>>
       #);
     IntegerRepAttr::
       (# tmp: @Integer <<SLOT psbetaobjectintegerrepattrDopart: dopart>>
       #);
     SetIntegerRepAttr::
       (# tmp: @Integer;
          low,high: @Integer;
          oldnlongs,newnlongs: @Integer;
       <<SLOT psbetaobjectsetintegerrepattrDopart: dopart>>
       #);
     RealRepAttr::
       (# tmp: @Integer <<SLOT psbetaobjectrealrepattrDopart: dopart>>
       #);
     SetRealRepAttr::
       (# tmp: @Integer;
          low,high: @Integer;
          oldnlongs,newnlongs: @Integer;
       <<SLOT psbetaobjectsetrealrepattrDopart: dopart>>
       #);
     ReferenceRepAttr::
       (# OID: @OIDtype; poffset: @Integer; tmp: @Integer;
       <<SLOT psbetaobjectreferencerepattrDopart: dopart>>
       #);
     SetReferenceRepAttr::
       (# tmp: @Integer;
          low,high: @Integer;
          oldnlongs,newnlongs: @Integer;
       <<SLOT psbetaobjectsetreferencerepattrDopart: dopart>>
       #);
     PatRefRepAttr:: (# <<SLOT psbetaobjectpatrefrepattrDopart: dopart>> #);
     PatternAttr::
       (# tmp,group,proto: @Integer; OID: @OIDtype; poffset: @Integer; 
       <<SLOT psbetaobjectpatternattrDopart: dopart>>
       #);
     SetPatternAttr::
       (# tmp: @Integer <<SLOT psbetaobjectsetpatternattrDopart: dopart>> #);
     
     dirty: @Boolean; (* Set to TRUE by all Set* methods, and by 
                       * createPSobject. Should be set to FALSE if
                       * this psBetaObject is saved in a location. *)
     
     state: ^RepetitionObject;
     loc: ^location;
     odote: ^odOffsetTableElement;
     (* Description of the ObjectDescriptor of the object with id OID and 
      * offset 0. *)
     
     OID: @OIDtype; offset: @Integer; (* Persistent ID of this object. *)
     
     getOD:
       (* Returns the ObjectDescriptor of this object. *)
       (# od: ^BETACFL.ObjectDescriptor;
       <<SLOT psbetaobjectgetodDopart: dopart>>
       exit od[]
       #);
     
     findSimpleLong: @
       (* Returns the value of the long with offset attoffset inside this
        * PSbetaObject. *)
       (# attoffset: @Integer;
          value: @Integer;
          doit: @<<SLOT psbetaobjectfindsimplelong:descriptor>>;
       enter attoffset
       do doit
       exit value
       #);
     
     putSimpleLong: @
       (* Returns the value of the long with offset attoffset inside this
        * PSbetaObject. *)
       (# attoffset: @Integer;
          value: @Integer;
          doit: @<<SLOT psbetaobjectputsimplelong:descriptor>>;
       enter (attoffset,value)
       do doit   
       #);
     
     findReferenceStateInx: @
       (* Returns the index in state where information on the reference
        * attribute with offset attoffset begins. *)
       (# attoffset: @Integer;
          value: @Integer;
          tmp,low,high: @Integer;
          doit: @<<SLOT psbetaobjectfindreferencestateinx:descriptor>>;
       enter attoffset
       do doit
       exit value
       #);
     
     maskRefType: @ 
       (* Removes the tag bits from the offsets describing the kind 
        * of reference. *)
       (# offset: @Integer;
       enter offset
       exit offset %Band 0xFFFFFFFC
       #);
  #);

createPSobject:
  (* Creates a new PSbetaObject to be put into the location loc. *)
  (# od: ^BETACFL.ObjectDescriptor;
     loc: ^location;
     pd: ^PSdumper;
     bo: ^PSbetaObject;
  enter (od[],loc[],pd[])
  do <<SLOT psobjdumpercreatepsobjectBody: descriptor>> 
  exit bo[]
  #);

newPSObject:
  (* Returns the (already existing) PSbetaObject with id (OID,offset) *)
  (# OID: @OIDtype; offset: @Integer; pd: ^PSdumper;
     bo: ^PSbetaObject;
  enter (OID,offset,pd[])
  do <<SLOT psobjdumpernewpsobjectBody: descriptor>>  
  exit bo[]
  #);

newPSPattern:
  (* Returns a PSbetaPattern with prototype=(group,proto)
   * and origin object (oriOID,oriOffset). *)
  (# group,proto: @Integer;
     oriOID: @OIDtype;
     oriOffset: @Integer;
     pd: ^PSdumper;
     loc: ^location;
     bp: ^PSbetaPattern;
  enter (group,proto,oriOID,oriOffset,pd[],loc[])
  do <<SLOT psobjdumpernewpspatternBody: descriptor>> 
  exit bp[]
  #);
