ORIGIN '../runAlloc';
(* 
 * $Id: runAlloc_sgiBody.bet,v 1.2 1996-02-05 13:13:11 beta Exp $
 *
 * COPYRIGHT
 *       Copyright Mjolner Informatics, 1992-96
 *       All rights reserved.
 *)
--- include '~beta/sysutils/v1.4/objinterface'

--- lib:attributes ---

(* Interface to C routines: 
 * extern void AlloRR (struct Object* theObj, unsigned offset, int range, long *SP);
 * extern void AlloVR1(struct Object* theObj, unsigned offset, int range, long *SP);
 * extern void AlloVR2(struct Object* theObj, unsigned offset, int range, long *SP);
 * extern void AlloVR4(struct Object* theObj, unsigned offset, int range, long *SP);
 * extern void AlloVR8(struct Object* theObj, unsigned offset, int range, long *SP);
 * extern struct Structure *AlloS(struct Object *origin, struct ProtoType *proto, long *SP);
 * extern struct Item *AlloH(struct ProtoType *proto, long *SP);
 * extern long GetSP();
 *)

AlloRR: External
  (# theObj: @Integer;
     offset: @Integer;
     range: @Integer;
     SP: @integer;
  enter (theObj, offset, range, SP)
  #);

AlloVR1: External 
  (# theObj: @Integer;
     offset: @Integer;
     range: @Integer;
     SP: @Integer;
  enter (theObj, offset, range, SP)
  #);

AlloVR2: External 
  (# theObj: @Integer;
     offset: @Integer;
     range: @Integer;
     SP: @Integer;
  enter (theObj, offset, range, SP)
  #);

AlloVR4: External 
  (# theObj: @Integer;
     offset: @Integer;
     range: @Integer;
     SP: @Integer;
  enter (theObj, offset, range, SP)
  #);

AlloVR8: External 
  (# theObj: @Integer;
     offset: @Integer;
     range: @Integer;
     SP: @Integer;
  enter (theObj, offset, range, SP)
  #);

AlloS: External
  (# origin: @Integer;
     proto: @Integer;
     SP: @integer;
     theStruct: @Integer;
  enter (origin, proto, SP)
  exit theStruct
  #);

AlloH: External
  (# origin: @Integer;
     proto: @Integer;
     SP: @Integer;
     theObj: @Integer;
  enter (proto, SP)
  exit theObj
  #);

GetSP: external
  (# sp: @integer
  exit sp
  #);

(* The following is VERY inefficient - should be optimized.
 * Problem is that SP must be stacktop of *previous* frame.
 *)

--- allocByteRepBody:dopart ---
do (# SP: @integer;
   do GetSP -> SP;
      (# dummy: @integer; (* Make sure this pattern is not inlined *)
      do (@@ori -> tos'%adrGetLong', offset, high, SP) -> AlloVR1;
      #)
   #)
--- allocWordRepBody:dopart ---
do (# SP: @integer;
   do GetSP -> SP;
      (# dummy: @integer; (* Make sure this pattern is not inlined *)
      do (@@ori -> tos'%adrGetLong', offset, high, SP) -> AlloVR2;
      #)
   #)
--- allocValRepBody:dopart ---
do (# SP: @integer;
   do GetSP -> SP;
      (# dummy: @integer; (* Make sure this pattern is not inlined *)
      do (@@ori -> tos'%adrGetLong', offset, high, SP) -> AlloVR4;
      #)
   #)
--- allocDoubleRepBody:dopart ---
do (# SP: @integer;
   do GetSP -> SP;
      (# dummy: @integer; (* Make sure this pattern is not inlined *)
      do (@@ori -> tos'%adrGetLong', offset, high, SP) -> AlloVR8;
      #)
   #)
--- allocRefRepBody:dopart ---
do (# SP: @integer;
   do GetSP -> SP;
      (# dummy: @integer; (* Make sure this pattern is not inlined *)
      do (@@ori -> tos'%adrGetLong', offset, high, SP) -> AlloRR;
      #)
   #)

--- allocStructureBody:dopart ---
do (# SP: @integer;
   do GetSP -> SP;
      (# dummy: @integer; (* Make sure this pattern is not inlined *)
      do (@@iOrigin -> tos'%adrGetLong', iProto, SP) -> AlloS -> structAdr;
         ((@@obj -> tos'%adrGetLong') + offset, structAdr) -> AssignRef;
      #)
   #)

--- allocHeapBody:dopart ---
do (# SP: @integer;
   do GetSP -> SP;
      (# dummy: @integer; (* Make sure this pattern is not inlined *)
      do (proto, SP) -> AlloH -> objAdr;
         (@@o, objAdr) -> assignRef;
      #)
   #)
