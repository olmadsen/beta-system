origin '../mps'; 
include '../dependency';
(***********************************************************
 * test of machine slectors like MDBODY
 * the files bar.bet and bar.ast MUST be present,
 * similarly for all files mentioned in MDBODY of bar.bet;
 * and notice that if e.g. no bar.ast, bar.bet will NOT be parsed;
 * this should fixed.
 * usag:
 *         testbuild bar
 *)
---program:descriptor---
(# AST: @ astinterface;
   D: @AST.dependencyGraph;
   FileName: ^text;
do AST.astLevelInit;
   (*(ast.trace.onParse,true) -> ast.trace.set;
   (ast.trace.fragmentOpen,true) -> ast.trace.set;
    (ast.trace.topOpen,true) ->a st.trace.set;*)
   D.Init;
   D.xverboselevel.actions -> D.xverboselevel;
   true -> D.switch[17]; (* for seeing that corect MDBODY is selected *)
   (if noOfArguments > 1 then
       2 -> arguments -> Filename[]
    else 
       'Usage:  testselect bar' -> putline;
       stop
   if);
   (for i: 5 repeat (* will currently fail for ppcmac??*)
        (if i
         // 1 then
            'sun4s'->D.targetDirectory;
            'sun4s'->D.targetMachine;
         // 2 then
            'sgi'->D.targetDirectory;
            'sgi'->D.targetMachine;
         // 3 then
            'nti_ms'->D.targetDirectory;
            'nti_ms'->D.targetMachine;
         // 4 then
            'nti_gnu'->D.targetDirectory;
            'nti_gnu'->D.targetMachine;
         // 5 then
            'hpux9pa'->D.targetDirectory;
            'hpux9pa'->D.targetMachine;
         // 6 then
            'ppcmac'->D.targetDirectory;
            'ppcmac'->D.targetMachine;
        if);   
        (if i // 1 // 3 // 4 then
            '\nBuild for target: ' -> puttext; 
            D.targetDirectory[] -> putline;
            FileName[] -> D.scanExtent
            (# currentProperty::
                 (#
                 do 'Property: ' -> puttext; 
                    (if propKind
                     // D.makeProperty then 'make' -> puttext
                     // D.objfileProperty then 'objfile' -> puttext
                     // D.libfileProperty then 'libfile' -> puttext
                     // D.linkoptProperty then 'linkopt' -> puttext
                     // D.betarunProperty then 'betarun' -> puttext
                     // D.resourceProperty then 'resource' -> puttext
                     else 
                        propKind -> putint
                    if);
                    '\n   value: ' -> puttext; arg[] -> putline;
                 #);
               notExistingException::
	         (#
	         do 'No such fragment: ' -> puttext;
                    FullFN[] -> putline
                 #);
	       emptyFragmentException::
	         (# 
	         do 'Empty fragment: ' -> puttext;
                    fg.name -> putline
                 #);
               propertyException::
                 (#
                 do (if n >= 5 then 
                        true->continue; (* warning *) 
                     else
                        'Property exception: ' -> puttext; 
                        n -> putint; newline;
                        p[] -> putline; t[] -> putline; 
                    if)
                 #);
            #);
            
        if)
   for)
#)
