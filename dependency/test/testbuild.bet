origin '../mps'; 
include '../dependency';
(***********************************************************
 * test of build property;
 * the files foo.bet and foo.ast MUST be present,
 * and notice that if no foo.ast, foo.bet will NOT be parsed;
 * this should fixed.
 * usage 1
 *         testbuild foo
 * usage 2
 *         touch viggo.c
 *         touch viggo.o
 *         testbuild foo
 *    this will for sun4s select only the first build entry
 * 
 * For tracing set switch 20 as shown in comment below!
 *)
---program:descriptor---
(# AST: @ astinterface;
   D: @AST.dependencyGraph;
   FileName: ^text;
do AST.astLevelInit;
   (*(ast.trace.onParse,true)->ast.trace.set;
   (ast.trace.fragmentOpen,true)->ast.trace.set;
    (ast.trace.topOpen,true)->ast.trace.set;*)
   D.Init;
   D.xverboselevel.actions -> D.xverboselevel;
   (*true -> D.switch[20];*)
   (if noOfArguments > 1 then
       2 -> arguments -> Filename[]
    else 'testdep'->Filename[]
   if);
   (for i: 5 repeat (* will currently fail for ppcmac??*)
        (if i
         // 1 then
            'sun4s'->D.targetDirectory;
            'sun4s'->D.targetMachine;
         // 2 then
            'sgi'->D.targetDirectory;
            'sgi'->D.targetMachine;
         // 3 then
            'nti_ms'->D.targetDirectory;
            'nti_ms'->D.targetMachine;
         // 4 then
            'nti_gnu'->D.targetDirectory;
            'nti_gnu'->D.targetMachine;
         // 5 then
            'hpux9pa'->D.targetDirectory;
            'hpux9pa'->D.targetMachine;
         // 6 then
            'ppcmac'->D.targetDirectory;
            'ppcmac'->D.targetMachine;
        if);   
        
        '\nBuild for target: '->puttext; D.targetDirectory[]->putline;
        FileName[] -> D.scanExtent
        (#  BuildProperty::
             (#
             do 'Build: '->puttext; objfile[]->putLine;
                '   in: '->puttext; directory[]->putline;
                ' with: '-> puttext; command[] -> putline;
             #);
           propertyException::
             (#
             do (if n >= 5 then 
                    true->continue; (* warning *) 
                 else
                    'Property exception: ' -> puttext; 
                    n -> putint; newline;
                    p[] -> putline; t[] -> putline; 
                if)
             #);
        #);
   for)
   
#)
   
