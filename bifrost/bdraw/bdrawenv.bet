ORIGIN '~beta/bifrost/Bifrost';
INCLUDE '~beta/bifrost/Palette';
INCLUDE '~beta/guienv/fields';
INCLUDE '~beta/guienv/utils/colorDialog';
INCLUDE '~beta/bifrost/ColorNames';
INCLUDE '~beta/bifrost/PredefinedGO';
INCLUDE '~beta/bifrost/SelectionPicture';
INCLUDE '~beta/guienv/utils/streamwindow';
INCLUDE '~beta/guienv/utils/interfaceObjectAdds';

---- LIB: attributes -----

bdrawenv: guienv
  (# paper_A4: (# exit (595, 842) #);
     topwindow: @window
       (# 
          eventhandler::
            (# onAboutToClose::
                 (# 
                 do Quit -> okToClose;
                 #);
            #);
          menubarpattern: menubar
            (# menus: @<<SLOT BdrawMenus: descriptor>>;
               setdefaults: <<SLOT BdrawMenusDefaults: descriptor>>;
               open:: (# <<SLOT BdrawInitMenus: dopart>> #)
            #);
          menubartype:: menubarpattern;
                 
          <<SLOT bdrawattributes: attributes>>;
          
          PositionMainCanvas: <<SLOT PositionMainCanvas: descriptor>>;
          
          maincanvas: ^BifrostCanvas;
          
          mainscroll: @scroller
            (# 
               contentsType:: BifrostCanvas
                 (# eventhandler:: 
                      (# 
                         onOpen::< (# <<SLOT WindowOpen: dopart>> #);
                         onKeyDown::< (# do ch -> doKeyPressed #);
                         onmouseDown::< (# <<SLOT WindowButton: dopart>> #);
                      #);
                    open::
                      (# 
                      do paper_A4 ->size;
                      #);
                 #);
               Open:: 
                 (# 
                 do contents[] -> maincanvas[];
                    INNER;
                    true->bindright; 
                    true->bindleft; 
                    true->bindbottom; 
                    true->bindtop; 
                 #);
            #);
          Zoomed: @Boolean;
          actualPosition, actualSize: @Point;
          
          State: @
            (# s: @integer
            enter (# enter s <<SLOT NewState: dopart>> #)
            exit  (# <<SLOT State: dopart>> exit s #)
            #);
          
          clickpos: @point;
          mouseclickshiftmodified: @boolean;
          
          SelectMode:	   	(# exit  1 #);
          RectObject:	   	(# exit  2 #);
          EllipseObject:   	(# exit  3 #);
          UserDefObject:   	(# exit  4 #);
          PieObject:       	(# exit  5 #);
          TextObject:	   	(# exit  6 #);
          LineObject:	   	(# exit  7 #);
          MultiLineObject:      (# exit  8 #);
          StrokedRectObject:    (# exit  9 #);
          StrokedEllipseObject: (# exit 10 #);
          ArcObject:            (# exit 11 #);
          
          HoldObjectType: @boolean;
          
          mySolidColor: @SolidColor;
          myLineWidth: @Integer;
          myCapstyle: @capstyledesc;
          myJoinstyle: @joinstyledesc;
          myFontName: @Fontname;
          myStyle: @Style;
          mySize: @Integer;
          myUnderlineFlag: @Boolean;
          myFillRule: @integer;
          mySelectionPicture: SelectionPicture
            (# onOneGO::  (# <<SLOT SelectionBecomesSingle: dopart>> #);
               onTwoGOs:: (# <<SLOT SelectionBecomesMulti: dopart>> #);
               onEmpty::  (# <<SLOT SelectionBecomesEmpty: dopart>> #);
            #);
          
          theSelection: ^MySelectionPicture;
          clipboard: ^Picture;
          
          AddingToSelected: @Boolean;
          
          (********** CURSORS **********)
          
          savedcursor: @<<SLOT SavedCursor: descriptor>>;
          
          savecursor: @<<SLOT saveCursor: descriptor>>;
          restorecursor: @<<SLOT restoreCursor: descriptor>>;
          
          watchcursor: @<<SLOT WatchCursor: descriptor>>;
          ulcornercursor: @<<SLOT UlCornerCursor: descriptor>>;
          lrcornercursor: @<<SLOT LrCornerCursor: descriptor>>;
          leftptrcursor: @<<SLOT leftptrcursor: descriptor>>;
          lefthandcursor: @<<SLOT lefthandcursor: descriptor>>;
          crosscursor: @<<SLOT crosscursor: descriptor>>;
          beamcursor: @<<SLOT beamcursor: descriptor>>;
          
          InitCursors: @<<SLOT InitCursors: descriptor>>;
                    
          (********** PALETTE ***********)
          
          thepalette: @Palette<<SLOT PaletteBody: MainPart>>;
          
          (************ CANVASES *************)
          
          Logo: @BifrostCanvas
            (# open:: (# <<SLOT InitializeLogo: dopart>> #);
               eventhandler::
                 (# onOpen:: (# do <<SLOT Logo:descriptor>> #)
                 #);
            #);
          
          ColorCanvas: @BifrostCanvas
            (# theLine: @Line;
               eventhandler::
                 (# onOpen:: (# do theLine[] -> draw #)#);
               open:: (# do <<SLOT InitializeColorCanvas: descriptor>> #);
               update: <<SLOT UpdateColorCanvas: descriptor>>;
            #);
          
          Inform: @BifrostCanvas
            (# t: @text;
               label: @GraphicText;
               clear: <<SLOT ClearInfo:descriptor>>;
               open:: (# do <<SLOT InitInfo:descriptor>> #);
               eventhandler::
                 (# onOpen::< (# <<SLOT OpenInfo: dopart>> #);
                    onFrameChanged:: (# do <<SLOT InfoFrameChanged: descriptor>> #);
                 #);
            enter (# enter t do <<SLOT SetInfo:descriptor>> #)
            #);
          
          (**************************** DIALOGS ********************************)
          
          InitDialogs: @<<SLOT InitDialogs: descriptor>>;
          
          SetColorDialogColor: 
            (# r,g,b: @integer; 
            enter (r,g,b)
               <<SLOT SetColorDialogColor: dopart>>
            #);
          
          ReadInt:
            (# title (* Title bar of dialog *),
               prompt (* Prompt in dialog *): ^text;
               useit:< IntegerObject; (* Specialize to use integer read *)
            enter (prompt[], title[])
            <<SLOT ReadIntBody:dopart>>
            #);
          
          Note: 
            (# message: ^text
            enter message[]
               <<SLOT BdrawNote: dopart>>
            #);
          
          (**************************** ACTIONS ********************************)
	  
	  dirty: @BooleanObject
	    (# do setTitle #);
	  currentFileName: ^text;
	  setTitle: @
	    (#
	       t: ^text
	    enter t[]
	    do <<SLOT bdrawSetTitle: descriptor>>
            #);
          
          Extensions: @<<SLOT BdrawExtensions: descriptor>>;
          
          NewFile: <<SLOT NewFile:descriptor>>;
          
          OpenFile: <<SLOT OpenFile:descriptor>>;
          readFile: 
	    (# 
	       filename: ^text
	    enter fileName[]
	    do <<SLOT readFile:descriptor>>
            #);
	  
          SaveFile: (# cancelled: @boolean do <<SLOT SaveFile:descriptor>> exit cancelled #);
          SaveFileAs: (# cancelled: @boolean do <<SLOT SaveFileAs:descriptor>> exit cancelled #);
          ExportEPS: 
            (# overwrite: @Boolean;
               filename: ^text; 
            enter (fileName[],overwrite)
            do <<SLOT ExportEPS: descriptor>> 
            exit filename[] #);
          
          SaveLog: <<SLOT SaveLog: descriptor>>;
          
          Print: <<SLOT BdrawPrint: descriptor>>;
          
          Quit: 
            (# doit: @Boolean
            do <<SLOT Quit:descriptor>>;
            exit doit
            #);
          
          Undo: <<SLOT Undo:descriptor>>;
          
          Cut: <<SLOT Cut:descriptor>>;
          
          Copy: <<SLOT Copy:descriptor>>;
          
          Paste: <<SLOT Paste:descriptor>>;
          
          Duplicate: <<SLOT Duplicate:descriptor>>;
          
          SelectAll: <<SLOT SelectAll:descriptor>>;
          
          ShowClipboard: <<SLOT ShowClipboard:descriptor>>;
          
          ShowLogWindow: <<SLOT ShowLogWindow:descriptor>>;
          
          ShowColorWindow: <<SLOT ShowColorWindow:descriptor>>;
          
          ClearSelection: <<SLOT ClearSelection:descriptor>>;
          
          RaiseSelection: <<SLOT RaiseSelection:descriptor>>;
          
          LowerSelection: <<SLOT LowerSelection:descriptor>>;     
          
          Group: <<SLOT Group:descriptor>>;
          
          Ungroup: <<SLOT Ungroup:descriptor>>;
          
          Smooth: <<SLOT Smooth:descriptor>>;
          
          Unsmooth: <<SLOT Unsmooth:descriptor>>;
          
          ReverseOrientation: <<SLOT ReverseOrientation:descriptor>>;
          
          StrokeShape: <<SLOT StrokeShape:descriptor>>;
          
          CombineShape: <<SLOT BdrawCombineShape: descriptor>>;
          
          SetFillRule: (# r: @integer enter r do <<SLOT SetFillRule: descriptor>> #);
          
          Move: <<SLOT Move:descriptor>>;
          
          MoveTo: <<SLOT MoveTo:descriptor>>;
          
          Scale: <<SLOT Scale:descriptor>>;
          
          Rotate: <<SLOT Rotate:descriptor>>;
          
          FlipHor: <<SLOT FlipHor:descriptor>>;
          
          FlipVer: <<SLOT FlipVer:descriptor>>;
          
          Select: <<SLOT Select:descriptor>>;
          
          Zoom: <<SLOT Zoom:descriptor>>;
          
          RefreshAll: <<SLOT RefreshAll:descriptor>>;
          
          Iconify: ##object;
          
          ColorChanged: <<SLOT ColorChanged:descriptor>>;
          
          ColorInfo: <<SLOT ColorInfo:descriptor>>;
          
          LineAttChanged: <<SLOT LineAttChanged:descriptor>>;
          
          TextAttChanged: <<SLOT TextAttChanged: descriptor>>;
          
          doLeftButton: <<SLOT DoLeftButton:descriptor>>;
          
          doMiddleButton: <<SLOT DoMiddleButton:descriptor>>;
          
          doRightButton: <<SLOT DoRightButton:descriptor>>;
          
          doKeyPressed: (# ch:@char enter ch do <<SLOT DoKeyPressed:descriptor>> #);
          
          colorwin: @colordialog<<SLOT ColorWinBody: MainPart>>;
          
          clipwin: @window
            (#
               closeCalled:@boolean;
               eventhandler::
                 (# 
                    onAboutToClose::
                      (# 
                      do (if not(closeCalled->okToClose) then
                             this(Window).hide;
                         if);
                      #);
                 #);
               clipcanvas: @BifrostCanvas
                 (*<<SLOT ClipCanvasBody: MainPart>>*)
                 (# eventhandler::
                      (# onfatherframechanged::
                           (# 
                           do clipwin.size->size;
                           #);
                      #);
                 #);
               close::<
                 (#
                 do true->closeCalled; INNER close; false->closeCalled;
                 #);
               open::
                 (# do 
                    hide; clipcanvas.open; (300,300)->size; update
                 #);
               update: 
                 <<SLOT ClipWinUpdate: descriptor>>;
               private: @<<SLOT ClipWinPrivate: descriptor>>;
            #);
                   
          logwin: @streamwindow
            (#
               open::
                 (# 
                 do hide;
                    'Bdraw: Log Window' -> title;
                    'bdraw.log' -> logfilename[];
                    (550,350) -> size;
                    thestream[] -> THIS(guienv).WarnStream[];
                    true->hideOnCloseByUser;
                 #);
            #);
          
          open::
            (* topWindow *)
            (# 
            do logwin.open;
               <<SLOT OpenBdraw:descriptor>>;
               clipwin.open;
            #)
          
       #);
     
     variant: <<SLOT BdrawVariant: descriptor>>;
     version: <<SLOT BdrawVersion: descriptor>>;
     description: <<SLOT BdrawDescription: descriptor>>;
     
  do (* bdrawenv *)
     variant;
     description;
     newline;
     topwindow.open;
  #)
