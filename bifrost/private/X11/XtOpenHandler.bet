ORIGIN 'BifrostX11impl';
INCLUDE 'CanvasXtImpl';


--CanvasAttributes: attributes--
XtRemoveEventHandler: external
  (# w: @integer;
     eventMask: @integer;
     nonmaskable: @integer;
     callBack: @integer; (* difference from the one in xtlib *)
     data: @integer
  enter (w,eventMask,nonmaskable,callBack,data)
  do callC
  #);

-- CanvasOpenHandler: dopart --
do (if not opened then
       (* getwindowID *)
       WindowId -> xdrawable;
       (* Use SouthWest bit_gravity: matches our coordinatesystem *)
       SouthWestGravity -> cwatt.bitgravity;
       CWBitGravity -> cwmask;
       (xdisplay,
       xdrawable,
       cwmask,
       cwatt.address) -> XChangeWindowAttributes;
       
       (if borderwidth//0 then else
           true->SetAnswer; (* guienv hack *)
           (XtNborderWidth,borderwidth) -> SetIntegerResource;
           false->SetAnswer; (* guienv hack *)
       if);
       
       (if borderpixelset then
           (xdisplay, 
           xdrawable,
           borderpixel) -> XSetWindowBorder;
       if);
       (if borderpixmapset then
           (xdisplay, 
           xdrawable,
           borderpixmap) -> XSetWindowBorderPixmap;
       if);
       (if not defaultbackground then
           (if backgroundpixelset then
               (xdisplay, 
               xdrawable,
               backgroundpixel) -> XSetWindowBackGround;
               
               (xdisplay, 
               xdrawable,
               0, 0, 0, 0, 0) -> XClearArea;
           if);
           (if backgroundpixmapset then
               (xdisplay, 
               xdrawable,
               backgroundpixmap) -> XSetWindowBackGroundPixmap;
               
               (xdisplay, 
               xdrawable,
               0, 0, 0, 0, 0) -> XClearArea;
           if);
           (if not (backgroundpixmapset or backgroundpixelset) then
               (xdisplay, 
               xdrawable,
               THIS(guienv).private.whitepixelvalue) -> XSetWindowBackGround;
               (xdisplay, 
               xdrawable,
               0, 0, 0, 0, 0) -> XClearArea;
           if);
       if);
       &RectangleList[] -> damagedlist[];
       damagedlist.init;
       UpdateCoordinateSystem;
       true -> opened;
       theEventhandler.onOpen;
       (WidgetID, XExposureMask, 0, openHandlerAddr, 0)
         -> XtRemoveEventhandler;
    else
       'ERROR: Openhandler called again' -> putline;
   if);
 
