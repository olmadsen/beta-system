ORIGIN 'BifrostX11impl';
LIB_ITEM 'bifrost';
BODY 'X11fontsbody'
-- CanvasImmediateTextBody: descriptor --
(# (* Need to be in this fragmentgroup to see private attributes of 
    * font info
    *)
   width: @integer;
   xf: ^THIS(guienv).private.xfont;
   nam: @FontName;
   sty: @Style;
   siz: @Integer;
do
   (THIS(BifrostCanvas)[], theFontName, theStyle, theSize) 
     -> SetXFont
     -> (xf[], nam, sty, siz);
   
   (THIS(guienv).private.display, 
   implpart.xdrawable, 
   implpart.xgc,
   pos.x,
   pos.y,
   thestring,
   thestring.lgth) -> XDrawString;
   
   (if underline then
       (if xf.fixedwidth then 
           thestring.length*xf.width -> width;
        else
           (xf.fi, thestring.t, thestring.t.range) -> XTextWidth -> width;
       if);
       
       (THIS(guienv).private.display,
       implpart.xdrawable, 
       implpart.xgc,
       pos.x,
       pos.y + xf.upos,
       width,
       xf.uthick)
         -> XFillRectangle;
   if);
#)

-- SetXFontBody: descriptor --
(# 
   fname:@text;
   succes: @Boolean;
   
do siz -> theCanvas.ZoomDim -> siz;
   (nam,sty,siz) -> XCheckFontLoaded -> (xf[],nam,sty,siz);
   (* Set font in GC *)
   (THIS(guienv).private.display, theCanvas.implpart.xgc, xf.XfontId) -> XSetFont;
   
   (* Temporarily store the current font in privatePart of theCanvas *)
   xf[] -> theCanvas.implpart.currentxfont[];
#)
                                  
-- BifrostAttributes: attributes -- 

Fontname2text:
  (# 
     i: @integer;
     t: ^text;
  enter i
     <<SLOT Fontname2textDoPart: dopart>>
  exit t[]
  #);
Fontstyle2text:
  (# 
     i: @integer;
     t: ^text;
  enter i
     <<SLOT Fontstyle2textDoPart: dopart>>
  exit t[]
  #);

initBifrostFonts: 
  (# warntxt, d: @Text;
     df: ^THIS(guienv).private.xfont;
     smallest, sizerange, result: @integer;
     stylepattern: @THIS(guienv).private.fonts.stylearray;
     sizepattern:  @THIS(guienv).private.fonts.sizearray;
  <<SLOT initBifrostFonts: doPart>>
  exit result
  #);

XCheckFontLoaded:
  (# nam, orignam: @FontName;
     sty, origsty: @Style;
     siz, origsiz, tmpsiz, range: @integer;
     legalsiz, legalnam, legalsty, subst: @boolean;
     xf: ^THIS(guienv).private.xfont;
  enter (nam,sty,siz)
  do <<SLOT XCheckFontLoaded: descriptor>>
  exit (xf[], nam, sty, siz)
  #);


XLoadFontFromName:
  (# xf: ^THIS(guienv).private.xfont;
  enter xf[]
  <<SLOT XLoadFontFromName: dopart>>
  #);


InitXFontNames:
  (# revision: @Integer;
     t: @text;
  do
     THIS(guienv).private.display -> XVendorRelease -> revision;
     (*(if revision >= 1000 then revision div 1000 -> revision if);*)
     (if revision
      // 0 // 1 // 2 then (* X11, X11.1, X11.2 *)
         &InitX11r0;
      else (* X11.{3,4,...}: Using adobe fonts *)
         &InitX11r3
     if);
  #);


InitX11r0:
  (#
  do (NONE, 
     'X Font Initialization: X11 servers prior to X11R3 not supported',
     'Unsupported X version') -> AlertUser;
  #);

InitX11r3: <<SLOT InitX11r3: descriptor>>;

getfontsize:
  (# mypos,mysize,sizepos: @integer;
     t,temp: ^text;
  enter t[]
  <<SLOT getfontsize: doPart>>
  exit mysize
  #);

buildFontNames:
  (# 
     onlyAdobeFonts: (# exit false #);
     fname, textname,tmpname,realname,scalableName, warntxt: ^text;
     maxnames: (# exit 100 #);
     names, count, tmprange, size, totalfonts: @integer;
     xname: @cstring;
     nam: @FontName;
     sty: @Style;
     tryOblique: (# <<SLOT buildFontNamesTryOblique: doPart>> #);
     listFonts:  (# <<SLOT buildFontNamesListFonts: doPart>> #);
  enter (nam,sty,warntxt[],textname[])
  do <<SLOT buildFontNames: descriptor>>
  #);
