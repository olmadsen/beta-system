ORIGIN '../X11/CanvasX11impl';
BODY 'XtOpenHandler';


-- CanvasAttributes: attributes --
SetAnswer: external
  (* guienv hack *)
  (# value: @boolean;
  enter value
  #);

-- InitCanvasWindow: descriptor -- 
(# do xdisplay -> XtGetMultiClickTime -> implpart.dbltime #)

-- GetDamagedRectangles: descriptor --
(# 
do 
   implpart.DamagedList.scan
   (# 
   do (Current.x, Current.y)
        -> TM.inverseTransformPoint
        -> (Current.x, Current.y);
      Current -> damaged;
   #);
   &RectangleList[] -> implpart.DamagedList[];
   implpart.DamagedList.init;
#)

-- OpenCanvas: dopart --
do (* Prepend openHandler, so that it is called before first expose event *)
   (implpart.openhandler##, XExposureMask) 
     -> prependEventProcessor
     -> implpart.openHandlerAddr;
   INNER;
   defaultbackground -> implpart.defaultbackground;
   updatecoordinatesystem;
   
-- changecanvasborderwidth: dopart --
do value -> implpart.borderwidth;
   (if implpart.opened then
       true -> SetAnswer; (* guienv hack *)
       (XtNborderWidth,value) -> SetIntegerResource;
       false -> SetAnswer; (* guienv hack *)
   if)
   
-- canvasborderwidth: dopart --
do implpart.borderwidth -> value

-- XGrabPointer: descriptor --
(# 
do ((*THIS(interfaceobject).private.*)widgetID,
   1,
   mask,
   grabModeASync,
   grabModeAsync,
   0,
   0,
   currentTime) -> XtGrabPointer -> status;
#)

-- XUnGrabPointer: dopart --
do (THIS(interfaceobject).private.widgetID,currentTime) -> XtUnGrabPointer

-- GetNextEvent: descriptor --
(# do (display, implpart.xevent) -> XNextEvent #)

-- StartInteractionHandler: descriptor --
(# mask: @integer;
do (xdisplay,currentTime) -> XUnGrabPointer;
   (* (xdisplay, 0) -> XSync;
    * THIS(interfaceobject).private.widgetID -> XtBuildEventMask -> mask;
    * (mask, XPointerMotionMask) -> TOS'%or' -> mask;
    * (xdisplay,
    * implpart.xdrawable,
    * mask) -> XSelectInput;   
    * (xdisplay, 0) -> XSync;
    *)
#)

-- EndInteractionHandler: descriptor --
(# (* mask: @integer; *)
do (* THIS(interfaceobject).private.widgetID -> XtBuildEventMask -> mask;
    * (mask, XPointerMotionMask->TOS'%not') -> TOS'%and' -> mask;
    * (xdisplay, implpart.xdrawable, mask) -> XSelectInput;
    *)
#)

