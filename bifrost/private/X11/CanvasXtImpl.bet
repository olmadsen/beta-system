ORIGIN '../X11/CanvasX11impl';
LIB_ITEM 'bifrost';
BODY 'XtOpenHandler';


-- CanvasAttributes: attributes --
SetAnswer: external
  (* guienv hack *)
  (# value: @boolean;
  enter value
  #);

-- InitCanvasWindow: descriptor -- 
(# do THIS(guienv).private.display -> XtGetMultiClickTime -> implpart.dbltime #)

-- GetDamagedRectangles: descriptor --
(# 
do 
   implpart.DamagedList.scan
   (# 
   do current
        -> TM.inverseTransformRectangle
        -> damaged;
   #);
   &RectangleList[] -> implpart.DamagedList[];
   implpart.DamagedList.init;
#)

-- OpenCanvas: dopart --
do (* Initialize zoom factor *)
   (1.0,1.0) -> privatePart.currentZoomFactor;
   (* Prepend openHandler, so that it is called before first expose event *)
   (implpart.openhandler##, XExposureMask) 
     -> prependEventProcessor
     -> implpart.openHandlerAddr;
   INNER;
   defaultbackground -> implpart.defaultbackground;
   updatecoordinatesystem;
   
-- changecanvasborderwidth: dopart --
do value -> implpart.borderwidth;
   (if implpart.opened then
       true -> SetAnswer; (* guienv hack *)
       (XtNborderWidth,value) -> SetIntegerResource;
       false -> SetAnswer; (* guienv hack *)
   if)
   
-- canvasborderwidth: dopart --
do implpart.borderwidth -> value

-- XGrabPointer: descriptor --
(# 
do ((*THIS(interfaceobject).private.*)widgetID,
   0,
   mask,
   grabModeASync,
   grabModeAsync,
   0,
   0,
   currentTime) -> XtGrabPointer -> status;
#)

-- XUnGrabPointer: dopart --
do (THIS(interfaceobject).private.widgetID,currentTime) -> XtUnGrabPointer

-- GetNextEvent: descriptor --
(# do (display, implpart.xevent) -> XNextEvent #)

-- eventPending: doPart --
do (display -> XPending) > 0 -> value

-- StartInteractionHandler: descriptor --
(# mask: @integer;
do (THIS(guienv).private.display,currentTime) -> XUnGrabPointer;
   (* (THIS(guienv).private.display, 0) -> XSync;
    * THIS(interfaceobject).private.widgetID -> XtBuildEventMask -> mask;
    * (mask %Bor XPointerMotionMask) -> mask;
    * (THIS(guienv).private.display,
    * implpart.xdrawable,
    * mask) -> XSelectInput;   
    * (THIS(guienv).private.display, 0) -> XSync;
    *)
#)

-- EndInteractionHandler: descriptor --
(# (* mask: @integer; *)
do (* THIS(interfaceobject).private.widgetID -> XtBuildEventMask -> mask;
    * (mask %Band XPointerMotionMask) -> mask;
    * (THIS(guienv).private.display, implpart.xdrawable, mask) -> XSelectInput;
    *)
#)

