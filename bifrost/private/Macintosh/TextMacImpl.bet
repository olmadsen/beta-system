ORIGIN '../Predefined/TextImpl';

INCLUDE 'BifrostMacImpl';
INCLUDE '~beta/maclib/maclib';
INCLUDE '~beta/guienv/graphics';
INCLUDE '~beta/guienv/private/macintosh/guienv_macprivate';

-- lib: attributes --

guienvRectangle: rectangle (# #);

-- TextListGetWidthHeight: descriptor --
(# st: @textStyle;
do (if nam
    //times then 'times' -> st.name;
    //courier then 'courier' -> st.name;
    //helvetica then 'helvetica' -> st.name;
   if);
   siz -> st.size;
   theLines.size*st.lineHeight -> height;
   theLines.scan
   (# w: @integer;
   do current[] -> st.widthOfText -> w;
      (if w>width then w->width if);
   #);
#)

-- TextGetWidth: descriptor --
(# st: @textStyle;
do (if nam
    //times then 'times' -> st.name;
    //courier then 'courier' -> st.name;
    //helvetica then 'helvetica' -> st.name;
   if);
   siz -> st.size;
   T[] -> st.widthOfText -> value;
#)
-- TextGetHeight: descriptor --
(# st: @textStyle;
do (if nam
    //times then 'times' -> st.name;
    //courier then 'courier' -> st.name;
    //helvetica then 'helvetica' -> st.name;
   if);
   siz -> st.size;
   st.lineHeight -> value;
#)

-- TextLineHeight: dopart --
do (NONE,nam,sty,siz) -> TextGetHeight -> value;

-- TextMaxDescent: doPart --
do (# st: @textStyle;
   do (if nam
       //times then 'times' -> st.name;
       //courier then 'courier' -> st.name;
       //helvetica then 'helvetica' -> st.name;
      if);
      siz -> st.size;
      st.descent -> value;
   #)
   
-- TextMaxAscent: doPart --
do (# st: @textStyle;
   do (if nam
       //times then 'times' -> st.name;
       //courier then 'courier' -> st.name;
       //helvetica then 'helvetica' -> st.name;
      if);
      siz -> st.size;
      st.ascent -> value;
   #)

-- TextUnderlineDepth: descriptor --
(# do 'TextShapeUnderlineDepth' -> UnImplemented; #)

(* TextShapeInteractiveCreate *)
--TextShapeInteractiveCreateBodyPrivate: descriptor--
(# SetFontInfo:
     (# name, style, size: @integer;
        theCanvas: ^bifrostCanvas;
     enter (theCanvas[], name, style, size)
     do (if name
         //times then 'times' -> fontInfo.theTextStyle.name;
         //courier then 'courier' -> fontInfo.theTextStyle.name;
         //helvetica then 'helvetica' -> fontInfo.theTextStyle.name;
        if);
        size -> fontInfo.theTextStyle.size;
     exit (name, style, size)
     #); 
   fontInfo: @
     (# theTextStyle: @textStyle;
        
        letterwidth: integerValue
          (# ch: @char;
          enter ch
          do ch -> theTextStyle.widthOfChar -> value;
          #);
        maxdescent: integerValue
          (#
          do theTextStyle.descent -> value;
          #);
        upos: integerValue
          (#
          do theTextStyle.ascent -> value;
          #);
        uthick: integerValue
          (#
          do 1 -> value;
          #);
     #);
#)
--TextShapeInteractiveCreateBodyDrawInsertionMark: descriptor--
(#
do theCanvas.prepareInteraction;
   ((base_x,base_y-1 + icprivate.fontInfo.maxdescent), (base_x,uppery-1))
     -> theCanvas.immediateline;
   theCanvas.endInteraction;
   theCanvas[] -> thecanvas.privatepart.interactionpaint.setcanvaspaint;
#)
--TextShapeInteractiveCreateBodyLetterWidth: dopart--
do ch -> icprivate.fontInfo.letterwidth
--TextShapeInteractiveCreateBodyDrawCh: descriptor--
(#
do theCanvas.graphics
   (# t: @text;
      r: @guienvRectangle;
   do ((base_X, uppery - 1), (base_X + ChWidth+1, uppery + size + 1)) -> r;
      (r[] -> makeMacRect).r[] -> EraseRect;
      (base_X, base_Y) -> moveTo;
      icprivate.fontinfo.theTextStyle[] -> style;
      t.clear;
      theCh -> t.put;
      t[] -> drawText;
   #);
#)
--TextShapeInteractiveCreateBodyClearPrevCh: descriptor--
(#
do theCanvas.graphics
   (# r: @guienvRectangle;
   do ((base_X, uppery - 1), (base_X + prevChWidth+1, uppery + size  + 1)) -> r;
      (r[] -> makeMacRect).r[] -> EraseRect;
   #);
#)
--TextShapeInteractiveCreateBodySetFontAndLine: descriptor--
(# 
do (theCanvas[], textprivate.theFontName, textprivate.theStyle, textprivate.theSize)
     -> icprivate.SetFontInfo
     -> (textprivate.theFontName,textprivate.theStyle,textprivate.theSize);
#)
--TextShapeInteractiveCreateBodyFontAscent: dopart--
do 
--TextShapeInteractiveCreateBodyCleanUp: descriptor--
(# 
do
#)

-- TextShapeHiliteOutlineBody: descriptor --
(# pos: @point;
   itext: @theCanvas.immediateText;
   lineheight: @integer;
   
do 
   (if TM[] // NONE then
       textprivate.position -> pos;
    else
       textprivate.position -> TM.transformpoint -> pos;
   if);
   pos -> Privatepart.Go2CanvasTM.m.transformPoint
     -> theCanvas.CanvasToDevice -> pos;
   (textprivate.theFontName, textprivate.theStyle, textprivate.theSize)
     -> TextLineHeight
     -> lineheight;
   
   textprivate.thestrings.scan
   (# 
   do (pos, 
      textprivate.theFontName,
      textprivate.theStyle,
      textprivate.theSize,
      underline,
      current[]) -> itext;
      pos.y+lineheight -> pos.y (* device coords *);
   #);
   
  
#)
