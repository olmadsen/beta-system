<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>

<HEAD>
<TITLE>BETA Runtime System Overview</TITLE>
<LINK REL="stylesheet" HREF="../../style/miadoc.css" TYPE="text/css">
</HEAD>

<BODY>
<H1>BETA Runtime System Overview</H1>

The following is a short description of the file organization
of the BETA runtime system, and instructions on how to check out and
build it for various platforms. 
<P>


<OL>
<LI><A HREF="#structure">File structure</A>
<LI><A HREF="#gen_repository">Organization of the <CODE>GEN</CODE> repository</A>
<LI><A HREF="#creating">Creating a betarun version</A>
<LI><A HREF="#generator">Making the runtime generator</A>
<UL>
<LI><A HREF="#make_linux_gen">linux</A>
<LI><A HREF="#make_nti_gen">nti</A>
</UL>

<LI><A HREF="#make">Making betarun for different platforms</A>
<LI><A HREF="#crypt">Encrypting betarun for Personal Edition</A>
<LI><A HREF="#decrypt">Decrypting betarun for Personal Edition</A>
</OL>

For other references, see
<UL>
<LI><A HREF="beta_collector.pdf">Overview of BETA garbage collector (chapter 5 of Jacob's and Steffen's thesis)</A>
<LI><CODE>$BETALIB/doc/*</CODE>
</UL>


<H2><A NAME="structure">File structure</A></H2>

<CODE>betarun</CODE> contains the following subdirectories:

<H3><CODE>GEN</CODE></H3>

The <CODE>GEN</CODE> directory contains the runtime generator, rungen,
used for INTEL platforms..

<H3><CODE>doc</CODE></H3>

The <CODE>doc</CODE> directory contains a few documentation files
regarding the runtime system.

<H3><CODE>sun4s, linux, sgi, hpux9pa, nti_gnu, nti_ms, x86sol, macosx</CODE></H3>

These directories contain build files for Betarun.  All files in
these directories are generated and all can be regenerated so you
can just delete these files at any time.

<H3>Subdirectories</H3>

<H4>C</H4>
This contains common files in C language. Some notable ones:
<PRE>
function.h	contains C-prototypes for all functions in all
		files in betarun. Good to get an overview.
beta.h		Main header file included by all .c files
		in betarun.
registers.h	Fixed register mappings for different platforms.
constant.h	Definition of constant values like special prototype 
		headers.
data.gen	Definition of all global variables in betarun.
		This file is preprocessed into data.c and data.h.
heap.h		Definition of the heaps for different platforms.
object.h	Structure of all BETA object types.
macro.h		definition of most C macros used in betarun.
betaerror.h	Numbers for all BETA errors.

sparcdep.h	SPARC specific stuff
snakedep.h	HPPA (snake) specific stuff
</PRE>

<H4>GC</H4>
C files mostly related to garbage collection.

<H4>P</H4>
C files related to persistence.

<H4>RUN</H4>
Implementation files for the runtime routines used on INTEL.
Are written in the RUN language and processed by the rungen
generator described below.

<H4>CRUN</H4>
Implementation files for the runtime routines used on sparc and hppa.
They are in C.
The file <CODE>crun.h</CODE> contains various definitions used
by all C files in this directory.
Many routines are declared using macros like <CODE>ParamOriginProto</CODE>; 
these are machine dependent parameter-specifications derfined in
<CODE>sparcdep.h</CODE>, <CODE>snakedep.h</CODE>, and
<CODE>crtsdep.h</CODE>.

<H4>NEWRUN</H4>
Implementation files for the runtime routines used on sgi and ppcmac.
They are called from BETA using a pure C calling convention.
The file <CODE>crun.h</CODE> contains various definitions used
by all C files in this directory.

<H2><A NAME="gen_repository">Organization of the <CODE>GEN</CODE> directory</A></H2>

The <CODE>GEN</CODE> directory is organized as follows:

<PRE>
GENERATOR	machine independent parts of the generator
GRAMMAR		grammar for the RUN language
linux		machine specific parts for linux
nti		machine specific parts for Windows NT/95
</PRE>


<H2><A NAME="creating">Creating a betarun version</A></H2>

Creating a betarun version consists of the following two steps:

<OL>
<LI><A HREF="#generator">Making the runtime generator</A> (only on intel)
<LI><A HREF="#make">Making betarun for different platforms</A>
</OL>


<H2><A NAME="generator">Making the runtime generator</A></H2>

This is only relevant for <CODE>linux</CODE>, <CODE>nti</CODE> and
<CODE>x86sol</CODE>.  <b>This is done automatically by
<CODE>mbs_boottrack</CODE> and you shouldn't have to do
it manually again after that.</b>

<H3>Making the parser</H3>

<PRE>
cd $BETALIB/betarun/GEN/GRAMMAR
dogram runtime
(or use bootdogram)
</PRE>

<A NAME="make_linux_gen"><H3>Making the <CODE>linux</CODE> generator</H3></A>
<PRE>
cd $BETALIB/betarun/GEN/linux
beta -qwd -o linux/gen gen
(or use bootbeta)
</PRE>

<A NAME="make_nti_gen"><H3>Making the <CODE>nti</CODE> generator</H3></A>
<PRE>
cd \beta\betarun\GEN\nti
beta -qwd gen
(or use bootbeta)
</PRE>


<H2><A NAME="make">Making betarun for different platforms</A></H2>

This is described in <a href=mbs_make.html>a separate document</a> now.

<H2><A name="crypt">Encrypting betarun for Personal Edition</A></H2>

<p>
<b>This information is now obsolete, as we don't do this any more</b>

<p>

Selve krypteringen håndteres af pakkescriptene.  Den hemmelige nøgle,
der bruges til at enkryptere, står i toppen af
~beta/export/misc/system-pe.sh. (PRODKEY) Den bør skiftes ved hvert release.
<BR>

<H2><A name="decrypt">Decrypting betarun for Personal Edition</A></H2>

Dekryptering: (PC som eksempel, unix helt analogt.  Mac har et smart script)
Lad være med at give koden nedenfor til nogen;  Den er til internt testbrug.
Den er gyldig for r4.1, som er krypteret med PRODKEY=17439 og seriel=0
<PRE>
cd \beta\r4.1\betarun\nti\ms
decrypt 630-8DD-4BEA betarun_lib.crypt betarun.lib
decrypt 630-8DD-4BEA betarun_v_lib.crypt betarun_v.lib
</PRE>
<BR>
For at beregne en nøgle udføres flg: (ret sti mht. machinetype) Der
bør anvendes et nyt &lt;serial&gt; for hver bruger, der gives en kode,
og den udleverede kode samt &lt;serial&gt; bør gemmes.  Hvis der
pludselig skulle dukke en kode op et sted, kan vi se hvor den kommer
fra.
<PRE>
To calc key:
       /users/beta/r4.2/crypt/sun4s/encrypt &lt;prodkey&gt; &lt;serial&gt;
</PRE>
<BR>
Her er de hidtil brugte <A HREF="releases.html#ProdKeys">ProdKeys</A>.

</BODY>
</HTML>
