<HTML>
<link rel="stylesheet" href="../../style/miadoc.css" type="text/css">
<TITLE>Establishing an MBS Development System</TITLE>
<BODY>

<h1>Establishing an MBS Development System</h1>

<b>If you are using Windows, <a href=win32-devsystem.html>set up your Windows development environment first</a>.</b>

<h2>Required software</h2>

For Unix, you need perl, GNU make, a C compiler and linker and cvs on
your machine.

<p>
For Windows you don't need GNU make (we provide one), but see
<a href="win32-devsystem.html">win32-devsystem.html</a> 
about the other things you need.

<p>You need access to the repository on alex.daimi.au.dk, either
via NFS or ssh:

<a name="chooseaccess"></a>
<p><b>NFS</b>
<p>If you are working on a Unix machine within Daimi then you can access
the repository via NFS.  The CVS root is /users/beta/.CVSHOME
<p>You must be a member of the beta group.
<p><b>ssh</b>
<p>If you are working on another machine you need to have ssh installed.
The CVS root is yourusername@alex.daimi.au.dk:/users/beta/.CVSHOME
<a name="sshhelp"></a>
<p>More information on ssh and cvs is in the <a href="cvs.html">cvs guide</a>
and the <a href="../sysadm/ssh.html">ssh guide</a> behind these links.

<h2>Directory structure</h2>

The normal directory structure is rooted in your home directory
and looks like this:

<p>
beta<br>
beta/bin<br>
beta/bin/admin<br>
beta/r5.3<br>
beta/r5.3/bin<br>
beta/r5.3/bin/admin<br>
beta/r5.4<br>
beta/r5.4/bin<br>
etc.

<p>
Of these, beta/bin and beta/bin/admin (the so-called <b>wrapper</b>
directories) are the <i>only ones</i> that should be in your path.

<h2>Environment variables</h2>
<a name="BETALIB"></a>
<p><b>BETALIB</b>
<p>set this variable to the full path of the directory that contains (or
will contain) your BETA development track.  Eg. /users/yourusername/beta/r5.3
<p><a name="betawrappers"></a><b>PATH</b>
<p>set this so it references the directories that contain (or will contain)
your wrapper scripts.  Eg. /users/yourusername/beta/bin and
/users/yourusername/beta/bin/admin.  If you have NFS access to the beta
account in Daimi then you can set your path to access /users/beta/bin
and /users/beta/bin/admin.  That way you wouldn't have to set up your
own wrapper directories, but could use those the beta user has.
<p>Note that if you are within Daimi you must ensure that the wrapper
directories are before /usr/local/bin and /usr/local/lib/beta in your
PATH, otherwise you will get ugly and confusing errors.
<p><b>CVS_RSH</b>
<p>Set this to 'ssh' if you are using ssh to access the
CVS repository (see <a href="#chooseaccess">above</a>,
the <a href=cvs.html>cvs guide</a> here and the <a
href="../sysadm/ssh.html">ssh guide</a> nearby for more details.
If you are using putty on Windows, then you need to set this
variable to 'plink'.
<p><b>GNUMAKE</b>
<p>You only need to set this if you get an error saying the build system
cannot find GNU make.  This should not happen within Daimi.
<p><b>HOME</b>
<p>Most versions of ssh need this variable to be set to a directory
where it can store config info.  For Unix systems this variable is already
set up, and you don't have to do anything.
<p><b>MIASDK</b>
<p>On Windows you need to set this to either 'gnu' or 'ms' depending
on whether you use the tools from GNU (Mingw32) or Microsoft (Visual
Studio) for linking and C code.

<H3>Setting the environment variables</H3>

On UNIX you typically set these variables in your <CODE>~/.cshrc</CODE>
file, whereas you can do it in your <CODE>.bash_login</CODE> file
under cygwin.
For <CODE>nti_gnu</CODE>, you can do it in a separate BAT file or in 
<CODE>autoexec.bat</CODE> inspired by the following:
<PRE class=beta>
@echo off
echo Setting up for nti_gnu usage:
echo Setting GNU
set GNU=C:\GNU-utils\gcc-2.95.2
echo Setting BETALIB
set BETALIB=C:\beta\r5.3
echo Setting PATH
set PATH=%GNU%\BIN;%PATH%
set PATH=C:\beta\bin;C:\beta\bin\admin;%PATH%
set PATH=%PATH%;C\Perl\bin
echo Setting MIASDK
set MIASDK=gnu
echo Changing directory
cd %BETALIB%
echo Done.
</PRE>

<h2>Establishing the wrapper directories</h2>

The commands in the wrapper directories have the same names as real
BETA programs.  They use the BETALIB variable to call the real
programs.  Their main use is that you don't have to change your
PATH when you switch BETA versions.

<p>
<h3>If you already have the wrapper directories in your path</h3>

then you
need to update them to the latest version.  Do this with the Unix commands

<p>
cd beta/bin<br>
rm -rf admin<br>
cvs update -d<br>
./make_wrappers

<p>
or by removing the admin subdir, then using the Windows commands

<p>
cd beta/bin<br>
cvs update -d

<h3>If you don't already have the wrapper directories</h3>
and you are not
<a href="#betawrappers">using beta's wrapper directories
via NFS</a> then you need to get a copy of the wrapper directories on your
system.  Assuming you are going to place then in your beta directory
you do that on Unix with the commands:

<p>
cvs -d yourusername@alex.daimi.au.dk:/users/beta/.CVSHOME checkout -d bin bin_unixwrapper<br>
cd bin<br>
./make_wrappers

<p>
or on Windows with the command:

<p>
cvs -d yourusername@alex.daimi.au.dk:/users/beta/.CVSHOME checkout -d bin bin_ntiwrapper 

<p>
You must make sure that these directories are on your <a href="#betawrappers">PATH</a>.

<a name="mbs_newtrack"></a>
<h2>Establishing a BETA development track</h2>

When you have the wrapper directories in place, you can make a new BETA
development track with the commands:

<p>
cd beta<br>
mbs_newtrack r5.4

<p>
The mbs_newtrack command will check a new BETA track out of CVS in the
current directory, calling the new directory r5.4, and will then boot the
new track, compiling and installing all the tools you need with
the command <a href="#mbs_boottrack">mbs_boottrack</a>.

<p>
mbs_newtrack has some options:

<p>-d cvsroot
<p>You can specify with -d a CVS root, from which to fetch the BETA
track.  If you don't specify a CVS root then mbs_newtrack will guess,
and this should work fine within Daimi or Mjølner.  Otherwise you can
specify it here, and it would typically be
yourusername@alex.daimi.au.dk:/users/beta/.CVSHOME
<p>-r tag
<p>You can specify with -r a CVS branch tag.  The resulting BETA
track will be on a development branch.  A typical tag might be
called r5_3_2b_correction_branch.  <i>You can't use this for versions
before r5.3, since they were organised in a different way</i>
You can see a list of tags in <a href="releases.html">releases.html</a>.


<a name="mbs_boottrack"></a>
<h2>Booting a BETA development track</h2>

When you run <a href="#mbs_newtrack">mbs_newtrack</a> it will automatically
boot the track with the mbs_boottrack command, but you can also run it
manually if your track is in a mess (eg. no compiler) and you need to
rebuild it.

<p>
mbs_bootrack uses the files in $BETALIB/boot to compile the entire
track from scratch.  It can take up to 2 hours on an old machine.

<h3>Metagrammar boot</h3>

mbs_boottrack first compiles the grammar files needed for the metagrammar
and for the beta grammar.  These files are needed for the BETA compiler
to run.

<p>
You can skip this stage with the <b>-g</b> option.

<h3>Build betarun</h3>

mbs_bootrack then compiles the runtime system, betarun, with the command
<a href="mbs_make.html">mbs_make</a>.  If you are running on a system that
needs the rungen compiler (Intel-based systems) then it first compiles
the rungen compiler with the beta compiler and runtime system in
$BETALIB/boot.

<p>
You can skip this stage with the <b>-r</b> option.

<h3>Build a new compiler</h3>

mbs_boottrack then compiles the beta compiler, using the beta compiler
in $BETALIB/boot.  At this stage the prettyprinter grammars are not
compiled to a usable form, and this means the compiler cannot print
out warnings and syntax errors (instead it will terminate with an
error about missing prettyprinter grammar files).  For this reason the
boot compiler is run with warnings switched off.

<p>If someone has committed a file in the compiler that cannot compile
then mbs_boottrack will stop here.  If the error can be reproduced in
already booted tracks, then it should be corrected and committed there.
Otherwise you may have to copy the prettyprinter files from
$BETALIB/grammars/beta from another track into this track so that you
can get sensible error messages from the beta compiler.

<h3>Build more grammar tools</h3>

mbs_boottrack will now build the grammar tools necessary to produce
the necessary prettyprinter files.  Then mbs_boottrack builds the
prettyprinter files.

<h3>Delete everything and compile with new compiler</h3>

mbs_boottrack now deletes almost all compiler-generated files, and
recompiles the whole beta_system with the new compiler.  It uses
mbs_compiletools and mbs_compile for this.

<h2>You're done</h2>

Now your new BETA track should work.  Set the <a href="#BETALIB">
BETALIB</a> variable if you didn't already do this, and get
hacking!

</body>
</html>
