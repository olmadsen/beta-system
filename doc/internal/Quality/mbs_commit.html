<HTML>
<link rel="stylesheet" href="../../style/miadoc.css" type="text/css">
<TITLE>Committing in Betarun and the compiler with mbs_commit</TITLE>
<BODY>

<h1>Committing in Betarun and the compiler with mbs_commit</h1>

<ul>
<li><a href="#intro">Introduction</a>
<li><a href="#invocation">Invocation</a>
<li><a href="#changes">Use of CHANGES.txt</a>
<li><a href="#oldversion">Going back to an old version</a>
</ul>

<h2><a name="intro"></a>Introduction</h2>

This document describes the thinking behind mbs_commit, the utility
for committing Betarun, and the compiler.  You can commit using 
the normal 'cvs commit' command instead if you follow some rules:

<ul>
<li>You must supply a log message saying what you have changed
<li>You must update the version number in verison.c (Betarun) or
compilerrcmversion.bet (compiler) and commit this file together
with those files you have altered.
<li>You must include a line saying 'Betarun verison number: 123'
or 'Compiler version number: 123' in your commit message
<li>You may not commit anonymously, use your real name, if necessary
in the commit message with a line saying 'Developer: yourname'.
</ul>

<p>mbs_compile automatically makes sure all these conditions are
met.  It deletes version.c/compilerrcmversion.bet, fetches the
latest version, increments the number, invokes an editor and
generates the cvs_commit command.

<h2><a name="invocation"></a>Invocation</h2>

mbs_commit passes most of its parameters to the 'cvs commit' command
and can in general be used just like the cvs commit command.  It
does however have some options of its own.  If you want to pass
options to cvs before the cvs command, then use '--' to mark the
end of the mbs_commit options and the start of the cvs options.

<p>Usage: mbs_commit [options] [file [file ...]]

<p><b>Options:</b>

<p><b>-</b>
<p>Use this option to not increment the version number in
version.c/compilerrcmversion.bet.  This can be useful in
combination with the -k option.  You must make sure that
there have been changes in the version file, since otherwise
it will not be committed with the other files.

<p><b>+</b>
<p>Use this option to add a '+' to the version number instead
of incrementing it.  This is intended for very small changes
(spelling errors, changes to the build procedure, syntax errors)
which do not change the actual code generated in Betarun/the
compiler.  The intention is that versions that only differ by 
the number of +'s in their version number are bug-for-bug
compatible.

<p><b>-k</b>
<p>This option indicates that the version file should not be
deleted and refetched from the CVS server.  You need this option
if the whole point of the commit is to commit a change in the
version file, eg. if you have accidentally committed a version
with the wrong line termination, or a syntax error has been
caused by a log message with a 'close comment' sequence in it.

<p><b>-d</b>
<p>Normally, mbs_commit will run diff on your copy of the compiler
or Betarun tree, and put the results in a comment in the message
editor.  This is to remind you of what you have changed.  If you
are too impatient to wait for the diff, or you know exactly what
you have changed then you can skip that step with this option.

<p><b>-n</b>
<p>This option is for a dry run.  It means that we just pretend to
commit, but don't actually do it.

<p><b>-u</b>
<p>This option can be used to set your user name.  Use it to avoid
having to type your user name in all the time when committing as the
beta user.  Better still, make your own development track instead
of committing as beta.

<p><b>-m</b>
<p>This option can be used to specify the commit message.  Probably
won't work on Windows due to quoting breakage in the shell.  Use it
to avoid having to wait for an editor to start up.

<h2><a name=changes></a>Use of the file CHANGES.txt</h2>

If you find it convenient, you can use the file $BETALIB/betarun/CHANGES.txt 
or $BETALIB/compiler/CHANGES.txt to record your changes as you make them.
If mbs_commit finds such a file, it will use it as the default commit
message.  After a successful commit, the CHANGES.txt file will be deleted
and reestablished a an empty file.

<p>
All commit messages will be found in the version file (version.c or
compilerrcmversion.c) so that this file gives a global history of
changes in the betarun and compiler directories.

<h2><a name=oldversion></a>Going back to an old version</h2>

If you want to go back to an old version of Betarun or the compiler
you can do this by looking in the version.c/compilerrcmversion.bet
file and finding in the log messages the exact time of the version you
want to go back to.  Then use the following commands:

<p>
<pre>cd $BETALIB
mv betarun betarun-normal
cvs checkout -D '01/14/2002 14:31' -d betarun beta_project/betarun
</pre>

<p>
Note:

<ul>
<li>The date is in MM/DD/YYYY format!
<li>This is called checking a directory out with a sticky date
<li>The date in the version file (and the cvs log info) is in <i>UTC</i>.
    Add 1 hour for local Danish time in the winter.  Add 2 hours for local
    Danish time in the summer.
<li>When you checkout a version you have to use <i>local</i> time.
<li>You can give the -D option to mbs_newtrack to get a whole track from
    a specific date
<li>A version checked out in this way will not be updated with a cvs update
    command, and you can't commit in it.
<li>You can use 'cvs status' on a file to find out if it is checked out with
    a sticky date.  The sticky date is displayed in UTC.
</ul>

<p>
For example, if a change was committed with the line in betarun/version.c:

<p>
<pre> * Revision 1.102  2002/03/27 14:16:08  corry</pre>
 
<p>
Then to get that version you would type

<p>
<pre>cvs checkout -D '03/27/2002 15:17' -d betarun beta_project/betarun</pre>

<p>
i.e. one minute later, remembering that March 27 is in the winter.

<p>
The same works in an anlogous way for the compiler or the entire
BETA system.

<p>
If you want to be able to commit then you need to make a branch tag
at that point and continue development along the branch tag.  In this
case you check out a directory with a sticky date as described above,
then make a sticky branch at that point.  After that it's simplest to
delete the directory and check it out again as a branch.

<p>
<pre>cd $BETALIB
mv betarun betarun-normal
cvs checkout -D '01/14/2002 14:31' -d betarun beta_project/betarun
cd betarun
cvs tag -b betarun-124
cd ..
rm -rf betarun
cvs checkout -r betarun-124 -d betarun beta_project/betarun

<p>
Now you can develop along the betarun-124 branch.  The first thing
you should do is to edit version.c or compilercmversion.bet and edit
the <i>major</i> version number to reflect that you are on a branch
of some sort.  Otherwise you will soon have two versions called 5.3(125)
with the attendant problems telling them apart.  <b>The minor version
numbers in version.c and compilerrcmversion.bet are not automatically
unique between branches.</b>  You will need to commit the version file
using 'mbs_commit -k -'.

</BODY>
</HTML>
