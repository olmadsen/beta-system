<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                      "http://www.w3.org/TR/REC-html40/loose.dtd"
>
<HTML>
<HEAD>
<META http-equiv="Content-Type" CONTENT="text/html; CHARSET=ISO-8859-1">
<TITLE> Moving Rails</TITLE>
<LINK REL=stylesheet HREF=../style/miadoc.css TYPE=text/css>

</HEAD>
<BODY>


<A NAME=HEADING9></A>


<P><A HREF=palette.html><IMG ALIGN=BOTTOM SRC="../images/next.gif" ALT=Next BORDER=0></A>
<A HREF=make_rail.html><IMG ALIGN=BOTTOM SRC="../images/prev.gif" ALT=Previous BORDER=0></A>

<A HREF=../index.html><IMG ALIGN=BOTTOM SRC="../images/top.gif" ALT=Top BORDER=0></A>
<A HREF=index.html#_toc><IMG ALIGN=BOTTOM SRC="../images/content.gif" ALT=Contents BORDER=0></A>
<A HREF=inx.html><IMG ALIGN=BOTTOM SRC="../images/index.gif" ALT=Index BORDER=0></A></P>
<P>Bifrost Tutorial</P>


<A NAME=HEADING9-0></A>
<H1> <A NAME="LINK-bifrost-tut-_Toc402456569"><A NAME=MARKER-9-110></A>Moving Rails</A></H1>
<P> When moving the Stations, there are two things to do to make the Rails &quot;stick&quot; to the Station being moved: During the move, feedback of the Rails connecting the Station with other Stations, must be shown, and after the Station has been moved, the Rails must be physically moved too.</P>
<P> When a Station is moved by InteractiveMove<A NAME=MARKER-2-112></A>, Bifrost automatically supplies feedback during the move. This is done by repeatedly executing an instance of the HiliteOutline <A NAME=MARKER-2-113></A>virtual of the shape of the Station. When calling HiliteOutline, the drawing is done in XOR <A NAME=MARKER-2-114></A>mode, meaning that drawings may be erased simply by drawing again. A Station is a Picture, and thus feedback for all graphical objects that have been added to this Picture is automatically provided. The Rails belonging to a Station, however, is not added to the Picture, and thus feedback for the rails is not supplied automatically. In subway6.bet<A NAME=MARKER-2-115></A>, by further binding the HiliteOutline virtual of the Station pattern, the extra feedback is easily supplied:</P>

<PRE CLASS=beta>
Station:
   (#
      ......

      shapedesc::
         (#                        
            hiliteoutline::
               (# 
               do rails.scan
                     (#
                     do (if TM[]=NONE then
                            (* No transformation *)
                            (current.otherpoint -&gt; CanvasToDevice,
                             position -&gt; CanvasToDevice)
                            -&gt; immediateline;
                        else
                            (current.otherpoint 
                               -&gt; CanvasToDevice,
                             position -&gt; TM.transformpoint
                               -&gt; CanvasToDevice)
                              -&gt; immediateline;
                        if);
                     #);
               #);
         #);
    #)
</PRE>
<P> HiliteOutline enters a reference to a Matrix called TM. If this
reference is not NONE, it describes the transformation to apply to the
feedback. E.g., if the Station has been moved a distance, TM will
describe this translation. If the reference is NONE, no transformation
is to be applied.</P>

<P> The feedback for a Rail will be a simple line from the position of
the Station in question to the other end point of the Rail. To draw
the actual feedback the &quot;immediate&quot; drawing<A
NAME=MARKER-2-116></A> operations of Canvas are used. These operations
draw directly into the Canvas, without adding the drawing to the
&quot;memory&quot; of the Canvas. The operations expect device
coordinates. This is the reason why  the coordinates are transformed
by CanvasToDevice before being entered to immediateline<A
NAME=MARKER-2-117></A>. Instead of using position as the first end
point of the immediate line, of course current.mypoint could have been
used. Since the Station at the other end of the Rail considered is not
moved, TM is only applied to the position of the Station being
moved. Thus the feedback will be a &quot;rubber line<A
NAME=MARKER-2-118></A>&quot; stuck to the two Stations it
connects.</P>

<P> When the interaction is finished in InteractiveMove, as mentioned
in 
<A HREF="make_rail.html">"Making Rails"</A>, 
it calls the move <A NAME=MARKER-2-119></A>virtual to
actually move the graphical object considered. Again, since the Rails
are not added to the Picture, move will not change the Rails, when the
Picture is moved by InteractiveMove<A NAME=MARKER-2-120></A>. Instead,
this may be accomplished by further binding move:</P>

<PRE CLASS=beta>
Station:
   (#
      ......

      move::
         (# 
         do (* Move is called by interactiveMove.
             * Furtherbind to move the rails too
             *)
            
            ... 

            rails.scan
               (#
               do current.r.getbounds -&gt; damaged;
                  position -&gt; current.mypoint; 
                  (* Changes either current.r.begin or 
                   * current.r.end
                   *)
                  current.r.getbounds -&gt; damaged;
               #);
         #);

      ......
   #)
</PRE>

<P> In rails.scan, current.r is a reference to one of the rails
connecting the Station with other Stations. First the bounding box of
the rail is reported to myCanvas as being damaged<A
NAME=MARKER-2-121></A>. Then the newly transformed position is entered
as the new end point of the Rail, belonging to the Station
considered. 
Of course the other end point of the Rail should not be
changed - this is also  the reason why the Rails are not <EM>added</EM> to the Picture (the
Station), since all members of a Picture are moved rigidly when the
Picture is moved.</P>

<P> After the Rail has been changed, the new bounding box of it is
also reported as being damaged. After InteractiveMove has called move,
it also calls myCanvas.repair<A NAME=MARKER-2-122></A>. This will make
all damaged areas of myCanvas be redrawn, and since the areas the
Rails have covered are now marked as damaged, this will complete the
moving of the rails too.</P>


<HR>
<P>
<TABLE border=0 width="100%">
<TR>
<TD width="40%" align="left">
<ADDRESS>Bifrost Tutorial</ADDRESS>
</TD>
<TD width="20%" align="center"><FONT SIZE="-1">&#169; <A HREF="http://www.mjolner.com">Mj&oslash;lner Informatics</A></FONT></TD>
<TD width="40%" align="right"><SCRIPT TYPE="text/javascript" LANGUAGE=JavaScript SRC="../javascript/lastmod.js"></SCRIPT></TD>
</TABLE>
<P>
<P><A HREF=palette.html><IMG ALIGN=BOTTOM SRC="../images/next.gif" ALT=Next BORDER=0></A>
<A HREF=make_rail.html><IMG ALIGN=BOTTOM SRC="../images/prev.gif" ALT=Previous BORDER=0></A>

<A HREF=../index.html><IMG ALIGN=BOTTOM SRC="../images/top.gif" ALT=Top BORDER=0></A>
<A HREF=index.html#_toc><IMG ALIGN=BOTTOM SRC="../images/content.gif" ALT=Contents BORDER=0></A>
<A HREF=inx.html><IMG ALIGN=BOTTOM SRC="../images/index.gif" ALT=Index BORDER=0></A></P>


</BODY>
</HTML>
