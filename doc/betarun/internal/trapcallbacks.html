<HTML>

<HEAD>
<TITLE>Calling BETA from trap handlers</TITLE>
<LINK REV="made" HREF="mailto:pa@cs.au.dk">
<LINK REL="stylesheet" HREF="../../style/miadoc.css" TYPE="text/css">
</HEAD>

<BODY>
<H1>Calling BETA from trap handlers</H1>

Handling of traps to C code that reenters BETA code must include the
following.
 
<PRE>
         BETA CODE                     Sighandler (C CODE)
             
             |
             |    (Trap occurs)	       
     SP:     `---------------------.   Linux:  SaveLinuxRegisters(...)              
 				   |   Win32:  SaveWin32Registers(...)              
 				   |   SGI:    SaveSGIRegisters(...) + fix_stacks(...)      
 				   |   
 				   |   All:    set_BetaStackTop(SP);            
                                   |   
                (BETA reentered)   |   
             .---------------------'   Protect all live object
             |                         references before reentering 
   GC might  |                         BETA kode (e.g. in DOT).
    occur    |
             |
             |     (return)
             `---------------------.  
                                   |   sparc:
				   |   ucon->uc_mcontext.gregs[REG_IOA] = (long)IOA;
                                   |   ucon->uc_mcontext.gregs[REG_IOATOPOFF] = (long)IOATopOff;
 				   |   
 				   |   Linux/Win32/SGI
                                   |   RestoreXXXRegisters(...);
                    (return)       |                   
              .--------------------'
              |   
 	      |	
 	      V	
</PRE>
 
</BODY>
</HTML>