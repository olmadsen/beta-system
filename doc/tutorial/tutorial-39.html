<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                      "http://www.w3.org/TR/REC-html40/loose.dtd"
>
<HTML>
<HEAD>
<META http-equiv="Content-Type" CONTENT="text/html; CHARSET=ISO-8859-1">
<TITLE> 18.2 Concurrency and User Interface Environments</TITLE>
<LINK REL=stylesheet HREF=../style/miadoc.css TYPE=text/css>

</HEAD>
<BODY>


<A NAME=HEADING39></A>


<P><A HREF=tutorial-40.html><IMG ALIGN=BOTTOM SRC="../images/next.gif" ALT=Next BORDER=0></A>
<A HREF=tutorial-37.html><IMG ALIGN=BOTTOM SRC="../images/prev.gif" ALT=Previous BORDER=0></A>
<A HREF=tutorial-37.html><IMG ALIGN=BOTTOM SRC="../images/up.gif" ALT=Up BORDER=0></A>
<A HREF=../index.html><IMG ALIGN=BOTTOM SRC="../images/top.gif" ALT=Top BORDER=0></A>
<A HREF=index.html#_toc><IMG ALIGN=BOTTOM SRC="../images/content.gif" ALT=Contents BORDER=0></A>
<A HREF=inx.html><IMG ALIGN=BOTTOM SRC="../images/index.gif" ALT=Index BORDER=0></A></P>
<P> 18 Concurrent Library</P>


<A NAME=HEADING39-0></A>
<H2> 18.2 Concurrency and User Interface Environments</H2>
<P> Graphical user interface environments are usually event-driven in the sense that actions in the program are executed as a response to user input events. To handle this, a number of separate implementations of systemenv exist for the different user interface libraries, such as motifEnv and guienv:</P>
<UL>
<LI> Use ~beta/basiclib/systemenv as origin for programs not using event-driven user-interface libraries. 
<LI> Use ~beta/Xt/xsystemenv as origin for programs using the Motif user interface library. 
<LI> Use ~beta/guienv/guienvsystemenv as origin for programs using GUIEnv interface library.
</UL>
<P> Please note, that programs should only use one of the systemenv, xsystemenv, and guienvsystemenv fragments.</P>

<P> Suppose that we like to extend the texteditor above with a clock that should be updated every second. A clock can easily be made using the basic systemenv:</P>
<A NAME=HEADING39-9></A>
<H4 CLASS=betacaption><A NAME="fig:Program 18.2: Clock.bet"> Program 18.2: Clock.bet</A></H4>
<PRE CLASS=beta>
ORIGIN  '~beta/basiclib/systemenv';
INCLUDE '~beta/sysutils/time'
-- program: descriptor --
systemenv
(# 
   updateClock: @|System
     (# 
     do cycle
        (#
        do 1 -&gt; sleep; 
           systemtime -&gt; formattime -&gt; putline
        #)
     #)
do updateClock[] -&gt; fork
#)
</PRE>

<P> Here we simply print out the current system time on the screen. Notice, that we have included a new library called time in '~beta/sysutils/time'. This library contains facilities for getting the date and time, time usage, and for formatting times for nice printing. Running the program shown above gives the following result:</P>
<PRE CLASS=beta>
Tue Aug 23 11:48:35 1994
Tue Aug 23 11:48:36 1994
Tue Aug 23 11:48:37 1994
Tue Aug 23 11:48:38 1994
Tue Aug 23 11:48:39 1994
Tue Aug 23 11:48:40 1994
Tue Aug 23 11:48:41 1994
Tue Aug 23 11:48:42 1994
Tue Aug 23 11:48:43 1994
Tue Aug 23 11:48:44 1994
Tue Aug 23 11:48:45 1994
Tue Aug 23 11:48:46 1994
Tue Aug 23 11:48:47 1994
Tue Aug 23 11:48:48 1994
Tue Aug 23 11:48:49 1994
</PRE>
<P> Now we want to integrate this clock in our GUIEnv texteditor program, so we can always see the time in the low left corner of the window. We need to use the '~beta/guienv/guienvsystemenv':</P>
<PRE CLASS=beta>
ORIGIN  '~beta/guienv/guienvsystemenv';
INCLUDE '~beta/guienv/fields'
        '~beta/guienv/stddialogs'
        '~beta/basiclib/file'
        '~beta/sysutils/time'
-- program: descriptor --
systemenv
(# 
   setWindowEnv:: (* tell systemenv that myguienv is the
                   * the graphical user interface
                   *)
     (# do myguienv[] -&gt; theWindowEnv[] #);
   
   updateClock: @|System
     (# 
     do cycle
        (#
        do 1 -&gt; sleep; 
           systemtime -&gt; formattime -&gt; ... ;
                            (* put time into the clock *)
        #);
     #);
                
   myguienv: @guienv (* inherit from guienv *)
     (# (* guienv code as before *)
     #);

do (* fork updateClock as a separate system *)
   updateClock[] -&gt; fork;
#)
</PRE>
<P> We need to specify to systemenv what graphical user interface system we are using. This is done by extending the virtual setWindowEnv like the following:</P>

<PRE CLASS=beta>
setWindowEnv::(# do myguienv[] -&gt; theWindowEnv[] #);
</PRE>
<P> In order to do that, we have changed the guienv into a static object called myguienv. myguienv will automatically be started by systemenv.</P>
<P> Finally, we need to create a user interface element that can show the time. We use a staticText, that we position below the TextEditor field:</P>

<PRE CLASS=beta>
clock: @staticText
  (# open::
       (# w,h: @integer;
       do systemtime -&gt; formattime -&gt; label;
          theWindow.size -&gt; (w,h);
          (5,h-16) -&gt; position; (50,15) -&gt; size;
          True -&gt; BindBottom; False -&gt; BindTop;
       #);
  #);
</PRE>
<P> The complete program is:</P>

<A NAME=HEADING39-26></A>
<H4 CLASS=betacaption><A NAME="fig:Program 18.3: ClockTextEditor.bet"> Program 18.3: ClockTextEditor.bet</A></H4>
<PRE CLASS=beta>
ORIGIN '~beta/guienv/guienvsystemenv';
INCLUDE '~beta/guienv/fields'
        '~beta/guienv/stddialogs'
        '~beta/basiclib/file'
        '~beta/sysutils/time';
-- program: Descriptor --
systemEnv
(#
   setWindowEnv::&lt;  (#  do myguienv[]-&gt;theWindowEnv[] #);
   updateClock: @|System
     (# 
     do
        cycle
        (# theText: @StyledText; 
        do 1-&gt;sleep;
           systemtime-&gt;formattime-&gt; myguienv.theWindow.clock.label;
        #);
     #);
   myguienv: @guienv (* inherit from guienv *)
     (# theWindow: @window (* make a window *)
          (# menubarType:: (* extend the menubar *) 
               (# fileMenu: @menu (* make a file menu *)
                    (# textFile: @file;
                       openItem: @menuitem (* make an open item *)
                         (# eventHandler::
                            (* extend the virtual that is called *) 
                              (# onSelect:: 
                                 (* this menu item is selected *) 
                                   (# theText: @StyledText; 
                                   do theWindow[]-&gt;
                                        fileSelectionDialog-&gt;
                                        textFile.name;
                                      textFile.openRead;
                                      textFile.scan
                                        (# while::(#do true-&gt;value#);
                                        do ch-&gt;theText.put
                                        #);
                                      theText[]-&gt;
                                      theTextEditor.contents.
                                                    contents;
                                      textFile.close;
                              #)#);
                            open::  (#  do 'Open'-&gt;name #);
                         #);
                       saveItem: @menuitem (* make a save item *)
                         (# eventHandler::
                            (* extend the virtual that is called *) 
                              (# onSelect:: 
                                 (* this menu item is selected *) 
                                   (# theText: @Text; 
                                   do
                                      textFile.openWrite;
                                      theTextEditor.contents.
                                                    contents-&gt;
                                        textFile.puttext;
                                      textFile.close;
                                   #)
                              #);
                            open:: (# do 'Save'-&gt;name #);
                         #);
                       quitItem: @menuitem (* make a quit item *)
                         (# eventHandler:: 
                              (# onSelect:: (#  do Terminate #) #);
                            open:: (#  do 'Quit'-&gt;name #);
                         #);
                       open:: 
                       (* extend the open virtual of filemenu 
                        * to open the items *)
                         (# 
                         do 'File'-&gt;name;
                            openItem.open;
                            openItem[]-&gt;append;
                            saveItem.open;
                            saveItem[]-&gt;append;
                            quitItem.open;
                            quitItem[]-&gt;append;
                         #)
                    #);
                  open::
                  (* extend the open virtual of the menubar
                   * to open the filemenu *)
                   (# do fileMenu.open; fileMenu[]-&gt;append #);
               #);
             thetextEditor: @textEditor (* our text editor *)
               (# open::
                  (* extend the open virtual to set the size 
                   * and the placement *)
                  (# w,h: @integer; 
                    do theWindow.size-&gt;(w,h);
                       (w,h-20)-&gt;Size;
                       True-&gt;bindBottom;
                       True-&gt;bindRight
                    #);
               #);
             clock: @staticText
               (# open:: 
                    (# w,h: @integer; 
                    do systemtime-&gt;formattime-&gt;label;
                       theWindow.size-&gt;(w,h);
                       (5,h-16)-&gt;position;
                       (300,15)-&gt;size;
                       True-&gt;BindBottom;
                       False-&gt;BindTop;
                    #);
               #);
             open::
             (* extend the window open virtual
              * to open the textEditor *) 
               (#  do thetextEditor.open; clock.open;  #);
          #);
     do theWindow.open; 
        (* open the window when the application start up *) 
     #)
do updateClock[]-&gt;fork; 
#)  
</PRE>
<P> The following figure shows a snapshot of the program running on Motif:</P>
<P> <IMG SRC=clocktexteditor.gif></P>
<P> </P>
<A NAME=HEADING39-30></A>
<H2> 18.3 Changes from the Original Design</H2>
<P> The abstractions defined here are based on the ones described in chapter 12 of the BETA book. The implementation is identical to the design in the BETA book, except for the following changes:</P>
<UL>
<LI>1. The syntax of fork is
<LI> S[]-&gt;fork  and not S.fork.<A NAME=MARKER-2-125></A>
<LI>2. The syntax of conc is
</UL>
<PRE CLASS=beta>
	conc<A NAME=MARKER-2-126></A>(# do S1[]-&gt;start; S2[]-&gt;start; S3[]-&gt;start #)
</PRE>
<UL>
<LI> and not conc(# do S1.start; S2.start; S3.start #).
<LI>3. The syntax of alt is
</UL>
<PRE CLASS=beta>
	alt<A NAME=MARKER-2-127></A>(# do S1[]-&gt;start; S2[]-&gt;start; S3[]-&gt;start #)
</PRE>
<UL>
<LI> and not alt(# do S1.start; S2.start; S3.start #).
</UL>

<P> This implementation of systemenv includes some new facilities, not described in the BETA book:</P>
<UL>
<LI>4. semaphore had an additional attribute: tryP, which is a non-blocking call of P.
<LI>5. In addition to s[]-&gt;fork, s[]-&gt;kill is possible, and in addition to pause, 100 -&gt; sleep is possible.
<LI>6. system has a new virtual attribute, onKilled, that is invoked before the system terminates
<LI>7. systemenv has a new virtual attribute, deadlocked, that is invoked if all processes are deadlocked.
<LI>8. Finally, systemenv defines three new attributes to cope with event driven user interfaces: windowEnvType, theWindowEnv, and setWindowEnv. See further details on cooperation with user interface environments below.
</UL>

<P> In order to implement real concurrency, an interrupt mechanism must be implemented. This is currently not done. A component/system will thus keep the control until it makes an explicit or implicit SUSPEND. An implicit SUSPEND is made when a component must wait for a semaphore<A NAME=MARKER-2-128></A>, or executes the pause and sleep patterns.</P>

<P> The systemenv libraries are thoroughly described in the manual <A HREF="../bibliography/index.html#mia94-25">[MIA 94-25]</A></P>











<HR>
<P>
<TABLE border=0 width="100%">
<TR>
<TD width="40%" align="left">
<ADDRESS>Libraries Tutorial</ADDRESS>
</TD>
<TD width="20%" align="center"><FONT SIZE="-1">&#169; <A HREF="http://www.mjolner.com">Mj&oslash;lner Informatics</A></FONT></TD>
<TD width="40%" align="right"><SCRIPT TYPE="text/javascript" LANGUAGE=JavaScript SRC="../javascript/lastmod.js"></SCRIPT></TD>
</TABLE>
<P>
<P><A HREF=tutorial-40.html><IMG ALIGN=BOTTOM SRC="../images/next.gif" ALT=Next BORDER=0></A>
<A HREF=tutorial-37.html><IMG ALIGN=BOTTOM SRC="../images/prev.gif" ALT=Previous BORDER=0></A>
<A HREF=tutorial-37.html><IMG ALIGN=BOTTOM SRC="../images/up.gif" ALT=Up BORDER=0></A>
<A HREF=../index.html><IMG ALIGN=BOTTOM SRC="../images/top.gif" ALT=Top BORDER=0></A>
<A HREF=index.html#_toc><IMG ALIGN=BOTTOM SRC="../images/content.gif" ALT=Contents BORDER=0></A>
<A HREF=inx.html><IMG ALIGN=BOTTOM SRC="../images/index.gif" ALT=Index BORDER=0></A></P>


</BODY>
</HTML>
