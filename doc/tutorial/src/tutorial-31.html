<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                      "http://www.w3.org/TR/REC-html40/loose.dtd"
>
<HTML>
<HEAD>
<META http-equiv="Content-Type" CONTENT="text/html; CHARSET=ISO-8859-1">
<TITLE> 15 Access to External Functions and Data</TITLE>
<LINK REL=stylesheet HREF=../style/miadoc.css TYPE=text/css>

</HEAD>
<BODY>


<A NAME=HEADING31></A>


<P><A HREF=tutorial-33.html><IMG ALIGN=BOTTOM SRC="../images/next.gif" ALT=Next BORDER=0></A>
<A HREF=tutorial-29.html><IMG ALIGN=BOTTOM SRC="../images/prev.gif" ALT=Previous BORDER=0></A>

<A HREF=../index.html><IMG ALIGN=BOTTOM SRC="../images/top.gif" ALT=Top BORDER=0></A>
<A HREF=index.html#_toc><IMG ALIGN=BOTTOM SRC="../images/content.gif" ALT=Contents BORDER=0></A>
<A HREF=inx.html><IMG ALIGN=BOTTOM SRC="../images/index.gif" ALT=Index BORDER=0></A></P>
<P>Libraries Tutorial</P>


<A NAME=HEADING31-0></A>
<H1> 15 Access to External Functions and Data</H1>
<P> The Mj&oslash;lner System allows a tight integration between the BETA language and routines and data structures, originating from the C language. Many of the libraries in the Mj&oslash;lner System (such as the interface to the X Window System) is based on this tight integration.</P>


<P> The integration allows for two types of integration, namely integration of routines, and integration of data structures. The facilities give the BETA programmer the possibility to invoke routines, written in C, and for accessing data structures, allocated in C. Moreover, the facilities also works the other way around, namely by allowing BETA patterns to be invoked (instantiated) from C routines, and BETA objects to be manipulated by C routines.</P>





<A NAME=HEADING32-0></A>
<H2> 15.1 Example</H2>
<P> Imagine that we have a database with person records. The database has a C interface and we like to use the database in BETA. </P>
<P> The following C declarations and functions illustrates a simplified database:</P>

<PRE CLASS=beta>
typedef struct Person {
  long ID;
  char *firstname,*surname;
  char sex; /* m(ale) or f(emale) */
} Person;

#define MaxPersons 200

Person Persons[MaxPersons];

Person *getPerson(long ID) {
  if (ID&gt;=0 &amp;&amp; ID&lt;MaxPersons)
    return &amp;Persons[ID];
  else
    return 0;
}

long putPerson(long ID, char * firstname, char* surname, char sex) {
  if (ID&gt;=0 &amp;&amp; ID&lt;MaxPersons) {
    Persons[ID].ID=ID;
    Persons[ID].firstname=firstname;
    Persons[ID].surname=surname;
    Persons[ID].sex=sex;
    return 1;
  } else {
    return 0;
   }
}
</PRE>
<P> We can then interface to the two functions and the Person struct by the following external and externalRecord declarations:</P>
<PRE CLASS=beta>
getPerson: external
  (# ID: @integer;
     ptr: @integer;
  enter ID
  exit ptr
  #);
putPerson: external
  (# ID: @integer;
     firstname, surname: [1]@char;
     sex: @char;
     result: @boolean;
  enter (ID,firstname,surname,sex)
  exit result
  #);
Person: externalRecord
  (# ID: @long(# pos::(# do 0-&gt; value #)#);
     firstname: @long(# pos::(# do 4-&gt; value #)#);
     surname: @long(# pos::(# do 8-&gt; value #)#); (* char ptr *)
     sex: @byte(# pos::(# do 12-&gt; value #)#);
  #);
</PRE>

<P> Interfacing to C routines are done by specifying the external pattern as the superpattern for the BETA pattern, which, when invoked, should invoke the C routine. The name of the entry call of the C routine should be the same as the name of the BETA pattern. The BETA compiler will then generate a call to an external routine with the same name as the BETA pattern, using C's style of passing parameters. The pattern:</P>
<PRE CLASS=beta>
getPerson: external
  (# ID: @integer;
     ptr: @integer;
  enter ID
  exit ptr
  #);
</PRE>
<P> describes the interface to an external C function with the name getPerson.</P>

<P> Transferring data to and from the external languages is dealt with through two special purpose patterns: cStruct and externalRecord. cStruct is the means for specifying a BETA object with a specific storage layout, and with the purpose of transferring this object to the external language for processing. That is, a cStruct object is allocated by BETA and made available for processing externally. externalRecord is the means for specifying a BETA interface into some data structures, allocated externally. The pattern:</P>
<PRE CLASS=beta>
Person: externalRecord
  (# ID: @long(# pos::(# do 0-&gt; value #)#);
     firstname: @long(# pos::(# do 4-&gt; value #)#);
     surname: @long(# pos::(# do 8-&gt; value #)#); (* char ptr *)
     sex: @byte(# pos::(# do 12-&gt; value #)#);
  #);
</PRE>
<P> describes an interface to an external allocated struct (Person) with four fields.</P>
<P> We can create a person by calling putPerson like this:</P>
<PRE CLASS=beta>
(117,'Roger','Smith','m')-&gt;putPerson
</PRE>
<P> We can get a person from the database by:</P>
<PRE CLASS=beta>
117 -&gt; getPerson -&gt; aPerson.ptr;
</PRE>
<P> Notice, that we must assign to the ptr attribute of the externalRecord Person.</P>

<P> The Person can now be examined like any other BETA object, except for the 'string' declarations firstname and surname. These refers to C strings. The Mj&oslash;lner System includes a cString<A NAME=MARKER-2-97></A> library for easy interface to these C strings, so we simply make a small operation to print out the strings:</P>
<PRE CLASS=beta>
putCString:
  (# cstr: @cString;
  enter cstr
  do cstr.get -&gt; puttext;
  #);
</PRE>

Finally we must specify where to find the C object file we are interfacing to. This is done using a OBJFILE<A NAME=MARKER-2-98></A> specification. The specification:
<PRE CLASS=beta>
OBJFILE nti     '$/cperson.obj'
        mac     '$/cperson.obj'
        default '$/cperson.o';
</PRE>
means that we should link with the file cperson.o (or cperson.obj, depending on the platform) located in the subdirectory with the name of the platform - the same name as the code subdirectory ('$' expands to name of platform).

<P> The C file can also be generated directly by the BETA compiler by a BUILD specification. The specification:</P>

<PRE CLASS=beta>
BUILD nti     '$$/cperson.obj' 'cperson.c' 
              'betacc $0 $1'
      ppcmac  '$$/cperson.obj' 'cperson.c' 
              'MrC -w 2 -o $0 $1'
      default '$$/cperson.o' 'cperson.c'
              '$CC -c -o $0 $1';
</PRE>
<P> means that we should link with the file cperson.o (or cperson.obj) located in the subdirectory with the name of the platform - the same name as the code subdirectory ('$$' expands to name of platform).  And that in order to generale the cperson.o (or cperson.obj file), the BETA compiler should invoke the betacc, MrC og CC compiner, depending on the platform)</P>

<P> And now the complete program:</P>
<A NAME=HEADING32-34></A>
<H4 CLASS=betacaption><A NAME="fig:Program 15: Person.bet"> Program 15: Person.bet</A></H4>
<PRE CLASS=beta>
ORIGIN '~beta/basiclib/external';
INCLUDE '~beta/sysutils/cstring';
BUILD nti     '$$/cperson.obj' 'cperson.c' 
              'betacc $0 $1'
      ppcmac  '$$/cperson.obj' 'cperson.c' 
              'MrC -w 2 -o $0 $1'
      default '$$/cperson.o' 'cperson.c'
              '$CC -c -o $0 $1';
--program: descriptor-- 
(# 
   getPerson: external
     (# ID: @integer;
        ptr: @integer;
     enter ID
     exit ptr
     #);
   putPerson: external
     (# ID: @integer;
        firstname, surname: [1]@char;
        sex: @char;
        result: @boolean;
     enter (ID,firstname,surname,sex)
     exit result
     #);
   Person: ExternalRecord
     (# ID: @long(# pos::(# do 0-&gt; value #)#);
        firstname: @long(# pos::(# do 4-&gt; value #)#);
        surname: @long(# pos::(# do 8-&gt; value #)#); (* pointers to text *)
        sex: @byte(# pos::(# do 12-&gt; value #)#);
     #);
   putCString:
     (# cstr: @cString;
     enter cstr
     do cstr.get -&gt; puttext;
     #);
   aPerson: @Person;
do 
   (* store a person in C-database *)
   (if not ((117,'Roger','Smith','m')-&gt;putPerson) then
       'Failed to store person'-&gt;putline; stop;
   if);
   (* get person from C-database *)
   117 -&gt; getPerson -&gt; aPerson.ptr;
   (if aPerson.ptr = 0 then
       'Failed to retrieve person' -&gt; putline; stop;
   if);
   'Person: ' -&gt; puttext;
   aPerson.ID -&gt; putint; 
   ' ' -&gt; put;
   'Name: ''' -&gt; puttext;
   aPerson.firstname -&gt; putCString;
   ' ' -&gt; put;
   aPerson.surname -&gt; putCString; 
   ''' ' -&gt; puttext;
   'Sex: ' -&gt; puttext;
   aPerson.sex-&gt; put;
   newline;
#)
</PRE>
<P> Output of running the program is:</P>
<PRE CLASS=beta>
nil% Person
Person: 117 Name: 'Roger Smith' Sex: m
</PRE>










<HR>
<P>
<TABLE border=0 width="100%">
<TR>
<TD width="40%" align="left">
<ADDRESS>Libraries Tutorial</ADDRESS>
</TD>
<TD width="20%" align="center"><FONT SIZE="-1">&#169; <A HREF="http://www.mjolner.com">Mj&oslash;lner Informatics</A></FONT></TD>
<TD width="40%" align="right"><SCRIPT TYPE="text/javascript" LANGUAGE=JavaScript SRC="../javascript/lastmod.js"></SCRIPT></TD>
</TABLE>
<P>
<P><A HREF=tutorial-33.html><IMG ALIGN=BOTTOM SRC="../images/next.gif" ALT=Next BORDER=0></A>
<A HREF=tutorial-29.html><IMG ALIGN=BOTTOM SRC="../images/prev.gif" ALT=Previous BORDER=0></A>

<A HREF=../index.html><IMG ALIGN=BOTTOM SRC="../images/top.gif" ALT=Top BORDER=0></A>
<A HREF=index.html#_toc><IMG ALIGN=BOTTOM SRC="../images/content.gif" ALT=Contents BORDER=0></A>
<A HREF=inx.html><IMG ALIGN=BOTTOM SRC="../images/index.gif" ALT=Index BORDER=0></A></P>


</BODY>
</HTML>
