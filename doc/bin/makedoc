#!/usr/local/bin/perl -s

sub usage
{
    print "usage: makedoc [-v] <manual>.book\n";
    print"   -v   verbose output\n";
    print"   -d   debug makedoc script\n";
    exit(1);
}

sub expand 
{
    local $path = $_;
    while ($path =~ m/\$(\w+)/){
	local $var = $1;
	if (!defined($ENV{$var})){
	    print "Expand $path: Warning: $var not in environment\n";
	} else {
	    $path = $` . $ENV{$var} . $';
	}
    }
    return $path;
}

sub read_book_file
{
    if ($#ARGV == 0){ 
	$book_file_name = $ARGV[0];
    } else {
	&usage();
    };
    
    open SEQUENCE, $book_file_name || die "Cannot open \"$book_file_name\" file: !$\n";
    #push @sequence, "title.html";
    while (<SEQUENCE>){
	chomp;
	# remove comments
	s/\#.*$//;
	# skip blank lines
	next if (m/^\s*$/);
	if (-f "src/$_"){
	    push @sequence, "src/$_";
	} else {
	    if (m/^date:\s*(.*)$/){ $date = $1 };
	    if (m/^mia:\s*(.*)$/){ $mia = $1 };
	    if (m/^title:\s*(.*)$/){ $title = $1 };
	    if (m/^copyright:\s*(.*)$/){ $copyright = $1 };
	    if (m/^pdf:\s*(.*)$/){ $pdf= $1 };
	    if (m/^int:\s*(.*)$/){ push @interfaces, &expand($1) };
	}
    }
    if ($debug){
	print "read book file $book_file_name.\n";
	print "  date:      $date\n";
	print "  mia:       $mia\n";
	print "  title:     $title\n";
	print "  copyright: $copyright\n";
	print "  pdf:       $pdf\n";
	print "  sequence:\n    ";
	print join("\n    ",@sequence);
	print "\n  interfaces:\n    ";
	print join("\n    ",@interfaces);
	print "\n";
    }
}

### main #######

# Command line options
$verbose = 1 if (defined($v));
$debug = 1 if (defined($d));

&read_book_file;
