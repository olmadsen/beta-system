#!/usr/local/bin/perl -s

sub usage
{
    print "usage: makedoc [-v] <manual>.book\n";
    print"   -v   verbose output\n";
    print"   -d   debug makedoc script\n";
    exit(1);
}

sub set_default_variable_values
{
    $insert_validhtml40 = 1;
    if ($fullpath){
	if ($extradir){
	    print "makedoc: Both -f and -x specified: -x is ignored\n";
	}
	$css = "http://www.mjolner.com/mjolner-system/documentation/style/miadoc.css";
	$jsdir = "http://www.mjolner.com/mjolner-system/documentation/javascript";
	$imagedir = "http://www.mjolner.com/mjolner-system/documentation/images/";
	$topfile = "http://www.mjolner.com/mjolner-system/documentation/index.html";
	$upfile = "http://www.mjolner.com/mjolner-system/documentation/index.html";
    } else {
	if ($extradir){
	    $css = "../../style/miadoc.css";
	    $jsdir = "../../javascript";
	    $imagedir = "../../images/";
	    $topfile = "../../index.html";
	    $upfile = "../index.html";
	} else {
	    $css = "../style/miadoc.css";
	    $jsdir = "../javascript";
	    $imagedir = "../images/";
	    $topfile = "../index.html";
	    $upfile = "index.html";
	}
    }
    $lastmodscript = "$jsdir/lastmod.js";
    $tocfile = "index.html";
    $indexfile = "inx.html";

    $leftmargin=25;
}

sub expand 
{
    local $path = $_;
    while ($path =~ m/\$(\w+)/){
	local $var = $1;
	if (!defined($ENV{$var})){
	    print "Expand $path: Warning: $var not in environment\n";
	} else {
	    $path = $` . $ENV{$var} . $';
	}
    }
    return $path;
}

sub strip_extension
{
    local ($string) = @_;
    if ( $string =~ m/([^\.]+)\..*/ ) {
	$string = $1;
    }
    return $string;
}

sub strip_path
{
    local ($string) = @_;
    if ( $string =~ m%.*/([^/]+)% ) {
	$string = $1;
    }
    return $string;
}

sub print_valid_html_button()
{

    print<<EOT if ($insert_validhtml40);
<TABLE BORDER=0 ALIGN=RIGHT>
<TR>
<TD>
<A HREF="http://validator.w3.org/check/referer">
<IMG BORDER=0 SRC="${imagedir}vh401.gif" ALT="Valid HTML 4.01!" HEIGHT=31 WIDTH=88>
</A>
</TD>
</TR>
</TABLE>
<BR CLEAR=right>
EOT
}

sub print_rel_link
{
    local ($type, $href) = @_;
    $type = ucfirst ($type);
    print<<EOT;
<LINK REL="$type" HREF="$href">
EOT
}

sub print_std_links
{
    local ($next, $prev);

    if ($filenumber==$#files){
	# last file
	&print_rel_link("next", $indexfile);
    } else {
	$next = &strip_path(&strip_extension($files[$filenumber+1]));
	&print_rel_link("next", "$next.html");
    }
    if ($filenumber==0){
	# first file
	&print_rel_link("prev", $tocfile);
    } else {
	$prev = &strip_path(&strip_extension($files[$filenumber-1]));
	&print_rel_link("prev", "$prev.html");
    }
    &print_rel_link("start", $topfile);
    &print_rel_link("first", &strip_path(&strip_extension($files[0])) . ".html");
    &print_rel_link("last", &strip_path(&strip_extension($files[$#files])) . ".html");
    &print_rel_link("contents", $tocfile);
    &print_rel_link("index", $indexfile);
    &print_rel_link("up", "index.html");
    &print_rel_link("author", "mailto:support\@mjolner.com?Subject=MIADOC Manual Comment");
    #&print_rel_link("copyright", "copyright.html");
    #&print_rel_link("help", "help.html");
    #&print_rel_link("search", "search.html");
}

sub print_nav_link
{
    local ($type, $href, $title) = @_;
    local ($label) = ucfirst ($type);
    if ($href ne ""){
	print "document.write(\'\\<A HREF=\"$href\" CLASS=\"SideBar\"\\ TITLE=\"$title\">$label\\</A\\>\\<BR\\>');\n";
    }
}

sub print_std_nav_links
{
    local ($next, $prev);

    if ($filenumber==$#files){
	# last file
	&print_nav_link("next", $indexfile, "Next: Alphabetic Index");
    } else {
	$next = &strip_path(&strip_extension($files[$filenumber+1]));
	&print_nav_link("next", "$next.html", "$next.html");
    }
    if ($filenumber==0){
	# first file
	&print_nav_link("previous", $tocfile, "Previous: Table of Contents");
    } else {
	$prev = &strip_path(&strip_extension($files[$filenumber-1]));
	&print_nav_link("previous", "$prev.html", "$prev.html");
    }
    &print_nav_link("top", $topfile, "Top: Manuals Main Entry");
    &print_nav_link("content", $tocfile, "Table of Contents");
    &print_nav_link("index", $indexfile, "Alphabetic Index");
    &print_nav_link("PDF", $pdf, "Portable Document Format version of manual");
}

sub print_layer_begin
{
    print<<EOT;
<LAYER id="SideBar" onMouseover="pull()" onMouseout="draw()" style="position:absolute;left:-95px;width:80px;layer-background-color:#00557A;padding:5px;line-height:25px; ">
<SCRIPT TYPE="text/javascript" LANGUAGE="JavaScript1.2">
if (document.all){
  document.write('\\<DIV id="SideBar2" onMouseover="pull()" onMouseout="draw()" STYLE="position:absolute;left:-80px;top:15px;width:100px;background-color:#00557A;padding:5px;line-height:25px;cursor:move;" TITLE=\"Navigation Bar: Slides out when cursor is moved out\"\\>');
}
if (document.all && (navigator.userAgent.indexOf("Mac")==-1)) {
  document.write('\\<IMG SRC="$imagedir/navigation.gif" STYLE="position:absolute;left:84;top:5" WIDTH=13 HEIGHT=63 ALT=""\\>');
} else {
  document.write('\\<IMG SRC="$imagedir/navigation.gif" ALIGN=RIGHT WIDTH=13 HEIGHT=63 ALT=""\\>');
}
EOT
}

sub print_layer_end
{
    print<<EOT;
if (document.all)
  document.write('\\</DIV\\>');
else
  document.write('&nbsp;');
SetupSideBar();
</SCRIPT>
</LAYER>
EOT
}

sub print_header
{
    local ($title) = @_;

    print<<EOT;
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                      "http://www.w3.org/TR/REC-html40/loose.dtd"
>
<!-- Autogenerated file - do not edit -->
<HTML>
<HEAD>
<META http-equiv="Content-Type" CONTENT="text/html; CHARSET=ISO-8859-1">
<TITLE>$title</TITLE>
<LINK REL="stylesheet" HREF="$css" TYPE="text/css">
EOT

    &print_std_links;

    print<<EOT;
<SCRIPT TYPE="text/javascript" LANGUAGE="JavaScript1.2" SRC="$jsdir/sidebar.js">
</SCRIPT>
</HEAD>
<BODY style="margin-left:${leftmargin}px">
EOT

    &print_layer_begin;
    &print_std_nav_links;
    &print_layer_end;

}

sub print_trailer
{
    local ($title) = @_;

    &print_valid_html_button;

    print<<EOT;
<!--+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++-->
<HR>
<P></P>
<TABLE cols=3 border=0 width=100%>
<TR>
<TD width="40%" align="left"><ADDRESS>$title</ADDRESS></TD>
<TD width="20%" align="center">$copyright</TD>
<TD width="40%" align="right"><SCRIPT LANGUAGE="JavaScript1.2" SRC="$lastmodscript"></SCRIPT></TD>
</TABLE>
<P></P>
</BODY>
</HTML>
EOT
}

sub print_toc_header
{
    local ($next) = &strip_path(&strip_extension($files[0]));

    print<<EOT;
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                      "http://www.w3.org/TR/REC-html40/loose.dtd"
>
<!-- Autogenerated file - do not edit -->
<HTML>
<HEAD>
<META http-equiv="Content-Type" CONTENT="text/html; CHARSET=ISO-8859-1">
<TITLE>Interface Description: Table of Contents</TITLE>
<SCRIPT TYPE="text/javascript" LANGUAGE="JavaScript1.2" SRC="$jsdir/sidebar.js">
</SCRIPT>
<LINK REL="stylesheet" HREF="$css" TYPE="text/css">
EOT

    &print_rel_link("next", "$next.html");
    &print_rel_link("start", $topfile);
    &print_rel_link("first", &strip_path(&strip_extension($files[0])) . ".html");
    &print_rel_link("last", &strip_path(&strip_extension($files[$#files])) . ".html");
    &print_rel_link("contents", $tocfile);
    &print_rel_link("index", $indexfile);
    &print_rel_link("up", "index.html");
    &print_rel_link("author", "mailto:support\@mjolner.com?Subject=MIADOC Manual Comment");
    #&print_rel_link("copyright", "copyright.html");
    #&print_rel_link("help", "help.html");
    #&print_rel_link("search", "search.html");


    print<<EOT;
</HEAD>
<BODY style="margin-left:${leftmargin}px">
EOT

    &print_layer_begin;
    &print_nav_link("next", "$next.html", "$next.html");
    &print_nav_link("top", $topfile, "Top: Manuals Main Entry");
    &print_nav_link("index", $indexfile, "Alphabetic Index");
    &print_nav_link("PDF", $pdf, "Portable Document Format version of manual");
    &print_layer_end;
}


sub read_book_file
{
    if ($#ARGV == 0){ 
	$book_file_name = $ARGV[0];
    } else {
	&usage();
    };
    
    open SEQUENCE, $book_file_name || die "Cannot open \"$book_file_name\" file: !$\n";
    while (<SEQUENCE>){
	chomp;
	# remove comments
	s/\#.*$//;
	# skip blank lines
	next if (m/^\s*$/);
	if (-f "src/$_"){
	    push @files, "$_";
	} else {
	    if (m/^date:\s*(.*)$/){ $date = $1 };
	    if (m/^mia:\s*(.*)$/){ $mia = $1 };
	    if (m/^title:\s*(.*)$/){ $title = $1 };
	    if (m/^copyright:\s*(.*)$/){ 
		$copyrightyears = $1; 
		$copyright = 
		    "<FONT size=-1>&COPY; $copyrightyears <A HREF=\"http://www.mjolner.com\">Mj&oslash;lner Informatics</A></FONT>";

	    };
	    if (m/^pdf:\s*(.*)$/){ $pdf= $1 };
	    if (m/^int:\s*(.*)$/){ push @interfaces, &expand($1) };
	}
    }
    if ($debug){
	print STDERR "read book file $book_file_name.\n";
	print STDERR "  date:      $date\n";
	print STDERR "  mia:       $mia\n";
	print STDERR "  title:     $title\n";
	print STDERR "  copyright: $copyrightyears\n";
	print STDERR "  pdf:       $pdf\n";
	print STDERR "  sequence:\n    ";
	print STDERR join("\n    ",@files);
	print STDERR "\n  interfaces:\n    ";
	print STDERR join("\n    ",@interfaces);
	print STDERR "\n";
    }
}

sub process_file
{
    local $file = $files[$filenumber];
    print STDERR "Generating $file from src/$file\n" if $verbose;

    printf STDERR "Reading src/$file ...\n" if $verbose==1;

    if (!open(SRC, "src/$file")){
	print "Cannot open src/$file for reading: $!\n";
	return;
    }

    $line="";
    while (<SRC>) {
	$line .= $_;
    };
    close (SRC);


    printf STDERR "Writing to $file ... " if $verbose==1;
    if (!open (STDOUT, ">$file")){
	print "\nCannot open $file for writing: $!\n";
	return;
    }
    &print_header($title);
    print $line;
    &print_trailer($title);
    close (STDOUT);

    printf STDERR "\ndone\n\n" if $verbose==1;


}

sub process_src_files
{
    for ($filenumber=0; $filenumber<=$#files; $filenumber++){
	&process_file($files[$filenumber]);
    }
}

sub print_toc
{
    print<<EOT;
<A NAME="_toc"></A>

<DIV CLASS=toc>
<DL>
<DT><A HREF="index.html#_toc"><B>Contents</B></A><DD>
  <DL>
EOT

    for ($filenumber=0; $filenumber<=$#files; $filenumber++){
	print "  <DT><A HREF=\"$files[$filenumber]\">";
	print "$files[$filenumber]</A> (FIXME: extract heading)<DD>\n";
    }

    if ($#interfaces>0){
	print "  <DT><I>Interface Descriptions:</I><DD>\n";
	print "    <DL>\n";
        for ($filenumber=0; $filenumber<=$#interfaces; $filenumber++){
	    local ($f);
	    $f = $interfaces[$filenumber];
	    $f = &strip_extension(&strip_path($f));
	    print "    <DT><A HREF=\"interface/$f.html\">";
	    print ucfirst($f) . " Interface</A><DD>\n";
	}
	print "    </DL>\n";
    }

    print<<EOT;
  <DT><A HREF="inx.html">FIXME: Index</A><DD>
  </DL>
</DL>
</DIV>
EOT

}

sub make_title_page
{
    printf STDERR "\nWriting title page index.html ... " if $verbose==1;
    open (STDOUT, ">index.html") || die "\nCannot open index.html for writing: $!\n";
    &print_toc_header($title);

    print<<EOT;
<H1>$title</H1>

<P>
<CENTER>
<B>
Mj&oslash;lner Informatics Report<BR>
$mia<BR>
$date</B>
<P>
</CENTER>
EOT

    &print_toc;

    &print_trailer($title);
    close (STDOUT);
    printf STDERR "done.\n" if $verbose==1;
}

### main #######

# Command line options
$verbose = 1 if (defined($v));
$debug = 1 if (defined($d));

# variables
&set_default_variable_values();

&read_book_file;

&process_src_files;

&make_title_page;
