<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
<HEAD>
<TITLE>External Interface</TITLE>
<LINK REL="stylesheet" HREF="../../style/miadoc.css" TYPE="text/css">
</HEAD>
<BODY>
<P></P>
<A HREF="unixfile.html"><IMG ALIGN=BOTTOM SRC="../../images/next.gif" ALT=Next BORDER=0></A>
<A HREF="timehandler.html"><IMG ALIGN=BOTTOM SRC="../../images/prev.gif" ALT=Previous BORDER=0></A>
<A HREF="../index.html"><IMG ALIGN=BOTTOM SRC="../../images/top.gif" ALT=Top BORDER=0></A>
<A HREF="index.html"><IMG ALIGN=BOTTOM SRC="../../images/content.gif" ALT=Content BORDER=0></A>
<A HREF="inx.html"><IMG ALIGN=BOTTOM SRC="../../images/index.gif" ALT=Index BORDER=0></A>
<P></P>
<P>Interface Description</P>
<HR>
<!---------------------------------------------------------->

<H1>External Interface</H1>
<PRE CLASS=interface>
ORIGIN 'betaenv';
-- CStructLib: attributes---
(*
 * COPYRIGHT
 *       Copyright Mjolner Informatics, 1992-99
 *       All rights reserved.
 *
 ****** Patterns for external interface *****
 * 
 * In CStructLib, the operations on a cStruct are defined.
 * The pattern ExternalRecord is an interface to e.g. CStruct objects
 * allocated from C or other external languages.
 *)
<B>GetByte</B><A name="GetByte.1(822)"></A>: 
  (# byteno: @int32;
  enter byteno-&gt;chk
  exit byteNo -&gt; R.%getByte
  #);
<B>PutByte</B><A name="PutByte.1(823)"></A>: 
  (# val: @int8;
     byteno: @int32;
  enter(byteno,val) 
  do byteno-&gt;chk;
     (val,byteno) -&gt;R.%putbyte
  #);
<B>GetShort</B><A name="GetShort.1(824)"></A>: 
  (# byteno: @int32;
  enter byteno-&gt;chk 
  exit (byteno div 2) -&gt;R.%getShort
  #);
<B>PutShort</B><A name="PutShort.1(825)"></A>: 
  (# val: @int16;
     byteno: @int32;
  enter (byteno,val) 
  do byteno-&gt;chk;
     (val,byteno div 2) -&gt; R.%putShort
  #);
<B>GetSignedShort</B><A name="GetSignedShort.1(826)"></A>: 
  (# byteno: @int32;
  enter byteno-&gt;chk 
  exit (byteno div 2) -&gt;R.%getSignedShort
  #);
<B>GetLong</B><A name="GetLong.1(827)"></A>: 
  (# byteno: @int32;
  enter byteno-&gt;chk
  exit (byteno div 4) -&gt;R.%getLong
  #);
<B>PutLong</B><A name="PutLong.1(828)"></A>: 
  (# val: @int32;
     byteno: @int32
  enter (byteno,val)
  do byteno-&gt;chk; 
     (val,byteno div 4) -&gt;R.%putLong
  #);

<B>CStructField</B><A name="CStructField.1(829)"></A>: 
  (* Used for declaring CStruct fields *)
  (# pos:&lt; IntegerObject; 
     p: @pos; 
  do INNER (* FIXME: only because of compiler bug for %getLong, see below *)
  #);
<B>Byte</B><A name="Byte.1(830)"></A>: CStructField
  (# set: @(# val: @int8 enter val do (val,p) -&gt;R.%putByte #);
  enter set
  exit p -&gt;R.%getByte
  #);
<B>Short</B><A name="Short.1(831)"></A>: CStructField
  (# set: @(# val: @int16 enter val do (val,p div 2) -&gt;R.%putShort #);
     pp: @integer;
  enter set
  do p-&gt;pp;
  exit (pp div 2) -&gt;R.%getShort
  #);
<B>SignedShort</B><A name="SignedShort.1(832)"></A>: CStructField
  (# set: @(# val: @int16 enter val do (val,p div 2) -&gt;R.%putShort #);
  enter set
  exit (p div 2) -&gt;R.%getSignedShort
  #);
(* FIXME: crashes compiler when compiling process/compipe'
 * Long: CStructField
 *   (# set: @(# val: @int32 enter val do (val,p) -&gt;R.%putLong #);
 *   enter set
 *   exit (p div 4)-&gt;R.%getLong
 *   #);
 *)
<B>Long</B><A name="Long.1(833)"></A>: CStructField
  (# set: @(# val: @int32 enter val do (val,p) -&gt;R.%putLong #);
     pp: @integer;
  enter set
  do p-&gt;pp;
  exit (pp div 4)-&gt;R.%getLong
  #);

--LIB: attributes--
<B>ExternalRecord</B><A name="ExternalRecord.1(834)"></A>: 
  (* Super-pattern for describing externally allocated record-structures.
   * A call to e.g. a C routine may often return a pointer to a CStruct.
   * By assigning such a pointer to the ptr-field of an externalRecord 
   * object it is possible to interface to such an external CStruct.
   * Notice the difference to the CStruct pattern, which is typically used
   * to *provide* external code with a structure allocated in BETA.
   *)
  (# <B>ptr</B><A name="ExternalRecord.1:ptr.2(835)"></A><A name="ptr.2(835)"></A>: @int32; (* pointer to the externally allocated record *)
     <B>GetByte</B><A name="ExternalRecord.1:GetByte.2(836)"></A><A name="GetByte.2(836)"></A>: 
       (# byteno: @int32;
       enter byteno
       exit %getByteAt (ptr+byteno)
       #);
     <B>PutByte</B><A name="ExternalRecord.1:PutByte.2(837)"></A><A name="PutByte.2(837)"></A>: 
       (# val: @int8;
          byteno: @int32;
       enter(byteno,val)
       do val %putByteAt (ptr+byteno)
       #);
     <B>GetShort</B><A name="ExternalRecord.1:GetShort.2(838)"></A><A name="GetShort.2(838)"></A>: 
       (# byteno: @int32;
       enter byteno
       exit %getShortAt (ptr+byteno)
       #);
     <B>GetSignedShort</B><A name="ExternalRecord.1:GetSignedShort.2(839)"></A><A name="GetSignedShort.2(839)"></A>: 
       (# byteno: @int32;
       enter byteno
       exit %getSignedShortAt (ptr+byteno)
       #);
     <B>PutShort</B><A name="ExternalRecord.1:PutShort.2(840)"></A><A name="PutShort.2(840)"></A>: 
       (# val: @int16;
          byteno: @int32;
       enter(byteno,val)
       do val %putShortAt (ptr+byteno)
       #);
     <B>GetLong</B><A name="ExternalRecord.1:GetLong.2(841)"></A><A name="GetLong.2(841)"></A>: 
       (# byteno: @int32
       enter byteno
       exit %getLongAt (ptr+byteno)
       #);
     <B>PutLong</B><A name="ExternalRecord.1:PutLong.2(842)"></A><A name="PutLong.2(842)"></A>: 
       (# val: @int32;
          byteno: @int32
       enter(byteno,val)
       do val %putLongAt (ptr+byteno)
       #);
     
     <B>ExternalRecordField</B><A name="ExternalRecord.1:ExternalRecordField.2(843)"></A><A name="ExternalRecordField.2(843)"></A>: 
       (* For declaring fields in ExternalRecords *)
       (# pos:&lt; IntegerValue; 
          p: @pos;
       #);
     <B>Byte</B><A name="ExternalRecord.1:Byte.2(844)"></A><A name="Byte.2(844)"></A>: ExternalRecordField
       (# set: @(# val: @int8 enter val do val %putByteAt (ptr+p) #)
       enter set
       exit %getByteAt (ptr+p)
       #);
     <B>Short</B><A name="ExternalRecord.1:Short.2(845)"></A><A name="Short.2(845)"></A>: ExternalRecordField
       (# set: @(# val: @int16 enter val do val %putShortAt (ptr+p) #);
       enter set
       exit %getShortAt (ptr+p)
       #);
     <B>SignedShort</B><A name="ExternalRecord.1:SignedShort.2(846)"></A><A name="SignedShort.2(846)"></A>: ExternalRecordField
       (# set: @(# val: @int16 enter val do val %putShortAt (ptr+p) #);
       enter set
       exit %getSignedShortAt (ptr+p)
       #);
     <B>Long</B><A name="ExternalRecord.1:Long.2(847)"></A><A name="Long.2(847)"></A>: ExternalRecordField
       (# val: @int32;
          set: @(# enter val do val %putLongAt (ptr+p) #);
       enter set
       exit %getLongAt (ptr+p)
       #);
     <B>DoubleLong</B><A name="ExternalRecord.1:DoubleLong.2(848)"></A><A name="DoubleLong.2(848)"></A>: ExternalRecordField
       (# v1,v2: @int32; 
          set: @(# enter(v1,v2) 
                do v1 %putLongAt (ptr+p);
                   v2 %putLongAt (ptr+p+4);
                #);
       enter set
       exit (%getLongAt (ptr+p), %getLongAt (ptr+p+4))
       #);
  #) (* ExternalRecord *);

<B>makeCBF</B><A name="makeCBF.1(849)"></A>: External
  (* Call this external to install a callback and get
   * an int32 pointer to it.
   *)
  (# <B>pat</B><A name="makeCBF.1:pat.2(850)"></A><A name="pat.2(850)"></A>: ##External;
     <B>cb</B><A name="makeCBF.1:cb.2(851)"></A><A name="cb.2(851)"></A>: @int32;
  enter pat##
  exit cb
  #);

<B>freeCBF</B><A name="freeCBF.1(852)"></A>: External
  (* Call this external with an int32 pointer to an installed
   * callback (obtained via MakeCBF) when it is certain that the
   * callback will NOT be called again.
   * This will free BETA heap space associated with the callback.
   *)
  (# <B>cbf</B><A name="freeCBF.1:cbf.2(853)"></A><A name="cbf.2(853)"></A>: @int32;
  enter cbf
  #)
</PRE>
<!---------------------------------------------------------->
<HR>
<P></P>
<TABLE cols=3 border=0 width=100%>
<TR>
<TD width="33%" align="left"><ADDRESS>Interface Description</ADDRESS></TD>
<TD width="34%" align="center"><FONT size=-1>&COPY; <A HREF="http://www.mjolner.com">Mj&oslash;lner Informatics</A></FONT></TD>
<TD width="33%" align="right"><FONT size=-1><SCRIPT LANGUAGE=JavaScript SRC="../../javascript/lastmod.js"></SCRIPT></FONT></TD>
</TABLE>
<P></P>
<A HREF="unixfile.html"><IMG ALIGN=BOTTOM SRC="../../images/next.gif" ALT=Next BORDER=0></A>
<A HREF="timehandler.html"><IMG ALIGN=BOTTOM SRC="../../images/prev.gif" ALT=Previous BORDER=0></A>
<A HREF="../index.html"><IMG ALIGN=BOTTOM SRC="../../images/top.gif" ALT=Top BORDER=0></A>
<A HREF="index.html"><IMG ALIGN=BOTTOM SRC="../../images/content.gif" ALT=Content BORDER=0></A>
<A HREF="inx.html"><IMG ALIGN=BOTTOM SRC="../../images/index.gif" ALT=Index BORDER=0></A>
</BODY>
</HTML>
