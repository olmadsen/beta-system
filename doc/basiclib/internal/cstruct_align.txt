Subject: Mac og cstructs.
Date: Fri, 8 Oct 1999 19:47:57 +0200

Nu har jeg et andet problem med CStruct
I en cstruct er der et felt der hedder 
   Long: CstructField
     (#
     ...
     exit (p div 4) -> R.%getLong
     #)
Dette har aabenbart en helt anden semantik end det plejer
at have.
Sagen er at de fleste toolbox strukturer er 2-byte aligned.
Det betyder at fx EventRecord ser saaledes ud:
    struct EventRecord {
       short what;
       long message;
       ...
    }    
"what" feltet fylder 2 byte og message feltet fylder 4 byte.
Denne struktur er erklaeret i beta:
   EventRecord: cStruct
     (#  what: Short(# pos:: (# do 0 -> value #);  #);
          message: Long(# pos:: (# do 2  -> value #);  #);
          ...
     #);
Det plejer at virker, men ikke laengere!
Hvis jeg skriver 
   %getLongAt  (@@event.R[1] + 2)
saa faar jeg faktisk den rigtige vaerdi.
Det betyder at "cstruct" er blevet uandvendelig til at interface til
macens toolbox.
Kan nogen af jer forklare hvad der foregaar i den nye cstruct?
--
Michael


-----------------------------------


Subject: Re: Mac og cstructs.
To: Michael Lassen <henryml@cs.au.dk>
Date: Sun, 10 Oct 1999 20:29:16 +0200 (MET DST)

Det er ganske rigtigt sådan at cstruct og external record er blevet
ændret for 4-5 måneder siden.
Den gamle implementation af Long var:
  Long: (* Used for declaring CStruct fields *)
    (# p: @pos; pos:< IntegerObject; val: @integer;
       set: @(# enter val do (R,p,val)->TOS'%inxPutLong' #);
    enter set
    exit (R,p)->TOS'%inxGetLong'
    #);
Erstatningen for TOS'%inxGetLong' er R.%getLong
(se http://www.cs.au.dk/~olm/DOC/unsafe.html#inxget).
Og som somtalt i denne URL er der ændret på adresse konventionen.
Du har nok ret i at CStrct bør rettes til at bruge %getLongAt istedet
da man ellers ikke vil kunne accesse unaligned longs med den.

/Peter
