ORIGIN 'ntitypes';
BODY 'private/registrybody';

(****************************************************
 *       registry.bet                               
 * 
 * Read values from the NT registry.
 ****************************************************)
-- lib: attributes --

HKEY_CLASSES_ROOT:     (# exit 16x80000000 #);
HKEY_CURRENT_USER:     (# exit 16x80000001 #);
HKEY_LOCAL_MACHINE:    (# exit 16x80000002 #);
HKEY_USERS:            (# exit 16x80000003 #);
HKEY_PERFORMANCE_DATA: (# exit 16x80000004 #);

(*
 * Predefined Value Types. From winnt.h
 *)

REG_NONE:                       (# exit  0 #);   (* No value type *)
REG_SZ:                         (# exit  1 #);   (* Unicode nul terminated string *)
REG_EXPAND_SZ:                  (# exit  2 #);   (* Unicode nul terminated string 
                                                 * (with environment variable references) *)
REG_BINARY:                     (# exit  3 #);   (* Free form binary *)
REG_DWORD:                      (# exit  4 #);   (* 32-bit number *)
REG_DWORD_LITTLE_ENDIAN:        (# exit  4 #);   (* 32-bit number (same as REG_DWORD) *)
REG_DWORD_BIG_ENDIAN:           (# exit  5 #);   (* 32-bit number *)
REG_LINK:                       (# exit  6 #);   (* Symbolic Link (unicode) *)
REG_MULTI_SZ:                   (# exit  7 #);   (* Multiple Unicode strings *)
REG_RESOURCE_LIST:              (# exit  8 #);   (* Resource list in the resource map *)
REG_FULL_RESOURCE_DESCRIPTOR:   (# exit  9 #);   (* Resource list in the hardware description *)
REG_RESOURCE_REQUIREMENTS_LIST: (# exit 10 #);

readFromRegistry:
  (# private: @<<SLOT ReadFromRegistryPriv:descriptor>>;
     
     subKeyName: ^Text; 
     HKEY_val: @Integer;
     valueName, value: ^Text;      
     
     NoSuchKey:< (# do INNER #); (* Exceptions *)
     NoSuchValue:< (# do INNER #);
     otherError:< (# do INNER #);

  enter (HKEY_val, subKeyName[], valueName[])
  do private;
  exit value[]
  #);

(*************************************************************************
  Function: SetRegKeyValue

  Summary:  Utility function to set a Key, Subkey, and value
            in the system Registry under a given root.

 Args:      root: @integer;
            key: ^text;
            subkey: ^text;
            value: ^text;

 Returns:  TRUE if success; FALSE if not.
 *************************************************************************)

SetRegKeyValue:
  (# root: @integer;
     key: ^text;
     subkey: ^text;
     valueType: @integer; (* One of the REG_ constants defined above 
                           * Currently only implemented for REG_SZ and 
                           * REG_DWORD.
                           *)
     valueName: ^text;
     value: ^object;
     res: @boolean;
     
     noSuchRoot:< (# do INNER #); (* Exceptions *)
     createKeyFailed:< (# msg: ^text; enter msg[] do INNER #);
     setValueFailed:< (# msg: ^text; enter msg[] do INNER #);
     otherError:< (# do INNER #);
     
     (* private *)
     ec: @integer;
     hKey: @integer;
     szKey: ^text;
     textValue: ^text;
     intValue: ^integerObject;
     intVal: @integer;
  enter (root,key[],subkey[],valueType,valueName[],value[])
  <<SLOT SetRegKeyValueImpl: doPart>>
  exit res
  #);

DeleteRegKey:
  (# hKey: @integer; (* handle to open key *)
     subKey: ^text;   (* name of subkey to delete *)
     res: @boolean;
     
     failed:< (# msg: ^text; enter msg[] do INNER #);
     
     (* private *)
     ec: @integer;
  enter (hKey, subKey[])
  <<SLOT DeleteRegKeyImpl: doPart>>
  exit res
  #);

EnumKeys:
  (# hKey: @integer; (* handle of key to enumerate *)
     index: @integer; (* index of subkey to enumerate *)
     subKeyName: ^text; (* address of buffer for subkey name *);
     className: ^text; (* address of buffer for class string *)
     res: @integer;
  enter (hKey, index, subKeyName[], className[])
  <<SLOT EnumKeysImpl: doPart>>
  exit res
  #);
     

QueryRegInfoKey:
  (# root: @integer; (* HKEY_CLASSES_ROOT or 
                      * HKEY_CURRENT_CONFIG or 
                      * HKEY_CURRENT_USER or 
                      * HKEY_LOCAL_MACHINE or 
                      * HKEY_USERS
                      *);

     keyName: ^text; (* name of key to query *)
     className: ^text; (* address of buffer for class string *)
     
     res: @integer; (* response code res = ERROR_SUCCESS -> success. *)
     cSubKeys: @integer; (* number of subkeys contained by the specified key *)
     cValues: @integer; (* the number of values associated with the key *)
     
  enter (root, keyName[], className[])
  <<SLOT QueryRegInfoKeyImpl: doPart>>
  exit (res, cSubKeys, cValues)
  #);

