ORIGIN '~beta/guienv/guienv';
LIB_DEF 'valhalstackview' '../../lib';
INCLUDE '../remotedumper'
        '../componentstack'
        '../processInterface'
        '~beta/basiclib/formatio'
        '~beta/toollibs/UI/listmoveable'
        '~beta/toollibs/UI/moveable'
        '~beta/toollibs/UI/icons'
        '~beta/toollibs/utils/options'
        '~beta/objectbrowser/UI/objectview';
BODY 'private/stackviewbody';
(*
 * COPYRIGHT
 *   Copyright (C) Aarhus University
 *   All rights reserved.
 *)
-- guienvlib: Attributes --
stackviewlistList: List
  (# (*element:: stackViewList;*)
     onInsert:<
       (# theStackviewList: ^window.stackViewList; 
       enter theStackviewList[]
       do INNER
       #);
     onDelete:<
       (# theStackviewList: ^window.stackViewList; 
       enter theStackviewList[]
       do INNER
       #);
     newscan: scan
       (# cur: ^window.stackViewList;  do current[]->cur[]; INNER ;  #);
     
  #);
getstackviewlistList: objectPool.get
  (# type::< stackviewlistList; init::  (#  do obj.init #) #);
  

-- windowLib: Attributes --
stackviewStack: componentStack
  (#
     codeTypes: [1] @Integer;
     viewIndex: [1] @Integer;
     viewText: [1] ^Text;
     lineCount: @Integer;
     
  #);
unknownCode: (#  exit 0 #);
betaCode: (#  exit 1 #);
Gcode: (#  exit 2 #);
Ccode: (#  exit 3 #);
attCode: (#  exit 4 #);
caller: (#  exit 5 #);
stackviewList: listmoveableList
  (#
     <<SLOT stackviewListLib:Attributes>>;
     open::< 
       (# 
       <<SLOT stackviewlistopen:DoPart>>
       #);
     close::<  (#  do <<SLOT stackviewlistclose:Descriptor>> #);
     eventHandler::< 
       (#
          onMouseDown::< 
            (# 
            do
               <<SLOT stackviewOnMouseDown:Descriptor>>
            #);
          onSelect::<  (#  do <<SLOT stackviewOnSelect:Descriptor>> #)
       #);
     encl: ^stackViewEncloser;
     getencloser:<
       (# theEncloser: ^stackViewEncloser
       do INNER ; theEncloser[]->encl[]; 
       exit theEncloser[]
       #);
     doUpdate::< 
       (# 
       <<SLOT stackviewlistdoupdate:DoPart>>
       #);
     onDeIconify::  (#  <<SLOT stackviewlistOnDeiconify:DoPart>> #);
     debuggee: ^processInterface;
     component:
       ^processInterface.
          remoteBetaObject;
     lastStack: ^stackviewStack;
     shortnames,shorttitle,numbernames: @Boolean;
     prefs:^preferences;
     objects: ^objectdb;
     updatedeferred: @Boolean;
     (* TRUE if an update was deferred due to this
      * stackview being iconified. *)
     debug: @Boolean;
     (* TRUE if extra debug information (for valhalla 
      * debugging) should be added to the stackview. *)
     svPrivate: @<<SLOT stackViewPrivate:Descriptor>>;
     
  #);
stackViewEncloser:
  (#
     gettarget:<
       (#
          debuggee: ^processInterface;
          component:
            ^processInterface.
               remoteBetaObject;
          
       do INNER
       exit (debuggee[],component[])
       #);
     openNewObjectView:< OpenObjectView;
     openNewCodeView:<
       (# cast: ^astInterface.ast;  enter cast[] do INNER #);
     openstackview:<
       (# comp: ^processInterface.remoteBetaObject
       enter comp[]
       do INNER
       #);
     selectObjectView:< OpenObjectView;
     selectCodeView:<
       (# cast: ^astInterface.ast;  enter cast[] do INNER #);
     selectExternalView:< (# msg: ^text;  enter msg[] do INNER #);
     settitle:< (# t: ^Text enter t[] do INNER #);
     tryclose:< Object;
     onHighLight:< Object;
     alertInfo:<
       (# inf,title: ^Text;  enter (inf[],title[]) do INNER #);
     
  #);
stackviewmoveable: listmoveable
  (#
     <<SLOT stackviewlib:Attributes>>;
     debuggee: ^processInterface;
     component:
       ^processInterface.remoteBetaObject;
     contentsType::< 
       (#
          listType::< stackviewList
            (#
               getencloser:: 
                 (# 
                 do
                    listEncloser[]
                      ->theEncloser[]
                 #)
            #);
          
       #);
     listEncloserType:< stackViewEncloser
       (#
          settitle:: 
            (# 
            do
               t[]
                 ->THIS(stackviewmoveable).title
            #);
          gettarget:: 
            (# 
            do
               THIS(stackviewmoveable).debuggee[]->debuggee[];
               THIS(stackviewmoveable).component[]->component[];
               
            #);
          tryclose::  (#  do THIS(stackviewmoveable).close #);
          onHighLight::  (#  do wriggle #);
          
       #);
     listEncloser: @listEncloserType;
     open::< 
       (# 
       enter (debuggee[],component[])
       do <<SLOT stackviewopen:Descriptor>>
       #);
     icon:: 
       (# 
       do
          'StackView_Icon'->(getIconDB).getIcon
            ->theIcon[];
          
       #);
     
  #);
  

