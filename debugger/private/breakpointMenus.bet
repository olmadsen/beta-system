ORIGIN '../valhallaapplication';
INCLUDE 'valhallabody'
        '../breakpointOperations'
        '~beta/editor/codeeditor';
LIB_ITEM 'valhalla';
(*
 * COPYRIGHT
 *   Copyright Mjolner Informatics, 1995-96
 *   All rights reserved.
 *)
(* FGC, Menuer skal ikke saettes op, da ymersiflib goer dette. *)

-- OnCodeViewOpenAppendAction:doPart --
do
   &thecodeviewer.contents.action
   (#
      eventtype:: thecodeviewer.contents.theeventhandler.mouseDown;
      breakpointsMenu: @breakpointController
        (#
           getFocus:: 
             (# i: @integer
             do thecodeviewer.sifviewer.cs->(node[],i,i,i)
             #);
           getCfe:: 
             (# 
             do
                (if thecodeviewer.sifviewer[] <> none then
                    thecodeviewer.sifviewer[]->fe[]
                if)
             #);
           infoMsg::  (#  do msg[]->sources.infoView.msg #);
           newCodeView::  (#  do node[]->newcodemoveable #);
           m: ^gui.menu
        #)
   do
      (if not theevent.doubleClick then
          (if theevent.buttonstate = 3 then
              (if theevent.shiftkey then
                  (* Motif bug: does not install translations for popup menu
                   * until activated the first time
                   *)
                  (if thecodeviewer.sifViewer.thePopupMenu[] = none then
                      &sources.ymerbrowser.codeEditorPopupMenu[]
                        ->thecodeviewer.sifViewer.thePopupMenu[];
                      thecodeviewer.sifViewer[]
                        ->thecodeviewer.sifViewer.thePopupMenu.attach;
                      thecodeviewer.sifViewer.thePopupMenu.open
                  if);
                  
               else
                  (* Motif bug: does not install translations for popup menu
                   * until activated the first time
                   *)
                  (if this(valhallaGui).isdebugging then
                      (if thecodeviewer.sifViewer.thePopupMenu[] <> none then
                          thecodeviewer.sifViewer.thePopupMenu.close;
                          none ->thecodeviewer.sifViewer.thePopupMenu[]
                      if);
                      (if breakPointsMenu.m[] = none then
                          breakpointsMenu.init;
                          &breakPointsMenu.breakPopupMenu[]
                            ->breakPointsMenu.m[];
                          breakPointsMenu.m.open;
                          
                      if);
                      (1,theevent.localposition,thecodeviewer.contents[])
                        ->breakPointsMenu.m.popup
                  if)
              if)
          if)
      if)
   #)[]->thecodeviewer.contents.prependAction;   

(*
-- onCodeViewOpen: DoPart --
do
   &thecodeview.contents.action
     (#
        eventtype:: thecodeview.contents.theeventhandler.mouseDown;
        breakpointsMenu: @breakpointController
          (#
             getFocus:: 
               (# i: @integer
               do thecodeview.sifviewer.cs->(node[],i,i,i)
               #);
             getCfe:: 
               (# 
               do
                  (if thecodeview.sifviewer[] <> none then
                      thecodeview.sifviewer[]->fe[]
                  if)
               #);
             infoMsg::  (#  do msg[]->browser.infoView.msg #);
             newCodeView::  (#  do node[]->newcodemoveable #);
             m: ^menu;
             
          #)
     do
        (if not theevent.doubleClick then
            (if theevent.buttonstate = 3 then
                (if theevent.shiftkey then
                (* Motif bug: does not install translations for popup menu
                 * until activated the first time
                 * )
                    (if thecodeview.sifViewer.thePopupMenu[] = none then
                        &codeEditorPopupMenu[]
                          ->thecodeview.sifViewer.thePopupMenu[];
                        thecodeview.sifViewer[]
                          ->thecodeview.sifViewer.thePopupMenu.attach;
                        thecodeview.sifViewer.thePopupMenu.open
                    if);
                    
                 else
                (* Motif bug: does not install translations for popup menu
                 * until activated the first time
                 * )
                    (if isdebugging then
                        (if thecodeview.sifViewer.thePopupMenu[] <> none then
                            thecodeview.sifViewer.thePopupMenu.close;
                            none ->thecodeview.sifViewer.thePopupMenu[]
                        if);
                        (if breakPointsMenu.m[] = none then
                            breakpointsMenu.init;
                            &breakPointsMenu.breakPopupMenu[]
                              ->breakPointsMenu.m[];
                            breakPointsMenu.m.open;
                            
                        if);
                        (1,theevent.localposition,thecodeview.contents[])
                          ->breakPointsMenu.m.popup;
                        
                    if);
                    
                if);
                
            if);
            
        if);
        
     #)[]->thecodeview.contents.appendAction;
  *)
-- mycodeviewOpen: DoPart --
do
   &action
     (#
        eventtype:: contents.editor.contents.theeventhandler.mouseDown;
        breakPointsMenu: @ (*FGC, gui.*) breakpointController
          (#
             getFocus:: 
               (# i: @integer do private.cfe.cs->(node[],i,i,i) #);
             getCfe::  (#  do private.cfe[]->fe[] #);
             infoMsg::  (#  do msg[]-> (*FGC, gui.*) putinfo #);
             newCodeView::  (#  do node[]->newcodemoveable #);
             m: ^ (*FGC, gui.*) gui.menu;
             
          #)
     do
        contents.editor[]->lastEditor[];
        (if not theevent.doubleClick then
            (if theevent.buttonstate = 3 then
                (if theevent.shiftkey then
                (* Motif bug: does not install translations for popup menu
                 * until activated the first time
                 *)
                    (if contents.editor.sifViewer.thePopupMenu[] = none then
                        & (*FGC, gui.*) main.codeEditorPopupMenu[]
                          ->contents.editor.sifViewer.thePopupMenu[];
                        contents.editor.sifViewer[]
                          ->contents.editor.sifViewer.thePopupMenu.attach;
                        contents.editor.sifViewer.thePopupMenu.open
                    if);
                    (if not isdebugging then
                        (1,theevent.localposition,contents[])
                          ->contents.editor.sifViewer.thePopupMenu.popup;
                        
                    if);
                    
                 else
                (* Motif bug: does not install translations for popup menu
                 * until activated the first time
                 *)
                    (if isdebugging then
                        (if breakPointsMenu.m[] = none then
                            breakpointsMenu.init;
                            &breakPointsMenu.breakPopupMenu[]
                              ->breakPointsMenu.m[];
                            breakPointsMenu.m.open;
                            
                        if);
                        (1,theevent.localposition,contents.editor.contents[])
                          ->breakPointsMenu.m.popup;
                        
                    if)
                if);
                
            if)
        if)
     #)[]->contents.editor.contents.prependAction;
   (*
    -- guiMenubarTypeOpen: DoPart --
    do
    INNER ;
    *)
     

-- mainTypeMenubarTypeOpen: DoPart --
do
   INNER ;
   &
     (#
        breakPointsMenu: @breakpointController
          (#
             getFocus:: 
               (# i: @integer
               do (if sources[]<>none then
                      sources.cfe.cs->(node[],i,i,i)
                   else
                      lastEditor.sifviewer.cs->(node[],i,i,i)
                  if);
               #);
             getCfe:: 
               (# 
               do
                  (if lastEditor[] <> none then
                      lastEditor.sifviewer[]->fe[]
                  if)
               #);
             infoMsg::  (#  do msg[]-> (*FGC, gui.*) putinfo #);
             newCodeView::  (#  do node[]->newcodemoveable #);
             m: ^ (*FGC, gui.*) gui.menu
          #)
     do
        breakpointsMenu.init;
        &breakpointsMenu.controlMenu[]->breakpointsMenu.m[];
        breakpointsMenu.m.open;
        'Control'->breakpointsMenu.m.name;
        breakpointsMenu.m[]->append;
        &breakpointsMenu.breakPulldownMenu[]->breakpointsMenu.m[];
        breakpointsMenu.m.open;
        'BreakPoints'->breakpointsMenu.m.name;
        breakpointsMenu.m[]->append;
        
     #)
     (*
      -- workspaceMenubarOpen: DoPart --
      do
      INNER ;
      &
      (#
      breakPointsMenu: @breakpointController
      (#
      getFocus:: 
      (# i: @integer do THIS(workspace).cfe.cs->(node[],i,i,i) #);
      getCfe::  (#  do THIS(workspace).cfe[]->fe[] #);
      infoMsg::  (#  do msg[]-> (*FGC, gui.* ) putinfo #);
      newCodeView::  (#  do node[]->newcodemoveable #);
      m: ^ (*FGC, gui.* ) menu;
      
      #);
      
      do
      breakpointsMenu.init;
      &breakpointsMenu.controlMenu[]->breakpointsMenu.m[];
      breakpointsMenu.m.open;
      'Control'->breakpointsMenu.m.name;
      breakpointsMenu.m[]->append;
      &breakpointsMenu.breakPulldownMenu[]->breakpointsMenu.m[];
      breakpointsMenu.m.open;
      'BreakPoints'->breakpointsMenu.m.name;
      breakpointsMenu.m[]->append;
      
      #);
      *)
     (*    
      -- codeViewWindowMenubarOpen: DoPart --
      do
      &
      (#
      breakPointsMenu: @breakpointController
      (#
      getFocus:: 
      (# i: @integer
      do THIS(codeViewWindow).fe.cs->(node[],i,i,i)
      #);
      getCfe::  (#  do THIS(codeViewWindow).fe[]->fe[] #);
      infoMsg::  (#  do msg[]-> (*FGC, gui.* ) putinfo #);
      newCodeView::  (#  do node[]->newcodemoveable #);
      m: ^ (*FGC, gui.* ) menu;
      
      #)
      do
      breakpointsMenu.init;
      &breakpointsMenu.controlMenu[]->breakpointsMenu.m[];
      breakpointsMenu.m.open;
      'Control'->breakpointsMenu.m.name;
      breakpointsMenu.m[]->append;
      &breakpointsMenu.breakPulldownMenu[]->breakpointsMenu.m[];
      breakpointsMenu.m.open;
      'BreakPoints'->breakpointsMenu.m.name;
      breakpointsMenu.m[]->append;
      
      #);
      *)  

-- processInterfaceLoadBreakpoints: DoPart --
do
     (#
        bml: ^breakManagerList;
        bm: ^breakManager;
        bc: @breakpointcontroller;
        
     do
        getBreakManagerList->bml[];
        breakpoints[]
          ->bml.readbreakpointsfromstream
            (# mtime: @integer; 
            do
               (fgname[]->mps.fragmentGroupTable.getFragmentGroup).modtime
                 ->mtime;
               (if mtime = modtime then
                   (fgname[],modtime,ffName[],index,breakType[],message[])
                     ->bc.setBreak
               if);
               
            #);
        
     #);
     

-- processInterfaceSaveBreakpoints: DoPart --
do
     (# bml: ^breakManagerList; bm: ^breakManager; 
     do
        &text[]->breakpoints[];
        getBreakManagerList->bml[];
        breakpoints[]->bml.writebreakpointstostream;
        
     #);
     

