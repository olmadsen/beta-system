ORIGIN '~beta/basiclib/v1.4/betaenv';

--- lib:attributes ---

(* OPCODES
 * ======= *)

(* Opcodes for communication from valhalla to debugged process.
 * VOP_* constants are replicated in ~betarun/C/valhallaComm.c
 * 
 * VOP is an acronym for Valhalla OPcode. *)

VOP_SCANGROUPS:        (# exit  1 #);
VOP_KILL:              (# exit  2 #);
VOP_GETDATAMEM:        (# exit  3 #);
VOP_GETINSTRUCTIONMEM: (# exit  4 #);
VOP_SETDATAMEM:        (# exit  5 #);
VOP_GETDATAWORDS:      (# exit  6 #);
VOP_CONTINUE:          (# exit  7 #);
VOP_DOTINSERT:         (# exit  9 #);
VOP_GETPROTOINFO:      (# exit 10 #);
VOP_DOTDELETE:         (# exit 11 #);
VOP_SCANSTACK:         (# exit 12 #);
VOP_OBJADRCANONIFY:    (# exit 13 #);

printOpCode:
  (# opcode: @Integer; s: ^Stream;
  enter (opcode,s[])
  do 
     (if opcode
      //VOP_SCANGROUPS then 'VOP_SCANGROUPS'->s.putText;
      //VOP_KILL then 'VOP_KILL'->s.putText;
      //VOP_GETDATAMEM then 'VOP_GETDATAMEM' ->s.putText;
      //VOP_GETINSTRUCTIONMEM then 'VOP_GETINSTRUCTIONMEM' ->s.putText;
      //VOP_SETDATAMEM then 'VOP_SETDATAMEM' ->s.putText;
      //VOP_GETDATAWORDS then 'VOP_GETDATAWORDS' ->s.putText;
      //VOP_CONTINUE then 'VOP_CONTINUE' ->s.putText;
      //VOP_DOTINSERT then 'VOP_DOTINSERT' ->s.putText;
      //VOP_GETPROTOINFO then 'VOP_GETPROTOINFO' ->s.putText;
      //VOP_SCANSTACK then 'VOP_SCANSTACK' -> s.putText;
      //VOP_OBJADRCANONIFY then 'VOP_OBJADRCANONIFY'->s.putText
      else
         'UNKNOWN OPCODE'->s.putText;
     if)
  #);


(* Opcodes for communication from debugged process to valhalla. *)

VOP_STOPPED:           (# exit 50 #);

(* Possible stack locations returned from VOP_SCANSTACK.
 * CS_* constants are replicated in ~betarun/C/valhallaFindComp.h. *)

CS_PROCESSORSTACK:  (# exit 1 #); (* component stack on processor stack. *)
CS_ACTIVECOMPONENT: (# exit 2 #); (* component is the currently active.  *)
CS_STACKOBJ:        (# exit 3 #); (* component stack in stack object.    *)
CS_NOSTACK:         (# exit 4 #); (* component has no stack.             *)


printStackType:
  (# stackType: @Integer; s: ^Stream;
  enter (stackType,s[])
  do (if stackType
      //CS_PROCESSORSTACK then 'CS_PROCESSORSTACK'->s.putText
      //CS_ACTIVECOMPONENT then 'CS_ACTIVECOMPONENT'->s.putText
      //CS_STACKOBJ then 'CS_STACKOBJ'->s.putText
      //CS_NOSTACK then 'CS_NOSTACK'->s.putText
      else
         'UNKNOWN STACKTYPE'->s.putText;
     if);
  #)

(* PROTOCOL SPECIFICATION
 * ======================
 *
 * 
 * VOP_SCANGROUPS:
 * ===============
 * 
 *   Functionality: Scans over all data segments statically linked into
 *                  process.
 *   Parameters: NONE.
 *   Returns: 1. VOP_SCANGROUPS. (For consistency check.)
 *            2. For each group the following is returned:
 *                 groupName (as found in data segment)
 *                 dataStart (virtual start address for data segment)
 *                 dataEnd (first virtual address after data segment)
 *                 codeStart (virtual start address for code segment)
 *                 codeEnd (first virtual address after code segment)
 *            3. After the last group an empty string is returned.
 * 
 * VOP_KILL:
 * =========
 *   
 *    Functionality: Makes the debugged process kill itself.
 *    Parameters: NONE.
 *    Returns: VOP_KILL. (For acknowledgement.)
 * 
 * VOP_GETDATAMEM:
 * ===============
 * 
 *    Functionality: Reads a range of the process' data memory.
 *    Parameters: address and length in bytes.
 *    Returns: 1. VOP_GETDATAMEM. (For consistency check)
 *             2. The memory bytes pointed out by parameters.
 * 
 * VOP_GETINSTRUCTIONMEM:
 * ======================
 * 
 *    Functionality: Reads a range of the process' instruction memory.
 *    Parameters: address and length in bytes.
 *    Returns: 1. VOP_GETINSTRUCTIONMEM. (For consistency check.)
 *             2. The memory bytes pointed out by parameters.
 * 
 * VOP_GETDATAWORDS:
 * =================
 *    Functionality: Reads memory cells in process' data memory pointed out
 *                   by a list of addresses.
 *    Parameters: Zero terminated list of addresses.
 *    Returns: 1. VOP_GETDATAWORDS. (For consistency check.)
 *             2. Values read.
 * 
 * VOP_SETDATAMEM:
 * ===============
 * 
 *    Functionality: Writes a range of the process' data memory.
 *    Parameters: 1. address.
 *                2. Number of bytes to write.
 *                3. values of bytes to write.
 *    Returns: 1. VOP_SETDATAMEM (For consistency check.)
 * 
 * VOP_CONTINUE:
 * =============
 * 
 *    Functionality: Make the process continue after being stopped.
 *    Parameters: None.
 *    Returns: 1. VOP_CONTINUE
 * 
 * VOP_STOPPED:
 * ============
 *  
 *    Functionality: Informs valhalla that the process has stopped and
 *                   is ready to continue.
 *    Parameters: 1. PC value when process stopped.
 *                2. Current Object.
 *                3. Current Component.
 *                4. Current Stack Pointer.
 *                5. Signal received. 0 if no signal was received.
 *                6. Zero terminated textual signal description.
 *                7. Runtime error number (betaerror.h). 0 if not a runtime
 *                   error.
 *                8. Iff error number <> 0: Textual error description.
 *                9. -1 terminated list of (DOTindex,VirtualAddress) pairs of 
 *                   DOT entries belonging to valhalla and corresponding 
 *                   object addresses for objects that are still alive (or 
 *                   just not yet known to be garbage). Indices not found in
 *                   this list are implicitly garbage.
 * 
 *    Valhalla returns: VOP_STOPPED (For consistency check.)
 * 
 * VOP_DOTINSERT:
 * ==============
 * 
 *    Functionality: Asks the debugged process to insert an object into the
 *                   DOT table.
 * 
 *    Parameters: 1. Virtual address of object to insert.
 *    
 *    Returns:    1. VOP_DOTINSERT.
 *                2. DOT index of newly inserted object.
 *                3. Object size in longs of newly inserted object.
 * 
 * VOP_OBJADRCANONIFY
 * ==================
 * 
 *    Functionality: Checks whether the address given is really a reference
 *                   to the object part of a component. If so it returns the `
 *                   address adjusted of the component header.
 * 
 *    Parameters:  1. Virtual object address.
 *  
 *    Returns:     1. VOP_OBJADRCANONIFY.
 *                 2. Adjusted address.
 * 
 * VOP_DOTDELETE:
 * ==============
 *  
 *    Functionality: Asks the debugged process to delete an object from the
 *                   DOT table.
 * 
 *    Parameters: 1. DOT index that should be deleted.
 * 
 *    Returns:    1. VOP_DOTDELETE.
 * 
 * VOP_GETPROTOINFO:
 * =================
 * 
 *    Functionality: Information about prototypes in specific group.
 * 
 *    Parameters: 1. Virtual address of group_header for the group in question.
 *     
 *    Returns:    1. List of Mentry, Gentry, and (FormIndex,AstIndex) for all
 *                   prototypes in the group. The Tentries are not returned
 *                   by this call since they are read using peekMemoryLongs,
 *                   i.e. VOP_GETDATAMEM. Valhalla knows the number of
 *                   prototypes, and thus the length of the list.
 *                2. VOP_GETPROTOINFO.
 *                
 * VOP_SCANSTACK:
 * ==============
 * 
 *    Functionality: Scans the stack corresponding to a component object.
 * 
 *    Parameters: 1. Virtual address of the component object.
 * 
 *    Returns:    1. Current location of component stack. 
 *                   Possible values are CS_PROCESSORSTACK, CS_ACTIVECOMPONENT,
 *                   CS_STACKOBJ or CS_NOSTACK.
 *                2. List (returnAdr,returnObj) pairs found on the stack of
 *                   the component. See scanComponentStack in 
 *                   valhallaFindComp.h
 *                3. (-1)
 *                4. VOP_SCANSTACK
 *)


