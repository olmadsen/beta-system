ORIGIN '~beta/basiclib/basicsystemenv' (*
 * COPYRIGHT
 *   Copyright (C) Aarhus University
 *   All rights reserved.
 *)
;
INCLUDE '~beta/guienv/guienvsystemenv'
        'valhallaapplication'
        'processInterface'
        'processCommCodes'
        'breakpoints'
        'UI/GUIprocess'
        'UI/stackview'
        'UI/stackbrowser'
        'UI/objectviewadds'
        'UI/enveditor'
        '~beta/guienv/utils/promptForArgs'
        '~beta/toollibs/utils/options'
        '~beta/toollibs/utils/systemenvcompspawner'
        '~beta/guienv/stddialogs'
        '~beta/guienv/utils/simplemenu'
        '~beta/process/systemcomm'
        '~beta/objectbrowser/UI/evaluatormoveable'
        '~beta/compiler/DYN/dynlib'
        '~beta/compiler/DYN/AstOfObject'
        '~beta/compiler/DYN/treelib'
        '~beta/pretty/astviewer' 'valhallaparams'
        '~beta/sourcebrowser/ymer';
BODY 'private/valhallabody';
BODY 'private/breakpointMenus';
BODY 'private/dynamic_compilation';
BODY 'private/valhallabodyext';
BODY '~beta/editor/private/compiler'
     '~beta/editor/private/nouser';
-- lib: Attributes --
DEFAULT_SIZE: (#  exit (250,250) #);   

-- program: Descriptor --
(#
   <<SLOT valhallalib:Attributes>>;
   thesystemenv: @|systemenv
     (#
        setWindowEnv:: 
          (#  do gui[]->theWindowEnv[] #);
        
     do
        gui[]->ymer.init;
        setupValhalla;
        myCallBack[]->ymer.newBrowserCallBack[];
        ymer.newbrowser;
        (if noOfArguments>1 then 
            parseValhallaParams;
            NoOfArguments->arguments->valhalla.externalInterface.debugProgram;
        if);
     #);
   gui: @guienv (#  #);
   ymer: @ymerenv (# editmode:: WriteMode #);
   myCallBack: @gui.BrowserCallBack
     (# 
     do
        (if not valhalla.first then
            BrowserInt[]->valhalla.sources[];
            valhalla.valhallainit;
            true->valhalla.first
        if);
        &ymerCall
        (#
           getFragmentGroup:: 
             (# 
             do name[]->ymer.mps.fragmentGroupTable.getFragmentGroup->fg[]
             #);
           machineType::  (#  do machine_type->t[] #)
        #)[]->ymerCallback[]
     #);
   valhalla: ^myvalhalla;
   setupValhalla:
     (# 
     do
        &myvalhalla[]->valhalla[];
        valhallaPrefs.open
          (# 
          do
             valhallaprefs.
               registerVALHALLAoptions;
             
          #);
        valhallaPrefs[]->objectpool.put;
        valhallaPrefs[]->valhalla.valhallaPrefs[];
        valhalla.globaloptions.init;
        valhalla.globaloptions[]->objectpool.put;
        valhallaprefs[]->obp.p[];
        obp[]->objectpool.put
     #);
   myvalhalla: thesystemenv.valhallaapplication
     (#
        first: @boolean;
        titleText: (#  exit 'Valhalla - Source Level Debugger ' #);
        editMode::  (#  do false->value;  #);
        valhallainit:
          (# 
          do
             'valhallainit'->putline;
             ymer.gui[]->gui[];
             ymer.mps[]->mps[];
             true->isStandAloneValhalla->isDebugging;
             init;
             true->valhallaPrefs.dynamiccompilation; 
             main.open;
             INNER ;
             main.theMenuBar->main.mainMenuBar[];
             (*     (if sources[]<>none then
              &ymerCall
              (#
              getFragmentGroup:: 
              (# 
              do name[]->mps.fragmentGroupTable.getFragmentGroup->fg[]
              #);
              machineType::  (#  do machine_type->t[] #);
              
              #)[]->sources.edenv.ymerCallback[];
              sources.loadSettings;
              if);
              *)
             
          #);
        afterInit::<  (#  #);
        
     do true->isStandAloneValhalla; true->valhallaPrefs.dynamiccompilation; 
     #);
   valhallaPrefs: @valhallaPreferences;
   mjolnerPrefs: @mjolnerPreferences;
   obp: @objectPreferences;
   
do &expandWildcardsArgumentHandler[]->argumentHandler[]; thesystemenv; 
#)  

