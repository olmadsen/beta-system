ORIGIN '~beta/basiclib/v1.4/basicsystemenv';
BODY '~beta/guienv/v1.2/private/X11/guienvxsystemenvbody';

INCLUDE '~beta/guienv/v1.2/guienv';

INCLUDE '~beta/objectbrowser/v2.0/systemenvcoroutinespawner';
INCLUDE '~beta/objectbrowser/v2.0/windowedbrowser';
INCLUDE '~beta/objectbrowser/v2.0/options';
INCLUDE '~beta/objectbrowser/v2.0/optionlist';
INCLUDE '~beta/objectbrowser/v2.0/UI/icons';
INCLUDE '~beta/objectbrowser/v2.0/UI/iconlist';
INCLUDE '~beta/guienv/v1.2/fields';
INCLUDE '~beta/basiclib/v1.4/formatio';
INCLUDE '~beta/sysutils/v1.4/envstring';

INCLUDE '~beta/debugger/v2.0/valhalla_application_interface';

BETARUN default '~beta/debugger/v2.0/betarun/$/betarun.debug';

--- lib: attributes ---

initialMAINSize: (# exit (600,400) #);

--- program:descriptor ---
systemenv
(# setWindowEnv:: (# do gui[]->theWindowEnv[] #);
   
   thespawner: @systemenvspawner;
   
   gui: @guienv
     (# clr: @rectangle;
        clearInProgress: @Boolean;
        
        main: @window
          (# menuBarType::<
               (# fileMenu: @Menu
                    (# lastHumle: ^humle;
                       startValhallaItem: @menuitem
                         (# open:: (# do 'Start Valhalla'->name; #);
                            eventHandler::
                              (# onSelect::
                                   (# 
                                   do startValhalla
                                   #);
                                 onStatus::
                                   (# 
                                   do (connected_to_valhalla=0)->value;
                                   #);
                              #);
                         #);
                       breakItem: @menuitem
                         (# open:: (# do 'Break'->name; 'B'->key #);
                            eventHandler::
                              (# onSelect::
                                   (# ml: ^moveableList;
                                   do getMoveableList->ml[];
                                      @@lastHumle->TOS'%adrGetLong'->breakpoint;
                                   #);
                              #);
                         #);
                       errorItem: @menuitem
                         (# open:: (# do 'Error'->name #);
                            eventHandler::
                              (# onSelect::
                                   (# i: [1]@Integer;
                                   do i[2]->putInt
                                   #);
                              #);
                         #);
                       newItem: @menuitem
                         (# open:: (# do 'New' -> name; 'N' -> key #);;
                            eventHandler::
                              (# onSelect::<
                                   (# h: ^humle;
                                   do 
                                      &humle[]->h[]->lastHumle[];
                                      (10,'a',5,TRUE,4.5,main[]) -> h;
                                      h[]->browser.showObject;
                                   #)
                              #)
                         #);
                       closeItem: @menuitem
                         (# open:: (# do 'Close' -> name; 'W' -> key #);
                            eventHandler:: 
                              (# onSelect:: 
                                   (# m: ^moveableList;
                                   do getMoveableList -> m[];
                                      m.scan
                                      (#
                                      do (if clr->current.inRect then 
                                             current.close 
                                         if);
                                      #);
                                      clr -> objworld.browserDrawRect;
                                      false -> clearInProgress;
                                   #);
                                 onStatus:: (# do clearInProgress -> value #);
                              #)
                         #);
                       quitItem: @menuitem
                         (# open:: (# do 'Quit' -> name; 'Q' -> key #);
                            eventHandler:: (# onSelect::< (# do Terminate #)#)
                         #);
                       open::
                         (# 
                         do 'File' -> name;
                            startValhallaItem.open; startValhallaItem[]->append;
                            breakItem.open; breakItem[]->append;
                            errorItem.open; errorItem[]->append;
                            newItem.open; newItem[] -> append;
                            closeItem.open; closeItem[] -> append;
                            quitItem.open; quitItem[] -> append;
                         #);
                    #);
                  open::< (# do fileMenu.open; fileMenu[] -> append #)
               #);
             
             open::
               (# 
               do initialMAINsize -> size; 'Valhalla Test Program' -> title;
                  contents->info.open; contents->objworld.open;
                  objworld[]->browser.init;
               #);
             
             objworld: @Canvas
               (# open::
                    (# sz: @Point; tmp: @Point;
                    do initialMAINsize->sz;
                       info.size->tmp;
                       sz.v-tmp.v->sz.v;
                       sz->size;
                       TRUE->bindLeft->bindRight->bindBottom->bindTop;
                    #);
                  eventHandler::
                    (# onMouseDown::
                         (#
                         do (if buttonState
                             //1 then
                                (if clearInProgress then clr->browserDrawRect if);
                                localPosition->SimpleDefineRect->clr;
                                (if not clr.isEmpty then
                                    true -> clearInProgress;
                                    clr->browserDrawRect;
                                 else 
                                    false -> clearInProgress;
                                if);
                            if);
                         #);
                    #);
               #);
             
             info: @staticText
               (# open::<
                    (# sz: @Point; ts: ^TextStyle;
                       pos: @Point;
                    do 
                       style->ts[]; 
                       
                       InitialMAINsize->sz;
                       ts.lineHeight+6->sz.v;
                       sz->size;
                       
                       InitialMAINsize->pos;
                       0->pos.h;
                       pos.v-sz.v->pos.v;
                       pos -> Position;
                       
                       TRUE->bindLeft->bindRight->bindBottom; FALSE->bindTop;
                       
                       TRUE->border.visible;
                       borderStyles.shadowIn->border.style;
                    #);
               #);

             browser: @windowedbrowser
               (# init:: 
                    (# options: ^optionDB;
                    do getOptionDB -> options[];
                       (charRepOnALine,TRUE) -> options.setBooleanOption;
                       (invisibleOrigins,TRUE) -> options.setBooleanOption;
                    #);
                  mpsinterfaceType::
                    (# 
                       onOpenGroup::
                         (# t: ^Text;
                         do 'opening '->t[];
                            groupName[]->t.append;
                            t[]->main.info.label;
                            true->main.info.update;
                         #);
                       onOpenGroupDone::
                         (# 
                         do ''->main.info.label;
                            true->main.info.update;
                         #);
                       onOldGroup::
                         (#
                         do 'ERROR: "%s.%s" is older than "%s.%s". Recompile!!!\n'
                              -> putFormat
                            (# 
                            do groupName[]->s; AST.astFileExtension->s;
                               groupName[]->s; 'bet'->s;
                            #)
                         #);
                       onGroupNotFound::
                         (#
                         do 'ERROR: "%s.%s" not found !!! \n' -> putFormat
                            (# 
                            do groupName[]->s; AST.astFileExtension->s;
                            #);
                         #);
                    #);
               #);
          #);
        
        humle: IntegerObject
          (# c: @Char;
             s: @ShortInt;
             obj: @IntegerObject;
             b: @Boolean;
             r: @Real;
             ref: ^Object;
             t: @Text;
             p: ##Object;
             pNone: ##Object;
             ir: [50]@Integer;
             orep: [10]^Object;
             prep: [10]##Object;
          enter (c,s,b,r,ref[])
          do 'dette er en humle ' -> t;
             (for i:50 repeat i->ir[i] for);
             (for i:10 repeat THIS(humle)[]-> orep[i][] for);
             (for i:5 repeat main##-> prep[i]## for);
             humle##->p##;
          #);
        
        myIcons: @iconDB
          (# movIcon: ^bitmap;
             getIcon::
               (# 
               do (if TRUE
                   //ObjectViewIcon -> name.equalNCS then
                      (if movIcon[]//NONE then
                          &bitmap[] -> movIcon[];
                          '$(BETALIB)/bitmap/ObjectViewIcon.xbm' 
                            -> expandEnvVar
                          (# defaultvalue::
                               (# do '/usr/local/lib/beta/'->envvarvalue[] #) 
                          #) -> movIcon.readFromX11File;
                      if);
                      movIcon[] -> theIcon[];
                  if);
               #);       
          #);

     do main.open; myIcons[]->objectPool.put; 
        thespawner.init; thespawner[]->objectPool.put;
     #)
#)
