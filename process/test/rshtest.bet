ORIGIN '~beta/basiclib/systemenv';
INCLUDE '~beta/basiclib/file';
INCLUDE '~beta/process/rsh';
--PROGRAM: descriptor--
systemenv
(# 
   s: ^StreamSocket;
   F: @File(# Binary::FalseObject #);
   keeper: system(# do L:(# do 0.1->sleep; restart L #)#);
   
   stress:
     (# 
     do (for i:1024 repeat
             i->screen.putInt; 
             ('ariel.daimi.au.dk', 'mg', 'beta', 
             'sh -c \'if [ -f "foo bar" ]; then echo yes; else echo no; fi\'')
               ->rsh->s[];
             (if s[]<>NONE then
                 ': '->screen.putText;
                 s.getLine->screen.putText; ascii.cr->screen.put;
                 L:(# 
                   do (if not s.eos then
                          s.get->screen.put;
                          restart L
                      if);
                   #);
                 s.close;
              else
                 ' FAILED!'->screen.putLine;
             if)
        for)
     #);                 
                 
   
do (* &|keeper[]->fork; *)
   ('ariel.daimi.au.dk', 'mg', 'beta', 'cat lst')->rsh->s[];
   (if s[]<>NONE then
       'test'->F.name;
       F.openWrite;
       L:(# 
         do (if not s.eos then
                s.get->F.put;
                restart L
            if);
         #);
       s.close;
       F.close;
       'Got contents of lst'->screen.putLine;
    else
       'Failed to get connection'->screen.putLine;
   if);
   
   ('ariel.daimi.au.dk', 'mg', 'beta', 
   'sh -c \'if [ -f "foo bar" ]; then echo yes; else echo no; fi\'')
     ->rsh->s[];
   (if s[]<>NONE then
       'Got connection for exist'->screen.putLine;
       s.getLine->screen.putLine;
       s.close;
   if);
   &stress;
#)
