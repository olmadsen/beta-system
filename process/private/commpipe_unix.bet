ORIGIN '../commpipe';

(*
 * COPYRIGHT
 *       Copyright (C) Mjolner Informatics 1995
 *       All rights reserved.
 *)


INCLUDE '~beta/unixlib/v1.6/unixinterface';
INCLUDE 'sysFdStream';
INCLUDE 'sysFdStream_unix';

--- PipePrivate:descriptor ---
(#
   descriptors: ^unixPipe;
   readCh: @readChannel;
   writeCh: @writeChannel;

   init: (# do (* !!! IOstate/timeHandler for pipes? *) #);
#)

--- PipeInit:dopart ---
do
   initSockets;
   INNER Init;
   (* get OS level pipe object *)
   &unixPipe[] -> private.descriptors[];
   (if (private.descriptors[] -> &openPipe)
    // -1 then 'failed to open pipe' -> error;
   if);
   private.init;

   (* make readCh/writeCh wrap the pipe *)
   private.descriptors.writeIndex -> private.writeCh.private.Index;
   private.descriptors.readIndex -> private.readCh.private.Index;
   private.readCh.openRead;
   private.writeCh.openWrite;

   (* initialize interface *)
   private.readCh[] -> readEnd[];
   private.writeCh[] -> writeEnd[];
   
--- PipeClose:dopart ---
do INNER close;
   readEnd.close;
   writeEnd.close;
