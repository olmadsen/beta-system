ORIGIN 'processmanagerbody';
INCLUDE '~beta/basiclib/private/betaenv_jvmbody';
INCLUDE '~beta/javalib/java/lang/Runtime';
INCLUDE '~beta/javalib/java/lang/Process';
INCLUDE '~beta/javalib/java/lang/Thread';
INCLUDE '~beta/javalib/java/io/InputStream';
INCLUDE '~beta/javalib/java/io/OutputStream';
INCLUDE '~beta/javalib/java/io/InputStreamReader';

--- Lib: attributes ---

OutErrHandler: Thread
  (# 
     is: ^InputStream;
     
     setstream: 
       (# 
       enter is[]
       #);
     
     run:
       (# br: ^BufferedReader;
          temp: ^String;
          isr: ^InputStreamReader;
       do is[] 
            -> InputStreamReader._init_InputStream
            -> isr[]; (* FIXME *)
          isr[]
            -> BufferedReader._init_Reader -> br[];
          read:
            (if (br.readLine->temp[] (* FIXME *))<>NONE then
                temp[] -> screen.putline;
                restart read;
            if);
          is.close;
       #);
  #);


--- ProcessPrivate:descriptor ---
(# jp: ^JavaProcess;
   out, err: ^OutErrHandler;
#)


--- ProcessStartMDBody:descriptor---
(# cmd: ^text
do name.copy -> cmd[];
   argument.scanArguments(# do ' '->cmd.put; current[]->cmd.append #);
   (* Start external process *)
   cmd[] -> (Runtime.getRuntime).exec_String -> private.jp[];
   
   (* Handle stdout and stderr from external process *)
   
   &OutErrHandler[] -> private.out[];
   private.jp.getInputStream -> private.out.setstream;
   private.out.start;
   
   &OutErrHandler[] -> private.err[];
   private.jp.getErrorStream -> private.err.setstream;
   private.err.start;
#)


--- ProcessStopMDBody:descriptor ---
(#
do private.jp.destroy;
#)


--- ProcessAwaitStopped:dopart ---
do private.jp.waitFor;
   INNER;
   

--- ProcessStillRunning:dopart ---
do 'processmanger_jvm:ProcessStillRunning' -> NYI;
   INNER;
   

--- connectToProcess:dopart ---
do 'processmanger_jvm:connectToProcess' -> NYI;
   INNER;
   

--- connectErrToProcess:dopart ---
do 'processmanger_jvm:connectErrToProcess' -> NYI;
   INNER;
   

--- connectInPipe:dopart ---
do 'processmanger_jvm:connectInPipe' -> NYI;
   INNER;

   
--- redirectFromFile:dopart ---
do 'processmanger_jvm:redirectFromFile' -> NYI;
   INNER;
   

--- redirectToFile:dopart ---
do 'processmanger_jvm:redirectToFile' -> NYI;
   INNER;

   
--- redirectErrToFile:dopart ---
do 'processmanger_jvm:redirectErrToFile' -> NYI;
   INNER;

   
--- redirectFromChannel:dopart ---
do 'processmanger_jvm:redirectFromChannel' -> NYI;
   INNER;
   

--- redirectToChannel:dopart ---
do 'processmanger_jvm:redirectToChannel' -> NYI;
   INNER;
   

--- redirectErrToChannel:dopart ---
do 'processmanger_jvm:redirectErrToChannel' -> NYI;
   INNER;
   

--- ProcessManagerExceptionMDBody:descriptor ---
(# 
do 'processmanger_jvm:ProcessManagerExceptionMDBody' -> NYI;
#)

