ORIGIN '../commpipe';
LIB_ITEM 'processpipe';

(*
 * COPYRIGHT
 *       Copyright (C) Aarhus University
 *       All rights reserved.
 *)


INCLUDE '~beta/win32lib/ntinterface';
INCLUDE 'sysFdStream';
INCLUDE 'sysFdStream_nt';

--- PipePrivate:descriptor ---
(#
   descriptors: ^ntPipe;
   readCh: @readChannel;
   writeCh: @writeChannel;

   init: (# do (* !!! IOstate/timeHandler for pipes? *) #);
#)

--- PipeInit:dopart ---
do
   initSockets;
   INNER Init;
   (* get OS level pipe object *)
   &ntPipe[] -> private.descriptors[];
   (if (private.descriptors[] -> &openPipe)
    // -1 then 'failed to open pipe' -> error;
   if);

   (* 'got OS level pipes: read=' -> screen.puttext;
   private.descriptors.readIndex -> screen.putint;
   ' and write=' -> screen.puttext;
   private.descriptors.writeIndex -> screen.putint;
   '.' -> screen.putline; *)

   private.init;

   (* make readCh/writeCh wrap the pipe *)
   private.descriptors.writeIndex -> private.writeCh.private.Index;
   private.descriptors.readIndex -> private.readCh.private.Index;
(*   private.readCh.openRead;
   private.writeCh.openWrite; *)

   (* initialize interface *)
   private.readCh[] -> readEnd[];
   private.writeCh[] -> writeEnd[];

--- PipeClose:dopart ---
do INNER close;   
   readEnd.close;
   writeEnd.close;
