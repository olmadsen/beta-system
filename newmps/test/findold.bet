ORIGIN '~beta/mps/astlevel';
INCLUDE '~beta/betaast/betacfl';
INCLUDE '../dependencyold';
INCLUDE '~beta/mps/grammarinit';


-- program: descriptor --
(#
   mps: @astInterface;
   beta: @mps.beta;
   
   group: ^astInterface.fragmentGroup;
   name: ^text;
   doGroup:
     (# group: ^astInterface.fragmentGroup;
     enter group[]
     do 'group.name = "' -> puttext;
        group.name -> puttext;
        '"' -> putline;
        'group.fullname = ' -> puttext;
        
        group.fullname -> puttext;
        '"' -> putline;
        
        
        'ORIGIN = "' -> puttext;
        group.setupOrigin;
        (if group.origin <> NONE then
            (group.origin).fullname -> puttext;
         else
            'NONE' -> puttext;
        if);
        '"' -> putline;
        
        group.scanIncludes
        (# fg: ^astInterface.FragmentGroup;
        do 'INCLUDE ' -> puttext;
           current.fullname -> putline;
        #);
        group.scan
        (#
        do current[] -> doFragment;
        #);
     #);
   doFragment:
     (# frag: ^astInterface.fragmentForm;
     enter frag[]
     do 'frag.name = "' -> puttext;
        frag.name -> puttext;
        '"' -> putline;
        'frag.fullname = ' -> puttext;
        
        frag.fullname -> puttext;
        '"' -> putline;
        (if frag.root.kind = MPS.kinds.interior then
            frag.root[] -> doExp;
        if);
     #);
   doExp:
     (# exp: ^astInterface.expanded;
        searchterm: ^Text;
        count: @integer;
        n: @integer;
     enter exp[]
     do 'integer' -> searchTerm[];
        exp.suffixWalk
        (#
        do (if current.kind
            //mps.kinds.nameAppl
            //mps.kinds.nameDecl then
               n + 1 -> n;
           if);
        #);
        'n = ' -> puttext;
        n -> putint;
        newline;
        beta.nameApl -> exp.suffixWalkForProd
        (# scanCat:: beta.NameApl;
           nameAppl: ^astInterface.nameAppl;
        do current.getNameAppl -> nameAppl[];
           (if nameAppl.getText -> searchterm.equalNCS then
               count + 1 -> count;
           if);
        #);
        beta.nameApl -> exp.suffixWalkForProd
        (# scanCat:: beta.NameApl;
           nameAppl: ^astInterface.nameAppl;
        do current.getNameAppl -> nameAppl[];
           (if nameAppl.getText -> searchterm.equalNCS then
               count + 1 -> count;
           if);
        #);
        'count = ' -> puttext;
        count -> putint;
        newline;
     #);
do mps.astLevelInit;
   ('~beta/grammars/beta/beta','beta',screen[])
     ->beta.betagrammarInit
   (#
      MPSerror::
        (# do (failure,msg[])->stop #);
      noParserAvailable:: 
        (# do (failure,msg[])->stop #)
   #); 
   (if NoOfArguments = 2 then
       2 -> arguments -> name[];
       name[] -> mps.Dependency
       (# doGroup::
            (#
            do current[] -> THIS(Program).doGroup;
            #);
       #);
   if);
	'top.capacity = ' -> puttext;
	mps.top.groupTable.range -> putint;
	newline;
	'top.size = ' -> puttext;
	mps.top.groupTable.size -> putint;
	newline;
	
	mps.top.groupTable.statistics
		(#
		do screen[] -> print;
		#);
#)

