ORIGIN '~beta/guienv/guienv';
INCLUDE '~beta/comlib/comtypes'
        '~beta/comlib/comlib'
        '~beta/comlib/oleidl'
        '~beta/guienv/private/winnt/guienv_ntiprivate'
        '~beta/win32lib/winerror'
        'additionslib'
        '~beta/guienv/controls';
-- program: Descriptor --
guienv
  (#
     mainWindow: @window
       (#
          ;
          SKAL_LIGGE_I_WINDOWLIB: (#  #);
          CCmdTarget: (#  #);
          COleDropTarget: CCmdTarget
            (#
               private: @
                 (#
                    pDropTarget: ^IDropTargetType;
                    IDropTargetType: IDropTarget
                      (#
                         QueryInterface::< 
                           (# 
                           do 'DropTarget: QueryInterface called'->putline
                           #);
                         AddRef::< 
                           (#  do 'DropTarget: AddRef called'->putline #);
                         Release::< 
                           (#  do 'DropTarget: Release called'->putline #);
                         ;
                         DragEnter::< 
                           (# 
                           do 'DropTarget: DragEnter called'->putline
                           #);
                         DragOver::< 
                           (#  do 'DropTarget: DragOver called'->putline #);
                         DragLeave::< 
                           (# 
                           do 'DropTarget: DragLeave called'->putline
                           #);
                         Drop::< 
                           (#  do 'DropTarget: DragDrop called'->putline #)
                      #)
                 #);
               init:
                 (# 
                 do
                    'COleDropTarget.init'->putline;
                    &private.IDropTargetType[]->private.pDropTarget[]
                 #);
               ;
               register:
                 (#
                    onError:< exception
                      (# 
                      do
                         'COleDropTarget error: unable to register window.'
                           ->msg.append
                      #);
                    theInterfaceObject: ^InterfaceObject;
                    ;
                    theHandle:
                      (# handle: @integer
                      do
                         (if theInterfaceObject[] <> none then
                             theInterfaceObject.InterfaceObjectID->handle;
                             (if false then
                                 2949810->handle;
                                 'theHandle: handle='->puttext;
                                 handle->putint;
                                 newline
                             if)
                          else
                             'theHandle: theCanvas[]=none'->putline
                         if)
                      exit handle
                      #);
                    hr: @HRESULT
                 enter theInterfaceObject[]
                 do
                    'TARGET_Register called'->putline;
                    (theHandle,private.pDropTarget[])->TARGET_RegisterDragDrop
                      ->hr;
                    (if hr.succeeded then
                        'RegisterDragDrop succeeded'->putline
                     else
                        'RegisterDragDrop failed!'->putline;
                        (if hr.value
                         // S_OK then
                            'S_OK'->putline
                         // DRAGDROP_E_INVALIDHWND then
                            'DRAGDROP_E_INVALIDHWND'->putline
                         // DRAGDROP_E_ALREADYREGISTERED then
                            'DRAGDROP_E_ALREADYREGISTERED'->putline
                         else
                            'hr er underlig'->putline
                        if);
                        onError
                    if)
                 #);
               revoke: (#  #)
            #);
          SOURCE_COleDropTarget: CCmdTarget
            (#
               private: @
                 (#
                    pDropSource: ^IDropSourceType;
                    IDropSourceType: IDropSource
                      (#
                         QueryInterface::< 
                           (# 
                           do 'DropSource: QueryInterface called'->putline
                           #);
                         AddRef::< 
                           (#  do 'DropSource: AddRef called'->putline #);
                         Release::< 
                           (#  do 'DropSource: Release called'->putline #);
                         ;
                         QueryContinueDrag::< 
                           (# 
                           do 'DropSource: QueryContinueDrag'->putline
                           #);
                         GiveFeedback::< 
                           (#  do 'DropSource: GiveFeedback'->putline #)
                      #)
                 #);
               init:
                 (# 
                 do
                    'SOURCE_COleDropTarget.init'->putline;
                    &private.IDropSourceType[]->private.pDropSource[]
                 #);
               ;
               register:
                 (#
                    onError:< exception
                      (# 
                      do
                         'SOURCE_COleDropTarget error: unable to register window.'
                           ->msg.append
                      #);
                    theInterfaceObject: ^InterfaceObject;
                    ;
                    theHandle:
                      (# handle: @integer
                      do
                         (if theInterfaceObject[] <> none then
                             theInterfaceObject.InterfaceObjectID->handle;
                             (if false then
                                 2949810->handle;
                                 'theHandle: handle='->puttext;
                                 handle->putint;
                                 newline
                             if)
                          else
                             'theHandle: theCanvas[]=none'->putline
                         if)
                      exit handle
                      #);
                    hr: @HRESULT
                 enter theInterfaceObject[]
                 do
                    'SOURCE_Register called'->putline;
                    (theHandle,private.pDropSource[])->SOURCE_RegisterDragDrop
                      ->hr;
                    (if hr.succeeded then
                        'RegisterDragDrop succeeded'->putline
                     else
                        'RegisterDragDrop failed!'->putline;
                        (if hr.value
                         // S_OK then
                            'S_OK'->putline
                         // DRAGDROP_E_INVALIDHWND then
                            'DRAGDROP_E_INVALIDHWND'->putline
                         // DRAGDROP_E_ALREADYREGISTERED then
                            'DRAGDROP_E_ALREADYREGISTERED'->putline
                         else
                            'hr er underlig'->putline
                        if);
                        onError
                    if)
                 #);
               revoke: (#  #)
            #);
          ;
          ;
          TING_SOM_HOERER_TIL_NETOP_DETTE_VINDUE: (#  #);
          open::< 
            (# 
            do
               (470,315)->size;
               clientCanvas.open;
               luk_btn.open;
               source_btn.open;
               target_btn.open;
               'Drag\'n\'drop demo'->title
            #);
          eventHandler::<  (# onAboutToClose::<  (#  do onExit #) #);
          menubarType:: 
            (#
               fileMenu: @menu
                 (#
                    openItem: @menuItem
                      (#
                         eventHandler:: 
                           (# onSelect::  (#  do onOpen;  #);  #);
                         open::  (#  do '&Open'->name; 'o'->key #)
                      #);
                    closeItem: @menuItem
                      (#
                         eventHandler:: 
                           (# onSelect::  (#  do onClose #);  #);
                         open::  (#  do '&Close'->name; 'c'->key #)
                      #);
                    exitItem: @menuItem
                      (#
                         eventHandler:: 
                           (# onSelect::  (#  do onExit #);  #);
                         open::  (#  do 'E&xit'->name; 'x'->key;  #)
                      #);
                    sep1: @separator;
                    open:: 
                      (# 
                      do
                         '&File'->name;
                         openItem.open;
                         openItem[]->append;
                         closeItem.open;
                         closeItem[]->append;
                         sep1.open;
                         sep1[]->append;
                         exitItem.open;
                         exitItem[]->append
                      #)
                 #);
               shortcutsMenu: @menu
                 (#
                    shortcut1Item: @menuItem
                      (#
                         eventHandler:: 
                           (# onSelect::  (#  do onShortcut1 #);  #);
                         open::  (#  do 'Shortcut &1'->name; '1'->key #)
                      #);
                    open:: 
                      (# 
                      do
                         'Shortcuts'->name;
                         Shortcut1Item.open;
                         Shortcut1Item[]->append
                      #)
                 #);
               open::< 
                 (# 
                 do
                    fileMenu.open;
                    fileMenu[]->append;
                    ShortcutsMenu.open;
                    ShortcutsMenu[]->append;
                    INNER
                 #)
            #);
          clientCanvas: @canvas
            (#
               open::< 
                 (# 
                 do
                    4->border.style;
                    true->border.visible;
                    (450,130)->size;
                    (15,30)->position;
                    
                 #)
            #);
          luk_btn: @pushbutton
            (#
               open::< 
                 (# 
                 do 'Luk'->label; (60,20)->size; (400,280)->position; INNER
                 #);
               eventHandler::<  (# onMouseUp::<  (#  do terminate #) #)
            #);
          source_btn: @pushbutton
            (#
               open::< 
                 (# 
                 do
                    'Source'->label; (60,20)->size; (400,185)->position; INNER
                 #)
            #);
          target_btn: @pushbutton
            (#
               open::< 
                 (# 
                 do
                    'Target'->label; (60,20)->size; (400,220)->position; INNER
                 #)
            #);
          ;
          onOpen:< (#  #);
          onClose:< (#  #);
          onExit:< (#  do terminate #);
          onShortcut1:< (#  #);
          ;
          SourceDT: @SOURCE_COleDropTarget (#  #);
          TargetDT: @COleDropTarget (#  #);
          registerDragDrop:
            (# 
            do
               newline;
               SourceDT.init;
               source_btn[]->SourceDT.register;
               newline;
               TargetDT.init;
               target_btn[]->TargetDT.register;
               newline
            #)
       #);
     ;
     InitOLE:
       (# hr: @HRESULT
       do
          0->OleInitialize->hr;
          (if hr.failed then 'OleInitialize failed!'->putline if)
       #)
  do InitOLE; mainWindow.open; mainWindow.registerDragDrop
  #)  

