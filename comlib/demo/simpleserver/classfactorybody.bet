ORIGIN 'classfactory';

INCLUDE
'~beta/win32lib/winerror';

-- QueryInterfaceImpl: doPart --
do 
   (if debug then
       errMsg.clear;
       'classFactory_QueryInterfaceImpl begin. ' -> errMsg.putText;
       errMsg[] -> screen.putline;
   if);
   
   riid[]->aGUID.binary[];
   none ->ppvObject;
   
   (if true
    //aGUID[]->Unknown_IID.equal 
    //aGUID[]->ClassFactory_IID.equal then
       THIS(IClassFactory)[]->ppvObject;
   if);
   (if ppvObject <> none then
       ppvObject.ref.AddRef; 
       NOERROR->result;
       
       'Class Factory returning interface pointer.' -> screen.putline;
       
       (if debug then
           errMsg.clear;
           'Class Factory returning interface pointer.' -> errMsg.puttext;
           errMsg[] -> screen.putline;
       if);
    else
       E_NOINTERFACE->result;
       
       (if debug then
           errMsg.clear;
           'Class Factory is not returning interface pointer.' 
             -> errMsg.puttext;
           errMsg[] -> screen.putline;
       if);
   if);
   
   (if debug then
       errMsg.clear;
       'classFactory_QueryInterfaceImpl done.' -> errMsg.putLine;
       errMsg[] -> screen.putline;
   if);
   
-- AddRefImpl: doPart --
do (if debug then 
       'CF_AddRefImpl begin.' -> errMsg.putLine;
       errMsg[] -> screen.putline;
   if);
   
   m_cRef + 1 -> m_cRef -> result;
   
   (if debug then 
       errMsg.clear;
       'CF_AddRefImpl done.' -> errMsg.putLine; 
       errMsg[] -> screen.putline;
   if);
   
-- ReleaseImpl: doPart --
do (if debug then 
       errMsg.clear;
       'CF_ReleaseImpl begin.' -> errMsg.putLine; 
       errMsg[] -> screen.putline;
   if);
   
   m_cRef - 1 -> m_cRef -> result;
   
   (if (0=m_cRef) then
       'm_cRef = 0. Should we deallocate something?' -> screen.putline;
   if);
   
   (if debug then 
       errMsg.clear;
       'CF_ReleaseImpl done. m_cRef = ' -> errMsg.putText; 
       m_cRef -> errMsg.putint;
       errMsg[] -> screen.putline;
   if);
   
-- CreateInstanceImpl: doPart --
do (if debug then 
       errMsg.clear;
       'CF_doCreateInstanceImpl begin' -> errMsg.putLine; 
       errMsg[] -> screen.putline;
   if);
   
   L:
     (# hr: @hresult;
     do
        
        none -> ppvObject;
        E_OUTOFMEMORY -> result;
        
        (* We don't support aggregation *)
        (if (pUnkOuter[]<>none) then
            CLASS_E_NOAGGREGATION -> result; 
            leave L
        if);
        
        (if theApplObject[]<>NONE then
            
            'Calling theApplObject.QueryInterface' -> screen.putline;
            (riid[],ppvObject[]) 
              -> theApplObject.QueryInterface 
             -> result; 
            NOERROR -> result;
            result -> hr.value;
            (if hr.succeeded then
                'theApplObject.QueryInterface succeeded.' -> screen.putline;
             else
                'theApplObject.QueryInterface failed.' -> screen.putline;
            if);
                
         else
            (if debug then 
                errMsg.clear;
                'theApplObject[]=none in CF_CreateInstanceImpl' 
                  -> errMsg.putLine; 
                errMsg[] -> screen.putline;
            if);
        if);
     #);
   
   (if debug then 
       errMsg.clear;
       'CF_CreateInstanceImpl done.' -> errMsg.putLine; 
       errMsg[] -> screen.putline;
   if);
   
-- LockServerImpl: doPart --
do (if debug then 
       errMsg.clear;
       'CF_LockServerImpl begin.' -> errMsg.putLine; 
       errMsg[] -> screen.putline;
   if);
   
   E_NOTIMPL -> result;
   
   (if debug then 
       errMsg.clear;
       'hyperviseCF_doLockServerImpl done.' -> errMsg.putLine; 
       errMsg[] -> screen.putline;
   if);
