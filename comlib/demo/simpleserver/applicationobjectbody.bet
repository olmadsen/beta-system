ORIGIN 'applicationobject';
INCLUDE 
'~beta/win32lib/winerror';

-- QueryInterfaceImpl: doPart --
do (# p: @screen.putline;
      
   do (if debug then
          errMsg.clear;
          'applobject_QueryInterfaceImpl begin. ' -> errMsg.putText;
          errMsg[] -> p;
      if);
      
      'applobject_QueryInterfaceImpl begin. ' ->  p;
      
      riid[]->aGUID.binary[];
      none ->ppvObject;
      
      '1--' -> p;
      
      (# dummy: @char;
      do
         (if true
          //aGUID[]->Unknown_IID.equal 
          //aGUID[]->SimpleServer_IID.equal then
             THIS(IUnknown)[]->ppvObject;
         if);
      #);
      
      '2--' -> p;
      
      (if ppvObject[] <> none then
          (# dummy: @integer;
          do
             '3--' -> p;
             ppvObject.ref.AddRef -> dummy; 
             '3.0--' -> p;
             NOERROR->result;
          #);
          
          '3.1--' -> p;
          
          (if debug then
              errMsg.clear;
              'Application Object returning interface pointer.' -> errMsg.puttext;
              errMsg[] -> p;
          if);

          'a--' -> p;
       else
          '4--' -> p;
          E_NOINTERFACE->result;
          
          (if debug then
              errMsg.clear;
              'Application Object is not returning interface pointer.' 
                -> errMsg.puttext;
              errMsg[] -> p;
          if);
      if);
      
      
      (# dummy: @char;
      do 'b--' -> p;
         (if debug  then
             errMsg.clear;
             'applobject_QueryInterfaceImpl done.' -> errMsg.putLine;
             errMsg[] -> p;
         if); 
         'c--' -> p;
      #);
      
      
   #)
   
(*-- AddRefImpl: doPart --
do (if true then 
       'applobj_AddRefImpl begin.' -> errMsg.putLine;
       errMsg[] -> screen.putline;
   if);
   
   m_cRef + 1 -> m_cRef -> result;
   
   (if true then 
       errMsg.clear;
       'applobj_AddRefImpl done.' -> errMsg.putLine; 
       errMsg[] -> screen.putline;
   if);*)
   
-- ReleaseImpl: doPart --
do (if debug then 
       errMsg.clear;
       'applobj_ReleaseImpl begin.' -> errMsg.putLine; 
       errMsg[] -> screen.putline;
   if);
   
   m_cRef - 1 -> m_cRef -> result;
   
   (if (0=m_cRef) then
       'm_cRef = 0. Should we deallocate something?' -> screen.putline;
   if);
   
   (if debug then 
       errMsg.clear;
       'applobj_ReleaseImpl done. m_cRef = ' -> errMsg.putText; 
       m_cRef -> errMsg.putint;
       errMsg[] -> screen.putline;
   if);
   
-- printImpl: doPart --
do 'printImpl. str = ' -> screen.putline;
   str.getText -> screen.putline;
