ORIGIN 'comlib';

---lib:attributes---
(* 
 * Beta Interface to Aggregated interfaces defined in chapter 8, Inside COM
 *)

IX: IUnknown
  (# 
     Fx:< (# #);
  #);
IY: IUnknown
  (# 
     Fy:< (# #);
  #);
IZ: IUnknown
  (# 
     Fz:< (# #);
  #);

--PROGRAM: descriptor--
(# IID_IX, IID_IY, IID_IZ: @IID;
   CLSID_Component1, CLSID_COMPONENT2: @CLSID;
   pIX,pIX2: ^IX;
   pIY: ^IY;
   
do '32bb8320-b41b-11cf-a6bb-0080c7b2d682' -> IID_IX;
   '32bb8321-b41b-11cf-a6bb-0080c7b2d682' -> IID_IY;
   '32bb8322-b41b-11cf-a6bb-0080c7b2d682' -> IID_IZ;
   '0c092c24-882c-11cf-a6bb-0080c7b2d682' -> CLSID_COMPONENT1;
   '0c092c25-882c-11cf-a6bb-0080c7b2d682' -> CLSID_COMPONENT2;
   
   0->CoInitialize;
   
   'Get interface IX from Component 1'->putLine;
   
   (CLSID_Component1[], NONE, CLSCTX_INPROC_SERVER, IID_IX[])
     -> CoCreateInstance->pIX[];

   (if pIX[]<>NONE then
       'Succeeded creating component.'->putLine;
       pIX.Fx;
       
       'Get interface IY from IX.'->putLine;
       IID_IY[]->pIX.query->pIY[];
       (if pIY[]<>NONE then
           'Succeeded getting interface IY from IX.'->putLine;
           pIY.Fy;
           'Get interface IX2 from IY.'->putLine;
           IID_IX[] -> pIY.Query -> pIX2[];
           (if pIX2[]<>NONE then
               'Succeeded getting interface IX2 from IY.'->putline;
               pIX2.Fx;
               pIX2.Release;
               NONE->pIX2[];
               'Succeeded releasing interface IX2.'->putline;
            else
               'Error! Should have gotten interface IX.'->putline;
           if);
           pIY.Release;
           NONE->pIY[];
           'Succeeded releasing interface IY.'->putline;
        else
	   'Could not get interface IY.'->putline;
       if);
       pIX.Release;
       'Succeeded releasing interface IX.'->putline;
    else
       'Could not create component'->putline;
   if);	
   'CoUninitialize'->putline;
   CoUninitialize;
   'CoUninitialize done'->putline;
#)
