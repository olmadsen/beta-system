ORIGIN 'translatebody';
INCLUDE '~beta/sysutils/envstring';

--LIB:attributes--
fix:
  (# t: ^text;
  enter t[]
  do '/' -> t.findall(# do ('\\', inx) -> t.inxPut #); 
  exit t[]
  #);
make_cmd:
  (# cmd: ^text;
  enter cmd[]
  do 'cmd /c ' -> cmd.prepend;
     (*for i:cmd.T.range repeat
          cmd.T[i] -> putint; '\t' -> put; cmd.T[i]->put; newline;
          (if i=cmd.lgth then
              '-------------'->putline;
          if);
     for*);
  exit cmd[]
  #);

--PreprocessBody:descriptor--
(# cmd: ^text;
   e: @diskentry;
   
do (* FIXME: should use process!!! *)

   (* The produced .i file is in local directory when using cl *)
   ifilename[] -> e.path;
   e.path.name -> ifilename[];
   
   'echo #define SAFEARRAY(type) SAFEARRAY*>'->cmd[];
   cfilename[] -> fix -> cmd.append;
   cmd[] -> make_cmd;
   cmd[] -> report;
   cmd -> system;
   
   (if false then
       'grep -v "#pragma" '->cmd[];
       idlfilename[] -> fix -> cmd.append;
       ' >> ' -> cmd.append;
       cfilename[] -> fix -> cmd.append;
       cmd[] -> make_cmd;
       cmd[] -> report;
       cmd -> system;
    else
       'perl -ne "if (!/#pragma/){print;}" '->cmd[];
       idlfilename[] -> fix -> cmd.append;
       '>>' -> cmd.append;
       cfilename[] -> fix -> cmd.append;
       cmd[] -> make_cmd;
       cmd[] -> report;
       cmd -> system;
   if);
   
   '$(BIDL_CPP)' -> expandEnvVar
   (# defaultvalue:: 
        (# do 'cl -nologo -EP -P'->envvarvalue[] #);
   #) -> cmd[];
   ' -I' -> cmd.append;
   (if HeadOfIdlFileName.length=0 then
       '. ' -> cmd.append;
    else
       HeadOfIdlFileName[] -> cmd.append;
       ' '->cmd.append;
   if);
   defines.scan
   (# 
   do '-D' -> cmd.append;
      current[] -> cmd.append;
      ' ' -> cmd.append;
   #);
   cfilename[] -> cmd.append;
   cmd[] -> fix -> report;
   '      '->screen.puttext;
   cmd[] -> make_cmd;
   cmd -> system;
   
   (if not preserve then
       'del /Q /F '->cmd[];
       cfilename[] -> fix -> cmd.append;
       cmd[] -> make_cmd;
       cmd[] -> report;
       cmd -> system;
   if);
#)

-- DeleleIFile: descriptor --
(# 
do (if not preserve then
       'del /Q /F '->cmd[];
       ifilename[] -> fix -> cmd.append;
       cmd[] -> make_cmd;
       cmd[] -> report;
       cmd -> system;
   if);
#)
