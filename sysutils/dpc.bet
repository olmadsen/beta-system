ORIGIN 'basicsystemenv';
BODY 'private/dpcbody';

--- systemlib:attributes ---

(* DPCHANDLER
 * ==========
 * 
 * Due to a limitiation in the BETA runtime system, it is currently
 * not allowed to suspend a component whose stack contains callbacks
 * from C to BETA.
 * 
 * The DPChandler is a way of handling this problem. It allows code
 * executed by a thread with C on the stack to register objects to be 
 * executed on a later point in time. This is then done by another thread 
 * executing the objects registered in the order in which they where 
 * registered.
 * 
 * DPC is an acronym for "Deferred Procedure Call", an idea taken from
 * the Windows NT operating system. In NT, the DPC takes care of low priority
 * actions initiated by high priority interrupt handlers. *)

DPChandler:
  (# procType:< Object
       (* The type of object to execute by this DPChandler *);
     
     invokeMax:< IntegerValue
       (* The maximum number of object invocations to perform
        * without pausing. -1 means that all objects registered
        * are executed before suspending explicitly. *)
       (# do -1 -> value; INNER #);
     
     init: (# do <<SLOT dpchandlerInit:descriptor>> #);
     
     destroy: <<SLOT dpchandlerDestroy:descriptor>>
     (* destroy kills the thread associated with this DPChandler. *);
     
     callDeferred:
       (# p: ^procType;
       enter p[]
       <<SLOT dpcCallDeferred:dopart>>
       #);
     
     dpcPriv: @<<SLOT dpcPriv:descriptor>>;
  #);
