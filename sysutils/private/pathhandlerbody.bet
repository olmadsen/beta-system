ORIGIN '../pathhandler';
MDBODY   mac     'pathhandler_macbody'
	 ppc     'pathhandler_macbody'
	 ppcmac  'pathhandler_macbody'
	 nti     'pathhandler_ntbody'
	 default 'pathhandler_unixbody';

INCLUDE '~beta/basiclib/v1.5/file'
        '~beta/basiclib/v1.5/external'
        '../envstring';

--LIB: attributes--
searchPath: 
  (# path: ^text;
  <<SLOT PathhandlerSearchPath: dopart>>
  exit path[]
  #);
searchPathDelimiter: 
  (# delimiter: @char;
  <<SLOT PathhandlerSearchPathDelimiter: dopart>>
  exit delimiter
  #);
     
removedoubleslash:
  (# p: ^text;
     inx, slashinx: @integer;
     dirCh: @char;
  enter p[]
  do (* Check that there are no double slashes in p *)
     -2 -> slashInx;
     DirectoryChar -> dirCh;
     search:
       (for inx: p.lgth repeat
            (if inx>p.lgth // true then leave search if);
            (if p.T[inx] 
             // '/' 
             // dirCh then 
                (if inx > slashInx
                 // true then
                    (if inx = slashInx+1
                     // true then 
                        (* two consecutive slashes *)
                        (slashinx, slashinx) -> p.delete;
                        inx-1 -> inx; (* one less char ! *)
                     // false then 
                        (* remember position of last slash *)
                        inx -> slashInx;
                    if)
                if)
            if);
       for);
  #);
  
-- ConvertFileNameNoFather: dopart --
do 'Error in file path conversion in PathHandler:' -> msg.putline;
   'Too many ''..''s in the path\n\t''' -> msg.puttext;
   THIS(ConvertFilePath).path[] -> msg.puttext;
   '''\ncompared to the basis\n\t''' -> msg.puttext;
   THIS(ConvertFilePath).basis[] -> msg.puttext;
   '''\n'->msg.puttext;
   'Path not converted.' -> msg.putline;
   INNER;
   
--PathHandlerScanSearchPath: dopart--
do (if pathlist[]=NONE then
       searchPath -> expandenvvar -> pathlist[];
   if);
   (if delimiter=0 then
       searchPathDelimiter -> delimiter;
   if);
   (if pathlist.length>0 then
       (# start: @integer;
       do 1->start;
          pathlist.reset;
          delimiter->pathlist.findAll
          (#
          do (if (inx-1>start) then 
                 (start,inx-1)->pathlist.sub->path[];
                 INNER scanSearchPath;
             if);
             inx+1->start;
          #);
          (if start-1<pathlist.length then
              (start,pathlist.length)->pathlist.sub->path[];
              INNER scanSearchPath;
          if);
       #);
   if)
   
   
-- LocalPathException: dopart --
do true -> continue;
   'Error in localpath conversion of \n'''->msg.puttext;
   this(localpath).path[] -> msg.puttext;
   '''\nrelative to the basis\n''' -> msg.puttext;
   this(localpath).basis[] -> msg.puttext;
   ''''->msg.putline;
   INNER;
   
