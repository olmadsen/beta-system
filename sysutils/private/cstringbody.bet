ORIGIN '../cstring';
LIB_ITEM 'sysutilscstring';
(*
 * COPYRIGHT
 *       Copyright Mjolner Informatics, 1992-96
 *       All rights reserved.
 *)

MDBODY nti     'cstring_ntbody'
       mac     'cstring_macbody'
       ppc     'cstring_macbody'
       ppcmac  'cstring_macbody'
       default 'cstring_unixbody';

--LIB: attributes--

stralloc: External
  (# size: @integer;
     ptr: @integer;
  enter size
     do 'malloc' -> callC
  exit ptr
  #);
strfree: External
  (# ptr: @integer
  enter ptr
  do 'free' -> callC;
  #);

--CStringInit: descriptor--
(# 
do (if length//0 then 256 -> stralloc -> charptr
    else length -> stralloc -> charptr
   if)
#)

--CStringSet: descriptor--
(# addr:@integer; 
do (if t[]//NONE then (failuretrace, 'Enter parameter to C string is NONE')->stop; if);
   t.length+1 -> init;
   charptr -> addr;
   t.scanall(# 
            do (ch) %putByteAt(addr+0); addr + 1 -> addr 
            (* Above line tos_converted from: do (addr,ch) -> TOS'%putByte[0]'; addr + 1 -> addr *)
            #);
   (0) %putByteAt(addr+0);
   (* Above line tos_converted from: (addr,0) -> tos'%putByte[0]'; *)
#)

--CStringGet: descriptor--
(# len: @integer;
do &text[] -> t[];
   (if charptr//0 then else
       length -> len;
       len-t.T.range -> t.extend;
       (for i:len repeat 
            (%getByteAt(charptr+i-1)) -> t.T[i];
            (* Above line tos_converted from: charptr + i-1 -> TOS'%adrGetByte' -> t.T[i]; *)
       for);
       len -> t.lgth -> t.pos;
   if);
#)

--CStringGetChars: descriptor--
(# len: @integer;
do (if charptr//0 then else
       length -> len;
       len -> R.extend;
       (for i:len repeat 
            (%getByteAt(charptr+i-1)) -> R[i];
            (* Above line tos_converted from: charptr + i-1 -> TOS'%adrGetByte' -> R[i]; *)
       for);
   if)
#)

--CStringLength: dopart--
do (if charptr//0 then else charptr->strlen->value if) 

--CStringInxPut: dopart--
do (ch) %putByteAt(charptr+inx+0) 
(* Above line tos_converted from: do (charptr+inx,ch) -> TOS'%putByte[0]' *)

--CStringInxGet: dopart--
do (%getByteAt(charptr+inx)) -> ch 
(* Above line tos_converted from: do charptr + inx -> TOS'%adrGetByte' -> ch *)

--CStringFree: dopart--
do charptr -> strfree
