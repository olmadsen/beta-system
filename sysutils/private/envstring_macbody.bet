ORIGIN '../envstring';
(*
 * COPYRIGHT
 *       Copyright Mjolner Informatics, 1992-94
 *       All rights reserved.
 *)

--- expandEnvVarBody: descriptor ---
(#
	getenv: external  (* Get value of an environment variable. *)
	  (# var: [1]@char;
	     Ccharpointer: @integer;
	     enter var
	     do callC
	     exit Ccharpointer
	   #);
	getenvstring: external
	  (# var: [1]@char;
	     result: [1]@char
	  enter var
	  do 'getenv' -> callC
	  exit result
	  #);
   startInx,endInx: @integer;
   envVar,envvarvalue: ^text
     
do
   (if t[]<>NONE // true then
       theLoop: 
         (if 1 // 1 then
             (* Find first '$' *)
             0 -> startInx;
             loop: '$' -> t.findCh(# do inx -> startInx; leave loop #);
             (if (startInx>0)
              // true then
                 (if (startInx+1<t.length)
                  // true then
                     (if (startInx+1 -> t.inxGet)
                      // '(' then
                         (* Find matching ')' *)
                         loop: ')' -> t.findCh
	                 (# 
	                 do (if (inx>startInx)
                             // true then
	                        inx -> endInx; leave loop
	                    if);
	                 #);
                         (if (endInx>0)
                          // true then
	                     (startInx+2,endinx-1) -> t.sub -> envVar[];
	                     (if (envVar -> getenv)
                              // 0 then 
                                 envVar[] -> defaultValue -> envVarValue[];
                                 (if envVarValue[]//NONE then &text[] -> envVarValue[] if);
	                      else 
                                 &text[] -> envVarValue[];
                                 envVar -> getenvstring -> envvarvalue;
                             if);
                             (startInx,endInx) -> t.delete;
	                     (envvarvalue[],startInx) -> t.insert;
	                     0 -> startInx -> endInx;
	                     restart theloop
   if)if)if)if)if)if)
#)



