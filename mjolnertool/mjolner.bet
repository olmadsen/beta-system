ORIGIN '~beta/basiclib/basicsystemenv';
INCLUDE '~beta/guienv/guienvsystemenv'
        '~beta/guienv/utils/simplemenu'
        '~beta/editor/ymercall'
        '~beta/sourcebrowser/ymer'
        '~beta/process/processmanager'
        '~beta/editor/ymersiflib'
        '~beta/interfacebuilder/friggapplication'
        '~beta/freja/frejalib'
        '~beta/freja/frejaoptions'
        '~beta/freja/knightapplication'
        'private/mjolnerOptions'
        '~beta/debugger/valhallaapplication'
        'prefDialog/prefDialog'
        '~beta/toollibs/preferences/preferencesDB'
        'seticon'
        '~beta/basiclib/mbs_version';
LIB_DEF 'mjolnertool' '../lib';
BODY '~beta/editor/private/nouser';
BODY '~beta/editor/private/compiler';
BODY '~beta/freja/private/frejaapplicationbody';
BODY '~beta/debugger/private/valhallabody';
BODY '~beta/debugger/private/breakpointMenus';
BODY '~beta/debugger/private/dynamic_compilation';
BODY '~beta/debugger/private/valhallabodyext';
BODY 'private/mjolnerbody';
(*
 * COPYRIGHT
 *   Copyright Mjolner Informatics, 1995-99
 *   All rights reserved.
 *   
 * NEW Integration Model!! 1.0
 *)
-- program: Descriptor --
(#
   mjolnerarguments,valhallaarguments,frejaarguments: ^text;
   readArguments:
   (* parse arguments in form:
    * mjolner -q -w filnavn --freja -s1231 --valhalla -bopt *)
     (#
        frejapos,valhallapos,mjolnerend: @integer;
        i: @integer;
        arguments: @text;
        
     <<SLOT readArguments:DoPart>>
     #);
   theSystemEnv: @|systemenv
     (#
        MjolnerDoitHandler: system
          (#
             port:
               (# m: @mbs_version; 
               exit 6000+100*m.major+10*m.minor+
               m.revision
               #);
             ClientSockType: StreamSocket
               (#
                  error:: 
                    (# 
                    do
                       true->SocketFailedFlag;
                       errCB_abortOperation->value;
                       
                    #)
               #);
             streamGen: @SocketGenerator;
             clientSock: ^ClientSockType;
             t,cmd: ^Text;
             SocketFailedFlag: @Boolean;
             
          <<SLOT MjolnerDoitHandler:DoPart>>
          #);
        setWindowEnv:: 
          (#  do gui[]->theWindowEnv[] #);
        fg:
          ^ymerBrowser.mps.ast.fragmentGroup;
        
     <<SLOT theSystemEnv:DoPart>>
     #);
   untitledExists:
    booleanValue
     (# f,astFile,textFile: @file; astfileName,textFileName: ^text
     <<SLOT untitledExists:DoPart>>
     #);
   ExternalAppendProject:
     (# name,fgname,ffname: ^text; f: @file; 
     enter name[]
     <<SLOT ExternalAppendProject:DoPart>>
     #);
   ymerBrowser: ^ymerBrowserInterface;
   gui: @guienv
     (#
        onQuit:: 
          (# 
          do 
             sif.askKillPrograms;
             (if Valhalla.isDebugging then 
                 Valhalla.stopDebugging 
              else
             if);
             originalscreen[]->screen[]
          #);
        
     #);
   ymer: @ymerEnv (# editMode:: WriteMode;  #);
   sif: @sifapplication
     (#
        programs: @list (# element:: thesystemenv.process #);
        executeProgram:: 
          (# p: @thesystemenv.process <<SLOT executeProgram:DoPart>> #);
        isProgramRunning:: 
          (# 
          <<SLOT isProgramRunning:DoPart>>
          #);
        killProgram::  (#  <<SLOT killProgram:DoPart>> #);
        askKillPrograms:: 
          (# msg: ^text
          <<SLOT askKillPrograms:DoPart>>
          #);
        setCompilerOptions:: 
          (#
             sifcompiler: ^mps.ast.compiler;
             sw: ^sifcompiler.setswitch;
             swtext: ^text
          <<SLOT MjolnerSetCompilerOptions:DoPart>>
          #);
        externalTextEdit:: 
          (# 
          do
             <<SLOT externalTextEdit:Descriptor>>;
             
          #);
        useExternalTextEditor::  (#  do true->value #)
     #);
   frigg: @friggapplication (#  #);
   frej: @freja (#  #);
   Knight:@KnightApplication(# #);
   myCallBack: @gui.BrowserCallBack (#  <<SLOT myCallBack:DoPart>> #);
   firstBrowser: @boolean;
   lastWEXT: ^sif.sifBrowserWindowExt;
   lastFriggExt: ^frigg.friggBrowserWindowExt;
   Setup:
     (# 
     do myCallBack[]->ymer.newBrowserCallBack[]
     #);
   SetUpMenus:
     (# (* different ways to setup menu *) 
     <<SLOT SetUpMenus:DoPart>>
     #);
   setupValhalla:
     (# 
     <<SLOT setupValhalla:DoPart>>
     #);
   valhalla: ^myValhalla;
   myvalhalla: thesystemenv.valhallaapplication
     (#
        titleText: (#  exit 'Valhalla - Source Level Debugger ' #);
        editMode::  (#  do false->value;  #);
        (* ymerBrowserWindow::< 
         (#
         open::<  (#  do THIS(window).hide;  #);
         isEditor::<  (#  do false->value;  #);
         initCompiler::  (#  do dc[]->compiler[];  #);
         
         #); 
         *)
        isProgramRunning:: 
          (# 
          <<SLOT valhallaIsProgramRunning:DoPart>>
          #);
        killProgram::  (#  <<SLOT valhallaKillProgram:DoPart>> #);
        valhallainit: (#  <<SLOT valhallainit:DoPart>> #)
     <<SLOT myvalhalla:DoPart>>
     #);
   valhallaPrefs:
     @valhallaPreferences;
   mjolnerPrefs: @mjolnerPreferences;
   compilerPrefs: @compilerPreferences;
   frejaPrefs: @frejaCMDPreferences;
   editorPrefs: @editorPreferences;
   obp: @objectPreferences;
   welcome: ^text;
   originalscreen: ^stream;
   
do
   screen[]->originalscreen[];
   'Mjolner Integrated Development Tool - release 5.2'->welcome[];
   <<SLOT mjolnerplatforminit:Descriptor>>;
   thesystemenv   
#)  

