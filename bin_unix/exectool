#!/bin/sh

##############################################################################
#     PLEASE DO NOT CHANGE BELOW THIS LINE
##############################################################################

MAIL="/usr/lib/sendmail -t"
TMPFILE=/tmp/$APPLICATION.$$
ERRFILE=/tmp/$APPLICATION.ERR.$$

TODAY="`date +%y%m%d`"

if [ "$MACHINETYPE" = "SGI" ]
then
  LD_LIBRARY_PATH=${LOCATION}:${LD_LIBRARY_PATH}
  LD_LIBRARY_PATH=${LOCATION}/${objdir}:${LD_LIBRARY_PATH}
# the latter is necessary if LOCATION is different from objdir
  export LD_LIBRARY_PATH
fi

if [ ! -f "$LOCATION/$EXECNAME" ]
then
	echo "$APPLICATION" is currently not available on $MACHINETYPE
	exit 0
fi

# remove dump file if possible.
if [ -f "$EXECNAME".dump ]
then
        /bin/rm -f "$EXECNAME".dump
fi
if [ -f "$EXECNAME".dump ]
then
        # rm failed
#        /bin/mv -f "$EXECNAME".dump /tmp
    echo "old dumpfile: $EXECNAME.dump could not be removed"
fi

if [  "$BETASTAT" = "yes" -a -w $STATFILE ] 
then
echo 'start:' `whoami` '|' $MACHINETYPE '|' `hostname` '|' `date` '|' $$ '|' $* >> $STATFILE
fi

# execute

trap "echo ''; echo 'User Interrupt'; \
if [  '$BETASTAT' = 'yes' -a -w $STATFILE ]; \
then \
echo 'interrupt:  ' `whoami` '|' $MACHINETYPE '|' `hostname` '|' `date` '|' $$ '|' $* code\(130\) \
>> $STATFILE; \
fi; \
exit 0\
" 2

touch $ERRFILE
if [ -w $ERRFILE ] 
then
	$LOCATION/$EXECNAME $* 2>$ERRFILE
else
	$LOCATION/$EXECNAME $* 
fi


# check status

NUMSTAT=$?

case $NUMSTAT in
0)	STATUS="NORMAL"
	;;

# kill -2, kill -INT
130)	STATUS="INTERRUPT"
	;;

# kill -9, kill -KILL
137)	STATUS="INTERRUPT"
	;;

# others
*)	STATUS="ERROR"
esac

case $STATUS in

NORMAL)
        # normal exit
        if [ "$BETASTAT" = "yes" -a -w $STATFILE ]
        then
        	echo 'end:  ' `whoami` '|' $MACHINETYPE '|' `hostname` '|' `date` '|' $$ '|' $* >> $STATFILE
		if [ -w $ERRFILE ] 
		then 
			cat $ERRFILE
			rm -f $ERRFILE
		fi
        fi

        ;;

INTERRUPT)
	#interupted
        if [  "$BETASTAT" = "yes" -a -w "$STATFILE" ]
        then
        	echo 'interrupt:' `whoami` '|' $MACHINETYPE '|' `hostname` '|' `date` '|' $$  '|' code\($NUMSTAT\) >> "$STATFILE"
		if [ -w $ERRFILE ] 
		then 
			cat $ERRFILE
			rm -f $ERRFILE
		fi
        fi
        ;;

*)

if [ "$BETAREPORT" = "yes" ]
then
    if  [ "$BETAREPORT_WWW" = "yes" ]
    then
	if [ ! -w $TOOLCOUNTER ]
	then
	    touch $TOOLCOUNTER
	    REPORTNO=1
	    PREV=0
	    NEXT=2
	    cat > $TOOLCOUNTER <<EOF
$REPORTNO
EOF
	else
	    read REPORTNO < $TOOLCOUNTER
	    REPORTNO=`expr $REPORTNO + 1`
	    PREV=`expr $REPORTNO - 1`
	    NEXT=`expr $REPORTNO + 1`
	    cat > $TOOLCOUNTER <<EOF
$REPORTNO
EOF
	fi
    fi
fi

if [ "$BETASTAT" = "yes" ]
then
    # error!
    if [ "$BETAREPORT_WWW" = "yes" ]
    then
	magic="`whoami` | $MACHINETYPE | `hostname` | `date` | $$ | $* $REPORTNO"
    else
	magic="`whoami` | $MACHINETYPE | `hostname` | `date` | $$ | $*"
    fi
    if [ -w $STATFILE ]
    then
	echo 'fatal:' $magic >> $STATFILE
    fi
fi

trap "" 2

if [ -w $ERRFILE ] 
then 
	cat $ERRFILE
fi
 
if [ "$BETAREPORT" = "yes" ]
then
        echo BETALIB="$BETALIB" > $TMPFILE
        echo LOCATION=$LOCATION >> $TMPFILE
        echo EXECNAME=$EXECNAME >> $TMPFILE
        echo "$magic" >> $TMPFILE
        echo Description:  >> $TMPFILE
        echo "----------"  >> $TMPFILE

        echo ""
        echo "****** ${EXECNAME} has exited with fatal error ******"
        echo Please enter a short description of the situation leading to this.
        echo "Stop by typing ^D:"
	cat		   >> $TMPFILE
        echo "----------"  >> $TMPFILE
        echo ""            >> $TMPFILE
        echo Dumpfile:     >> $TMPFILE
        echo "----------"  >> $TMPFILE
        if [ -f "$EXECNAME".dump ]
        then
	    dump="`pwd`/$EXECNAME".dump

	    if  [ "$BETAREPORT_WWW" = "yes" ]
	    then
		if [ -w $TOOLINDEX ]
		then
		    LINE1=`head -1 "$EXECNAME".dump  | sed -e 's/</\&lt;/g' -e 's/>/\&gt;/g'`
		    LINE5=`head -5 "$EXECNAME".dump | tail -1 | sed -e 's/</\&lt;/g' -e 's/>/\&gt;/g' `
		    LINE6=`head -6 "$EXECNAME".dump | tail -1 | sed -e 's/</\&lt;/g' -e 's/>/\&gt;/g' `
		    echo '<br> '$TODAY' <a href="http:'$REPORTNO'.html"> '$REPORTNO '</a>  `whoami` <br>' $LINE1 '<br>' $LINE5 '<br>' $LINE6 '<br>' >>$TOOLINDEX

		fi
	    fi

	    ls -l $dump                      >> $TMPFILE
	    echo ""                          >> $TMPFILE
	    cat "$EXECNAME".dump | head -500    >> $TMPFILE
        else

	    if  [ "$BETAREPORT_WWW" = "yes" ]
	    then
		if [ -w $TOOLINDEX ]
		then
		    echo '<br><a href="http:'$REPORTNO'.html"> '$TODAY' '$REPORTNO `whoami` '</a><br>' No dumpfile '<br>' Probably: Cannot open display '<br>'  >>$TOOLINDEX
		fi
	    fi

	    echo "(no dumpfile)"             >> $TMPFILE
	    if [ -w $ERRFILE ] 
	    then 
		cat $ERRFILE  | head -500 >> $TMPFILE
	    fi
        fi
        echo "----------"                  >> $TMPFILE

	if  [ "$BETAREPORT_EMAIL" = "yes" ]
	then
	    echo Sending error report to $TO with Cc to $CC
        (echo To: ${TO}; echo Cc: ${CC}; echo Subject: Automatic "$APPLICATION" error report; \
         echo "";                                                    \
         cat $TMPFILE;                                  \
         ) | ${MAIL}
	fi

	if  [ "$BETAREPORT_WWW" = "yes" ]
	then
	    REPORTFILE="$REPORTDIR"/"$REPORTNO".html
	    touch $REPORTFILE
            chmod a+r $REPORTFILE
            chmod a+w $REPORTFILE

	    echo '<title>' $TODAY"."$REPORTNO '</title>' '<br><a href="http:'$PREV.html'"> 'Previous'</a>' '<a href="http:'$NEXT.html'"> 'Next'</a>' '<a href="http:index.html">Overview</a><pre>' > $REPORTFILE 

	    cat $TMPFILE | sed -e 's/</\&lt;/g' -e 's/>/\&gt;/g'  >> $REPORTFILE 
	    # to substitute < and > with &lt; and &gt; resp.
	fi
        rm -f $TMPFILE
fi

rm -f $ERRFILE

esac

# give an appropriate exit code
case $STATUS in
NORMAL)
    exit 0;;
INTERRUPT)
    exit 1;;
*)
    exit 1;;
esac