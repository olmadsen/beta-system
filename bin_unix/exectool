#!/bin/sh

#set -x

##############################################################################
#     CHANGE THESE ACCORDING TO THE CURRENT INSTALLATION
##############################################################################

INSTALLATION=student
RELEASE=r5.2
BUGS_SUPERVISOR=ess-betastat@mjolner.dk

##############################################################################
#     PLEASE DO NOT CHANGE BELOW THIS LINE
##############################################################################

MAIL="/usr/lib/sendmail -t"
TMPFILE0=/tmp/$APPLICATION.0.$$
TMPFILE=/tmp/$APPLICATION.$$
ERRFILE=/tmp/$APPLICATION.ERR.$$
ERRCODEFILE=/tmp/$APPLICATION.ERRCODE.$$
LOGFILEINREPORT=yes
ARGS=$*
PID=$$

#TODAY="`date +%y%m%d`"
TODAY=`sh -c 'LC_TIME="C"; export LC_TIME; date'`

# The following is no longer needed since this is done by
# $BETALIB/configuration/env.sh, which is dotted by all scripts.
if [ "$MACHINETYPE" = "SGI" ]
then
  LD_LIBRARY_PATH=${LOCATION}:${BETALIB}/lib/${objdir}:${LD_LIBRARY_PATH}
  export LD_LIBRARY_PATH
fi

if [ ! -f "$LOCATION/$EXECNAME" ]
then
	echo "$APPLICATION" is currently not available on $MACHINETYPE
	exit 0
fi

# remove dump file if possible.
if [ -f "$EXECNAME".dump ]
then
        /bin/rm -f "$EXECNAME".dump
fi
if [ -f "$EXECNAME".dump ]
then
        # rm failed
#        /bin/mv -f "$EXECNAME".dump /tmp
    echo "old dumpfile: $EXECNAME.dump could not be removed"
fi

# remove log file if possible.
if [ -w "$EXECNAME".log ]
then
        /bin/rm -f "$EXECNAME".log
fi
if [ -f "$EXECNAME".log ]
then
        # rm failed
    echo "old logfile: $EXECNAME.log could not be removed"
    LOGFILEINREPORT=no
fi


SendErrorStatistics () {
# This procedure is report breakdowns of the tool
# in order to improve the tool robustness

  if [ "$BETASTAT" = "yes" ]
  then
    cmd=$1;
    shift
    (echo To: ${BUGS_SUPERVISOR}; \
     echo Subject: ${INSTALLATION}-${APPLICATION}-${RELEASE}; \
     echo ""; \
     echo $cmd `whoami` '|' $MACHINETYPE '|' `hostname` '|' \
     `sh -c 'LC_TIME="C"; export LC_TIME; date'` '|' $PID '|' $*) \
    | ${MAIL}

    if [ -w $STATFILE ] 
    then
      echo $cmd `whoami` '|' $MACHINETYPE '|' `hostname` '|' `sh -c 'LC_TIME="C"; export LC_TIME; date'` '|' $$ '|' $* >> $STATFILE
    fi
  fi
}

SendErrorStatistics 'start:' $ARGS

# execute

# trap user interrupt - exit 1 in this case:
# in case this script was invoked from a make file or perl
# this will stop make/perl too.
# Also remove ERRFILE and ERRCODEFILE, which are both opened
# by the sh-command below (and the interrupt typically comes
# during execution of this).

trap "echo ''; echo 'User Interrupt'; \
SendErrorStatistics 'interrupt:  ' $ARGS code\(130\); \
/bin/rm -f $ERRFILE $ERRCODEFILE "$EXECNAME".log; \
if [ -w "$EXECNAME".log ]; \
then \
/bin/rm -f "$EXECNAME".log; \
fi; \
exit 1\
" 2

touch $ERRFILE
if [ -w $ERRFILE ] 
then
	#hack to collect exit code from $EXECNAME instead of tee:
	sh -c "$LOCATION/$EXECNAME $DEFAULTOPTIONS $*; NUMSTAT=\$?; echo \$NUMSTAT>$ERRCODEFILE " 2>&1 | tee $ERRFILE
	NUMSTAT=`cat $ERRCODEFILE`
	/bin/rm -f $ERRCODEFILE;
	echo "Exitcode: $NUMSTAT" >> $ERRFILE
else
	$LOCATION/$EXECNAME $DEFAULTOPTIONS $* 
	NUMSTAT=$?
fi



# check status

case $NUMSTAT in
0)	STATUS="NORMAL"
	;;

# kill -1, kill -HUP
129)	STATUS="INTERRUPT"
	;;

# kill -2, kill -INT
130)	STATUS="INTERRUPT"
	;;

# kill -3, kill -QUIT
131)	STATUS="INTERRUPT"
	;;

# kill -9, kill -KILL
137)	STATUS="INTERRUPT"
	;;

# kill -15, kill -TERM
143)	STATUS="INTERRUPT"
	;;

# kill -23, kill -STOP
151)	STATUS="INTERRUPT"
	;;

# kill -24, kill -TSTP
152)	STATUS="INTERRUPT"
	;;

# Xlib Fatal error, window killed or X shutdown.
32)	STATUS="INTERRUPT"
	;;

# others
*)	STATUS="ERROR"
esac

case $STATUS in

NORMAL)
        # normal exit
        SendErrorStatistics 'end:  ' $ARGS
	if [ -w $ERRFILE ] 
	then 
		#cat $ERRFILE
		/bin/rm -f $ERRFILE
	fi
	if [ -w "$EXECNAME".log ] 
	then 
	        /bin/rm -f "$EXECNAME".log
	fi
        ;;

INTERRUPT)
	#interupted
        SendErrorStatistics 'interrupt:' code\($NUMSTAT\)
	if [ -w $ERRFILE ] 
	then 
		#cat $ERRFILE
		/bin/rm -f $ERRFILE
	fi
	if [ -w "$EXECNAME".log ] 
	then 
	        /bin/rm -f "$EXECNAME".log
	fi
        ;;

*)

if [ "$BETAREPORT" = "yes" ]
then
    if  [ "$BETAREPORT_WWW" = "yes" ]
    then
	if [ -w $TOOLCOUNTER ]
	then
	    # REPORTNO=`cat $TOOLCOUNTER`
	    read REPORTNO < $TOOLCOUNTER
	    if [ "$REPORTNO" = "" ]; then REPORTNO="0"; fi
	    REPORTNO=`expr $REPORTNO + 1`
	    PREV=`expr $REPORTNO - 1`
	    NEXT=`expr $REPORTNO + 1`
	    # echo $REPORTNO > $TOOLCOUNTER
	    cat > $TOOLCOUNTER <<EOF
$REPORTNO
EOF
	fi
    fi
fi

if [ "$BETAREPORT_WWW" = "yes" ]
then
  SendErrorStatistics 'fatal:' $ARGS $REPORTNO
else
  SendErrorStatistics 'fatal:' $ARGS
fi

trap "" 2

#if [ -w $ERRFILE ] 
#then 
#	$ERRFILE
#fi
 
if [ "$BETAREPORT" = "yes" ]
then
        echo BETALIB="$BETALIB" > $TMPFILE
        echo LOCATION=$LOCATION >> $TMPFILE
        echo EXECNAME=$EXECNAME >> $TMPFILE
	echo 'fatal:' `whoami` '|' $MACHINETYPE '|' `hostname` '|' \
	`sh -c 'LC_TIME="C"; export LC_TIME; date'` '|' $PID '|' $ARGS >> $TMPFILE
	if [ -x /usr/sbin/top ] 
	then
        	echo Top:  >> $TMPFILE
	        echo "----------"  >> $TMPFILE
	    	/usr/sbin/top >> $TMPFILE
	        echo "----------"  >> $TMPFILE
	fi
        echo Description:  >> $TMPFILE
        echo "----------"  >> $TMPFILE

        echo ""
        echo "****** ${EXECNAME} has exited with fatal error ******"
	echo In order to find the cause of the error we need your help. 
	echo Please enter a short description of the situation leading to the crash.
	echo "The description will be mailed to the developers of the ${EXECNAME} tool."
	echo The dump file and the console output will automatically be included in the mail,
	echo but any further information is appreciated.
	echo ""
        echo "Stop by typing ^D:"
	cat - 		   > $TMPFILE0
	cat $TMPFILE0 >> $TMPFILE
	echo ""
	echo "Thank you!"

        echo "----------"  >> $TMPFILE
        echo ""            >> $TMPFILE
        echo Dumpfile:     >> $TMPFILE
        echo "----------"  >> $TMPFILE
        if [ -f "$EXECNAME".dump ]
        then
	    dump="`pwd`/$EXECNAME".dump

	    if  [ "$BETAREPORT_WWW" = "yes" ]
	    then
		if [ -w $TOOLINDEX ]
		then
		    echo '<pre><a href="http:'$REPORTNO'.html">'$REPORTNO'</a>' `whoami` $TODAY $MACHINETYPE >>$TOOLINDEX
		    head -1 "$EXECNAME".dump | sed -e 's/</\&lt;/g' -e 's/>/\&gt;/g'                           >>$TOOLINDEX
                    head -8 "$EXECNAME".dump | tail -4 | sed -e 's/</\&lt;/g' -e 's/>/\&gt;/g' | grep -v '^$'  >>$TOOLINDEX
		    echo '</pre><sp>' >> $TOOLINDEX
		    cat  $TMPFILE0  >> $TOOLINDEX
		    echo '<sp><hr>' >> $TOOLINDEX
		fi
	    fi

	    ls -l $dump                      >> $TMPFILE
	    echo ""                          >> $TMPFILE
	    cat "$EXECNAME".dump | head -500    >> $TMPFILE
        else

	    if  [ "$BETAREPORT_WWW" = "yes" ]
	    then
		if [ -w $TOOLINDEX ]
		then
		    echo '<pre><a href="http:'$REPORTNO'.html">'$REPORTNO'</a>' `whoami` $TODAY '<br>' No dumpfile '<br></pre>'  >>$TOOLINDEX
		fi
	    fi

	    echo "(no dumpfile)"             >> $TMPFILE
	    
        fi

        echo "----------"                  >> $TMPFILE
        echo ""            >> $TMPFILE

        if [ -w $ERRFILE ] 
	then 
            echo "Output:"                  >> $TMPFILE
            echo "----------"                  >> $TMPFILE
	    cat $ERRFILE  | head -500 >> $TMPFILE
	fi

        if [ -r "$EXECNAME".log -a "$LOGFILEINREPORT" = "yes" ] 
	then 
	    echo "----------"                  >> $TMPFILE
	    echo ""            >> $TMPFILE
            echo "Logfile:"                  >> $TMPFILE
            echo "----------"                  >> $TMPFILE
	    cat "$EXECNAME".log  | head -500 >> $TMPFILE
	fi

        echo "----------"                  >> $TMPFILE
        echo ""            >> $TMPFILE

	if  [ "$BETAREPORT_EMAIL" = "yes" ]
	then
	    echo The error report has been sent to $MAILTO with Cc to $MAILCC
        (echo To: ${MAILTO}; echo Cc: ${MAILCC}; echo Subject: Automatic "$APPLICATION" error report: "$REPORTNO"; \
         echo "";                                                    \
         cat $TMPFILE;                                  \
         ) | ${MAIL}
	fi

	if  [ "$BETAREPORT_WWW" = "yes" ]
	then
	    if  [ -w  $REPORTDIR ] 
	    then
		REPORTFILE="$REPORTDIR"/"$REPORTNO".html
		touch $REPORTFILE
		chmod a+r $REPORTFILE
		chmod a+w $REPORTFILE

		echo '<title>' $REPORTNO '</title>' '<br><a href="http:'$PREV.html'"> 'Previous'</a>' '<a href="http:'$NEXT.html'"> 'Next'</a>' '<a href="http:index.html">Overview</a><pre>' > $REPORTFILE 

		cat $TMPFILE | sed -e 's/</\&lt;/g' -e 's/>/\&gt;/g'  >> $REPORTFILE 
		# to substitute < and > with &lt; and &gt; resp.
	    fi
	fi
        /bin/rm -f $TMPFILE0
        /bin/rm -f $TMPFILE
fi

/bin/rm -f $ERRFILE
if [ -w "$EXECNAME".log ]
then
        /bin/rm -f "$EXECNAME".log
fi

esac

# give an appropriate exit code - see trap for user interrupt above
# for motivation for this.
exit $NUMSTAT
