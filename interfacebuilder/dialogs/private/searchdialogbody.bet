ORIGIN '../searchdialog';
INCLUDE '~beta/guienv/v1.4/controls';
INCLUDE '~beta/basiclib/v1.5/regexp';

-- searchDialogopen: doPart --
do Private.open;
   
   
-- searchDialogPrivate: descriptor --
(# 
   open: (#
         do 
            (400, 150)->size;
            'Find Dialog'->title;
            CloseBtn.open;
            (5,5)->CloseBtn.position;
            sep1.open;
            (0,30)->sep1.position;
            expressionField.open;
            (100,45)->expressionField.position;
            Findtext.open;
            (10,45)->FindText.position;
            CaseSensitiveBtn.open;
            (10,85)->CaseSensitiveBtn.position;
            WrapBtn.open;
            (150,85)->WrapBtn.position;
            sep2.open;
            (0,110)->sep2.position;
            FindBtn.open;
            (5,120)->FindBtn.position;
         #);
   
    CloseBtn: @PushButton
     (# EventHandler::<
          (# onMouseUp::< 
               (# 
               do this(SearchDialog).Close;
               #);
          #);
        Open::<
          (#
          do 'Close' -> Label;
             (60,20) -> Size;
             True -> BindBottom;
             False -> BindTop;
          #);
     #);
   sep1: @separator
          (#
             open::<
               (# do (400,0)->size;
               #);
          #);
   Findtext: @StaticText
     (#
        open::<
          (#
          do
             (40,20)->size;
             'Find:'->label;
          #);
     #);
   expressionField: @TextField
     (#
        Open::<
          (#
          do 
             (250,30) -> Size;
          #);
     #);
   caseSensitive: @Boolean;
   CaseSensitiveBtn: @Checkbox
     (# 
        EventHandler::<
          (# onStateChanged::<
               (#
               do (not caseSensitive)->caseSensitive;
                  (if caseSensitive then
                      'Case Sensitive'->label;
                   else
                      'Not Case Sensitive'->label;
                  if);
               #);
          #);
        open::<
          (#
          do (140,15)->size;
             true -> caseSensitive;
             'Case Sensitive'->label;
          #);   
     #);
   
   wrap: @Boolean;
   WrapBtn: @Checkbox
     (# 
        EventHandler::<
          (# onStateChanged::<
               (#
               do (not wrap)->wrap;
                  (if wrap then
                      'Wrap'->label;
                   else
                      'Not Wrap'->label;
                  if);
               #);
          #);
        open::<
          (#
          do (80,15)->size;
             'Wrap'->label;
          #);   
     #);

   sep2: @separator
          (#
             open::<
               (# do (400,0)->size;
               #);
          #);
   FindBtn: @PushButton
     (# 
        EventHandler::<
          (# onMouseUp::< 
               (# t:^text;
               do 'on Mouse up'->putline;
                  expressionField.contents->putline;
                  expressionField.contents->t[];
                  t->mkTextRef->Find;
               #);
          #);
        Open::<
          (#
          do 'Find' -> Label;
             (60,20) -> Size;
             True -> BindBottom;
             False -> BindTop;
          #);
     #);   
#)


-- textFieldSearch: DoPart --
   
do 
   (# regex: ^text;
      fieldcontents:^text;
      pos:@integer;
   do 
      searchText[]->regex[];
      (if regex.length // 0 then 'tom string'->putline;
       else
          'selectiuon'->putline;
          selection.start->putint;
          ' '->putline;
          selection.end->putint;
          ' '->putline;
          (if selection.end // 0 then
              contents->fieldcontents[];
           else
              contents->fieldcontents[];
              (selection.end+1,fieldcontents.length)->fieldcontents.sub->fieldcontents[];
          if);
          
          (if fieldcontents.length //0 then 'tom textfield'->putline;
           else
              fieldcontents[]->putline;
              0->fieldcontents.pos;
              regex[]->fieldcontents.regexp_search
              (#noMatch::< (# do 'No match'->putline;
                           #);
              do (for i: 1 repeat
                      (*'i is'->putline;
                      i->putint;*)
                      (if (i-1->regs.start) >= 0 // true then
                          (i-1->regs.start)+1->putint;
                          ' '->putline;
                          i-1->regs.end->putint;
                          ((i-1->regs.start)+1, i-1->regs.end)->fieldcontents.sub->putline;
                          ((i-1->regs.start)+selection.end)->pos;
                          (pos, pos+regex.length)->selection.set;
                      if)
                 for);
              #);
          if);
      if);
   #)

