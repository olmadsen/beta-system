ORIGIN '../fragmenteditor'
[[
-- INCLUDE '~beta/guienv/v1.3.1/stddialogs'
-- INCLUDE '~beta/guienv/v1.3.1/controls'
-- INCLUDE '~beta/guienv/v1.3.1/fields'
-- Include '~beta/guienv/v1.3.1/scrolllists'
-- Include '~beta/guienv/v1.3.1/styledtext'
-- Include 'propertyparser'
-- INCLUDE '~beta/basiclib/v1.4/regexp'
-- Include '~beta/interfacebuilder/v1.0/guienvadds/guienvadds'
-- INCLUDE '~beta/interfacebuilder/v1.0/guienvadds/listview'

-- WindowLib: Attributes --
     button: pushbutton
       (#
          command:< Object;
          eventHandler::<
            (#  onMouseUp::<
                 (# 
                 do command;
                 #);
            #);
          open::<
            (# 
            do (60,20) -> size;
               inner;
            #);
       #);

--FragmentEditorOpen: Descriptor --
(#
do
   (550,480)->Size;
   Properties.open;
   Fragments.open;
   INNER open;
#)


--FragmentEditorPropertiesOpen: Descriptor --
(# 
do 
   (3,10)->position;
   (540,190)->Size;
   'Properties'->label;
   Private.PropertiesText.open;
   Private.RevertButton.open;
   Private.ParseButton.open;
   Private.OpenButton.open;
   true -> bindRight;
   INNER open;
#)


--FragmentEditorPropertiesState: Descriptor --
(# 
do 
   (if value<>ChangedFlag then
       value->ChangedFlag;
       (if ChangedFlag then
           Private.ParseButton.enable;
           Private.RevertButton.enable;
           Private.OpenButton.enable;
        else
           Private.ParseButton.disable;
           Private.RevertButton.disable;
           Private.OpenButton.disable;
       if);
   if);
#)

--FragmentEditorPropertiesPrivate: Descriptor --
(#
   OpenNewGroup:<
     (# name: ^text;
        theGroup: ^MPS.fragmentGroup;
        theFragmentEditor:^fragmentEditorWindow;
        fragmentEditorWindowType: ##fragmentEditorWindow;
     enter name[]
     do
        (name[], screen[]) -> MPS.top.open -> theGroup[];
        (if theGroup[]<>none then
            this(fragmentEditorWindow).struc -> fragmentEditorWindowType##;
            &fragmentEditorWindowType[] -> theFragmentEditor[];
            theGroup[] -> theFragmentEditor.init;
        if);
     #);
   
   OpenButton: @button
     (# command::< (# 
                   do OpenNewGroup;   
                   #);   
        open::<(# do
                  'Open'->label;
                  (70,20)->size;
                  (440,30)->position;
                  true -> bindRight;
                  false -> bindleft;
                  disable;
               #);
     #);
   RevertButton: @button
     (# command::< (# 
                   do    
                      PropertiesText.prettyprint;
                   #);   
        open::<(# do
                  'Revert'->label;
                  (70,20)->size;
                  (440,70)->position;
                  disable;
                  false -> bindleft;
                  true -> bindRight;
               #);
        
     #);
   ParseButton: @button
     (# command::< (# 
                   do  
                      PropertiesText.parse;
                   #);
        open::<(# do 'Parse'->label;
                  (70,20)->size;
                  (440,110)->position;
                  disable;
                  false -> bindleft;
                  true -> bindRight;
               #);
     #);
   
   
   PropertiesText: @TextEditor
     (#
        changed: @boolean;
        count: @integer;
        
        open::<(# 
               do
                  (5,20)->position;
                  (400,150)->size;
                  PropertiesText.init;   
                  true -> bindright;
               #);
        init:<(# 
              do contents[]->theTextField[];
                 prettyPrint;
              #);
        prettyPrint:<
          (# st: ^styledtext;
          do    
             &styledtext[]->st[];
             (theFragmentGroup.prop[],st[]) -> pretty.printProperties;
             st[]->textContents;
          #);
        
        Parse:<
          (# TextToParse: ^text;
             parseOK: @boolean;
             errorText: @text;
             fg: ^MPS.fragmentGroup;
             prop: ^propertyList;
          do
             (*   fg.fragmentList.scan
              (# 
              do (if current.type//MPS.linkType then
              Delete current 
              if);
              #);*)
             theFragmentGroup[] -> fg[];
             TextContents -> TextToParse[];
             TextToParse.reset;
             &propertyList[] -> prop[];
             prop.init;
             parsing: (TextToParse[], screen[],prop[]) -> MPS.parseProperty
             (#
                parseErrors::<
                  (# 
                  do leave parsing;
                  #);
             #) -> parseOK;
             (if parseOK then
                 prop[] -> theFragmentGroup.prop[];
                 false->Changed;
                 PropertiesText.prettyprint;
                 ' parse ok \n'->putline;
              else
                 ' parse not ok \n'->putline;
             if);
             
          #);
        
        TextContents: 
          (#
             st:^styledText;
          enter (#   
                enter st[]
                do 
                   0->count;
                   false->Changed->State;
                   st[]->theTextField.contents;
                #)
          exit (# do theTextField.contents->st[];
               exit st[]
               #)
          #);
        theTextField: ^TextField;
        contentsType::<
          (#
             eventHandler::< 
               (#
                  onMouseDown::<
                    (# groupname: ^text;
                    do
                       &text[]->groupname[];
                       (if doubleClick//true then
                           'doubleclick'->putline;
                           'groupname'->putline;
                           selection.start->putint;
                           selection.end->putint;
                           selection.contents->groupname[];
                           groupname[]->putline;
                           (if 1->groupname.inxget // '''' then 'yes1'->putline; if);
                           (if groupname.length->groupname.inxget // '''' then 'yes2'->putline; if);
                           OpenButton.enable;         
                       if);
                    #);
                  
                  onTextChanged::<
                    (# 
                    do 
                       count + 1 ->count;
                       'text changed ' -> putText;
                       count -> putInt;
                       newLine;
                       (if (count > 1) then 
                           true->Changed->State;
                       if);
                   #);
               #);
          #);
     #);
#)
   

--FragmentEditorFragmentsOpen: Descriptor --
(# st: ^styledtext;
do 
   (3,220)->position;
   (540,250)->size;
   'Fragments'->label;
   Private.OpenButton.open;
   Private.NewButton.open;
   Private.UpdateButton.open;
   Private.DeleteButton.open;
   Private.FragmentField.open;
   Private.NameField.open;
   Private.TypeOptionButton.open;
   (*&styledtext[]->st[];*)
   (*st[]->contents.contents;*)
   true -> bindRight -> bindBottom;
   INNER open;
#)

--FragmentEditorFragmentsPrivate: Descriptor --
(#
   NewFragment: @Boolean;
   OpenButton: @button
     (# command::< (# 
                   do (* frag[] -> openFragment *)
                   #);   
        open::<(# do
                  'Open'->label;
                  (70,20)->size;
                  (440,30)->position;
                  false -> bindleft;
                  true -> bindRight;
               #);
        
     #);
   NewButton: @button
     (# command::< (# 
                   do New;    
                   #);   
        open::<(# do
                  'New'->label;
                  (70,20)->size;
                  (440,70)->position;
                  false -> bindleft;
                  true -> bindRight;
               #);
        
     #);
   DeleteButton: @button
     (# command::< (# 
                   do Delete;    
                   #);   
        open::<(# do
                  'Delete'->label;
                  (70,20)->size;
                  (440,110)->position;
                  false -> bindleft;
                  true -> bindRight;
               #);
        
     #);
   UpdateButton: @button
     (# command::< (# 
                   do 
                      UpdateFragments;
                   #);
        open::<(# do 'Update'->label;
                  (70,20)->size;
                  (440,150)->position;
                  disable;
                  false -> bindleft;
                  true -> bindRight;
                 
               #);
     #);
   
   Delete:<
     (#
     do          
        (if NewFragment // false
            then (FragmentField.Selection.last,1)->FragmentField.delete;
        if);
        UpdateButton.disable;
        NameField.clearText;
        TypeOptionButton.disable;
        NameField.disable;

        (* delete fra Fragmentlist in MPS *)
     #);
   
   UpdateFragments:<
     (# st: ^styledText;
        groupname:^text;
        pos: @integer;
        theFragmentForm: ^MPS.fragmentForm;
        ff: ^MPS.fragmentForm;   
        betaGram: ^MPS.beta; 
     do 
        &styledtext[]->st[];
        NameField.contents->st[];
        ': '->st.append;
        (if TypeoptionButton.currentitem
         // 1 then 'Descriptor'->st.append;
         // 2 then 'Attributes'->st.append;
         // 3 then 'DoPart'->st.append;
        if);
        (if NewFragment
         //true then 
            
            NameField.contents->groupname[];
            (* make new FragmentForm *)
            MPS.grammarTable.beta[] -> betaGram[];
            betaGram[] -> MPS.newFragmentForm -> ff[];
            (if ff[]<>none then
                groupname[] -> ff.name;
                (* set category *)
                ff[] -> theFragmentGroup.fragmentList.addFragment;
                (st[],ff[],TypeOptionButton.currentItem)->FragmentField.makeNewItem;    
            if);
            (*insert in Fragmentlist *)   
         else
            st[]->FragmentField.UpdateItem;
            (* Update the old name in Fragmentlist*)    
        if);
        UpdateButton.disable;
        NameField.clearText;
        TypeOptionButton.disable;
        NameField.disable;
        
     #);
   
   New:< 
     (# 
     do
        true->newFragment;
        TypeOptionButton.enable;
        NameField.enable;
        NameField.cleartext;
        UpdateButton.enable;
     #);
   
   FragmentField: @listView
     (# selectText: ^text;
        count: @integer;
        changed: @boolean;
        selectedItem:^fragItem;
        updateItem:
          (# name:^text;
          enter name[]
          do
             name[]->selectedItem.name;
             (* name[]->selectedItem.frag.name[] *);
          #);
        makeNewItem:
          (# name: ^text;
             frag:^MPS.fragmentform;
             category: @integer;
             newfragItem:^fragItem;
          enter (name[],frag[],category)
          do
             &fragItem[]->newfragItem[];
             selectedItem[]->newfragitem.init;
             name[]->newfragitem.name;
             category->newfragitem.category;
             frag[]->newfragitem.frag[];
             
          #);
        fragItem: listItem
          (# frag: ^MPS.fragmentForm;
             category: @integer;
             onSelect::<
               (# t:^text;
                  st: ^styledtext;
               do this(fragItem)[]->selectedItem[];
                  (if doubleClick then
                      'open' -> putLine;
                   else
                      &text[]->t[];
                      &styledtext[]->st[];
                      false->Newfragment;
                      TypeOptionButton.enable;
                      NameField.enable;
                      UpdateButton.enable;
                      DeleteButton.enable;
                      'frag name'-> putline;
                      frag.name->putline;
                      frag.name->t[];
                      (*name->t[];*)
                      t->st;
                      st[]->NameField.contents;
                      (if true
                       // 1 = category then
                          'ok'->putline;
                          1->TypeOptionButton.CurrentItem;
                          false->TypeMenu.attributeType.enable;
                          false->TypeMenu.DoPartType.enable;
                       // 2 = category then
                          2->TypeOptionButton.CurrentItem;
                          false->TypeMenu.descriptorType.enable;
                          false->TypeMenu.DoPartType.enable;
                       // 3 = category  then
                          3->TypeOptionButton.CurrentItem;
                          false->TypeMenu.descriptorType.enable;
                          false->TypeMenu.DoPartType.enable;
                      if);
                  if);
               #);
             
          #);
        
        Open::<
          (# do
             (5,20)->position;
             (400,170)->Size;
             true -> bindRight -> bindBottom;
             FragmentField.init;             
             true->singleSelection;
          #);
        Init:
          (# 
             st: ^styledtext;
          do    
             &styledtext[]->st[];
             theFragmentGroup.fragmentlist.scan(# theFragmentForm: ^MPS.fragmentForm;
                                                  newFragItem:^fragItem;
                                               do 
                                                  st.clear;
                                                  (if current.type//MPS.formType then
                                                      screen[] -> current.open -> theFragmentForm[];
                                                      (if theFragmentForm.category 
                                                       // betaGram.DescriptorForm then
                                                          &fragItem[]->newfragItem[];
                                                          newfragitem.init;
                                                          current.name[]->st.append;
                                                          ': Descriptor'->st.append;
                                                          st[]->newfragItem.name;
                                                          theFragmentForm[]->newfragitem.frag[];
                                                          1->newfragitem.category;
                                               
                                                       // betagram.AttributesForm then
                                                          &fragItem[]->newfragItem[];
                                                          newfragitem.init;
                                                          current.name[]->st.append;
                                                          ': Attributes'->st.append;
                                                          st[]->newfragItem.name;
                                                          theFragmentForm[]->newfragitem.frag[];
                                                          2->newfragitem.category;
                                                          
                                                       // betagram.doPart then
                                                          &fragItem[]->newfragItem[];
                                                          newfragitem.init;
                                                          current.name[]->st.append;
                                                          ': DoPart'->st.append;
                                                          st[]->newfragItem.name;
                                                          theFragmentForm[]->newfragitem.frag[];
                                                          3->newfragitem.category;
                                                      if);
                                                  if);
                                               #);
          #);

        
     #);
   NameField: @TextField
     (# 
        Cleartext:
        (# t: ^styledtext;
        do
           &styledText[] -> t[];
           t[]->contents;   
        #);
        Open::<
          (# do
             (5,200)->position;
             (300,30)->Size;
             true -> bindBottom;   
             false -> bindTop;
             disable
          #);
     #);

   TypeMenu: @menu
     (# attributeType: @MenuItem
          (#  enable: @boolean;
              eventHandler::<
                      (# onSelect::<
                           (# 
                           do 
                           #);
                         onStatus::< (# do (if enable//false then
                                               false->value;
                                           'on status'->putline;    
                                           if);
                                     #);
                      #);
             #);

        doPartType : @Menuitem
          (#  enable: @boolean;
              eventHandler::<
                      (# onSelect::<
                           (# 
                           do 
                           #);
                         onStatus::< (# do (if enable//false then
                                               false->value;
                                           if);
                                     #);
                      #);
          #);
        descriptorType: @MenuItem
          (#  enable: @boolean;
              eventHandler::<
                      (# onSelect::<
                           (# 
                           do 
                           #);
                         onStatus::< (# do (if enable//false then
                                               'on status' ->putline;
                                               false->value;
                                               
                                           if);
                                     #);
                      #);
             #);
        open::<
          (#
          do 
             attributeType.open;
             'Attributes'->attributeType.name;
             doPartType.open;
             'DoPart'->doPartType.name;
             descriptorType.open;
             'Descriptor'->descriptorType.name;
             descriptorType[]->append;
             attributeType[]->append;
             doPartType[]->append;
          #);
     #);
   TypeoptionButton: @OptionButton
     (#
        open::<
          (#
          do 
             (330,200)->position;
             TypeMenu.open;
             TypeMenu[]->popupMenu;
             true -> bindBottom;
             false -> bindtop;
             preferredSize -> Size;
             ':'->label;
          #);
     #);
   
   
#)





--FragmentEditorFragmentsPrettyPrint: Descriptor --
(# st: ^styledtext;
do    

#)
(*
--FragmentEditorFragmentsParse: Descriptor --
(# TextToParse: ^text;
   parseOK: @boolean;
   line: ^text;
   regexpr:^text;
do    
   TextContents -> TextToParse[];
   TextToParse.reset;
   true->parseOK;
   '[a-zA-z][a-zA-Z0-9_]*[ \t]*:[ \t]*\\(Descriptor\\|Attributes\\|DoPart\\)'->regexpr[];
   *)

   (*
   L:
     (# 
     do (if (TextToParse.eos) then
            leave L;
         else
            TextToParse.getline->line[];
            line[]->putline;
            (if line.length // 0 then restart L; if);
            0->line.pos;
            regexpr[] ->line.regexp_match
            (# noMatch::< (#do '\t no match'->putline; 
                             false->parseOK #)
            #);
            restart L;
        if)
     #);
   
   TextToParse.getline->line[];
   line[]->putline;
   (if parseOK then
       ' parse ok \n'->putline;
    else
       ' parse not ok \n'->putline;
   if);
#)



--FragmentEditorFragmentscTeHonMouseDown : Descriptor --
(# do 
#) 


--FragmentEditorFragmentscTeHonTextChanged: Descriptor --
(# do 
   count + 1 ->count;
   'text changed ' -> putText;
   count -> putInt;
   newLine;
   (if (count > 1) then 
       true->Changed->State;
   if);
#) 
*)
--]]












