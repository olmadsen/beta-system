ORIGIN '../fragmenteditor'
[[
-- INCLUDE '~beta/guienv/v1.2/stddialogs'
-- INCLUDE '~beta/guienv/v1.2/controls'
-- INCLUDE '~beta/guienv/v1.2/fields'
-- Include '~beta/guienv/v1.2/scrolllists'
-- Include '~beta/guienv/v1.2/styledtext'
-- Include 'propertyparser'
-- INCLUDE '~beta/basiclib/v1.4/regexp'
-- Include '~beta/interfacebuilder/v1.0d/guienvadds/guienvadds'
-- INCLUDE '~beta/interfacebuilder/v1.0d/guienvadds/listview'

--FragmentEditorOpen: Descriptor --
(#
do
   (550,480)->Size;
   Properties.open;
   Fragments.open;
   INNER open;
#)


--FragmentEditorPropertiesOpen: Descriptor --
(# 
do 
   (3,10)->position;
   (540,190)->Size;
   'Properties'->label;
   Private.PropertiesText.open;
   Private.RevertButton.open;
   Private.ParseButton.open;
   Private.OpenButton.open;
   true -> bindRight;
   INNER open;
#)


--FragmentEditorPropertiesState: Descriptor --
(# 
do 
   (if value<>ChangedFlag then
       value->ChangedFlag;
       (if ChangedFlag then
           Private.ParseButton.enable;
           Private.RevertButton.enable;
        else
           Private.ParseButton.disable;
           Private.RevertButton.disable;
       if);
   if);
#)

--FragmentEditorPropertiesPrivate: Descriptor --
(#
   OpenButton: @button
     (# command::< (# 
                   do    
                   #);   
        open::<(# do
                  'Open'->label;
                  (70,20)->size;
                  (440,30)->position;
                  true -> bindRight;
                  false -> bindleft;
               #);
     #);
   RevertButton: @button
     (# command::< (# 
                   do    
                      PropertiesText.prettyprint;
                   #);   
        open::<(# do
                  'Revert'->label;
                  (70,20)->size;
                  (440,70)->position;
                  disable;
                  false -> bindleft;
                  true -> bindRight;
               #);
        
     #);
   ParseButton: @button
     (# command::< (# 
                   do  
                      PropertiesText.parse;
                   #);
        open::<(# do 'Parse'->label;
                  (70,20)->size;
                  (440,110)->position;
                  disable;
                  false -> bindleft;
                  true -> bindRight;
               #);
     #);
   
   
   PropertiesText: @TextEditor
     (#
        changed: @boolean;
        count: @integer;
        
        open::<(# 
               do
                  (5,20)->position;
                  (400,150)->size;
                  PropertiesText.init;   
                  true -> bindright;
               #);
        init:<(# 
              do contents[]->theTextField[];
                 prettyPrint;
              #);
        prettyPrint:<
          (# st: ^styledtext;
          do    
             &styledtext[]->st[];
             (theFragmentGroup.prop[],st[]) -> pretty.printProperties;
             st[]->textContents;
          #);
        
        Parse:<
          (# TextToParse: ^text;
             parseOK: @boolean;
             errorText: @text;
             fg: ^MPS.fragmentGroup;
             prop: ^propertyList;
          do
             (*   fg.fragmentList.scan
              (# 
              do (if current.type//MPS.linkType then
              Delete current 
              if);
              #);*)
             theFragmentGroup[] -> fg[];
             TextContents -> TextToParse[];
             TextToParse.reset;
             &propertyList[] -> prop[];
             prop.init;
             parsing: (TextToParse[], screen[],prop[]) -> MPS.parseProperty
             (#
                parseErrors::<
                  (# 
                  do leave parsing;
                  #);
             #) -> parseOK;
             (if parseOK then
                 prop[] -> theFragmentGroup.prop[];
                 false->Changed;
                 PropertiesText.prettyprint;
                 ' parse ok \n'->putline;
              else
                 ' parse not ok \n'->putline;
             if);
             
          #);
        
        TextContents: 
          (#
             st:^styledText;
          enter (#   
                enter st[]
                do 
                   0->count;
                   false->Changed->State;
                   st[]->theTextField.contents;
                #)
          exit (# do theTextField.contents->st[];
               exit st[]
               #)
          #);
        theTextField: ^TextField;
        contentsType::<
          (#
             eventHandler::< (#
                                onMouseDown::<
                                  (# 
                                  do 
                                     Changed->State;
                                     0->TargetFlag;
                                  #);
                                onTextChanged::<
                                  (# 
                                  do 
                                     count + 1 ->count;
                                     'text changed ' -> putText;
                                     count -> putInt;
                                     newLine;
                                     (if (count > 1) then 
                                         true->Changed->State;
                                     if);
                                  #);
                             #);
          #);
     #);
#)
   

--FragmentEditorFragmentsOpen: Descriptor --
(# st: ^styledtext;
do 
   (3,220)->position;
   (540,250)->size;
   'Fragments'->label;
   Private.OpenButton.open;
   Private.NewButton.open;
   Private.UpdateButton.open;
   Private.DeleteButton.open;
   Private.FragmentField.open;
   Private.NameField.open;
   Private.TypeMenuButton.open;
   (*&styledtext[]->st[];*)
   (*st[]->contents.contents;*)
   true -> bindRight -> bindBottom;
   INNER open;
#)

--FragmentEditorFragmentsPrivate: Descriptor --
(#
   NewFragment: @Boolean;
   OpenButton: @button
     (# command::< (# 
                   do (* frag[] -> openFragment *)
                   #);   
        open::<(# do
                  'Open'->label;
                  (70,20)->size;
                  (440,30)->position;
                  false -> bindleft;
                  true -> bindRight;
               #);
        
     #);
   NewButton: @button
     (# command::< (# 
                   do New;    
                   #);   
        open::<(# do
                  'New'->label;
                  (70,20)->size;
                  (440,70)->position;
                  false -> bindleft;
                  true -> bindRight;
               #);
        
     #);
   DeleteButton: @button
     (# command::< (# 
                   do Delete;    
                   #);   
        open::<(# do
                  'Delete'->label;
                  (70,20)->size;
                  (440,110)->position;
                  false -> bindleft;
                  true -> bindRight;
               #);
        
     #);
   UpdateButton: @button
     (# command::< (# 
                   do 
                      UpdateFragments;
                   #);
        open::<(# do 'Update'->label;
                  (70,20)->size;
                  (440,150)->position;
                  disable;
                  false -> bindleft;
                  true -> bindRight;
                 
               #);
     #);
   
   Delete:<
     (#
     do          
        (if NewFragment // false
            then (FragmentField.Selection.last,1)->FragmentField.delete;
        if);
        UpdateButton.disable;
        NameField.clearText;
        TypeMenuButton.disable;
        NameField.disable;

        (* delete fra Fragmentlist in MPS *)
     #);
   
   UpdateFragments:<
     (# st: ^styledText;
        pos: @integer;
     do 'in Update'->putline;
        &styledtext[]->st[];
        NameField.contents->st[];
        ': '->st.append;
        (if TypemenuButton.currentitem
         // 1 then 'Descriptor'->st.append;
         // 2 then 'Attributes'->st.append;
         // 3 then 'DoPart'->st.append;
        if);
        (if NewFragment
         //true then
            FragmentField.Selection.last->putint;
            (if ((FragmentField.Selection.last = 0) or (FragmentField.numberofItems = FragmentField.Selection.last))
             // true then 
                ' pos is numberofItems or last is 0'->putline;
                FragmentField.numberofItems->pos;
                1->FragmentField.append;
                (pos+1,st[])->FragmentField.settext;
             else
                FragmentField.Selection.last->pos;
                (pos+1,1)->FragmentField.insert;
                (pos+1,st[])->FragmentField.settext;
                'pos is ...'->putline;
                
                (*insert in Fragmentlist *)
            if);
         else 
            (FragmentField.Selection.last,st[])->FragmentField.settext;
            (* Update the old name in Fragmentlist*)
        if);
        UpdateButton.disable;
        NameField.clearText;
        TypeMenuButton.disable;
        NameField.disable;
        
     #);
   
   New:< 
     (# 
     do
        true->newFragment;
        TypeMenuButton.enable;
        NameField.enable;
        NameField.cleartext;
        UpdateButton.enable;
     #);
   
   FragmentField: @listView
     (# selectText: ^text;
        count: @integer;
        changed: @boolean;
        fragItem: listItem
          (# frag: ^MPS.fragmentForm;
             category: ^text;
             onSelect::<
                    (# 
                    do (if doubleClick then
                           'open' -> putLine;
                        else
                           name -> putLine;
                           TypeMenuButton.enable;
                           NameField.enable;
                           UpdateButton.enable;
                           DeleteButton.enable;
                           fragItem.name->NameField.contents;
                           (if fragItem.category 
                            // 'Descriptor' then
                               1->TypeMenuButton.CurrentItem;
                            // 'Attributes' then
                               2->TypeMenuButton.CurrentItem;
                            // 'DoPart' then
                               3->TypeMenuButton.CurrentItem;
    
                           if);
                       if);
                    #);

          #);
        
        eventHandler::<
          (# onMouseUp::<
               (# regexpr: ^text;
                  matchok: @boolean;
                  matchedText:^text;
                  styledmatchedText:^styledtext;
               do 
                  false->Newfragment;
             (*     &text[]->matchedtext[];
                  &styledtext[]->styledmatchedtext[];
                  'on mouse up '->putline;
                  '[a-zA-Z][a-zA-Z0-9_]*[ \t]*:'->regexpr[];
                  (if Selection.last
                   // 0 then ;
                   else
               
                      Selection.last -> getText -> selectText[] ->putline;
                      0->selectText.pos;
                      
                      regexpr[]->selecttext.regexp_match (# 
                                                            nomatch::< (#
                                                                       do false->matchok;
                                                                       #);
                                                         do
                                                            true->posToMatchEnd;
                                                            'match:'->putline;
                                                            ((0->regs.start)+1,(0->regs.end)-1)->selecttext.sub->matchedtext[];
                                                            matchedText->styledmatchedText;
                                                            NameField.enable;
                                                            styledmatchedText[]->NameField.contents;
                                                         #);
                      true->matchok;
                      '[ \t]*Descriptor'->regexpr[];
                      regexpr[]->selecttext.regexp_search (# 
                                                             nomatch::< (#
                                                                        do 
                                                                           false->matchok;
                                                                        #);
                                                          #);
                      (if matchok 
                       // true then 
                          1->TypeMenuButton.CurrentItem;
                          1->putint;
                          false->TypeMenu.attributeType.enable;
                          true->TypeMenu.doPartType.enable;
                       // false then
                          '[ \t]*Attributes'->regexpr[];
                          true->matchok;
                          regexpr[]->selecttext.regexp_search (# 
                                                                nomatch::< (# do 
                                                                              false->matchok;
                                                                           #);
                                                             #); 
                          (if matchok
                           // true then 
                              2->TypeMenuButton.currentItem;
                              2->putint;
                           // false then
                              '[ \t]*DoPart'->regexpr[];
                              true->matchok;
                              regexpr[]->selecttext.regexp_search (# 
                                                                    nomatch::< (#
                                                                               do false->matchok;
                                                                               #);
                                                                 #); 
                              (if matchOK
                               // true then 3->typeMenuButton.currentItem;
                                  3->putint;
                               else
                                  'no match' ->putline;
                              if);
                          if);
                      if);
                  if);
               #);
             onKeyDown::<
               (#
               do
                  'on Key  down '->putline;
               #);
          #);             
        Open::<
          (# do
             (5,20)->position;
             (400,170)->Size;
             true -> bindRight -> bindBottom;
             'foer int'->putline;
             FragmentField.init;             
             true->singleSelection;
          #);
        Init:
          (# 
             st: ^styledtext;
          do    
             &styledtext[]->st[];
             'in i init'->putline;
             theFragmentGroup.fragmentlist.scan(# theFragmentForm: ^MPS.fragmentForm;
                                                  newFragItem:^fragItem;
                                               do 
                                                  st.clear;
                                                  (if current.type//MPS.formType then
                                                      screen[] -> current.open -> theFragmentForm[];
                                                      (if theFragmentForm.category 
                                                       // betaGram.DescriptorForm then
                                                          &fragItem[]->newfragItem[];
                                                          newfragitem.init;
                                                          current.name[]->st.append;
                                                          current.name[]->newfragitem.name;
                                                          ': Descriptor'->st.append;
                                                          'Descriptor'->newfragitem.category[];
                                                          st[]->newfragItem.name;
                                                       // betagram.AttributesForm then
                                                          &fragItem[]->newfragItem[];
                                                          newfragitem.init;
                                                          current.name[]->st.append;
                                                          ': Attributes'->st.append;
                                                          current.name[]->newfragitem.name;
                                                          'Attributes'->newfragitem.category[];
                                                          st[]->newfragItem.name;
                                                       // betagram.doPart then
                                                          &fragItem[]->newfragItem[];
                                                          ': DoPart'->st.append;
                                                          newfragitem.init;
                                                          current.name[]->st.append;
                                                          current.name[]->newfragitem.name;
                                                          'DoPart'->newfragitem.category[];
                                                          st[]->newfragItem.name;
                                                      if);
                                                  if);
                                               #);
          #);

        
     #);
   SaveList: @list
     (# element::< styledtext #);
   NameField: @TextField
     (# 
        Cleartext:
        (# t: ^styledtext;
        do
           &styledText[] -> t[];
           t[]->contents;   
        #);
        Open::<
          (# do
             (5,200)->position;
             (250,30)->Size;
             true -> bindBottom;   
             false -> bindTop;
             disable
          #);
     #);

   TypeMenu: @menu
     (# attributeType: @MenuItem
          (#  enable: @boolean;
              eventHandler::<
                      (# onSelect::<
                           (# 
                           do 
                           #);
                         onStatus::< (# do (if enable//false then
                                               false->value;
                                           'on status'->putline;    
                                           if);
                                     #);
                      #);
             #);

        doPartType : @Menuitem
          (#  enable: @boolean;
              eventHandler::<
                      (# onSelect::<
                           (# 
                           do 
                           #);
                         onStatus::< (# do (if enable//false then
                                               false->value;
                                           if);
                                     #);
                      #);
          #);
        descriptorType: @MenuItem
          (#  enable: @boolean;
              eventHandler::<
                      (# onSelect::<
                           (# 
                           do 
                           #);
                         onStatus::< (# do (if enable//false then
                                               'on status' ->putline;
                                               false->value;
                                               
                                           if);
                                     #);
                      #);
             #);
        open::<
          (#
          do 
             attributeType.open;
             'Attributes'->attributeType.name;
             doPartType.open;
             'DoPart'->doPartType.name;
             descriptorType.open;
             'Descriptor'->descriptorType.name;
             descriptorType[]->append;
             attributeType[]->append;
             doPartType[]->append;
          #);
     #);
   TypemenuButton: @OptionButton
     (#
        open::<
          (#
          do 
             (270,200)->position;
             TypeMenu.open;
             TypeMenu[]->popupMenu;
             true -> bindBottom;
             false -> bindtop;
             preferredSize -> Size;
             ':'->label;
          #);
     #);
   
   
#)





--FragmentEditorFragmentsPrettyPrint: Descriptor --
(# st: ^styledtext;
do    
   Private.SaveList.scan 
#)
(*
--FragmentEditorFragmentsParse: Descriptor --
(# TextToParse: ^text;
   parseOK: @boolean;
   line: ^text;
   regexpr:^text;
do    
   TextContents -> TextToParse[];
   TextToParse.reset;
   true->parseOK;
   '[a-zA-z][a-zA-Z0-9_]*[ \t]*:[ \t]*\\(Descriptor\\|Attributes\\|DoPart\\)'->regexpr[];
   *)
   (*   MPS: ^astInterface;
    fg: ^MPS.fragmentGroup;
    ff: ^MPS.fragmentForm;
    betaGram: ^MPS.beta;
    do createMPS -> MPS[];
    MPS.grammarTable.beta[] -> betaGram[];
    
       //'create' -> command.equalNCS then
          getAtom -> what[];
          getAtom -> name[];
         
              betaGram[] -> MPS.newFragmentForm -> ff[];
              (if ff[]<>none then
                  name[] -> ff.name;
                  ff[] -> fg.fragmentList.addFragment;
                  ff.name -> putLine;
                  (ff[],'GUIenv') -> betaGram.newDescriptorForm -> ff.root[];
              if);
          if);
   *)
   (*
   L:
     (# 
     do (if (TextToParse.eos) then
            leave L;
         else
            TextToParse.getline->line[];
            line[]->putline;
            (if line.length // 0 then restart L; if);
            0->line.pos;
            regexpr[] ->line.regexp_match
            (# noMatch::< (#do '\t no match'->putline; 
                             false->parseOK #)
            #);
            restart L;
        if)
     #);
   
   TextToParse.getline->line[];
   line[]->putline;
   (if parseOK then
       ' parse ok \n'->putline;
    else
       ' parse not ok \n'->putline;
   if);
#)



--FragmentEditorFragmentscTeHonMouseDown : Descriptor --
(# do 
   1->TargetFlag;
#) 


--FragmentEditorFragmentscTeHonTextChanged: Descriptor --
(# do 
   count + 1 ->count;
   'text changed ' -> putText;
   count -> putInt;
   newLine;
   (if (count > 1) then 
       true->Changed->State;
   if);
#) 
*)
--]]












