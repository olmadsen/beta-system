ORIGIN '../friggapplication';
INCLUDE '../code/match'
        '../code/generate'
        '~beta/betaast/gram'
'~beta/sourcebrowser/private/ymerBody'
'~beta/guienv/stddialogs'
        '../dialogs/createwindow';
LIB_ITEM 'frigg_application';

-- friggApplicationLib: Attributes --
findGroupEditor:
  (#
     fg: ^astInterface.fragmentGroup;
     theGroupEditor: ^gui.window.editorEnv.groupEditor;
     
  enter fg[]
  do
     (*
      fg[]->ymerBrowser.ymerBrowserPrivate.geList.findOrCreateGroupEditor
      ->theGroupEditor[]; 
      *)
     fg[]->ymerBrowser.findOrCreateGroupEditor->theGroupEditor[];
  exit theGroupEditor[]
  #);
makeSavePrompt:
  (# fg: ^astInterface.fragmentGroup; str: ^text; 
  enter fg[]
  do 'Save changes to '->str[]; fg.name->str.putText; '?'->str.put; 
  exit str[]
  #);
  
guienvLocation: (# exit '~beta/guienv/guienv' #);
defaultWindowDef: (# exit 'myWindow: window (# open::< (# do INNER #) #)' #);
defaultCanvasDef: (# exit 'myCanvas: canvas (# open::< (# do INNER #) #)' #);

-- theGraphicalEditorEnvOpenAstEditorDopart: DoPart --
do
     (#
        theGroupEditor: ^gui.window.editorEnv.groupEditor;
        theFormEditor: ^gui.window.codeEditor;
        
     do
        node.frag.father->findGroupEditor->theGroupEditor[];
        (if theGroupEditor[] <> none then
            node.frag[]->theGroupEditor.formEditorList.findOrCreateEditor
              ->theFormEditor[];
            (if theFormEditor[] = none then
                node.frag[]->findForm;
                (node[],node[])->ymerBrowser.cfe.openSubEditor;
                
             else
                (node[],node[])->theFormEditor.openSubEditor; 
            if);
            
        if);
        
     #);
     

-- theGraphicalEditorEnvAutoSaveGroupDopart: DoPart --
do
   13->trace (#  do 'group autosave, name = "'->xT; fg.name->xT; xn #);
     (# theGroupEditor: ^gui.window.editorEnv.groupEditor; 
     do
        fg[]->findGroupEditor->theGroupEditor[];
        (if theGroupEditor[] = none then  else theGroupEditor.autoSave;  if);
        
     #)  

-- theGraphicalEditorEnvOnGroupOpenDopart: DoPart --
do
   13->trace (#  do 'group open, name = "'->xT; fg.name->xT; xn #);
   fg[]->findGroup;
     

-- theGraphicalEditorEnvSaveFragmentGroupDopart: DoPart --
do
   13->trace (#  do 'group save, name = "'->xT; fg.name->xT; xn #);
     (# theGroupEditor: ^gui.window.editorEnv.groupEditor; 
     do
        fg[]->findGroupEditor->theGroupEditor[];
        (if theGroupEditor[] = none then
            
         else
            (true,false,true)->theGroupEditor.save; 
        if);
        
     #);
     

-- friggApplicationQuitApplication: DoPart --
do
(*
 (if ymerBrowser.ymerBrowserPrivate.geList.closeGroups and
 ymerBrowser.browser.sbprivate.down.aeList.closeAsciiEditors then
 ymerBrowser.quit
 if) *)   

-- theGraphicalEditorEnvOnGroupChangedDopart: DoPart --
do
   13
     ->trace
       (#  do 'group changed, name = "'->xT; fg.name->xT; '"'->xT; xN #);
     (# theGroupEditor: ^gui.window.editorEnv.groupEditor; 
     do
        fg[]->findGroupEditor->theGroupEditor[];
        (if theGroupEditor[] <> none then
            13
              ->trace
                (# 
                do 'group touched = '->xT; theGroupEditor.touched->xI; xN
                #);
            theGroupEditor.groupTouched;
            
         else
            'thegroupeditor is none'->screen.putline
        if);
        
     #);
     

-- theGraphicalEditorEnvOnGroupSavedDopart: DoPart --
do   



-- newGraphicalEditorOnSelect: DoPart --
do
   (if browser.cfe[] <> none then
       browser.cfe.frag[]->frag[];
   if);
   frag[] -> createWindow;
   

-- friggApplicationProcessCommand: DoPart --
do
   'ProcessCommandfrigg'->screen.putline;
   (*
    cmd[]->ymerBrowserInt.appendProject;
    ymerBrowser.appendDone;
    ymerBrowser.bringToFront *)
     

-- prettyPrintGroup: DoPart --
do
     (# f: @file; 
     do
        13
          ->trace
            (#  do 'prettyprint group, name = '->xT; group.name->xT; xN #);
        (mps[],group[],none ,name[])->prettyPrintFragment;
        name[]->f.name;
        group.modTime-200->f.entry.modtime;
        
     #);
     

     

-- friggCreateWindow: doPart --
do (#
      theCreateWindow: @gui.createEditorDialog
        (#
           open::
             (# gram: @grammar;
             do (if frag[] <> NONE then
                    (if frag.root.symbol = gram.attributesForm then
                        frag.father -> shortName -> fileLabel.label;
                    if);
                 else
                    'NONE' -> fileLabel.label;
                if);
             #);
           onCancel::  (#  do theCreateWindow.close #);
           
           shortName:
             (# group: ^astInterface.fragmentGroup;
                name: ^text;
                e: @diskEntry;
             enter group[]
             do group.fullname -> e.path;
                e.path.name -> name[];
             exit name[]
             #);
           createSourceFragment:
             (# filename: ^text;
                group: ^astInterface.fragmentGroup;
                gram: @grammar;
             enter filename[]
             do (if filename[] <> NONE then
                    (if ymerbrowser[] <> NONE then
                        (if ymerbrowser.edenv[] <> NONE then
                            (ymerbrowser.ymerbrowser[], filename[], false) -> ymerbrowser.edenv.newBetaLibrary -> group[];
                            (if group[] <> NONE then
                                'ORIGIN' -> group.prop.addProp
                                (#
                                do guienvLocation -> addString;
                                #);
                                group.fragmentlist.scan
                                (#
                                do (if current.type = mps.ast.formType then
                                       current.f[] -> frag[];
                                       'guienvLib' -> frag.name;
                                       frag.name -> current.name[];
                                       
                                       (frag[], ' ', gram.attributesForm) 
                                         -> parsetext 
                                         -> frag.root[];
                                   if);
                                #);
                                
                                group.fullName->ymerBrowser.addproject;
                                group[] -> shortName -> fileLabel.label;
                            if);
                        if);
                    if);
                if);
             #);
           
           onOther::
             (#
             do (# filename: ^text;
                  
                do gui.fileCreationDialog -> filename[];
                   (if fileName[] <> NONE then
                       fileName[] -> createSourceFragment;
                   if);
                #)
             #);
           onCreate:: 
             (# gram: @grammar;
             do (if name[]->theGraphicalEditorEnv.checkIdentifier then
                    (if frag[] = NONE then
                        name[] -> createSourceFragment;
                     else
                        (if frag.root.symbol <> gram.attributesForm then
                            NONE -> frag[];
                            name[] -> createsourcefragment;
                        if);
                    if);
                    (if frag[] <> NONE then
                        theCreateWindow.close;
                        (frag[],name[],'window')
                          ->theGraphicalEditorEnv.createWindow;
                    if);
                 else
                    message:
                      (# msg: ^text; 
                      do
                         &text[]->msg[];
                         '"'->msg.put;
                         name[]->msg.putText;
                         '"'->msg.put;
                         ' is not a legal name.'->msg.putText;
                         msg[]->gui.displayMessage;
                         
                      #);
                    
                if)
             #);
           
        #);
   do theCreateWindow.open;
   #);
 
