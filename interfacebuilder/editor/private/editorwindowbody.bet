ORIGIN '../editorwindow';
INCLUDE '~beta/guienv/guienvall'
        '../dictionary'
'~beta/guienv/utils/tabControl'
'../../support/row'
        '../../guienvstuff/killtranslations'
        '~beta/guienv/utils/guienvadds'
        '../../resourcesupport/parameters'
        '~beta/guienv/controls';
-- editorWindowprivate: Descriptor --
(#
   isOpen: @boolean;
   palette: row
     (#
        x,y: @integer;
        paletteItem: iconButton
          (#
             name:
               (# 
               enter (#  enter theName[] do theName[]->label;  #)
               exit theName[]
               #);
             theName: ^text;
             open:: 
               (# 
               do disableDefaultBehaviour; (30,30)->size; false->showLabel; 
               #);
             eventHandler:: 
               (#
                  onMouseDown:: 
                    (# p: @point; 
                    do
                       (localPosition,THIS(paletteItem)[],paletteTabber[])
                         ->translate->p;
                       (theName[],p,THIS(mouseDown)[])->mousedownInItem;
                       
                    #);
                  
               #);
             
          #);
        addPaletteItem:
          (# icon: ^pixmap; name: ^text; 
          enter (icon[],name[])
          do
               (# theItem: ^paletteItem; 
               do
                  &paletteItem[]->theItem[];
                  THIS(palette)[]->theItem.open;
                  icon[]->theItem.icon;
                  name[]->theItem.name;
                  
               #);
             
          #);
        findPaletteItem:
          (# pt: @point; thePaletteItem: ^paletteItem
          enter pt
          do
             search: scan
               (# r: @rectangle
               do
                  current.frame->r;
                  (if pt->r.containsPoint then
                      current[]->thePaletteItem[]; leave search
                  if)
               #)
          exit thePaletteItem[]
          #);
        open::< 
          (# 
          do
             true->bindRight;
             (552,40)->size;
             
          #)
     #);
   makePalette:
     (# aPalette: ^palette
     do &palette[]->aPalette[]; paletteTabber[]->aPalette.open
     exit aPalette[]
     #);
   itemDictionary: @patternDictionary;
   aTimer: @editorTimer
     (# action::  
          (# 
          do paletteTabber.checkStatus 
          #) 
     #);
   paletteTabber: @tabControl
     (#
        palettes: @dictionary (# element:: palette #);
        checkStatus:
          (# thePalette: ^palette; theItem: ^palette.paletteItem; pt: @point
          do
             (if selection = none then
                 ''->status
              else
                 (selection).page->thePalette[];
                 mouse.globalPosition->pt;
                 pt->THIS(window).globalToLocal->pt;
                 pt.v->pt.v (* Adjust for menubar - bug in GUIenv *) ;
                 (pt,THIS(window).contents,thePalette[])->translate->pt;
                 pt->thePalette.findPaletteItem->theItem[];
                 (if theItem[] = none then
                     ''->status
                  else
                     theItem.name->status
                 if)
             if)
          #);
        addPaletteItem:
          (# icon: ^pixmap; name,grouping: ^text; 
          enter (grouping[],icon[],name[])
          do
               (# thePalette: ^palette
               do
                  grouping[]->palettes.lookup->thePalette[];
                  (if thePalette[] = none then
                      (grouping[],makePalette->thePalette[])->addPalette
                  if);
                  (icon[],name[])->thePalette.addPaletteItem
               #);
             
          #);
        add:
          (# name: ^text; thePalette: ^palette; theTab: ^tab
          enter (thePalette[],name[])
          do
             &tab[]->theTab[];
             name[]->theTab.label;
             thePalette[]->theTab.page;
             theTab.open;
             
          #);
        addPalette:
          (# name: ^text; thePalette: ^palette; 
          enter (name[],thePalette[])
          do (thePalette[],name[])->add; (name[],thePalette[])->palettes.define
          #);
        open::< 
          (# 
          do
             true->bindRight;
             false->border.visible;
             (540,68)->size;
             (0,0)->position;
             palettes.init;
             
          #)
     #);
   statusbar: @canvas
     (#
        open::< 
          (# 
          do
             true->bindRight;
             5->border.style;
             true->border.visible;
             (540,24)->size;
             statusLabel.open;
             (0,68)->position;
             
          #);
        statusLabel: @statictext
          (#
             open::< 
               (# theStyle: ^textStyle
               do
                  true->bindRight;
                  'Status'->label;
                  (521,19)->size;
                  (12,3)->position;
                  &textStyle[]->theStyle[];
                  'Times'->theStyle.name;
                  12->theStyle.size;
                  textFaces.italic->theStyle.face;
                  theStyle[]->style
               #)
          #)
     #);
   adorner: @canvas
     (#
        interior: (#  enter theInterior[] do adjustSize #);
        inside: (#  exit outerframe.innerFrame[] #);
        theInterior: ^windowItem;
        open::< 
          (# 
          do
             true->bindBottom;
             true->bindRight;
             (540,308)->size;
             outerFrame.open;
             (0,92)->position;
             
          #);
        adjustingSize: @boolean;
        adjustSize:
          (# width,height: @integer; 
          do (if not adjustingSize then
                 true->adjustingSize;
                 (if theInterior[] <> none then
                     (4,4)->theInterior.position;
                     theInterior.size->(width,height);
                     (width+16,height+25+8+4)->outerFrame.size
                 if);
                 false->adjustingSize
             if)
          #);
        eventHandler::<  (# onMouseUp::<  (#  do clearSelection #) #);
        outerFrame: @canvas
          (#
             open::< 
               (# 
               do
                  5->border.style;
                  true->border.visible;
                  (408,208)->size;
                  innerFrame.open;
                  titlePanel.open;
                  (4,10)->position;
                  
               #);
             innerFrame: @canvas
               (#
                  eventHandler:: 
                    (#
                       onChildFrameChanged::  (#  do adjustSize #);
                       onMouseUp::< (#  do onSelectEntire #)
                    #);
                  open::< 
                    (# 
                    do
                       true->bindBottom;
                       true->bindRight;
                       4->border.style;
                       true->border.visible;
                       (400,179)->size;
                       (4,25)->position;
                       
                    #)
               #);
             titlePanel: @statictext
               (#
                  open::< 
                    (# 
                    do
                       true->bindRight;
                       'This space for rent...'->label;
                       (376,14)->size;
                       (17,6)->position;
                       
                    #);
                  eventHandler::<
                    (# onMouseUp::< (#  do onSelectEntire #) #)
               #);
             eventHandler::<
               (# onMouseUp::< (#  do onSelectEntire #) #)
          #)
     #)
#)  

-- editorWindowLib: Attributes --
registerStandardItems:
  (# 
  do
     ('windowItem',windowItem##)->registerItem;
     ('canvas',canvas##)->registerItem;
     ('control',control##)->registerItem;
     ('scrollbar',scrollbar##)->registerItem;
     ('button',button##)->registerItem;
     ('pushButton',pushButton##)->registerItem;
     ('staticText',staticText##)->registerItem;
     ('iconButton',iconButton##)->registerItem;
     ('optionButton',optionButton##)->registerItem;
     ('toggleButton',toggleButton##)->registerItem;
     ('radioButton',radioButton##)->registerItem;
     ('checkBox',checkBox##)->registerItem;
     ('editText',editText##)->registerItem;
     ('textField',textField##)->registerItem;
     ('abstractScroller',abstractScroller##)->registerItem;
     ('textEditor',textEditor##)->registerItem;
     ('scroller',scroller##)->registerItem;
     ('scrollList',scrollList##)->registerItem;
     ('textScrollList',textScrollList##)->registerItem
  #)  

-- editorWindowOpen: DoPart --
do
   (5,40)->position;
   (540,400)->size;
   registerStandardItems;
   private.paletteTabber.open;
   private.statusbar.open;
   private.adorner.open;
   200->private.aTimer.start;
   INNER ;
   true->private.isOpen;
     

-- editorWindowRegisterItem: DoPart --
do (name[],item##)->private.itemDictionary.define  

-- editorWindowLookupItem: DoPart --
do name[]->private.itemDictionary.lookup->item##;   

-- editorWindowInterior: DoPart --
do theInterior[]->private.adorner.interior  

-- editorWindowStatus: DoPart --
do
   (if not (private.statusbar.statusLabel.label->msg.equalNCS) then
       msg[]->private.statusbar.statusLabel.label
   if)  

-- editorWindowonActivate: DoPart --
do   

-- editorWindowonDeactivate: DoPart --
do   

-- editorWindowClose: DoPart --
do false->private.isOpen; INNER  

-- editorWindowTitleBar: DoPart --
do str[]->private.adorner.outerFrame.titlePanel.label  

-- editorWindowIsOpen: DoPart --
do private.isOpen->value;   

-- editorWindowNeededSize: doPart --
do (# bounds: @rectangle;
   do private.adorner.outerFrame.frame -> bounds;
      bounds.right + 10 -> width;
      bounds.bottom + 10 -> height;
      ((width, height), private.adorner[], contents) 
      	-> translate 
      	-> (width, height);
   #);
