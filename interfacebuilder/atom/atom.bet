ORIGIN '~beta/basiclib/v1.5/betaenv';
INCLUDE '../datastructures/sequence';
INCLUDE '../datastructures/set';

BODY 'private/atombody';

-- lib: attributes --

textType: (# exit 1 #);
boolType: (# exit 2 #);
intType: (# exit 3 #);
listType: (# exit 4 #);
tableType: (# exit 5 #);

atom:
  (# <<SLOT atomLib: attributes>>;
     type:< integerValue;
     equal:<
       (# other: ^atom;
          isEqual: @boolean;
       enter other[]
       <<SLOT atomEqual: doPart>>
       exit isEqual
       #);
     asTextAtom:<
       (# value: ^textAtom;
       do inner;
       exit value[]
       #);
     asBoolAtom:<
       (# value: ^boolAtom;
       do inner;
       exit value[]
       #);
     asIntAtom:<
       (# value: ^intAtom;
       do inner;
       exit value[]
       #);
     asListAtom:<
       (# value: ^listAtom;
       do inner;
       exit value[]
       #);
     asTableAtom:<
       (# value: ^tableAtom;
       do inner;
       exit value[]
       #);
  #);
textAtom: atom
  (# value: ^text;
     asTextAtom::
       (# 
       do this(textAtom)[] -> value[];
       #);
     type:: (# do textType -> value #);
     equal:: (# <<SLOT textAtomEqual: doPart>> #);
  enter value[]
  exit value[]
  #);
boolAtom: atom
  (# value: @boolean;
     asBoolAtom::
       (# 
       do this(boolAtom)[] -> value[];
       #);
     type:: (# do boolType -> value #);
     equal:: (# <<SLOT boolAtomEqual: doPart>> #);
  enter value
  exit value
  #);
intAtom: atom
  (# value: @integer;
     asIntAtom::
       (# 
       do this(intAtom)[] -> value[];
       #);
     type:: (# do intType -> value #);
     equal:: (# <<SLOT intAtomEqual: doPart>> #);
  enter value
  exit value
  #);
listAtom: atom
  (# storage: @sequence
       (# element:: atom;
       #);
     asListAtom::
       (# 
       do this(listAtom)[] -> value[];
       #);
     type:: (# do listType -> value #);
     equal:: (# <<SLOT listAtomEqual: doPart>> #);
  #);
tableAtom: atom
  (# storage: @set
       (# element::
            (# key: ^text;
               value: ^atom;
            #);
       #);
     define:
       (# key: ^text;
          value: ^atom;
       enter (key[], value[])
       <<SLOT tableAtomDefine: doPart>>
       #);
     lookup:
       (# key: ^text;
          value: ^atom;
       enter key[]
       <<SLOT tableAtomLookup: doPart>>
       exit value[]
       #);
     asTableAtom::
       (# 
       do this(tableAtom)[] -> value[];
       #);
     type:: (# do tableType -> value #);
     equal:: (# <<SLOT tableAtomEqual: doPart>> #);
  #);

atomParser:
  (# <<SLOT atomParserLib: attributes>>;
     theStream: ^stream;
     init:
       (# 
       enter theStream[]
       <<SLOT atomParserInit: doPart>>
       #);
     readAtom:
       (# theAtom: ^atom;
       <<SLOT atomParserReadAtom: doPart>>
       exit theAtom[]
       #);
     private: @<<SLOT atomParserPrivate: descriptor>>;
  #);

atomPrinter:
  (# <<SLOT atomPrinterLib: attributes>>;
     theStream: ^stream;
     init:
       (# 
       enter theStream[]
       <<SLOT atomPrinterInit: doPart>>
       #);
     printAtom:
       (# theAtom: ^atom;
       enter theAtom[]
       <<SLOT atomPrinterPrintAtom: doPart>>
       #);
     private: @<<SLOT atomPrinterPrivate: descriptor>>;
  #);
