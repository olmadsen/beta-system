ORIGIN 'pcrebody';
INCLUDE 'pcrelib';
(*
 * COPYRIGHT
 *       Copyright (C) Mjolner Informatics, 2000
 *       All rights reserved.
 *       Written by Erik Corry
 *)

--- PcreInit: dopart ----
do (# error: ^CString;
      opt: @Integer;
      errtext: @Integer;
      erroffset: @Integer;
   do options -> opt;
      (if opt %Band pcre_C_LOCALE <> 0 then
	  (@@exp.T[1],
	  opt %Band pcre_NONBETAOPTIONS,
	  @@errtext,
	  @@erroffset, 0) -> pcre_compile -> private.compiled_regexp;
       else
	  (@@exp.T[1],
	  opt %Band pcre_NONBETAOPTIONS,
	  @@errtext,
	  @@erroffset) -> locale_pcre_compile -> private.compiled_regexp;
      if);
      (if private.compiled_regexp = 0 then
	  &CString[] -> error[];
	  errtext -> error;
	  error.get -> compilation_error;
       else
          (if opt %Band pcre_DO_STUDY <> 0 then
	      (private.compiled_regexp, opt %Band pcre_NONBETAOPTIONS, @@errtext) ->
              pcre_study -> private.extra;
	      (if errtext <> 0 then
	          &CString[] -> error[];
	          errtext -> error;
	          error.get -> compilation_error;
	      if);
	  if);
	  (private.compiled_regexp, private.extra, pcre_INFO_CAPTURECOUNT, @@subpatterns) ->
          pcre_fullinfo;
	  ((subpatterns + 1) * 3) -> private.oVector.new;
      if);
   #);
   

---- PcreMatch: dopart ----
do options -> opt;
   0 -> subMatchCounter;
   pre;
   private.oVector.range -> private.oVector.new;
   (if subject.T.range = 0 then 1 -> subject.T.extend; 0 -> subject.T[1] if);
   position - 1 -> psn;
   (private.compiled_regexp, private.extra, @@subject.T[1], subject.lgth,
   psn, opt %Band pcre_NONBETAOPTIONS, 
   @@private.oVector[1], private.oVector.range) -> pcre_exec -> result;
   (result <> pcre_ERROR_NOMATCH) -> matched;
   (if matched then
       INNER;
    else
       noMatch;
   if);
   
---- PcreMatchAll: dopart ----
do split;
   matches + 1 -> matches;
   INNER matchAll;
   loop:
     (#
     do private.oVector[2] -> privatema.endOfPreviousMatch;
        (if private.oVector[2] >= subject.lgth then
	    leave loop;  (* Got to end of string *)
	if);
	(private.compiled_regexp, private.extra, @@subject.T[1], subject.lgth,
        private.oVector[2], opt %Band pcre_NONBETAOPTIONS,
        @@private.oVector[1], private.oVector.range) -> pcre_exec -> result;
        (result <> pcre_ERROR_NOMATCH) -> matched;
        (if matched then
	    split;
	    matches + 1 -> matches;
	    INNER matchAll;
	 else
	    (* Fix up private.oVector so you can call splitText and splitPos one
	     * last time.
	     *)
	    subject.lgth -> private.oVector[1];
	    subject.lgth -> private.oVector[2];
	    split;
	    post;
	    true -> matched; (* At least one match occurred *)
	    leave loop;
        if);
        restart loop;
     #);

