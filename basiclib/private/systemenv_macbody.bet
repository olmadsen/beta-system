ORIGIN 'basicsystemenv_mac';
INCLUDE 'console_macbody';
(*
 * COPYRIGHT
 *       Copyright (C) Mjolner Informatics, 1984-96
 *       All rights reserved.
 *
 *)
 
-- installKeyboard: Descriptor --
(#
#)  

--- BasicScheduler:descriptor ---
(# console: ^ConsoleStream;
   x: @COM
      (# event: @EventRecord (* specialization of DATA *);
	  #);
   result: @boolean;
   abort: @boolean;
   lastTime: @integer;
   now: @integer;
do 
   (if screen[] <> NONE then
	   (if screen## <= ConsoleStream## then
		  screen[] -> console[];
	   if);
   if);
   initBeforeScheduler;
   
   run: cycle
      (# result: @integer
	  do private.attNext -> result;
	     (if result=2 then
		    leave run;
		 else
		 	private.mdpriv.check;
		    (if console[] <> NONE then
			   TickCount -> now;
			   (if (now - lastTime) > 1 then
				   (everyEvent, x.event[], 2, 0) -> WaitNextEvent -> result;
				   x.event[] -> console.handleEvent -> abort;
				   (if abort then
					  leave run;
				   if);
			   if);
			if);
		 if);
	  #);
	  
#)

--- pioEnsure:descriptor ---
(# do#)

--- pioPrivate:descriptor ---
(# (****
		sysKeyboard: @keyboardStream
		(# ready: @semaphore;
			block::
				(#
				do true  -> keyboardBlocked;
					ready.P;
				#);
			continue::
				(#
				do false -> keyboardBlocked;
					ready.V;
				#);
			
		#);
	****)
#)

--- forksecond:descriptor ---
(# do#)

