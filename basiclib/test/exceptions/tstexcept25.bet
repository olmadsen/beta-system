ORIGIN '~beta/basiclib/betaenv';
INCLUDE '~beta/basiclib/private/systemExceptionHandler';

(* See NOTE in README *)

---program:descriptor---
(# (* The P-object in which &A[]->R[] was executed is NOT on
    * the stack, i.e. ExO don't find it.
    *)
   P:
     (# first: @boolean
     enter first
     do (if first then
            L: (# A: (# do leave L (* LeaveBasicCompErr: Illegal leave/restart *) #)
               do &A[]->R[]
               #);
         else R
        if);
     #);
   R: ^object;
   X: @P
do runtimeExceptionHandler##->InstallSystemExceptionHandler;
   try
   (#
      name:: (# do 'leaveTry'->n[] #);
      handler::
        (# 
        do when (# type:: leaveBasicCompException
                do 'leaveTry handler...aborting'->putline;
                   abort;
                #);
        #);
   do try (#
             name:: (# do 'inner'->n[] #);
             handler::
               (# 
               do when (# type:: leaveBasicCompException
                       do 'inner handler...propagating'->putline;
                          propagate;
                       #);
               #);
          do true->X; false->P;#);     
   #);
#)
