ORIGIN '~beta/basiclib/betaenv';
INCLUDE '~beta/basiclib/private/systemExceptionHandler';
INCLUDE 'tstexceptlibc';
(* Test dump with error in external code.
 * Like tstdump35 but with two callback frames.
 *)

-----program:descriptor-----
(#
   a: @|(# p: (# do inner #);
           pp: @p(# 
                 do 1->x;
                    2->y;
                    x+y -> x;
                    zoo## -> doCallBack;
                 #);
        do pp
        #);
   b: @|(# q: (# do inner #);
           qq: @q(# do a; #);
        do qq
        #);
   foo: External
     (# i,j:@ integer; T: [1] @ char;
        x3,x4,x5,x6,x7,x8: @integer;
        r: [1]@char;
     enter(i,T,x3,x4,x5,x6,x7,x8)
     do cExternalEntry;
        'Call Back. Now force "Segmentation fault/Bus error"' -> putline;
        b;
     #);
   boo: External
     (# i,j:@ integer; T: [1] @ char;
        x3,x4,x5,x6,x7,x8: @integer;
        r: [1]@char;
     enter(i,T,x3,x4,x5,x6,x7,x8)
     do cExternalEntry;
        kuk;
     #);
   zoo: External
     (# i,j:@ integer; T: [1] @ char;
        x3,x4,x5,x6,x7,x8: @integer;
        r: [1]@char;
     enter(i,T,x3,x4,x5,x6,x7,x8)
     do cExternalEntry;
        1->doCallBackI (* SegmentationErr: Segmentation fault *)
     #);
   kuk: 
     (# dummy: @integer;
     do 1->x;
        2->y;
        x+y -> x;
        foo##->doCallBack; 
        (* call back from C of ('l','mn','!','!','!','!','!','o')->foo;*)   
     #);
   x,y: @integer;
do runtimeExceptionHandler##->InstallSystemExceptionHandler;
   try
   (#
      name:: (# do 'segmentationTry'->n[] #);
      handler::
        (# 
        do when (# type:: segmentationException
                do 'segmenationTry handler...aborting'->putline;
                   abort;
                #);
        #);
   do try (#
             name:: (# do 'inner'->n[] #);
             handler::
               (# 
               do when (# type:: segmentationException
                       do 'inner handler...propagating'->putline;
                          propagate;
                       #);
               #);
          do 1->x;
   2->y;
   x+y -> x;
   boo##->doCallBack; #);     
   #);
#)

