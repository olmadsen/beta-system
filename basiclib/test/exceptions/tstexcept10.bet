ORIGIN '~beta/basiclib/betaenv';
INCLUDE '~beta/basiclib/private/systemExceptionHandler';

--- program: descriptor ---
(# factorial: @|
     (# next:
          (# n, thisF: @integer;
          enter n
          do n*F -> F -> thisF; i+1->i;
             SUSPEND;
             (if i=n//true then n+1->&next if);
             (if true
              // i>n then thisF->F; (for j:i-n repeat factorial for);
                 (*                                   ^^^^^^^^^    *)
                 (* RecursiveAttachErr: 
                  *   Attempt to attach component that is already attached
                  *)
             if);
          #);
        F, i: @integer
     enter i
     do 1->F->&next
     exit F
     #);
   puti: (# i: @integer; enter i do i -> putint; newline; #);
do runtimeExceptionHandler##->InstallSystemExceptionHandler;
   try
   (#
      name:: (# do 'recursiveAttTry'->n[] #);
      handler::
        (# 
        do when (# type:: recursiveAttException
                do 'recursiveAttTry handler...aborting'->putline;
                   abort;
                #);
        #);
   do factorial->puti;
      6->factorial->puti;
   #);
#)

(* stack layout at dump time:
 * 
 *   |    main            |
 *   |____________________|       
 *   |                    |
 *   |    M1BETAENV       |       basic component
 *   |____________________|
 *   |                    |
 *   |    M1PROGRAM       |       <PROGRAM-~>
 *   |____________________| 
 *   |                    |
 *   |    Att             |
 *   |____________________|
 *   |                    |
 *   |    M2PROGRAM       |       factorial#
 *   |____________________|
 *   |                    |
 *   |    M3PROGRAM       |       next#
 *   |____________________|
 *   |                    |
 *   |    Att             |
 *   |____________________|
 * 
 *)
