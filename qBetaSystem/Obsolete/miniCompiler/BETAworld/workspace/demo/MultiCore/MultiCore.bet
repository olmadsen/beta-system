MultiCore: @
  (# 
     Core: 
       (# S: ^Object;
          attach:
            (#
            enter S[]
            do
            #);
       do loop:
            (if S[] <> none then
                S
            if)
       #);
     core1,core2: @Core;
     
     init_core:
       (#
       do core1[] -> fork; core2[] -> fork
       #);
     
     P1: @
       (# R: @
            (#
               foo: (# do 'F'-> put #);
            #)
       do R.foo;
          mutex.lock;
          'Hello from P1\n'.print;
          mutex.unlock
       #);     
     P2: @
       (# S: @
            (# bar: (# do 'B' -> put #)
            #);
       do S.bar;
          mutex.lock;
          'Hello from P2\n'.print;
          mutex.unlock
       #);
     mutex: @
       (# M: @integer;
          CompareAndSwap:
            (# V: @integer; res: @boolean
            enter V
            do V -> M.cmpAndSwap -> res
            exit res
            #);
          lock:
            (# res: @integer
            do Loop:
                 (# 
                 do 1 -> M.cmpAndSwap -> res;                    
                    (if res = 1 then 
                        500 -> sleep;
                        restart Loop 
                    if)
                 #);
            #);
          unlock: (# do 0 -> M #)
       #);
     init_process:
       (#
       do P1[] -> core1.attach;
          P2[] -> core1.attach;
       #)
  do '!' -> put;
     P1[] -> fork;
     P2[] -> fork;
     
     mutex.lock;
     'Hello from main\n'.print;
     mutex.unlock
  #)
