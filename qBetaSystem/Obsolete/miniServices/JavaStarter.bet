ORIGIN '~beta/basiclib/systemenv';
INCLUDE '~beta/process/processmanager';
INCLUDE '~beta/process/streamgenerator';

--- program:descriptor ---
systemEnv
(#	
   application: @process;
   inSocket: ^StreamSocket;
   Generator: @socketGenerator;
   aText: ^Text;
do	
   'Launching \'Java\'' -> putline;
   'C:\\Windows\\system32\\java' ->	application.init;
   '-jar JavaHello.jar JavaHello' -> application.argument.putArg;
   application.start; 
   
   'Communicate via socket using number 5123' -> putline;
   5123 -> Generator.bind; 
   
   'Establishing connection' -> putline;
   waitForever -> Generator.getStreamConnection -> inSocket[];
   screen.newline;
   
   (for i: 10 repeat 
        (# T: @text
        do 'Mesage: ' -> T; i -> T.putint; T.newline;
           T[] -> inSocket.putText;
        #)
   for);
   
   (* inSocket.flush is done automatically by inSocket.newline *)
   
   'Closing down' -> putline;
   application.awaitStopped; (* client first: avoids address-in-use error *)
   inSocket.close;
   Generator.close;
#)

