ORIGIN '../graphicscanvas';

MDBODY nti 'winnt/graphicscanvas_nti'
       ppcmac 'macintosh/graphicscanvas_mac'
       default 'X11/graphicscanvas_X11';

-- GUIenvLib: attributes --

getShared: objectPool.get
  (# type:: PixmapSurface;
     
     init::
       (# screen: @Rectangle;
          image: ^Pixmap;
       do &Pixmap[] -> image[];
          screenRectangle -> screen;
          screen.size -> image.init;
          image[] -> obj.init;
       #);
  #);

-- LayerAdd: doPart --
do child[] -> children.append;
   
-- LayerRemove: doPart --
do child[] -> children.at -> children.delete;
   
-- LayerDrawOn: doPart --
do children.scan
   (#
   do theSurface[] -> current.drawOn;
   #);
   

-- GraphicsCanvasAdd: doPart --
do child[] -> children.append;

-- GraphicsCanvasRemove: doPart --
do child[] -> children.at -> children.delete;

-- ItemDrawOn: doPart --
do theSurface.push;
   (x, y) -> theSurface.translate;
   INNER;
   theSurface.pop;
   
-- LineDrawOn: doPart --
do (if stroke[] <> NONE then
       stroke[] -> theSurface.pen;
   if);
   strokewidth -> theSurface.width;
   (start[], end[]) -> theSurface.drawLine;
   
-- LineContainsPoint: doPart --
do (if start.x < end.x then
       start.x -> left;
       end.x -> right;
    else
       start.x -> right;
       end.x  -> left;
   if);
   (if start.y < end.y then
       start.y -> top;
       end.y -> bottom;
    else
       start.y -> bottom;
       end.y  -> top;
   if);
   strokewidth / 2 -> halfStrokeWidth;
   left - halfStrokeWidth -> left;
   right + halfStrokeWidth -> right;
   top - halfStrokeWidth -> top;
   bottom + halfStrokeWidth -> bottom;
   (if (x >= left) AND (x <= right) AND (y >= top) AND (y <= bottom) then
       end.x - start.x -> b;
       -(end.y - start.y) -> a;
       -a * start.x - b*start.y -> c;
       a*a + b*b -> sqrt -> d;
       (if d > 0.0001 then
           (a*x + b*y + c) / d -> abs -> dist;
           (if dist < (halfStrokeWidth + 3) then
               THIS(Line)[] -> target[];
           if);
       if);
   if);

-- RectDrawOn: doPart --
do (if fill[] <> NONE then
      fill[] -> theSurface.pen;
      (width, height) -> theSurface.fillRect;
   if);
   (if stroke[] <> NONE then
      stroke[] -> theSurface.pen;
      (width, height) -> theSurface.drawRect;
   if);
   
-- OvalDrawOn: doPart --
do strokewidth -> theSurface.width;
    (if stroke[] <> NONE then
       stroke[] -> theSurface.pen;
       (width, height) -> theSurface.drawOval;
   if);
   (if fill[] <> NONE then
      fill[] -> theSurface.pen;
      (width, height) -> theSurface.fillOval;
   if);
  

-- PolygonDrawOn: doPart --
do (if fill[] <> NONE then
      fill[] -> theSurface.pen;
      points[] -> theSurface.fillPolygon;
   if);
   (if stroke[] <> NONE then
      stroke[] -> theSurface.pen;
      points[] -> theSurface.drawPolygon;
   if);
   

-- TextItemDrawOn: doPart --
do style[] -> theSurface.style;
   (if stroke[] <> NONE then
       stroke[] -> theSurface.pen;
       angle -> theSurface.angle;
       (if content[] <> NONE then
           content[] -> theSurface.drawText;
       if);
   if);
   
-- PixmapItemDrawOn: doPart --
do 
   (if content[] <> NONE then
       content[] -> theSurface.drawPixmap;
   if);

-- CompositeAdd: doPart --
do child[] -> children.append;

-- CompoisteRemove: doPart --
do child[] -> children.at -> children.delete;
   
-- CompositeClear: doPart --
do children.clear;
   
-- CompositeDrawOn: doPart --
do children.scan
     (#
     do theSurface[] -> current.drawOn;
     #);

-- GraphicsCanvasOnMouseDown: doPart --
do localPosition -> select -> current[];
   (if current[] <> NONE then
       (localPosition, globalPosition, buttonState, doubleClick, shiftKey, controlKey, when) 
         -> current.onMouseDown;
    else
       INNER onMouseDown;
   if);
   
-- GraphicsCanvasOnMouseUp: doPart --
do (if current[] <> NONE then
       (localPosition, globalPosition, buttonState, doubleClick, shiftKey, controlKey, when) 
         -> current.onMouseUp;
       NONE -> current[];
    else
       INNER onMouseUp;
   if);
   
-- GraphicsCanvasOnMouseMove: doPart --
do (if current[] <> NONE then
       (localPosition, globalPosition, buttonState, doubleClick, shiftKey, controlKey, when) 
         -> current.onMouseMove;
   if);
   INNER onMouseMove;
   
   
-- GraphicsCanvasAddLayer: doPart --
do theLayer[] -> layers.append;
   
-- GraphicsCanvasRemoveLayer: doPart --
do theLayer[] -> layers.at -> layers.delete;
