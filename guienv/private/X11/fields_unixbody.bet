ORIGIN '../fieldsbody';
INCLUDE 'widget'
        'guienvattributes'
        'motifstuff'
        'guienv_unixprivate'
        '~beta/sysutils/objinterface'
        'callbacks'
        '../../graphics';
LIB_ITEM 'guienvfields';
-- textFieldLib: Attributes --
getselection: external
  (# w: @integer; leftP,rightP: @integer; result: @boolean; 
  enter (w,leftP,rightP)
  exit result
  #);
handleTextFieldValueChanged: motifCallbackSelector
  (#  do theEventHandler.onTextChanged;  #);
textFieldValueChangedProcessor: callbackProcessor
  (#  do &handleTextFieldValueChanged[]->cb[];  #);
handleTextFieldBeforeChange: textCallbackSelector
  (#
     allow: @boolean;
     position: @integer;
     length: @integer;
     textBlock: @XmTextBlockRec;
     
  do
     startPos->position;
     textP->THIS(guienv).private.textP;
     (if startPos = endPos then
         textP->textBlock; textBlock.length->length; 
      else
         startPos-endPos->length; 
     if);
     (position,length)->theEventHandler.onBeforeChange->allow;
     (* datpete feb 14 1996: removed use of 'doit' because of
      * Motif bug in connection with delete button
      *)
     (*allow -> doit;*)
     (if not allow then
     (* set textblock.length to 0 in case there is some text to
      * insert
      *)
         textP->textBlock;
         0->textBlock.length;
         (* set endpos to startpos in case it is a deletion/paste *)
         (%getLongAt (callDataAddress+textStartPosOffset))
         %putLongAt
           (callDataAddress+textEndPosOffset);
         
     if)
  #);
textFielVerifyProcessor: callbackProcessor
  (#  do &handleTextFieldBeforeChange[]->cb[];  #);
  

-- GUIENVtextFieldBeforeChangeTheText: DoPart --
do
     (#
        textBlock: @XmTextBlockRec;
        textAddress: @integer;
        textLength: @integer;
        memcpy: external
          (# dstAddress,srcAddress,size: @integer; 
          enter (dstAddress,srcAddress,size)
          #);
        
     do
        THIS(guienv).private.textP->textBlock;
        textBlock.length->textLength;
        (if textLength > 0 then
            textBlock.ptr->textAddress;
            &text[]->value[];
            textLength->value.T.new;
            (@@ value.T[1],textAddress,textLength)->memcpy;
            textLength->value.lgth->value.pos;
            
         else
            none ->value[]; 
        if);
        
     #);
     

-- GUIENVmovieFieldSetContents: Descriptor --
(#  do  #)  

-- GUIENVmovieFieldGetContents: Descriptor --
(#  do  #)  

-- GUIENVmovieFieldSetScaleToFit: Descriptor --
(#  do  #)  

-- GUIENVmovieFieldGetScaleToFit: Descriptor --
(#  do  #)  

-- GUIENVmovieFieldCreate: Descriptor --
(#  do  #)  

-- GUIENVmovieFieldOpen: Descriptor --
(#  do INNER open;  #)  

-- GUIENVmovieFieldClose: Descriptor --
(#  do INNER close;  #)  

-- GUIENVmovieFieldPrivate: Descriptor --
(#  #)  

-- GUIENVtextFieldDoPaste: Descriptor --
(#  do widgetID->XmTextPaste;  #)  

-- GUIENVtextFieldDoCopy: Descriptor --
(#  do (widgetID,0)->XmTextCopy;  #)  

-- GUIENVtextFieldDoCut: Descriptor --
(#  do (widgetID,0)->XmTextCut;  #)  

-- GUIENVtextFieldDoClear: Descriptor --
(#
   XmTextClearSelection: external
     (# widget,time: @integer;  enter (widget,time) #);
   
do (widgetID,0)->XmTextCut; 
#)  

-- GUIENVtextFieldSetContents: Descriptor --
assertOpen
  (# location::  (#  do 'TextField.SetContents'->t[] #); 
  do (XmNvalue,theText[])->setStringResource; 
  #)  

-- GUIENVtextFieldGetContents: Descriptor --
assertOpen
  (# location::  (#  do 'TextField.GetContents'->t[] #); t: ^text; 
  do
     XmNvalue->getStringResourceCopy->t[];
     &styledText[]->theText[];
     t->theText;
     
  #)  

-- GUIENVtextFieldGetChar: Descriptor --
assertOpen
  (# location::  (#  do 'TextField.GetChar'->t[] #); charPtr: @integer; 
  do
     XmNvalue->getPointerResource->charPtr;
     (if charPtr <> 0 then
         (%getByteAt(charPtr+pos))->ch; charPtr->XtFree; 
         (* Above line tos_converted from: charPtr+pos->tos'%adrGetByte'->ch; charPtr->XtFree; *)
      else
         '"XmNvalue -> getPointerResource" failed'->putLine; 
     if);
     
  #)  

-- GUIENVtextFieldLength: Descriptor --
assertOpen
  (# location::  (#  do 'TextField.Length'->t[] #); charPtr: @integer; 
  do
     XmNvalue->getPointerResource->charPtr;
     (if charPtr <> 0 then
         charPtr->strlen->value; charPtr->XtFree; 
      else
         '"XmNvalue -> getPointerResource" failed'->putLine; 
     if);
     
  #)  

-- GUIENVtextFieldScanText: Descriptor --
assertOpen
  (#
     location::  (#  do 'TextField.ScanText'->t[] #);
     amount: @integer;
     charPtr: @integer;
     lastPosition: @Integer;
     
  do
     (if Start <> End then
         XmNvalue->getPointerResource->charPtr;
         (if charPtr <> 0 then
             charPtr->strlen->lastPosition;
             (if (end > lastPosition) then lastPosition->end if);
             (if (start < 0) then 0->start;  if);
             (if (start > end) then
                 - 1->amount; start-1->start; end-1->end; 
              else
                 1->amount
             if);
             loop:
             (if (start <> end) then
                 (%getByteAt(charPtr+start))->ch;
                 (* Above line tos_converted from: charPtr+start->tos'%adrGetByte'->ch; *)
                 INNER scanText;
                 start+amount->start;
                 restart loop
             if);
             charPtr->XtFree;
             
          else
             '"XmNvalue -> getPointerResource" failed'->putLine; 
         if);
         
     if);
     
  #)  

-- GUIENVtextFieldPosToPt: Descriptor --
assertOpen
  (# location::  (#  do 'TextField.PosToPt'->t[] #); x,y: @integerRef; 
  do
     (if ((widgetID,pos,x,y)->XmTextPosToXY) <> 0 then
         x.shortValue->pt.h; y.shortValue->pt.v; 
      else
         (- 1,- 1)->pt; 
     if);
     
  #)  

-- GUIENVtextFieldPtToPos: Descriptor --
assertOpen
  (# location::  (#  do 'TextField.PtToPos'->t[] #); 
  do (widgetID,pt.h,pt.v)->XmTextXYtoPos->pos; 
  #)  

-- GUIENVtextFieldSelectionStart: Descriptor --
assertOpen
  (#
     location::  (#  do 'TextField.SelectionStart'->t[] #);
     left,right: @integer;
     result: @boolean;
     id: @integer;
     
  do
     widgetID->id;
     (id,@@ left,@@ right)->getselection->result;
     (if result then
         left->value; 
      else
         XmNcursorPosition->getPointerResource->value; 
     if);
     
  #)  

-- GUIENVtextFieldSelectionEnd: Descriptor --
assertOpen
  (#
     location::  (#  do 'TextField.SelectionEnd'->t[] #);
     left,right: @integer;
     result: @boolean;
     id: @integer;
     
  do
     widgetID->id;
     (id,@@ left,@@ right)->getselection->result;
     (if result then
         right->value; 
      else
         XmNcursorPosition->getPointerResource->value; 
     if);
     
  #)  

-- GUIENVtextFieldSelectionContents: Descriptor --
assertOpen
  (#
     location::  (#  do 'TextField.SelectionContents'->t[] #);
     str: @cstring;
     
  do
     widgetID->XmTextGetSelection->str;
     str.get->theText[];
     (*str.free; NO - was allocated with XtMalloc *)
     str.charptr->XtFree;
     theText.T.range->theText.pos->theText.lgth;
     
  #)  

-- GUIENVtextFieldSelectionScrollIntoView: Descriptor --
assertOpen
  (#
     location::  (#  do 'TextField.ScrollIntoView'->t[] #);
     start,end: @integer;
     ID: @integer;
     XmTextDisableRedisplay: external (# id: @integer;  enter id #);
     XmTextEnableRedisplay: external (# id: @integer;  enter id #);
     
  do
     selection.start->start;
     selection.end->end;
     widgetID->ID;
     (* ID -> XmTextDisableRedisplay; *)
     (ID,end)->XmTextShowPosition;
     (ID,start)->XmTextShowPosition;
     (* ID -> XmTextEnableRedisplay; *)
     
  #)  

-- GUIENVtextFieldSelectionSet: Descriptor --
assertOpen
  (#
     location::  (#  do 'TextField.SelectionSet'->t[] #);
     currentTime: (#  exit 0 #);
     (* Special constant *)
     
  do
     (if theStart = theEnd then
         (widgetID,currentTime)->XmTextClearSelection;
         (widgetID,theStart)->XmTextSetInsertionPosition;
         
      else
         (widgetID,theStart,theEnd,currentTime)->XmTextSetSelection;
         (widgetID,theStart)->XmTextSetInsertionPosition;
         
     if);
     
  #)  

-- GUIENVtextFieldSetDefaultStyle: Descriptor --
assertOpen
  (# location::  (#  do 'TextField.SetDefaultStyle'->t[] #); 
  do (XmnFontList,style.createFontList)->setIntegerResource; 
  #)  

-- GUIENVtextFieldGetDefaultStyle: Descriptor --
assertOpen
  (# location::  (#  do 'TextField.GetDefaultStyle'->t[] #); 
  do
     &textStyle[]->style[];
     XmNfontList->getIntegerResource->style.initWithFontList;
     
  #)  

-- GUIENVtextFieldIsOneStyle: Descriptor --
(#  do  #)  

-- GUIENVtextFieldSetOneSize: Descriptor --
(#  do  #)  

-- GUIENVtextFieldSetOneFont: Descriptor --
(#  do  #)  

-- GUIENVtextFieldSetOneFace: Descriptor --
(#  do  #)  

-- GUIENVtextFieldSetOneStyle: Descriptor --
(#  do  #)  

-- GUIENVtextFieldScanTextWithStyle: Descriptor --
(#  do  #)  

-- GUIENVtextFieldSetMargin: Descriptor --
assertOpen
  (# location::  (#  do 'TextField.SetMargin'->t[] #); 
  do
     (XmNmarginWidth,leftMargin)->setIntegerResource;
     (XmNmarginHeight,topMargin)->setIntegerResource;
     
  #)  

-- GUIENVtextFieldGetMargin: Descriptor --
assertOpen
  (# location::  (#  do 'TextField.GetMargin'->t[] #); 
  do
     XmNmarginWidth->getPointerResource->leftMargin;
     XmNmarginHeight->getPointerResource->topMargin;
     
  #)  

-- GUIENVtextFieldInsert: Descriptor --
assertOpen
  (#
     location::  (#  do 'TextField.Insert'->t[] #);
     pos: @integer;
     XmTextInsert: external
       (# widget,position: @integer; charP: @integer; 
       enter (widget,position,charP)
       #);
     cstr: @cString;
     left,right: @integer;
     result: @boolean;
     id: @integer;
     
  do
     widgetID->id;
     (id,@@ left,@@ right)->getselection->result;
     (if result then
         left->pos; 
      else
         XmNcursorPosition->getPointerResource->pos; 
     if);
     theText[]->cstr.set;
     (widgetID,pos,cstr)->XmTextInsert;
     cstr.free;
     
  #)  

-- GUIENVtextFieldDelete: Descriptor --
assertOpen
  (# location::  (#  do 'TextField.Delete'->t[] #); 
  do widgetID->XmTextRemove; 
  #)  

-- GUIENVtextFieldCreate: Descriptor --
(# 
do
   INNER create;
   (if widgetID = 0 then
       (xmTextWidgetClass,father.widgetID)->createSimple;
       (XmNeditMode,XmMULTI_LINE_EDIT)->setIntegerResource;
       (XmNhighlightThickness,0)->setIntegerResource;
       (XmNautoShowCursorPosition,true)->setBooleanResource;
       (XmNverifyBell,false)->setBooleanResource;
       
   if);
   
#)  

-- GUIENVtextFieldOpen: Descriptor --
(# 
do
   (textFieldValueChangedProcessor##,XmNvalueChangedCallback)
     ->addCallbackProcessor;
   (textFielVerifyProcessor##,XmNModifyVerifyCallback)->addCallbackProcessor;
   INNER open;
   
#)  

-- GUIENVtextFieldClose: Descriptor --
(#  do INNER close;  #)  

-- GUIENVtextfieldonframechanged: Descriptor --
(#  do INNER onFrameChanged;  #)  

-- GUIENVtextfieldonrefresh: Descriptor --
(#  do INNER onRefresh;  #)  

-- GUIENVtextfieldonmouseup: Descriptor --
(#  do INNER onMouseUp;  #)  

-- GUIENVtextfieldondisabletarget: Descriptor --
(#  do INNER onDisableTarget;  #)  

-- GUIENVtextfieldonmousedown: Descriptor --
(#  do INNER onMouseDown;  #)  

-- GUIENVtextfieldonkeydown: Descriptor --
(#  do controlKey->controlModified; INNER onKeyDown;  #)  

-- GUIENVtextfieldonenabletarget: Descriptor --
(#  do INNER onEnableTarget;  #)  

-- GUIENVtextFieldPrivate: Descriptor --
(#  #)  

-- GUIENVabstractScrollerScroll: Descriptor --
(#  do INNER Scroll;  #)  

-- GUIENVabstractScrollerCreate: Descriptor --
(#  do INNER create;  #)  

-- GUIENVabstractScrollerOpen: Descriptor --
(#  do THIS(abstractScroller)[]->contents.open; INNER open;  #)  

-- GUIENVabstractScrollerClose: Descriptor --
(#  do INNER close;  #)  

-- GUIENVabstractScrollerPrivate: Descriptor --
(#  #)  

-- GUIENVtextEditorScroll: Descriptor --
(#  do INNER scroll;  #)  

-- GUIENVtextEditorCreate: Descriptor --
(# args: @argList; textFieldWidget: @integer; fatherWidget: @integer; 
do
   INNER create;
   (if widgetID = 0 then
       (1,XmNeditMode,XmMULTI_LINE_EDIT)->args.set;
       (2,XmNverifyBell,0)->args.set;
       father.widgetID->fatherWidget;
       (fatherwidget,'scrolledtext',args[],2)->XmCreateScrolledText
         ->textFieldWidget;
       textFieldWidget->XtManageChild;
       textFieldWidget->XtParent->widgetID;
       textFieldWidget->contents.widgetID;
       
   if)
#)  

-- GUIENVtextEditorOpen: Descriptor --
(#  do INNER open;  #)  

-- GUIENVtextEditorClose: Descriptor --
(#  do INNER close;  #)  

-- GUIENVtexteditorprivate: Descriptor --
(#  #)  

-- GUIENVscrollerScroll: Descriptor --
(#  do INNER scroll;  #)  

-- GUIENVscrollerCreate: Descriptor --
(# args: @argList; name: ^text; fatherwidget: @integer; 
do
   INNER create;
   (if widgetID = 0 then
       THIS(scroller)[]->getPatternName->name[];
       (1,XmNscrollingPolicy,XmAUTOMATIC)->args.set;
       (2,XmNscrollbarDisplayPolicy,XmSTATIC)->args.set;
       (* (3,XmNvisualPolicy,XmVARIABLE) -> args.set; *)
       father.widgetID->fatherwidget;
       (name,xmScrolledWindowWidgetClass,fatherwidget,args[],2)
         ->XtCreateManagedWidget->widgetID;
       (scrollerExposeProcessor##,XExposureMask)->appendEventProcessor;
       
   if);
   
#)  

-- GUIENVscrollerOpen: Descriptor --
(#
   ID: @integer;
   itsValue,itsSliderSize,itsIncrement,itsPageIncrement: @integer;
   
do
   INNER open;
   (XmNworkWindow,contents.widgetID)->setIntegerResource;
   (* set vertival scrolling policy *)
   XmNverticalScrollbar->getIntegerResource->ID;
   (ID,@@ itsValue,@@ itsSliderSize,@@ itsIncrement,@@ itsPageIncrement)
     ->XmScrollBarGetValues;
   (ID,itsValue,itsSliderSize,32,itsPageIncrement,1)->XmScrollBarSetValues;
   (* set horisontal scrolling policy *)
   XmNhorizontalScrollbar->getIntegerResource->ID;
   (ID,@@ itsValue,@@ itsSliderSize,@@ itsIncrement,@@ itsPageIncrement)
     ->XmScrollBarGetValues;
   (ID,itsValue,itsSliderSize,32,itsPageIncrement,1)->XmScrollBarSetValues;
   

#)  

-- GUIENVscrollerClose: Descriptor --
(#  do INNER close;  #)  

-- GUIENVscrollerOnFrameChanged: Descriptor --
(#  do INNER onFrameChanged;  #)  

-- scrollerLib: Attributes --
scrollerExposeProcessor: eventProcessor
  (#  do &refreshSelector[]->es[];  #);
refreshSelector: exposeEventSelector
  (# ID: @integer; args: @argList; itsWidth,itsHeight,itsX,itsY: @shortInt; 
  do
     (if count = 0 then
         (if private.hiliteContents then
             XmNclipWindow->getIntegerResource->ID;
             (1,XtNwidth,@@ itsWidth)->args.set;
             (2,XtNheight,@@ itsHeight)->args.set;
             (3,XtNx,@@ itsX)->args.set;
             (4,XtNy,@@ itsY)->args.set;
             (ID,args[],4)->XtGetValues;
             graphics
               (# 
               do
                  ((itsX-4,itsY-4),(itsX+itsWidth+3,itsY+itsHeight+3))
                    ->drawRect;
                  ((itsX-3,itsY-3),(itsX+itsWidth+2,itsY+itsHeight+2))
                    ->drawRect;
                  
               #);
             
         if);
         
     if);
     
  #);
hiliteContents:
  (# value: @boolean
  enter value
  do
     (if value <> private.hiliteContents then
         value->private.hiliteContents; update; 
     if);
     
  #);
  

-- GUIENVscrollerPrivate: Descriptor --
(# hiliteContents: @boolean;  #)  

