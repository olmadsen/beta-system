ORIGIN 'guienv_macprivate';
INCLUDE '../pathmanager';

BUILD default ':$$/raster_mac.obj' ':external/raster_mac.c' 'mrc -o $0 $1';

INCLUDE '~beta/maclib/v3.0/mactypes';



-- pixmapLib: attributes --
LockPix: external
	(# pixmap,data: @integer;
	enter (pixmap,data)
	#);
UnlockPix: external
	(# pixmap,data: @integer;
	enter (pixmap,data)
	#);
	
CreatePixPatFromPixMap: external
	(# pixmap, data, pixpat: @integer;
	enter (pixmap, data)
	exit pixpat
	#);
CreatePixmapFromPictureFile: external
	(# name: [1] @char;
		pixelsP,dataP: @integer;
	enter (name,pixelsP,dataP)
	#);
PixMapGetWidth: external
	(#	pixels: @integer;
		width: @integer;
	enter pixels
	exit width
	#);
PixMapGetHeight: external
	(#	pixels: @integer;
		height: @integer;
	enter pixels
	exit height
	#);
PixMapGetSize: external
	(# pixels: @integer;
		width,height: ^longInt;
	enter (pixels,width[],height[])
	#);
CreateBitmapFromPictureFile: external
	(# name: [1] @char;
		bitMapHandleP: @integer;
		dataHandleP: @integer;
		error: @integer;
	enter (name,bitMapHandleP,dataHandleP)
	exit error
	#);
BitMapGetSize: external
	(# bitMapHandle: @integer;
		width,height: ^longInt;
	enter (bitMapHandle,width[],height[])
	#);
BitMapGetWidth: external
	(# bitMapHandle: @integer;
		width: @integer;
	enter bitMapHandle
	exit width
	#);
BitMapGetHeight: external
	(# bitMapHandle: @integer;
		height: @integer;
	enter bitMapHandle
	exit height
	#);


getPixmapPathManager: objectPool.get
  (# type:: pixmapPathManager;
     exact:: (# do true -> value #);
     init:: (# do obj.init #);
  #);
  

pixmapPathManager: pathManager
	(# init::
			(# betalib: ^text;
				pixmapDir: ^text;
			do ':' -> add;
				':pixmaps:' -> add;
			#);
	#);

search:
  (# name: ^text;
     expandedName: ^text;
  enter name[]
  do (# thePixmapPathManager: ^pixmapPathManager;
     do getPixmapPathManager -> thePixmapPathManager[];
        name[] -> thePixmapPathManager.lookup -> expandedName[];
     #);
  exit expandedName[]
  #);

expandPixmapName:
  (# name: ^text;
     expandedName: ^text;
     error:<
       (# msg: ^text;
       enter msg[]
       do INNER;
       #);
     
  enter name[]
  do (# isPath: @boolean;
        hasExtension: @boolean;
        doesNotExists:
          (# msg: ^text;
          do &text[] -> msg[];
             'PICT file "' -> msg.putText;
             name[] -> msg.putText;
             '" does not exist' -> msg.putLine;
             msg[] -> error;
          #);
        wasNotFound:
          (# msg: ^text;
          do &text[] -> msg[];
             'PICT file "' -> msg.putText;
             name[] -> msg.putText;
             '" was not found in any of the pixmap directories' -> msg.putLine;
             msg[] -> error;
          #);
     do (if (name[] <> NONE) and (not name.empty) then
            name.reset;
            l: ':' -> name.find (# do true -> isPath; leave l; #);
            (if isPath then
                (if name[] -> exists then
                    name.copy -> expandedName[];
                 else
                    doesNotExists;
                if);
             else
                l: '.' -> name.find (# do true -> hasExtension; leave l #);
                (if not hasExtension then
                    '.pict' -> (name.copy).append -> name[];
                if);
                name[] -> search -> expandedName[];
                (if expandedName[] = NONE then
                    wasNotFound;
                if);
            if);
        if);
     #);
  exit expandedName[]
  #);
  
-- GUIENVRastercopyPatternData: descriptor --
(#
#)

-- GUIENVrasterLock: descriptor --
(#

#)

-- GUIENVrasterUnlock: descriptor --

(#

#)

 
-- pixMapRead: doPart --
do l: (# expandedName: ^text;
		do name[] -> expandPixmapName 
			(# error::
				  (# 
				  do msg[] -> this(read).error;
					  leave l;
				  #);
			#) -> expandedName[];
			(if expandedName[] <> NONE then
				(# 
					address,data: @integer;
					t: @text;
				do (expandedName,@@address,@@data) -> CreatePixmapFromPictureFile;
					(if address<>0 then
						address -> private.address;
						data -> private.data;
						address -> PixMapGetWidth -> private.width;
						address -> PixMapGetHeight -> private.height;
					if);
				#)
			if);
		#);

-- pixmapInit: doPart --
do

-- pixmapDispose: doPart --
do

-- pixmapWidth: doPart --
do

-- pixmapHeight: doPart --
do

