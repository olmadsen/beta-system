ORIGIN '../getfilebody';

INCLUDE '~beta/basiclib/v1.4/file';
INCLUDE '~beta/sysutils/v1.4.2/cstring';
INCLUDE '~beta/win32lib/v1.1/winbase';

-- lib: attributes --
getCurrentDir:
  (# dir: ^text;
     cstr: @cstring; res: @integer;
  do 256 -> cstr.init;
     (256, cstr.charPtr) -> GetCurrentDirectory -> res;
     (if res=0 then 
         'GetCurrentDirectory failed' -> putLine;
      else
         cstr.get -> dir[];
     if);
     cstr.free;
     
     'dir: ' -> puttext; dir[] -> putline;
     'dir.length: ' -> puttext; dir.length -> putint; newline;
  exit dir[]
  #);

-- GUIENVgetFile: doPart --
do (# theFileBrowserWindow: @fileBrowserWindow
        (# fileBrowserType::
             (# filter::
                  (# anEntry: @diskEntry;
                     itsExt: ^text;
                  do (if ext[] = none then
                         true -> value;
                      else
                         name[] -> anEntry.path;
                         anEntry.path.name.extension -> itsExt[];
                         ext[] -> itsExt.equal -> value;
                     if);
                  #);
                fileSelected::
                  (# 
                  do name.copy -> this(getFile).name[];
                     theFileBrowserWindow.close;
                  #);
                userCancel::
                  (#
                  do theFileBrowserWindow.close;
                  #);
             #);
           open::
             (# cStr: @cString; curDir: ^text;
             do 'File browser' -> title;
                '1 ' -> putline;
                getCurrentDir -> curDir[];
                '2 ' -> putline;
                (if curDir[]<>NONE then
                    '3 ' -> putline;
                    curdir[] -> theFileBrowser.theDirectory;
                    '4 ' -> putline;
                    hide;
                    '5 ' -> putline;
                 else
                    'curDir is NONE' -> putline;
                if);
             #);
        #);
   do 'Before theFileBrowserWindow.open;' -> putline;
      theFileBrowserWindow.open;
      'After theFileBrowserWindow.open; ' -> putline;
      theFileBrowserWindow.showModal;
      'After theFileBrowserWindow.showModal;' -> putline;
   #);


