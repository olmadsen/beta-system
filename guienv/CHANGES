******************************************************************************
Thu May 29  1997: Michael Lassen

Merged r4.0.3 onto head and solved conflicts. 

******************************************************************************
Thu May 29  1997: Michael Lassen

Changes in the Macintosh implementation:


o Added a further binding of onVisibleChanged in  Canvas.
  Canvas now sends onVisibleChanged to its visible children.

o Added a further binding of onVisibleChanged in Scrolllist, to 
  hide the toolbox scrollist  by turning drawing on and off 
  (LSetDrawingMode).

o Added assertOpen to all methods in windowItem  (and descendants), 
  so the notOpened exception is called.
	
o Made small fixes to the implementation of optionButton

o Implemented onMouseUp

o Fixed onMouseDown in scrolllist to not call onMouseUp when the click
  occurs in the scrollbar.
  
o Made an overall update fix by testing for "viewable" instead of "visible".

    windowItem.viewable = windowItem.visible AND windowItem.father.viewable
	
o Fixed som scrolling logic bugs in "scroller"

o Implemented the Region pattern in "graphmath"

o Implemented the figureItems

o Changed some dangerous uses of the  @@ operation.

o Moved some toolbox interfacing from guienv to maclib.

o Other small now forgotten fixes.


******************************************************************************
Thu May 29  1997: Michael Lassen

Change in Unix implementation:

The resource popupEnabled are set to False. Normally, it is not
possible to have a popupmenu in both a canvas and one of its
children. When popupEnabled is False, this is possible.

******************************************************************************
Mon Apr 7 1997: Michael Lassen

The changes made in the r4_0_1a_correction_branch is merged into the
main trunk.

******************************************************************************

   The following changes are made in v1.4, r4.0.2.

******************************************************************************
Marts 15, 1997: Michael Lassen

Changes in Unix implementation:

o Changed a problem with the use of shortint in external calls to Xlib
  and Xt: The arguments  was treated as signed shorts by Xlib and
  Xt, but unsigned short by BETA. The fix looks like this:

       x -> uShort2Short -> x;

     uShort2Short:
       (# value: @integer;
       enter value
       do  (if value > 32768 then
              value - 65536 -> value;
           if);
       exit value
       #);

******************************************************************************



1) Introduced use of BUILD instead of MAKE+OBJFILE in implementation

2) transfermode changed to constants instead of objects.

3) In case of 'Cannot open display' in X implementation,
   the program now stops with normal error code instead of 
   failure error code.

******************************************************************************

   The following changes are made in v1.4, r4.0.1.


******************************************************************************

********************************
January 29, 1997: Lennert Sloth

1) guienv_nti.c: 
  - updateAccelTable, deleteAccel: No longer calls CreateAcceleratorTable with
    empty accel list.
  - New function: getOsMajorVersionId.

2) scrolllists.bet: 
   - scrollListDelete: Initial values of "min" and "upper" was wrong.

3) controls_ntibody.bet: 
   Now delegates font changes to the dropDown list.
   - optionbutton.open: 
	(dropDownListID,WM_SETFONT,theTextStyle.textStyleID,1) -> SendMessage;

   - GUIENVoptionButtonOnStyleChanged:
        (dropDownListID,WM_SETFONT,theTextStyle.textStyleID,1) ->SendMessage;


4) guienv_ntibody.bet: 
   - Now detects if too much text is entered into a textfield.
     (if type=EN_MAXTEXT then
   - processWM_CTLCOLORBTN and processWM_CTLCOLORSTATIC are
     new in GUIENVwindowItemMethodsdispatchMessage. They see to that
     the background color of controls are the same as their canvas.


5) guienv_ntibody.bet
   - Interface to getOsMajorVersionId.

6) graphics_ntibody.bet: 
   - Now use penstyle: PS_INSIDEFRAME. 
   - Deleted getOsVersionId. It was also in guienv_ntiprivate.bet

7) fields_ntibody.bet: 
   - Removed processScroll.


8) stddialogs_ntibody.bet: On win32 you cannot set "label". Before
   label was used to set the default filename. This has been
   corrected. "fileName" is now used for that.



********************************
January 28, 1997: Peter Andersen

Renamed files with long file names:

demo/windowWithStandardMenubar.bet
	-> demo/windowWithStdMenubar.bet
private/winnt/optionbutton_ntiprivate.bet
	-> private/winnt/optionbutton_nti.bet
utils/private/X11/movabletextfieldX11body.bet
	-> utils/private/X11/movabletextfield_X11.bet
utils/private/macintosh/movabletextfield_macbody.bet
	-> utils/private/macintosh/movabletextfield_mac.bet
utils/private/winnt/movabletextfield_ntibody.bet
	-> utils/private/winnt/movabletextfield_nti.bet


******************************************************************************
January 25, 1997: Michael Lassen


Unix Implementation:

   o Implemented textField.defaultFont. 
     File:

       ./private/X11/fields_unixbody.bet

******************************************************************************
January 23, 1997: Michael Lassen


Added support for color icons.

New files:

   interface: 

      ./utils/iconname.bet: Adds the operation ``iconname'' to
                            iconButton. This operation reads a pixmap
                            file and uses the pixmap as the icon.

   implementation:

      ./utils/private/iconnamebody.bet
      ./utils/private/X11/iconname_x11body.bet
      ./utils/private/winnt/iconname_ntibody.bet
      ./utils/private/macintosh/iconname_macbody.bet

    external code:

      ./utils/private/external/xpm/*.h *.c Makefile


******************************************************************************
January 22, 1997: Michael Lassen

Unix implementation:

  o The implementation of raster and graphics are extended to make it
    possible to use color pixmaps and not just black and white
    bitmaps. This is done in a way that will *not* interfere with
    existing GUIenv applications. This is accomplished by adding a
    boolean ``newstyle'' to the (unix) private part of raster. The
    ``drawraster'' calls XCopyArea instead of XCopyPlane if
    ``newstyle'' is true.

    Files:
       private/X11/raster_unixbody.bet
       private/X11/graphics_unixbody.bet 

******************************************************************************
January 20, 1997: Michael Lassen

Unix implementation:

  o The use of @@ made safe: All allocations in conjunction with the
    @@ construct and external procedures are eliminated. The affected
    files are:

       ./private/X11/scrolllists_unixbody.bet
       ./private/X11/fields_unixbody.bet

  o The error handler is changed to differentiate between xlib errors
    and xlib fatal error. In the latter case the stack is not dumped
    so as to avoid a stack dump when people choose ``destroy'' in the
    window menu. Files:

       ./private/X11/error.bet
       ./private/X11/errorbody.bet


******************************************************************************
December 19, 1996: Michael Lassen

A correction is made in the unix implementation:

  o The "textField.selection.scrollIntoView" did not always ensure the
    the entire selection was visible in the window. This is changed.

******************************************************************************
December 18, 1996: Michael Lassen

An enhancement is made in the unix implementation: the Xt and Xlib
errors are now catched in a BETA exception and the stack is
dumped. This is useful if the application is started in "sync" mode.

Two new files are added in private/X11:

   error.bet
   errorbody.bet

They are copied almost verbatim from the Bifrosts "errorhandler" code.


******************************************************************************
December 18, 1996: Michael Lassen

An error is fixed in the unix implementation:

  o It was not possible to set and get the textstyle used in the 
    textScrollList, this error is fixed.

******************************************************************************
December 17, 1996: Michael Lassen

A number of errors related to the unix implementation is fixed:

   o The segmentation fault in the "drag" routine is fixed by moving
     an allocation outside of the enter list to an X routine with '@@'
     parameters:

       (display (* allocation *), @@x, ...) -> XQueryPointer;
   
   o A 16 bit wrap error is fixed.


******************************************************************************

December 14, 1996: OLM

A number of minor errors, such as changing absolute references like
	~beta/v1.4.1/guienv/
to relative references.
*****************************************************************************
November, 21, 1996: OLM

In controls_macbody.bet pattern toFuncPtr
	 ##external was changed to ##actionProc
A compiler error will otherwise imply that a Pascal callBack is 
transferred as a C callBack.
*****************************************************************************
November, 8 1996: Michael Lassen

Macintosh implementation:

A reference to MACGlobalToLocal in 
       utils/private/macintosh/track_macbody.bet
is changed to GlobalToLocal to avoid link problems on powermac.

******************************************************************************
November, 7 1996: Michael Lassen

Macintosh implementation:

Some changes are made in the macintosh implementation to correct an
index error that occurred in calls like ``(@@txt.T[1], ...) ->''. A
test is now inserted to check for txt.T.range = 0. The changed files
are in the private/macintosh directory, they are:

     controls_macbody.bet
     fields_macbody.bet
     graphics_macbody.bet
     guienv_macbody2.bet
     guienv_macprivate.bet
     scrolllists_macbody.bet


******************************************************************************
November, 4 1996: Michael Lassen

Version v1.4.1 is created as a merge between v1.3.2 and v1.4, where
v1.3.2 is a special macintosh version for release 3.0.

The changes from  v1.4 to v1.4.1 is:

   o There is not made any significant changes in the interface files.
     Some virtual bindings are added in controls.bet, this changes
     nothing for users of GUIenv.

   o Some macintosh specific bodies are added in the directory
     ``private/macintosh''.

   o mac, ppc and ppcmac MDBODY entries are added in the body files in
     ``private''.


******************************************************************************


   The following changes are made in v1.4 and earlier.

******************************************************************************
August, 9 1996: Lennert Sloth
1) private/winnt/graphics_ntibody.bet
   a) The drawing operations did not take figureItems (i.e. windowItems that are not win32
      windows) into account. This is done now by initializing private.windowID and 
      private.translateX and private.translateY in GUIENVgraphicsBody and then using these
      in all drawing operations, just as in guienv_unixbody.bet

2) private/winnt/guienv_ntibody.bet
   a) GUIENVcanvasOnRefresh: Now only calls onRefresh on figureItems if
      they are visible.

3) private/winnt/guienv_ntiprivate.bet
   a) Because case in fragment names now matters on Win32,
      INCLUDE '~beta/containers/v1.5/hashtable'; 
      was changed to:
      INCLUDE '~beta/containers/v1.5/hashTable';

4) demo/TutorialDemos/textEditorFull.bet
   a) Crashed if you clicked cancel in the file dialog and if you tried to save
      without first having opened a file.

******************************************************************************
June, 28 1996: Lennert Sloth
1) private/winnt/guienv_ntibody.bet 
   
   a) Just removed a debug printout from processDrawItem.

******************************************************************************
June, 27 1996: Lennert Sloth
1) private/winnt/guienv_ntibody.bet 
   
   a) win32Menuitem: create and updateMenuItem:
      No longer just prepends the menuItem name with a '&' to make a 
      Mnemonics. The control is now left to the programmer.
      Removed: '&' -> name.prepend;
      See also 3) private/winnt/win32menubarbody.bet below.

   b) processMouseDown in GUIENVwindowItemMethodsdispatchMessage
      Removed: interfaceObjectID -> SetCapture;
      Somethings stops working under Win95 if we do capture the mouse here.
      These problems has not been observed under Win NT.

   c) processMouseUp in GUIENVwindowItemMethodsdispatchMessage.
      - As we no longer capture the mouse in processMouseDown we should 
        no longer release it here.
      - - 'or doubleClickPossible ' has been removed from condition in 'if'
        statement, and (if doubleClickPossible then
                           0 -> this(guienv).private.lastCaptureID;
                       if);
        has been added to the body of 
        '(if ( (0 < pt.h) and (pt.h < w) and (0 < pt.v) and (pt.v < h) ) then'

   d) The clipboard:
      New implementation of:
       TextToClipboard, TextFromClipboard, GUIENVclipBoardSetText and
       GUIENVclipBoardGetText.
      See also 5) private/winnt/external/guienv_nti.c a) below.

   e) GUIENVStandardWindowProc:
      New implementation. All messages are now allow to slip through.
      This is to make it possible to define new windowitems that must handle
      new messages without having to modify the GUIENVStandardWindowProc.


2) private/winnt/stddialogs_ntibody.bet
 
   a) The changes listed under b) and c) above under guienv_ntibody.bet  
      makes it necessary to clear 
      this(guienv).private.lastCaptureID whenever guienv uses a window that
      is not controled by itself, e.g. when using standard dialogs. Therefor
      "0 -> this(guienv).private.lastCaptureID;" has been added to 
      "GUIENVdialog: doPart" in stddialogs_ntibody.bet.

3) private/winnt/win32menubarbody.bet

   a) GUIENVwin32Menubarappend and GUIENVwin32Menubarinsert
      As for menuItems, no longer just prepends the menuItem name with a 
      '&' to make a Mnemonics. The control is now left to the programmer.
      Removed: '&' -> name.prepend;

4) private/winnt/guienv_ntiprivate.bet

   a) GUIENVPrivate:
      Added  isMCIWndClassReg: @boolean;. Used to support movies.

5) private/winnt/external/guienv_nti.c

   a) New implementation of TextFromClipboard.

6) private/winnt/externa/stdfiledlg.c + private/winnt/stddialogs_ntibody.bet
   
   a) New implementation of stdopenfiledlg and stdsavefiledlg in stdfiledlg.c.
      Now all strings are malloc'd, copied and freed. The result should be freed from
      BETA.
      These changes are reflected in private/winnt/stddialogs_ntibody.bet.

7) private/winnt/fields_ntibody.bet

   a) GUIENVtextFieldPtToPos:
      Translated pos TO local, it must be FROM local.
      Made an operation "translateFromLocal" to do this. 
      GUIENVtextFieldSelectionStart and GUIENVtextFieldSelectionEnd now also use this
      instead of a local copy.


June, 14 1996: Lennert Sloth

1) private/winnt/guienv_ntibody.bet
   
   a) GUIENVDoPart: Added call of onStartApplication.

   b) registerUienvClass in GUIENVdoSetUp:
      - Deleted makeIntResource.
      - Added: 
            0 -> theClass.cbClsExtra;
            0 -> theClass.cbWndExtra;
      - Added:
            cstr.free;

   c) GUIENVdoSetUp:
      - Now only allocates 28 bytes for the message.

   d) GUIENVupdateRect:
      Deleted:
       - hRgn: @integer;
       - (* hRgn -> DeleteObject; *)
       - (* this(guienv).private.damaged[] -> value[]; *) 

   e) textStyleLib: attributes:
      - useTextStyle: Now allocates 56 bytes for infoPtr.

   f) GUIENVterminateBody now just do:
      0 -> PostQuitMessage;

   g) GUIENVstandardFileMenuOpen: 
      Fixed bug: saveMenuItem and saveAsMenuItem was mixed up.
      Before saveMenuItem and saveAsMenuItem were mixed:
      saveMenuitem.open;
      'Save as...' -> saveAsMenuitem.name;
      saveAsMenuitem[] -> append;

      Now:
      saveMenuitem.open;
      'Save' -> saveMenuitem.name;
      saveMenuitem[] -> append;

      saveAsMenuitem.open;
      'Save as...' -> saveAsMenuitem.name;
      saveAsMenuitem[] -> append;

   h) GUIENVwindowitemSetFrame: has been simplified and it is more informative
      in case of errors.

   i) In GUIENVwindowitemCreate: 
      Added: defaultStyle: @integer; 
      and the window styles are now "or'ed" instead of just added.
   
2) private/winnt/guienv_ntiprivate.bet
   
   a) In processOneEvent if continue=0 the we call:
      cleanUp;
      Stop;

   b) cleanUp no longer close windows. 

   c) A linked list 'win32Menubars' has been added in order to Destroy
      win32Menubars when we cleanup.
      menus.cleanUp now calls win32Menubars.cleanUp, 
      and GUIENVwin32Menubaropen appends to the list 
      and GUIENVwin32MenubarClose deletes from the list.

3) private/winnt/fields_ntibody.bet
  
   a) GUIENVtextFieldonKeyDown:
      Now checks if the textfield is still open after INNER:
      (if this(textField).isOpen then ..
      This is necessary because if the textfield is closed in INNER we
      must NOT call the default windowProc.

   b) There is now allocated 56 bytes for the pointer used in the two 
      calls to GetTextMetrics.

   c) TextEditGetRange: Deleted some old code that was just a comment.

   d) GUIENVtextFieldPosToPt: New implementation.

   e) GUIENVtextFieldPtToPos: New implementation.


4) private/winnt/graphics_ntibody.bet

   a) GUIENVgraphicsFillRect: New implementation.

   b) GUIENVgraphicsDrawText: New implementation. The code concerned
      with SetBkMode and SetTextAlign has been moved to
      GUIENVgraphicsBody. See c) below.
 
 
   c) GUIENVgraphicsBody:
      - Deleted: hBrush: @integer; It was not used.
      - Added: 
        prevBkMode: @integer; 
        windowID: @integer;   

        this(windowItem).interfaceObjectID -> windowID;
        Uses windowID instead of this(windowItem).interfaceObjectID.

        (private.hdc,TRANSPARENT) -> SetBkMode -> prevBkMode; 
        (if prevBkMode=0 then
           'SetBkMode failed.' -> screen.putLine;
        if);
        (private.hdc,TA_BASELINE+TA_LEFT+TA_UPDATECP) -> SetTextAlign;


        (private.hdc,prevBkMode) -> SetBkMode;

   

5) private/winnt/windowbody.bet
   a) processActivate and windowCreate:
      If activation in processActivate is false we now do: 
        this(window).interfaceObjectID -> lastActiveWindowID;
      and this code has been removed from windowCreate.

   b) GUIENVwindowClose: 
      - We no longer do:
        (if this(guienv).private.windows.empty then
           0 -> PostQuitMessage;
        if);
      - Deleted some old code that was just a comment.

   c) GUIENVwindowShowModal:
      windowFrame -> frame; has been moved to after the call to show.

   d) GUIENVwindowBringToFront now checks if the window already is in the 
      front by calling GetForegroundWindow.

   e) theEventHandler.onRefresh now gets called on windows.
      processRefresh in GUIENVwindowMethodsdispatchMessage now calls
      theEventHandler.onRefresh and sets update region.


6) private/winnt/win32menubarbody.bet

   a) GUIENVwin32Menubaropen:
      Added:
      this(win32Menubar)[]->this(guienv).private.win32Menubars.append;

   b) GUIENVwin32MenubarClose: 
      Added:
      this(win32Menubar)[]->this(guienv).private.win32Menubars.delete;

7) private/winnt/controls_ntibody.bet

   a) preferredSize in optionButtonLib 
       - (if l.length>0 then
             widthOfLabel + 2 -> widthOfLabel;
         if);
       - now checks if private.optionButtonPopupMenu is none.
       - Adds 2 instead of 18 to prefW.
       - And the calculation of prefH has changed.
      

   b) updateDropDownList in optionButtonLib
      - Deleted: 
        (* this(optionButton).buttonStyle -> theTextStyle[]; *)
      - Added :
        (if l.length>0 then widthOfLabel+2 -> widthOfLabel; if);
        and do not add 2 to widthOfLabel in call to MoveWindow.
   
   c) GUIENVoptionButtonOnLabelChanged, 
      GUIENVoptionButtonOnStyleChanged, and
      GUIENVoptionButtonOpen:
      - Added: (if l.length>0 then widthOfLabel+2 -> widthOfLabel; if);
      - Changed:
        (dropDownListID,widthOfLabel+2,0,100,100,1)->MoveWindow->result;
        to:
        (dropDownListID,widthOfLabel,0,100,100,1)->MoveWindow->result;

   d) GUIENVbuttonSetLabel: Now checks if theLabel is NONE.

   e) editTextLib: attributes:
      setEditTextMargins: Has changed the top and left margin from (1,1) to
                          (2,2) and (2,2) to (3,3).

   f) GUIENVeditTextCreate: Now uses "tos'%or'" instead of just "+" to create
      windowItemStyle.

   g) GUIENVeditTextSetStyle: Removed: 'EdittextSetStyle' -> putline;.

   h) GUIENVradioButtonPrivate, GUIENVRadioButtonOpen, GUIENVRadioButtonClose:
      Has added: theMouseUpAction and theKeyDownAction.
      They are appended in open and deleted in close.
      This is to get the same behavior as on Motif. However, this must be 
      changed in the next version, because this behavior is wrong.
      On windows the windowItemStyle should simply be BS_AUTORADIOBUTTON and
      the actions are not needed.

   i) GUIENVstaticTextOnRefresh: Now calls inner before drawing the label.

   j) GUIENViconButtonOnRefresh:
      Changed: this(windowItem).interfaceObjectID -> windowID;
      to: interfaceObjectID -> windowID;

   k) GUIENViconbuttonOnHiliteChanged:
      Now use windowID instead of interfaceObjectID.

8) private/winnt/scrolllist_ntibody.bet
 
   a) GUIENVselectionDeselect. 
      It was not possible to deselect the first 
      element because of "(if ( (theItem>1)". This has been changed to 
      "(if ( (theItem>0)".

   b) GUIENVselectionSelectItem. 
      The extend parameter was not used. The 
      selection was always extended. This has been fixed.

   c) scrollListLib. Has added LBN_DBLCLK to handleNotification in order to
      call onSelect on doubleClicks.

   d) GUIENVscrollListCreate:
      Now uses tos'%or' to create the window style and has added the
      LBS_NOTIFY listbox style to get notifications when the selection 
      changes.

9) utils/private/winnt/loadraster_ntibody.bet
   
   a) GUIENVloadRaster:
      name.copyPrepend -> (name.copy).Prepend

   b) Removed: RESOURCE nti 'utils.rc';
-----------------------------------------------------------------------

June, 11 1996: Jorgen Lindskov Knudsen

Installed new utils/pane.bet and utils/private/panebody.bet

   - extended to allow zooming/unzooming of the individual pane
     members (zooming implies that the pane member takes over the
     entire pane area.
   - extented to enable explicit specifivation of the fatherFrame.

Changed utils/private/X11/guienvadds_unixbody.bet

   - Fixed a bug in windowItemDrawShadows which used platform specific
     shadow styles.

Changed utils/private/groupbody.bet

   - Fixed a bug in groupOnRefresh using a integer constant (5) as
     borderStyle.

------------------------------------------------------------
June, 10 1996: Henry Michael Lassen

Changed private/X11/guienv_unixbody.bet

   - Fixed a bug in windowItem.show/hide that caused a crash, when
     called on a figureItem

------------------------------------------------------------
May, 31 1996: Henry Michael Lassen

Changed private/X11/deviceinfo.bet:

       - Uses objectPool.scan instead of objectPool.get to work around
         a bug in objectPool.get.

------------------------------------------------------------
May, 23 1996: JLK

Changed implementation of prompts:
	- Corrected error in 'father' settings for the buttons - was
	  visible on Linux and HPUX9MC (buttons were not displayed in the
	  prompt itself in some cases)
	- Made prompts react to <cr> as OK, and <esc> as CANCEL.
	- Protected the implementation against multiple invocations of the ok,
	  etc. virtuals in the case of double-click,etc. on the buttons.
	- Changed the default positioning in the case of father[]=NONE to be
	  center of the screen (previous version used mouseposition, resulting
	  in 'chasing' of multiple dialogs.

------------------------------------------------------------
   6/2 96. Henry Michael Lassen

There are a number of modifications in the motif implementation:

* Changes in graphics_unixbody

   - drawRaster is modified to call XCopyArea instead of XCopyPlane,
     this means that the depth of the pixmap must be the same as the
     screen, therefore readFromX11File is changed in raster_unixbody.

     The clipmask is used, if there is any (Xpm format only).

* Changes in raster_unixbody

   - readFromX11File is modified to read the bitmap into a pixmap with
     the same depth as the screen.

* Changes in fields_unixbody

   - To avoid segmentation fault the result of all 

        XmValue -> getPointerResource

     calls are checked.

------------------------------------------------------------



