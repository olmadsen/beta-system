ORIGIN 'mactypes';
INCLUDE 'memory';

BODY 'private/texteditbody';
-- Lib: Attributes --
TEPtr: ToolboxRecord
  (# destRect: Rect (# Pos::< (# do 0->Value;  #);  #);
     viewRect: Rect (# Pos::< (# do 8->Value;  #);  #);
     lineHeight: Short (# Pos::< (# do 24->Value;  #);  #);
     fontAscent: Short (# Pos::< (# do 26->Value;  #);  #);
     selStart: Short (# Pos::< (# do 32->Value;  #);  #);
     selEnd: Short (# Pos::< (# do 34->Value;  #);  #);
     wordBreak: Long (# Pos::< (# do 38->Value;  #);  #);
     clikLoop: Long (# Pos::< (# do 42->Value;  #);  #);
     just: Short (# Pos::< (# do 58->Value;  #);  #);
     teLength: Short (# Pos::< (# do 60->Value;  #);  #);
     hText: Short (# Pos::< (# do 62->Value;  #);  #);
     crOnly: Short (# Pos::< (# do 72->Value;  #);  #);
     txFont: Short (# Pos::< (# do 74->Value;  #);  #);
     txFace: Short (# Pos::< (# do 76->Value;  #);  #);
     txMode: Short (# Pos::< (# do 78->Value;  #);  #);
     txSize: Short (# Pos::< (# do 80->Value;  #);  #);
     inPort: Long (# Pos::< (# do 82->Value;  #);  #);
     highHook: Long (# Pos::< (# do 86->Value;  #);  #);
     caretHook: Long (# Pos::< (# do 90->Value;  #);  #);
     nLines: Short (# Pos::< (# do 94->Value;  #);  #);
     lineStart: (# lineNo: @Integer;  enter lineNo exit 96+lineNo*2->getShort #);
     
  #);
TextStyleRec: cstruct
  (# byteSize::< (# do 12->value #);
     tsFont: Short (# Pos::< (# do 0->Value;  #);  #);
     tsFace: Byte (# Pos::< (# do 2->Value;  #);  #);
     tsSize: Short (# Pos::< (# do 4->Value;  #);  #);
     
  #);
TEInit: External (# do '$A9CC'->PascalTrap;  #);
TENew: External
  (# destRect,viewRect: ^MacRect; theHandle: @Integer; 
  enter (destRect[],viewRect[])
  do '$A9D2'->PascalTrap; 
  exit theHandle
  #);
TEDispose: External (# theHandle: @Integer;  enter theHandle do '$A9CD'->PascalTrap;  #);
TESetText: External
  (# text,length,hTe: @Integer;  enter (text,length,hTe) do '$A9CF'->PascalTrap;  #);
TEGetText: External
  (# thetext,hTe: @Integer;  enter hTe do '$A9CB'->PascalTrap;  exit theText #);
TEIdle: External (# hTe: @Integer;  enter hTe do '$A9DA'->PascalTrap;  #);
TESetSelect: External
  (# selStart,selEnd,hTe: @Integer;  enter (selStart,selEnd,hTe) do '$A9D1'->PascalTrap;  #);
TEActivate: External (# hTe: @Integer;  enter hTe do '$A9D8'->PascalTrap;  #);
TEDeactivate: External (# hTe: @Integer;  enter hTe do '$A9D9'->PascalTrap;  #);
TEKey: External
  (# key: @ShortInt; hTe: @Integer;  enter (key,hTe) do '$A9DC'->PascalTrap;  #);
TECut: External (# hTe: @Integer;  enter hTe do '$A9D6'->PascalTrap;  #);
TECopy: External (# hTe: @Integer;  enter hTe do '$A9D5'->PascalTrap;  #);
TEPaste: External (# hTe: @Integer;  enter hTe do '$A9DB'->PascalTrap;  #);
TEDelete: External (# hTe: @Integer;  enter hTe do '$A9D7'->PascalTrap;  #);
TEInsert: External
  (# text,length,hTe: @Integer;  enter (text,length,hTe) do '$A9DE'->PascalTrap;  #);
TESetJust: External
  (# hTe: @Integer; just: @ShortInt;  enter (just,hTe) do '$A9DF'->PascalTrap;  #);
TEUpdate: External
  (# hTe: @Integer; rUpdate: ^MacRect;  enter (rUpdate[],hTe) do '$A9D3'->PascalTrap;  #);
TETextBox: External
  (# text,length: @Integer; box: ^MacRect; just: @ShortInt; 
  enter (text,length,box[],just)
  do '$A9CE'->PascalTrap; 
  #);
TEScroll: External
  (# dh,dv: @ShortInt; hTe: @Integer;  enter (dh,dv,hTe) do '$A9DD'->PascalTrap;  #);
TESelView: External (# hTe: @Integer;  enter hTe do '$A811'->PascalTrap;  #);
TEPinScroll: External
  (# dh,dv: @ShortInt; hTe: @Integer;  enter (dh,dv,hTe) do '$A812'->PascalTrap;  #);
TEAutoView: External
  (# fAuto: @Boolean; hTe: @Integer;  enter (fAuto,hTe) do '$A813'->PascalTrap;  #);
TEScrapHandle: External (# hndl: @Integer;  do '{$2EB8,$0AB4}'->PascalTrap;  exit hndl #);
TECalText: External (# hndl: @Integer;  enter hndl do '$A9D0'->PascalTrap;  #);
TEGetOffset: External
  (# pt,hndl: @Integer; res: @ShortInt;  enter (pt,hndl) do '$A83C'->PascalTrap;  exit res #);
TEGetPoint:
  (# offset: @ShortInt; hndl: @Integer; p: @MacPoint; 
  enter (offset,hndl)
  do <<SLOT TEGetPoint:Descriptor>>; 
  exit p[]
  #);
TEClick: External
  (# pt,hte: @Integer; fExtend: @Boolean; 
  enter (pt,fExtend,hTe)
  do '$A9D4'->PascalTrap; 
  #);
TEStyleNew: External
  (# d,v: ^MacRect; TEHandle: @Integer; 
  enter (d[],v[])
  do '$A83E'->PascalTrap; 
  exit TEHandle
  #);
SetStyleHandle: External
  (# stylhndl,tehndl: @Integer; 
  enter (stylhndl,tehndl)
  do '{$3F3C,$0005,$A83D}'->PascalTrap; 
  #);
GetStyleHandle: External
  (# stylhndl,tehndl: @Integer; 
  enter tehndl
  do '{$3F3C,$0004,$A83D}'->PascalTrap; 
  exit stylhndl
  #);
TEGetScrapLen: External
  (# i: @Integer;  do callpascal;  exit i #);
TESetScrapLen: External
  (# i: @Integer;  enter i do callpascal;  #);
TEFromScrap: External
  (# res: @ShortInt;  do callpascal;  exit res #);
TEToScrap: External
  (# res: @ShortInt;  do callpascal;  exit res #);
TENumStyles: External
  (# rangeStart,rangeEnd,hTE,num: @Integer; 
  enter (rangeStart,rangeEnd,hTE)
  do '{$3F3C,$000D,$A83D}'->PascalTrap; 
  exit num
  #);
TEReplaceStyle: External
  (# mode: @ShortInt;
     oldStyle,newStyle: ^TextStyleRec;
     redraw: @Boolean;
     hTE: @Integer;
     
  enter (mode,oldStyle[],newStyle[],redraw,hTE)
  do '{$3F3C,$0002,$A83D}'->PascalTrap; 
  #);
TEStyleInsert: External
  (# buf,len,hST,hTE: @Integer; 
  enter (buf,len,hST,hTE)
  do '{$3F3C,$0007,$A83D}'->PascalTrap; 
  #);
TEGetStyleScrapHandle: External
  (# hTE,hST: @Integer; 
  enter hTE
  do '{$3F3C,$0006,$A83D}'->PascalTrap; 
  exit hST
  #);
TESetStyleScrapHandle: External
  (# rangeStart,rangeEnd,newStyles,hTE: @Integer; redraw: @Boolean; 
  enter (rangeStart,rangeEnd,newStyles,redraw,hTE)
  do '{$3F3C,$000B,$A83D}'->PascalTrap; 
  #);
TEContinuousStyle: External
  (# mode: ^ShortRef;
     aStyle: ^TextStyleRec;
     hTE: @Integer;
     isContinous: @Boolean;
     
  enter (mode[],aStyle[],hTE)
  do '{$3F3C,$000A,$A83D}'->PascalTrap; 
  exit isContinous
  #);
TEGetHeight: External
  (# endLine,startLine,hTE,height: @Integer; 
  enter (endLine,startLine,hTE)
  do '{$3F3C,$0009,$A83D}'->PascalTrap; 
  exit height
  #);
TESetStyle: External
  (# mode: @ShortInt;
     newStyle: ^TextStyleRec;
     redraw: @Boolean;
     hTE: @Integer;
     
  enter (mode,newStyle[],redraw,hTE)
  do '{$3F3C,$0001,$A83D}'->PascalTrap; 
  #);
TEFeatureFlag: External
  (# feature,action,before: @ShortInt; hTE: @Integer; 
  enter (feature,action,hTE)
  do '{$3F3C,$000E,$A83D}'->PascalTrap; 
  exit before
  #);
TEGetStyle: External
  (# offset: @ShortInt;
     theStyle: ^TextStyleRec;
     lineHeight,fontAscent: ^ShortRef;
     hTE: @Integer;
     
  enter (offset,theStyle[],lineHeight[],fontAscent[],hTE)
  do '{$3F3C,$0003,$A83D}'->PascalTrap; 
  #);
TEStylePaste: External
  (# hTE: @Integer; 
  enter hTE
  do '{$3F3C,$0000,$A83D}'->PascalTrap; 
  #);
  

doFont: (# exit 1 #);
doFace: (# exit 2 #);
doSize: (# exit 4 #);
doColor: (# exit 8 #);
doAll: (# exit 15 #);
addSize: (# exit 16 #);

TESetStyleHandle: External 
	(# stylhndl,tehndl: @Integer;
	enter (stylhndl,tehndl)
	do '{$3F3C,$0005,$A83D}' -> PascalTrap;
	#);
TEGetStyleHandle: External 
	(# stylhndl,tehndl: @Integer;
	enter tehndl
	do '{$3F3C,$0004,$A83D}' -> PascalTrap;
	exit stylhndl
	#);
TEUseStyleScrap: External 
	(#	rangeStart,rangeEnd,newStyles,hTE: @Integer;
		redraw: @Boolean;
	enter (rangeStart,rangeEnd,newStyles,redraw,hTE)
	do '{$3F3C,$000B,$A83D}' -> PascalTrap;
	#);

TextEditInsert:
	(# data: ^text;
		teHandle: @integer;
	enter (data[], teHandle)
	do (if data.lgth > 0 then
			(@@data.T[1], data.lgth, teHandle) -> TEInsert;
		if);
	#);
TextEditSetText:
	(# data: ^text;
		teHandle: @integer;
	enter (data[], teHandle)
	do (if data.lgth > 0 then
			(@@data.T[1], data.lgth, teHandle) -> TESetText;
		else
			(0, 0, teHandle) -> TESetText;
		if);
	#);

MakeText:
	(# data: ^text;
		h: @integer;
		p: @integer;
		size: @integer;
	enter h
	do &text[] -> data[];
		h -> GetHandleSize -> size;
		(if size > 0 then
			size -> data.extend;
			h -> TOS'%adrGetLong' -> p;
			(p, @@data.T[1], size) -> BlockMove;
			size -> data.lgth -> data.pos;
		if);
	exit data[]
	#);
	
TextEditGetText:
	(# data: ^text;
		teHandle: @integer;
	enter teHandle
	do teHandle -> TEGetText -> MakeText -> data[];
	exit data[]
	#);

TextBox:
	(# t: ^text;
		box: ^macRect;
		align: @shortInt;
	enter (t[], box[], align)
	do (if t.lgth > 0 then
			(@@t.T[1], t.lgth, box[], align) -> TETExtBox;
		if);
	#);
