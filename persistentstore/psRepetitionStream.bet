ORIGIN '~beta/basiclib/v1.6/betaenv';
(* 
 * $RCSfile: psRepetitionStream.bet,v $ $Revision: 1.7 $ $Date: 1997-06-02 13:31:30 $
 *
 * COPYRIGHT
 *       Copyright Mjolner Informatics, 1992-94
 *       All rights reserved.
 *)
BODY 'private/psRepetitionStreamBody';

INCLUDE '~beta/basiclib/v1.6/file';
INCLUDE '~beta/sysutils/v1.6/RepetitionObject';

--- lib:attributes ---
psRepetitionStream:
  (# repFile: ^File;
     changed: @Boolean;
     
     pageSize: (# exit 1024 #);
     page: 
       (# data: [pageSize]@Integer;
          changed: @Boolean;
       #);
     
     pages: [1]^page;
     lastPage: @Integer;  (* last Page loaded.   *)
     lastSaved: @Integer; (* Index of last page ever saved. *)
     firstFree: @Integer; (* First unused index. *)
     
     (* OPEN
      * ====
      * Open THIS(psRepetitionStream) *)
     
     open:
       (# 
       enter repFile[]
       do <<SLOT psPagedRepetitionStreamOpen:descriptor>>
       #);
     
     (* CREATE
      * ======
      * Create THIS(psRepetitionStream) *)
       
     create:
       (# 
       enter repFile[]
       do <<SLOT psPagedRepetitionStreamCreate:descriptor>>
       #);
     
     (* SAVE
      * ====
      * Save changes to this(psRepetitionStream) *)
     
     save:
       (* Saves changes to this(PagedRepetitionStream) *)
       (# do <<SLOT psPagedRepetitionStreamSave:descriptor>> #);
     
     
     (* ALLOC
      * =====
      * Allocate an area in the byteStream of size 'needed'
      * and return the index of the area. *)
     
     alloc: @
       (# needed: @Integer;
          freeInx: @Integer;
       enter needed
       do firstFree -> freeInx; needed + firstFree -> firstFree;
       exit freeInx
       #);
     
     (* GETREP
      * ======
      * Read 'len' bytes in byteStream starting at index 'inx'
      * and return them in rep. *)
     
     getRep: @
       (# getIt: @<<SLOT psgetRepGetItBody:descriptor>>;
          inx, len: @Integer;
          rep: ^RepetitionObject;
       enter (inx,len)
       do getIt 
       exit rep[]
       #);
     
     (* PUTREP
      * ======
      * Writen 'rep' at index 'inx' in byteStream *)
     
     putRep: @
       (# putIt: @<<SLOT psputRepPutItBody:descriptor>>;
          inx: @Integer;
          rep: ^RepetitionObject;
       enter (inx, rep[])
       do putIt
       #);
     
     private: @<<SLOT pspagedRepetitionStreamPrivate:descriptor>>;
  #);
