ORIGIN '~beta/basiclib/v1.4/betaenv';

INCLUDE '~beta/persistentstore/v1.41/persistentstore';
INCLUDE '~beta/sysutils/v1.4/objinterface';
INCLUDE 'textHash';


(* NOTE!! Lazy fetch does not work on all architectures!!!
 * ======================================================= *)

--- program : descriptor ---
(# PS: @persistentstore 
     (# allowLazyFetch::< (# do true -> value #);
        onDanglerHit::<
          (# 
          do 'Dangling reference hit...' -> putText;
          #);
        afterDanglerHit::<
          (# pt: @protoType;
          do 'Object type was ' -> putText;
             theObject[] -> getProtoType -> pt;
             pt.labId -> screen.putLine;
          #);
     #);
   H: ^textHashTable;

do
   (* 'myStore' -> PS.openWrite;
    *    'opened' -> putLine; screen.newline;
    *    
    *    'Getting...' -> screen.putText;
    *    ('TextTable', textHashTable##) -> PS.get -> H[];
    *    
    *    'Closing...' -> screen.putText;
    *    PS.close 
    *    (# doCheckPoint::< (# do false -> value #);
    *       danglersExists::< 
    *         (# 
    *         do fetch -> toDo;
    *            'danglersExists called. Fetching danglers' -> screen.putLine;
    *         #)
    *    #);
    *    
    *    'Scanning...' -> screen.putText;
    *    H.scan (# do current[] -> putLine; #);
    *    
    *)
   
   'myStore' -> PS.openWrite;
   'opened' -> putLine; screen.newline;
   
   'Getting...' -> screen.putText;
   ('TextTable', textHashTable##) -> PS.get -> H[];
   
   'Scanning...' -> screen.putText;
   H.scan (# do current[] -> putLine; #); 
   
   PS.close (# doCheckPoint::< (# do false -> value #)#);
   screen.newline; screen.newline;
#)
